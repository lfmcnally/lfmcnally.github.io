<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tales from Herodotus - Section 2</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: #333;
            padding: 25px 45px;
            min-height: 100vh;
            margin: 0;
            font-size: 22px;
        }

        .header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 2px;
        }

        .logo:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
        }

        .title-area {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        h1 {
            color: #222;
            margin: 0;
            font-size: 1.6em;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1em;
            color: #666;
            margin: 0;
        }

        /* Compact controls */
        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 4px;
        }

        .controls {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .controls button {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
            flex: 1;
            text-align: center;
        }

        .controls button:hover {
            background: rgba(0, 102, 255, 0.15);
            transform: translateY(-1px);
        }

        #showAllBtn {
            background: #0066ff;
            color: white;
        }

        #showAllBtn:hover {
            background: #0052cc;
        }

        #hideAllBtn {
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
        }

        #toggleColoursBtn {
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
        }

        #toggleStyleBtn {
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
        }

        body.style-mode #toggleStyleBtn {
            background: #0066ff;
            color: white;
        }

        /* Key - compact squares in header */
        .key {
            display: flex;
            gap: 6px;
        }

        .key-item {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
            flex: 1;
        }

        .key-item:hover {
            transform: translateY(-1px);
            filter: brightness(0.95);
        }

        .key-item.active {
            outline: 2px solid #333;
            outline-offset: 1px;
        }

        /* Main content area */
        .translation-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
        }

        .column-header {
            font-size: 0.9em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            padding-left: 0;
        }

        /* Each line row */
        .line-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .line-number {
            display: none;
            color: #0066ff;
            font-weight: bold;
            min-width: 45px;
            margin-right: 10px;
            font-size: 1.15em;
            align-self: flex-end;
            padding-bottom: 4px;
        }

        .words-container {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            flex-wrap: wrap;
        }

        /* Word group with number above */
        .word-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .word-order {
            font-size: 0.65em;
            color: #888;
            margin-bottom: 4px;
            height: 1em;
            font-weight: 600;
        }

        .latin-word, .english-word {
            padding: 3px 7px;
            border-radius: 3px;
            font-size: 1em;
            transition: background-color 0.3s, opacity 0.3s;
            cursor: pointer;
        }

        .latin-word {
            background-color: transparent;
        }

        .english-word {
            opacity: 0;
        }

        .english-word.revealed {
            opacity: 1;
        }

        /* Colours */
        .subject .latin-word { background-color: #ffb3b3; }
        .english-word.subject { background-color: #ffb3b3; }

        .verb .latin-word { background-color: #b3e6ff; }
        .english-word.verb { background-color: #b3e6ff; }

        .object .latin-word { background-color: #b3ffcc; }
        .english-word.object { background-color: #b3ffcc; }

        .genitive .latin-word { background-color: #ffd9b3; }
        .english-word.genitive { background-color: #ffd9b3; }

        .dative .latin-word { background-color: #e6b3ff; }
        .english-word.dative { background-color: #e6b3ff; }

        .ablative .latin-word { background-color: #ffffb3; }
        .english-word.ablative { background-color: #ffffb3; }

        .preposition .latin-word { background-color: #ffb3e6; }
        .english-word.preposition { background-color: #ffb3e6; }

        .conjunction .latin-word { background-color: #d9ffb3; }
        .english-word.conjunction { background-color: #d9ffb3; }

        .adverb .latin-word { background-color: #ccb3ff; }
        .english-word.adverb { background-color: #ccb3ff; }

        .gerundive .latin-word { background-color: #ffcbb3; }
        .english-word.gerundive { background-color: #ffcbb3; }

        /* Highlighting */
        .subject.highlighted .latin-word { background-color: #ffb3b3 !important; }
        .english-word.subject.highlighted { background-color: #ffb3b3 !important; }
        .verb.highlighted .latin-word { background-color: #b3e6ff !important; }
        .english-word.verb.highlighted { background-color: #b3e6ff !important; }
        .object.highlighted .latin-word { background-color: #b3ffcc !important; }
        .english-word.object.highlighted { background-color: #b3ffcc !important; }
        .genitive.highlighted .latin-word { background-color: #ffd9b3 !important; }
        .english-word.genitive.highlighted { background-color: #ffd9b3 !important; }
        .dative.highlighted .latin-word { background-color: #e6b3ff !important; }
        .english-word.dative.highlighted { background-color: #e6b3ff !important; }
        .ablative.highlighted .latin-word { background-color: #ffffb3 !important; }
        .english-word.ablative.highlighted { background-color: #ffffb3 !important; }
        .preposition.highlighted .latin-word { background-color: #ffb3e6 !important; }
        .english-word.preposition.highlighted { background-color: #ffb3e6 !important; }
        .conjunction.highlighted .latin-word { background-color: #d9ffb3 !important; }
        .english-word.conjunction.highlighted { background-color: #d9ffb3 !important; }
        .adverb.highlighted .latin-word { background-color: #ccb3ff !important; }
        .english-word.adverb.highlighted { background-color: #ccb3ff !important; }
        .gerundive.highlighted .latin-word { background-color: #ffcbb3 !important; }
        .english-word.gerundive.highlighted { background-color: #ffcbb3 !important; }

        /* Hide colours mode */
        body.hide-colours .subject .latin-word,
        body.hide-colours .english-word.subject.revealed,
        body.hide-colours .verb .latin-word,
        body.hide-colours .english-word.verb.revealed,
        body.hide-colours .object .latin-word,
        body.hide-colours .english-word.object.revealed,
        body.hide-colours .genitive .latin-word,
        body.hide-colours .english-word.genitive.revealed,
        body.hide-colours .dative .latin-word,
        body.hide-colours .english-word.dative.revealed,
        body.hide-colours .ablative .latin-word,
        body.hide-colours .english-word.ablative.revealed,
        body.hide-colours .preposition .latin-word,
        body.hide-colours .english-word.preposition.revealed,
        body.hide-colours .conjunction .latin-word,
        body.hide-colours .english-word.conjunction.revealed,
        body.hide-colours .adverb .latin-word,
        body.hide-colours .english-word.adverb.revealed,
        body.hide-colours .gerundive .latin-word,
        body.hide-colours .english-word.gerundive.revealed {
            background-color: #e0e0e0;
        }

        /* Style Mode */
        .style-highlight {
            position: relative;
        }

        .style-highlight.active-style .latin-word {
            outline: 2px solid #333;
            outline-offset: 1px;
        }

        /* Style panel at bottom */
        .style-panel {
            display: none;
            background: rgba(0, 102, 255, 0.03);
            border-top: 2px solid rgba(0, 102, 255, 0.15);
            padding: 18px 24px;
            margin-top: 20px;
        }

        body.style-mode .style-panel {
            display: block;
        }

        .style-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .style-panel h3 {
            margin: 0;
            color: #0066ff;
            font-size: 1rem;
            font-weight: 600;
        }

        .style-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .style-tag {
            padding: 8px 14px;
            background: white;
            border: 1px solid rgba(0, 102, 255, 0.25);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
        }

        .style-tag:hover {
            border-color: #0066ff;
            background: rgba(0, 102, 255, 0.05);
        }

        .style-tag.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        .style-tag em {
            font-style: italic;
        }

        .style-analysis {
            display: none;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(0, 102, 255, 0.15);
        }

        .style-analysis.active {
            display: block;
        }

        .style-analysis-title {
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .style-analysis-lines {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .style-analysis-effect {
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .style-analysis-effect strong {
            color: #0066ff;
        }

        .style-analysis-exam {
            padding-top: 12px;
            border-top: 1px dashed #ddd;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        .style-analysis-exam strong {
            color: #333;
        }

        .style-analysis em {
            font-style: italic;
        }

        /* ===== ANALYSIS MODE ===== */
        #analyseBtn {
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            color: white;
        }

        #analyseBtn:hover {
            background: linear-gradient(135deg, #0052cc 0%, #3d85e0 100%);
        }

        .analysis-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #fff;
            z-index: 1000;
            flex-direction: column;
        }

        .analysis-overlay.active {
            display: flex;
        }

        .analysis-overlay .english-word {
            opacity: 1;
        }

        /* Top toolbar */
        .analysis-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
            z-index: 20;
            flex-shrink: 0;
        }

        .analysis-toolbar-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-btn {
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
            font-family: inherit;
        }

        .analysis-btn:hover {
            background: rgba(0, 102, 255, 0.15);
        }

        .analysis-btn.active {
            background: #0066ff;
            color: white;
        }

        .analysis-btn.back-btn {
            background: #f0f0f0;
            color: #333;
        }

        .analysis-btn.back-btn:hover {
            background: #e0e0e0;
        }

        .analysis-nav-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            min-width: 140px;
            text-align: center;
        }

        .save-indicator {
            font-size: 0.8rem;
            color: #4caf50;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        /* Drawing tools bar */
        .analysis-tools-bar {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            gap: 6px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            flex-shrink: 0;
            z-index: 20;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tool-divider {
            width: 1px;
            height: 22px;
            background: #ddd;
            margin: 0 8px;
        }

        .color-swatch {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.active {
            border-color: #333;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #333;
        }

        .size-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.15s;
            font-family: inherit;
        }

        .size-btn:hover {
            background: #f0f0f0;
        }

        .size-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        /* Analysis key */
        .analysis-key {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .analysis-key-item {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            color: #555;
        }

        /* Workspace */
        .analysis-workspace {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
            background-image: radial-gradient(circle, #e8e8e8 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .analysis-sentence-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            pointer-events: none;
            max-width: 80%;
        }

        .analysis-latin-line {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .analysis-english-line {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }

        .analysis-sentence-display .word-group {
            cursor: default;
        }

        .analysis-sentence-display .word-order {
            display: none;
        }

        .analysis-sentence-display .latin-word {
            font-size: 1.4em;
            padding: 5px 12px;
            border-radius: 4px;
        }

        .analysis-sentence-display .english-word {
            font-size: 1.2em;
            padding: 4px 10px;
            border-radius: 4px;
        }

        #analysisCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
        }

        #analysisCanvas.eraser-mode {
            cursor: cell;
        }

        #analysisCanvas.pointer-mode {
            pointer-events: none;
            cursor: default;
        }

        /* Notes panel */
        .analysis-notes {
            border-top: 2px solid #eee;
            background: #fafafa;
            flex-shrink: 0;
            z-index: 20;
        }

        .analysis-notes-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            cursor: pointer;
            user-select: none;
        }

        .analysis-notes-toggle:hover {
            background: #f0f0f0;
        }

        .analysis-notes-toggle h4 {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .analysis-notes-toggle .toggle-arrow {
            font-size: 0.8rem;
            color: #999;
            transition: transform 0.2s;
        }

        .analysis-notes.open .toggle-arrow {
            transform: rotate(180deg);
        }

        .analysis-notes-body {
            display: none;
            padding: 0 20px 12px;
        }

        .analysis-notes.open .analysis-notes-body {
            display: block;
        }

        #analysisNotesText {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            outline: none;
            line-height: 1.5;
        }

        #analysisNotesText:focus {
            border-color: #0066ff;
            box-shadow: 0 0 0 2px rgba(0, 102, 255, 0.1);
        }
    </style>
</head><body>
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <a href="https://www.classicalia.co.uk" class="logo">C</a>
                <div class="title-area">
                    <h1>Tales from Herodotus</h1>
                    <p class="subtitle">Section 1: XI (a): First capture of Babylon by Cyrus: Part one</p>
                </div>
            </div>
            <div class="controls-area">
                <div class="controls">
                    <button id="showAllBtn">Show All</button>
                    <button id="hideAllBtn">Hide All</button>
                    <button id="toggleColoursBtn">Hide Colours</button>
                    <button id="toggleStyleBtn">Style Notes</button>
                    <button id="analyseBtn">Analyse</button>
                </div>
                <div class="key">
                    <span class="key-item" data-category="subject" style="background-color: #ffb3b3;">Subj.</span>
                    <span class="key-item" data-category="object" style="background-color: #b3ffcc;">Obj.</span>
                    <span class="key-item" data-category="verb" style="background-color: #b3e6ff;">Verb</span>
                    <span class="key-item" data-category="genitive" style="background-color: #ffd9b3;">Gen.</span>
                    <span class="key-item" data-category="dative" style="background-color: #e6b3ff;">Dat.</span>
                    <span class="key-item" data-category="preposition" style="background-color: #ffb3e6;">Prep.</span>
                    <span class="key-item" data-category="conjunction" style="background-color: #d9ffb3;">Conj.</span>
                    <span class="key-item" data-category="adverb" style="background-color: #ccb3ff;">Adv.</span>
                    <span class="key-item" data-category="gerundive" style="background-color: #ffcbb3;">Ptcp.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="translation-area">
        <!-- GREEK COLUMN -->
        <div class="latin-column">
            <div class="column-header">Greek</div>

            <!-- Sentence 1: οὕτω τε δὴ τάξας καὶ παραινέσας ἀπήλαυνεν αὐτὸς σὺν τῷ ἀχρείῳ τοῦ στρατοῦ. -->
            <div class="line-row" data-line="1">
                <span class="line-number">1</span>
                <div class="words-container">
                    <span class="word-group adverb" data-order="01-01"><span class="word-order">1</span><span class="latin-word">οὕτω</span></span>
                    <span class="word-group conjunction style-highlight" data-order="01-03" data-style-feature="correlative"><span class="word-order">3</span><span class="latin-word">τε</span></span>
                    <span class="word-group adverb" data-order="01-02"><span class="word-order">2</span><span class="latin-word">δὴ</span></span>
                    <span class="word-group gerundive style-highlight" data-order="01-04" data-style-feature="participle-chain"><span class="word-order">4</span><span class="latin-word">τάξας</span></span>
                    <span class="word-group conjunction style-highlight" data-order="01-05" data-style-feature="correlative"><span class="word-order">5</span><span class="latin-word">καὶ</span></span>
                    <span class="word-group gerundive style-highlight" data-order="01-06" data-style-feature="participle-chain"><span class="word-order">6</span><span class="latin-word">παραινέσας</span></span>
                    <span class="word-group verb style-highlight" data-order="01-08" data-style-feature="imperfect-tense"><span class="word-order">8</span><span class="latin-word">ἀπήλαυνεν</span></span>
                    <span class="word-group subject" data-order="01-07"><span class="word-order">7</span><span class="latin-word">αὐτὸς</span></span>
                    <span class="word-group preposition" data-order="01-09"><span class="word-order">9</span><span class="latin-word">σὺν</span></span>
                    <span class="word-group dative" data-order="01-10"><span class="word-order">10</span><span class="latin-word">τῷ</span></span>
                    <span class="word-group dative" data-order="01-11"><span class="word-order">11</span><span class="latin-word">ἀχρείῳ</span></span>
                    <span class="word-group genitive" data-order="01-12"><span class="word-order">12</span><span class="latin-word">τοῦ</span></span>
                    <span class="word-group genitive" data-order="01-13"><span class="word-order">13</span><span class="latin-word">στρατοῦ.</span></span>
                </div>
            </div>

            <!-- Sentence 2: ἀφικόμενος δὲ ἐπὶ τὴν λίμνην, οὖσαν ἕλος, τὸν ποταμὸν διώρυχι εἰσαγαγών, τὸ ἀρχαῖον ῥεῖθρον διαβατὸν εἶναι ἐποίησεν, ὑπονοστήσαντος τοῦ ποταμοῦ. -->
            <div class="line-row" data-line="2">
                <span class="line-number">2</span>
                <div class="words-container">
                    <span class="word-group gerundive style-highlight" data-order="02-02" data-style-feature="participle-chain"><span class="word-order">2</span><span class="latin-word">ἀφικόμενος</span></span>
                    <span class="word-group conjunction" data-order="02-01"><span class="word-order">1</span><span class="latin-word">δὲ</span></span>
                    <span class="word-group preposition" data-order="02-03"><span class="word-order">3</span><span class="latin-word">ἐπὶ</span></span>
                    <span class="word-group object" data-order="02-04"><span class="word-order">4</span><span class="latin-word">τὴν</span></span>
                    <span class="word-group object" data-order="02-05"><span class="word-order">5</span><span class="latin-word">λίμνην,</span></span>
                    <span class="word-group gerundive style-highlight" data-order="02-06" data-style-feature="participle-chain"><span class="word-order">6</span><span class="latin-word">οὖσαν</span></span>
                    <span class="word-group object" data-order="02-07"><span class="word-order">7</span><span class="latin-word">ἕλος,</span></span>
                    <span class="word-group object" data-order="02-09"><span class="word-order">9</span><span class="latin-word">τὸν</span></span>
                    <span class="word-group object" data-order="02-10"><span class="word-order">10</span><span class="latin-word">ποταμὸν</span></span>
                    <span class="word-group dative" data-order="02-11"><span class="word-order">11</span><span class="latin-word">διώρυχι</span></span>
                    <span class="word-group gerundive style-highlight" data-order="02-08" data-style-feature="participle-chain"><span class="word-order">8</span><span class="latin-word">εἰσαγαγών,</span></span>
                    <span class="word-group object" data-order="02-13"><span class="word-order">13</span><span class="latin-word">τὸ</span></span>
                    <span class="word-group object" data-order="02-14"><span class="word-order">14</span><span class="latin-word">ἀρχαῖον</span></span>
                    <span class="word-group object" data-order="02-15"><span class="word-order">15</span><span class="latin-word">ῥεῖθρον</span></span>
                    <span class="word-group object" data-order="02-17"><span class="word-order">17</span><span class="latin-word">διαβατὸν</span></span>
                    <span class="word-group verb" data-order="02-16"><span class="word-order">16</span><span class="latin-word">εἶναι</span></span>
                    <span class="word-group verb" data-order="02-12"><span class="word-order">12</span><span class="latin-word">ἐποίησεν,</span></span>
                    <span class="word-group gerundive style-highlight" data-order="02-20" data-style-feature="genitive-absolute verbal-echo"><span class="word-order">20</span><span class="latin-word">ὑπονοστήσαντος</span></span>
                    <span class="word-group genitive style-highlight" data-order="02-18" data-style-feature="genitive-absolute"><span class="word-order">18</span><span class="latin-word">τοῦ</span></span>
                    <span class="word-group genitive style-highlight" data-order="02-19" data-style-feature="genitive-absolute"><span class="word-order">19</span><span class="latin-word">ποταμοῦ.</span></span>
                </div>
            </div>

            <!-- Sentence 3: γενομένου δὲ τούτου τοιούτου, οἱ Πέρσαι οἵπερ τεταγμένοι ἦσαν ἐπ' αὐτῷ τούτῳ, ὑπονενοστηκότος τοῦ Εὐφράτου ποταμοῦ, ἀνδρὶ ὡς εἰς μέσον μηρὸν μάλιστα, κατὰ τὸ ῥεῖθρον εἰσῆσαν εἰς τὴν Βαβυλῶνα. -->
            <div class="line-row" data-line="3">
                <span class="line-number">3</span>
                <div class="words-container">
                    <span class="word-group gerundive style-highlight" data-order="03-04" data-style-feature="genitive-absolute"><span class="word-order">4</span><span class="latin-word">γενομένου</span></span>
                    <span class="word-group conjunction" data-order="03-01"><span class="word-order">1</span><span class="latin-word">δὲ</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-02" data-style-feature="genitive-absolute"><span class="word-order">2</span><span class="latin-word">τούτου</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-03" data-style-feature="genitive-absolute"><span class="word-order">3</span><span class="latin-word">τοιούτου,</span></span>
                    <span class="word-group subject" data-order="03-05"><span class="word-order">5</span><span class="latin-word">οἱ</span></span>
                    <span class="word-group subject" data-order="03-06"><span class="word-order">6</span><span class="latin-word">Πέρσαι</span></span>
                    <span class="word-group subject" data-order="03-07"><span class="word-order">7</span><span class="latin-word">οἵπερ</span></span>
                    <span class="word-group gerundive style-highlight" data-order="03-09" data-style-feature="participle-chain"><span class="word-order">9</span><span class="latin-word">τεταγμένοι</span></span>
                    <span class="word-group verb" data-order="03-08"><span class="word-order">8</span><span class="latin-word">ἦσαν</span></span>
                    <span class="word-group preposition" data-order="03-10"><span class="word-order">10</span><span class="latin-word">ἐπ'</span></span>
                    <span class="word-group dative" data-order="03-11"><span class="word-order">11</span><span class="latin-word">αὐτῷ</span></span>
                    <span class="word-group dative" data-order="03-12"><span class="word-order">12</span><span class="latin-word">τούτῳ,</span></span>
                    <span class="word-group gerundive style-highlight" data-order="03-16" data-style-feature="genitive-absolute verbal-echo"><span class="word-order">16</span><span class="latin-word">ὑπονενοστηκότος</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-13" data-style-feature="genitive-absolute"><span class="word-order">13</span><span class="latin-word">τοῦ</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-15" data-style-feature="genitive-absolute"><span class="word-order">15</span><span class="latin-word">Εὐφράτου</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-14" data-style-feature="genitive-absolute"><span class="word-order">14</span><span class="latin-word">ποταμοῦ,</span></span>
                    <span class="word-group dative" data-order="03-21"><span class="word-order">21</span><span class="latin-word">ἀνδρὶ</span></span>
                    <span class="word-group adverb" data-order="03-17"><span class="word-order">17</span><span class="latin-word">ὡς</span></span>
                    <span class="word-group preposition" data-order="03-18"><span class="word-order">18</span><span class="latin-word">εἰς</span></span>
                    <span class="word-group object" data-order="03-19"><span class="word-order">19</span><span class="latin-word">μέσον</span></span>
                    <span class="word-group object" data-order="03-20"><span class="word-order">20</span><span class="latin-word">μηρὸν</span></span>
                    <span class="word-group adverb" data-order="03-17b"><span class="word-order">(17)</span><span class="latin-word">μάλιστα,</span></span>
                    <span class="word-group preposition" data-order="03-23"><span class="word-order">23</span><span class="latin-word">κατὰ</span></span>
                    <span class="word-group object" data-order="03-24"><span class="word-order">24</span><span class="latin-word">τὸ</span></span>
                    <span class="word-group object" data-order="03-25"><span class="word-order">25</span><span class="latin-word">ῥεῖθρον</span></span>
                    <span class="word-group verb" data-order="03-26"><span class="word-order">26</span><span class="latin-word">εἰσῆσαν</span></span>
                    <span class="word-group preposition" data-order="03-27"><span class="word-order">27</span><span class="latin-word">εἰς</span></span>
                    <span class="word-group object" data-order="03-28"><span class="word-order">28</span><span class="latin-word">τὴν Βαβυλῶνα.</span></span>
                </div>
            </div>
        </div>

        <!-- ENGLISH COLUMN -->
        <div class="english-column">
            <div class="column-header">English</div>

            <!-- Sentence 1 English -->
            <div class="line-row" data-line="1">
                <span class="line-number">1</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="01-01">Thus,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="01-02">then,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="01-03">having both</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="01-04">drawn up</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="01-05">and</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="01-06">advised (them)</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="01-07">he</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="01-08">marched away</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="01-09">with</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="01-10">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="01-11">unserviceable (part)</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="01-12">of the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="01-13">army.</span></span>
                </div>
            </div>

            <!-- Sentence 2 English -->
            <div class="line-row" data-line="2">
                <span class="line-number">2</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="02-01">And</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="02-02">when he arrived</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="02-03">at</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-04">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-05">lake,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="02-06">being</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-07">a marsh,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="02-08">having led</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-09">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-10">river</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="02-08">into (it)</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="02-11">by means of a trench,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="02-12">he made</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-13">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-14">old</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-15">stream</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="02-16">to be</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-17">crossable,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="02-20">after</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="02-18">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="02-19">river</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="02-20">sank down.</span></span>
                </div>
            </div>

            <!-- Sentence 3 English -->
            <div class="line-row" data-line="3">
                <span class="line-number">3</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="03-01">And</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="03-04">after</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-02">these</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-03">such things</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="03-04">came about,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="03-05">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="03-06">Persians,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="03-07">the very ones who</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="03-08">had been</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="03-09">drawn up</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="03-10">for</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="03-11">this very</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="03-12">purpose,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-13">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-14">river</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-15">Euphrates</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="03-16">having dropped</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="03-17">to about</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="03-18">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="03-19">mid</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="03-20">thigh</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="03-21">for a man,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="03-26">they went</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="03-23">down</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="03-24">the</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="03-25">stream</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="03-27">into</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="03-28">Babylon.</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Style Panel -->
    <div class="style-panel">
        <div class="style-panel-header">
            <h3>Stylistic Features</h3>
        </div>
        <div class="style-list">
            <span class="style-tag" data-feature="genitive-absolute">Genitive Absolute — <em>ὑπονοστήσαντος... γενομένου... ὑπονενοστηκότος</em></span>
            <span class="style-tag" data-feature="participle-chain">Participial Narrative — <em>τάξας... παραινέσας... ἀφικόμενος... εἰσαγαγών</em></span>
            <span class="style-tag" data-feature="imperfect-tense">Imperfect Tense — <em>ἀπήλαυνεν</em></span>
            <span class="style-tag" data-feature="correlative">τε...καί Correlation — <em>τε... καί</em></span>
            <span class="style-tag" data-feature="verbal-echo">Verbal Echo — <em>ὑπονοστήσαντος... ὑπονενοστηκότος</em></span>
        </div>

        <div class="style-analysis" id="analysis-genitive-absolute">
            <div class="style-analysis-title">Genitive Absolute — ὑπονοστήσαντος... γενομένου... ὑπονενοστηκότος</div>
            <div class="style-analysis-lines">Sentences 2-3</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> The genitive absolute is Herodotus's workhorse for subordinating circumstantial information. In this passage, three genitive absolutes drive the narrative forward. First, <em>ὑπονοστήσαντος τοῦ ποταμοῦ</em> ('after the river sank down') provides the crucial result of Cyrus's engineering. Then <em>γενομένου δὲ τούτου τοιούτου</em> ('after these such things came about') marks the transition to the final assault. Finally, <em>ὑπονενοστηκότος τοῦ Εὐφράτου ποταμοῦ</em> ('the Euphrates having dropped') restates the precondition for the invasion, this time with the river named. Each genitive absolute compresses a whole event into a dependent clause, keeping Herodotus's prose economical and fast-paced.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "Herodotus employs three genitive absolutes to subordinate circumstantial events and maintain narrative pace. The progression from ὑπονοστήσαντος τοῦ ποταμοῦ ('after the river sank') to the fuller ὑπονενοστηκότος τοῦ Εὐφράτου ποταμοῦ ('the river Euphrates having dropped') shows increasing specificity as the narrative reaches its climax, while γενομένου δὲ τούτου τοιούτου provides a summary transition between Cyrus's preparation and the Persian advance."
            </div>
        </div>

        <div class="style-analysis" id="analysis-participle-chain">
            <div class="style-analysis-title">Participial Narrative — τάξας... παραινέσας... ἀφικόμενος... εἰσαγαγών</div>
            <div class="style-analysis-lines">Sentences 1-3</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> Herodotus packs enormous narrative weight into participles. Sentence 1 compresses Cyrus's entire military preparation into two aorist participles: <em>τάξας</em> ('having drawn up') and <em>παραινέσας</em> ('having advised') — two major actions squeezed into subordinate words before the main verb. Sentence 2 intensifies this: <em>ἀφικόμενος</em> ('having arrived'), <em>οὖσαν</em> ('being'), and <em>εἰσαγαγών</em> ('having led into') cascade one after another, each participle adding a layer of circumstance before we finally reach the main verb <em>ἐποίησεν</em> ('he made'). The effect is of a commander methodically executing a complex plan — each step compressed into a participle, building towards the decisive main action.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The chains of aorist participles (τάξας... παραινέσας in sentence 1; ἀφικόμενος... εἰσαγαγών in sentence 2) compress multiple preparatory actions into subordinate clauses, creating a sense of rapid, purposeful execution. By reserving the main verbs (ἀπήλαυνεν, ἐποίησεν) for the climactic actions, Herodotus foregrounds Cyrus's decisive moments while the participles establish his methodical preparation."
            </div>
        </div>

        <div class="style-analysis" id="analysis-imperfect-tense">
            <div class="style-analysis-title">Imperfect Tense — ἀπήλαυνεν</div>
            <div class="style-analysis-lines">Sentence 1</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> After two sharp aorist participles (τάξας, παραινέσας) — completed, decisive actions — Herodotus switches to the imperfect <em>ἀπήλαυνεν</em> ('was marching away'). The imperfect here creates a vivid, cinematic quality: we see Cyrus's departure not as a completed fact but as an ongoing, visible action. The army is still moving, the dust still rising. This choice of tense also suggests that the marching continues into the next event — Cyrus doesn't just leave, he is <em>in the process of leaving</em> when the next phase begins. The contrast between the compressed aorist participles and the drawn-out imperfect main verb is characteristic of Herodotean narrative rhythm.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The imperfect ἀπήλαυνεν ('was marching away') contrasts with the preceding aorist participles τάξας and παραινέσας, shifting from completed preparation to ongoing movement. This creates a vivid, continuous backdrop against which the subsequent events unfold, and is characteristic of Herodotus's use of the imperfect to paint scenes rather than simply record facts."
            </div>
        </div>

        <div class="style-analysis" id="analysis-correlative">
            <div class="style-analysis-title">τε...καί Correlation — τε... καί</div>
            <div class="style-analysis-lines">Sentence 1</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> The <em>τε...καί</em> construction ('both...and') pairs Cyrus's two preparatory actions: <em>τάξας</em> ('having drawn up') <strong>τε</strong>... <strong>καί</strong> <em>παραινέσας</em> ('having advised'). This isn't just a list — it's a deliberate correlation that presents the military and rhetorical preparations as equally important and inseparable. A good commander both arranges his troops <em>and</em> inspires them; the correlative construction reinforces that Cyrus did both. The τε is slightly postpositive, giving a sense of retrospective connection — 'having, on the one hand, drawn up... and also advised.'
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The correlative τε...καί construction pairs the two aorist participles τάξας ('having drawn up') and παραινέσας ('having advised'), presenting Cyrus's military arrangement and verbal encouragement as complementary, equally essential aspects of his leadership. This balanced pairing emphasises the thoroughness of his preparation before departure."
            </div>
        </div>

        <div class="style-analysis" id="analysis-verbal-echo">
            <div class="style-analysis-title">Verbal Echo — ὑπονοστήσαντος... ὑπονενοστηκότος</div>
            <div class="style-analysis-lines">Sentences 2-3</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> Herodotus uses two forms of the same verb ὑπονοστέω ('to sink back/recede') in consecutive sentences — the aorist participle <em>ὑπονοστήσαντος</em> in sentence 2 and the perfect participle <em>ὑπονενοστηκότος</em> in sentence 3. The repetition is deliberate: the first, in the aorist, describes the river's sinking as a completed event caused by Cyrus's engineering. The second, in the perfect, describes the resulting state — the river <em>having receded</em> and <em>remaining</em> at a low level. The shift from aorist to perfect marks the progression from action to consequence: Cyrus made the river drop (sentence 2), and now the river <em>is</em> dropped (sentence 3), enabling the Persian advance. The verbal echo also creates a strong thematic link between the two sentences.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The verbal echo between ὑπονοστήσαντος (aorist, sentence 2) and ὑπονενοστηκότος (perfect, sentence 3) traces the progression from Cyrus's action to its consequence. The aorist presents the river's sinking as a completed event; the perfect emphasises the resulting state that enables the Persian invasion. This deliberate repetition with tense variation links the engineering feat to its military payoff."
            </div>
        </div>
    </div>

    <!-- Analysis Mode Overlay -->
    <div id="analysisOverlay" class="analysis-overlay">
        <!-- Toolbar -->
        <div class="analysis-toolbar">
            <div class="analysis-toolbar-section">
                <button class="analysis-btn back-btn" id="analysisBackBtn">Back</button>
                <button class="analysis-btn" id="analysisPrevBtn">&#9664;</button>
                <span class="analysis-nav-label" id="analysisNavLabel">Sentence 1 of 3</span>
                <button class="analysis-btn" id="analysisNextBtn">&#9654;</button>
            </div>
            <div class="analysis-toolbar-section">
                <button class="analysis-btn" id="analysisSaveBtn">Save</button>
                <span class="save-indicator" id="analysisSaveIndicator">Saved</span>
            </div>
        </div>

        <!-- Drawing tools -->
        <div class="analysis-tools-bar">
            <div class="tool-group">
                <button class="analysis-btn active" data-tool="pen" id="toolPen">Pen</button>
                <button class="analysis-btn" data-tool="eraser" id="toolEraser">Eraser</button>
                <button class="analysis-btn" data-tool="pointer" id="toolPointer">Pointer</button>
            </div>
            <span class="tool-divider"></span>
            <div class="tool-group">
                <span class="color-swatch active" data-color="#333333" style="background:#333333;" title="Black"></span>
                <span class="color-swatch" data-color="#e53935" style="background:#e53935;" title="Red"></span>
                <span class="color-swatch" data-color="#1e88e5" style="background:#1e88e5;" title="Blue"></span>
                <span class="color-swatch" data-color="#43a047" style="background:#43a047;" title="Green"></span>
                <span class="color-swatch" data-color="#fb8c00" style="background:#fb8c00;" title="Orange"></span>
            </div>
            <span class="tool-divider"></span>
            <div class="tool-group">
                <button class="size-btn" data-size="2" title="Fine">S</button>
                <button class="size-btn active" data-size="4" title="Medium">M</button>
                <button class="size-btn" data-size="8" title="Thick">L</button>
            </div>
            <span class="tool-divider"></span>
            <div class="tool-group">
                <button class="analysis-btn" id="undoBtn">Undo</button>
                <button class="analysis-btn" id="clearCanvasBtn">Clear</button>
            </div>
            <div class="analysis-key">
                <span class="analysis-key-item" style="background:#ffb3b3;">Subj</span>
                <span class="analysis-key-item" style="background:#b3ffcc;">Obj</span>
                <span class="analysis-key-item" style="background:#b3e6ff;">Verb</span>
                <span class="analysis-key-item" style="background:#ffd9b3;">Gen</span>
                <span class="analysis-key-item" style="background:#e6b3ff;">Dat</span>
                <span class="analysis-key-item" style="background:#ffb3e6;">Prep</span>
                <span class="analysis-key-item" style="background:#d9ffb3;">Conj</span>
                <span class="analysis-key-item" style="background:#ccb3ff;">Adv</span>
                <span class="analysis-key-item" style="background:#ffcbb3;">Ptcp</span>
            </div>
        </div>

        <!-- Workspace -->
        <div class="analysis-workspace" id="analysisWorkspace">
            <div class="analysis-sentence-display" id="analysisSentenceDisplay">
                <div class="analysis-latin-line" id="analysisLatinLine"></div>
                <div class="analysis-english-line" id="analysisEnglishLine"></div>
            </div>
            <canvas id="analysisCanvas"></canvas>
        </div>

        <!-- Notes panel -->
        <div class="analysis-notes" id="analysisNotes">
            <div class="analysis-notes-toggle" id="analysisNotesToggle">
                <h4>Notes</h4>
                <span class="toggle-arrow">&#9650;</span>
            </div>
            <div class="analysis-notes-body">
                <textarea id="analysisNotesText" placeholder="Type your analysis notes here..."></textarea>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let coloursHidden = false;
        const activeCategories = new Set();

        const wordOrders = [];
        document.querySelectorAll('.latin-column .word-group').forEach(group => {
            if (group.dataset.order) {
                wordOrders.push(group.dataset.order);
            }
        });
        wordOrders.sort((a, b) => {
            const [lineA, numA] = a.split('-');
            const [lineB, numB] = b.split('-');
            if (lineA !== lineB) return lineA.localeCompare(lineB);
            return parseInt(numA) - parseInt(numB);
        });

        function revealWord(order) {
            const latinGroup = document.querySelector(`.latin-column .word-group[data-order="${order}"]`);
            if (latinGroup) {
                latinGroup.classList.add('revealed');
            }

            document.querySelectorAll(`.english-word`).forEach(word => {
                if (word.dataset.order) {
                    const orders = word.dataset.order.split(',');
                    if (orders.includes(order)) {
                        word.classList.add('revealed');
                    }
                }
            });
        }

        function hideWord(order) {
            const latinGroup = document.querySelector(`.latin-column .word-group[data-order="${order}"]`);
            if (latinGroup) {
                latinGroup.classList.remove('revealed');
            }

            document.querySelectorAll(`.english-word`).forEach(word => {
                if (word.dataset.order) {
                    const orders = word.dataset.order.split(',');
                    if (orders.includes(order)) {
                        word.classList.remove('revealed');
                    }
                }
            });
        }

        function toggleWord(order) {
            const latinGroup = document.querySelector(`.latin-column .word-group[data-order="${order}"]`);
            if (latinGroup && latinGroup.classList.contains('revealed')) {
                hideWord(order);
            } else {
                revealWord(order);
            }
        }

        function stepForward() {
            if (currentStep < wordOrders.length) {
                revealWord(wordOrders[currentStep]);
                currentStep++;
            }
        }

        function stepBackward() {
            if (currentStep > 0) {
                currentStep--;
                hideWord(wordOrders[currentStep]);
            }
        }

        function toggleCategory(category) {
            const keyItem = document.querySelector(`.key-item[data-category="${category}"]`);

            if (activeCategories.has(category)) {
                activeCategories.delete(category);
                keyItem.classList.remove('active');

                document.querySelectorAll(`.latin-column .word-group.${category}`).forEach(group => {
                    group.classList.remove('highlighted');
                });

                document.querySelectorAll(`.english-word.${category}`).forEach(word => {
                    word.classList.remove('highlighted');
                });
            } else {
                activeCategories.add(category);
                keyItem.classList.add('active');

                document.querySelectorAll(`.latin-column .word-group.${category}`).forEach(group => {
                    group.classList.add('highlighted');
                });

                document.querySelectorAll(`.english-word.${category}`).forEach(word => {
                    word.classList.add('highlighted');
                });
            }
        }

        document.getElementById('showAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.latin-column .word-group').forEach(group => {
                if (group.dataset.order) {
                    revealWord(group.dataset.order);
                }
            });
            currentStep = wordOrders.length;
        });

        document.getElementById('hideAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.revealed').forEach(el => {
                el.classList.remove('revealed');
            });
            document.querySelectorAll('.english-word').forEach(el => {
                el.classList.remove('revealed');
            });
            document.querySelectorAll('.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            document.querySelectorAll('.key-item').forEach(el => {
                el.classList.remove('active');
            });
            activeCategories.clear();
            currentStep = 0;
        });

        document.getElementById('toggleColoursBtn').addEventListener('click', () => {
            coloursHidden = !coloursHidden;
            document.body.classList.toggle('hide-colours', coloursHidden);
            document.getElementById('toggleColoursBtn').textContent =
                coloursHidden ? 'Show Colours' : 'Hide Colours';
        });

        document.querySelectorAll('.key-item').forEach(item => {
            item.addEventListener('click', () => {
                toggleCategory(item.dataset.category);
            });
        });

        document.querySelectorAll('.latin-column .word-group').forEach(group => {
            group.addEventListener('click', () => {
                if (group.dataset.order) {
                    toggleWord(group.dataset.order);
                }
            });
        });

        document.querySelectorAll('.english-word').forEach(word => {
            word.addEventListener('click', () => {
                if (word.dataset.order) {
                    const order = word.dataset.order.split(',')[0];
                    toggleWord(order);
                }
            });
        });

        document.querySelectorAll('.english-column .line-number').forEach(lineNum => {
            lineNum.style.cursor = 'pointer';
            lineNum.addEventListener('click', () => {
                const lineRow = lineNum.closest('.line-row');
                const lineOrders = [];
                lineRow.querySelectorAll('.english-word').forEach(word => {
                    if (word.dataset.order) {
                        word.dataset.order.split(',').forEach(order => {
                            if (!lineOrders.includes(order)) {
                                lineOrders.push(order);
                            }
                        });
                    }
                });

                const firstWord = lineRow.querySelector('.english-word');
                const isRevealed = firstWord && firstWord.classList.contains('revealed');

                lineOrders.forEach(order => {
                    if (isRevealed) {
                        hideWord(order);
                    } else {
                        revealWord(order);
                    }
                });
            });
        });

        document.getElementById('toggleStyleBtn').addEventListener('click', () => {
            document.body.classList.toggle('style-mode');
            const isStyleMode = document.body.classList.contains('style-mode');
            document.getElementById('toggleStyleBtn').textContent =
                isStyleMode ? 'Hide Style' : 'Style Notes';

            if (!isStyleMode) {
                document.querySelectorAll('.style-tag.active').forEach(tag => {
                    tag.classList.remove('active');
                });
                document.querySelectorAll('.style-analysis.active').forEach(analysis => {
                    analysis.classList.remove('active');
                });
                document.querySelectorAll('.active-style').forEach(el => {
                    el.classList.remove('active-style');
                });
            }
        });

        document.querySelectorAll('.style-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const featureId = tag.dataset.feature;
                const isActive = tag.classList.contains('active');

                document.querySelectorAll('.style-tag.active').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.style-analysis.active').forEach(a => a.classList.remove('active'));
                document.querySelectorAll('.active-style').forEach(el => el.classList.remove('active-style'));

                if (!isActive) {
                    tag.classList.add('active');

                    const analysis = document.getElementById('analysis-' + featureId);
                    if (analysis) {
                        analysis.classList.add('active');
                    }

                    document.querySelectorAll('[data-style-feature]').forEach(el => {
                        const features = el.dataset.styleFeature.split(' ');
                        if (features.includes(featureId)) {
                            el.classList.add('active-style');
                        }
                    });
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (window.isAnalysisActive && window.isAnalysisActive()) return;
            if (e.code === 'ArrowRight' || e.code === 'ArrowDown' || e.code === 'PageDown' || e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                stepForward();
            }
            else if (e.code === 'ArrowLeft' || e.code === 'ArrowUp' || e.code === 'PageUp' || e.code === 'Backspace') {
                e.preventDefault();
                stepBackward();
            }
            else if (e.code === 'Escape' || e.code === 'KeyR') {
                document.getElementById('hideAllBtn').click();
            }
        });
        // ===== ANALYSIS MODE =====
        (function() {
            const overlay = document.getElementById('analysisOverlay');
            const canvas = document.getElementById('analysisCanvas');
            const ctx = canvas.getContext('2d');
            const workspace = document.getElementById('analysisWorkspace');

            let analysisActive = false;
            let currentSentenceIdx = 0;
            let drawTool = 'pen';
            let drawColor = '#333333';
            let drawSize = 4;
            let isDrawing = false;
            let lastX = 0, lastY = 0;
            let undoStack = [];
            const MAX_UNDO = 30;

            const sentences = [
                { lines: ['1'], title: 'Sentence 1' },
                { lines: ['2'], title: 'Sentence 2' },
                { lines: ['3'], title: 'Sentence 3' }
            ];

            // === Canvas setup ===
            function resizeCanvas(preserveContent) {
                const rect = workspace.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                let savedData = null;
                if (preserveContent && canvas.width > 0 && canvas.height > 0) {
                    savedData = canvas.toDataURL();
                }
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                if (savedData) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0, rect.width, rect.height);
                    img.src = savedData;
                }
            }

            // === Drawing ===
            function getCoords(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            }

            function saveUndoState() {
                undoStack.push(canvas.toDataURL());
                if (undoStack.length > MAX_UNDO) undoStack.shift();
            }

            function startDraw(e) {
                if (drawTool === 'pointer') return;
                e.preventDefault();
                isDrawing = true;
                saveUndoState();
                const { x, y } = getCoords(e);
                lastX = x; lastY = y;
                ctx.beginPath();
                ctx.arc(x, y, drawSize / 2, 0, Math.PI * 2);
                ctx.globalCompositeOperation = drawTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.fillStyle = drawTool === 'eraser' ? 'rgba(0,0,0,1)' : drawColor;
                ctx.fill();
            }

            function doDraw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getCoords(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.lineWidth = drawSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalCompositeOperation = drawTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.strokeStyle = drawTool === 'eraser' ? 'rgba(0,0,0,1)' : drawColor;
                ctx.stroke();
                lastX = x; lastY = y;
            }

            function stopDraw() {
                isDrawing = false;
            }

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', doDraw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseleave', stopDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', doDraw, { passive: false });
            canvas.addEventListener('touchend', stopDraw);

            // === Undo ===
            function undo() {
                if (undoStack.length === 0) return;
                const prev = undoStack.pop();
                const img = new Image();
                img.onload = () => {
                    const rect = workspace.getBoundingClientRect();
                    ctx.clearRect(0, 0, rect.width, rect.height);
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.drawImage(img, 0, 0, rect.width, rect.height);
                };
                img.src = prev;
            }

            document.getElementById('undoBtn').addEventListener('click', undo);

            document.getElementById('clearCanvasBtn').addEventListener('click', () => {
                saveUndoState();
                const rect = workspace.getBoundingClientRect();
                ctx.clearRect(0, 0, rect.width, rect.height);
            });

            // === Tools ===
            document.querySelectorAll('[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    drawTool = btn.dataset.tool;
                    canvas.className = drawTool === 'pointer' ? 'pointer-mode' :
                                       drawTool === 'eraser' ? 'eraser-mode' : '';
                });
            });

            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    drawColor = swatch.dataset.color;
                    if (drawTool !== 'pen') {
                        document.querySelector('[data-tool="pen"]').click();
                    }
                });
            });

            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    drawSize = parseInt(btn.dataset.size);
                });
            });

            // === Save / Load ===
            function getStorageKey(idx) {
                return 'herodotus-s2-analysis-' + idx;
            }

            function saveAnalysis() {
                try {
                    const data = {
                        canvas: canvas.toDataURL(),
                        notes: document.getElementById('analysisNotesText').value
                    };
                    localStorage.setItem(getStorageKey(currentSentenceIdx), JSON.stringify(data));
                    const indicator = document.getElementById('analysisSaveIndicator');
                    indicator.classList.add('visible');
                    setTimeout(() => indicator.classList.remove('visible'), 1500);
                } catch(e) {}
            }

            function loadAnalysis(idx) {
                const raw = localStorage.getItem(getStorageKey(idx));
                const rect = workspace.getBoundingClientRect();
                ctx.clearRect(0, 0, rect.width, rect.height);
                ctx.globalCompositeOperation = 'source-over';
                document.getElementById('analysisNotesText').value = '';
                undoStack = [];

                if (raw) {
                    try {
                        const data = JSON.parse(raw);
                        if (data.canvas) {
                            const img = new Image();
                            img.onload = () => {
                                ctx.globalCompositeOperation = 'source-over';
                                ctx.drawImage(img, 0, 0, rect.width, rect.height);
                            };
                            img.src = data.canvas;
                        }
                        if (data.notes) {
                            document.getElementById('analysisNotesText').value = data.notes;
                        }
                    } catch(e) {}
                }
            }

            document.getElementById('analysisSaveBtn').addEventListener('click', saveAnalysis);

            // === Sentence display ===
            function showSentence(idx) {
                if (analysisActive && currentSentenceIdx !== idx) {
                    try { saveAnalysis(); } catch(e) {}
                }

                currentSentenceIdx = idx;
                const def = sentences[idx];

                document.getElementById('analysisNavLabel').textContent =
                    def.title + ' (' + (idx + 1) + ' of ' + sentences.length + ')';

                // Build Greek
                const latinEl = document.getElementById('analysisLatinLine');
                latinEl.innerHTML = '';
                def.lines.forEach(line => {
                    const row = document.querySelector('.latin-column .line-row[data-line="' + line + '"]');
                    if (row) {
                        row.querySelectorAll('.word-group').forEach(wg => {
                            const clone = wg.cloneNode(true);
                            clone.style.cursor = 'default';
                            latinEl.appendChild(clone);
                        });
                    }
                });

                // Build English
                const engEl = document.getElementById('analysisEnglishLine');
                engEl.innerHTML = '';
                def.lines.forEach(line => {
                    const row = document.querySelector('.english-column .line-row[data-line="' + line + '"]');
                    if (row) {
                        row.querySelectorAll('.word-group').forEach(wg => {
                            const clone = wg.cloneNode(true);
                            clone.querySelectorAll('.english-word').forEach(ew => ew.classList.add('revealed'));
                            clone.style.cursor = 'default';
                            engEl.appendChild(clone);
                        });
                    }
                });

                requestAnimationFrame(() => loadAnalysis(idx));
            }

            // Nav
            document.getElementById('analysisPrevBtn').addEventListener('click', () => {
                if (currentSentenceIdx > 0) showSentence(currentSentenceIdx - 1);
            });

            document.getElementById('analysisNextBtn').addEventListener('click', () => {
                if (currentSentenceIdx < sentences.length - 1) showSentence(currentSentenceIdx + 1);
            });

            // === Enter / Exit ===
            function enterAnalysis() {
                analysisActive = true;
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                requestAnimationFrame(() => {
                    resizeCanvas(false);
                    showSentence(0);
                });
            }

            function exitAnalysis() {
                try { saveAnalysis(); } catch(e) {}
                analysisActive = false;
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            document.getElementById('analyseBtn').addEventListener('click', enterAnalysis);
            document.getElementById('analysisBackBtn').addEventListener('click', exitAnalysis);

            // Notes toggle
            document.getElementById('analysisNotesToggle').addEventListener('click', () => {
                document.getElementById('analysisNotes').classList.toggle('open');
                requestAnimationFrame(() => resizeCanvas(true));
            });

            // Window resize
            window.addEventListener('resize', () => {
                if (analysisActive) resizeCanvas(true);
            });

            // Analysis keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (!analysisActive) return;
                if (document.activeElement && document.activeElement.tagName === 'TEXTAREA') {
                    if (e.code === 'Escape') {
                        document.activeElement.blur();
                        e.preventDefault();
                    }
                    return;
                }
                if (e.code === 'Escape') {
                    e.preventDefault();
                    exitAnalysis();
                } else if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    if (currentSentenceIdx > 0) showSentence(currentSentenceIdx - 1);
                } else if (e.code === 'ArrowRight') {
                    e.preventDefault();
                    if (currentSentenceIdx < sentences.length - 1) showSentence(currentSentenceIdx + 1);
                } else if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ') {
                    e.preventDefault();
                    undo();
                } else if (e.code === 'KeyS' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    saveAnalysis();
                }
            });

            window.isAnalysisActive = () => analysisActive;
        })();
    </script>
</body>
</html>
