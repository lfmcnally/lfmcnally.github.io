<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Details - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .join-code {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            letter-spacing: 2px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-white {
            background: white;
            color: #0066ff;
        }
        .btn-white:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.3);
        }
        .btn-primary {
            background: #0066ff;
            color: white;
        }
        .btn-primary:hover {
            background: #0052cc;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Class Stats Overview */
        .class-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .class-stat {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .class-stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .class-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #0066ff;
        }
        .class-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Overview Row */
        .overview-row {
            margin-bottom: 1.5rem;
        }
        .leaderboard-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .leaderboard-tabs {
            display: flex;
            gap: 0.25rem;
        }
        .lb-tab {
            padding: 0.35rem 0.6rem;
            background: #f3f4f6;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lb-tab:hover {
            background: #e5e7eb;
        }
        .lb-tab.active {
            background: #0066ff;
            color: white;
        }

        /* Leaderboard */
        .leaderboard-list {
            list-style: none;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        .leaderboard-rank {
            width: 2rem;
            font-weight: 700;
            font-size: 1rem;
            color: #6b7280;
        }
        .leaderboard-rank.gold { color: #f59e0b; }
        .leaderboard-rank.silver { color: #9ca3af; }
        .leaderboard-rank.bronze { color: #b45309; }
        .leaderboard-name {
            flex: 1;
            font-weight: 500;
            color: #1f2937;
        }
        .leaderboard-value {
            font-weight: 600;
            color: #0066ff;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card.full-width {
            grid-column: 1 / -1;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-body {
            padding: 1.25rem;
        }

        /* Students List */
        .students-list {
            list-style: none;
        }
        .students-list li {
            padding: 0.875rem 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .students-list li:last-child {
            border-bottom: none;
        }
        .student-name {
            font-weight: 500;
            color: #0066ff;
            text-decoration: none;
        }
        .student-name:hover {
            text-decoration: underline;
        }
        .student-email {
            color: #6b7280;
            font-size: 0.8rem;
        }
        .student-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-icon {
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-icon:hover {
            background: #e5e7eb;
        }
        .btn-icon.danger:hover {
            background: #fee2e2;
        }

        /* Task Type Selector */
        .task-type-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .task-type-btn {
            flex: 1;
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .task-type-btn:hover {
            border-color: #0066ff;
        }
        .task-type-btn.active {
            border-color: #0066ff;
            background: #eff6ff;
            color: #0066ff;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        .task-form-section {
            display: none;
        }
        .task-form-section.active {
            display: block;
        }

        /* Message */
        .message {
            padding: 0.875rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }
        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            display: block;
        }
        .message.success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
            display: block;
        }

        /* Task Items */
        .task-item {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .task-header {
            padding: 1rem 1.25rem;
            background: #f9fafb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .task-header:hover {
            background: #f3f4f6;
        }
        .task-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .task-toggle {
            font-size: 0.75rem;
            color: #6b7280;
            transition: transform 0.2s;
        }
        .task-item.open .task-toggle {
            transform: rotate(90deg);
        }
        .task-title {
            font-weight: 600;
            color: #1f2937;
        }
        .task-due {
            font-size: 0.85rem;
            color: #6b7280;
            margin-left: 1rem;
        }
        .task-due.overdue {
            color: #dc2626;
            font-weight: 500;
        }
        .task-header-right {
            display: flex;
            gap: 0.5rem;
        }
        .task-body {
            display: none;
            padding: 1.25rem;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
        }
        .task-item.open .task-body {
            display: block;
        }

        /* Progress Table */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .progress-table th,
        .progress-table td {
            padding: 0.875rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .progress-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .progress-table tr:hover {
            background: #f9fafb;
        }
        .progress-table tr:last-child td {
            border-bottom: none;
        }
        .status-complete {
            color: #059669;
            font-weight: 600;
        }
        .status-started {
            color: #f59e0b;
            font-weight: 600;
        }
        .status-not-started {
            color: #9ca3af;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #1f2937;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #1f2937;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-body p {
            color: #4b5563;
            line-height: 1.5;
        }
        .modal-body p strong {
            color: #1f2937;
        }
        .modal-body .warning-text {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Student Mastery Modal */
        .mastery-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .mastery-stat {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        .mastery-stat.mastered { border-left: 3px solid #10b981; }
        .mastery-stat.learning { border-left: 3px solid #f59e0b; }
        .mastery-stat.struggling { border-left: 3px solid #ef4444; }
        .mastery-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .mastery-stat.mastered .mastery-stat-value { color: #10b981; }
        .mastery-stat.learning .mastery-stat-value { color: #f59e0b; }
        .mastery-stat.struggling .mastery-stat-value { color: #ef4444; }
        .mastery-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .word-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
        }
        .word-latin {
            font-weight: 600;
            color: #0066ff;
        }
        .word-english {
            color: #6b7280;
            font-size: 0.85rem;
        }
        .word-stats {
            text-align: right;
            font-size: 0.8rem;
        }
        .word-accuracy {
            font-weight: 600;
        }
        .word-accuracy.good { color: #10b981; }
        .word-accuracy.okay { color: #f59e0b; }
        .word-accuracy.bad { color: #ef4444; }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover { color: #1f2937; }
        .tab-btn.active {
            color: #0066ff;
            border-bottom-color: #0066ff;
        }
        
        /* History styles */
        .tab-content {
            min-height: 300px;
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .history-stat {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        .history-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0066ff;
        }
        .history-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .history-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
        }
        .history-item.completed {
            border-left: 3px solid #10b981;
        }
        .history-item.incomplete {
            border-left: 3px solid #f59e0b;
        }
        .history-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .history-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .history-score {
            font-weight: 600;
            font-size: 1rem;
        }
        .history-score.good { color: #10b981; }
        .history-score.okay { color: #f59e0b; }
        .history-score.bad { color: #ef4444; }
        .history-time {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Task Completion Grid */
        .completion-grid-card {
            margin-bottom: 2rem;
        }
        .completion-grid-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .grid-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .legend-dot.not-started { background: #f3f4f6; border: 1px solid #d1d5db; }
        .legend-dot.completed { background: #10b981; }
        .legend-dot.completed-late { background: #f59e0b; }
        .legend-dot.overdue { background: #ef4444; }
        
        .completion-grid-wrapper {
            overflow-x: auto;
        }
        .completion-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }
        .completion-grid th,
        .completion-grid td {
            padding: 0.6rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .completion-grid th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }
        .completion-grid th.student-col {
            text-align: left;
            width: 140px;
            min-width: 140px;
            position: sticky;
            left: 0;
            background: #f9fafb;
            z-index: 1;
        }
        .completion-grid th.task-col {
            width: 75px;
            min-width: 75px;
            font-size: 0.8rem;
            cursor: help;
        }
        .completion-grid td.student-name {
            text-align: left;
            font-weight: 500;
            color: #1f2937;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            width: 140px;
        }
        .completion-grid td.task-cell {
            width: 75px;
            min-width: 75px;
        }
        .completion-grid tbody tr:hover {
            background: #f9fafb;
        }
        .completion-grid tbody tr:hover td.student-name {
            background: #f9fafb;
        }
        
        /* Cell styling */
        .task-cell-inner {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
            min-width: 50px;
            min-height: 38px;
        }
        .task-cell-inner.not-started {
            background: #f3f4f6;
            color: #9ca3af;
        }
        .task-cell-inner.completed {
            background: #d1fae5;
            color: #065f46;
        }
        .task-cell-inner.completed-late {
            background: #fef3c7;
            color: #92400e;
        }
        .task-cell-inner.overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        .task-cell-inner.in-progress {
            background: #dbeafe;
            color: #1e40af;
        }
        .task-cell-time {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .task-cell-score {
            font-size: 0.7rem;
            opacity: 0.85;
        }
        .task-cell-icon {
            font-size: 0.85rem;
        }
        
        .no-tasks-message {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
        }

        /* Announcements & Resources */
        .announcement-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .announcement-item:last-child {
            margin-bottom: 0;
        }
        .announcement-item.important {
            border-left: 3px solid #ef4444;
            background: #fef2f2;
        }
        .announcement-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .announcement-item-title {
            font-weight: 600;
            color: #1f2937;
        }
        .announcement-item-date {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .announcement-item-content {
            font-size: 0.9rem;
            color: #4b5563;
            line-height: 1.5;
        }
        .announcement-item-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .resource-item:last-child {
            margin-bottom: 0;
        }
        .resource-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .resource-item-icon.pdf { background: #fee2e2; }
        .resource-item-icon.doc { background: #dbeafe; }
        .resource-item-icon.link { background: #dcfce7; }
        .resource-item-icon.video { background: #fef3c7; }
        .resource-item-info {
            flex: 1;
            min-width: 0;
        }
        .resource-item-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }
        .resource-item-url {
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .resource-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        .empty-list {
            text-align: center;
            padding: 1.5rem;
            color: #9ca3af;
            font-size: 0.9rem;
        }
        .add-form {
            background: #f9fafb;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        .add-form.visible {
            display: block;
        }
        .add-form .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .checkbox-group input {
            width: 16px;
            height: 16px;
        }
        .checkbox-group label {
            font-size: 0.85rem;
            color: #4b5563;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .overview-row {
                grid-template-columns: 1fr;
            }
            .class-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .class-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .leaderboard-tabs {
                flex-wrap: wrap;
            }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .task-header-right {
                width: 100%;
                justify-content: flex-end;
            }
            .progress-table {
                font-size: 0.75rem;
            }
            .progress-table th,
            .progress-table td {
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 id="className">Loading...</h1>
                    <div class="join-code" id="joinCode">---</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-white" onclick="openParentsEvening()" title="Presentation view for parents' evening">üë®‚Äçüë©‚Äçüëß Parents' Evening</button>
                    <button class="btn btn-ghost" onclick="copyJoinCode()">üìã Copy Code</button>
                    <button class="btn btn-ghost" onclick="openEditClassModal()">‚úèÔ∏è Rename</button>
                    <button class="btn btn-ghost" onclick="openDeleteClassModal()" style="color: #ef4444;">üóëÔ∏è Delete</button>
                    <a href="teacher-help.html" class="btn btn-ghost">? Help</a>
                    <a href="teacher.html" class="btn btn-white">‚Üê Back to Dashboard</a>
                </div>
            </div>
        </div>

        <!-- Content Settings (for Latin: set texts, for Classics: courses) -->
        <div class="card" id="contentSettingsCard" style="margin-bottom: 1.5rem; display: none;">
            <div class="card-header">
                <span class="card-title">üìã Content Settings</span>
                <span style="font-size: 0.8rem; color: #6b7280;">Select which content students should track</span>
            </div>
            <div class="card-body" id="contentSettingsBody">
                <!-- Latin Set Texts -->
                <div id="setTextSettings" style="display: none;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.75rem;">üìú Set Texts</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                            <input type="checkbox" id="settext_messalina" onchange="saveContentSettings()" style="width: 18px; height: 18px;">
                            <span>Messalina</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                            <input type="checkbox" id="settext_baucis-philemon" onchange="saveContentSettings()" style="width: 18px; height: 18px;">
                            <span>Baucis & Philemon</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                            <input type="checkbox" id="settext_otium" onchange="saveContentSettings()" style="width: 18px; height: 18px;">
                            <span>Otium</span>
                        </label>
                    </div>
                </div>
                <!-- Classics Courses -->
                <div id="classicsCourseSettings" style="display: none;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.75rem;">üèõÔ∏è Courses</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                            <input type="checkbox" id="course_politics" onchange="saveContentSettings()" style="width: 18px; height: 18px;">
                            <span>Politics of the Late Republic</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                            <input type="checkbox" id="course_myth" onchange="saveContentSettings()" style="width: 18px; height: 18px;">
                            <span>Myth & Religion</span>
                        </label>
                    </div>
                </div>
                <div id="settingsSaveStatus" style="margin-top: 0.75rem; font-size: 0.85rem; color: #6b7280;"></div>
            </div>
        </div>

        <!-- Class Stats Overview -->
        <div class="class-stats-grid">
            <div class="class-stat">
                <div class="class-stat-icon">üë•</div>
                <div class="class-stat-value" id="csStudents">0</div>
                <div class="class-stat-label">Students</div>
            </div>
            <div class="class-stat">
                <div class="class-stat-icon">‚è±Ô∏è</div>
                <div class="class-stat-value" id="csTotalTime">0m</div>
                <div class="class-stat-label">Total Practice</div>
            </div>
            <div class="class-stat">
                <div class="class-stat-icon">üéØ</div>
                <div class="class-stat-value" id="csAvgScore">0%</div>
                <div class="class-stat-label">Avg Score</div>
            </div>
            <div class="class-stat">
                <div class="class-stat-icon">‚úÖ</div>
                <div class="class-stat-value" id="csCompletion">0%</div>
                <div class="class-stat-label">Task Completion</div>
            </div>
            <div class="class-stat" id="wordsMasteredStat">
                <div class="class-stat-icon">üìö</div>
                <div class="class-stat-value" id="csWordsMastered">0</div>
                <div class="class-stat-label">Words Mastered</div>
            </div>
        </div>

        <!-- Leaderboard & Alerts Row -->
        <div class="overview-row">
            <div class="card leaderboard-card">
                <div class="card-header">
                    <span class="card-title">üèÜ Leaderboard</span>
                    <div class="leaderboard-tabs">
                        <button class="lb-tab active" onclick="showLeaderboard('time', this)">‚è±Ô∏è Time</button>
                        <button class="lb-tab" id="leaderboardWordsTab" onclick="showLeaderboard('words', this)">üìö Words</button>
                        <button class="lb-tab" onclick="showLeaderboard('streak', this)">üî• Streak</button>
                        <button class="lb-tab" onclick="showLeaderboard('score', this)">üéØ Score</button>
                    </div>
                </div>
                <div class="card-body" id="leaderboardContainer">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Task Completion Grid -->
        <div class="card completion-grid-card">
            <div class="card-header">
                <span class="card-title">üìä Task Completion Overview</span>
                <div class="grid-legend">
                    <span class="legend-item"><span class="legend-dot not-started"></span> Not started</span>
                    <span class="legend-item"><span class="legend-dot completed"></span> Completed</span>
                    <span class="legend-item"><span class="legend-dot completed-late"></span> Late</span>
                    <span class="legend-item"><span class="legend-dot overdue"></span> Overdue</span>
                </div>
            </div>
            <div class="card-body">
                <div id="completionGridContainer">
                    <div class="loading">Loading task data...</div>
                </div>
            </div>
        </div>

        <!-- Set Text Progress Grid -->
        <div class="card completion-grid-card" id="setTextProgressCard" style="margin-top: 1.5rem;">
            <div class="card-header">
                <span class="card-title">üìú Set Text Progress</span>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <select id="setTextGridSelector" class="form-input" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; min-width: 180px;" onchange="loadSetTextGrid()">
                        <option value="messalina">Messalina (Tacitus)</option>
                        <option value="baucis-philemon">Baucis and Philemon (Ovid)</option>
                        <option value="otium">Otium (Catullus)</option>
                    </select>
                    <div class="grid-legend">
                        <span class="legend-item"><span class="legend-dot" style="background: #d1fae5;"></span> 70%+</span>
                        <span class="legend-item"><span class="legend-dot" style="background: #fef3c7;"></span> &lt;70%</span>
                        <span class="legend-item"><span class="legend-dot" style="background: #f3f4f6;"></span> Not started</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="setTextGridContainer">
                    <div class="loading">Loading set text data...</div>
                </div>
            </div>
        </div>

        <!-- Classics Quiz Progress Grid (for Classics classes) -->
        <div class="card completion-grid-card" id="classicsQuizProgressCard" style="margin-top: 1.5rem; display: none;">
            <div class="card-header">
                <span class="card-title">üèõÔ∏è Classics Quiz Progress</span>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <select id="classicsCourseSelector" class="form-input" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; min-width: 180px;" onchange="loadClassicsTopicSelector(); loadClassicsGrid()">
                        <option value="politics">Politics of the Late Republic</option>
                    </select>
                    <select id="classicsTopicSelector" class="form-input" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; min-width: 180px;" onchange="loadClassicsGrid()">
                        <option value="topic-1">Topic 1: The Roman Republic</option>
                    </select>
                    <div class="grid-legend">
                        <span class="legend-item"><span class="legend-dot" style="background: #d1fae5;"></span> 70%+</span>
                        <span class="legend-item"><span class="legend-dot" style="background: #fef3c7;"></span> &lt;70%</span>
                        <span class="legend-item"><span class="legend-dot" style="background: #f3f4f6;"></span> Not started</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="classicsGridContainer">
                    <div class="loading">Loading classics quiz data...</div>
                </div>
            </div>
        </div>

        <!-- Co-Teachers Card (only visible to class owner) -->
        <div class="card" id="coTeachersCard" style="margin-bottom: 1.5rem; display: none;">
            <div class="card-header">
                <span class="card-title">üë®‚Äçüè´ Co-Teachers (<span id="coTeacherCount">0</span>)</span>
                <button class="btn btn-primary btn-sm" id="addCoTeacherBtn" onclick="openAddCoTeacherModal()">+ Add Co-Teacher</button>
            </div>
            <div class="card-body" id="coTeachersContainer">
                <div class="loading">Loading co-teachers...</div>
            </div>
        </div>

        <!-- Vocab Tests Card -->
        <div class="card" id="vocabTestsCard" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <span class="card-title">üìä Vocab Test Scores</span>
                <button class="btn btn-primary btn-sm" onclick="openCreateTestModal()">+ New Test</button>
            </div>
            <div class="card-body" id="vocabTestsContainer">
                <div class="loading">Loading tests...</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="dashboard-grid">
            <!-- Students Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üë• Students (<span id="studentCount">0</span>)</span>
                </div>
                <div class="card-body" id="studentsContainer">
                    <div class="loading">Loading students...</div>
                </div>
            </div>

            <!-- Set Task Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìù Set a New Task</span>
                </div>
                <div class="card-body">
                    <div id="taskMessage" class="message"></div>
                    
                    <div class="task-type-selector">
                        <button class="task-type-btn active" id="vocabTaskOption" onclick="selectTaskType('vocab')">üìñ Vocabulary</button>
                        <button class="task-type-btn" id="setTextTaskOption" onclick="selectTaskType('settext')">üìú Set Text</button>
                        <button class="task-type-btn" id="classicsQuizTaskOption" style="display: none;" onclick="selectTaskType('classicsquiz')">üèõÔ∏è Classics Quiz</button>
                        <button class="task-type-btn" onclick="selectTaskType('custom')">üîó Custom Link</button>
                    </div>
                    
                    <div id="vocabForm" class="task-form-section active">
                        <form id="setVocabTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="vocabTitle" placeholder="e.g. Chapter 7 Vocabulary" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Chapter</label>
                                    <select class="form-input" id="taskChapter" required>
                                        <option value="">Select...</option>
                                        <!-- Populated dynamically based on class type -->
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>From Word</label>
                                    <select class="form-input" id="taskFromWord" required disabled>
                                        <option value="">Select chapter first</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>To Word</label>
                                    <select class="form-input" id="taskToWord" required disabled>
                                        <option value="">Select from word first</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="vocabDueDate" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Vocabulary Task</button>
                        </form>
                    </div>
                    
                    <div id="setTextForm" class="task-form-section">
                        <form id="setSetTextTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="setTextTitle" placeholder="e.g. Messalina Section 1" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Set Text</label>
                                    <select class="form-input" id="setTextSelect" required>
                                        <option value="">Select text...</option>
                                        <option value="messalina">Messalina (Tacitus)</option>
                                        <option value="baucis-philemon">Baucis and Philemon (Ovid)</option>
                                        <option value="otium">Otium (Catullus)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Section</label>
                                    <select class="form-input" id="setTextSection" required disabled>
                                        <option value="">Select text first</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="setTextDueDate" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Literature Task</button>
                        </form>
                    </div>

                    <div id="classicsQuizForm" class="task-form-section">
                        <form id="setClassicsQuizTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="classicsQuizTitle" placeholder="e.g. Topic 1.1: What was the Roman Republic?" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Course</label>
                                    <select class="form-input" id="classicsQuizCourse" required onchange="populateClassicsTopicDropdown()">
                                        <option value="">Select course...</option>
                                        <option value="politics">Politics of the Late Republic</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Topic</label>
                                    <select class="form-input" id="classicsQuizTopic" required disabled onchange="populateClassicsSubtopicDropdown()">
                                        <option value="">Select course first</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Subtopic</label>
                                    <select class="form-input" id="classicsQuizSubtopic" required disabled>
                                        <option value="">Select topic first</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="classicsQuizDueDate" required>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Classics Quiz Task</button>
                        </form>
                    </div>

                    <div id="customForm" class="task-form-section">
                        <form id="setCustomTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="customTitle" placeholder="e.g. Translation Exercise" required>
                            </div>

                            <div class="form-group">
                                <label>Content URL</label>
                                <input type="url" class="form-input" id="customUrl" placeholder="https://classicalia.co.uk/..." required>
                            </div>
                            
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="customDueDate" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Custom Task</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Announcements Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üì¢ Announcements</span>
                    <button class="btn btn-primary btn-sm" onclick="toggleAddAnnouncementForm()">+ Post</button>
                </div>
                <div class="card-body">
                    <div id="addAnnouncementForm" class="add-form">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="form-input" id="announcementTitle" placeholder="e.g. Reminder: Vocab test next week">
                        </div>
                        <div class="form-group">
                            <label>Message</label>
                            <textarea class="form-input" id="announcementContent" rows="3" placeholder="Write your announcement..."></textarea>
                        </div>
                        <div class="form-row-2">
                            <div class="form-group">
                                <label>Expires</label>
                                <input type="date" class="form-input" id="announcementExpires">
                            </div>
                            <div class="checkbox-group" style="margin-top: 1.5rem;">
                                <input type="checkbox" id="announcementImportant">
                                <label for="announcementImportant">Mark as important</label>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="postAnnouncement()">Post Announcement</button>
                            <button class="btn btn-secondary btn-sm" onclick="toggleAddAnnouncementForm()">Cancel</button>
                        </div>
                    </div>
                    <div id="announcementsContainer">
                        <div class="empty-list">No announcements yet</div>
                    </div>
                </div>
            </div>

            <!-- Resources Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìÅ Resources</span>
                    <button class="btn btn-primary btn-sm" onclick="toggleAddResourceForm()">+ Add</button>
                </div>
                <div class="card-body">
                    <div id="addResourceForm" class="add-form">
                        <div class="form-group">
                            <label>Resource Name</label>
                            <input type="text" class="form-input" id="resourceTitle" placeholder="e.g. Chapter 7 Vocab List">
                        </div>
                        <div class="form-row-2">
                            <div class="form-group">
                                <label>URL</label>
                                <input type="url" class="form-input" id="resourceUrl" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select class="form-input" id="resourceType">
                                    <option value="link">üîó Link</option>
                                    <option value="pdf">üìÑ PDF</option>
                                    <option value="doc">üìù Document</option>
                                    <option value="video">üé¨ Video</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="addResource()">Add Resource</button>
                            <button class="btn btn-secondary btn-sm" onclick="toggleAddResourceForm()">Cancel</button>
                        </div>
                    </div>
                    <div id="resourcesContainer">
                        <div class="empty-list">No resources yet</div>
                    </div>
                </div>
            </div>

            <!-- Tasks & Progress Card -->
            <div class="card full-width">
                <div class="card-header">
                    <span class="card-title">üìä Tasks & Progress</span>
                </div>
                <div class="card-body" id="tasksContainer">
                    <div class="loading">Loading tasks...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Student Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Rename Student</h3>
                <button class="modal-close" onclick="closeModal('renameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>New Name</label>
                    <input type="text" class="form-input" id="newStudentName" placeholder="Enter new name">
                </div>
                <input type="hidden" id="renameStudentId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('renameModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRenameStudent()">Save</button>
            </div>
        </div>
    </div>

    <!-- Remove Student Modal -->
    <div class="modal-overlay" id="removeStudentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Remove Student</h3>
                <button class="modal-close" onclick="closeModal('removeStudentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="removeStudentName"></strong> from this class?</p>
                <p class="warning-text">Their progress data will be kept.</p>
                <input type="hidden" id="removeStudentId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('removeStudentModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmRemoveStudent()">Remove</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal-overlay" id="editTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Task</h3>
                <button class="modal-close" onclick="closeModal('editTaskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task Title</label>
                    <input type="text" class="form-input" id="editTaskTitle">
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="datetime-local" class="form-input" id="editTaskDueDate">
                </div>
                <input type="hidden" id="editTaskId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editTaskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditTask()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Task Modal -->
    <div class="modal-overlay" id="deleteTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Task</h3>
                <button class="modal-close" onclick="closeModal('deleteTaskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteTaskName"></strong>?</p>
                <p class="warning-text">This will also delete all student attempts for this task.</p>
                <input type="hidden" id="deleteTaskId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteTaskModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteTask()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div class="modal-overlay" id="editClassModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Rename Class</h3>
                <button class="modal-close" onclick="closeModal('editClassModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Class Name</label>
                    <input type="text" class="form-input" id="editClassName" placeholder="e.g. Year 9 Latin">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editClassModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditClass()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Class Modal -->
    <div class="modal-overlay" id="deleteClassModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Class</h3>
                <button class="modal-close" onclick="closeModal('deleteClassModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteClassName"></strong>?</p>
                <p class="warning-text">‚ö†Ô∏è This will permanently delete:</p>
                <ul style="color: #6b7280; margin: 0.5rem 0 1rem 1.5rem; font-size: 0.9rem;">
                    <li>All student enrolments</li>
                    <li>All assigned tasks</li>
                    <li>All task attempts and progress data</li>
                </ul>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteClassModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteClass()">Delete Class</button>
            </div>
        </div>
    </div>

    <!-- Student Mastery Modal -->
    <div class="modal-overlay" id="studentMasteryModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìä <span id="studentMasteryName">Student</span></h3>
                <button class="modal-close" onclick="closeModal('studentMasteryModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Main tabs -->
                <div class="tabs" style="padding: 0 1rem; border-bottom: 1px solid #e5e7eb;">
                    <button class="tab-btn active" onclick="showMainTab('history', this)">üìÖ History</button>
                    <button class="tab-btn" onclick="showMainTab('words', this)">üìö Word Bank</button>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="tab-content" style="padding: 1rem;">
                    <div class="history-stats">
                        <div class="history-stat">
                            <div class="history-stat-value" id="shTotalSessions">0</div>
                            <div class="history-stat-label">Sessions</div>
                        </div>
                        <div class="history-stat">
                            <div class="history-stat-value" id="shTotalTime">0m</div>
                            <div class="history-stat-label">Total Time</div>
                        </div>
                        <div class="history-stat">
                            <div class="history-stat-value" id="shAvgScore">0%</div>
                            <div class="history-stat-label">Avg Score</div>
                        </div>
                    </div>
                    <div id="studentHistoryList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                
                <!-- Words Tab -->
                <div id="wordsTab" class="tab-content" style="padding: 1rem; display: none;">
                    <div class="mastery-stats">
                        <div class="mastery-stat mastered">
                            <div class="mastery-stat-value" id="smMastered">0</div>
                            <div class="mastery-stat-label">üåü Mastered</div>
                        </div>
                        <div class="mastery-stat learning">
                            <div class="mastery-stat-value" id="smLearning">0</div>
                            <div class="mastery-stat-label">üìñ Learning</div>
                        </div>
                        <div class="mastery-stat struggling">
                            <div class="mastery-stat-value" id="smStruggling">0</div>
                            <div class="mastery-stat-label">üí™ Need Practice</div>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showStudentTab('all', this)">All</button>
                        <button class="tab-btn" onclick="showStudentTab('mastered', this)">Mastered</button>
                        <button class="tab-btn" onclick="showStudentTab('struggling', this)">Struggling</button>
                    </div>
                    <div id="studentWordList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Co-Teacher Modal -->
    <div class="modal-overlay" id="addCoTeacherModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Co-Teacher</h3>
                <button class="modal-close" onclick="closeModal('addCoTeacherModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">Enter the email address of the teacher you want to add as a co-teacher. They must already have a teacher account.</p>
                <div class="form-group">
                    <label>Teacher Email</label>
                    <input type="email" class="form-input" id="coTeacherEmail" placeholder="teacher@school.edu">
                </div>
                <div id="addCoTeacherMessage" class="message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCoTeacherModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addCoTeacher()">Add Co-Teacher</button>
            </div>
        </div>
    </div>

    <!-- Remove Co-Teacher Modal -->
    <div class="modal-overlay" id="removeCoTeacherModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Remove Co-Teacher</h3>
                <button class="modal-close" onclick="closeModal('removeCoTeacherModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="removeCoTeacherName"></strong> as a co-teacher?</p>
                <p class="warning-text">They will no longer have access to this class.</p>
                <input type="hidden" id="removeCoTeacherId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('removeCoTeacherModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmRemoveCoTeacher()">Remove</button>
            </div>
        </div>
    </div>

    <!-- Create Vocab Test Modal -->
    <div class="modal-overlay" id="createTestModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Create Vocab Test</h3>
                <button class="modal-close" onclick="closeModal('createTestModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Test Name</label>
                    <input type="text" class="form-input" id="newTestName" placeholder="e.g. Week 3 Vocab Test">
                </div>
                <div class="form-group">
                    <label>Maximum Score</label>
                    <input type="number" class="form-input" id="newTestMaxScore" placeholder="e.g. 20" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Test Date</label>
                    <input type="date" class="form-input" id="newTestDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createTestModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createVocabTest()">Create Test</button>
            </div>
        </div>
    </div>

    <!-- Edit Test Scores Modal -->
    <div class="modal-overlay" id="editScoresModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="editScoresTitle">Edit Scores</h3>
                <button class="modal-close" onclick="closeModal('editScoresModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <input type="hidden" id="editScoresTestId">
                <div id="scoresTableContainer">
                    <table class="scores-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 0.5rem; border-bottom: 2px solid #e5e7eb;">Student</th>
                                <th style="text-align: right; padding: 0.5rem; border-bottom: 2px solid #e5e7eb; width: 100px;">Score</th>
                            </tr>
                        </thead>
                        <tbody id="scoresTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editScoresModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTestScores()">Save Scores</button>
            </div>
        </div>
    </div>

    <!-- Delete Test Modal -->
    <div class="modal-overlay" id="deleteTestModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Test</h3>
                <button class="modal-close" onclick="closeModal('deleteTestModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteTestName"></strong>?</p>
                <p class="warning-text">All scores for this test will be permanently deleted.</p>
                <input type="hidden" id="deleteTestId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteTestModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteTest()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Vocab Test Modal -->
    <div class="modal-overlay" id="editTestModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Vocab Test</h3>
                <button class="modal-close" onclick="closeModal('editTestModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTestId">
                <div class="form-group">
                    <label>Test Name</label>
                    <input type="text" class="form-input" id="editTestName" placeholder="e.g. Week 3 Vocab Test">
                </div>
                <div class="form-group">
                    <label>Maximum Score</label>
                    <input type="number" class="form-input" id="editTestMaxScore" placeholder="e.g. 20" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Test Date</label>
                    <input type="date" class="form-input" id="editTestDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editTestModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditTest()">Save</button>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    <script src="../shared/vocabulary-data.js"></script>
    <script src="../shared/greek-vocabulary-data.js"></script>
    <script src="../latin/data/suburani-vocab.js"></script>

    <script>
        let currentUser = null;
        let currentClass = null;
        let classStudents = [];
        let classCoTeachers = [];
        let isClassOwner = false;
        
        // Get vocab data based on class type
        function getVocabData() {
            if (!currentClass) return [];
            const type = currentClass.type;
            if (type === 'latin') return typeof vocabularyData !== 'undefined' ? vocabularyData : [];
            if (type === 'greek') return typeof greekVocabularyData !== 'undefined' ? greekVocabularyData : [];
            if (type === 'prep-latin') return typeof suburaniVocabularyData !== 'undefined' ? suburaniVocabularyData : [];
            return [];
        }
        
        // Get vocab practice URL based on class type
        function getVocabPracticeUrl(chapter, from, to) {
            const type = currentClass?.type;
            if (type === 'latin') return `/latin/vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
            if (type === 'greek') return `/greek/vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
            if (type === 'prep-latin') return `/latin/prep-vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
            return `/latin/vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
        }
        
        // Get word display property based on class type
        function getWordProperty(word) {
            if (currentClass?.type === 'greek') return word.greek;
            return word.latin;
        }
        
        // Populate chapter dropdown based on class type
        function populateChapterDropdown() {
            const select = document.getElementById('taskChapter');
            select.innerHTML = '<option value="">Select...</option>';
            
            const type = currentClass?.type;
            const maxChapter = (type === 'prep-latin') ? 16 : 10;
            
            for (let i = 1; i <= maxChapter; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Chapter ${i}`;
                select.appendChild(option);
            }
        }
        
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = 'message ' + type;
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('open');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }
        
        // Close modal when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('open');
                }
            });
        });
        
        function copyJoinCode() {
            const code = document.getElementById('joinCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Join code copied: ' + code);
            });
        }

        function openParentsEvening() {
            window.location.href = `parents-evening.html?class=${currentClass.id}`;
        }

        function selectTaskType(type) {
            document.querySelectorAll('.task-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.task-form-section').forEach(form => form.classList.remove('active'));

            if (type === 'vocab') {
                document.getElementById('vocabTaskOption').classList.add('active');
                document.getElementById('vocabForm').classList.add('active');
            } else if (type === 'settext') {
                document.getElementById('setTextTaskOption').classList.add('active');
                document.getElementById('setTextForm').classList.add('active');
            } else if (type === 'classicsquiz') {
                document.getElementById('classicsQuizTaskOption').classList.add('active');
                document.getElementById('classicsQuizForm').classList.add('active');
            } else {
                document.querySelector('.task-type-btn:last-child').classList.add('active');
                document.getElementById('customForm').classList.add('active');
            }
        }
        
        function toggleTask(taskId) {
            const taskItem = document.getElementById(`task-${taskId}`);
            taskItem.classList.toggle('open');
        }
        
        async function loadClassDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const classId = urlParams.get('id');

            if (!classId) {
                window.location.href = 'teacher.html';
                return;
            }

            const { data: classData, error } = await supabase
                .from('classes')
                .select('*')
                .eq('id', classId)
                .single();

            if (error || !classData) {
                window.location.href = 'teacher.html';
                return;
            }

            currentClass = classData;

            // Check if user is owner or co-teacher
            isClassOwner = classData.teacher_id === currentUser.id;

            if (!isClassOwner) {
                // Check if user is a co-teacher
                const { data: coTeacherEntry } = await supabase
                    .from('class_teachers')
                    .select('id')
                    .eq('class_id', classId)
                    .eq('teacher_id', currentUser.id)
                    .single();

                if (!coTeacherEntry) {
                    // User is neither owner nor co-teacher
                    window.location.href = 'teacher.html';
                    return;
                }
            }

            // Update UI based on ownership status
            if (isClassOwner) {
                // Show co-teachers section
                document.getElementById('coTeachersCard').style.display = 'block';
                await loadCoTeachers();
            } else {
                // Co-teachers can't delete the class
                const deleteBtn = document.querySelector('button[onclick="openDeleteClassModal()"]');
                if (deleteBtn) deleteBtn.style.display = 'none';
            }

            document.getElementById('className').textContent = classData.name;
            document.getElementById('joinCode').textContent = classData.join_code;
            
            // Handle class type - configure task options based on type
            if (classData.type === 'classics') {
                // Hide words mastered stat
                document.getElementById('wordsMasteredStat').style.display = 'none';
                // Hide vocab and set text task forms, show classics quiz
                document.getElementById('vocabTaskOption').style.display = 'none';
                document.getElementById('setTextTaskOption').style.display = 'none';
                document.getElementById('classicsQuizTaskOption').style.display = '';
                selectTaskType('classicsquiz');
                // Hide words tab in leaderboard
                document.getElementById('leaderboardWordsTab').style.display = 'none';
                // Hide set text progress grid, show classics quiz grid
                document.getElementById('setTextProgressCard').style.display = 'none';
                document.getElementById('classicsQuizProgressCard').style.display = 'block';
            } else {
                // Latin GCSE, Greek, and Prep Latin all have vocab tracking
                // Show vocab picker and populate chapters appropriately
                document.getElementById('vocabTaskOption').style.display = '';
                populateChapterDropdown();
                
                // Update vocab button text based on type
                const vocabBtn = document.getElementById('vocabTaskOption');
                if (classData.type === 'greek') {
                    vocabBtn.textContent = 'üè∫ Vocabulary';
                    document.getElementById('setTextTaskOption').style.display = 'none'; // No Greek set texts
                    document.getElementById('setTextProgressCard').style.display = 'none'; // No set text progress for Greek
                } else if (classData.type === 'prep-latin') {
                    vocabBtn.textContent = 'üìö Vocabulary';
                    document.getElementById('setTextTaskOption').style.display = 'none'; // No Prep set texts
                    document.getElementById('setTextProgressCard').style.display = 'none'; // No set text progress for Prep
                } else {
                    vocabBtn.textContent = 'üìñ Vocabulary';
                    document.getElementById('setTextTaskOption').style.display = ''; // Show for Latin GCSE
                    document.getElementById('setTextProgressCard').style.display = 'block'; // Show set text progress for GCSE Latin
                }
            }

            // Show and load content settings
            await loadContentSettings();
        }

        // Load content settings for this class
        async function loadContentSettings() {
            const settingsCard = document.getElementById('contentSettingsCard');
            const setTextSettings = document.getElementById('setTextSettings');
            const classicsCourseSettings = document.getElementById('classicsCourseSettings');

            // Show appropriate settings based on class type
            if (currentClass.type === 'latin') {
                settingsCard.style.display = 'block';
                setTextSettings.style.display = 'block';
                classicsCourseSettings.style.display = 'none';
            } else if (currentClass.type === 'classics') {
                settingsCard.style.display = 'block';
                setTextSettings.style.display = 'none';
                classicsCourseSettings.style.display = 'block';
            } else {
                // Prep Latin and Greek don't have content settings yet
                settingsCard.style.display = 'none';
                return;
            }

            // Load saved settings
            const settings = currentClass.content_settings || {};

            // Apply set text settings
            if (currentClass.type === 'latin') {
                const enabledTexts = settings.set_texts || ['messalina', 'baucis-philemon', 'otium']; // Default all enabled
                document.getElementById('settext_messalina').checked = enabledTexts.includes('messalina');
                document.getElementById('settext_baucis-philemon').checked = enabledTexts.includes('baucis-philemon');
                document.getElementById('settext_otium').checked = enabledTexts.includes('otium');
            }

            // Apply classics course settings
            if (currentClass.type === 'classics') {
                const enabledCourses = settings.courses || ['politics', 'myth']; // Default all enabled
                document.getElementById('course_politics').checked = enabledCourses.includes('politics');
                document.getElementById('course_myth').checked = enabledCourses.includes('myth');
            }
        }

        // Save content settings
        async function saveContentSettings() {
            const statusEl = document.getElementById('settingsSaveStatus');
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#6b7280';

            let settings = currentClass.content_settings || {};

            if (currentClass.type === 'latin') {
                const enabledTexts = [];
                if (document.getElementById('settext_messalina').checked) enabledTexts.push('messalina');
                if (document.getElementById('settext_baucis-philemon').checked) enabledTexts.push('baucis-philemon');
                if (document.getElementById('settext_otium').checked) enabledTexts.push('otium');
                settings.set_texts = enabledTexts;
            }

            if (currentClass.type === 'classics') {
                const enabledCourses = [];
                if (document.getElementById('course_politics').checked) enabledCourses.push('politics');
                if (document.getElementById('course_myth').checked) enabledCourses.push('myth');
                settings.courses = enabledCourses;
            }

            const { error } = await supabase
                .from('classes')
                .update({ content_settings: settings })
                .eq('id', currentClass.id);

            if (error) {
                statusEl.textContent = 'Error: ' + (error.message || error.code || 'Check RLS policies');
                statusEl.style.color = '#dc2626';
                console.error('Error saving content settings:', error);
            } else {
                currentClass.content_settings = settings;
                statusEl.textContent = 'Settings saved ‚úì';
                statusEl.style.color = '#16a34a';
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            }
        }

        // Co-Teacher Management Functions
        async function loadCoTeachers() {
            const container = document.getElementById('coTeachersContainer');

            const { data: coTeacherEntries, error } = await supabase
                .from('class_teachers')
                .select(`
                    id,
                    teacher_id,
                    added_at,
                    users:teacher_id (
                        id,
                        full_name,
                        email
                    )
                `)
                .eq('class_id', currentClass.id);

            if (error) {
                console.error('Error loading co-teachers:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading co-teachers</p></div>';
                return;
            }

            classCoTeachers = (coTeacherEntries || []).map(entry => ({
                id: entry.id,
                teacher_id: entry.teacher_id,
                ...entry.users
            }));

            document.getElementById('coTeacherCount').textContent = classCoTeachers.length;

            if (classCoTeachers.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë®‚Äçüè´</div><p>No co-teachers yet.<br>Add a co-teacher to share class management.</p></div>';
                return;
            }

            let html = '<ul class="students-list">';
            for (const teacher of classCoTeachers) {
                html += `
                    <li>
                        <div>
                            <span class="student-name" style="cursor: default;">${teacher.full_name || 'Unknown'}</span>
                            <div class="student-email">${teacher.email || ''}</div>
                        </div>
                        <div class="student-actions">
                            <button class="btn-icon danger" onclick="showRemoveCoTeacher('${teacher.id}', '${(teacher.full_name || teacher.email || 'this teacher').replace(/'/g, "\\'")}')" title="Remove co-teacher">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            }
            html += '</ul>';
            container.innerHTML = html;
        }

        function openAddCoTeacherModal() {
            document.getElementById('coTeacherEmail').value = '';
            document.getElementById('addCoTeacherMessage').className = 'message';
            document.getElementById('addCoTeacherMessage').textContent = '';
            document.getElementById('addCoTeacherModal').classList.add('open');
        }

        async function addCoTeacher() {
            const email = document.getElementById('coTeacherEmail').value.trim().toLowerCase();
            const messageEl = document.getElementById('addCoTeacherMessage');

            if (!email) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Please enter an email address.';
                return;
            }

            // Find the teacher by email
            const { data: teacherData, error: teacherError } = await supabase
                .from('users')
                .select('id, full_name, email, role')
                .eq('email', email)
                .single();

            if (teacherError || !teacherData) {
                messageEl.className = 'message error';
                messageEl.textContent = 'No user found with this email address.';
                return;
            }

            if (teacherData.role !== 'teacher') {
                messageEl.className = 'message error';
                messageEl.textContent = 'This user is not a teacher account.';
                return;
            }

            if (teacherData.id === currentUser.id) {
                messageEl.className = 'message error';
                messageEl.textContent = 'You cannot add yourself as a co-teacher.';
                return;
            }

            if (teacherData.id === currentClass.teacher_id) {
                messageEl.className = 'message error';
                messageEl.textContent = 'This user is already the class owner.';
                return;
            }

            // Check if already a co-teacher
            const existingCoTeacher = classCoTeachers.find(ct => ct.teacher_id === teacherData.id);
            if (existingCoTeacher) {
                messageEl.className = 'message error';
                messageEl.textContent = 'This teacher is already a co-teacher for this class.';
                return;
            }

            // Add co-teacher
            const { error: insertError } = await supabase
                .from('class_teachers')
                .insert({
                    class_id: currentClass.id,
                    teacher_id: teacherData.id
                });

            if (insertError) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Error adding co-teacher: ' + (insertError.message || 'Unknown error');
                return;
            }

            messageEl.className = 'message success';
            messageEl.textContent = `${teacherData.full_name || email} has been added as a co-teacher!`;

            // Refresh the co-teachers list
            await loadCoTeachers();

            // Close modal after a short delay
            setTimeout(() => {
                closeModal('addCoTeacherModal');
            }, 1500);
        }

        function showRemoveCoTeacher(entryId, name) {
            document.getElementById('removeCoTeacherId').value = entryId;
            document.getElementById('removeCoTeacherName').textContent = name;
            document.getElementById('removeCoTeacherModal').classList.add('open');
        }

        async function confirmRemoveCoTeacher() {
            const entryId = document.getElementById('removeCoTeacherId').value;

            const { error } = await supabase
                .from('class_teachers')
                .delete()
                .eq('id', entryId);

            if (error) {
                alert('Error removing co-teacher: ' + error.message);
                return;
            }

            closeModal('removeCoTeacherModal');
            await loadCoTeachers();
        }

        async function loadStudents() {
            const container = document.getElementById('studentsContainer');
            
            const { data: members, error } = await supabase
                .from('class_members')
                .select(`
                    student_id,
                    joined_at,
                    users (
                        id,
                        full_name,
                        email
                    )
                `)
                .eq('class_id', currentClass.id);
            
            if (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading students</p></div>';
                return;
            }
            
            classStudents = members.map(m => m.users);
            document.getElementById('studentCount').textContent = classStudents.length;
            
            if (classStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No students yet.<br>Share the join code!</p></div>';
                return;
            }
            
            let html = '<ul class="students-list">';
            for (const student of classStudents) {
                html += `
                    <li>
                        <div>
                            <a href="student-profile.html?student_id=${student.id}&class_id=${currentClass.id}" class="student-name" title="View full profile">${student.full_name || 'Unknown'}</a>
                        </div>
                        <div class="student-actions">
                            <a href="student-profile.html?student_id=${student.id}&class_id=${currentClass.id}" class="btn-icon" title="View full profile">üìä</a>
                            <button class="btn-icon" onclick="viewStudentMastery('${student.id}', '${(student.full_name || 'Student').replace(/'/g, "\\'")}')" title="Quick view">üìö</button>
                            ${getVocabProgressLink(student.id)}
                            <button class="btn-icon" onclick="showRenameStudent('${student.id}', '${(student.full_name || '').replace(/'/g, "\\'")}')" title="Rename">‚úèÔ∏è</button>
                            <button class="btn-icon danger" onclick="showRemoveStudent('${student.id}', '${(student.full_name || student.email).replace(/'/g, "\\'")}')" title="Remove">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            }
            html += '</ul>';
            container.innerHTML = html;
        }

        // Generate vocab progress link based on class type
        function getVocabProgressLink(studentId) {
            const classType = currentClass?.type;
            if (classType === 'latin') {
                return `<a href="vocab-progress.html?language=latin&vocab_set=gcse&student_id=${studentId}&class_id=${currentClass.id}" class="btn-icon" title="Vocab progress">üìà</a>`;
            } else if (classType === 'greek') {
                return `<a href="vocab-progress.html?language=greek&vocab_set=gcse&student_id=${studentId}&class_id=${currentClass.id}" class="btn-icon" title="Vocab progress">üìà</a>`;
            }
            return ''; // No vocab progress for other class types
        }

        // View student word mastery
        let currentStudentMastery = { all: [], mastered: [], learning: [], struggling: [] };
        let currentStudentHistory = [];
        let currentStudentId = null;
        
        async function viewStudentMastery(studentId, studentName) {
            currentStudentId = studentId;
            document.getElementById('studentMasteryName').textContent = studentName;
            openModal('studentMasteryModal');
            
            // Reset to history tab
            showMainTab('history', document.querySelector('#studentMasteryModal .tabs .tab-btn'));
            
            // Load both history and word mastery
            await Promise.all([
                loadStudentHistory(studentId),
                loadStudentWords(studentId)
            ]);
        }
        
        // Switch between History and Words tabs
        function showMainTab(tab, btn) {
            // Update active state on main tabs
            document.querySelectorAll('#studentMasteryModal .modal-body > .tabs .tab-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Show/hide content
            document.getElementById('historyTab').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('wordsTab').style.display = tab === 'words' ? 'block' : 'none';
            
            // If switching to words tab, show all words
            if (tab === 'words') {
                const allBtn = document.querySelector('#wordsTab .tabs .tab-btn');
                showStudentTab('all', allBtn);
            }
        }
        
        // Load student practice history
        async function loadStudentHistory(studentId) {
            document.getElementById('studentHistoryList').innerHTML = '<div class="loading">Loading...</div>';
            
            const { data, error } = await supabase
                .from('task_attempts')
                .select('*, tasks(title)')
                .eq('student_id', studentId)
                .order('started_at', { ascending: false })
                .limit(50);
            
            if (error) {
                document.getElementById('studentHistoryList').innerHTML = '<p style="color: #dc2626;">Error loading history</p>';
                return;
            }
            
            currentStudentHistory = data || [];
            
            // Calculate stats
            const totalSessions = currentStudentHistory.length;
            const totalSeconds = currentStudentHistory.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            const totalMinutes = Math.round(totalSeconds / 60);
            const completedWithScores = currentStudentHistory.filter(a => a.score !== null);
            const avgScore = completedWithScores.length > 0 
                ? Math.round(completedWithScores.reduce((sum, a) => sum + a.score, 0) / completedWithScores.length)
                : 0;
            
            document.getElementById('shTotalSessions').textContent = totalSessions;
            document.getElementById('shTotalTime').textContent = totalMinutes + 'm';
            document.getElementById('shAvgScore').textContent = avgScore + '%';
            
            // Render history list
            const container = document.getElementById('studentHistoryList');
            
            if (currentStudentHistory.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No practice sessions yet.</p>';
                return;
            }
            
            container.innerHTML = '<ul class="history-list">' + currentStudentHistory.map(attempt => {
                const isCompleted = attempt.completed_at !== null;
                const title = attempt.tasks?.title || 'Free Practice';
                const date = new Date(attempt.started_at);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const duration = attempt.time_spent_seconds ? Math.round(attempt.time_spent_seconds / 60) + 'm' : '-';
                const score = attempt.score !== null ? attempt.score + '%' : '-';
                const scoreClass = attempt.score >= 70 ? 'good' : attempt.score >= 50 ? 'okay' : 'bad';
                
                return `
                    <li class="history-item ${isCompleted ? 'completed' : 'incomplete'}">
                        <div>
                            <div class="history-title">${title}</div>
                            <div class="history-meta">${dateStr} at ${timeStr} ¬∑ ${duration}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="history-score ${scoreClass}">${score}</div>
                            <div class="history-time">${isCompleted ? '‚úÖ Completed' : '‚è∏Ô∏è Partial'}</div>
                        </div>
                    </li>
                `;
            }).join('') + '</ul>';
        }
        
        // Load student word mastery
        async function loadStudentWords(studentId) {
            // Fetch word mastery for this student
            const { data, error } = await supabase
                .from('word_mastery')
                .select('*')
                .eq('student_id', studentId)
                .order('last_seen_at', { ascending: false });
            
            if (error) {
                console.error('Error loading word mastery:', error);
                return;
            }
            
            // Categorise words
            currentStudentMastery = { all: data || [], mastered: [], learning: [], struggling: [] };
            
            (data || []).forEach(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? (word.correct_count / total) * 100 : 0;
                
                if (word.correct_count >= 3 && accuracy >= 70) {
                    currentStudentMastery.mastered.push({ ...word, accuracy });
                } else if (accuracy < 50 && word.incorrect_count >= 2) {
                    currentStudentMastery.struggling.push({ ...word, accuracy });
                } else {
                    currentStudentMastery.learning.push({ ...word, accuracy });
                }
            });
            
            // Update stats
            document.getElementById('smMastered').textContent = currentStudentMastery.mastered.length;
            document.getElementById('smLearning').textContent = currentStudentMastery.learning.length;
            document.getElementById('smStruggling').textContent = currentStudentMastery.struggling.length;
        }
        
        function showStudentTab(tab, btn) {
            // Update active tab (only within words tab section)
            document.querySelectorAll('#wordsTab .tabs .tab-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Get words for this tab
            let words = currentStudentMastery[tab] || [];
            
            const container = document.getElementById('studentWordList');
            
            if (words.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No words in this category yet.</p>';
                return;
            }
            
            container.innerHTML = '<ul class="word-list">' + words.map(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? Math.round((word.correct_count / total) * 100) : 0;
                const accuracyClass = accuracy >= 70 ? 'good' : accuracy >= 50 ? 'okay' : 'bad';
                
                return `
                    <li class="word-item">
                        <div>
                            <div class="word-latin">${word.word_latin}</div>
                            <div class="word-english">${word.word_english || ''}</div>
                        </div>
                        <div class="word-stats">
                            <div class="word-accuracy ${accuracyClass}">${accuracy}%</div>
                            <div>${word.correct_count}‚úì ${word.incorrect_count}‚úó</div>
                        </div>
                    </li>
                `;
            }).join('') + '</ul>';
        }
        
        // Student management
        function showRenameStudent(studentId, currentName) {
            document.getElementById('renameStudentId').value = studentId;
            document.getElementById('newStudentName').value = currentName;
            openModal('renameModal');
        }
        
        async function confirmRenameStudent() {
            const studentId = document.getElementById('renameStudentId').value;
            const newName = document.getElementById('newStudentName').value.trim();
            
            if (!newName) {
                alert('Please enter a name');
                return;
            }
            
            const { error } = await supabase
                .from('users')
                .update({ full_name: newName })
                .eq('id', studentId);
            
            if (error) {
                alert('Error renaming student: ' + error.message);
                return;
            }
            
            closeModal('renameModal');
            await loadStudents();
        }
        
        function showRemoveStudent(studentId, studentName) {
            document.getElementById('removeStudentId').value = studentId;
            document.getElementById('removeStudentName').textContent = studentName;
            openModal('removeStudentModal');
        }
        
        async function confirmRemoveStudent() {
            const studentId = document.getElementById('removeStudentId').value;
            
            const { error } = await supabase
                .from('class_members')
                .delete()
                .eq('class_id', currentClass.id)
                .eq('student_id', studentId);
            
            if (error) {
                alert('Error removing student: ' + error.message);
                return;
            }
            
            closeModal('removeStudentModal');
            await loadStudents();
        }
        
        // Task management
        function showEditTask(taskId, title, dueDate) {
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskTitle').value = title;
            
            if (dueDate) {
                const date = new Date(dueDate);
                const localDateTime = date.toISOString().slice(0, 16);
                document.getElementById('editTaskDueDate').value = localDateTime;
            }
            
            openModal('editTaskModal');
        }
        
        async function confirmEditTask() {
            const taskId = document.getElementById('editTaskId').value;
            const newTitle = document.getElementById('editTaskTitle').value.trim();
            const newDueDate = document.getElementById('editTaskDueDate').value;
            
            if (!newTitle) {
                alert('Please enter a title');
                return;
            }
            
            const { error } = await supabase
                .from('tasks')
                .update({ 
                    title: newTitle,
                    due_date: newDueDate || null
                })
                .eq('id', taskId);
            
            if (error) {
                alert('Error updating task: ' + error.message);
                return;
            }
            
            closeModal('editTaskModal');
            await loadTasks();
            await loadCompletionGrid();
        }
        
        function showDeleteTask(taskId, taskName) {
            document.getElementById('deleteTaskId').value = taskId;
            document.getElementById('deleteTaskName').textContent = taskName;
            openModal('deleteTaskModal');
        }
        
        async function confirmDeleteTask() {
            const taskId = document.getElementById('deleteTaskId').value;
            
            await supabase
                .from('task_attempts')
                .delete()
                .eq('task_id', taskId);
            
            const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', taskId);
            
            if (error) {
                alert('Error deleting task: ' + error.message);
                return;
            }
            
            closeModal('deleteTaskModal');
            await loadTasks();
            await loadCompletionGrid();
        }
        
        // Class edit/delete functions
        function openEditClassModal() {
            document.getElementById('editClassName').value = currentClass.name;
            openModal('editClassModal');
        }
        
        function openDeleteClassModal() {
            document.getElementById('deleteClassName').textContent = currentClass.name;
            openModal('deleteClassModal');
        }
        
        async function confirmEditClass() {
            const newName = document.getElementById('editClassName').value.trim();
            
            if (!newName) {
                alert('Please enter a class name.');
                return;
            }
            
            const { error } = await supabase
                .from('classes')
                .update({ name: newName })
                .eq('id', currentClass.id);
            
            if (error) {
                alert('Error renaming class: ' + error.message);
                return;
            }
            
            currentClass.name = newName;
            document.getElementById('className').textContent = newName;
            closeModal('editClassModal');
        }
        
        async function confirmDeleteClass() {
            // Delete in order: task_attempts -> tasks -> class_members -> class
            
            // 1. Get all task IDs for this class
            const { data: tasks } = await supabase
                .from('tasks')
                .select('id')
                .eq('class_id', currentClass.id);
            
            // 2. Delete task attempts for those tasks
            if (tasks && tasks.length > 0) {
                const taskIds = tasks.map(t => t.id);
                await supabase
                    .from('task_attempts')
                    .delete()
                    .in('task_id', taskIds);
            }
            
            // 3. Delete tasks
            await supabase
                .from('tasks')
                .delete()
                .eq('class_id', currentClass.id);
            
            // 4. Delete class members
            await supabase
                .from('class_members')
                .delete()
                .eq('class_id', currentClass.id);
            
            // 5. Delete the class
            const { error } = await supabase
                .from('classes')
                .delete()
                .eq('id', currentClass.id);
            
            if (error) {
                alert('Error deleting class: ' + error.message);
                return;
            }
            
            // Redirect to teacher dashboard
            window.location.href = 'teacher.html';
        }
        
        async function loadTasks() {
            const container = document.getElementById('tasksContainer');

            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .eq('class_id', currentClass.id)
                .not('content_path', 'like', 'manual_test%')
                .order('due_date', { ascending: true });
            
            if (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading tasks</p></div>';
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No tasks set yet.<br>Create one using the form above!</p></div>';
                return;
            }
            
            const now = new Date();
            let html = '<p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Click on a task to view student progress</p>';
            
            for (const task of tasks) {
                const dueDate = task.due_date ? new Date(task.due_date) : null;
                const isOverdue = dueDate && dueDate < now;
                
                const dueDateStr = dueDate ? dueDate.toLocaleDateString('en-GB', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'No due date';
                
                html += `
                    <div class="task-item" id="task-${task.id}">
                        <div class="task-header" onclick="toggleTask('${task.id}')">
                            <div class="task-header-left">
                                <span class="task-toggle">‚ñ∂</span>
                                <span class="task-title">${task.title}</span>
                                <span class="task-due ${isOverdue ? 'overdue' : ''}">
                                    ${isOverdue ? '‚ö†Ô∏è Overdue: ' : 'Due: '}${dueDateStr}
                                </span>
                            </div>
                            <div class="task-header-right" onclick="event.stopPropagation()">
                                <button class="btn btn-secondary btn-sm" onclick="showEditTask('${task.id}', '${task.title.replace(/'/g, "\\'")}', '${task.due_date || ''}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteTask('${task.id}', '${task.title.replace(/'/g, "\\'")}')">Delete</button>
                            </div>
                        </div>
                        <div class="task-body">
                            <table class="progress-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Attempts</th>
                                        <th>Best Score</th>
                                        <th>Total Time</th>
                                        <th>First Attempt</th>
                                        <th>Last Attempt</th>
                                    </tr>
                                </thead>
                                <tbody id="progress-${task.id}">
                                    <tr><td colspan="6" style="text-align:center; color:#9ca3af;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            for (const task of tasks) {
                await loadTaskProgress(task.id);
            }
        }
        
        async function loadTaskProgress(taskId) {
            const tbody = document.getElementById(`progress-${taskId}`);

            // Get the task's created_at date to filter other vocab time
            const { data: taskData } = await supabase
                .from('tasks')
                .select('created_at')
                .eq('id', taskId)
                .single();

            const taskCreatedAt = taskData?.created_at;

            const { data: attempts, error } = await supabase
                .from('task_attempts')
                .select('*')
                .eq('task_id', taskId);

            if (error) {
                tbody.innerHTML = '<tr><td colspan="6">Error loading progress</td></tr>';
                return;
            }

            // Fetch "other vocab time" for all students - time spent on vocab practice NOT on this task
            // Only includes practice SINCE this task was created
            const studentIds = classStudents.map(s => s.id);
            const otherVocabStats = {};

            if (studentIds.length > 0 && taskCreatedAt) {
                // Get all vocab-related practice attempts not linked to this task, since task was created
                let query = supabase
                    .from('task_attempts')
                    .select('student_id, time_spent_seconds, started_at, content_path')
                    .in('student_id', studentIds)
                    .or(`task_id.is.null,task_id.neq.${taskId}`)
                    .like('content_path', '%vocabulary-practice%')
                    .gte('started_at', taskCreatedAt);

                const { data: otherAttempts } = await query;

                if (otherAttempts) {
                    for (const attempt of otherAttempts) {
                        if (!otherVocabStats[attempt.student_id]) {
                            otherVocabStats[attempt.student_id] = {
                                totalTime: 0,
                                sessions: 0,
                                lastPractice: null
                            };
                        }
                        const stats = otherVocabStats[attempt.student_id];
                        stats.totalTime += (attempt.time_spent_seconds || 0);
                        stats.sessions++;
                        const startedAt = new Date(attempt.started_at);
                        if (!stats.lastPractice || startedAt > stats.lastPractice) {
                            stats.lastPractice = startedAt;
                        }
                    }
                }
            }

            const studentStats = {};

            for (const attempt of attempts) {
                if (!studentStats[attempt.student_id]) {
                    studentStats[attempt.student_id] = {
                        attempts: 0,
                        bestScore: null,
                        totalTime: 0,
                        firstAttempt: null,
                        lastAttempt: null
                    };
                }

                const stats = studentStats[attempt.student_id];
                stats.attempts++;

                if (attempt.completed_at && attempt.score !== null) {
                    if (stats.bestScore === null || attempt.score > stats.bestScore) {
                        stats.bestScore = attempt.score;
                    }
                }

                if (attempt.time_spent_seconds) {
                    stats.totalTime += attempt.time_spent_seconds;
                }

                const startedAt = new Date(attempt.started_at);
                if (stats.firstAttempt === null || startedAt < stats.firstAttempt) {
                    stats.firstAttempt = startedAt;
                }

                if (attempt.completed_at) {
                    const completedAt = new Date(attempt.completed_at);
                    if (stats.lastAttempt === null || completedAt > stats.lastAttempt) {
                        stats.lastAttempt = completedAt;
                    }
                }
            }

            let html = '';

            for (const student of classStudents) {
                const stats = studentStats[student.id];
                const otherVocab = otherVocabStats[student.id];

                if (!stats) {
                    // Student hasn't started this task - show other vocab time if available
                    let otherVocabDisplay = '';
                    if (otherVocab && otherVocab.totalTime > 0) {
                        const mins = Math.round(otherVocab.totalTime / 60);
                        const lastPracticeStr = otherVocab.lastPractice ?
                            otherVocab.lastPractice.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        otherVocabDisplay = `<div style="font-size: 0.75rem; color: #7c3aed; margin-top: 0.25rem;" title="${otherVocab.sessions} sessions, last: ${lastPracticeStr}">Other vocab: ${mins} min</div>`;
                    }
                    html += `
                        <tr>
                            <td>${student.full_name || student.email}${otherVocabDisplay}</td>
                            <td class="status-not-started">0</td>
                            <td class="status-not-started">‚Äî</td>
                            <td class="status-not-started">‚Äî</td>
                            <td class="status-not-started">Not started</td>
                            <td class="status-not-started">‚Äî</td>
                        </tr>
                    `;
                } else {
                    const bestScoreDisplay = stats.bestScore !== null ?
                        `<span class="${stats.bestScore >= 70 ? 'status-complete' : 'status-started'}">${stats.bestScore}%</span>` :
                        '<span class="status-started">In progress</span>';

                    const totalTimeDisplay = stats.totalTime > 0 ?
                        `${Math.round(stats.totalTime / 60)} min` :
                        '< 1 min';

                    const firstAttemptDisplay = stats.firstAttempt ?
                        stats.firstAttempt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) :
                        '‚Äî';

                    const lastAttemptDisplay = stats.lastAttempt ?
                        stats.lastAttempt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) :
                        '‚Äî';

                    // Show other vocab time indicator if they've also practiced elsewhere
                    let otherVocabDisplay = '';
                    if (otherVocab && otherVocab.totalTime > 0) {
                        const mins = Math.round(otherVocab.totalTime / 60);
                        otherVocabDisplay = `<span style="font-size: 0.7rem; color: #7c3aed; margin-left: 0.5rem;" title="${otherVocab.sessions} other vocab sessions">+${mins}m other</span>`;
                    }

                    html += `
                        <tr>
                            <td>${student.full_name || student.email}</td>
                            <td>${stats.attempts}</td>
                            <td>${bestScoreDisplay}</td>
                            <td>${totalTimeDisplay}${otherVocabDisplay}</td>
                            <td>${firstAttemptDisplay}</td>
                            <td>${lastAttemptDisplay}</td>
                        </tr>
                    `;
                }
            }

            if (html === '') {
                html = '<tr><td colspan="6" class="empty-state">No students in class</td></tr>';
            }

            tbody.innerHTML = html;
        }
        
        // Load the task completion grid
        async function loadCompletionGrid() {
            const container = document.getElementById('completionGridContainer');
            
            // Helper to escape HTML for attributes
            function escapeHtml(text) {
                if (!text) return '';
                return text.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;')
                           .replace(/"/g, '&quot;')
                           .replace(/'/g, '&#039;');
            }
            
            // Get tasks for this class (most recent 10)
            const { data: tasks, error: tasksError } = await supabase
                .from('tasks')
                .select('*')
                .eq('class_id', currentClass.id)
                .order('due_date', { ascending: false })
                .limit(10);
            
            if (tasksError || !tasks || tasks.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No tasks set yet. Create a task to see completion tracking.</div>';
                return;
            }
            
            // Reverse so oldest is first (left to right = chronological)
            const sortedTasks = [...tasks].reverse();
            
            // Get all students in class
            if (classStudents.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No students in class yet.</div>';
                return;
            }
            
            // Get all task attempts for these tasks
            const taskIds = sortedTasks.map(t => t.id);
            const studentIds = classStudents.map(s => s.id);
            
            const { data: attempts, error: attemptsError } = await supabase
                .from('task_attempts')
                .select('*')
                .in('task_id', taskIds)
                .in('student_id', studentIds);
            
            // Build lookup: { taskId: { studentId: { completed, time, score } } }
            const attemptLookup = {};
            if (attempts) {
                attempts.forEach(a => {
                    if (!attemptLookup[a.task_id]) {
                        attemptLookup[a.task_id] = {};
                    }
                    const existing = attemptLookup[a.task_id][a.student_id];
                    const time = a.time_spent_seconds || 0;
                    const score = a.score || 0;
                    
                    if (!existing || score > existing.score) {
                        attemptLookup[a.task_id][a.student_id] = {
                            completed: !!a.completed_at,
                            completedAt: a.completed_at ? new Date(a.completed_at) : null,
                            time: time,
                            score: score,
                            attempts: (existing?.attempts || 0) + 1
                        };
                    } else if (existing) {
                        existing.attempts++;
                        existing.time += time;
                    }
                });
            }
            
            // Build HTML table
            let html = '<div class="completion-grid-wrapper"><table class="completion-grid">';
            
            // Header row
            html += '<thead><tr><th class="student-col">Student</th>';
            sortedTasks.forEach(task => {
                const dueDate = new Date(task.due_date);
                const dueDateStr = dueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                html += `<th class="task-col" title="${escapeHtml(task.title)}">${dueDateStr}</th>`;
            });
            html += '</tr></thead>';
            
            // Body rows
            html += '<tbody>';
            const now = new Date();
            
            classStudents.forEach(student => {
                const name = student.full_name || student.email.split('@')[0];
                html += `<tr><td class="student-name">${name}</td>`;
                
                sortedTasks.forEach(task => {
                    const attempt = attemptLookup[task.id]?.[student.id];
                    const dueDate = new Date(task.due_date);
                    const isOverdue = now > dueDate;
                    
                    let cellClass = 'not-started';
                    let cellContent = '<span class="task-cell-icon">‚Äî</span>';
                    
                    if (attempt && attempt.completed) {
                        const wasLate = attempt.completedAt && attempt.completedAt > dueDate;
                        cellClass = wasLate ? 'completed-late' : 'completed';
                        const mins = Math.round(attempt.time / 60);
                        const timeStr = mins > 0 ? `${mins}m` : '<1m';
                        cellContent = `<span class="task-cell-time">${timeStr}</span>`;
                        if (attempt.score) {
                            cellContent += `<span class="task-cell-score">${attempt.score}%</span>`;
                        }
                    } else if (attempt && !attempt.completed) {
                        cellClass = 'in-progress';
                        cellContent = '<span class="task-cell-icon">‚è≥</span>';
                    } else if (isOverdue) {
                        cellClass = 'overdue';
                        cellContent = '<span class="task-cell-icon">‚úó</span>';
                    }
                    
                    html += `<td class="task-cell"><div class="task-cell-inner ${cellClass}">${cellContent}</div></td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Load the set text progress grid
        async function loadSetTextGrid() {
            const container = document.getElementById('setTextGridContainer');
            const selector = document.getElementById('setTextGridSelector');
            const selectedTextId = selector ? selector.value : 'messalina';

            if (classStudents.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No students in class yet.</div>';
                return;
            }

            const studentIds = classStudents.map(s => s.id);

            // Get set text progress for students in this class, filtered by selected text
            const { data: progress, error: progressError } = await supabase
                .from('set_text_progress')
                .select('*')
                .in('student_id', studentIds)
                .eq('text_id', selectedTextId);

            if (progressError) {
                console.error('Error loading set text progress:', progressError);
                container.innerHTML = '<div class="no-tasks-message">Error loading set text data.</div>';
                return;
            }

            // Define available texts and their sections
            const allTexts = {
                'messalina': { id: 'messalina', name: 'Messalina', shortName: 'Mess.', sections: 9 },
                'baucis-philemon': { id: 'baucis-philemon', name: 'Baucis & Philemon', shortName: 'B&P', sections: 6 },
                'otium': { id: 'otium', name: 'Otium', shortName: 'Otium', sections: 3 }
            };

            // Get selected text config
            const selectedText = allTexts[selectedTextId];
            const texts = [selectedText];
            
            // Build lookup: { textId: { sectionNum: { userId: { score, attempts } } } }
            const progressLookup = {};
            if (progress) {
                progress.forEach(p => {
                    if (!progressLookup[p.text_id]) progressLookup[p.text_id] = {};
                    if (!progressLookup[p.text_id][p.section_id]) progressLookup[p.text_id][p.section_id] = {};
                    
                    const existing = progressLookup[p.text_id][p.section_id][p.student_id];
                    // Use best_score if available, otherwise calculate from questions_correct/questions_total
                    const score = p.best_score != null ? p.best_score :
                        (p.questions_total > 0 ? Math.round((p.questions_correct / p.questions_total) * 100) : 0);
                    
                    if (!existing || score > existing.score) {
                        progressLookup[p.text_id][p.section_id][p.student_id] = {
                            score: score,
                            correct: p.questions_correct,
                            total: p.questions_total,
                            attempts: p.attempts || 1
                        };
                    }
                });
            }
            
            // Check if any progress exists for this text
            const hasAnyProgress = progress && progress.length > 0;
            if (!hasAnyProgress) {
                container.innerHTML = `<div class="no-tasks-message">No ${selectedText.name} attempts yet. Students can practise at the <a href="/latin/literature/set-text-quiz.html?text=${selectedTextId}" target="_blank">Set Text Tester</a>.</div>`;
                return;
            }
            
            // Build HTML table
            let html = '<div class="completion-grid-wrapper"><table class="completion-grid">';
            
            // Header row
            html += '<thead><tr><th class="student-col">Student</th>';
            texts.forEach(text => {
                for (let s = 1; s <= text.sections; s++) {
                    html += `<th class="task-col" title="${text.name} Section ${s}">${text.shortName} ¬ß${s}</th>`;
                }
            });
            html += '</tr></thead>';
            
            // Body rows
            html += '<tbody>';
            
            classStudents.forEach(student => {
                const name = student.full_name || student.email.split('@')[0];
                html += `<tr><td class="student-name">${name}</td>`;
                
                texts.forEach(text => {
                    for (let s = 1; s <= text.sections; s++) {
                        const data = progressLookup[text.id]?.[s]?.[student.id];
                        
                        let cellClass = 'not-started';
                        let cellContent = '<span class="task-cell-icon">‚Äî</span>';
                        
                        if (data) {
                            if (data.score >= 70) {
                                cellClass = 'completed';
                            } else {
                                cellClass = 'completed-late'; // Yellow for <70%
                            }
                            cellContent = `<span class="task-cell-score" style="font-size: 0.9rem; font-weight: 600;">${data.score}%</span>`;
                        }
                        
                        html += `<td class="task-cell"><div class="task-cell-inner ${cellClass}">${cellContent}</div></td>`;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Classics Quiz Progress Grid Functions
        const classicsCoursesData = {
            'politics': {
                id: 'politics',
                title: 'Politics of the Late Republic',
                shortTitle: 'Politics',
                topics: {
                    'topic-1': { title: 'Topic 1: The Roman Republic', subtopics: 5 },
                    'topic-2': { title: 'Topic 2: The End of the Republic', subtopics: 3 },
                    'topic-3': { title: 'Topic 3: Political Violence', subtopics: 4 },
                    'topic-4': { title: 'Topic 4: The First Triumvirate', subtopics: 3 },
                    'topic-5': { title: 'Topic 5: Caesar and the Civil War', subtopics: 4 },
                    'topic-6': { title: 'Topic 6: The Assassination', subtopics: 3 }
                }
            }
        };

        const classicsSubtopicsData = {
            'politics': {
                'topic-1': [
                    { id: '1', number: '1.1', title: 'What was the Roman Republic?' },
                    { id: '2', number: '1.2', title: 'The Constitution' },
                    { id: '3', number: '1.3', title: 'Patronage and Amicitia' },
                    { id: '4', number: '1.4', title: 'Political Ideals' },
                    { id: '5', number: '1.5', title: 'Political Factions' }
                ]
            }
        };

        function loadClassicsTopicSelector() {
            const courseId = document.getElementById('classicsCourseSelector').value;
            const topicSelector = document.getElementById('classicsTopicSelector');
            const course = classicsCoursesData[courseId];

            if (!course) return;

            topicSelector.innerHTML = '';
            Object.entries(course.topics).forEach(([topicId, topic]) => {
                const option = document.createElement('option');
                option.value = topicId;
                option.textContent = topic.title;
                topicSelector.appendChild(option);
            });
        }

        async function loadClassicsGrid() {
            const container = document.getElementById('classicsGridContainer');
            const courseId = document.getElementById('classicsCourseSelector').value;
            const topicId = document.getElementById('classicsTopicSelector').value;

            if (classStudents.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No students in class yet.</div>';
                return;
            }

            const studentIds = classStudents.map(s => s.id);
            const course = classicsCoursesData[courseId];
            const topic = course?.topics[topicId];

            if (!topic) {
                container.innerHTML = '<div class="no-tasks-message">Topic not found.</div>';
                return;
            }

            // Get classics quiz progress for students in this class, filtered by course and topic
            const { data: progress, error: progressError } = await supabase
                .from('classics_quiz_progress')
                .select('*')
                .in('student_id', studentIds)
                .eq('course_id', courseId)
                .eq('topic_id', topicId);

            if (progressError) {
                console.error('Error loading classics quiz progress:', progressError);
                container.innerHTML = '<div class="no-tasks-message">Error loading classics quiz data.</div>';
                return;
            }

            // Build lookup: { subtopicId: { userId: { score, attempts } } }
            const progressLookup = {};
            if (progress) {
                progress.forEach(p => {
                    if (!progressLookup[p.subtopic_id]) progressLookup[p.subtopic_id] = {};

                    const existing = progressLookup[p.subtopic_id][p.student_id];
                    const score = p.score_percentage || 0;

                    if (!existing || score > existing.score) {
                        progressLookup[p.subtopic_id][p.student_id] = {
                            score: score,
                            correct: p.questions_correct,
                            total: p.questions_total,
                            attempts: p.attempts || 1
                        };
                    }
                });
            }

            // Check if any progress exists
            const hasAnyProgress = progress && progress.length > 0;
            if (!hasAnyProgress) {
                container.innerHTML = `<div class="no-tasks-message">No ${topic.title} attempts yet. Students can practise at the <a href="/classics/quiz.html?course=${courseId}&topic=${topicId}" target="_blank">Classics Quiz</a>.</div>`;
                return;
            }

            // Get subtopic data for this topic (only topic-1 has data currently)
            const subtopics = classicsSubtopicsData[courseId]?.[topicId] || [];
            const numSubtopics = topic.subtopics;

            // Build HTML table
            let html = '<div class="completion-grid-wrapper"><table class="completion-grid">';

            // Header row
            html += '<thead><tr><th class="student-col">Student</th>';
            for (let s = 1; s <= numSubtopics; s++) {
                const subtopic = subtopics[s - 1];
                const label = subtopic ? subtopic.number : `¬ß${s}`;
                const title = subtopic ? `${subtopic.number}: ${subtopic.title}` : `Subtopic ${s}`;
                html += `<th class="task-col" title="${title}">${label}</th>`;
            }
            html += '</tr></thead>';

            // Body rows
            html += '<tbody>';

            classStudents.forEach(student => {
                const name = student.full_name || student.email.split('@')[0];
                html += `<tr><td class="student-name">${name}</td>`;

                for (let s = 1; s <= numSubtopics; s++) {
                    const subtopicId = String(s);
                    const data = progressLookup[subtopicId]?.[student.id];

                    let cellClass = 'not-started';
                    let cellContent = '<span class="task-cell-icon">‚Äî</span>';

                    if (data) {
                        if (data.score >= 70) {
                            cellClass = 'completed';
                        } else {
                            cellClass = 'completed-late'; // Yellow for <70%
                        }
                        cellContent = `<span class="task-cell-score" style="font-size: 0.9rem; font-weight: 600;">${data.score}%</span>`;
                    }

                    html += `<td class="task-cell"><div class="task-cell-inner ${cellClass}">${cellContent}</div></td>`;
                }

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Classics Quiz Task Form Functions
        function populateClassicsTopicDropdown() {
            const courseId = document.getElementById('classicsQuizCourse').value;
            const topicSelect = document.getElementById('classicsQuizTopic');
            const subtopicSelect = document.getElementById('classicsQuizSubtopic');

            if (!courseId) {
                topicSelect.innerHTML = '<option value="">Select course first</option>';
                topicSelect.disabled = true;
                subtopicSelect.innerHTML = '<option value="">Select topic first</option>';
                subtopicSelect.disabled = true;
                return;
            }

            const course = classicsCoursesData[courseId];
            topicSelect.innerHTML = '<option value="">Select topic...</option>';
            Object.entries(course.topics).forEach(([topicId, topic]) => {
                topicSelect.innerHTML += `<option value="${topicId}">${topic.title}</option>`;
            });
            topicSelect.disabled = false;

            subtopicSelect.innerHTML = '<option value="">Select topic first</option>';
            subtopicSelect.disabled = true;
        }

        function populateClassicsSubtopicDropdown() {
            const courseId = document.getElementById('classicsQuizCourse').value;
            const topicId = document.getElementById('classicsQuizTopic').value;
            const subtopicSelect = document.getElementById('classicsQuizSubtopic');

            if (!topicId) {
                subtopicSelect.innerHTML = '<option value="">Select topic first</option>';
                subtopicSelect.disabled = true;
                return;
            }

            const subtopics = classicsSubtopicsData[courseId]?.[topicId];
            const topic = classicsCoursesData[courseId]?.topics[topicId];

            subtopicSelect.innerHTML = '<option value="">Select subtopic...</option>';

            if (subtopics && subtopics.length > 0) {
                // Use named subtopics if available
                subtopics.forEach(sub => {
                    subtopicSelect.innerHTML += `<option value="${sub.id}">${sub.number}: ${sub.title}</option>`;
                });
            } else if (topic) {
                // Fall back to generic subtopic numbers
                for (let i = 1; i <= topic.subtopics; i++) {
                    subtopicSelect.innerHTML += `<option value="${i}">Subtopic ${i}</option>`;
                }
            }

            subtopicSelect.disabled = false;
        }

        async function setTask(title, contentPath, dueDate) {
            // Convert datetime-local value to proper ISO 8601 format for PostgreSQL
            const formattedDueDate = dueDate ? new Date(dueDate).toISOString() : null;

            const { data, error } = await supabase
                .from('tasks')
                .insert({
                    class_id: currentClass.id,
                    title: title,
                    content_path: contentPath,
                    due_date: formattedDueDate,
                    created_by: currentUser.id
                });
            
            if (error) {
                return { success: false, error: error.message };
            }
            
            return { success: true };
        }
        
        function waitForVocabularyData() {
            return new Promise((resolve) => {
                const checkData = () => {
                    const vocabData = getVocabData();
                    if (vocabData && vocabData.length > 0) {
                        resolve();
                    } else {
                        setTimeout(checkData, 100);
                    }
                };
                checkData();
            });
        }
        
        async function handleChapterChange() {
            await waitForVocabularyData();
            
            const chapter = document.getElementById('taskChapter').value;
            const fromSelect = document.getElementById('taskFromWord');
            const toSelect = document.getElementById('taskToWord');
            
            if (!chapter) {
                fromSelect.disabled = true;
                fromSelect.innerHTML = '<option value="">Select chapter first</option>';
                toSelect.disabled = true;
                toSelect.innerHTML = '<option value="">Select from word first</option>';
                return;
            }
            
            const vocabData = getVocabData();
            const chapterWords = vocabData.filter(word => word.chapter == chapter);
            
            fromSelect.innerHTML = '<option value="">Select start word</option>';
            chapterWords.forEach((word, index) => {
                const wordText = getWordProperty(word);
                fromSelect.innerHTML += `<option value="${index}">${wordText}</option>`;
            });
            fromSelect.disabled = false;
            
            toSelect.innerHTML = '<option value="">Select from word first</option>';
            toSelect.disabled = true;
        }
        
        async function handleFromWordChange() {
            await waitForVocabularyData();
            
            const chapter = document.getElementById('taskChapter').value;
            const fromIndex = parseInt(document.getElementById('taskFromWord').value);
            const toSelect = document.getElementById('taskToWord');
            
            if (isNaN(fromIndex)) {
                toSelect.disabled = true;
                toSelect.innerHTML = '<option value="">Select from word first</option>';
                return;
            }
            
            const vocabData = getVocabData();
            const chapterWords = vocabData.filter(word => word.chapter == chapter);
            
            toSelect.innerHTML = '<option value="">Select end word</option>';
            for (let i = fromIndex; i < chapterWords.length; i++) {
                const wordText = getWordProperty(chapterWords[i]);
                toSelect.innerHTML += `<option value="${i}">${wordText}</option>`;
            }
            toSelect.disabled = false;
        }
        
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }
            
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if (!profile || profile.role !== 'teacher') {
                window.location.href = '../auth/login.html';
                return;
            }
            
            currentUser = profile;
            
            await loadClassDetails();
            await loadStudents();
            await loadTasks();
            await loadCompletionGrid();

            // Load appropriate progress grid based on class type
            if (currentClass.type === 'classics') {
                await loadClassicsGrid();
            } else {
                await loadSetTextGrid();
            }

            await loadClassStats();
            await loadLeaderboard();

            // Load announcements and resources (may fail if tables don't exist yet)
            await loadAnnouncements();
            await loadResources();
            await loadVocabTests();

            document.getElementById('taskChapter').addEventListener('change', handleChapterChange);
            document.getElementById('taskFromWord').addEventListener('change', handleFromWordChange);
        }
        
        // Class Stats & Leaderboard Data
        let classStatsData = {
            studentStats: [], // Array of { student, attempts, totalTime, avgScore, wordsMastered, streak }
        };
        
        async function loadClassStats() {
            if (classStudents.length === 0) {
                document.getElementById('csStudents').textContent = '0';
                return;
            }
            
            // Get all attempts for all students in this class
            const studentIds = classStudents.map(s => s.id);
            
            const { data: attempts, error: attemptsError } = await supabase
                .from('task_attempts')
                .select('*')
                .in('student_id', studentIds);
            
            const { data: wordMastery, error: wordError } = await supabase
                .from('word_mastery')
                .select('*')
                .in('student_id', studentIds);
            
            // Get tasks for this class to calculate completion
            const { data: tasks } = await supabase
                .from('tasks')
                .select('id')
                .eq('class_id', currentClass.id);
            
            const taskIds = (tasks || []).map(t => t.id);
            
            // Calculate per-student stats
            classStatsData.studentStats = classStudents.map(student => {
                const studentAttempts = (attempts || []).filter(a => a.student_id === student.id);
                const studentWords = (wordMastery || []).filter(w => w.student_id === student.id);
                
                const totalTime = studentAttempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                const completedAttempts = studentAttempts.filter(a => a.score !== null);
                const avgScore = completedAttempts.length > 0
                    ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                    : 0;
                
                // Count mastered words
                const wordsMastered = studentWords.filter(w => {
                    const total = w.correct_count + w.incorrect_count;
                    const acc = total > 0 ? (w.correct_count / total) * 100 : 0;
                    return w.correct_count >= 3 && acc >= 70;
                }).length;
                
                // Calculate streak
                const streak = calculateStreak(studentAttempts);
                
                // Task completion (unique tasks completed)
                const completedTaskIds = [...new Set(
                    studentAttempts
                        .filter(a => a.completed_at && taskIds.includes(a.task_id))
                        .map(a => a.task_id)
                )];
                
                return {
                    student,
                    attempts: studentAttempts.length,
                    totalTime,
                    avgScore,
                    wordsMastered,
                    streak,
                    tasksCompleted: completedTaskIds.length
                };
            });
            
            // Calculate class-wide stats
            const totalStudents = classStudents.length;
            const totalTime = classStatsData.studentStats.reduce((sum, s) => sum + s.totalTime, 0);
            const totalMinutes = Math.round(totalTime / 60);
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
            
            const studentsWithScores = classStatsData.studentStats.filter(s => s.avgScore > 0);
            const avgScore = studentsWithScores.length > 0
                ? Math.round(studentsWithScores.reduce((sum, s) => sum + s.avgScore, 0) / studentsWithScores.length)
                : 0;
            
            // Task completion rate
            const totalTasksAssigned = taskIds.length * totalStudents;
            const totalTasksCompleted = classStatsData.studentStats.reduce((sum, s) => sum + s.tasksCompleted, 0);
            const completionRate = totalTasksAssigned > 0
                ? Math.round((totalTasksCompleted / totalTasksAssigned) * 100)
                : 0;
            
            const totalWordsMastered = classStatsData.studentStats.reduce((sum, s) => sum + s.wordsMastered, 0);
            
            // Update display
            document.getElementById('csStudents').textContent = totalStudents;
            document.getElementById('csTotalTime').textContent = timeStr;
            document.getElementById('csAvgScore').textContent = avgScore + '%';
            document.getElementById('csCompletion').textContent = completionRate + '%';
            document.getElementById('csWordsMastered').textContent = totalWordsMastered;
        }
        
        function calculateStreak(attempts) {
            if (!attempts || attempts.length === 0) return 0;
            
            const completedAttempts = attempts.filter(a => a.completed_at);
            if (completedAttempts.length === 0) return 0;
            
            // Get unique dates
            const dates = [...new Set(completedAttempts.map(a => 
                new Date(a.completed_at).toISOString().split('T')[0]
            ))].sort().reverse();
            
            if (dates.length === 0) return 0;
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            // Check if most recent is today or yesterday
            if (dates[0] !== today && dates[0] !== yesterday) return 0;
            
            let streak = 1;
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i - 1]);
                const currDate = new Date(dates[i]);
                const diff = (prevDate - currDate) / 86400000;
                
                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        async function loadLeaderboard() {
            showLeaderboard('time', document.querySelector('.lb-tab.active'));
        }
        
        function showLeaderboard(type, btn) {
            // Update active tab
            document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            const container = document.getElementById('leaderboardContainer');
            
            if (classStatsData.studentStats.length === 0) {
                container.innerHTML = '<div class="loading" style="padding: 2rem;">No data yet</div>';
                return;
            }
            
            let sorted = [...classStatsData.studentStats];
            let valueFormatter;
            
            switch (type) {
                case 'time':
                    sorted.sort((a, b) => b.totalTime - a.totalTime);
                    valueFormatter = s => {
                        const mins = Math.round(s.totalTime / 60);
                        return mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins}m`;
                    };
                    break;
                case 'words':
                    sorted.sort((a, b) => b.wordsMastered - a.wordsMastered);
                    valueFormatter = s => `${s.wordsMastered} words`;
                    break;
                case 'streak':
                    sorted.sort((a, b) => b.streak - a.streak);
                    valueFormatter = s => s.streak > 0 ? `${s.streak} days üî•` : '-';
                    break;
                case 'score':
                    sorted.sort((a, b) => b.avgScore - a.avgScore);
                    valueFormatter = s => s.avgScore > 0 ? `${s.avgScore}%` : '-';
                    break;
            }
            
            container.innerHTML = '<ul class="leaderboard-list">' + 
                sorted.slice(0, 10).map((s, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;
                    return `
                        <li class="leaderboard-item">
                            <span class="leaderboard-rank ${rankClass}">${medal}</span>
                            <span class="leaderboard-name">${s.student.full_name || 'Unknown'}</span>
                            <span class="leaderboard-value">${valueFormatter(s)}</span>
                        </li>
                    `;
                }).join('') + '</ul>';
        }
        
        document.getElementById('setVocabTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('vocabTitle').value.trim();
            const chapter = document.getElementById('taskChapter').value;
            const fromWord = document.getElementById('taskFromWord').value;
            const toWord = document.getElementById('taskToWord').value;
            const dueDate = document.getElementById('vocabDueDate').value;
            
            if (!chapter || fromWord === '' || toWord === '') {
                showMessage('taskMessage', 'Please select chapter and word range.', 'error');
                return;
            }
            
            const contentPath = getVocabPracticeUrl(chapter, fromWord, toWord);
            
            const result = await setTask(title, contentPath, dueDate);
            
            if (result.success) {
                showMessage('taskMessage', 'Task created successfully!', 'success');
                document.getElementById('setVocabTaskForm').reset();
                document.getElementById('taskFromWord').disabled = true;
                document.getElementById('taskToWord').disabled = true;
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });
        
        document.getElementById('setCustomTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('customTitle').value.trim();
            const url = document.getElementById('customUrl').value.trim();
            const dueDate = document.getElementById('customDueDate').value;
            
            const result = await setTask(title, url, dueDate);
            
            if (result.success) {
                showMessage('taskMessage', 'Task created successfully!', 'success');
                document.getElementById('setCustomTaskForm').reset();
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });
        
        // Set Text data
        const setTextData = {
            messalina: {
                title: 'Messalina',
                author: 'Tacitus',
                sections: [
                    { num: 1, lines: '1-8', title: 'Silius is forced to have an affair with Messalina' },
                    { num: 2, lines: '8-17', title: "Messalina's visits to Silius become increasingly more frequent" },
                    { num: 3, lines: '17-26', title: 'Eventually, Messalina decides to marry Silius' },
                    { num: 4, lines: '27-38', title: 'Widespread knowledge of the affair prompts Narcissus to take action' },
                    { num: 5, lines: '39-49', title: 'The marriage becomes known to Claudius' },
                    { num: 6, lines: '49-59', title: 'Silius hides and Messalina appeals to Claudius' },
                    { num: 7, lines: '60-69', title: 'Narcissus arranges the assassination of Messalina' },
                    { num: 8, lines: '70-79', title: 'Narcissus orders a tribune to murder Messalina' },
                    { num: 9, lines: '79-89', title: 'Messalina is killed by the tribune' }
                ]
            },
            'baucis-philemon': {
                title: 'Baucis and Philemon',
                author: 'Ovid',
                sections: [
                    { num: 1, lines: '1-11', title: 'Jupiter and Mercury Arrive' },
                    { num: 2, lines: '12-25', title: 'The Gods are Welcomed' },
                    { num: 3, lines: '26-35', title: 'Arrangements for the Unexpected Guests' },
                    { num: 4, lines: '36-50', title: 'The Miracle & The Command' },
                    { num: 5, lines: '50-63', title: 'The house is turned into a temple' },
                    { num: 6, lines: '64-76', title: 'Philemon asks that he and Baucis may die at the same time' }
                ]
            }
        };
        
        // Handle text selection change
        document.getElementById('setTextSelect').addEventListener('change', function() {
            const textId = this.value;
            const sectionSelect = document.getElementById('setTextSection');
            
            if (!textId) {
                sectionSelect.innerHTML = '<option value="">Select text first</option>';
                sectionSelect.disabled = true;
                return;
            }
            
            const textData = setTextData[textId];
            sectionSelect.innerHTML = '<option value="">Select section...</option>';
            
            textData.sections.forEach(s => {
                const option = document.createElement('option');
                option.value = s.num;
                option.textContent = `Section ${s.num} (Lines ${s.lines}): ${s.title}`;
                sectionSelect.appendChild(option);
            });
            
            sectionSelect.disabled = false;
            
            // Auto-fill title
            const titleInput = document.getElementById('setTextTitle');
            if (!titleInput.value) {
                titleInput.value = `${textData.title} Section`;
            }
        });
        
        // Handle section selection - update title
        document.getElementById('setTextSection').addEventListener('change', function() {
            const textId = document.getElementById('setTextSelect').value;
            const sectionNum = this.value;
            
            if (textId && sectionNum) {
                const textData = setTextData[textId];
                const section = textData.sections.find(s => s.num == sectionNum);
                document.getElementById('setTextTitle').value = `${textData.title} Section ${sectionNum}: ${section.title}`;
            }
        });
        
        // Set text form submission
        document.getElementById('setSetTextTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const title = document.getElementById('setTextTitle').value.trim();
            const textId = document.getElementById('setTextSelect').value;
            const sectionNum = document.getElementById('setTextSection').value;
            const dueDate = document.getElementById('setTextDueDate').value;

            if (!textId || !sectionNum) {
                showMessage('taskMessage', 'Please select a text and section', 'error');
                return;
            }

            const contentPath = `/latin/literature/set-text-quiz.html?text=${textId}&section=${sectionNum}`;

            const result = await setTask(title, contentPath, dueDate);

            if (result.success) {
                showMessage('taskMessage', 'Literature task created successfully!', 'success');
                document.getElementById('setSetTextTaskForm').reset();
                document.getElementById('setTextSection').disabled = true;
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });

        // Classics quiz form submission
        document.getElementById('setClassicsQuizTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const title = document.getElementById('classicsQuizTitle').value.trim();
            const courseId = document.getElementById('classicsQuizCourse').value;
            const topicId = document.getElementById('classicsQuizTopic').value;
            const subtopicId = document.getElementById('classicsQuizSubtopic').value;
            const dueDate = document.getElementById('classicsQuizDueDate').value;

            if (!courseId || !topicId || !subtopicId) {
                showMessage('taskMessage', 'Please select a course, topic, and subtopic', 'error');
                return;
            }

            const contentPath = `/classics/quiz.html?course=${courseId}&topic=${topicId}&subtopic=${subtopicId}`;

            const result = await setTask(title, contentPath, dueDate);

            if (result.success) {
                showMessage('taskMessage', 'Classics quiz task created successfully!', 'success');
                document.getElementById('setClassicsQuizTaskForm').reset();
                document.getElementById('classicsQuizTopic').disabled = true;
                document.getElementById('classicsQuizSubtopic').disabled = true;
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });

        // =====================
        // ANNOUNCEMENTS & RESOURCES
        // =====================

        let announcements = [];
        let resources = [];

        function toggleAddAnnouncementForm() {
            const form = document.getElementById('addAnnouncementForm');
            form.classList.toggle('visible');
            if (form.classList.contains('visible')) {
                // Set default expiry date to 2 weeks from now
                const twoWeeks = new Date();
                twoWeeks.setDate(twoWeeks.getDate() + 14);
                document.getElementById('announcementExpires').value = twoWeeks.toISOString().split('T')[0];
            }
        }

        function toggleAddResourceForm() {
            const form = document.getElementById('addResourceForm');
            form.classList.toggle('visible');
        }

        async function loadAnnouncements() {
            try {
                const { data, error } = await supabase
                    .from('class_announcements')
                    .select('*')
                    .eq('class_id', currentClass.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.log('Announcements table not available:', error.message);
                    return;
                }

                announcements = data || [];
                renderAnnouncements();
            } catch (e) {
                console.log('Error loading announcements:', e);
            }
        }

        function renderAnnouncements() {
            const container = document.getElementById('announcementsContainer');

            if (announcements.length === 0) {
                container.innerHTML = '<div class="empty-list">No announcements yet</div>';
                return;
            }

            container.innerHTML = announcements.map(a => {
                const date = new Date(a.created_at);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const importantClass = a.is_important ? 'important' : '';

                return `
                    <div class="announcement-item ${importantClass}">
                        <div class="announcement-item-header">
                            <div class="announcement-item-title">${escapeHtml(a.title)}</div>
                            <div class="announcement-item-date">${dateStr}</div>
                        </div>
                        <div class="announcement-item-content">${escapeHtml(a.content)}</div>
                        <div class="announcement-item-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteAnnouncement('${a.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function postAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const expiresStr = document.getElementById('announcementExpires').value;
            const isImportant = document.getElementById('announcementImportant').checked;

            if (!title || !content) {
                alert('Please fill in all fields');
                return;
            }

            const expires = expiresStr ? new Date(expiresStr).toISOString() : new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString();

            try {
                const { error } = await supabase
                    .from('class_announcements')
                    .insert({
                        class_id: currentClass.id,
                        title: title,
                        content: content,
                        expires_at: expires,
                        is_important: isImportant
                    });

                if (error) throw error;

                // Clear form and reload
                document.getElementById('announcementTitle').value = '';
                document.getElementById('announcementContent').value = '';
                document.getElementById('announcementImportant').checked = false;
                toggleAddAnnouncementForm();
                await loadAnnouncements();

            } catch (e) {
                alert('Error posting announcement: ' + e.message);
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('Delete this announcement?')) return;

            try {
                const { error } = await supabase
                    .from('class_announcements')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                await loadAnnouncements();
            } catch (e) {
                alert('Error deleting announcement: ' + e.message);
            }
        }

        async function loadResources() {
            try {
                const { data, error } = await supabase
                    .from('class_resources')
                    .select('*')
                    .eq('class_id', currentClass.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.log('Resources table not available:', error.message);
                    return;
                }

                resources = data || [];
                renderResources();
            } catch (e) {
                console.log('Error loading resources:', e);
            }
        }

        function renderResources() {
            const container = document.getElementById('resourcesContainer');

            if (resources.length === 0) {
                container.innerHTML = '<div class="empty-list">No resources yet</div>';
                return;
            }

            const typeIcons = {
                'pdf': { icon: 'üìÑ', class: 'pdf' },
                'doc': { icon: 'üìù', class: 'doc' },
                'docx': { icon: 'üìù', class: 'doc' },
                'link': { icon: 'üîó', class: 'link' },
                'video': { icon: 'üé¨', class: 'video' },
            };

            container.innerHTML = resources.map(r => {
                const typeInfo = typeIcons[r.resource_type] || typeIcons['link'];

                return `
                    <div class="resource-item">
                        <div class="resource-item-icon ${typeInfo.class}">${typeInfo.icon}</div>
                        <div class="resource-item-info">
                            <div class="resource-item-name">${escapeHtml(r.title)}</div>
                            <div class="resource-item-url">${escapeHtml(r.url)}</div>
                        </div>
                        <div class="resource-item-actions">
                            <a href="${escapeHtml(r.url)}" target="_blank" class="btn btn-primary btn-sm">Open</a>
                            <button class="btn btn-danger btn-sm" onclick="deleteResource('${r.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addResource() {
            const title = document.getElementById('resourceTitle').value.trim();
            const url = document.getElementById('resourceUrl').value.trim();
            const type = document.getElementById('resourceType').value;

            if (!title || !url) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const { error } = await supabase
                    .from('class_resources')
                    .insert({
                        class_id: currentClass.id,
                        title: title,
                        url: url,
                        resource_type: type
                    });

                if (error) throw error;

                // Clear form and reload
                document.getElementById('resourceTitle').value = '';
                document.getElementById('resourceUrl').value = '';
                document.getElementById('resourceType').value = 'link';
                toggleAddResourceForm();
                await loadResources();

            } catch (e) {
                alert('Error adding resource: ' + e.message);
            }
        }

        async function deleteResource(id) {
            if (!confirm('Delete this resource?')) return;

            try {
                const { error } = await supabase
                    .from('class_resources')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                await loadResources();
            } catch (e) {
                alert('Error deleting resource: ' + e.message);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;')
                       .replace(/"/g, '&quot;')
                       .replace(/'/g, '&#039;');
        }

        // ========== VOCAB TESTS ==========
        let vocabTests = [];

        async function loadVocabTests() {
            const container = document.getElementById('vocabTestsContainer');

            const { data: tests, error } = await supabase
                .from('tasks')
                .select('*')
                .eq('class_id', currentClass.id)
                .like('content_path', 'manual_test%')
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = '<p style="color: #dc2626;">Error loading tests</p>';
                return;
            }

            vocabTests = tests || [];

            if (vocabTests.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">No vocab tests yet. Click "+ New Test" to create one.</p>';
                return;
            }

            const testIds = vocabTests.map(t => t.id);
            const { data: allScores } = await supabase
                .from('task_attempts')
                .select('*')
                .in('task_id', testIds);

            const scoresByTest = {};
            (allScores || []).forEach(s => {
                if (!scoresByTest[s.task_id]) scoresByTest[s.task_id] = [];
                scoresByTest[s.task_id].push(s);
            });

            let html = '<div class="vocab-tests-list">';
            for (const test of vocabTests) {
                const scores = scoresByTest[test.id] || [];
                const presentScores = scores.filter(s => s.score !== -1);
                const notPresentCount = scores.filter(s => s.score === -1).length;
                const enteredCount = scores.length;
                const avgScore = presentScores.length > 0
                    ? Math.round(presentScores.reduce((sum, s) => sum + (s.score || 0), 0) / presentScores.length)
                    : null;
                const maxScore = test.content_path && test.content_path.includes(':') ? parseInt(test.content_path.split(':')[1]) : 20;
                const testDate = test.due_date ? test.due_date.split('T')[0] : '';
                const testDateDisplay = testDate ? new Date(testDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';

                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                        <div>
                            <div style="font-weight: 600;">${escapeHtml(test.title)}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">
                                ${testDateDisplay ? testDateDisplay + ' ¬∑ ' : ''}Max: ${maxScore} ¬∑ ${enteredCount}/${classStudents.length} entered${notPresentCount > 0 ? ` (${notPresentCount} NP)` : ''}
                                ${avgScore !== null ? ` ¬∑ Avg: ${avgScore}/${maxScore}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="openEditTestModal('${test.id}', '${escapeHtml(test.title).replace(/'/g, "\\'")}', ${maxScore}, '${testDate}')">Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="openEditScoresModal('${test.id}', '${escapeHtml(test.title).replace(/'/g, "\\'")}', ${maxScore})">Scores</button>
                            <button class="btn btn-danger btn-sm" onclick="showDeleteTest('${test.id}', '${escapeHtml(test.title).replace(/'/g, "\\'")}')" style="padding: 0.25rem 0.5rem;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function openCreateTestModal() {
            document.getElementById('newTestName').value = '';
            document.getElementById('newTestMaxScore').value = '20';
            document.getElementById('newTestDate').value = new Date().toISOString().split('T')[0];
            openModal('createTestModal');
        }

        async function createVocabTest() {
            const name = document.getElementById('newTestName').value.trim();
            const maxScore = document.getElementById('newTestMaxScore').value;
            const testDate = document.getElementById('newTestDate').value;

            if (!name) { alert('Please enter a test name'); return; }
            if (!maxScore || maxScore < 1) { alert('Please enter a valid maximum score'); return; }

            const { error } = await supabase
                .from('tasks')
                .insert({
                    class_id: currentClass.id,
                    title: name,
                    content_path: 'manual_test:' + maxScore,
                    due_date: testDate ? testDate + 'T00:00:00' : null,
                    created_by: currentUser.id
                });

            if (error) { alert('Error creating test: ' + error.message); return; }

            closeModal('createTestModal');
            await loadVocabTests();
        }

        async function openEditScoresModal(testId, testName, maxScore) {
            document.getElementById('editScoresTestId').value = testId;
            document.getElementById('editScoresTitle').textContent = testName + ' (/' + maxScore + ')';

            const { data: scores } = await supabase
                .from('task_attempts')
                .select('*')
                .eq('task_id', testId);

            const scoreMap = {};
            (scores || []).forEach(s => { scoreMap[s.student_id] = s.score; });

            const tbody = document.getElementById('scoresTableBody');
            tbody.innerHTML = classStudents.map(student => {
                const currentScore = scoreMap[student.id];
                const isNotPresent = currentScore === -1;
                const displayScore = currentScore !== undefined && currentScore !== -1 ? currentScore : '';
                return `
                    <tr>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6;">${escapeHtml(student.full_name || 'Unknown')}</td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;">
                            <label style="font-size: 0.75rem; color: #6b7280; display: flex; align-items: center; gap: 0.25rem;">
                                <input type="checkbox" class="not-present-checkbox" data-student-id="${student.id}" ${isNotPresent ? 'checked' : ''} onchange="toggleNotPresent(this)">
                                NP
                            </label>
                            <input type="number" class="form-input score-input" data-student-id="${student.id}" value="${displayScore}" min="0" max="${maxScore}" style="width: 70px; text-align: center; padding: 0.25rem;" ${isNotPresent ? 'disabled' : ''}>
                        </td>
                    </tr>
                `;
            }).join('');

            openModal('editScoresModal');
        }

        function toggleNotPresent(checkbox) {
            const studentId = checkbox.dataset.studentId;
            const scoreInput = document.querySelector(`.score-input[data-student-id="${studentId}"]`);
            if (checkbox.checked) {
                scoreInput.disabled = true;
                scoreInput.value = '';
            } else {
                scoreInput.disabled = false;
            }
        }

        async function saveTestScores() {
            const testId = document.getElementById('editScoresTestId').value;
            const test = vocabTests.find(t => t.id === testId);
            const maxScore = test && test.content_path && test.content_path.includes(':') ? parseInt(test.content_path.split(':')[1]) : 20;

            const inputs = document.querySelectorAll('#scoresTableBody .score-input');
            const scoresToSave = [];

            inputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const notPresentCheckbox = document.querySelector(`.not-present-checkbox[data-student-id="${studentId}"]`);
                const isNotPresent = notPresentCheckbox && notPresentCheckbox.checked;
                const value = input.value.trim();

                if (isNotPresent) {
                    scoresToSave.push({ student_id: studentId, score: -1 });
                } else if (value !== '') {
                    scoresToSave.push({ student_id: studentId, score: parseInt(value) });
                }
            });

            await supabase.from('task_attempts').delete().eq('task_id', testId);

            if (scoresToSave.length > 0) {
                const { error } = await supabase
                    .from('task_attempts')
                    .insert(scoresToSave.map(s => ({
                        task_id: testId,
                        student_id: s.student_id,
                        score: s.score,
                        started_at: new Date().toISOString(),
                        completed_at: new Date().toISOString()
                    })));
                if (error) { alert('Error saving scores: ' + error.message); return; }
            }

            closeModal('editScoresModal');
            await loadVocabTests();
        }

        function showDeleteTest(testId, testName) {
            document.getElementById('deleteTestId').value = testId;
            document.getElementById('deleteTestName').textContent = testName;
            openModal('deleteTestModal');
        }

        async function confirmDeleteTest() {
            const testId = document.getElementById('deleteTestId').value;
            await supabase.from('task_attempts').delete().eq('task_id', testId);
            const { error } = await supabase.from('tasks').delete().eq('id', testId);
            if (error) { alert('Error deleting test: ' + error.message); return; }
            closeModal('deleteTestModal');
            await loadVocabTests();
        }

        function openEditTestModal(testId, testName, maxScore, testDate) {
            document.getElementById('editTestId').value = testId;
            document.getElementById('editTestName').value = testName;
            document.getElementById('editTestMaxScore').value = maxScore;
            document.getElementById('editTestDate').value = testDate || '';
            openModal('editTestModal');
        }

        async function confirmEditTest() {
            const testId = document.getElementById('editTestId').value;
            const newName = document.getElementById('editTestName').value.trim();
            const newMaxScore = document.getElementById('editTestMaxScore').value;
            const newDate = document.getElementById('editTestDate').value;

            if (!newName) { alert('Please enter a test name'); return; }
            if (!newMaxScore || newMaxScore < 1) { alert('Please enter a valid maximum score'); return; }

            const { error } = await supabase
                .from('tasks')
                .update({
                    title: newName,
                    content_path: 'manual_test:' + newMaxScore,
                    due_date: newDate ? newDate + 'T00:00:00' : null
                })
                .eq('id', testId);

            if (error) { alert('Error updating test: ' + error.message); return; }

            closeModal('editTestModal');
            await loadVocabTests();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
