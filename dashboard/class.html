<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Details - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
            font-weight: 400;
        }

        /* Premium Header */
        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: #FFFFFF;
            padding: 2rem 2rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }
        .class-meta {
            font-size: 0.9rem;
            opacity: 0.75;
            font-weight: 400;
        }
        .class-meta span {
            margin-right: 1.5rem;
        }
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Premium Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.95);
            color: #1a1a1a;
            border-color: rgba(255,255,255,0.2);
        }
        .btn-secondary:hover {
            background: #FFFFFF;
        }
        .btn-ghost {
            background: transparent;
            color: rgba(255,255,255,0.9);
            border-color: rgba(255,255,255,0.3);
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        /* Premium Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
        }

        /* Premium Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2.5rem;
        }
        .stat-card {
            background: #FFFFFF;
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stat-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        .stat-value {
            font-size: 2.25rem;
            font-weight: 600;
            color: #000000;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            font-size: 0.8125rem;
            color: #666666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Premium Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 3rem 0 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #000000;
        }
        .section-header:first-of-type {
            margin-top: 0;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000000;
            letter-spacing: -0.01em;
        }

        /* Premium Student Table */
        .student-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 2.5rem;
        }
        .student-table thead {
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
        }
        .student-table th {
            text-align: left;
            padding: 1rem 1.25rem;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #4a4a4a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        .student-table th:hover {
            background: rgba(0,0,0,0.02);
        }
        .student-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.15s;
        }
        .student-table tbody tr:hover {
            background: #fafafa;
        }
        .student-table tbody tr:last-child {
            border-bottom: none;
        }
        .student-table td {
            padding: 1.125rem 1.25rem;
            font-size: 0.9375rem;
            vertical-align: middle;
        }

        /* Student Name with Avatar */
        .student-name-cell {
            display: flex;
            align-items: center;
            gap: 0.875rem;
        }
        .student-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        .student-name-link {
            font-weight: 500;
            color: #1a1a1a;
            text-decoration: none;
            transition: color 0.15s;
        }
        .student-name-link:hover {
            color: #667eea;
        }

        /* Premium Metrics */
        .metric-value {
            font-variant-numeric: tabular-nums;
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.9375rem;
        }
        .metric-label {
            font-size: 0.75rem;
            color: #999999;
            display: block;
            margin-top: 0.25rem;
        }

        /* Premium Progress Indicator */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .progress-circle {
            width: 44px;
            height: 44px;
            position: relative;
        }
        .progress-circle svg {
            transform: rotate(-90deg);
        }
        .progress-circle circle {
            fill: none;
            stroke-width: 4;
        }
        .progress-circle .bg-circle {
            stroke: #f0f0f0;
        }
        .progress-circle .progress-arc {
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s;
        }
        .progress-circle .progress-arc.excellent { stroke: #2E7D32; }
        .progress-circle .progress-arc.good { stroke: #000000; }
        .progress-circle .progress-arc.warning { stroke: #F57C00; }
        .progress-circle .progress-arc.critical { stroke: #C62828; }
        .progress-text {
            font-size: 0.6875rem;
            font-weight: 600;
            fill: #1a1a1a;
        }

        /* Premium Cards for Subject-Specific Views */
        .detail-card {
            background: #FFFFFF;
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        .detail-card-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 1.5rem;
            padding-bottom: 0.875rem;
            border-bottom: 1px solid #e5e5e5;
        }

        /* Lesson Progress Table (for Classics) */
        .lesson-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .lesson-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e5e5;
        }
        .lesson-table td {
            padding: 1rem;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9375rem;
        }
        .lesson-table tr:last-child td {
            border-bottom: none;
        }
        .lesson-table tr:hover {
            background: #fafafa;
        }
        .lesson-name {
            font-weight: 500;
            color: #1a1a1a;
        }
        .lesson-meta {
            font-size: 0.8125rem;
            color: #999999;
            margin-top: 0.25rem;
        }

        /* Completion Badge */
        .completion-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
        }
        .completion-badge.complete {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .completion-badge.in-progress {
            background: #FFF3E0;
            color: #F57C00;
        }
        .completion-badge.not-started {
            background: #f5f5f5;
            color: #999999;
        }

        /* Time Display */
        .time-display {
            font-variant-numeric: tabular-nums;
            font-weight: 500;
            color: #1a1a1a;
        }

        /* Score Display */
        .score-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-variant-numeric: tabular-nums;
            font-weight: 600;
        }
        .score-display.excellent { color: #2E7D32; }
        .score-display.good { color: #000000; }
        .score-display.warning { color: #F57C00; }
        .score-display.critical { color: #C62828; }

        /* Premium Grid Layout */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Chapter Progress (for vocab) */
        .chapter-item {
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.15s;
        }
        .chapter-item:hover {
            background: #f5f5f5;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .chapter-name {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 0.9375rem;
        }
        .chapter-progress-bar {
            height: 6px;
            background: #e5e5e5;
            border-radius: 3px;
            overflow: hidden;
        }
        .chapter-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #999999;
        }
        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #999999;
            font-size: 0.9375rem;
        }

        /* Tasks Section */
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .task-card {
            background: #FFFFFF;
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border-color: rgba(0,0,0,0.15);
        }
        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        .task-title {
            font-weight: 600;
            font-size: 1rem;
            color: #1a1a1a;
            letter-spacing: -0.01em;
            margin-bottom: 0.25rem;
        }
        .task-due-date {
            font-size: 0.8125rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .task-due-date.overdue {
            color: #C62828;
            font-weight: 600;
        }
        .task-due-date.urgent {
            color: #F57C00;
            font-weight: 600;
        }
        .task-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        .task-stat {
            text-align: center;
        }
        .task-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            font-variant-numeric: tabular-nums;
        }
        .task-stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.125rem;
        }
        .completion-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .completion-badge.high {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .completion-badge.medium {
            background: #FFF3E0;
            color: #F57C00;
        }
        .completion-badge.low {
            background: #FFEBEE;
            color: #C62828;
        }

        /* Task Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: #FFFFFF;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.01em;
            margin-bottom: 0.25rem;
        }
        .modal-header p {
            font-size: 0.875rem;
            color: #666;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: rgba(0,0,0,0.05);
            color: #1a1a1a;
        }
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        .completion-table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 8px;
            overflow: hidden;
        }
        .completion-table thead {
            background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .completion-table th {
            text-align: left;
            padding: 0.875rem;
            font-weight: 600;
            font-size: 0.75rem;
            color: #424242;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .completion-table td {
            padding: 1rem 0.875rem;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            font-size: 0.875rem;
            vertical-align: middle;
        }
        .completion-table tr:hover {
            background: #FAFAFA;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }
        .status-badge.completed {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .status-badge.in-progress {
            background: #FFF3E0;
            color: #F57C00;
        }
        .status-badge.not-started {
            background: #F5F5F5;
            color: #666;
        }

        /* Detail Sidebar for Classics Lessons */
        .detail-with-sidebar {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.5rem;
        }
        .lesson-sidebar {
            background: #FFFFFF;
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 12px;
            padding: 1.25rem;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        .lesson-sidebar h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a1a1a;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .lesson-list {
            list-style: none;
        }
        .lesson-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #FAFAFA;
            border-radius: 6px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .lesson-item:hover {
            background: #F5F5F5;
            border-left-color: #667eea;
        }
        .lesson-item.has-activity {
            border-left-color: #2E7D32;
        }
        .lesson-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: #1a1a1a;
            margin-bottom: 0.25rem;
        }
        .lesson-time {
            font-size: 0.75rem;
            color: #666;
            font-variant-numeric: tabular-nums;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem 1rem;
            }
            .header {
                padding: 1.5rem 1rem;
            }
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Premium Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1 id="className">Loading...</h1>
                <div class="class-meta">
                    <span id="classSubject">‚Äî</span> | <span id="classCode">‚Äî</span> | <span id="studentCount">‚Äî</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="exportData()">üìä Export Data</button>
                <a href="teacher.html" class="btn btn-ghost btn-sm">‚Üê Back</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Premium Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statStudents">0</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAvgProgress">0%</div>
                <div class="stat-label">Average Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statActive">0</div>
                <div class="stat-label">Active This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTotalTime">0h</div>
                <div class="stat-label">Total Practice Time</div>
            </div>
        </div>

        <!-- Prep Tasks & Assignments -->
        <div class="section-header">
            <span class="section-title">Prep Tasks & Assignments</span>
        </div>

        <div id="tasksContainer">
            <div class="loading">Loading tasks...</div>
        </div>

        <!-- Student Overview Table -->
        <div class="section-header">
            <span class="section-title">Student Progress Overview</span>
        </div>

        <div id="studentTableContainer">
            <div class="loading">Loading student data...</div>
        </div>

        <!-- Subject-Specific Detail Views -->
        <div id="detailViewsContainer"></div>
    </div>

    <script src="../auth/config.js"></script>
    <script src="../shared/analytics-engine.js"></script>
    <script>
        let currentUser = null;
        let currentClass = null;
        let classStudents = [];
        let studentData = [];
        let analyticsEngine = null;

        // Class type configuration
        const classTypeConfig = {
            latin: {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'vocab', 'setText', 'prep'],
                name: 'Latin GCSE'
            },
            greek: {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'vocab', 'prep'],
                name: 'Greek GCSE'
            },
            classics: {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'reading', 'contentTest', 'prep'],
                name: 'Classical Civilisation'
            },
            'prep-latin': {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'vocab', 'prep'],
                name: 'Prep School Latin'
            }
        };

        // Initialize
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'teacher') {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = profile;
            analyticsEngine = new AnalyticsEngine(supabase);

            const urlParams = new URLSearchParams(window.location.search);
            const classId = urlParams.get('id');

            if (!classId) {
                alert('No class ID provided');
                window.location.href = 'teacher.html';
                return;
            }

            await loadClass(classId);
            await loadStudents();
            await loadTasks();
            await loadStudentData();
            renderStudentTable();
            await renderSubjectSpecificViews();
        }

        // Load class details
        async function loadClass(classId) {
            const { data, error } = await supabase
                .from('classes')
                .select('*')
                .eq('id', classId)
                .single();

            if (error || !data) {
                alert('Error loading class');
                window.location.href = 'teacher.html';
                return;
            }

            currentClass = data;
            const config = classTypeConfig[data.type] || classTypeConfig.latin;

            document.getElementById('className').textContent = data.name;
            document.getElementById('classSubject').textContent = config.name;
            document.getElementById('classCode').textContent = data.join_code;
        }

        // Load students
        async function loadStudents() {
            const { data: members, error } = await supabase
                .from('class_members')
                .select(`
                    student_id,
                    joined_at,
                    users (
                        id,
                        full_name,
                        email
                    )
                `)
                .eq('class_id', currentClass.id);

            if (error) {
                console.error('Error loading students:', error);
                return;
            }

            classStudents = (members || []).map(m => m.users).filter(u => u !== null);
            document.getElementById('statStudents').textContent = classStudents.length;
            document.getElementById('studentCount').textContent = `${classStudents.length} students`;
        }

        // Load student data
        async function loadStudentData() {
            if (classStudents.length === 0) {
                studentData = [];
                return;
            }

            const studentIds = classStudents.map(s => s.id);

            const dataPromises = classStudents.map(async student => {
                const data = {
                    id: student.id,
                    name: student.full_name || student.email,
                    lastActivity: null,
                    totalTime: 0,
                    vocabProgress: 0,
                    setTextAvg: 0,
                    readingLessons: 0,
                    contentTestAvg: 0,
                    outstandingPrep: 0,
                    overallProgress: 0
                };

                // Get all task attempts (all time)
                const { data: attempts } = await supabase
                    .from('task_attempts')
                    .select('*')
                    .eq('student_id', student.id);

                if (attempts && attempts.length > 0) {
                    data.totalTime = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                    const latestAttempt = attempts.reduce((latest, a) => {
                        const date = new Date(a.started_at || a.completed_at);
                        return !latest || date > new Date(latest) ? a.started_at || a.completed_at : latest;
                    }, null);
                    data.lastActivity = latestAttempt;
                }

                // Vocabulary progress
                if (['latin', 'greek', 'prep-latin'].includes(currentClass.type)) {
                    const language = currentClass.type === 'prep-latin' ? 'prep-latin' : currentClass.type;
                    const { data: wordMastery } = await supabase
                        .from('word_mastery')
                        .select('*')
                        .eq('student_id', student.id)
                        .eq('language', language);

                    if (wordMastery && wordMastery.length > 0) {
                        const mastered = wordMastery.filter(w => w.mastered_at).length;
                        data.vocabProgress = Math.round((mastered / wordMastery.length) * 100);
                    }
                }

                // Set text progress
                if (currentClass.type === 'latin') {
                    const { data: setTextProgress } = await supabase
                        .from('set_text_progress')
                        .select('best_score')
                        .eq('user_id', student.id);

                    if (setTextProgress && setTextProgress.length > 0) {
                        const avgScore = setTextProgress.reduce((sum, s) => sum + (s.best_score || 0), 0) / setTextProgress.length;
                        data.setTextAvg = Math.round(avgScore);
                    }
                }

                // Reading lessons (Classics)
                if (currentClass.type === 'classics') {
                    const { data: readingAttempts } = await supabase
                        .from('task_attempts')
                        .select('content_path')
                        .eq('student_id', student.id)
                        .not('content_path', 'is', null)
                        .like('content_path', '%/reading/%');

                    if (readingAttempts && readingAttempts.length > 0) {
                        const uniqueLessons = new Set(readingAttempts.map(a => a.content_path));
                        data.readingLessons = uniqueLessons.size;
                    }
                }

                // Content test average
                const { data: contentTests } = await supabase
                    .from('content_test_attempts')
                    .select('score_percentage')
                    .eq('student_id', student.id);

                if (contentTests && contentTests.length > 0) {
                    const avgScore = contentTests.reduce((sum, t) => sum + (t.score_percentage || 0), 0) / contentTests.length;
                    data.contentTestAvg = Math.round(avgScore);
                }

                // Outstanding prep
                const { data: tasks } = await supabase
                    .from('tasks')
                    .select('id')
                    .eq('class_id', currentClass.id);

                if (tasks && tasks.length > 0) {
                    const taskIds = tasks.map(t => t.id);
                    const { data: completions } = await supabase
                        .from('task_attempts')
                        .select('task_id')
                        .eq('student_id', student.id)
                        .in('task_id', taskIds)
                        .not('completed_at', 'is', null);

                    const completedIds = new Set((completions || []).map(c => c.task_id));
                    data.outstandingPrep = taskIds.length - completedIds.size;
                }

                // Calculate overall progress
                let progressFactors = [];
                if (data.vocabProgress > 0) progressFactors.push(data.vocabProgress);
                if (data.setTextAvg > 0) progressFactors.push(data.setTextAvg);
                if (data.readingLessons > 0) progressFactors.push(Math.min((data.readingLessons / 30) * 100, 100));
                if (data.contentTestAvg > 0) progressFactors.push(data.contentTestAvg);

                if (progressFactors.length > 0) {
                    data.overallProgress = Math.round(progressFactors.reduce((sum, p) => sum + p, 0) / progressFactors.length);
                }

                return data;
            });

            studentData = await Promise.all(dataPromises);
            updateStats();
        }

        // Update stats
        function updateStats() {
            const avgProgress = studentData.length > 0
                ? Math.round(studentData.reduce((sum, s) => sum + s.overallProgress, 0) / studentData.length)
                : 0;
            document.getElementById('statAvgProgress').textContent = avgProgress + '%';

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const active = studentData.filter(s => s.lastActivity && new Date(s.lastActivity) > sevenDaysAgo).length;
            document.getElementById('statActive').textContent = active;

            const totalSeconds = studentData.reduce((sum, s) => sum + s.totalTime, 0);
            const hours = Math.round(totalSeconds / 3600);
            document.getElementById('statTotalTime').textContent = hours + 'h';
        }

        // Render student table
        function renderStudentTable() {
            const container = document.getElementById('studentTableContainer');

            if (studentData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No students in this class yet</p></div>';
                return;
            }

            const config = classTypeConfig[currentClass.type];
            const columns = config.columns;

            let headerHtml = '<tr>';
            if (columns.includes('name')) headerHtml += '<th>Student</th>';
            if (columns.includes('lastActivity')) headerHtml += '<th>Last Active</th>';
            if (columns.includes('totalTime')) headerHtml += '<th>Total Time</th>';
            if (columns.includes('progress')) headerHtml += '<th>Progress</th>';
            if (columns.includes('vocab')) headerHtml += '<th>Vocabulary</th>';
            if (columns.includes('setText')) headerHtml += '<th>Set Texts</th>';
            if (columns.includes('reading')) headerHtml += '<th>Reading</th>';
            if (columns.includes('contentTest')) headerHtml += '<th>Content Tests</th>';
            if (columns.includes('prep')) headerHtml += '<th>Outstanding</th>';
            headerHtml += '</tr>';

            let rowsHtml = '';
            for (const student of studentData) {
                const initials = student.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                rowsHtml += '<tr>';

                // Student name
                if (columns.includes('name')) {
                    rowsHtml += `
                        <td>
                            <div class="student-name-cell">
                                <div class="student-avatar">${initials}</div>
                                <a href="student-profile.html?student_id=${student.id}&class_id=${currentClass.id}" class="student-name-link">
                                    ${student.name}
                                </a>
                            </div>
                        </td>
                    `;
                }

                // Last activity
                if (columns.includes('lastActivity')) {
                    const timeAgo = student.lastActivity ? getTimeAgo(new Date(student.lastActivity)) : 'No activity';
                    rowsHtml += `<td><span class="metric-value">${timeAgo}</span></td>`;
                }

                // Total time
                if (columns.includes('totalTime')) {
                    const hours = Math.floor(student.totalTime / 3600);
                    const minutes = Math.floor((student.totalTime % 3600) / 60);
                    const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    rowsHtml += `<td><span class="time-display">${timeStr}</span></td>`;
                }

                // Overall progress with circular indicator
                if (columns.includes('progress')) {
                    const progressClass = getProgressClass(student.overallProgress);
                    const circumference = 2 * Math.PI * 18;
                    const offset = circumference - (student.overallProgress / 100) * circumference;

                    rowsHtml += `
                        <td>
                            <div class="progress-indicator">
                                <div class="progress-circle">
                                    <svg width="44" height="44">
                                        <circle class="bg-circle" cx="22" cy="22" r="18"></circle>
                                        <circle class="progress-arc ${progressClass}" cx="22" cy="22" r="18"
                                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle>
                                        <text x="22" y="26" text-anchor="middle" class="progress-text">${student.overallProgress}%</text>
                                    </svg>
                                </div>
                            </div>
                        </td>
                    `;
                }

                // Vocabulary
                if (columns.includes('vocab')) {
                    rowsHtml += `<td><span class="metric-value">${student.vocabProgress}%</span></td>`;
                }

                // Set texts
                if (columns.includes('setText')) {
                    const scoreClass = getProgressClass(student.setTextAvg);
                    rowsHtml += `<td><span class="score-display ${scoreClass}">${student.setTextAvg}%</span></td>`;
                }

                // Reading
                if (columns.includes('reading')) {
                    rowsHtml += `<td><span class="metric-value">${student.readingLessons} lessons</span></td>`;
                }

                // Content tests
                if (columns.includes('contentTest')) {
                    const scoreClass = getProgressClass(student.contentTestAvg);
                    rowsHtml += `<td><span class="score-display ${scoreClass}">${student.contentTestAvg}%</span></td>`;
                }

                // Outstanding prep
                if (columns.includes('prep')) {
                    const badgeClass = student.outstandingPrep > 0 ? 'in-progress' : 'complete';
                    const badgeText = student.outstandingPrep > 0 ? student.outstandingPrep : '‚úì';
                    rowsHtml += `<td><span class="completion-badge ${badgeClass}">${badgeText}</span></td>`;
                }

                rowsHtml += '</tr>';
            }

            container.innerHTML = `
                <table class="student-table">
                    <thead>${headerHtml}</thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            `;
        }

        // Render subject-specific detail views
        async function renderSubjectSpecificViews() {
            const container = document.getElementById('detailViewsContainer');

            if (currentClass.type === 'classics') {
                await renderClassicsDetailView(container);
            } else if (currentClass.type === 'latin') {
                await renderLatinDetailView(container);
            } else if (currentClass.type === 'greek') {
                await renderGreekDetailView(container);
            } else if (currentClass.type === 'prep-latin') {
                await renderPrepLatinDetailView(container);
            }
        }

        // Render Classics detail view (lesson breakdown)
        async function renderClassicsDetailView(container) {
            // Define all possible lessons
            const courses = {
                'iliad': { name: 'The Iliad', lessons: Array.from({length: 10}, (_, i) => `Lesson ${i + 1}`) },
                'aeneid': { name: 'The Aeneid', lessons: Array.from({length: 10}, (_, i) => `Lesson ${i + 1}`) },
                'odyssey': { name: 'The Odyssey', lessons: Array.from({length: 10}, (_, i) => `Lesson ${i + 1}`) },
                'greek-art': { name: 'Greek Art', lessons: Array.from({length: 8}, (_, i) => `Lesson ${i + 1}`) }
            };

            let html = '<div class="section-header"><span class="section-title">Course Progress Breakdown</span></div>';

            for (const [courseId, courseData] of Object.entries(courses)) {
                // Get lesson data for all students
                const lessonProgress = await Promise.all(courseData.lessons.map(async (lesson, index) => {
                    const lessonNumber = index + 1;

                    const studentsCompleted = [];
                    let totalTime = 0;

                    for (const student of studentData) {
                        const { data: attempts } = await supabase
                            .from('task_attempts')
                            .select('time_spent_seconds')
                            .eq('student_id', student.id)
                            .like('content_path', `%/${courseId}/lesson-${lessonNumber}%`)
                            .not('completed_at', 'is', null);

                        if (attempts && attempts.length > 0) {
                            studentsCompleted.push(student.name);
                            totalTime += attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                        }
                    }

                    return {
                        lesson,
                        completedCount: studentsCompleted.length,
                        totalTime,
                        completionRate: studentData.length > 0 ? Math.round((studentsCompleted.length / studentData.length) * 100) : 0
                    };
                }));

                html += `
                    <div class="detail-card" style="cursor: pointer;" onclick="showClassicsLessonDetail('${courseId}', '${courseData.name}')">
                        <div class="detail-card-header">${courseData.name} <span style="font-size: 0.8em; opacity: 0.6;">‚Üí Click for lesson details</span></div>
                        <table class="lesson-table">
                            <thead>
                                <tr>
                                    <th>Lesson</th>
                                    <th>Students Completed</th>
                                    <th>Completion Rate</th>
                                    <th>Total Time Spent</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                lessonProgress.forEach(progress => {
                    const completionBadge = progress.completionRate >= 80 ? 'complete' : progress.completionRate >= 50 ? 'in-progress' : 'not-started';
                    const timeMinutes = Math.round(progress.totalTime / 60);

                    html += `
                        <tr>
                            <td>
                                <div class="lesson-name">${progress.lesson}</div>
                            </td>
                            <td><span class="metric-value">${progress.completedCount} / ${studentData.length}</span></td>
                            <td><span class="completion-badge ${completionBadge}">${progress.completionRate}%</span></td>
                            <td><span class="time-display">${timeMinutes} min</span></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Render Latin detail view (set text breakdown)
        async function renderLatinDetailView(container) {
            const setTexts = {
                'messalina': { name: 'Messalina', sections: 10 },
                'baucis-philemon': { name: 'Baucis & Philemon', sections: 8 },
                'otium': { name: 'Otium', sections: 6 }
            };

            let html = '<div class="section-header"><span class="section-title">Set Text Performance</span></div>';

            for (const [textId, textData] of Object.entries(setTexts)) {
                html += `<div class="detail-card"><div class="detail-card-header">${textData.name}</div><table class="lesson-table"><thead><tr><th>Section</th><th>Students Attempted</th><th>Average Score</th><th>Students < 70%</th></tr></thead><tbody>`;

                for (let section = 1; section <= textData.sections; section++) {
                    const sectionScores = [];
                    let attemptedCount = 0;
                    let strugglingCount = 0;

                    for (const student of studentData) {
                        const { data: progress } = await supabase
                            .from('set_text_progress')
                            .select('best_score')
                            .eq('user_id', student.id)
                            .eq('text_id', textId)
                            .eq('section_id', section.toString())
                            .single();

                        if (progress && progress.best_score !== null) {
                            attemptedCount++;
                            sectionScores.push(progress.best_score);
                            if (progress.best_score < 70) strugglingCount++;
                        }
                    }

                    const avgScore = sectionScores.length > 0
                        ? Math.round(sectionScores.reduce((sum, s) => sum + s, 0) / sectionScores.length)
                        : 0;
                    const scoreClass = getProgressClass(avgScore);

                    html += `
                        <tr>
                            <td><div class="lesson-name">Section ${section}</div></td>
                            <td><span class="metric-value">${attemptedCount} / ${studentData.length}</span></td>
                            <td><span class="score-display ${scoreClass}">${avgScore}%</span></td>
                            <td><span class="metric-value">${strugglingCount}</span></td>
                        </tr>
                    `;
                }

                html += '</tbody></table></div>';
            }

            container.innerHTML = html;
        }

        // Render Greek detail view
        async function renderGreekDetailView(container) {
            // Similar to Latin but without set texts
            container.innerHTML = '<div class="section-header"><span class="section-title">Vocabulary Progress by Chapter</span></div><div class="detail-card"><p>Chapter-by-chapter vocabulary breakdown coming soon...</p></div>';
        }

        // Render Prep Latin detail view
        async function renderPrepLatinDetailView(container) {
            container.innerHTML = '<div class="section-header"><span class="section-title">Suburani Vocabulary Progress</span></div><div class="detail-card"><p>Chapter-by-chapter vocabulary breakdown coming soon...</p></div>';
        }

        // Load and render tasks
        async function loadTasks() {
            const container = document.getElementById('tasksContainer');

            // Fetch all tasks for this class
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .eq('class_id', currentClass.id)
                .order('due_date', { ascending: true });

            if (error) {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<div class="empty-state"><p>Error loading tasks</p></div>';
                return;
            }

            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No prep tasks or assignments set for this class yet.</p></div>';
                return;
            }

            // For each task, get completion stats (only for students in this class)
            const studentIds = classStudents.map(s => s.id);
            const tasksWithStats = await Promise.all(tasks.map(async (task) => {
                const { data: attempts } = await supabase
                    .from('task_attempts')
                    .select('student_id, completed_at, score, time_spent_seconds, num_attempts')
                    .eq('task_id', task.id)
                    .in('student_id', studentIds);

                const totalStudents = classStudents.length;
                const completedStudents = new Set(
                    (attempts || [])
                        .filter(a => a.completed_at)
                        .map(a => a.student_id)
                ).size;

                const avgAttempts = attempts && attempts.length > 0
                    ? Math.round(attempts.reduce((sum, a) => sum + (a.num_attempts || 1), 0) / attempts.length)
                    : 0;

                const avgTime = attempts && attempts.length > 0
                    ? Math.round(attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0) / attempts.length / 60)
                    : 0;

                const avgScore = attempts && attempts.length > 0
                    ? Math.round(attempts.reduce((sum, a) => sum + (a.score || 0), 0) / attempts.length)
                    : 0;

                return {
                    ...task,
                    completedStudents,
                    totalStudents,
                    avgAttempts,
                    avgTime,
                    avgScore
                };
            }));

            renderTasks(tasksWithStats);
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            const now = new Date();

            let html = '<div class="tasks-grid">';

            tasks.forEach(task => {
                const dueDate = new Date(task.due_date);
                const daysUntilDue = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));

                let dueDateClass = '';
                let dueDateText = dueDate.toLocaleDateString();

                if (daysUntilDue < 0) {
                    dueDateClass = 'overdue';
                    dueDateText = `Overdue (${Math.abs(daysUntilDue)}d ago)`;
                } else if (daysUntilDue <= 2) {
                    dueDateClass = 'urgent';
                    dueDateText = `Due in ${daysUntilDue}d`;
                } else if (daysUntilDue <= 7) {
                    dueDateText = `Due in ${daysUntilDue}d`;
                }

                const completionRate = Math.round((task.completedStudents / task.totalStudents) * 100) || 0;
                let completionClass = 'low';
                if (completionRate >= 80) completionClass = 'high';
                else if (completionRate >= 50) completionClass = 'medium';

                html += `
                    <div class="task-card" onclick="showTaskDetails('${task.id}')">
                        <div class="task-card-header">
                            <div>
                                <div class="task-title">${task.title}</div>
                                <div class="task-due-date ${dueDateClass}">üìÖ ${dueDateText}</div>
                            </div>
                            <div class="completion-badge ${completionClass}">
                                ${completionRate}%
                            </div>
                        </div>
                        <div class="task-stats">
                            <div class="task-stat">
                                <div class="task-stat-value">${task.completedStudents}/${task.totalStudents}</div>
                                <div class="task-stat-label">Completed</div>
                            </div>
                            <div class="task-stat">
                                <div class="task-stat-value">${task.avgAttempts || '‚Äî'}</div>
                                <div class="task-stat-label">Avg Attempts</div>
                            </div>
                            <div class="task-stat">
                                <div class="task-stat-value">${task.avgTime || '‚Äî'}m</div>
                                <div class="task-stat-label">Avg Time</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        async function showTaskDetails(taskId) {
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTaskTitle');
            const modalMeta = document.getElementById('modalTaskMeta');
            const modalBody = document.getElementById('modalTaskBody');

            // Show modal and reset content
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading">Loading task details...</div>';

            // Fetch task details
            const { data: task, error: taskError } = await supabase
                .from('tasks')
                .select('*')
                .eq('id', taskId)
                .single();

            if (taskError || !task) {
                modalBody.innerHTML = '<div class="empty-state"><p>Error loading task details</p></div>';
                return;
            }

            modalTitle.textContent = task.title;
            const dueDate = new Date(task.due_date).toLocaleDateString();
            modalMeta.textContent = `Due: ${dueDate}`;

            // Fetch all attempts for this task by students in this class
            const studentIds = classStudents.map(s => s.id);
            const { data: attempts } = await supabase
                .from('task_attempts')
                .select('*')
                .eq('task_id', taskId)
                .in('student_id', studentIds);

            // Build completion map - keep best attempt per student
            const completionMap = {};
            (attempts || []).forEach(attempt => {
                const existingAttempt = completionMap[attempt.student_id];

                if (!existingAttempt) {
                    // First attempt for this student
                    completionMap[attempt.student_id] = attempt;
                } else {
                    // Already have an attempt, decide which to keep
                    const hasCompleted = attempt.completed_at !== null;
                    const existingHasCompleted = existingAttempt.completed_at !== null;

                    if (hasCompleted && !existingHasCompleted) {
                        // New attempt is completed, existing isn't - prefer completed
                        completionMap[attempt.student_id] = attempt;
                    } else if (hasCompleted && existingHasCompleted) {
                        // Both completed - keep most recent
                        if (new Date(attempt.completed_at) > new Date(existingAttempt.completed_at)) {
                            completionMap[attempt.student_id] = attempt;
                        }
                    } else if (!hasCompleted && !existingHasCompleted) {
                        // Both in progress - keep most recent started
                        if (new Date(attempt.started_at) > new Date(existingAttempt.started_at)) {
                            completionMap[attempt.student_id] = attempt;
                        }
                    }
                    // If existing is completed and new isn't, keep existing (do nothing)
                }
            });

            // Render student completion table
            let html = `
                <table class="completion-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Status</th>
                            <th>Attempts</th>
                            <th>Time Spent</th>
                            <th>Score</th>
                            <th>Completed</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            classStudents.forEach(student => {
                const attempt = completionMap[student.id];

                if (attempt && attempt.completed_at) {
                    const numAttempts = attempt.num_attempts || 1;
                    const timeSpent = Math.round((attempt.time_spent_seconds || 0) / 60);
                    const score = attempt.score || 0;
                    const completedDate = new Date(attempt.completed_at).toLocaleDateString();

                    html += `
                        <tr>
                            <td>${student.full_name}</td>
                            <td><span class="status-badge completed">Completed</span></td>
                            <td>${numAttempts}</td>
                            <td>${timeSpent}m</td>
                            <td>${score}%</td>
                            <td>${completedDate}</td>
                        </tr>
                    `;
                } else if (attempt) {
                    html += `
                        <tr>
                            <td>${student.full_name}</td>
                            <td><span class="status-badge in-progress">In Progress</span></td>
                            <td>${attempt.num_attempts || 1}</td>
                            <td>${Math.round((attempt.time_spent_seconds || 0) / 60)}m</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr>
                            <td>${student.full_name}</td>
                            <td><span class="status-badge not-started">Not Started</span></td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                        </tr>
                    `;
                }
            });

            html += `
                    </tbody>
                </table>
            `;

            modalBody.innerHTML = html;
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('taskModal');
            if (e.target === modal) {
                closeTaskModal();
            }
        });

        // Show detailed lesson breakdown for Classics courses
        async function showClassicsLessonDetail(courseId, courseName) {
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTaskTitle');
            const modalMeta = document.getElementById('modalTaskMeta');
            const modalBody = document.getElementById('modalTaskBody');

            // Show modal and reset content
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading">Loading lesson details...</div>';

            modalTitle.textContent = courseName;
            modalMeta.textContent = 'Detailed lesson breakdown';

            // Determine number of lessons based on course
            const lessonCounts = {
                'iliad': 10,
                'aeneid': 10,
                'odyssey': 10,
                'greek-art': 8
            };
            const numLessons = lessonCounts[courseId] || 10;

            // Get detailed data for each lesson
            const lessonDetails = await Promise.all(
                Array.from({ length: numLessons }, async (_, index) => {
                    const lessonNumber = index + 1;
                    const studentProgress = [];

                    for (const student of studentData) {
                        const { data: attempts } = await supabase
                            .from('task_attempts')
                            .select('time_spent_seconds, completed_at')
                            .eq('student_id', student.id)
                            .like('content_path', `%/${courseId}/lesson-${lessonNumber}%`);

                        if (attempts && attempts.length > 0) {
                            const totalTime = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                            const completed = attempts.some(a => a.completed_at);

                            studentProgress.push({
                                studentName: student.name,
                                timeSpent: totalTime,
                                completed
                            });
                        }
                    }

                    return {
                        lessonNumber,
                        studentProgress
                    };
                })
            );

            // Render lesson details
            let html = '<div class="lesson-detail-container">';

            lessonDetails.forEach(lesson => {
                const totalTime = lesson.studentProgress.reduce((sum, sp) => sum + sp.timeSpent, 0);
                const timeMinutes = Math.round(totalTime / 60);
                const completedCount = lesson.studentProgress.filter(sp => sp.completed).length;

                html += `
                    <div class="detail-card" style="margin-bottom: 1rem;">
                        <div class="detail-card-header">
                            Lesson ${lesson.lessonNumber}
                            <span style="font-size: 0.85em; opacity: 0.7; font-weight: 400;">
                                ${completedCount} completed ‚Ä¢ ${timeMinutes} min total
                            </span>
                        </div>
                `;

                if (lesson.studentProgress.length > 0) {
                    html += '<ul class="lesson-list" style="list-style: none; padding: 0;">';
                    lesson.studentProgress
                        .sort((a, b) => b.timeSpent - a.timeSpent)
                        .forEach(sp => {
                            const mins = Math.round(sp.timeSpent / 60);
                            const statusIcon = sp.completed ? '‚úì' : '‚óã';
                            html += `
                                <li class="lesson-item ${sp.completed ? 'has-activity' : ''}">
                                    <div class="lesson-name">${statusIcon} ${sp.studentName}</div>
                                    <div class="lesson-time">${mins} minutes</div>
                                </li>
                            `;
                        });
                    html += '</ul>';
                } else {
                    html += '<p style="padding: 1rem; color: #999; text-align: center;">No student activity yet</p>';
                }

                html += '</div>';
            });

            html += '</div>';
            modalBody.innerHTML = html;
        }

        // Helper functions
        function getProgressClass(score) {
            if (score >= 85) return 'excellent';
            if (score >= 70) return 'good';
            if (score >= 50) return 'warning';
            return 'critical';
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return Math.floor(seconds / 604800) + 'w ago';
        }

        function exportData() {
            alert('Export functionality coming soon');
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Task Detail Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 id="modalTaskTitle">Task Details</h3>
                    <p id="modalTaskMeta"></p>
                </div>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalTaskBody">
                <div class="loading">Loading task details...</div>
            </div>
        </div>
    </div>
</body>
</html>
