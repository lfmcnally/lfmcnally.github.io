<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Details - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .join-code {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            letter-spacing: 2px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-white {
            background: white;
            color: #0066ff;
        }
        .btn-white:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.3);
        }
        .btn-primary {
            background: #0066ff;
            color: white;
        }
        .btn-primary:hover {
            background: #0052cc;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Class Stats Overview */
        .class-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .class-stat {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .class-stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .class-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #0066ff;
        }
        .class-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Overview Row */
        .overview-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .leaderboard-card, .alerts-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .leaderboard-tabs {
            display: flex;
            gap: 0.25rem;
        }
        .lb-tab {
            padding: 0.35rem 0.6rem;
            background: #f3f4f6;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lb-tab:hover {
            background: #e5e7eb;
        }
        .lb-tab.active {
            background: #0066ff;
            color: white;
        }

        /* Leaderboard */
        .leaderboard-list {
            list-style: none;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        .leaderboard-rank {
            width: 2rem;
            font-weight: 700;
            font-size: 1rem;
            color: #6b7280;
        }
        .leaderboard-rank.gold { color: #f59e0b; }
        .leaderboard-rank.silver { color: #9ca3af; }
        .leaderboard-rank.bronze { color: #b45309; }
        .leaderboard-name {
            flex: 1;
            font-weight: 500;
            color: #1f2937;
        }
        .leaderboard-value {
            font-weight: 600;
            color: #0066ff;
        }

        /* Alerts */
        .alert-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #fef3c7;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid #f59e0b;
        }
        .alert-item:last-child {
            margin-bottom: 0;
        }
        .alert-item.danger {
            background: #fee2e2;
            border-left-color: #ef4444;
        }
        .alert-icon {
            font-size: 1.25rem;
        }
        .alert-text {
            flex: 1;
            font-size: 0.85rem;
            color: #1f2937;
        }
        .alert-name {
            font-weight: 600;
        }
        .no-alerts {
            text-align: center;
            padding: 2rem;
            color: #10b981;
        }
        .no-alerts-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card.full-width {
            grid-column: 1 / -1;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-body {
            padding: 1.25rem;
        }

        /* Students List */
        .students-list {
            list-style: none;
        }
        .students-list li {
            padding: 0.875rem 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .students-list li:last-child {
            border-bottom: none;
        }
        .student-name {
            font-weight: 500;
            color: #0066ff;
            text-decoration: none;
        }
        .student-name:hover {
            text-decoration: underline;
        }
        .student-email {
            color: #6b7280;
            font-size: 0.8rem;
        }
        .student-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-icon {
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-icon:hover {
            background: #e5e7eb;
        }
        .btn-icon.danger:hover {
            background: #fee2e2;
        }

        /* Task Type Selector */
        .task-type-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .task-type-btn {
            flex: 1;
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .task-type-btn:hover {
            border-color: #0066ff;
        }
        .task-type-btn.active {
            border-color: #0066ff;
            background: #eff6ff;
            color: #0066ff;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        .task-form-section {
            display: none;
        }
        .task-form-section.active {
            display: block;
        }

        /* Message */
        .message {
            padding: 0.875rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }
        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            display: block;
        }
        .message.success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
            display: block;
        }

        /* Task Items */
        .task-item {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .task-header {
            padding: 1rem 1.25rem;
            background: #f9fafb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .task-header:hover {
            background: #f3f4f6;
        }
        .task-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .task-toggle {
            font-size: 0.75rem;
            color: #6b7280;
            transition: transform 0.2s;
        }
        .task-item.open .task-toggle {
            transform: rotate(90deg);
        }
        .task-title {
            font-weight: 600;
            color: #1f2937;
        }
        .task-due {
            font-size: 0.85rem;
            color: #6b7280;
            margin-left: 1rem;
        }
        .task-due.overdue {
            color: #dc2626;
            font-weight: 500;
        }
        .task-header-right {
            display: flex;
            gap: 0.5rem;
        }
        .task-body {
            display: none;
            padding: 1.25rem;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
        }
        .task-item.open .task-body {
            display: block;
        }

        /* Progress Table */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .progress-table th,
        .progress-table td {
            padding: 0.875rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .progress-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .progress-table tr:hover {
            background: #f9fafb;
        }
        .progress-table tr:last-child td {
            border-bottom: none;
        }
        .status-complete {
            color: #059669;
            font-weight: 600;
        }
        .status-started {
            color: #f59e0b;
            font-weight: 600;
        }
        .status-not-started {
            color: #9ca3af;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #1f2937;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #1f2937;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-body p {
            color: #4b5563;
            line-height: 1.5;
        }
        .modal-body p strong {
            color: #1f2937;
        }
        .modal-body .warning-text {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Student Mastery Modal */
        .mastery-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .mastery-stat {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        .mastery-stat.mastered { border-left: 3px solid #10b981; }
        .mastery-stat.learning { border-left: 3px solid #f59e0b; }
        .mastery-stat.struggling { border-left: 3px solid #ef4444; }
        .mastery-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .mastery-stat.mastered .mastery-stat-value { color: #10b981; }
        .mastery-stat.learning .mastery-stat-value { color: #f59e0b; }
        .mastery-stat.struggling .mastery-stat-value { color: #ef4444; }
        .mastery-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .word-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
        }
        .word-latin {
            font-weight: 600;
            color: #0066ff;
        }
        .word-english {
            color: #6b7280;
            font-size: 0.85rem;
        }
        .word-stats {
            text-align: right;
            font-size: 0.8rem;
        }
        .word-accuracy {
            font-weight: 600;
        }
        .word-accuracy.good { color: #10b981; }
        .word-accuracy.okay { color: #f59e0b; }
        .word-accuracy.bad { color: #ef4444; }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover { color: #1f2937; }
        .tab-btn.active {
            color: #0066ff;
            border-bottom-color: #0066ff;
        }
        
        /* History styles */
        .tab-content {
            min-height: 300px;
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .history-stat {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        .history-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0066ff;
        }
        .history-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .history-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
        }
        .history-item.completed {
            border-left: 3px solid #10b981;
        }
        .history-item.incomplete {
            border-left: 3px solid #f59e0b;
        }
        .history-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .history-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .history-score {
            font-weight: 600;
            font-size: 1rem;
        }
        .history-score.good { color: #10b981; }
        .history-score.okay { color: #f59e0b; }
        .history-score.bad { color: #ef4444; }
        .history-time {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Task Completion Grid */
        .completion-grid-card {
            margin-bottom: 2rem;
        }
        .completion-grid-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .grid-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .legend-dot.not-started { background: #f3f4f6; border: 1px solid #d1d5db; }
        .legend-dot.completed { background: #10b981; }
        .legend-dot.completed-late { background: #f59e0b; }
        .legend-dot.overdue { background: #ef4444; }
        
        .completion-grid-wrapper {
            overflow-x: auto;
        }
        .completion-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }
        .completion-grid th,
        .completion-grid td {
            padding: 0.6rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .completion-grid th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }
        .completion-grid th.student-col {
            text-align: left;
            width: 140px;
            min-width: 140px;
            position: sticky;
            left: 0;
            background: #f9fafb;
            z-index: 1;
        }
        .completion-grid th.task-col {
            width: 75px;
            min-width: 75px;
            font-size: 0.8rem;
            cursor: help;
        }
        .completion-grid td.student-name {
            text-align: left;
            font-weight: 500;
            color: #1f2937;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            width: 140px;
        }
        .completion-grid td.task-cell {
            width: 75px;
            min-width: 75px;
        }
        .completion-grid tbody tr:hover {
            background: #f9fafb;
        }
        .completion-grid tbody tr:hover td.student-name {
            background: #f9fafb;
        }
        
        /* Cell styling */
        .task-cell-inner {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
            min-width: 50px;
            min-height: 38px;
        }
        .task-cell-inner.not-started {
            background: #f3f4f6;
            color: #9ca3af;
        }
        .task-cell-inner.completed {
            background: #d1fae5;
            color: #065f46;
        }
        .task-cell-inner.completed-late {
            background: #fef3c7;
            color: #92400e;
        }
        .task-cell-inner.overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        .task-cell-inner.in-progress {
            background: #dbeafe;
            color: #1e40af;
        }
        .task-cell-time {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .task-cell-score {
            font-size: 0.7rem;
            opacity: 0.85;
        }
        .task-cell-icon {
            font-size: 0.85rem;
        }
        
        .no-tasks-message {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .overview-row {
                grid-template-columns: 1fr;
            }
            .class-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .class-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .leaderboard-tabs {
                flex-wrap: wrap;
            }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .task-header-right {
                width: 100%;
                justify-content: flex-end;
            }
            .progress-table {
                font-size: 0.75rem;
            }
            .progress-table th,
            .progress-table td {
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 id="className">Loading...</h1>
                    <div class="join-code" id="joinCode">---</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-ghost" onclick="copyJoinCode()">üìã Copy Code</button>
                    <button class="btn btn-ghost" onclick="openEditClassModal()">‚úèÔ∏è Rename</button>
                    <button class="btn btn-ghost" onclick="openDeleteClassModal()" style="color: #ef4444;">üóëÔ∏è Delete</button>
                    <a href="teacher.html" class="btn btn-white">‚Üê Back to Dashboard</a>
                </div>
            </div>
        </div>

        <!-- Class Stats Overview -->
        <div class="class-stats-grid">
            <div class="class-stat">
                <div class="class-stat-icon">üë•</div>
                <div class="class-stat-value" id="csStudents">0</div>
                <div class="class-stat-label">Students</div>
            </div>
            <div class="class-stat">
                <div class="class-stat-icon">‚è±Ô∏è</div>
                <div class="class-stat-value" id="csTotalTime">0m</div>
                <div class="class-stat-label">Total Practice</div>
            </div>
            <div class="class-stat">
                <div class="class-stat-icon">üéØ</div>
                <div class="class-stat-value" id="csAvgScore">0%</div>
                <div class="class-stat-label">Avg Score</div>
            </div>
            <div class="class-stat">
                <div class="class-stat-icon">‚úÖ</div>
                <div class="class-stat-value" id="csCompletion">0%</div>
                <div class="class-stat-label">Task Completion</div>
            </div>
            <div class="class-stat" id="wordsMasteredStat">
                <div class="class-stat-icon">üìö</div>
                <div class="class-stat-value" id="csWordsMastered">0</div>
                <div class="class-stat-label">Words Mastered</div>
            </div>
        </div>

        <!-- Leaderboard & Alerts Row -->
        <div class="overview-row">
            <div class="card leaderboard-card">
                <div class="card-header">
                    <span class="card-title">üèÜ Leaderboard</span>
                    <div class="leaderboard-tabs">
                        <button class="lb-tab active" onclick="showLeaderboard('time', this)">‚è±Ô∏è Time</button>
                        <button class="lb-tab" id="leaderboardWordsTab" onclick="showLeaderboard('words', this)">üìö Words</button>
                        <button class="lb-tab" onclick="showLeaderboard('streak', this)">üî• Streak</button>
                        <button class="lb-tab" onclick="showLeaderboard('score', this)">üéØ Score</button>
                    </div>
                </div>
                <div class="card-body" id="leaderboardContainer">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="card alerts-card">
                <div class="card-header">
                    <span class="card-title">‚ö†Ô∏è Needs Attention</span>
                </div>
                <div class="card-body" id="alertsContainer">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Task Completion Grid -->
        <div class="card completion-grid-card">
            <div class="card-header">
                <span class="card-title">üìä Task Completion Overview</span>
                <div class="grid-legend">
                    <span class="legend-item"><span class="legend-dot not-started"></span> Not started</span>
                    <span class="legend-item"><span class="legend-dot completed"></span> Completed</span>
                    <span class="legend-item"><span class="legend-dot completed-late"></span> Late</span>
                    <span class="legend-item"><span class="legend-dot overdue"></span> Overdue</span>
                </div>
            </div>
            <div class="card-body">
                <div id="completionGridContainer">
                    <div class="loading">Loading task data...</div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="dashboard-grid">
            <!-- Students Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üë• Students (<span id="studentCount">0</span>)</span>
                </div>
                <div class="card-body" id="studentsContainer">
                    <div class="loading">Loading students...</div>
                </div>
            </div>

            <!-- Set Task Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìù Set a New Task</span>
                </div>
                <div class="card-body">
                    <div id="taskMessage" class="message"></div>
                    
                    <div class="task-type-selector">
                        <button class="task-type-btn active" id="vocabTaskOption" onclick="selectTaskType('vocab')">üìñ Vocabulary</button>
                        <button class="task-type-btn" id="setTextTaskOption" onclick="selectTaskType('settext')">üìú Set Text</button>
                        <button class="task-type-btn" onclick="selectTaskType('custom')">üîó Custom Link</button>
                    </div>
                    
                    <div id="vocabForm" class="task-form-section active">
                        <form id="setVocabTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="vocabTitle" placeholder="e.g. Chapter 7 Vocabulary" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Chapter</label>
                                    <select class="form-input" id="taskChapter" required>
                                        <option value="">Select...</option>
                                        <!-- Populated dynamically based on class type -->
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>From Word</label>
                                    <select class="form-input" id="taskFromWord" required disabled>
                                        <option value="">Select chapter first</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>To Word</label>
                                    <select class="form-input" id="taskToWord" required disabled>
                                        <option value="">Select from word first</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="vocabDueDate" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Vocabulary Task</button>
                        </form>
                    </div>
                    
                    <div id="setTextForm" class="task-form-section">
                        <form id="setSetTextTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="setTextTitle" placeholder="e.g. Messalina Section 1" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Set Text</label>
                                    <select class="form-input" id="setTextSelect" required>
                                        <option value="">Select text...</option>
                                        <option value="messalina">Messalina (Tacitus)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Section</label>
                                    <select class="form-input" id="setTextSection" required disabled>
                                        <option value="">Select text first</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="setTextDueDate" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Literature Task</button>
                        </form>
                    </div>
                    
                    <div id="customForm" class="task-form-section">
                        <form id="setCustomTaskForm">
                            <div class="form-group">
                                <label>Task Title</label>
                                <input type="text" class="form-input" id="customTitle" placeholder="e.g. Translation Exercise" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Content URL</label>
                                <input type="url" class="form-input" id="customUrl" placeholder="https://classicalia.co.uk/..." required>
                            </div>
                            
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="datetime-local" class="form-input" id="customDueDate" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Set Custom Task</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tasks & Progress Card -->
            <div class="card full-width">
                <div class="card-header">
                    <span class="card-title">üìä Tasks & Progress</span>
                </div>
                <div class="card-body" id="tasksContainer">
                    <div class="loading">Loading tasks...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Student Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Rename Student</h3>
                <button class="modal-close" onclick="closeModal('renameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>New Name</label>
                    <input type="text" class="form-input" id="newStudentName" placeholder="Enter new name">
                </div>
                <input type="hidden" id="renameStudentId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('renameModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRenameStudent()">Save</button>
            </div>
        </div>
    </div>

    <!-- Remove Student Modal -->
    <div class="modal-overlay" id="removeStudentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Remove Student</h3>
                <button class="modal-close" onclick="closeModal('removeStudentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="removeStudentName"></strong> from this class?</p>
                <p class="warning-text">Their progress data will be kept.</p>
                <input type="hidden" id="removeStudentId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('removeStudentModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmRemoveStudent()">Remove</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal-overlay" id="editTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Task</h3>
                <button class="modal-close" onclick="closeModal('editTaskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task Title</label>
                    <input type="text" class="form-input" id="editTaskTitle">
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="datetime-local" class="form-input" id="editTaskDueDate">
                </div>
                <input type="hidden" id="editTaskId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editTaskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditTask()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Task Modal -->
    <div class="modal-overlay" id="deleteTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Task</h3>
                <button class="modal-close" onclick="closeModal('deleteTaskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteTaskName"></strong>?</p>
                <p class="warning-text">This will also delete all student attempts for this task.</p>
                <input type="hidden" id="deleteTaskId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteTaskModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteTask()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div class="modal-overlay" id="editClassModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Rename Class</h3>
                <button class="modal-close" onclick="closeModal('editClassModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Class Name</label>
                    <input type="text" class="form-input" id="editClassName" placeholder="e.g. Year 9 Latin">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editClassModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditClass()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Class Modal -->
    <div class="modal-overlay" id="deleteClassModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Class</h3>
                <button class="modal-close" onclick="closeModal('deleteClassModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteClassName"></strong>?</p>
                <p class="warning-text">‚ö†Ô∏è This will permanently delete:</p>
                <ul style="color: #6b7280; margin: 0.5rem 0 1rem 1.5rem; font-size: 0.9rem;">
                    <li>All student enrolments</li>
                    <li>All assigned tasks</li>
                    <li>All task attempts and progress data</li>
                </ul>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteClassModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteClass()">Delete Class</button>
            </div>
        </div>
    </div>

    <!-- Student Mastery Modal -->
    <div class="modal-overlay" id="studentMasteryModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìä <span id="studentMasteryName">Student</span></h3>
                <button class="modal-close" onclick="closeModal('studentMasteryModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Main tabs -->
                <div class="tabs" style="padding: 0 1rem; border-bottom: 1px solid #e5e7eb;">
                    <button class="tab-btn active" onclick="showMainTab('history', this)">üìÖ History</button>
                    <button class="tab-btn" onclick="showMainTab('words', this)">üìö Word Bank</button>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="tab-content" style="padding: 1rem;">
                    <div class="history-stats">
                        <div class="history-stat">
                            <div class="history-stat-value" id="shTotalSessions">0</div>
                            <div class="history-stat-label">Sessions</div>
                        </div>
                        <div class="history-stat">
                            <div class="history-stat-value" id="shTotalTime">0m</div>
                            <div class="history-stat-label">Total Time</div>
                        </div>
                        <div class="history-stat">
                            <div class="history-stat-value" id="shAvgScore">0%</div>
                            <div class="history-stat-label">Avg Score</div>
                        </div>
                    </div>
                    <div id="studentHistoryList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                
                <!-- Words Tab -->
                <div id="wordsTab" class="tab-content" style="padding: 1rem; display: none;">
                    <div class="mastery-stats">
                        <div class="mastery-stat mastered">
                            <div class="mastery-stat-value" id="smMastered">0</div>
                            <div class="mastery-stat-label">üåü Mastered</div>
                        </div>
                        <div class="mastery-stat learning">
                            <div class="mastery-stat-value" id="smLearning">0</div>
                            <div class="mastery-stat-label">üìñ Learning</div>
                        </div>
                        <div class="mastery-stat struggling">
                            <div class="mastery-stat-value" id="smStruggling">0</div>
                            <div class="mastery-stat-label">üí™ Need Practice</div>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showStudentTab('all', this)">All</button>
                        <button class="tab-btn" onclick="showStudentTab('mastered', this)">Mastered</button>
                        <button class="tab-btn" onclick="showStudentTab('struggling', this)">Struggling</button>
                    </div>
                    <div id="studentWordList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    <script src="../shared/vocabulary-data.js"></script>
    <script src="../shared/greek-vocabulary-data.js"></script>
    <script src="../latin/data/suburani-vocab.js"></script>
    
    <script>
        let currentUser = null;
        let currentClass = null;
        let classStudents = [];
        
        // Get vocab data based on class type
        function getVocabData() {
            if (!currentClass) return [];
            const type = currentClass.type;
            if (type === 'latin') return typeof vocabularyData !== 'undefined' ? vocabularyData : [];
            if (type === 'greek') return typeof greekVocabularyData !== 'undefined' ? greekVocabularyData : [];
            if (type === 'prep-latin') return typeof suburaniVocabularyData !== 'undefined' ? suburaniVocabularyData : [];
            return [];
        }
        
        // Get vocab practice URL based on class type
        function getVocabPracticeUrl(chapter, from, to) {
            const type = currentClass?.type;
            if (type === 'latin') return `/latin/vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
            if (type === 'greek') return `/greek/vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
            if (type === 'prep-latin') return `/latin/prep-vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
            return `/latin/vocabulary-practice.html?chapter=${chapter}&from=${from}&to=${to}`;
        }
        
        // Get word display property based on class type
        function getWordProperty(word) {
            if (currentClass?.type === 'greek') return word.greek;
            return word.latin;
        }
        
        // Populate chapter dropdown based on class type
        function populateChapterDropdown() {
            const select = document.getElementById('taskChapter');
            select.innerHTML = '<option value="">Select...</option>';
            
            const type = currentClass?.type;
            const maxChapter = (type === 'prep-latin') ? 16 : 10;
            
            for (let i = 1; i <= maxChapter; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Chapter ${i}`;
                select.appendChild(option);
            }
        }
        
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = 'message ' + type;
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('open');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }
        
        // Close modal when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('open');
                }
            });
        });
        
        function copyJoinCode() {
            const code = document.getElementById('joinCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Join code copied: ' + code);
            });
        }
        
        function selectTaskType(type) {
            document.querySelectorAll('.task-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.task-form-section').forEach(form => form.classList.remove('active'));
            
            if (type === 'vocab') {
                document.getElementById('vocabTaskOption').classList.add('active');
                document.getElementById('vocabForm').classList.add('active');
            } else if (type === 'settext') {
                document.getElementById('setTextTaskOption').classList.add('active');
                document.getElementById('setTextForm').classList.add('active');
            } else {
                document.querySelector('.task-type-btn:last-child').classList.add('active');
                document.getElementById('customForm').classList.add('active');
            }
        }
        
        function toggleTask(taskId) {
            const taskItem = document.getElementById(`task-${taskId}`);
            taskItem.classList.toggle('open');
        }
        
        async function loadClassDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const classId = urlParams.get('id');
            
            if (!classId) {
                window.location.href = 'teacher.html';
                return;
            }
            
            const { data: classData, error } = await supabase
                .from('classes')
                .select('*')
                .eq('id', classId)
                .single();
            
            if (error || !classData) {
                window.location.href = 'teacher.html';
                return;
            }
            
            currentClass = classData;
            document.getElementById('className').textContent = classData.name;
            document.getElementById('joinCode').textContent = classData.join_code;
            
            // Handle class type - configure task options based on type
            if (classData.type === 'classics') {
                // Hide words mastered stat
                document.getElementById('wordsMasteredStat').style.display = 'none';
                // Hide vocab task form, show only custom
                document.getElementById('vocabTaskOption').style.display = 'none';
                document.getElementById('setTextTaskOption').style.display = 'none';
                selectTaskType('custom');
                // Hide words tab in leaderboard
                document.getElementById('leaderboardWordsTab').style.display = 'none';
            } else {
                // Latin GCSE, Greek, and Prep Latin all have vocab tracking
                // Show vocab picker and populate chapters appropriately
                document.getElementById('vocabTaskOption').style.display = '';
                populateChapterDropdown();
                
                // Update vocab button text based on type
                const vocabBtn = document.getElementById('vocabTaskOption');
                if (classData.type === 'greek') {
                    vocabBtn.textContent = 'üè∫ Vocabulary';
                    document.getElementById('setTextTaskOption').style.display = 'none'; // No Greek set texts yet
                } else if (classData.type === 'prep-latin') {
                    vocabBtn.textContent = 'üìö Vocabulary';
                    document.getElementById('setTextTaskOption').style.display = 'none'; // No Prep set texts
                } else {
                    vocabBtn.textContent = 'üìñ Vocabulary';
                    document.getElementById('setTextTaskOption').style.display = ''; // Show for Latin GCSE
                }
            }
        }
        
        async function loadStudents() {
            const container = document.getElementById('studentsContainer');
            
            const { data: members, error } = await supabase
                .from('class_members')
                .select(`
                    student_id,
                    joined_at,
                    users (
                        id,
                        full_name,
                        email
                    )
                `)
                .eq('class_id', currentClass.id);
            
            if (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading students</p></div>';
                return;
            }
            
            classStudents = members.map(m => m.users);
            document.getElementById('studentCount').textContent = classStudents.length;
            
            if (classStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No students yet.<br>Share the join code!</p></div>';
                return;
            }
            
            let html = '<ul class="students-list">';
            for (const student of classStudents) {
                html += `
                    <li>
                        <div>
                            <a href="student-profile.html?student_id=${student.id}&class_id=${currentClass.id}" class="student-name" title="View full profile">${student.full_name || 'Unknown'}</a>
                        </div>
                        <div class="student-actions">
                            <a href="student-profile.html?student_id=${student.id}&class_id=${currentClass.id}" class="btn-icon" title="View full profile">üìä</a>
                            <button class="btn-icon" onclick="viewStudentMastery('${student.id}', '${(student.full_name || 'Student').replace(/'/g, "\\'")}')" title="Quick view">üìö</button>
                            <button class="btn-icon" onclick="showRenameStudent('${student.id}', '${(student.full_name || '').replace(/'/g, "\\'")}')" title="Rename">‚úèÔ∏è</button>
                            <button class="btn-icon danger" onclick="showRemoveStudent('${student.id}', '${(student.full_name || student.email).replace(/'/g, "\\'")}')" title="Remove">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            }
            html += '</ul>';
            container.innerHTML = html;
        }
        
        // View student word mastery
        let currentStudentMastery = { all: [], mastered: [], learning: [], struggling: [] };
        let currentStudentHistory = [];
        let currentStudentId = null;
        
        async function viewStudentMastery(studentId, studentName) {
            currentStudentId = studentId;
            document.getElementById('studentMasteryName').textContent = studentName;
            openModal('studentMasteryModal');
            
            // Reset to history tab
            showMainTab('history', document.querySelector('#studentMasteryModal .tabs .tab-btn'));
            
            // Load both history and word mastery
            await Promise.all([
                loadStudentHistory(studentId),
                loadStudentWords(studentId)
            ]);
        }
        
        // Switch between History and Words tabs
        function showMainTab(tab, btn) {
            // Update active state on main tabs
            document.querySelectorAll('#studentMasteryModal .modal-body > .tabs .tab-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Show/hide content
            document.getElementById('historyTab').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('wordsTab').style.display = tab === 'words' ? 'block' : 'none';
            
            // If switching to words tab, show all words
            if (tab === 'words') {
                const allBtn = document.querySelector('#wordsTab .tabs .tab-btn');
                showStudentTab('all', allBtn);
            }
        }
        
        // Load student practice history
        async function loadStudentHistory(studentId) {
            document.getElementById('studentHistoryList').innerHTML = '<div class="loading">Loading...</div>';
            
            const { data, error } = await supabase
                .from('task_attempts')
                .select('*, tasks(title)')
                .eq('student_id', studentId)
                .order('started_at', { ascending: false })
                .limit(50);
            
            if (error) {
                document.getElementById('studentHistoryList').innerHTML = '<p style="color: #dc2626;">Error loading history</p>';
                return;
            }
            
            currentStudentHistory = data || [];
            
            // Calculate stats
            const totalSessions = currentStudentHistory.length;
            const totalSeconds = currentStudentHistory.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            const totalMinutes = Math.round(totalSeconds / 60);
            const completedWithScores = currentStudentHistory.filter(a => a.score !== null);
            const avgScore = completedWithScores.length > 0 
                ? Math.round(completedWithScores.reduce((sum, a) => sum + a.score, 0) / completedWithScores.length)
                : 0;
            
            document.getElementById('shTotalSessions').textContent = totalSessions;
            document.getElementById('shTotalTime').textContent = totalMinutes + 'm';
            document.getElementById('shAvgScore').textContent = avgScore + '%';
            
            // Render history list
            const container = document.getElementById('studentHistoryList');
            
            if (currentStudentHistory.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No practice sessions yet.</p>';
                return;
            }
            
            container.innerHTML = '<ul class="history-list">' + currentStudentHistory.map(attempt => {
                const isCompleted = attempt.completed_at !== null;
                const title = attempt.tasks?.title || 'Free Practice';
                const date = new Date(attempt.started_at);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const duration = attempt.time_spent_seconds ? Math.round(attempt.time_spent_seconds / 60) + 'm' : '-';
                const score = attempt.score !== null ? attempt.score + '%' : '-';
                const scoreClass = attempt.score >= 70 ? 'good' : attempt.score >= 50 ? 'okay' : 'bad';
                
                return `
                    <li class="history-item ${isCompleted ? 'completed' : 'incomplete'}">
                        <div>
                            <div class="history-title">${title}</div>
                            <div class="history-meta">${dateStr} at ${timeStr} ¬∑ ${duration}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="history-score ${scoreClass}">${score}</div>
                            <div class="history-time">${isCompleted ? '‚úÖ Completed' : '‚è∏Ô∏è Partial'}</div>
                        </div>
                    </li>
                `;
            }).join('') + '</ul>';
        }
        
        // Load student word mastery
        async function loadStudentWords(studentId) {
            // Fetch word mastery for this student
            const { data, error } = await supabase
                .from('word_mastery')
                .select('*')
                .eq('student_id', studentId)
                .order('last_seen_at', { ascending: false });
            
            if (error) {
                console.error('Error loading word mastery:', error);
                return;
            }
            
            // Categorise words
            currentStudentMastery = { all: data || [], mastered: [], learning: [], struggling: [] };
            
            (data || []).forEach(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? (word.correct_count / total) * 100 : 0;
                
                if (word.correct_count >= 3 && accuracy >= 70) {
                    currentStudentMastery.mastered.push({ ...word, accuracy });
                } else if (accuracy < 50 && word.incorrect_count >= 2) {
                    currentStudentMastery.struggling.push({ ...word, accuracy });
                } else {
                    currentStudentMastery.learning.push({ ...word, accuracy });
                }
            });
            
            // Update stats
            document.getElementById('smMastered').textContent = currentStudentMastery.mastered.length;
            document.getElementById('smLearning').textContent = currentStudentMastery.learning.length;
            document.getElementById('smStruggling').textContent = currentStudentMastery.struggling.length;
        }
        
        function showStudentTab(tab, btn) {
            // Update active tab (only within words tab section)
            document.querySelectorAll('#wordsTab .tabs .tab-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Get words for this tab
            let words = currentStudentMastery[tab] || [];
            
            const container = document.getElementById('studentWordList');
            
            if (words.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No words in this category yet.</p>';
                return;
            }
            
            container.innerHTML = '<ul class="word-list">' + words.map(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? Math.round((word.correct_count / total) * 100) : 0;
                const accuracyClass = accuracy >= 70 ? 'good' : accuracy >= 50 ? 'okay' : 'bad';
                
                return `
                    <li class="word-item">
                        <div>
                            <div class="word-latin">${word.word_latin}</div>
                            <div class="word-english">${word.word_english || ''}</div>
                        </div>
                        <div class="word-stats">
                            <div class="word-accuracy ${accuracyClass}">${accuracy}%</div>
                            <div>${word.correct_count}‚úì ${word.incorrect_count}‚úó</div>
                        </div>
                    </li>
                `;
            }).join('') + '</ul>';
        }
        
        // Student management
        function showRenameStudent(studentId, currentName) {
            document.getElementById('renameStudentId').value = studentId;
            document.getElementById('newStudentName').value = currentName;
            openModal('renameModal');
        }
        
        async function confirmRenameStudent() {
            const studentId = document.getElementById('renameStudentId').value;
            const newName = document.getElementById('newStudentName').value.trim();
            
            if (!newName) {
                alert('Please enter a name');
                return;
            }
            
            const { error } = await supabase
                .from('users')
                .update({ full_name: newName })
                .eq('id', studentId);
            
            if (error) {
                alert('Error renaming student: ' + error.message);
                return;
            }
            
            closeModal('renameModal');
            await loadStudents();
        }
        
        function showRemoveStudent(studentId, studentName) {
            document.getElementById('removeStudentId').value = studentId;
            document.getElementById('removeStudentName').textContent = studentName;
            openModal('removeStudentModal');
        }
        
        async function confirmRemoveStudent() {
            const studentId = document.getElementById('removeStudentId').value;
            
            const { error } = await supabase
                .from('class_members')
                .delete()
                .eq('class_id', currentClass.id)
                .eq('student_id', studentId);
            
            if (error) {
                alert('Error removing student: ' + error.message);
                return;
            }
            
            closeModal('removeStudentModal');
            await loadStudents();
        }
        
        // Task management
        function showEditTask(taskId, title, dueDate) {
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskTitle').value = title;
            
            if (dueDate) {
                const date = new Date(dueDate);
                const localDateTime = date.toISOString().slice(0, 16);
                document.getElementById('editTaskDueDate').value = localDateTime;
            }
            
            openModal('editTaskModal');
        }
        
        async function confirmEditTask() {
            const taskId = document.getElementById('editTaskId').value;
            const newTitle = document.getElementById('editTaskTitle').value.trim();
            const newDueDate = document.getElementById('editTaskDueDate').value;
            
            if (!newTitle) {
                alert('Please enter a title');
                return;
            }
            
            const { error } = await supabase
                .from('tasks')
                .update({ 
                    title: newTitle,
                    due_date: newDueDate || null
                })
                .eq('id', taskId);
            
            if (error) {
                alert('Error updating task: ' + error.message);
                return;
            }
            
            closeModal('editTaskModal');
            await loadTasks();
            await loadCompletionGrid();
        }
        
        function showDeleteTask(taskId, taskName) {
            document.getElementById('deleteTaskId').value = taskId;
            document.getElementById('deleteTaskName').textContent = taskName;
            openModal('deleteTaskModal');
        }
        
        async function confirmDeleteTask() {
            const taskId = document.getElementById('deleteTaskId').value;
            
            await supabase
                .from('task_attempts')
                .delete()
                .eq('task_id', taskId);
            
            const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', taskId);
            
            if (error) {
                alert('Error deleting task: ' + error.message);
                return;
            }
            
            closeModal('deleteTaskModal');
            await loadTasks();
            await loadCompletionGrid();
        }
        
        // Class edit/delete functions
        function openEditClassModal() {
            document.getElementById('editClassName').value = currentClass.name;
            openModal('editClassModal');
        }
        
        function openDeleteClassModal() {
            document.getElementById('deleteClassName').textContent = currentClass.name;
            openModal('deleteClassModal');
        }
        
        async function confirmEditClass() {
            const newName = document.getElementById('editClassName').value.trim();
            
            if (!newName) {
                alert('Please enter a class name.');
                return;
            }
            
            const { error } = await supabase
                .from('classes')
                .update({ name: newName })
                .eq('id', currentClass.id);
            
            if (error) {
                alert('Error renaming class: ' + error.message);
                return;
            }
            
            currentClass.name = newName;
            document.getElementById('className').textContent = newName;
            closeModal('editClassModal');
        }
        
        async function confirmDeleteClass() {
            // Delete in order: task_attempts -> tasks -> class_members -> class
            
            // 1. Get all task IDs for this class
            const { data: tasks } = await supabase
                .from('tasks')
                .select('id')
                .eq('class_id', currentClass.id);
            
            // 2. Delete task attempts for those tasks
            if (tasks && tasks.length > 0) {
                const taskIds = tasks.map(t => t.id);
                await supabase
                    .from('task_attempts')
                    .delete()
                    .in('task_id', taskIds);
            }
            
            // 3. Delete tasks
            await supabase
                .from('tasks')
                .delete()
                .eq('class_id', currentClass.id);
            
            // 4. Delete class members
            await supabase
                .from('class_members')
                .delete()
                .eq('class_id', currentClass.id);
            
            // 5. Delete the class
            const { error } = await supabase
                .from('classes')
                .delete()
                .eq('id', currentClass.id);
            
            if (error) {
                alert('Error deleting class: ' + error.message);
                return;
            }
            
            // Redirect to teacher dashboard
            window.location.href = 'teacher.html';
        }
        
        async function loadTasks() {
            const container = document.getElementById('tasksContainer');
            
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .eq('class_id', currentClass.id)
                .order('due_date', { ascending: true });
            
            if (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading tasks</p></div>';
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No tasks set yet.<br>Create one using the form above!</p></div>';
                return;
            }
            
            const now = new Date();
            let html = '<p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Click on a task to view student progress</p>';
            
            for (const task of tasks) {
                const dueDate = task.due_date ? new Date(task.due_date) : null;
                const isOverdue = dueDate && dueDate < now;
                
                const dueDateStr = dueDate ? dueDate.toLocaleDateString('en-GB', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'No due date';
                
                html += `
                    <div class="task-item" id="task-${task.id}">
                        <div class="task-header" onclick="toggleTask('${task.id}')">
                            <div class="task-header-left">
                                <span class="task-toggle">‚ñ∂</span>
                                <span class="task-title">${task.title}</span>
                                <span class="task-due ${isOverdue ? 'overdue' : ''}">
                                    ${isOverdue ? '‚ö†Ô∏è Overdue: ' : 'Due: '}${dueDateStr}
                                </span>
                            </div>
                            <div class="task-header-right" onclick="event.stopPropagation()">
                                <button class="btn btn-secondary btn-sm" onclick="showEditTask('${task.id}', '${task.title.replace(/'/g, "\\'")}', '${task.due_date || ''}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteTask('${task.id}', '${task.title.replace(/'/g, "\\'")}')">Delete</button>
                            </div>
                        </div>
                        <div class="task-body">
                            <table class="progress-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Attempts</th>
                                        <th>Best Score</th>
                                        <th>Total Time</th>
                                        <th>First Attempt</th>
                                        <th>Last Attempt</th>
                                    </tr>
                                </thead>
                                <tbody id="progress-${task.id}">
                                    <tr><td colspan="6" style="text-align:center; color:#9ca3af;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            for (const task of tasks) {
                await loadTaskProgress(task.id);
            }
        }
        
        async function loadTaskProgress(taskId) {
            const tbody = document.getElementById(`progress-${taskId}`);
            
            const { data: attempts, error } = await supabase
                .from('task_attempts')
                .select('*')
                .eq('task_id', taskId);
            
            if (error) {
                tbody.innerHTML = '<tr><td colspan="6">Error loading progress</td></tr>';
                return;
            }
            
            const studentStats = {};
            
            for (const attempt of attempts) {
                if (!studentStats[attempt.student_id]) {
                    studentStats[attempt.student_id] = {
                        attempts: 0,
                        bestScore: null,
                        totalTime: 0,
                        firstAttempt: null,
                        lastAttempt: null
                    };
                }
                
                const stats = studentStats[attempt.student_id];
                stats.attempts++;
                
                if (attempt.completed_at && attempt.score !== null) {
                    if (stats.bestScore === null || attempt.score > stats.bestScore) {
                        stats.bestScore = attempt.score;
                    }
                }
                
                if (attempt.time_spent_seconds) {
                    stats.totalTime += attempt.time_spent_seconds;
                }
                
                const startedAt = new Date(attempt.started_at);
                if (stats.firstAttempt === null || startedAt < stats.firstAttempt) {
                    stats.firstAttempt = startedAt;
                }
                
                if (attempt.completed_at) {
                    const completedAt = new Date(attempt.completed_at);
                    if (stats.lastAttempt === null || completedAt > stats.lastAttempt) {
                        stats.lastAttempt = completedAt;
                    }
                }
            }
            
            let html = '';
            
            for (const student of classStudents) {
                const stats = studentStats[student.id];
                
                if (!stats) {
                    html += `
                        <tr>
                            <td>${student.full_name || student.email}</td>
                            <td class="status-not-started">0</td>
                            <td class="status-not-started">‚Äî</td>
                            <td class="status-not-started">‚Äî</td>
                            <td class="status-not-started">Not started</td>
                            <td class="status-not-started">‚Äî</td>
                        </tr>
                    `;
                } else {
                    const bestScoreDisplay = stats.bestScore !== null ? 
                        `<span class="${stats.bestScore >= 70 ? 'status-complete' : 'status-started'}">${stats.bestScore}%</span>` : 
                        '<span class="status-started">In progress</span>';
                    
                    const totalTimeDisplay = stats.totalTime > 0 ? 
                        `${Math.round(stats.totalTime / 60)} min` : 
                        '< 1 min';
                    
                    const firstAttemptDisplay = stats.firstAttempt ? 
                        stats.firstAttempt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 
                        '‚Äî';
                    
                    const lastAttemptDisplay = stats.lastAttempt ? 
                        stats.lastAttempt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 
                        '‚Äî';
                    
                    html += `
                        <tr>
                            <td>${student.full_name || student.email}</td>
                            <td>${stats.attempts}</td>
                            <td>${bestScoreDisplay}</td>
                            <td>${totalTimeDisplay}</td>
                            <td>${firstAttemptDisplay}</td>
                            <td>${lastAttemptDisplay}</td>
                        </tr>
                    `;
                }
            }
            
            if (html === '') {
                html = '<tr><td colspan="6" class="empty-state">No students in class</td></tr>';
            }
            
            tbody.innerHTML = html;
        }
        
        // Load the task completion grid
        async function loadCompletionGrid() {
            const container = document.getElementById('completionGridContainer');
            
            // Get tasks for this class (most recent 10)
            const { data: tasks, error: tasksError } = await supabase
                .from('tasks')
                .select('*')
                .eq('class_id', currentClass.id)
                .order('due_date', { ascending: false })
                .limit(10);
            
            if (tasksError || !tasks || tasks.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No tasks set yet. Create a task to see completion tracking.</div>';
                return;
            }
            
            // Reverse so oldest is first (left to right = chronological)
            const sortedTasks = [...tasks].reverse();
            
            // Get all students in class
            if (classStudents.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No students in class yet.</div>';
                return;
            }
            
            // Get all task attempts for these tasks
            const taskIds = sortedTasks.map(t => t.id);
            const studentIds = classStudents.map(s => s.id);
            
            const { data: attempts, error: attemptsError } = await supabase
                .from('task_attempts')
                .select('*')
                .in('task_id', taskIds)
                .in('student_id', studentIds);
            
            // Build lookup: { taskId: { studentId: { completed, time, score } } }
            const attemptLookup = {};
            if (attempts) {
                attempts.forEach(a => {
                    if (!attemptLookup[a.task_id]) {
                        attemptLookup[a.task_id] = {};
                    }
                    const existing = attemptLookup[a.task_id][a.student_id];
                    const time = a.time_spent_seconds || 0;
                    const score = a.score || 0;
                    
                    if (!existing || score > existing.score) {
                        attemptLookup[a.task_id][a.student_id] = {
                            completed: !!a.completed_at,
                            completedAt: a.completed_at ? new Date(a.completed_at) : null,
                            time: time,
                            score: score,
                            attempts: (existing?.attempts || 0) + 1
                        };
                    } else if (existing) {
                        existing.attempts++;
                        existing.time += time;
                    }
                });
            }
            
            // Build HTML table
            let html = '<div class="completion-grid-wrapper"><table class="completion-grid">';
            
            // Header row
            html += '<thead><tr><th class="student-col">Student</th>';
            sortedTasks.forEach(task => {
                const dueDate = new Date(task.due_date);
                const dueDateStr = dueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                html += `<th class="task-col" title="${task.title}">${dueDateStr}</th>`;
            });
            html += '</tr></thead>';
            
            // Body rows
            html += '<tbody>';
            const now = new Date();
            
            classStudents.forEach(student => {
                const name = student.full_name || student.email.split('@')[0];
                html += `<tr><td class="student-name">${name}</td>`;
                
                sortedTasks.forEach(task => {
                    const attempt = attemptLookup[task.id]?.[student.id];
                    const dueDate = new Date(task.due_date);
                    const isOverdue = now > dueDate;
                    
                    let cellClass = 'not-started';
                    let cellContent = '<span class="task-cell-icon">‚Äî</span>';
                    
                    if (attempt && attempt.completed) {
                        const wasLate = attempt.completedAt && attempt.completedAt > dueDate;
                        cellClass = wasLate ? 'completed-late' : 'completed';
                        const mins = Math.round(attempt.time / 60);
                        const timeStr = mins > 0 ? `${mins}m` : '<1m';
                        cellContent = `<span class="task-cell-time">${timeStr}</span>`;
                        if (attempt.score) {
                            cellContent += `<span class="task-cell-score">${attempt.score}%</span>`;
                        }
                    } else if (attempt && !attempt.completed) {
                        cellClass = 'in-progress';
                        cellContent = '<span class="task-cell-icon">‚è≥</span>';
                    } else if (isOverdue) {
                        cellClass = 'overdue';
                        cellContent = '<span class="task-cell-icon">‚úó</span>';
                    }
                    
                    html += `<td class="task-cell"><div class="task-cell-inner ${cellClass}">${cellContent}</div></td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        async function setTask(title, contentPath, dueDate) {
            const { data, error } = await supabase
                .from('tasks')
                .insert({
                    class_id: currentClass.id,
                    title: title,
                    content_path: contentPath,
                    due_date: dueDate,
                    created_by: currentUser.id
                });
            
            if (error) {
                return { success: false, error: error.message };
            }
            
            return { success: true };
        }
        
        function waitForVocabularyData() {
            return new Promise((resolve) => {
                const checkData = () => {
                    const vocabData = getVocabData();
                    if (vocabData && vocabData.length > 0) {
                        resolve();
                    } else {
                        setTimeout(checkData, 100);
                    }
                };
                checkData();
            });
        }
        
        async function handleChapterChange() {
            await waitForVocabularyData();
            
            const chapter = document.getElementById('taskChapter').value;
            const fromSelect = document.getElementById('taskFromWord');
            const toSelect = document.getElementById('taskToWord');
            
            if (!chapter) {
                fromSelect.disabled = true;
                fromSelect.innerHTML = '<option value="">Select chapter first</option>';
                toSelect.disabled = true;
                toSelect.innerHTML = '<option value="">Select from word first</option>';
                return;
            }
            
            const vocabData = getVocabData();
            const chapterWords = vocabData.filter(word => word.chapter == chapter);
            
            fromSelect.innerHTML = '<option value="">Select start word</option>';
            chapterWords.forEach((word, index) => {
                const wordText = getWordProperty(word);
                fromSelect.innerHTML += `<option value="${index}">${wordText}</option>`;
            });
            fromSelect.disabled = false;
            
            toSelect.innerHTML = '<option value="">Select from word first</option>';
            toSelect.disabled = true;
        }
        
        async function handleFromWordChange() {
            await waitForVocabularyData();
            
            const chapter = document.getElementById('taskChapter').value;
            const fromIndex = parseInt(document.getElementById('taskFromWord').value);
            const toSelect = document.getElementById('taskToWord');
            
            if (isNaN(fromIndex)) {
                toSelect.disabled = true;
                toSelect.innerHTML = '<option value="">Select from word first</option>';
                return;
            }
            
            const vocabData = getVocabData();
            const chapterWords = vocabData.filter(word => word.chapter == chapter);
            
            toSelect.innerHTML = '<option value="">Select end word</option>';
            for (let i = fromIndex; i < chapterWords.length; i++) {
                const wordText = getWordProperty(chapterWords[i]);
                toSelect.innerHTML += `<option value="${i}">${wordText}</option>`;
            }
            toSelect.disabled = false;
        }
        
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }
            
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if (!profile || profile.role !== 'teacher') {
                window.location.href = '../auth/login.html';
                return;
            }
            
            currentUser = profile;
            
            await loadClassDetails();
            await loadStudents();
            await loadTasks();
            await loadCompletionGrid();
            await loadClassStats();
            await loadLeaderboard();
            
            document.getElementById('taskChapter').addEventListener('change', handleChapterChange);
            document.getElementById('taskFromWord').addEventListener('change', handleFromWordChange);
        }
        
        // Class Stats & Leaderboard Data
        let classStatsData = {
            studentStats: [], // Array of { student, attempts, totalTime, avgScore, wordsMastered, streak }
        };
        
        async function loadClassStats() {
            if (classStudents.length === 0) {
                document.getElementById('csStudents').textContent = '0';
                return;
            }
            
            // Get all attempts for all students in this class
            const studentIds = classStudents.map(s => s.id);
            
            const { data: attempts, error: attemptsError } = await supabase
                .from('task_attempts')
                .select('*')
                .in('student_id', studentIds);
            
            const { data: wordMastery, error: wordError } = await supabase
                .from('word_mastery')
                .select('*')
                .in('student_id', studentIds);
            
            // Get tasks for this class to calculate completion
            const { data: tasks } = await supabase
                .from('tasks')
                .select('id')
                .eq('class_id', currentClass.id);
            
            const taskIds = (tasks || []).map(t => t.id);
            
            // Calculate per-student stats
            classStatsData.studentStats = classStudents.map(student => {
                const studentAttempts = (attempts || []).filter(a => a.student_id === student.id);
                const studentWords = (wordMastery || []).filter(w => w.student_id === student.id);
                
                const totalTime = studentAttempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                const completedAttempts = studentAttempts.filter(a => a.score !== null);
                const avgScore = completedAttempts.length > 0
                    ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                    : 0;
                
                // Count mastered words
                const wordsMastered = studentWords.filter(w => {
                    const total = w.correct_count + w.incorrect_count;
                    const acc = total > 0 ? (w.correct_count / total) * 100 : 0;
                    return w.correct_count >= 3 && acc >= 70;
                }).length;
                
                // Calculate streak
                const streak = calculateStreak(studentAttempts);
                
                // Task completion (unique tasks completed)
                const completedTaskIds = [...new Set(
                    studentAttempts
                        .filter(a => a.completed_at && taskIds.includes(a.task_id))
                        .map(a => a.task_id)
                )];
                
                return {
                    student,
                    attempts: studentAttempts.length,
                    totalTime,
                    avgScore,
                    wordsMastered,
                    streak,
                    tasksCompleted: completedTaskIds.length
                };
            });
            
            // Calculate class-wide stats
            const totalStudents = classStudents.length;
            const totalTime = classStatsData.studentStats.reduce((sum, s) => sum + s.totalTime, 0);
            const totalMinutes = Math.round(totalTime / 60);
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
            
            const studentsWithScores = classStatsData.studentStats.filter(s => s.avgScore > 0);
            const avgScore = studentsWithScores.length > 0
                ? Math.round(studentsWithScores.reduce((sum, s) => sum + s.avgScore, 0) / studentsWithScores.length)
                : 0;
            
            // Task completion rate
            const totalTasksAssigned = taskIds.length * totalStudents;
            const totalTasksCompleted = classStatsData.studentStats.reduce((sum, s) => sum + s.tasksCompleted, 0);
            const completionRate = totalTasksAssigned > 0
                ? Math.round((totalTasksCompleted / totalTasksAssigned) * 100)
                : 0;
            
            const totalWordsMastered = classStatsData.studentStats.reduce((sum, s) => sum + s.wordsMastered, 0);
            
            // Update display
            document.getElementById('csStudents').textContent = totalStudents;
            document.getElementById('csTotalTime').textContent = timeStr;
            document.getElementById('csAvgScore').textContent = avgScore + '%';
            document.getElementById('csCompletion').textContent = completionRate + '%';
            document.getElementById('csWordsMastered').textContent = totalWordsMastered;
            
            // Load alerts
            renderAlerts();
        }
        
        function calculateStreak(attempts) {
            if (!attempts || attempts.length === 0) return 0;
            
            const completedAttempts = attempts.filter(a => a.completed_at);
            if (completedAttempts.length === 0) return 0;
            
            // Get unique dates
            const dates = [...new Set(completedAttempts.map(a => 
                new Date(a.completed_at).toISOString().split('T')[0]
            ))].sort().reverse();
            
            if (dates.length === 0) return 0;
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            // Check if most recent is today or yesterday
            if (dates[0] !== today && dates[0] !== yesterday) return 0;
            
            let streak = 1;
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i - 1]);
                const currDate = new Date(dates[i]);
                const diff = (prevDate - currDate) / 86400000;
                
                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }
        
        function renderAlerts() {
            const container = document.getElementById('alertsContainer');
            const alerts = [];
            
            // Check for students who need attention
            classStatsData.studentStats.forEach(s => {
                // No activity in last 7 days
                if (s.totalTime === 0) {
                    alerts.push({
                        type: 'danger',
                        icon: 'üö´',
                        text: `<span class="alert-name">${s.student.full_name || 'Unknown'}</span> has no practice recorded`
                    });
                }
                // Low average score
                else if (s.avgScore > 0 && s.avgScore < 50) {
                    alerts.push({
                        type: 'warning',
                        icon: 'üìâ',
                        text: `<span class="alert-name">${s.student.full_name || 'Unknown'}</span> has ${s.avgScore}% average score`
                    });
                }
                // Very little practice time
                else if (s.totalTime > 0 && s.totalTime < 300) { // Less than 5 minutes total
                    alerts.push({
                        type: 'warning',
                        icon: '‚è±Ô∏è',
                        text: `<span class="alert-name">${s.student.full_name || 'Unknown'}</span> has only ${Math.round(s.totalTime / 60)} min practice`
                    });
                }
            });
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-alerts">
                        <div class="no-alerts-icon">‚úÖ</div>
                        <div>All students on track!</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = alerts.slice(0, 5).map(alert => `
                <div class="alert-item ${alert.type === 'danger' ? 'danger' : ''}">
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-text">${alert.text}</div>
                </div>
            `).join('');
        }
        
        async function loadLeaderboard() {
            showLeaderboard('time', document.querySelector('.lb-tab.active'));
        }
        
        function showLeaderboard(type, btn) {
            // Update active tab
            document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            const container = document.getElementById('leaderboardContainer');
            
            if (classStatsData.studentStats.length === 0) {
                container.innerHTML = '<div class="loading" style="padding: 2rem;">No data yet</div>';
                return;
            }
            
            let sorted = [...classStatsData.studentStats];
            let valueFormatter;
            
            switch (type) {
                case 'time':
                    sorted.sort((a, b) => b.totalTime - a.totalTime);
                    valueFormatter = s => {
                        const mins = Math.round(s.totalTime / 60);
                        return mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins}m`;
                    };
                    break;
                case 'words':
                    sorted.sort((a, b) => b.wordsMastered - a.wordsMastered);
                    valueFormatter = s => `${s.wordsMastered} words`;
                    break;
                case 'streak':
                    sorted.sort((a, b) => b.streak - a.streak);
                    valueFormatter = s => s.streak > 0 ? `${s.streak} days üî•` : '-';
                    break;
                case 'score':
                    sorted.sort((a, b) => b.avgScore - a.avgScore);
                    valueFormatter = s => s.avgScore > 0 ? `${s.avgScore}%` : '-';
                    break;
            }
            
            container.innerHTML = '<ul class="leaderboard-list">' + 
                sorted.slice(0, 10).map((s, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;
                    return `
                        <li class="leaderboard-item">
                            <span class="leaderboard-rank ${rankClass}">${medal}</span>
                            <span class="leaderboard-name">${s.student.full_name || 'Unknown'}</span>
                            <span class="leaderboard-value">${valueFormatter(s)}</span>
                        </li>
                    `;
                }).join('') + '</ul>';
        }
        
        document.getElementById('setVocabTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('vocabTitle').value.trim();
            const chapter = document.getElementById('taskChapter').value;
            const fromWord = document.getElementById('taskFromWord').value;
            const toWord = document.getElementById('taskToWord').value;
            const dueDate = document.getElementById('vocabDueDate').value;
            
            if (!chapter || fromWord === '' || toWord === '') {
                showMessage('taskMessage', 'Please select chapter and word range.', 'error');
                return;
            }
            
            const contentPath = getVocabPracticeUrl(chapter, fromWord, toWord);
            
            const result = await setTask(title, contentPath, dueDate);
            
            if (result.success) {
                showMessage('taskMessage', 'Task created successfully!', 'success');
                document.getElementById('setVocabTaskForm').reset();
                document.getElementById('taskFromWord').disabled = true;
                document.getElementById('taskToWord').disabled = true;
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });
        
        document.getElementById('setCustomTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('customTitle').value.trim();
            const url = document.getElementById('customUrl').value.trim();
            const dueDate = document.getElementById('customDueDate').value;
            
            const result = await setTask(title, url, dueDate);
            
            if (result.success) {
                showMessage('taskMessage', 'Task created successfully!', 'success');
                document.getElementById('setCustomTaskForm').reset();
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });
        
        // Set Text data
        const setTextData = {
            messalina: {
                title: 'Messalina',
                author: 'Tacitus',
                sections: [
                    { num: 1, lines: '1-8', title: 'Silius is forced to have an affair with Messalina' },
                    { num: 2, lines: '8-17', title: "Messalina's visits to Silius become increasingly more frequent" },
                    { num: 3, lines: '17-26', title: 'Eventually, Messalina decides to marry Silius' },
                    { num: 4, lines: '27-38', title: 'Widespread knowledge of the affair prompts Narcissus to take action' },
                    { num: 5, lines: '39-49', title: 'The marriage becomes known to Claudius' },
                    { num: 6, lines: '49-59', title: 'Silius hides and Messalina appeals to Claudius' },
                    { num: 7, lines: '60-69', title: 'Narcissus arranges the assassination of Messalina' },
                    { num: 8, lines: '70-79', title: 'Narcissus orders a tribune to murder Messalina' },
                    { num: 9, lines: '79-89', title: 'Messalina is killed by the tribune' }
                ]
            }
        };
        
        // Handle text selection change
        document.getElementById('setTextSelect').addEventListener('change', function() {
            const textId = this.value;
            const sectionSelect = document.getElementById('setTextSection');
            
            if (!textId) {
                sectionSelect.innerHTML = '<option value="">Select text first</option>';
                sectionSelect.disabled = true;
                return;
            }
            
            const textData = setTextData[textId];
            sectionSelect.innerHTML = '<option value="">Select section...</option>';
            
            textData.sections.forEach(s => {
                const option = document.createElement('option');
                option.value = s.num;
                option.textContent = `Section ${s.num} (Lines ${s.lines}): ${s.title}`;
                sectionSelect.appendChild(option);
            });
            
            sectionSelect.disabled = false;
            
            // Auto-fill title
            const titleInput = document.getElementById('setTextTitle');
            if (!titleInput.value) {
                titleInput.value = `${textData.title} Section`;
            }
        });
        
        // Handle section selection - update title
        document.getElementById('setTextSection').addEventListener('change', function() {
            const textId = document.getElementById('setTextSelect').value;
            const sectionNum = this.value;
            
            if (textId && sectionNum) {
                const textData = setTextData[textId];
                const section = textData.sections.find(s => s.num == sectionNum);
                document.getElementById('setTextTitle').value = `${textData.title} Section ${sectionNum}: ${section.title}`;
            }
        });
        
        // Set text form submission
        document.getElementById('setSetTextTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('setTextTitle').value.trim();
            const textId = document.getElementById('setTextSelect').value;
            const sectionNum = document.getElementById('setTextSection').value;
            const dueDate = document.getElementById('setTextDueDate').value;
            
            if (!textId || !sectionNum) {
                showMessage('taskMessage', 'Please select a text and section', 'error');
                return;
            }
            
            const contentPath = `/latin/literature/set-text-quiz.html?text=${textId}&section=${sectionNum}`;
            
            const result = await setTask(title, contentPath, dueDate);
            
            if (result.success) {
                showMessage('taskMessage', 'Literature task created successfully!', 'success');
                document.getElementById('setSetTextTaskForm').reset();
                document.getElementById('setTextSection').disabled = true;
                await loadTasks();
                await loadCompletionGrid();
            } else {
                showMessage('taskMessage', result.error, 'error');
            }
        });
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
