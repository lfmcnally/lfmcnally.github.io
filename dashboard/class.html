<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Details - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #FFFFFF;
            min-height: 100vh;
            color: #000000;
            line-height: 1.5;
        }

        /* Professional Header */
        .header {
            background: #000000;
            color: #FFFFFF;
            padding: 1.5rem 2rem;
            border-bottom: 3px solid #000000;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .class-meta {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .class-meta span {
            margin-right: 1rem;
        }
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
            border: 2px solid;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        .btn-primary {
            background: #000000;
            color: #FFFFFF;
            border-color: #FFFFFF;
        }
        .btn-primary:hover {
            background: #2E7D32;
            border-color: #2E7D32;
        }
        .btn-secondary {
            background: #FFFFFF;
            color: #000000;
            border-color: #FFFFFF;
        }
        .btn-secondary:hover {
            background: #F5F5F5;
        }
        .btn-ghost {
            background: transparent;
            color: #FFFFFF;
            border-color: #FFFFFF;
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.1);
        }
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Date range selector */
        .date-range-select {
            padding: 0.5rem;
            border: 2px solid #FFFFFF;
            background: transparent;
            color: #FFFFFF;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 600;
        }
        .date-range-select option {
            background: #000000;
            color: #FFFFFF;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1px;
            background: #E0E0E0;
            border: 1px solid #E0E0E0;
            margin-bottom: 2rem;
        }
        .stat-item {
            background: #FFFFFF;
            padding: 1.25rem;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #000000;
            font-variant-numeric: tabular-nums;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #757575;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #000000;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #000000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Student Table */
        .student-table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
            margin-bottom: 2rem;
        }
        .student-table thead {
            background: #F5F5F5;
            border-bottom: 2px solid #000000;
        }
        .student-table th {
            text-align: left;
            padding: 0.875rem;
            font-weight: 700;
            font-size: 0.75rem;
            color: #424242;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid #E0E0E0;
            cursor: pointer;
            user-select: none;
        }
        .student-table th:hover {
            background: #E5E7EB;
        }
        .student-table th:last-child {
            border-right: none;
        }
        .student-table th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
        }
        .student-table th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }
        .student-table th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }
        .student-table tbody tr {
            border-bottom: 1px solid #E0E0E0;
            transition: background 0.1s;
        }
        .student-table tbody tr:hover {
            background: #FAFAFA;
        }
        .student-table tbody tr.status-critical {
            background: #FFEBEE;
        }
        .student-table tbody tr.status-warning {
            background: #FFF3E0;
        }
        .student-table tbody tr.status-excellent {
            background: #E8F5E9;
        }
        .student-table td {
            padding: 1rem 0.875rem;
            font-size: 0.9rem;
            border-right: 1px solid #F5F5F5;
            vertical-align: middle;
        }
        .student-table td:last-child {
            border-right: none;
        }

        /* Student Name Cell */
        .student-name-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.critical {
            background: #C62828;
        }
        .status-dot.warning {
            background: #F57C00;
        }
        .status-dot.good {
            background: #2E7D32;
        }
        .status-dot.inactive {
            background: #BDBDBD;
        }
        .student-name-link {
            font-weight: 600;
            color: #000000;
            text-decoration: none;
        }
        .student-name-link:hover {
            text-decoration: underline;
        }

        /* Table metrics */
        .metric-value {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            color: #000000;
        }
        .metric-secondary {
            font-size: 0.75rem;
            color: #757575;
            display: block;
            margin-top: 0.125rem;
        }
        .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 2px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .badge-critical {
            background: #C62828;
            color: #FFFFFF;
        }
        .badge-warning {
            background: #F57C00;
            color: #FFFFFF;
        }
        .badge-none {
            background: #E0E0E0;
            color: #757575;
        }

        /* Progress Bar */
        .progress-mini {
            width: 100%;
            height: 6px;
            background: #E0E0E0;
            border-radius: 0;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }
        .progress-fill.critical {
            background: #C62828;
        }
        .progress-fill.warning {
            background: #F57C00;
        }
        .progress-fill.good {
            background: #2E7D32;
        }
        .progress-fill.excellent {
            background: #000000;
        }

        /* Visualization Grid */
        .viz-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .viz-card {
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
            padding: 1.5rem;
        }
        .viz-card-header {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E0E0E0;
        }

        /* Activity Heatmap */
        .heatmap-container {
            overflow-x: auto;
        }
        .heatmap-summary {
            font-size: 0.85rem;
            color: #757575;
            margin-bottom: 1rem;
            display: flex;
            gap: 1.5rem;
        }
        .heatmap-grid {
            display: grid;
            grid-template-columns: 150px auto;
            gap: 0.5rem;
            min-width: 600px;
        }
        .heatmap-student-name {
            font-size: 0.85rem;
            padding: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .heatmap-cells {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(18px, 1fr));
            gap: 2px;
        }
        .heatmap-cell {
            width: 18px;
            height: 18px;
            background: #F5F5F5;
            border: 1px solid #E0E0E0;
            cursor: pointer;
        }
        .heatmap-cell.level-1 { background: #EEEEEE; }
        .heatmap-cell.level-2 { background: #BDBDBD; }
        .heatmap-cell.level-3 { background: #757575; }
        .heatmap-cell.level-4 { background: #424242; }
        .heatmap-cell.level-5 { background: #000000; }
        .heatmap-legend {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #757575;
            align-items: center;
        }
        .heatmap-legend-box {
            width: 15px;
            height: 15px;
            border: 1px solid #E0E0E0;
        }

        /* Progress Distribution */
        .distribution-bar {
            width: 100%;
            height: 60px;
            display: flex;
            border: 1px solid #E0E0E0;
            overflow: hidden;
        }
        .distribution-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .distribution-segment:hover {
            opacity: 0.8;
        }
        .distribution-segment.critical {
            background: #C62828;
            color: #FFFFFF;
        }
        .distribution-segment.warning {
            background: #F57C00;
            color: #FFFFFF;
        }
        .distribution-segment.acceptable {
            background: #BDBDBD;
            color: #000000;
        }
        .distribution-segment.excellent {
            background: #2E7D32;
            color: #FFFFFF;
        }
        .distribution-legend {
            margin-top: 1rem;
            font-size: 0.85rem;
        }
        .distribution-legend-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #F5F5F5;
        }

        /* Weak Areas List */
        .weak-areas-list {
            list-style: none;
        }
        .weak-area-item {
            padding: 0.75rem;
            border: 1px solid #E0E0E0;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .weak-area-item.critical {
            border-left: 4px solid #C62828;
        }
        .weak-area-item.warning {
            border-left: 4px solid #F57C00;
        }
        .weak-area-rank {
            font-weight: 700;
            font-size: 1.5rem;
            color: #BDBDBD;
            margin-right: 1rem;
        }
        .weak-area-info {
            flex: 1;
        }
        .weak-area-name {
            font-weight: 600;
            color: #000000;
        }
        .weak-area-meta {
            font-size: 0.75rem;
            color: #757575;
            margin-top: 0.125rem;
        }
        .weak-area-score {
            font-size: 1.25rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        .weak-area-score.critical {
            color: #C62828;
        }
        .weak-area-score.warning {
            color: #F57C00;
        }

        /* Time Spent List */
        .time-list {
            list-style: none;
        }
        .time-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid #F5F5F5;
        }
        .time-item:hover {
            background: #FAFAFA;
        }
        .time-rank {
            font-weight: 700;
            color: #BDBDBD;
            margin-right: 1rem;
        }
        .time-student {
            flex: 1;
            font-weight: 600;
        }
        .time-value {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        .time-value.high {
            color: #2E7D32;
        }
        .time-value.medium {
            color: #F57C00;
        }
        .time-value.low {
            color: #757575;
        }

        /* Prep Task Completion */
        .prep-completion {
            text-align: center;
        }
        .completion-ring {
            width: 200px;
            height: 200px;
            margin: 0 auto 1rem;
            position: relative;
        }
        .completion-ring svg {
            transform: rotate(-90deg);
        }
        .completion-ring circle {
            fill: none;
            stroke-width: 20;
        }
        .completion-ring .bg-circle {
            stroke: #E0E0E0;
        }
        .completion-ring .progress-circle {
            stroke: #2E7D32;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s;
        }
        .completion-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 700;
        }
        .completion-label {
            font-size: 0.85rem;
            color: #757575;
            margin-top: 0.5rem;
        }
        .task-breakdown {
            margin-top: 1.5rem;
            text-align: left;
        }
        .task-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid #F5F5F5;
            font-size: 0.85rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #757575;
        }
        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #757575;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .viz-grid {
                grid-template-columns: 1fr;
            }
            .student-table {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .header {
                padding: 1rem;
            }
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Convert table to cards on mobile */
            .student-table thead {
                display: none;
            }
            .student-table tbody,
            .student-table tr,
            .student-table td {
                display: block;
            }
            .student-table tr {
                margin-bottom: 1rem;
                border: 1px solid #E0E0E0;
            }
            .student-table td {
                border: none;
                border-bottom: 1px solid #F5F5F5;
                padding: 0.75rem;
            }
            .student-table td:before {
                content: attr(data-label);
                font-weight: 700;
                text-transform: uppercase;
                font-size: 0.7rem;
                color: #757575;
                display: block;
                margin-bottom: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1 id="className">Loading...</h1>
                <div class="class-meta">
                    <span id="classSubject">‚Äî</span> | <span id="classCode">‚Äî</span>
                </div>
            </div>
            <div class="header-actions">
                <select class="date-range-select" id="dateRange" onchange="updateDateRange()">
                    <option value="14">Last 14 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="60">Last 60 days</option>
                </select>
                <button class="btn btn-secondary btn-sm" onclick="exportData()">üìä Export</button>
                <a href="teacher.html" class="btn btn-ghost btn-sm">‚Üê Back</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="statStudents">0</div>
                <div class="stat-label">Students</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statAvgProgress">0%</div>
                <div class="stat-label">Avg Progress</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statActive">0</div>
                <div class="stat-label">Active (7d)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statOverdue">0</div>
                <div class="stat-label">Overdue Tasks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statTotalTime">0h</div>
                <div class="stat-label">Practice Time</div>
            </div>
        </div>

        <!-- Student Overview Table -->
        <div class="section-header">
            <span class="section-title">Student Progress</span>
        </div>

        <div id="studentTableContainer">
            <div class="loading">Loading student data...</div>
        </div>

        <!-- Visualizations -->
        <div class="section-header" style="margin-top: 3rem;">
            <span class="section-title">Analytics</span>
        </div>

        <div class="viz-grid">
            <!-- Activity Heatmap -->
            <div class="viz-card" style="grid-column: 1 / -1;">
                <div class="viz-card-header">Activity Heatmap</div>
                <div id="heatmapContainer">
                    <div class="loading">Loading heatmap...</div>
                </div>
            </div>

            <!-- Progress Distribution -->
            <div class="viz-card">
                <div class="viz-card-header">Progress Distribution</div>
                <div id="distributionContainer">
                    <div class="loading">Loading distribution...</div>
                </div>
            </div>

            <!-- Weak Areas -->
            <div class="viz-card">
                <div class="viz-card-header">Top 5 Weak Areas</div>
                <div id="weakAreasContainer">
                    <div class="loading">Loading weak areas...</div>
                </div>
            </div>

            <!-- Time Spent Ranking -->
            <div class="viz-card">
                <div class="viz-card-header">Time Spent Ranking</div>
                <div id="timeRankingContainer">
                    <div class="loading">Loading rankings...</div>
                </div>
            </div>

            <!-- Prep Task Completion -->
            <div class="viz-card">
                <div class="viz-card-header">Prep Task Completion</div>
                <div id="prepCompletionContainer">
                    <div class="loading">Loading task data...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    <script src="../shared/analytics-engine.js"></script>
    <script>
        let currentUser = null;
        let currentClass = null;
        let classStudents = [];
        let studentData = [];
        let dateRangeDays = 30;
        let analyticsEngine = null;

        // Class type configuration
        const classTypeConfig = {
            latin: {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'vocab', 'setText', 'contentTest', 'prep'],
                name: 'Latin GCSE'
            },
            greek: {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'vocab', 'contentTest', 'prep'],
                name: 'Greek GCSE'
            },
            classics: {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'reading', 'contentTest', 'prep'],
                name: 'Classical Civilisation'
            },
            'prep-latin': {
                columns: ['name', 'lastActivity', 'totalTime', 'progress', 'vocab', 'prep'],
                name: 'Prep School Latin'
            }
        };

        // Initialize
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Get user profile
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'teacher') {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = profile;
            analyticsEngine = new AnalyticsEngine(supabase);

            // Get class ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const classId = urlParams.get('id');

            if (!classId) {
                alert('No class ID provided');
                window.location.href = 'teacher.html';
                return;
            }

            // Load class data
            await loadClass(classId);
            await loadStudents();
            await loadStudentData();
            renderStudentTable();
            await loadVisualizations();
        }

        // Load class details
        async function loadClass(classId) {
            const { data, error } = await supabase
                .from('classes')
                .select('*')
                .eq('id', classId)
                .single();

            if (error || !data) {
                alert('Error loading class');
                window.location.href = 'teacher.html';
                return;
            }

            currentClass = data;
            const config = classTypeConfig[data.type] || classTypeConfig.latin;

            document.getElementById('className').textContent = data.name;
            document.getElementById('classSubject').textContent = config.name;
            document.getElementById('classCode').textContent = 'Join Code: ' + data.join_code;
        }

        // Load students
        async function loadStudents() {
            const { data: members, error } = await supabase
                .from('class_members')
                .select(`
                    student_id,
                    joined_at,
                    users (
                        id,
                        full_name,
                        email
                    )
                `)
                .eq('class_id', currentClass.id);

            if (error) {
                console.error('Error loading students:', error);
                return;
            }

            classStudents = (members || []).map(m => m.users).filter(u => u !== null);
            document.getElementById('statStudents').textContent = classStudents.length;
        }

        // Load student data
        async function loadStudentData() {
            if (classStudents.length === 0) {
                studentData = [];
                return;
            }

            const studentIds = classStudents.map(s => s.id);

            // Parallel data loading for all students
            const dataPromises = classStudents.map(async student => {
                const data = {
                    id: student.id,
                    name: student.full_name || student.email,
                    lastActivity: null,
                    totalTime: 0,
                    vocabProgress: 0,
                    setTextAvg: 0,
                    readingProgress: 0,
                    contentTestAvg: 0,
                    outstandingPrep: 0,
                    overallProgress: 0
                };

                // Get all task attempts
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const { data: attempts } = await supabase
                    .from('task_attempts')
                    .select('*')
                    .eq('student_id', student.id)
                    .gte('started_at', sevenDaysAgo.toISOString());

                if (attempts && attempts.length > 0) {
                    data.totalTime = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                    const latestAttempt = attempts.reduce((latest, a) => {
                        const date = new Date(a.started_at || a.completed_at);
                        return !latest || date > new Date(latest) ? a.started_at || a.completed_at : latest;
                    }, null);
                    data.lastActivity = latestAttempt;
                }

                // Vocabulary progress (for Latin/Greek/Prep-Latin)
                if (['latin', 'greek', 'prep-latin'].includes(currentClass.type)) {
                    const language = currentClass.type === 'prep-latin' ? 'prep-latin' : currentClass.type;
                    const { data: wordMastery } = await supabase
                        .from('word_mastery')
                        .select('*')
                        .eq('student_id', student.id)
                        .eq('language', language);

                    if (wordMastery && wordMastery.length > 0) {
                        const mastered = wordMastery.filter(w => w.mastered_at).length;
                        data.vocabProgress = Math.round((mastered / wordMastery.length) * 100);
                    }
                }

                // Set text progress (Latin only)
                if (currentClass.type === 'latin') {
                    const { data: setTextProgress } = await supabase
                        .from('set_text_progress')
                        .select('best_score')
                        .eq('user_id', student.id);

                    if (setTextProgress && setTextProgress.length > 0) {
                        const avgScore = setTextProgress.reduce((sum, s) => sum + (s.best_score || 0), 0) / setTextProgress.length;
                        data.setTextAvg = Math.round(avgScore);
                    }
                }

                // Reading progress (Classics only)
                if (currentClass.type === 'classics') {
                    const { data: readingAttempts } = await supabase
                        .from('task_attempts')
                        .select('content_path')
                        .eq('student_id', student.id)
                        .eq('total_questions', 0)
                        .not('content_path', 'is', null);

                    if (readingAttempts && readingAttempts.length > 0) {
                        const uniqueLessons = new Set(readingAttempts.map(a => a.content_path));
                        data.readingProgress = uniqueLessons.size * 5; // Rough estimate
                    }
                }

                // Content test average
                const { data: contentTests } = await supabase
                    .from('content_test_attempts')
                    .select('score_percentage')
                    .eq('student_id', student.id);

                if (contentTests && contentTests.length > 0) {
                    const avgScore = contentTests.reduce((sum, t) => sum + (t.score_percentage || 0), 0) / contentTests.length;
                    data.contentTestAvg = Math.round(avgScore);
                }

                // Outstanding prep tasks
                const { data: tasks } = await supabase
                    .from('tasks')
                    .select('id')
                    .eq('class_id', currentClass.id);

                if (tasks && tasks.length > 0) {
                    const taskIds = tasks.map(t => t.id);
                    const { data: completions } = await supabase
                        .from('task_attempts')
                        .select('task_id')
                        .eq('student_id', student.id)
                        .in('task_id', taskIds)
                        .not('completed_at', 'is', null);

                    const completedIds = new Set((completions || []).map(c => c.task_id));
                    data.outstandingPrep = taskIds.length - completedIds.size;
                }

                // Calculate overall progress
                let progressFactors = [];
                if (data.vocabProgress > 0) progressFactors.push(data.vocabProgress);
                if (data.setTextAvg > 0) progressFactors.push(data.setTextAvg);
                if (data.readingProgress > 0) progressFactors.push(data.readingProgress);
                if (data.contentTestAvg > 0) progressFactors.push(data.contentTestAvg);

                if (progressFactors.length > 0) {
                    data.overallProgress = Math.round(progressFactors.reduce((sum, p) => sum + p, 0) / progressFactors.length);
                }

                return data;
            });

            studentData = await Promise.all(dataPromises);

            // Update stats
            updateStats();
        }

        // Update stats bar
        function updateStats() {
            // Average progress
            const avgProgress = studentData.length > 0
                ? Math.round(studentData.reduce((sum, s) => sum + s.overallProgress, 0) / studentData.length)
                : 0;
            document.getElementById('statAvgProgress').textContent = avgProgress + '%';

            // Active last 7 days
            const active = studentData.filter(s => s.lastActivity).length;
            document.getElementById('statActive').textContent = active;

            // Total overdue tasks
            const overdue = studentData.reduce((sum, s) => sum + s.outstandingPrep, 0);
            document.getElementById('statOverdue').textContent = overdue;

            // Total practice time
            const totalSeconds = studentData.reduce((sum, s) => sum + s.totalTime, 0);
            const hours = Math.round(totalSeconds / 3600);
            document.getElementById('statTotalTime').textContent = hours + 'h';
        }

        // Render student table
        function renderStudentTable() {
            const container = document.getElementById('studentTableContainer');

            if (studentData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚Äî</div>
                        <p>No students in this class yet. Share the join code!</p>
                    </div>
                `;
                return;
            }

            const config = classTypeConfig[currentClass.type];
            const columns = config.columns;

            // Build table headers
            let headerHtml = '<tr>';
            if (columns.includes('name')) headerHtml += '<th class="sortable" onclick="sortTable(\'name\')">Student</th>';
            if (columns.includes('lastActivity')) headerHtml += '<th class="sortable" onclick="sortTable(\'lastActivity\')">Last Active</th>';
            if (columns.includes('totalTime')) headerHtml += '<th class="sortable" onclick="sortTable(\'totalTime\')">Time (7d)</th>';
            if (columns.includes('progress')) headerHtml += '<th class="sortable" onclick="sortTable(\'progress\')">Overall %</th>';
            if (columns.includes('vocab')) headerHtml += '<th class="sortable" onclick="sortTable(\'vocab\')">Vocab %</th>';
            if (columns.includes('setText')) headerHtml += '<th class="sortable" onclick="sortTable(\'setText\')">Set Text %</th>';
            if (columns.includes('reading')) headerHtml += '<th class="sortable" onclick="sortTable(\'reading\')">Reading</th>';
            if (columns.includes('contentTest')) headerHtml += '<th class="sortable" onclick="sortTable(\'contentTest\')">Content %</th>';
            if (columns.includes('prep')) headerHtml += '<th class="sortable" onclick="sortTable(\'prep\')">Tasks</th>';
            headerHtml += '</tr>';

            // Build table rows
            let rowsHtml = '';
            for (const student of studentData) {
                // Determine row status
                let statusClass = '';
                let statusDot = 'inactive';

                if (student.overallProgress >= 85) {
                    statusClass = 'status-excellent';
                    statusDot = 'good';
                } else if (student.overallProgress < 50 || student.outstandingPrep > 2) {
                    statusClass = 'status-critical';
                    statusDot = 'critical';
                } else if (student.overallProgress < 70 || student.outstandingPrep > 0) {
                    statusClass = 'status-warning';
                    statusDot = 'warning';
                } else if (student.lastActivity) {
                    statusDot = 'good';
                }

                rowsHtml += `<tr class="${statusClass}">`;

                // Student name
                if (columns.includes('name')) {
                    rowsHtml += `
                        <td data-label="Student">
                            <div class="student-name-cell">
                                <span class="status-dot ${statusDot}"></span>
                                <a href="student-profile.html?student_id=${student.id}&class_id=${currentClass.id}" class="student-name-link">
                                    ${student.name}
                                </a>
                            </div>
                        </td>
                    `;
                }

                // Last activity
                if (columns.includes('lastActivity')) {
                    const timeAgo = student.lastActivity ? getTimeAgo(new Date(student.lastActivity)) : 'No activity';
                    rowsHtml += `<td data-label="Last Active"><span class="metric-value">${timeAgo}</span></td>`;
                }

                // Total time
                if (columns.includes('totalTime')) {
                    const hours = Math.floor(student.totalTime / 3600);
                    const minutes = Math.floor((student.totalTime % 3600) / 60);
                    const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    rowsHtml += `<td data-label="Time (7d)"><span class="metric-value">${timeStr}</span></td>`;
                }

                // Overall progress
                if (columns.includes('progress')) {
                    let progressClass = 'critical';
                    if (student.overallProgress >= 85) progressClass = 'excellent';
                    else if (student.overallProgress >= 70) progressClass = 'good';
                    else if (student.overallProgress >= 50) progressClass = 'warning';

                    rowsHtml += `
                        <td data-label="Overall %">
                            <span class="metric-value">${student.overallProgress}%</span>
                            <div class="progress-mini">
                                <div class="progress-fill ${progressClass}" style="width: ${student.overallProgress}%"></div>
                            </div>
                        </td>
                    `;
                }

                // Vocab progress
                if (columns.includes('vocab')) {
                    rowsHtml += `<td data-label="Vocab %"><span class="metric-value">${student.vocabProgress}%</span></td>`;
                }

                // Set text average
                if (columns.includes('setText')) {
                    rowsHtml += `<td data-label="Set Text %"><span class="metric-value">${student.setTextAvg}%</span></td>`;
                }

                // Reading progress
                if (columns.includes('reading')) {
                    rowsHtml += `<td data-label="Reading"><span class="metric-value">${student.readingProgress} lessons</span></td>`;
                }

                // Content test average
                if (columns.includes('contentTest')) {
                    rowsHtml += `<td data-label="Content %"><span class="metric-value">${student.contentTestAvg}%</span></td>`;
                }

                // Outstanding prep
                if (columns.includes('prep')) {
                    let badgeClass = 'badge-none';
                    let badgeText = 'None';
                    if (student.outstandingPrep > 0) {
                        badgeClass = student.outstandingPrep > 2 ? 'badge-critical' : 'badge-warning';
                        badgeText = student.outstandingPrep.toString();
                    }
                    rowsHtml += `<td data-label="Tasks"><span class="badge ${badgeClass}">${badgeText}</span></td>`;
                }

                rowsHtml += '</tr>';
            }

            container.innerHTML = `
                <table class="student-table">
                    <thead>${headerHtml}</thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            `;
        }

        // Sort table
        let currentSort = { column: null, direction: 'asc' };

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }

            const sortMap = {
                'name': 'name',
                'lastActivity': 'lastActivity',
                'totalTime': 'totalTime',
                'progress': 'overallProgress',
                'vocab': 'vocabProgress',
                'setText': 'setTextAvg',
                'reading': 'readingProgress',
                'contentTest': 'contentTestAvg',
                'prep': 'outstandingPrep'
            };

            const key = sortMap[column];
            studentData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                // Handle nulls
                if (valA === null || valA === undefined) valA = currentSort.direction === 'asc' ? Infinity : -Infinity;
                if (valB === null || valB === undefined) valB = currentSort.direction === 'asc' ? Infinity : -Infinity;

                // String comparison for name
                if (key === 'name') {
                    return currentSort.direction === 'asc'
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }

                // Numeric comparison
                return currentSort.direction === 'asc' ? valA - valB : valB - valA;
            });

            renderStudentTable();

            // Update header styling
            document.querySelectorAll('.student-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const headerIndex = Array.from(document.querySelectorAll('.student-table th')).findIndex(th =>
                th.textContent.toLowerCase().includes(column.toLowerCase().replace(/([A-Z])/g, ' $1').trim())
            );
            if (headerIndex >= 0) {
                const header = document.querySelectorAll('.student-table th')[headerIndex];
                header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // Load visualizations
        async function loadVisualizations() {
            await loadHeatmap();
            await loadProgressDistribution();
            await loadWeakAreas();
            await loadTimeRanking();
            await loadPrepCompletion();
        }

        // Load heatmap
        async function loadHeatmap() {
            const container = document.getElementById('heatmapContainer');

            if (classStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No students yet</p></div>';
                return;
            }

            try {
                const heatmapData = await analyticsEngine.generateClassActivityHeatmap(currentClass.id, dateRangeDays);

                if (!heatmapData || !heatmapData.students || heatmapData.students.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No activity data</p></div>';
                    return;
                }

                // Summary
                let html = `
                    <div class="heatmap-summary">
                        <span><strong>${heatmapData.summary.activeStudents}</strong> / ${heatmapData.summary.totalStudents} students active</span>
                        <span><strong>${heatmapData.summary.totalSessions}</strong> total sessions</span>
                        <span><strong>${Math.round(heatmapData.summary.totalTime / 60)}</strong> minutes</span>
                    </div>
                    <div class="heatmap-container">
                `;

                // Build grid for each student
                for (const student of heatmapData.students) {
                    html += '<div class="heatmap-grid">';
                    html += `<div class="heatmap-student-name">${student.studentName}</div>`;
                    html += '<div class="heatmap-cells">';

                    for (const date of heatmapData.dates) {
                        const activity = student.activity[date];
                        const sessions = activity.sessions;

                        let level = 0;
                        if (sessions >= 5) level = 5;
                        else if (sessions >= 4) level = 4;
                        else if (sessions >= 2) level = 3;
                        else if (sessions === 1) level = 2;
                        else if (sessions > 0) level = 1;

                        const tooltip = `${date}: ${sessions} sessions, ${Math.round(activity.timeSpent / 60)} min`;
                        html += `<div class="heatmap-cell ${level > 0 ? 'level-' + level : ''}" title="${tooltip}"></div>`;
                    }

                    html += '</div></div>';
                }

                html += `
                    </div>
                    <div class="heatmap-legend">
                        <span>Less</span>
                        <div class="heatmap-legend-box" style="background: #F5F5F5;"></div>
                        <div class="heatmap-legend-box" style="background: #BDBDBD;"></div>
                        <div class="heatmap-legend-box" style="background: #757575;"></div>
                        <div class="heatmap-legend-box" style="background: #424242;"></div>
                        <div class="heatmap-legend-box" style="background: #000000;"></div>
                        <span>More</span>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading heatmap:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>Error loading heatmap</p></div>';
            }
        }

        // Load progress distribution
        async function loadProgressDistribution() {
            const container = document.getElementById('distributionContainer');

            if (studentData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No data</p></div>';
                return;
            }

            const distribution = {
                critical: studentData.filter(s => s.overallProgress < 50).length,
                warning: studentData.filter(s => s.overallProgress >= 50 && s.overallProgress < 70).length,
                acceptable: studentData.filter(s => s.overallProgress >= 70 && s.overallProgress < 85).length,
                excellent: studentData.filter(s => s.overallProgress >= 85).length
            };

            const total = studentData.length;

            let html = '<div class="distribution-bar">';

            if (distribution.critical > 0) {
                const percent = (distribution.critical / total) * 100;
                html += `<div class="distribution-segment critical" style="width: ${percent}%">${distribution.critical}</div>`;
            }
            if (distribution.warning > 0) {
                const percent = (distribution.warning / total) * 100;
                html += `<div class="distribution-segment warning" style="width: ${percent}%">${distribution.warning}</div>`;
            }
            if (distribution.acceptable > 0) {
                const percent = (distribution.acceptable / total) * 100;
                html += `<div class="distribution-segment acceptable" style="width: ${percent}%">${distribution.acceptable}</div>`;
            }
            if (distribution.excellent > 0) {
                const percent = (distribution.excellent / total) * 100;
                html += `<div class="distribution-segment excellent" style="width: ${percent}%">${distribution.excellent}</div>`;
            }

            html += '</div>';
            html += '<div class="distribution-legend">';
            html += `<div class="distribution-legend-item"><span>< 50% (Critical)</span><strong>${distribution.critical} students</strong></div>`;
            html += `<div class="distribution-legend-item"><span>50-70% (Warning)</span><strong>${distribution.warning} students</strong></div>`;
            html += `<div class="distribution-legend-item"><span>70-85% (Acceptable)</span><strong>${distribution.acceptable} students</strong></div>`;
            html += `<div class="distribution-legend-item"><span>‚â• 85% (Excellent)</span><strong>${distribution.excellent} students</strong></div>`;
            html += '</div>';

            container.innerHTML = html;
        }

        // Load weak areas
        async function loadWeakAreas() {
            const container = document.getElementById('weakAreasContainer');

            // Calculate weak areas based on class type
            const weakAreas = [];

            if (['latin', 'greek', 'prep-latin'].includes(currentClass.type)) {
                const avgVocab = studentData.filter(s => s.vocabProgress > 0).length > 0
                    ? Math.round(studentData.reduce((sum, s) => sum + s.vocabProgress, 0) / studentData.filter(s => s.vocabProgress > 0).length)
                    : 0;
                if (avgVocab < 70) {
                    weakAreas.push({
                        name: 'Vocabulary Mastery',
                        avg: avgVocab,
                        struggling: studentData.filter(s => s.vocabProgress < 70).length
                    });
                }
            }

            if (currentClass.type === 'latin') {
                const avgSetText = studentData.filter(s => s.setTextAvg > 0).length > 0
                    ? Math.round(studentData.reduce((sum, s) => sum + s.setTextAvg, 0) / studentData.filter(s => s.setTextAvg > 0).length)
                    : 0;
                if (avgSetText < 70) {
                    weakAreas.push({
                        name: 'Set Text Comprehension',
                        avg: avgSetText,
                        struggling: studentData.filter(s => s.setTextAvg < 70 && s.setTextAvg > 0).length
                    });
                }
            }

            if (currentClass.type === 'classics') {
                const avgReading = studentData.filter(s => s.readingProgress > 0).length > 0
                    ? Math.round(studentData.reduce((sum, s) => sum + s.readingProgress, 0) / studentData.filter(s => s.readingProgress > 0).length)
                    : 0;
                if (avgReading < 50) {
                    weakAreas.push({
                        name: 'Reading Completion',
                        avg: avgReading,
                        struggling: studentData.filter(s => s.readingProgress < 50).length
                    });
                }
            }

            const avgContentTest = studentData.filter(s => s.contentTestAvg > 0).length > 0
                ? Math.round(studentData.reduce((sum, s) => sum + s.contentTestAvg, 0) / studentData.filter(s => s.contentTestAvg > 0).length)
                : 0;
            if (avgContentTest < 70) {
                weakAreas.push({
                    name: 'Content Tests',
                    avg: avgContentTest,
                    struggling: studentData.filter(s => s.contentTestAvg < 70 && s.contentTestAvg > 0).length
                });
            }

            // Outstanding prep
            const totalOutstanding = studentData.reduce((sum, s) => sum + s.outstandingPrep, 0);
            if (totalOutstanding > 0) {
                weakAreas.push({
                    name: 'Prep Task Completion',
                    avg: Math.round(((studentData.length * 5 - totalOutstanding) / (studentData.length * 5)) * 100),
                    struggling: studentData.filter(s => s.outstandingPrep > 0).length
                });
            }

            // Sort by severity
            weakAreas.sort((a, b) => a.avg - b.avg);
            const top5 = weakAreas.slice(0, 5);

            if (top5.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><p>No significant weak areas detected</p></div>';
                return;
            }

            let html = '<ul class="weak-areas-list">';
            top5.forEach((area, index) => {
                const severity = area.avg < 50 ? 'critical' : 'warning';
                html += `
                    <li class="weak-area-item ${severity}">
                        <div class="weak-area-rank">${index + 1}</div>
                        <div class="weak-area-info">
                            <div class="weak-area-name">${area.name}</div>
                            <div class="weak-area-meta">${area.struggling} students struggling</div>
                        </div>
                        <div class="weak-area-score ${severity}">${area.avg}%</div>
                    </li>
                `;
            });
            html += '</ul>';

            container.innerHTML = html;
        }

        // Load time ranking
        async function loadTimeRanking() {
            const container = document.getElementById('timeRankingContainer');

            if (studentData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No data</p></div>';
                return;
            }

            // Sort by total time
            const sorted = [...studentData].sort((a, b) => b.totalTime - a.totalTime);
            const avgTime = studentData.reduce((sum, s) => sum + s.totalTime, 0) / studentData.length;

            let html = '<ul class="time-list">';
            sorted.slice(0, 10).forEach((student, index) => {
                const hours = Math.floor(student.totalTime / 3600);
                const minutes = Math.floor((student.totalTime % 3600) / 60);
                const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                let valueClass = 'low';
                if (student.totalTime > avgTime * 1.5) valueClass = 'high';
                else if (student.totalTime > avgTime) valueClass = 'medium';

                html += `
                    <li class="time-item">
                        <span class="time-rank">${index + 1}</span>
                        <span class="time-student">${student.name}</span>
                        <span class="time-value ${valueClass}">${timeStr}</span>
                    </li>
                `;
            });
            html += '</ul>';

            container.innerHTML = html;
        }

        // Load prep completion
        async function loadPrepCompletion() {
            const container = document.getElementById('prepCompletionContainer');

            // Get total tasks
            const { data: tasks } = await supabase
                .from('tasks')
                .select('id')
                .eq('class_id', currentClass.id);

            const totalTasks = (tasks || []).length;
            const totalStudents = classStudents.length;
            const expectedCompletions = totalTasks * totalStudents;

            if (expectedCompletions === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No prep tasks assigned</p></div>';
                return;
            }

            const totalOutstanding = studentData.reduce((sum, s) => sum + s.outstandingPrep, 0);
            const completedCount = expectedCompletions - totalOutstanding;
            const completionPercent = Math.round((completedCount / expectedCompletions) * 100);

            // SVG circle
            const circumference = 2 * Math.PI * 80;
            const offset = circumference - (completionPercent / 100) * circumference;

            let html = `
                <div class="prep-completion">
                    <div class="completion-ring">
                        <svg width="200" height="200">
                            <circle class="bg-circle" cx="100" cy="100" r="80"></circle>
                            <circle class="progress-circle" cx="100" cy="100" r="80"
                                style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};">
                            </circle>
                        </svg>
                        <div class="completion-percentage">${completionPercent}%</div>
                    </div>
                    <div class="completion-label">${completedCount} of ${expectedCompletions} tasks completed</div>
                    <div class="task-breakdown">
                        <div class="task-breakdown-item">
                            <span>Total tasks assigned</span>
                            <strong>${totalTasks}</strong>
                        </div>
                        <div class="task-breakdown-item">
                            <span>Total students</span>
                            <strong>${totalStudents}</strong>
                        </div>
                        <div class="task-breakdown-item">
                            <span>Expected completions</span>
                            <strong>${expectedCompletions}</strong>
                        </div>
                        <div class="task-breakdown-item">
                            <span>Outstanding</span>
                            <strong style="color: ${totalOutstanding > 0 ? '#C62828' : '#2E7D32'};">${totalOutstanding}</strong>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Update date range
        function updateDateRange() {
            dateRangeDays = parseInt(document.getElementById('dateRange').value);
            loadHeatmap();
            loadTimeRanking();
        }

        // Export data
        function exportData() {
            // Create CSV
            const config = classTypeConfig[currentClass.type];
            const columns = config.columns;

            let csv = 'Student Name,';
            if (columns.includes('lastActivity')) csv += 'Last Activity,';
            if (columns.includes('totalTime')) csv += 'Time Spent (seconds),';
            if (columns.includes('progress')) csv += 'Overall Progress %,';
            if (columns.includes('vocab')) csv += 'Vocabulary %,';
            if (columns.includes('setText')) csv += 'Set Text %,';
            if (columns.includes('reading')) csv += 'Reading Lessons,';
            if (columns.includes('contentTest')) csv += 'Content Test %,';
            if (columns.includes('prep')) csv += 'Outstanding Prep';
            csv += '\n';

            for (const student of studentData) {
                csv += `"${student.name}",`;
                if (columns.includes('lastActivity')) csv += `"${student.lastActivity || 'N/A'}",`;
                if (columns.includes('totalTime')) csv += `${student.totalTime},`;
                if (columns.includes('progress')) csv += `${student.overallProgress},`;
                if (columns.includes('vocab')) csv += `${student.vocabProgress},`;
                if (columns.includes('setText')) csv += `${student.setTextAvg},`;
                if (columns.includes('reading')) csv += `${student.readingProgress},`;
                if (columns.includes('contentTest')) csv += `${student.contentTestAvg},`;
                if (columns.includes('prep')) csv += `${student.outstandingPrep}`;
                csv += '\n';
            }

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClass.name}_Progress_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Time ago helper
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return Math.floor(seconds / 604800) + 'w ago';
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
