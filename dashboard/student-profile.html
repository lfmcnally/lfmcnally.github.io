<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #FFFFFF;
            min-height: 100vh;
            color: #000000;
            line-height: 1.5;
        }

        /* Professional Header */
        .header {
            background: #000000;
            color: #FFFFFF;
            padding: 1.5rem 2rem;
            border-bottom: 3px solid #000000;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .header-meta {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
            border: 2px solid;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        .btn-primary {
            background: #000000;
            color: #FFFFFF;
            border-color: #FFFFFF;
        }
        .btn-primary:hover {
            background: #2E7D32;
            border-color: #2E7D32;
        }
        .btn-secondary {
            background: #FFFFFF;
            color: #000000;
            border-color: #FFFFFF;
        }
        .btn-secondary:hover {
            background: #F5F5F5;
        }
        .btn-ghost {
            background: transparent;
            color: #FFFFFF;
            border-color: #FFFFFF;
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.1);
        }
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1px;
            background: #E0E0E0;
            border: 1px solid #E0E0E0;
            margin-bottom: 2rem;
        }
        .stat-item {
            background: #FFFFFF;
            padding: 1.25rem;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #000000;
            font-variant-numeric: tabular-nums;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #757575;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        /* Subject Tabs */
        .subject-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #000000;
            margin-bottom: 2rem;
        }
        .subject-tab {
            padding: 0.875rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #757575;
            border-bottom: 3px solid transparent;
            transition: all 0.15s;
        }
        .subject-tab:hover {
            background: #F5F5F5;
            color: #000000;
        }
        .subject-tab.active {
            color: #000000;
            border-bottom-color: #000000;
            background: #F5F5F5;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #000000;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #000000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .grid-full {
            grid-column: 1 / -1;
        }

        /* Card */
        .card {
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
            padding: 1.5rem;
        }
        .card-header {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E0E0E0;
        }

        /* Progress List */
        .progress-list {
            list-style: none;
        }
        .progress-item {
            padding: 0.875rem;
            border: 1px solid #E0E0E0;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-item-info {
            flex: 1;
        }
        .progress-item-name {
            font-weight: 600;
            color: #000000;
            margin-bottom: 0.25rem;
        }
        .progress-item-meta {
            font-size: 0.75rem;
            color: #757575;
        }
        .progress-item-score {
            font-size: 1.25rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-left: 1rem;
        }
        .progress-item-score.excellent {
            color: #2E7D32;
        }
        .progress-item-score.good {
            color: #000000;
        }
        .progress-item-score.warning {
            color: #F57C00;
        }
        .progress-item-score.critical {
            color: #C62828;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #E0E0E0;
            border: 1px solid #BDBDBD;
            margin: 0.5rem 0;
        }
        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #FFFFFF;
        }
        .progress-bar-fill.excellent {
            background: #2E7D32;
        }
        .progress-bar-fill.good {
            background: #000000;
        }
        .progress-bar-fill.warning {
            background: #F57C00;
        }
        .progress-bar-fill.critical {
            background: #C62828;
        }

        /* Activity Timeline */
        .activity-timeline {
            list-style: none;
        }
        .activity-item {
            padding: 0.75rem;
            border-left: 3px solid #E0E0E0;
            margin-bottom: 0.5rem;
            background: #FAFAFA;
        }
        .activity-item.recent {
            border-left-color: #2E7D32;
        }
        .activity-date {
            font-size: 0.75rem;
            color: #757575;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .activity-desc {
            font-size: 0.875rem;
            color: #000000;
        }
        .activity-score {
            font-size: 0.875rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        /* Weak Areas */
        .weak-areas-list {
            list-style: none;
        }
        .weak-area-item {
            padding: 0.75rem;
            border: 1px solid #E0E0E0;
            margin-bottom: 0.5rem;
            border-left: 4px solid #C62828;
        }
        .weak-area-name {
            font-weight: 600;
            color: #C62828;
            margin-bottom: 0.25rem;
        }
        .weak-area-meta {
            font-size: 0.75rem;
            color: #757575;
        }

        /* Teacher Notes */
        .notes-textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 2px solid #E0E0E0;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }
        .notes-textarea:focus {
            outline: none;
            border-color: #000000;
        }
        .notes-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #757575;
        }
        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #757575;
        }

        /* Print Styles */
        @media print {
            body {
                background: #FFFFFF;
            }
            .header {
                background: #FFFFFF;
                color: #000000;
                border-bottom: 2px solid #000000;
            }
            .btn, .notes-textarea {
                display: none;
            }
            .container {
                padding: 0;
            }
            .card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .header {
                padding: 1rem;
            }
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            .subject-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1 id="studentName">Loading...</h1>
                <div class="header-meta">
                    <span id="studentEmail">‚Äî</span> | <span id="className">‚Äî</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="exportToPDF()">üìÑ Export PDF</button>
                <a href="#" class="btn btn-ghost btn-sm" id="backLink">‚Üê Back to Class</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="statOverallProgress">0%</div>
                <div class="stat-label">Overall Progress</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statTimeSpent">0h</div>
                <div class="stat-label">Time Spent (7d)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statLastActive">‚Äî</div>
                <div class="stat-label">Last Active</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statOutstanding">0</div>
                <div class="stat-label">Outstanding Tasks</div>
            </div>
        </div>

        <!-- Subject Tabs (if multi-enrolled) -->
        <div id="subjectTabsContainer"></div>

        <!-- Content for selected subject -->
        <div id="subjectContent">
            <div class="loading">Loading student data...</div>
        </div>

        <!-- Teacher Notes (always visible) -->
        <div class="section-header" style="margin-top: 3rem;">
            <span class="section-title">Teacher Notes</span>
        </div>
        <div class="card">
            <textarea class="notes-textarea" id="teacherNotes" placeholder="Add notes about this student..."></textarea>
            <div class="notes-actions">
                <button class="btn btn-secondary btn-sm" onclick="saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    <script src="../shared/analytics-engine.js"></script>
    <script>
        let currentUser = null;
        let currentStudent = null;
        let currentClass = null;
        let studentEnrollments = [];
        let selectedSubject = null;
        let analyticsEngine = null;

        // Initialize
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Get user profile
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'teacher') {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = profile;
            analyticsEngine = new AnalyticsEngine(supabase);

            // Get student_id and class_id from URL
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('student_id');
            const classId = urlParams.get('class_id');

            if (!studentId || !classId) {
                alert('Missing student or class ID');
                window.history.back();
                return;
            }

            // Set back link
            document.getElementById('backLink').href = `class.html?id=${classId}`;

            // Load data
            await loadStudent(studentId);
            await loadClass(classId);
            await loadStudentEnrollments(studentId);
            await loadTeacherNotes(studentId, classId);

            // If student has multiple enrollments, show tabs
            if (studentEnrollments.length > 1) {
                renderSubjectTabs();
                selectedSubject = currentClass.id; // Default to current class
            } else {
                selectedSubject = currentClass.id;
            }

            await loadSubjectContent();
        }

        // Load student details
        async function loadStudent(studentId) {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', studentId)
                .single();

            if (error || !data) {
                alert('Error loading student');
                window.history.back();
                return;
            }

            currentStudent = data;
            document.getElementById('studentName').textContent = data.full_name || 'Student';
            document.getElementById('studentEmail').textContent = data.email || '‚Äî';
        }

        // Load class details
        async function loadClass(classId) {
            const { data, error } = await supabase
                .from('classes')
                .select('*')
                .eq('id', classId)
                .single();

            if (error || !data) {
                alert('Error loading class');
                return;
            }

            currentClass = data;
            document.getElementById('className').textContent = data.name;
        }

        // Load all student enrollments
        async function loadStudentEnrollments(studentId) {
            const { data: memberships } = await supabase
                .from('class_members')
                .select(`
                    class_id,
                    classes (
                        id,
                        name,
                        type
                    )
                `)
                .eq('student_id', studentId);

            studentEnrollments = (memberships || [])
                .map(m => m.classes)
                .filter(c => c !== null);
        }

        // Render subject tabs
        function renderSubjectTabs() {
            const container = document.getElementById('subjectTabsContainer');

            const typeNames = {
                latin: 'Latin GCSE',
                greek: 'Greek GCSE',
                classics: 'Classical Civ',
                'prep-latin': 'Prep Latin'
            };

            let html = '<div class="subject-tabs">';
            for (const enrollment of studentEnrollments) {
                const isActive = enrollment.id === selectedSubject;
                html += `
                    <button class="subject-tab ${isActive ? 'active' : ''}"
                            onclick="switchSubject('${enrollment.id}')">
                        ${typeNames[enrollment.type] || enrollment.name}
                    </button>
                `;
            }
            html += '</div>';

            container.innerHTML = html;
        }

        // Switch subject
        async function switchSubject(classId) {
            selectedSubject = classId;

            // Update currentClass
            const enrollment = studentEnrollments.find(e => e.id === classId);
            if (enrollment) {
                await loadClass(classId);
                renderSubjectTabs();
                await loadSubjectContent();
            }
        }

        // Load subject-specific content
        async function loadSubjectContent() {
            const container = document.getElementById('subjectContent');
            container.innerHTML = '<div class="loading">Loading data...</div>';

            // Get analytics for this subject
            const analysis = await analyticsEngine.analyzeStudentPerformance(
                currentStudent.id,
                currentClass.id,
                currentClass.type
            );

            // Update stats
            updateStats(analysis);

            // Render subject-specific content
            let html = '';

            if (currentClass.type === 'latin') {
                html = renderLatinContent(analysis);
            } else if (currentClass.type === 'greek') {
                html = renderGreekContent(analysis);
            } else if (currentClass.type === 'classics') {
                html = renderClassicsContent(analysis);
            } else if (currentClass.type === 'prep-latin') {
                html = renderPrepLatinContent(analysis);
            }

            container.innerHTML = html;
        }

        // Update stats bar
        function updateStats(analysis) {
            // Overall progress
            let progressFactors = [];
            if (analysis.byCategory.vocabulary && analysis.byCategory.vocabulary.accuracy > 0) {
                progressFactors.push(analysis.byCategory.vocabulary.accuracy * 100);
            }
            if (analysis.byCategory.setTexts && analysis.byCategory.setTexts.averageScore > 0) {
                progressFactors.push(analysis.byCategory.setTexts.averageScore);
            }
            if (analysis.byCategory.reading && analysis.byCategory.reading.totalTime > 0) {
                progressFactors.push(Math.min((analysis.byCategory.reading.totalTime / 3600) * 20, 100));
            }
            if (analysis.byCategory.contentTests && analysis.byCategory.contentTests.averageScore > 0) {
                progressFactors.push(analysis.byCategory.contentTests.averageScore);
            }

            const overallProgress = progressFactors.length > 0
                ? Math.round(progressFactors.reduce((sum, p) => sum + p, 0) / progressFactors.length)
                : 0;
            document.getElementById('statOverallProgress').textContent = overallProgress + '%';

            // Time spent
            const hours = Math.round(analysis.activitySummary.totalTime / 3600);
            document.getElementById('statTimeSpent').textContent = hours + 'h';

            // Last active
            const lastActive = analysis.activitySummary.lastActive
                ? getTimeAgo(new Date(analysis.activitySummary.lastActive))
                : 'No activity';
            document.getElementById('statLastActive').textContent = lastActive;

            // Outstanding tasks
            const outstanding = analysis.byCategory.prepTasks
                ? analysis.byCategory.prepTasks.overdue + analysis.byCategory.prepTasks.pending
                : 0;
            document.getElementById('statOutstanding').textContent = outstanding;
        }

        // Render Latin content
        function renderLatinContent(analysis) {
            const vocab = analysis.byCategory.vocabulary || {};
            const setTexts = analysis.byCategory.setTexts || {};
            const contentTests = analysis.byCategory.contentTests || {};
            const prepTasks = analysis.byCategory.prepTasks || {};

            return `
                <div class="grid">
                    <!-- Vocabulary Progress -->
                    <div class="card">
                        <div class="card-header">Vocabulary Mastery</div>
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">Overall: ${Math.round((vocab.accuracy || 0) * 100)}%</span>
                                <span style="color: #757575;">${vocab.mastered || 0} / ${vocab.totalWords || 0} mastered</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill ${getProgressClass((vocab.accuracy || 0) * 100)}"
                                     style="width: ${Math.round((vocab.accuracy || 0) * 100)}%">
                                    ${Math.round((vocab.accuracy || 0) * 100)}%
                                </div>
                            </div>
                        </div>
                        ${vocab.struggling > 0 ? `
                            <div style="background: #FFF3E0; padding: 0.75rem; border-left: 4px solid #F57C00; margin-top: 1rem;">
                                <div style="font-weight: 600; color: #F57C00;">‚ö† ${vocab.struggling} words need practice</div>
                                ${vocab.weakWords && vocab.weakWords.length > 0 ? `
                                    <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                                        Struggling with: ${vocab.weakWords.slice(0, 5).map(w => w.latin).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : '<div style="background: #E8F5E9; padding: 0.75rem; color: #2E7D32; font-weight: 600;">‚úì Vocabulary on track</div>'}
                    </div>

                    <!-- Set Text Progress -->
                    <div class="card">
                        <div class="card-header">Set Text Performance</div>
                        ${setTexts.texts && setTexts.texts.length > 0 ? `
                            <ul class="progress-list">
                                ${setTexts.texts.map(text => `
                                    <li class="progress-item">
                                        <div class="progress-item-info">
                                            <div class="progress-item-name">${formatTextName(text.textId)}</div>
                                            <div class="progress-item-meta">${text.sectionsAttempted} sections attempted</div>
                                        </div>
                                        <div class="progress-item-score ${getProgressClass(text.averageScore)}">
                                            ${Math.round(text.averageScore)}%
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                            ${setTexts.weakSections.length > 0 ? `
                                <div style="margin-top: 1rem; background: #FFEBEE; padding: 0.75rem; border-left: 4px solid #C62828;">
                                    <div style="font-weight: 600; color: #C62828;">Weak sections: ${setTexts.weakSections.length}</div>
                                </div>
                            ` : ''}
                        ` : '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No set text attempts yet</p></div>'}
                    </div>

                    <!-- Content Tests -->
                    <div class="card">
                        <div class="card-header">Content Test Performance</div>
                        ${contentTests.testsAttempted > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">Average: ${Math.round(contentTests.averageScore)}%</span>
                                    <span style="color: #757575;">${contentTests.testsAttempted} tests</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${getProgressClass(contentTests.averageScore)}"
                                         style="width: ${Math.round(contentTests.averageScore)}%">
                                        ${Math.round(contentTests.averageScore)}%
                                    </div>
                                </div>
                            </div>
                        ` : '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No content tests attempted</p></div>'}
                    </div>

                    <!-- Prep Tasks -->
                    <div class="card">
                        <div class="card-header">Prep Task Status</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #E8F5E9; border: 1px solid #2E7D32;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: #2E7D32;">${prepTasks.completed || 0}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Completed</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: ${prepTasks.overdue > 0 ? '#FFEBEE' : '#FFF3E0'}; border: 1px solid ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">${(prepTasks.pending || 0) + (prepTasks.overdue || 0)}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Outstanding</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                ${analysis.recommendations.length > 0 ? `
                    <div class="section-header">
                        <span class="section-title">Recommendations</span>
                    </div>
                    <div class="card">
                        <ul class="weak-areas-list">
                            ${analysis.recommendations.slice(0, 5).map(rec => `
                                <li class="weak-area-item">
                                    <div class="weak-area-name">${rec.title}</div>
                                    <div class="weak-area-meta">${rec.description}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        // Render Greek content
        function renderGreekContent(analysis) {
            const vocab = analysis.byCategory.vocabulary || {};
            const contentTests = analysis.byCategory.contentTests || {};
            const prepTasks = analysis.byCategory.prepTasks || {};

            return `
                <div class="grid">
                    <!-- Vocabulary Progress -->
                    <div class="card">
                        <div class="card-header">Vocabulary Mastery</div>
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">Overall: ${Math.round((vocab.accuracy || 0) * 100)}%</span>
                                <span style="color: #757575;">${vocab.mastered || 0} / ${vocab.totalWords || 0} mastered</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill ${getProgressClass((vocab.accuracy || 0) * 100)}"
                                     style="width: ${Math.round((vocab.accuracy || 0) * 100)}%">
                                    ${Math.round((vocab.accuracy || 0) * 100)}%
                                </div>
                            </div>
                        </div>
                        ${vocab.struggling > 0 ? `
                            <div style="background: #FFF3E0; padding: 0.75rem; border-left: 4px solid #F57C00;">
                                <div style="font-weight: 600; color: #F57C00;">‚ö† ${vocab.struggling} words need practice</div>
                            </div>
                        ` : '<div style="background: #E8F5E9; padding: 0.75rem; color: #2E7D32; font-weight: 600;">‚úì Vocabulary on track</div>'}
                    </div>

                    <!-- Content Tests -->
                    <div class="card">
                        <div class="card-header">Content Test Performance</div>
                        ${contentTests.testsAttempted > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">Average: ${Math.round(contentTests.averageScore)}%</span>
                                    <span style="color: #757575;">${contentTests.testsAttempted} tests</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${getProgressClass(contentTests.averageScore)}"
                                         style="width: ${Math.round(contentTests.averageScore)}%">
                                        ${Math.round(contentTests.averageScore)}%
                                    </div>
                                </div>
                            </div>
                        ` : '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No content tests attempted</p></div>'}
                    </div>

                    <!-- Prep Tasks -->
                    <div class="card grid-full">
                        <div class="card-header">Prep Task Status</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #E8F5E9; border: 1px solid #2E7D32;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: #2E7D32;">${prepTasks.completed || 0}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Completed</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: ${prepTasks.overdue > 0 ? '#FFEBEE' : '#FFF3E0'}; border: 1px solid ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">${(prepTasks.pending || 0) + (prepTasks.overdue || 0)}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Outstanding</div>
                            </div>
                        </div>
                    </div>
                </div>

                ${analysis.recommendations.length > 0 ? `
                    <div class="section-header">
                        <span class="section-title">Recommendations</span>
                    </div>
                    <div class="card">
                        <ul class="weak-areas-list">
                            ${analysis.recommendations.slice(0, 5).map(rec => `
                                <li class="weak-area-item">
                                    <div class="weak-area-name">${rec.title}</div>
                                    <div class="weak-area-meta">${rec.description}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        // Render Classics content
        function renderClassicsContent(analysis) {
            const reading = analysis.byCategory.reading || {};
            const contentTests = analysis.byCategory.contentTests || {};
            const prepTasks = analysis.byCategory.prepTasks || {};

            return `
                <div class="grid">
                    <!-- Reading Progress -->
                    <div class="card">
                        <div class="card-header">Reading Completion</div>
                        ${reading.coursesStarted && reading.coursesStarted.length > 0 ? `
                            <ul class="progress-list">
                                ${reading.coursesStarted.map(course => `
                                    <li class="progress-item">
                                        <div class="progress-item-info">
                                            <div class="progress-item-name">${formatCourseName(course.name)}</div>
                                            <div class="progress-item-meta">${course.lessonsCompleted} lessons ‚Ä¢ ${Math.round(course.time / 60)} min</div>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #F5F5F5;">
                                <div style="font-weight: 600;">Total: ${Math.round(reading.totalTime / 60)} minutes reading</div>
                            </div>
                        ` : '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No reading sessions yet</p></div>'}
                    </div>

                    <!-- Content Tests -->
                    <div class="card">
                        <div class="card-header">Content Test Performance</div>
                        ${contentTests.testsAttempted > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">Average: ${Math.round(contentTests.averageScore)}%</span>
                                    <span style="color: #757575;">${contentTests.testsAttempted} tests</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${getProgressClass(contentTests.averageScore)}"
                                         style="width: ${Math.round(contentTests.averageScore)}%">
                                        ${Math.round(contentTests.averageScore)}%
                                    </div>
                                </div>
                            </div>
                        ` : '<div class="empty-state"><div class="empty-state-icon">‚Äî</div><p>No content tests attempted</p></div>'}
                    </div>

                    <!-- Prep Tasks -->
                    <div class="card grid-full">
                        <div class="card-header">Prep Task Status</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #E8F5E9; border: 1px solid #2E7D32;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: #2E7D32;">${prepTasks.completed || 0}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Completed</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: ${prepTasks.overdue > 0 ? '#FFEBEE' : '#FFF3E0'}; border: 1px solid ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">${(prepTasks.pending || 0) + (prepTasks.overdue || 0)}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Outstanding</div>
                            </div>
                        </div>
                    </div>
                </div>

                ${analysis.recommendations.length > 0 ? `
                    <div class="section-header">
                        <span class="section-title">Recommendations</span>
                    </div>
                    <div class="card">
                        <ul class="weak-areas-list">
                            ${analysis.recommendations.slice(0, 5).map(rec => `
                                <li class="weak-area-item">
                                    <div class="weak-area-name">${rec.title}</div>
                                    <div class="weak-area-meta">${rec.description}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        // Render Prep Latin content
        function renderPrepLatinContent(analysis) {
            const vocab = analysis.byCategory.vocabulary || {};
            const prepTasks = analysis.byCategory.prepTasks || {};

            return `
                <div class="grid">
                    <!-- Vocabulary Progress -->
                    <div class="card">
                        <div class="card-header">Vocabulary Mastery</div>
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">Overall: ${Math.round((vocab.accuracy || 0) * 100)}%</span>
                                <span style="color: #757575;">${vocab.mastered || 0} / ${vocab.totalWords || 0} mastered</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill ${getProgressClass((vocab.accuracy || 0) * 100)}"
                                     style="width: ${Math.round((vocab.accuracy || 0) * 100)}%">
                                    ${Math.round((vocab.accuracy || 0) * 100)}%
                                </div>
                            </div>
                        </div>
                        ${vocab.struggling > 0 ? `
                            <div style="background: #FFF3E0; padding: 0.75rem; border-left: 4px solid #F57C00;">
                                <div style="font-weight: 600; color: #F57C00;">‚ö† ${vocab.struggling} words need practice</div>
                            </div>
                        ` : '<div style="background: #E8F5E9; padding: 0.75rem; color: #2E7D32; font-weight: 600;">‚úì Vocabulary on track</div>'}
                    </div>

                    <!-- Prep Tasks -->
                    <div class="card">
                        <div class="card-header">Prep Task Status</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #E8F5E9; border: 1px solid #2E7D32;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: #2E7D32;">${prepTasks.completed || 0}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Completed</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: ${prepTasks.overdue > 0 ? '#FFEBEE' : '#FFF3E0'}; border: 1px solid ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${prepTasks.overdue > 0 ? '#C62828' : '#F57C00'};">${(prepTasks.pending || 0) + (prepTasks.overdue || 0)}</div>
                                <div style="font-size: 0.75rem; color: #757575; text-transform: uppercase; margin-top: 0.25rem;">Outstanding</div>
                            </div>
                        </div>
                    </div>
                </div>

                ${analysis.recommendations.length > 0 ? `
                    <div class="section-header">
                        <span class="section-title">Recommendations</span>
                    </div>
                    <div class="card">
                        <ul class="weak-areas-list">
                            ${analysis.recommendations.slice(0, 5).map(rec => `
                                <li class="weak-area-item">
                                    <div class="weak-area-name">${rec.title}</div>
                                    <div class="weak-area-meta">${rec.description}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        // Load teacher notes
        async function loadTeacherNotes(studentId, classId) {
            const { data } = await supabase
                .from('teacher_notes')
                .select('notes')
                .eq('student_id', studentId)
                .eq('class_id', classId)
                .single();

            if (data && data.notes) {
                document.getElementById('teacherNotes').value = data.notes;
            }
        }

        // Save teacher notes
        async function saveNotes() {
            const notes = document.getElementById('teacherNotes').value;

            const { error } = await supabase
                .from('teacher_notes')
                .upsert({
                    student_id: currentStudent.id,
                    class_id: currentClass.id,
                    teacher_id: currentUser.id,
                    notes: notes,
                    updated_at: new Date().toISOString()
                });

            if (error) {
                alert('Error saving notes: ' + error.message);
            } else {
                alert('Notes saved successfully');
            }
        }

        // Export to PDF
        function exportToPDF() {
            window.print();
        }

        // Helper functions
        function getProgressClass(score) {
            if (score >= 85) return 'excellent';
            if (score >= 70) return 'good';
            if (score >= 50) return 'warning';
            return 'critical';
        }

        function formatTextName(textId) {
            const names = {
                'messalina': 'Messalina',
                'otium': 'Otium',
                'baucis-philemon': 'Baucis & Philemon'
            };
            return names[textId] || textId;
        }

        function formatCourseName(courseName) {
            const names = {
                'iliad': 'The Iliad',
                'aeneid': 'The Aeneid',
                'odyssey': 'The Odyssey',
                'greek-art': 'Greek Art'
            };
            return names[courseName] || courseName;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return Math.floor(seconds / 604800) + 'w ago';
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
