<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Planner â€” Classicalia</title>
<link rel="icon" type="image/png" href="../images/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px}
body{background:#f3f0ea;color:#2c2820;font-family:'Nunito',sans-serif;min-height:100vh;line-height:1.6}
:root{
  --cream:#f3f0ea;--warm:#ede9e1;--parch:#e3ddd3;--white:#fff;
  --border:#d5cfc4;--bsoft:#ddd8ce;
  --text:#2c2820;--mid:#6b6258;--soft:#9c9288;--dim:#bcb4aa;
  --sh-xs:0 1px 2px rgba(44,40,32,.05);
  --sh-sm:0 1px 4px rgba(44,40,32,.08);
  --sh-md:0 4px 20px rgba(44,40,32,.10),0 2px 6px rgba(44,40,32,.06);
  --sh-lg:0 24px 64px rgba(44,40,32,.15),0 6px 22px rgba(44,40,32,.08);
  --ev:#b07800;--ev-bg:#fff8e6;--ev-br:#f0d880;
  --du:#1a6a78;--du-bg:#e6f5f8;--du-br:#80ccd8;
}
/* HEADER */
.hdr{background:var(--white);border-bottom:1px solid var(--border);padding:0 1.4rem;display:flex;align-items:center;gap:.9rem;height:50px;box-shadow:var(--sh-sm);position:sticky;top:0;z-index:60;flex-wrap:nowrap}
.hdr-title{font-family:'Lora',serif;font-size:1rem;font-weight:600;white-space:nowrap}
.hdr-school{font-size:.67rem;color:var(--soft);white-space:nowrap}
.hdr-div{width:1px;height:16px;background:var(--border);flex-shrink:0}
.wk-chip{font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.15rem .55rem;border-radius:20px;background:var(--text);color:#fff;flex-shrink:0}
.hdr-clock{margin-left:auto;display:flex;align-items:center;gap:.65rem;flex-shrink:0}
.clock-time{font-family:'Lora',serif;font-size:.95rem;font-weight:500;min-width:40px}
.clock-lesson{font-size:.66rem;color:var(--soft);max-width:170px;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.clock-lesson strong{color:var(--text);font-weight:700}
.clock-lesson.now strong{color:#1a6a20}
.clock-lesson.soon strong{color:#8a6000}
.hdr-btn{height:27px;border-radius:6px;border:1px solid var(--border);background:var(--white);color:var(--mid);cursor:pointer;display:flex;align-items:center;gap:.25rem;padding:0 .65rem;font-family:'Nunito',sans-serif;font-size:.67rem;font-weight:600;transition:all .13s;white-space:nowrap;flex-shrink:0}
.hdr-btn:hover{border-color:var(--mid);color:var(--text)}
.hdr-btn.ev{border-color:var(--ev-br);color:var(--ev);background:var(--ev-bg)}
.hdr-btn.ev:hover{background:#fff3cc}
.hdr-btn.du{border-color:var(--du-br);color:var(--du);background:var(--du-bg)}
.hdr-btn.du:hover{background:#d0edf2}
.settings-btn{width:27px;height:27px;border-radius:6px;border:1px solid var(--border);background:var(--white);color:var(--mid);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.88rem;transition:all .13s;flex-shrink:0}
.settings-btn:hover{border-color:var(--mid);color:var(--text)}
/* NAV */
.nav{background:var(--white);border-bottom:1px solid var(--bsoft);padding:0 1.4rem;display:flex;overflow-x:auto}
.ntab{background:none;border:none;border-bottom:2px solid transparent;padding:.58rem .85rem .52rem;font-family:'Nunito',sans-serif;font-size:.73rem;font-weight:500;color:var(--soft);cursor:pointer;transition:all .14s;margin-bottom:-1px;white-space:nowrap}
.ntab:hover{color:var(--text)}
.ntab.active{color:var(--text);border-bottom-color:var(--text);font-weight:700}
/* MAIN */
main{padding:1.2rem 1.4rem 3rem}
body.timeline-mode{overflow:hidden}
body.timeline-mode main{padding-bottom:1.4rem}
.view{display:none}.view.visible{display:block}
/* WEEK LAYOUT */
.week-layout{display:grid;grid-template-columns:1fr 272px;gap:1.1rem;align-items:start}
.wk-ctrl{display:flex;align-items:center;gap:.58rem;margin-bottom:.9rem}
.wk-range{font-family:'Lora',serif;font-size:.92rem;font-weight:500}
.wk-btn{width:24px;height:24px;border-radius:5px;border:1px solid var(--border);background:var(--white);color:var(--mid);font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.wk-btn:hover{border-color:var(--mid);color:var(--text)}
.today-pill{font-size:.61rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;padding:.15rem .55rem;border-radius:20px;background:var(--text);color:#fff;cursor:pointer;border:none}
.today-pill:hover{opacity:.72}
/* TIMETABLE */
.tt{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem}
.day-col{display:flex;flex-direction:column;gap:.24rem}
.day-hd{padding:.38rem .5rem;background:var(--white);border:1px solid var(--bsoft);border-radius:6px;box-shadow:var(--sh-xs);margin-bottom:.03rem}
.day-hd.today-hd{background:var(--text);border-color:var(--text)}
.dn{font-size:.56rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--soft);line-height:1}
.dd{font-family:'Lora',serif;font-size:.86rem;font-weight:500;margin-top:.06rem}
.today-hd .dn{color:rgba(255,255,255,.4)}.today-hd .dd{color:#fff}
.empty-day{font-size:.61rem;color:var(--dim);font-style:italic;padding:.42rem .4rem}
/* LESSON CARD */
.lcard{border-radius:6px;padding:.44rem .54rem .44rem .66rem;cursor:pointer;border:1px solid transparent;border-left-width:3px;position:relative;overflow:hidden;transition:transform .15s cubic-bezier(.22,1,.36,1),box-shadow .15s}
.lcard:hover:not(.no-click):not(.cancelled){transform:translateY(-1px) scale(1.01);box-shadow:var(--sh-md)}
.no-click{cursor:default}
.cancelled{opacity:.44}
.cancelled:hover{transform:none!important;box-shadow:none!important}
.cstripe{position:absolute;inset:0;background:repeating-linear-gradient(-45deg,transparent,transparent 6px,rgba(0,0,0,.025) 6px,rgba(0,0,0,.025) 12px);pointer-events:none}
.lc-time{font-size:.55rem;color:var(--soft);font-weight:500;margin-bottom:.04rem}
.lc-code{font-family:'Lora',serif;font-size:.86rem;font-weight:600;line-height:1.15}
.lc-subj{font-size:.55rem;color:var(--soft);margin-top:.02rem}
.lc-topic{font-size:.64rem;font-weight:600;color:var(--mid);margin-top:.18rem;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.lc-cancelled{font-size:.55rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--dim);margin-top:.14rem}
.lc-indicators{display:flex;gap:.2rem;margin-top:.16rem;flex-wrap:wrap}
.lc-badge{font-size:.5rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;padding:.06rem .26rem;border-radius:7px;white-space:nowrap}
.badge-prep{background:#fff3cd;color:#7a5a00;border:1px solid #e8d08a}
.badge-warn{background:#fff0f0;color:#8a2020;border:1px solid #e8c0c0}
.badge-det{background:#fdf0f5;color:#8a206a;border:1px solid #e0b8d0}
.badge-praise{background:#f0f8f0;color:#1a6a20;border:1px solid #b0d8b0}
.plan-dot{position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;background:#2eaa2e;border:1px solid #1e8a1e}
.prep-night-dot{position:absolute;top:4px;right:13px;width:6px;height:6px;border-radius:50%;background:#d83030;border:1px solid #b02020}
/* EVENT/DUTY CARD */
.ecard{border-radius:6px;padding:.4rem .54rem .4rem .66rem;border:1px solid transparent;border-left-width:3px;cursor:pointer;transition:transform .14s,box-shadow .14s;position:relative}
.ecard:hover{transform:translateY(-1px);box-shadow:var(--sh-md)}
.ecard.ev-card{background:var(--ev-bg);border-color:var(--ev-br);border-left-color:var(--ev)}
.ecard.du-card{background:var(--du-bg);border-color:var(--du-br);border-left-color:var(--du)}
.ec-time{font-size:.55rem;font-weight:500;margin-bottom:.04rem}
.ecard.ev-card .ec-time{color:#a06800}
.ecard.du-card .ec-time{color:#147080}
.ec-title{font-size:.77rem;font-weight:700;line-height:1.2}
.ecard.ev-card .ec-title{color:var(--ev)}
.ecard.du-card .ec-title{color:var(--du)}
.ec-type{font-size:.54rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;margin-top:.06rem}
.ecard.ev-card .ec-type{color:#c09000}
.ecard.du-card .ec-type{color:#1a8090}
.ec-del{position:absolute;top:3px;right:4px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:.68rem;opacity:0;transition:opacity .14s,color .12s}
.ecard:hover .ec-del{opacity:1}
.ec-del:hover{color:#c03030}
/* DAY NOTE CARD */
.dnote-card{border-radius:6px;padding:.34rem .52rem;border:1px dashed #c0b8d0;border-left:3px solid #7c6aa0;background:#f6f3fa;cursor:pointer;transition:transform .14s,box-shadow .14s;position:relative;margin-bottom:.12rem}
.dnote-card:hover{transform:translateY(-1px);box-shadow:var(--sh-md)}
.dnote-icon{font-size:.62rem;margin-right:.22rem}
.dnote-text{font-size:.66rem;font-weight:600;color:#5a4a78;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.dnote-del{position:absolute;top:2px;right:4px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:.62rem;opacity:0;transition:opacity .14s,color .12s}
.dnote-card:hover .dnote-del{opacity:1}
.dnote-del:hover{color:#c03030}
.day-hd-wrap{display:flex;align-items:center;justify-content:space-between}
.day-add-note{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.72rem;line-height:1;padding:0 .1rem;transition:color .12s;flex-shrink:0}
.day-add-note:hover{color:var(--text)}
/* DAY NOTE MODAL */
.dn-modal{background:var(--white);border-radius:13px;box-shadow:var(--sh-lg);width:100%;max-width:400px;animation:popIn .21s cubic-bezier(.34,1.56,.64,1)}
.dn-top{padding:1rem 1.3rem .78rem;border-bottom:1px solid var(--bsoft);display:flex;align-items:center;justify-content:space-between}
.dn-title-txt{font-family:'Lora',serif;font-size:.95rem;font-weight:600}
.dn-body{padding:.92rem 1.3rem;display:flex;flex-direction:column;gap:.72rem}
.dn-foot{padding:.62rem 1.3rem 1.1rem;border-top:1px solid var(--bsoft);display:flex;gap:.42rem}
/* TODAY PANEL */
.today-panel{background:var(--white);border:1px solid var(--bsoft);border-radius:10px;box-shadow:var(--sh-sm);position:sticky;top:62px;overflow:hidden;max-height:calc(100vh - 74px);display:flex;flex-direction:column}
.tp-hdr{padding:.68rem .95rem .55rem;border-bottom:1px solid var(--bsoft);display:flex;align-items:baseline;justify-content:space-between;flex-shrink:0}
.tp-title{font-family:'Lora',serif;font-size:.88rem;font-weight:600}
.tp-date-lbl{font-size:.63rem;color:var(--soft)}
.tp-scroll{padding:.5rem .75rem .9rem 1rem;position:relative;flex:1;overflow-y:auto;min-height:0}
/* progress track */
.tp-track{position:absolute;left:52px;top:0;bottom:0;width:2px;background:var(--bsoft);border-radius:1px}
.tp-fill{position:absolute;left:0;top:0;width:100%;background:linear-gradient(to bottom,var(--text) 60%,rgba(44,40,32,.2));border-radius:1px;transition:height .5s ease}
.tp-now-marker{position:absolute;left:-4px;width:10px;height:10px;border-radius:50%;background:var(--text);border:2px solid var(--white);box-shadow:0 0 0 2px var(--text);transition:top .5s ease}
/* timeline items */
.tp-item{display:flex;align-items:flex-start;padding:.36rem 0;position:relative;z-index:1;padding-left:68px;min-height:40px}
.tp-item-time{position:absolute;left:0;width:44px;text-align:right;font-size:.65rem;font-weight:600;color:var(--soft);padding-top:.12rem;line-height:1;letter-spacing:.01em}
.tp-dot{position:absolute;left:48px;top:.38rem;width:11px;height:11px;border-radius:50%;border:2px solid var(--white);box-shadow:var(--sh-xs);flex-shrink:0}
.tp-body{flex:1;min-width:0}
.tp-item-title{font-size:.72rem;font-weight:600;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tp-item-sub{font-size:.6rem;color:var(--soft);margin-top:.04rem}
.tp-item-dur{font-size:.56rem;color:var(--dim);margin-top:.03rem}
.tp-gap{padding:.16rem 0 .16rem 68px;font-size:.6rem;color:var(--dim);font-style:italic}
.tp-item.tp-past .tp-item-title{color:var(--dim);font-weight:400}
.tp-item.tp-past .tp-item-sub{color:var(--dim)}
.tp-item.tp-now .tp-body{background:var(--warm);border-radius:5px;padding:.2rem .38rem;margin-left:-.38rem;border-left:2px solid var(--text)}
.tp-item.tp-now .tp-item-title{font-weight:700;color:var(--text)}
.tp-empty{padding:1.4rem .75rem;text-align:center;font-size:.72rem;color:var(--dim);font-style:italic}
/* HEATMAP */
.heatmap{display:flex;flex-direction:column}
.hm-week{display:flex;align-items:stretch;border-bottom:1px solid var(--bsoft)}
.hm-week:first-child{border-top:1px solid var(--bsoft)}
.hm-lbl{font-family:'Lora',serif;font-size:.7rem;font-weight:500;padding:.48rem .7rem;min-width:62px;border-right:1px solid var(--bsoft);display:flex;align-items:center;color:var(--mid);background:var(--warm);white-space:pre-line}
.hm-days{display:flex;flex:1}
.hm-day{flex:1;border-right:1px solid var(--bsoft);display:flex;flex-direction:column;min-width:0}
.hm-day:last-child{border-right:none}
.hm-day-hdr{font-size:.54rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--soft);padding:.26rem .38rem .18rem;border-bottom:1px solid var(--bsoft);background:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hm-day-hdr.today-col{background:var(--text);color:rgba(255,255,255,.5)}
.hm-cells{padding:.2rem .26rem;display:flex;flex-direction:column;gap:.13rem;background:var(--warm)}
.hcell{height:16px;border-radius:3px;border-left:2px solid transparent;display:flex;align-items:center;padding:0 .26rem;font-size:.54rem;font-weight:600;cursor:pointer;transition:opacity .11s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hcell:hover{opacity:.75}
/* CLASSES VIEW */
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:.82rem}
.ccard{background:var(--white);border:1px solid var(--bsoft);border-left:3px solid;border-radius:9px;padding:.92rem 1rem;cursor:pointer;transition:transform .13s,box-shadow .13s;box-shadow:var(--sh-xs)}
.ccard:hover{transform:translateY(-2px);box-shadow:var(--sh-md)}
.cch{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:.62rem}
.cc-code{font-family:'Lora',serif;font-size:1.02rem;font-weight:600}
.ctag{font-size:.55rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;padding:.12rem .44rem;border-radius:20px}
.cstats{display:flex;gap:.82rem;margin-bottom:.5rem}
.csv{font-family:'Lora',serif;font-size:1.15rem;font-weight:500;line-height:1}
.csl{font-size:.55rem;color:var(--dim);margin-top:.04rem}
.cbar{height:3px;background:var(--border);border-radius:2px;margin-bottom:.56rem;overflow:hidden}
.cbarf{height:100%;border-radius:2px;transition:width .4s}
.clast{font-size:.64rem;color:var(--soft);line-height:1.5}
.clast strong{color:var(--mid);font-weight:700;font-size:.57rem;letter-spacing:.05em;text-transform:uppercase;display:block;margin-bottom:.04rem}
/* CLASS DETAIL VIEW */
.cd-back{background:none;border:none;font-family:'Nunito',sans-serif;font-size:.7rem;font-weight:600;color:var(--soft);cursor:pointer;display:flex;align-items:center;gap:.3rem;margin-bottom:.7rem;padding:0}
.cd-back:hover{color:var(--text)}
.cd-header{display:flex;align-items:center;gap:.7rem;margin-bottom:.9rem}
.cd-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.cd-title{font-family:'Lora',serif;font-size:1.05rem;font-weight:600}
.cd-subj{font-size:.7rem;color:var(--soft);font-weight:400}
.cd-stats{display:flex;gap:1.2rem;margin-bottom:.9rem;padding:.6rem .8rem;background:var(--white);border:1px solid var(--bsoft);border-radius:8px}
.cd-stat-val{font-family:'Lora',serif;font-size:1.1rem;font-weight:500;line-height:1}
.cd-stat-lbl{font-size:.54rem;color:var(--dim);margin-top:.04rem}
.cd-list{display:flex;flex-direction:column;gap:.18rem}
.cd-lesson{display:flex;gap:.7rem;padding:.52rem .7rem;background:var(--white);border:1px solid var(--bsoft);border-left:3px solid;border-radius:6px;cursor:pointer;transition:transform .12s,box-shadow .12s;align-items:center}
.cd-lesson:hover{transform:translateY(-1px);box-shadow:var(--sh-md)}
.cd-lesson.is-today{box-shadow:0 0 0 2px var(--text)}
.cd-lesson.cancelled{opacity:.5}
.cd-lesson.cancelled:hover{transform:none;box-shadow:none}
.cd-ldate{font-size:.6rem;color:var(--soft);min-width:72px;font-weight:500;line-height:1.4}
.cd-ltime{font-size:.56rem;color:var(--dim)}
.cd-ltopic{font-size:.68rem;font-weight:600;color:var(--mid);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cd-lcancel{font-size:.52rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--dim);background:var(--parch);padding:.08rem .35rem;border-radius:3px}
.cd-ldot{width:6px;height:6px;border-radius:50%;background:#2eaa2e;border:1px solid #1e8a1e;flex-shrink:0}
.cd-divider{font-size:.58rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--soft);margin:.7rem 0 .3rem;padding-left:.2rem}
/* SEARCH */
.search-overlay{display:none;position:fixed;inset:0;background:rgba(44,40,32,.42);backdrop-filter:blur(7px);z-index:250;align-items:flex-start;justify-content:center;padding:3rem 1rem 1rem}
.search-overlay.open{display:flex}
.search-box{background:var(--white);border-radius:13px;box-shadow:var(--sh-lg);width:100%;max-width:540px;max-height:80vh;display:flex;flex-direction:column;animation:popIn .21s cubic-bezier(.34,1.56,.64,1)}
.search-input-wrap{display:flex;align-items:center;gap:.5rem;padding:.8rem 1rem;border-bottom:1px solid var(--bsoft)}
.search-icon{font-size:.9rem;color:var(--dim);flex-shrink:0}
.search-input{border:none;outline:none;font-family:'Nunito',sans-serif;font-size:.82rem;flex:1;background:none;color:var(--text)}
.search-input::placeholder{color:var(--dim)}
.search-close{background:none;border:none;font-size:.9rem;color:var(--soft);cursor:pointer;padding:.15rem}
.search-close:hover{color:var(--text)}
.search-results{overflow-y:auto;padding:.4rem;flex:1}
.search-empty{text-align:center;padding:2rem 1rem;font-size:.72rem;color:var(--dim);font-style:italic}
.search-result{display:flex;gap:.65rem;padding:.52rem .6rem;border-radius:6px;cursor:pointer;transition:background .1s;align-items:flex-start}
.search-result:hover{background:var(--warm)}
.sr-color{width:4px;min-height:28px;border-radius:2px;flex-shrink:0;margin-top:.1rem}
.sr-body{flex:1;min-width:0}
.sr-head{display:flex;align-items:center;gap:.4rem;margin-bottom:.1rem}
.sr-code{font-family:'Lora',serif;font-size:.76rem;font-weight:600}
.sr-date{font-size:.56rem;color:var(--soft)}
.sr-topic{font-size:.66rem;font-weight:600;color:var(--text);margin-bottom:.06rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sr-match{font-size:.62rem;color:var(--mid);line-height:1.4;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sr-match mark{background:#fff3a0;color:var(--text);border-radius:2px;padding:0 .06rem}
/* PAST VIEW */
.psec{margin-bottom:1.6rem}
.ptitle{font-family:'Lora',serif;font-size:.86rem;font-weight:600;padding-bottom:.38rem;border-bottom:1px solid var(--bsoft);margin-bottom:.55rem;display:flex;align-items:center;gap:.42rem}
.pdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.pentry{display:flex;gap:.8rem;padding:.5rem 0;border-bottom:1px solid var(--bsoft);align-items:flex-start}
.pdate{font-size:.6rem;color:var(--soft);min-width:70px;font-weight:500;line-height:1.5}
.ptopic-lbl{font-size:.7rem;font-weight:700;color:var(--text);margin-bottom:.08rem}
.ptext{font-size:.7rem;color:var(--mid);line-height:1.5;flex:1}
.pcancel-tag{font-size:.55rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--dim);background:var(--parch);padding:.1rem .4rem;border-radius:3px;white-space:nowrap}
.no-entries{font-size:.68rem;color:var(--dim);font-style:italic;padding:.3rem 0}
/* BEHAVIOUR VIEW */
.beh-filters{display:flex;gap:.3rem;flex-wrap:wrap;margin-bottom:.8rem}
.beh-filter-btn{background:none;border:1px solid var(--border);border-radius:20px;padding:.17rem .6rem;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:500;color:var(--soft);cursor:pointer;transition:all .11s}
.beh-filter-btn:hover,.beh-filter-btn.active{background:var(--text);color:#fff;border-color:var(--text)}
.beh-class-section{margin-bottom:1.6rem}
.beh-class-title{font-family:'Lora',serif;font-size:.86rem;font-weight:600;display:flex;align-items:center;gap:.42rem;padding-bottom:.38rem;border-bottom:1px solid var(--bsoft);margin-bottom:.55rem}
.beh-entries{display:flex;flex-direction:column;gap:.24rem}
.beh-entry{display:flex;align-items:flex-start;gap:.55rem;padding:.44rem .6rem;background:var(--white);border:1px solid var(--bsoft);border-radius:6px;box-shadow:var(--sh-xs)}
.beh-entry-left{min-width:88px}
.beh-sname{font-size:.69rem;font-weight:600}
.beh-date{font-size:.56rem;color:var(--soft)}
.beh-type-badge{font-size:.53rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;padding:.08rem .36rem;border-radius:8px;white-space:nowrap;flex-shrink:0}
.beh-note{font-size:.7rem;color:var(--mid);line-height:1.5;flex:1}
.beh-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.7rem;padding:.03rem .18rem;border-radius:3px;transition:color .1s}
.beh-del:hover{color:#c03030}
.beh-empty{font-size:.68rem;color:var(--dim);font-style:italic;padding:.38rem 0}
.type-verbal   {background:#fff0f0;color:#8a2020;border:1px solid #e8c0c0}
.type-detention{background:#fdf0f5;color:#8a206a;border:1px solid #e0b8d0}
.type-praise   {background:#f0f8f0;color:#1a6a20;border:1px solid #b0d8b0}
.type-note     {background:#f0f4ff;color:#1a3080;border:1px solid #b8c8e8}
/* QUICK NOTES */
.qn-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(258px,1fr));gap:.82rem}
.qn-card{background:var(--white);border:1px solid var(--bsoft);border-left:3px solid;border-radius:9px;overflow:hidden;box-shadow:var(--sh-xs)}
.qn-hdr{padding:.6rem .82rem .5rem;border-bottom:1px solid var(--bsoft);display:flex;align-items:center;gap:.44rem}
.qn-code{font-family:'Lora',serif;font-size:.86rem;font-weight:600}
.qn-subj{font-size:.6rem;color:var(--soft)}
.qn-ta{width:100%;border:none;background:transparent;font-family:'Nunito',sans-serif;font-size:.76rem;color:var(--text);line-height:1.7;padding:.66rem .82rem;resize:none;outline:none;min-height:96px}
.qn-ta::placeholder{color:var(--dim);font-style:italic}
.qn-footer{padding:.28rem .82rem .42rem;border-top:1px solid var(--bsoft);display:flex;align-items:center;justify-content:space-between}
.qn-saved{font-size:.58rem;color:#2e7060;font-weight:600;opacity:0;transition:opacity .3s}
.qn-saved.show{opacity:1}
.qn-save-btn{background:var(--text);color:#fff;border:none;border-radius:5px;padding:.24rem .7rem;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:700;cursor:pointer;transition:background .11s}
.qn-save-btn:hover{background:#3d3830}
/* ALL LESSONS VIEW */
.al-day{margin-bottom:1.1rem}
.al-day-hdr{font-family:'Lora',serif;font-size:.82rem;font-weight:600;color:var(--text);padding:.38rem .3rem .28rem;border-bottom:1px solid var(--bsoft);margin-bottom:.32rem;display:flex;align-items:baseline;gap:.4rem;position:sticky;top:0;background:var(--cream);z-index:2}
.al-day-hdr .al-wk{font-family:'Nunito',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--soft)}
.al-day-hdr.today-al{color:var(--text)}
.al-day-hdr.today-al::after{content:'Today';font-family:'Nunito',sans-serif;font-size:.55rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;background:var(--text);color:#fff;padding:.08rem .4rem;border-radius:10px;margin-left:.3rem}
.al-list{display:flex;flex-direction:column;gap:.18rem}
.al-empty{font-size:.68rem;color:var(--dim);font-style:italic;padding:1.4rem .3rem;text-align:center}
/* LESSON MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(44,40,32,.42);backdrop-filter:blur(7px);z-index:200;align-items:center;justify-content:center;padding:1rem}
.overlay.open{display:flex}
.modal{background:var(--white);border-radius:13px;box-shadow:var(--sh-lg);width:100%;max-width:570px;max-height:92vh;overflow-y:auto;animation:popIn .21s cubic-bezier(.34,1.56,.64,1)}
@keyframes popIn{from{opacity:0;transform:scale(.93) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}
.mtop{padding:1.15rem 1.4rem .88rem;border-bottom:1px solid var(--bsoft);display:flex;align-items:flex-start;justify-content:space-between;gap:.9rem;position:sticky;top:0;background:var(--white);z-index:2;border-radius:13px 13px 0 0}
.m-cname{font-family:'Lora',serif;font-size:1.12rem;font-weight:600;letter-spacing:-.01em}
.m-cmeta{font-size:.67rem;color:var(--soft);margin-top:.12rem}
.m-close{width:26px;height:26px;border-radius:50%;border:1px solid var(--border);background:var(--white);color:var(--soft);font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .11s}
.m-close:hover{background:var(--warm);color:var(--text)}
.modal-tabs{display:flex;padding:.64rem 1.4rem .52rem;gap:.3rem;border-bottom:1px solid var(--bsoft)}
.modal-tab{background:none;border:1px solid var(--border);border-radius:20px;padding:.23rem .78rem;font-family:'Nunito',sans-serif;font-size:.68rem;font-weight:500;color:var(--soft);cursor:pointer;transition:all .13s}
.modal-tab:hover{border-color:var(--mid);color:var(--text)}
.modal-tab.active{background:var(--text);color:#fff;border-color:var(--text);font-weight:700}
.modal-pane{display:none;padding:1.05rem 1.4rem;flex-direction:column;gap:.95rem}
.modal-pane.active{display:flex}
.slabel{font-size:.57rem;font-weight:700;letter-spacing:.11em;text-transform:uppercase;color:var(--soft);margin-bottom:.3rem}
.cnt-banner{display:flex;align-items:center;gap:.78rem;padding:.68rem .88rem;background:var(--warm);border:1px solid var(--bsoft);border-radius:7px}
.cnt-big{font-family:'Lora',serif;font-size:1.8rem;font-weight:500;line-height:1}
.cnt-lbls{flex:1}
.cnt-main{font-size:.71rem;font-weight:500}
.cnt-sub{font-size:.63rem;color:var(--soft);margin-top:.04rem}
.cnt-bar-wrap{width:50px}
.cnt-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.cnt-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.pn-grid{display:grid;grid-template-columns:1fr 1fr;gap:.42rem}
.pn-blk{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;padding:.6rem .74rem}
.pn-lbl{font-size:.54rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--dim);margin-bottom:.1rem}
.pn-date{font-size:.61rem;color:var(--soft);font-weight:500;margin-bottom:.16rem}
.pn-topic{font-size:.68rem;font-weight:600;color:var(--text);margin-bottom:.06rem}
.pn-text{font-size:.68rem;color:var(--mid);line-height:1.45;font-style:italic}
.pn-empty{color:var(--dim);font-style:normal}
.prep-due-banner{background:#fffbf0;border:1px solid #e8d090;border-radius:7px;padding:.62rem .84rem}
.prep-due-title{font-size:.6rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#8a6000;margin-bottom:.16rem}
.prep-due-text{font-size:.74rem;color:#4a3800;line-height:1.45}
.prep-due-sub{font-size:.61rem;color:#8a6000;margin-top:.1rem}
.topic-in{width:100%;background:var(--warm);border:1px solid var(--border);border-radius:7px;padding:.58rem .78rem;font-family:'Lora',serif;font-size:.86rem;font-weight:500;color:var(--text);outline:none;transition:border-color .13s,box-shadow .13s}
.topic-in:focus{border-color:var(--mid);box-shadow:0 0 0 3px rgba(44,40,32,.05)}
.topic-in::placeholder{color:var(--dim);font-style:italic;font-family:'Nunito',sans-serif;font-weight:300}
.plan-ta{width:100%;background:var(--warm);border:1px solid var(--border);border-radius:7px;padding:.58rem .78rem;font-family:'Nunito',sans-serif;font-size:.76rem;color:var(--text);line-height:1.7;resize:vertical;min-height:72px;outline:none;transition:border-color .13s,box-shadow .13s}
.plan-ta:focus{border-color:var(--mid);box-shadow:0 0 0 3px rgba(44,40,32,.05)}
.plan-ta::placeholder{color:var(--dim);font-style:italic}
.res-add-row{display:flex;gap:.4rem;align-items:center;margin-top:.4rem}
.res-input{flex:1;padding:.34rem .5rem!important;font-size:.68rem!important}
.res-add-btn{white-space:nowrap;padding:.34rem .6rem!important;font-size:.62rem!important}
.res-item{display:flex;align-items:center;gap:.5rem;padding:.36rem .5rem;background:#fff;border:1px solid var(--border);border-radius:5px;margin-bottom:.3rem}
.res-item a{flex:1;font-size:.72rem;color:var(--mid);text-decoration:none;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.res-item a:hover{text-decoration:underline}
.res-item .res-domain{font-size:.58rem;color:var(--dim);margin-left:.3rem;font-weight:400}
.res-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.72rem;padding:.1rem .3rem;border-radius:3px;transition:color .1s}
.res-del:hover{color:#c03030}
.cancel-box{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;padding:.68rem .84rem}
.cancel-row{display:flex;align-items:center;justify-content:space-between;gap:.8rem}
.cancel-title{font-size:.73rem;font-weight:600}
.cancel-sub{font-size:.62rem;color:var(--soft);margin-top:.04rem}
.tgl-wrap{flex-shrink:0}
.tgl-in{position:absolute;opacity:0;width:0;height:0}
.tgl-lbl{display:flex;width:37px;height:19px;border-radius:10px;background:var(--border);cursor:pointer;transition:background .17s;position:relative}
.tgl-lbl::after{content:'';position:absolute;left:2px;top:2px;width:15px;height:15px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.18);transition:left .17s}
.tgl-in:checked+.tgl-lbl{background:#b03030}
.tgl-in:checked+.tgl-lbl::after{left:20px}
.cancel-reason-wrap{margin-top:.52rem;display:none}
.cancel-reason-wrap.open{display:block}
.cancel-reason-in{width:100%;background:#fff;border:1px solid var(--border);border-radius:5px;padding:.5rem .72rem;font-family:'Nunito',sans-serif;font-size:.74rem;color:var(--text);outline:none;transition:border-color .12s}
.cancel-reason-in:focus{border-color:var(--mid)}
.cancel-reason-in::placeholder{color:var(--dim);font-style:italic}
/* PREP */
.prep-existing{background:var(--warm);border:1px solid var(--bsoft);border-radius:6px;padding:.55rem .7rem;margin-bottom:.2rem}
.prep-existing-lbl{font-size:.54rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--dim);margin-bottom:.16rem}
.prep-existing-text{font-size:.72rem;color:var(--mid);line-height:1.42}
.prep-existing-due{font-size:.6rem;color:var(--soft);margin-top:.12rem}
.prep-existing-actions{display:flex;gap:.3rem;margin-top:.32rem}
.prep-small-btn{background:none;border:1px solid var(--border);border-radius:4px;padding:.17rem .52rem;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:500;color:var(--mid);cursor:pointer;transition:all .11s}
.prep-small-btn:hover{border-color:var(--mid);color:var(--text)}
.prep-small-btn.danger:hover{border-color:#c03030;color:#c03030}
.prep-set-box{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;padding:.72rem .84rem;display:flex;flex-direction:column;gap:.52rem}
.frow{display:flex;flex-direction:column;gap:.2rem}
.finput,.fselect{width:100%;background:#fff;border:1px solid var(--border);border-radius:5px;padding:.5rem .7rem;font-family:'Nunito',sans-serif;font-size:.74rem;color:var(--text);outline:none;transition:border-color .12s}
.finput:focus,.fselect:focus{border-color:var(--mid)}
.finput::placeholder{color:var(--dim);font-style:italic}
.fselect{cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239c9288' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .68rem center}
.sm-action-btn{background:var(--text);color:#fff;border:none;border-radius:6px;padding:.4rem .9rem;font-family:'Nunito',sans-serif;font-size:.68rem;font-weight:700;cursor:pointer;align-self:flex-start;transition:background .11s}
.sm-action-btn:hover{background:#3d3830}
.prep-collect-wrap{background:#fffbf0;border:1px solid #e8d090;border-radius:6px;padding:.55rem .72rem;margin-top:.38rem}
.prep-collect-lbl{font-size:.57rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#8a6000;margin-bottom:.26rem}
.prep-collect-btns{display:flex;gap:.3rem;flex-wrap:wrap}
.pcbtn{border:1px solid var(--border);border-radius:20px;padding:.18rem .65rem;font-family:'Nunito',sans-serif;font-size:.64rem;font-weight:600;cursor:pointer;background:#fff;transition:all .11s}
.pcbtn.ai{background:#e8f5e8;border-color:#80c080;color:#1a5a20}
.pcbtn.ap{background:#fff8e0;border-color:#d4b040;color:#7a5500}
.pcbtn.am{background:#fdf0f0;border-color:#e0a0a0;color:#8a2020}
/* BEHAVIOUR */
.beh-log-list{display:flex;flex-direction:column;gap:.24rem;max-height:158px;overflow-y:auto}
.beh-log-entry{display:flex;align-items:flex-start;gap:.4rem;padding:.36rem .52rem;background:var(--warm);border:1px solid var(--bsoft);border-radius:5px}
.beh-log-left{min-width:78px}
.beh-log-name{font-weight:600;font-size:.68rem}
.beh-log-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.68rem;padding:.02rem .14rem;border-radius:3px;transition:color .1s;flex-shrink:0}
.beh-log-del:hover{color:#c03030}
.beh-add-form{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;padding:.72rem .84rem;display:flex;flex-direction:column;gap:.5rem}
.beh-type-btns{display:flex;gap:.26rem;flex-wrap:wrap}
.beh-type-btn{background:#fff;border:1px solid var(--border);border-radius:4px;padding:.22rem .55rem;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:600;cursor:pointer;transition:all .1s}
.beh-type-btn:hover{border-color:var(--mid)}
.beh-type-btn.sv{background:#fff0f0;border-color:#e8c0c0;color:#8a2020}
.beh-type-btn.sd{background:#fdf0f5;border-color:#e0b8d0;color:#8a206a}
.beh-type-btn.sp{background:#f0f8f0;border-color:#b0d8b0;color:#1a6a20}
.beh-type-btn.sn{background:#f0f4ff;border-color:#b8c8e8;color:#1a3080}
.no-students-msg{font-size:.68rem;color:var(--dim);font-style:italic}
.go-settings-link{color:var(--mid);text-decoration:underline;cursor:pointer}
.go-settings-link:hover{color:var(--text)}
/* MODAL FOOTER */
.mfoot{padding:.7rem 1.4rem 1.18rem;border-top:1px solid var(--bsoft);display:flex;align-items:center;gap:.45rem;position:sticky;bottom:0;background:var(--white);border-radius:0 0 13px 13px}
.btn-save{background:var(--text);color:#fff;border:none;border-radius:6px;padding:.44rem 1.05rem;font-family:'Nunito',sans-serif;font-size:.72rem;font-weight:700;cursor:pointer;transition:background .11s}
.btn-save:hover{background:#3d3830}
.btn-discard{background:none;border:1px solid var(--border);border-radius:6px;padding:.44rem .84rem;font-family:'Nunito',sans-serif;font-size:.72rem;font-weight:500;color:var(--mid);cursor:pointer;transition:all .11s}
.btn-discard:hover{border-color:var(--mid);color:var(--text)}
.saved-msg{font-size:.65rem;color:#2e7060;font-weight:600;opacity:0;transition:opacity .3s;margin-left:.16rem}
.saved-msg.show{opacity:1}
/* EVENT/DUTY MODAL */
.ed-modal{background:var(--white);border-radius:13px;box-shadow:var(--sh-lg);width:100%;max-width:420px;animation:popIn .21s cubic-bezier(.34,1.56,.64,1)}
.ed-top{padding:1.05rem 1.35rem .82rem;border-bottom:1px solid var(--bsoft);display:flex;align-items:center;justify-content:space-between}
.ed-title-txt{font-family:'Lora',serif;font-size:1rem;font-weight:600}
.ed-body{padding:.95rem 1.35rem;display:flex;flex-direction:column;gap:.82rem}
.ed-type-row{display:flex;gap:.38rem}
.ed-type-btn{flex:1;border:1px solid var(--border);border-radius:7px;padding:.46rem .45rem;font-family:'Nunito',sans-serif;font-size:.7rem;font-weight:600;cursor:pointer;transition:all .13s;background:#fff;text-align:center;line-height:1.4}
.ed-type-btn.sel-ev{background:var(--ev-bg);border-color:var(--ev-br);color:var(--ev)}
.ed-type-btn.sel-du{background:var(--du-bg);border-color:var(--du-br);color:var(--du)}
.ed-time-row{display:grid;grid-template-columns:1fr 1fr;gap:.48rem}
.ed-foot{padding:.68rem 1.35rem 1.15rem;border-top:1px solid var(--bsoft);display:flex;gap:.42rem}
/* SETTINGS */
.settings-overlay{display:none;position:fixed;inset:0;background:rgba(44,40,32,.42);backdrop-filter:blur(7px);z-index:300;align-items:center;justify-content:center;padding:1rem}
.settings-overlay.open{display:flex}
.settings-modal{background:var(--white);border-radius:13px;box-shadow:var(--sh-lg);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;animation:popIn .21s cubic-bezier(.34,1.56,.64,1)}
.settings-top{padding:1.05rem 1.4rem .82rem;border-bottom:1px solid var(--bsoft);display:flex;align-items:center;justify-content:space-between}
.settings-title{font-family:'Lora',serif;font-size:.98rem;font-weight:600}
.settings-body{padding:1.05rem 1.4rem;display:flex;flex-direction:column;gap:1.25rem}
.sst{font-size:.56rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--soft);margin-bottom:.58rem;padding-bottom:.32rem;border-bottom:1px solid var(--bsoft)}
.colour-row{display:flex;align-items:center;gap:.56rem;padding:.42rem .62rem;background:var(--warm);border:1px solid var(--bsoft);border-radius:6px;margin-bottom:.35rem}
.colour-swatch{width:15px;height:15px;border-radius:50%;flex-shrink:0;border:2px solid rgba(0,0,0,.08)}
.colour-code{font-family:'Lora',serif;font-size:.8rem;font-weight:600;min-width:42px}
.colour-name{font-size:.67rem;color:var(--mid);flex:1}
.colour-preview{height:19px;border-radius:3px;flex:1.5;border-left:3px solid transparent;display:flex;align-items:center;padding:0 .42rem;font-size:.58rem;font-weight:600;transition:all .2s;overflow:hidden;white-space:nowrap}
.colour-input{width:28px;height:20px;border-radius:4px;border:1px solid var(--border);padding:0;cursor:pointer;background:none;overflow:hidden;flex-shrink:0}
.colour-input::-webkit-color-swatch-wrapper{padding:1px}
.colour-input::-webkit-color-swatch{border-radius:2px;border:none}
.roster-row{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;margin-bottom:.42rem}
.roster-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;padding:.52rem .68rem}
.roster-class-label{font-family:'Lora',serif;font-size:.8rem;font-weight:600}
.roster-toggle{font-size:.62rem;color:var(--soft);transition:transform .15s}
.roster-toggle.open{transform:rotate(180deg)}
.roster-content{display:none;margin:0 .68rem .55rem;flex-direction:column;gap:.3rem}
.roster-content.open{display:flex}
.roster-ta{width:100%;background:#fff;border:1px solid var(--border);border-radius:5px;padding:.45rem .65rem;font-family:'Nunito',sans-serif;font-size:.7rem;color:var(--text);line-height:1.7;resize:vertical;min-height:58px;outline:none;transition:border-color .11s}
.roster-ta:focus{border-color:var(--mid)}
.roster-ta::placeholder{color:var(--dim);font-style:italic}
.roster-hint{font-size:.58rem;color:var(--dim)}
.roster-save-btn{background:var(--text);color:#fff;border:none;border-radius:5px;padding:.3rem .75rem;font-family:'Nunito',sans-serif;font-size:.64rem;font-weight:700;cursor:pointer;align-self:flex-start;transition:background .1s}
.roster-save-btn:hover{background:#3d3830}
.roster-saved{font-size:.58rem;color:#2e7060;font-weight:600;opacity:0;transition:opacity .3s;margin-left:.26rem}
.roster-saved.show{opacity:1}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:1080px){.week-layout{grid-template-columns:1fr}.today-panel{display:none}}
body.timeline-mode .today-panel{display:none}
body.timeline-mode .week-layout{grid-template-columns:1fr}
@media(max-width:940px){.tt{grid-template-columns:repeat(3,1fr)}}
@media(max-width:560px){.tt{grid-template-columns:repeat(2,1fr)};main{padding:.85rem .85rem 2rem};.hdr,.nav{padding:0 .85rem};.pn-grid{grid-template-columns:1fr}}

/* VIEW TOGGLE */
.view-toggle{display:flex;background:var(--warm);border:1px solid var(--border);border-radius:7px;padding:2px;gap:2px;margin-left:.5rem}
.vt-btn{background:none;border:none;border-radius:5px;padding:.2rem .72rem;font-family:'Nunito',sans-serif;font-size:.67rem;font-weight:600;color:var(--soft);cursor:pointer;transition:all .15s;white-space:nowrap}
.vt-btn.active{background:var(--white);color:var(--text);box-shadow:0 1px 3px rgba(44,40,32,.1)}
.vt-btn:hover:not(.active){color:var(--text)}

/* TIMELINE VIEW */
.tt-timeline{display:grid;grid-template-columns:32px repeat(6,1fr);gap:0;position:relative;background:var(--white);border:1px solid var(--bsoft);border-radius:10px;overflow:hidden;box-shadow:var(--sh-sm)}
.tl-time-col{grid-column:1;display:flex;flex-direction:column;background:var(--warm);border-right:1px solid var(--bsoft);position:relative;z-index:2}
.tl-time-label{font-size:.55rem;font-weight:600;color:var(--soft);text-align:right;padding-right:.38rem;position:absolute;transform:translateY(-50%);right:0;white-space:nowrap;letter-spacing:.01em}
.tl-day-col{position:relative;border-right:1px solid var(--bsoft);min-height:0}
.tl-day-col:last-child{border-right:none}
.tl-day-hdr{padding:.38rem .45rem .32rem;background:var(--white);border-bottom:1px solid var(--bsoft);position:sticky;top:0;z-index:3;text-align:center}
.tl-day-hdr.today-hd{background:var(--text)}
.tl-hour-line{position:absolute;left:0;right:0;height:1px;background:var(--bsoft);z-index:0;pointer-events:none}
.tl-hour-line.half{background:var(--parch)}
.tl-body{position:relative;padding-bottom:6px}

/* cards inside timeline */
.tl-card{position:absolute;left:3px;right:3px;border-radius:5px;padding:.28rem .42rem .28rem .58rem;border:1px solid transparent;border-left-width:3px;overflow:hidden;cursor:pointer;transition:box-shadow .14s,transform .12s;z-index:1}
.tl-card:hover:not(.cancelled){box-shadow:var(--sh-md);transform:translateX(1px)}
.tl-card.cancelled{opacity:.42;cursor:pointer}
.tl-card .lc-time{font-size:.52rem}
.tl-card .lc-code{font-size:.76rem}
.tl-card .lc-subj{font-size:.5rem}
.tl-card .lc-topic{font-size:.6rem;margin-top:.1rem;-webkit-line-clamp:2}
.tl-ecard{position:absolute;left:3px;right:3px;border-radius:5px;padding:.26rem .38rem .26rem .54rem;border:1px solid transparent;border-left-width:3px;overflow:hidden;cursor:pointer;transition:box-shadow .14s;z-index:1}
.tl-ecard:hover{box-shadow:var(--sh-md)}
.tl-ecard.ev-card{background:var(--ev-bg);border-color:var(--ev-br);border-left-color:var(--ev)}
.tl-ecard.du-card{background:var(--du-bg);border-color:var(--du-br);border-left-color:var(--du)}
.tl-now-line{position:absolute;left:0;right:0;height:2px;background:#e03030;z-index:10;pointer-events:none;box-shadow:0 0 4px rgba(224,48,48,.4)}
.tl-now-line::before{content:'';position:absolute;left:-4px;top:-4px;width:10px;height:10px;border-radius:50%;background:#e03030;border:2px solid #fff}
.tl-card.tl-now{box-shadow:0 0 0 2px rgba(44,40,32,.25),var(--sh-md);z-index:5}
.tl-time-hdr{background:var(--warm);border-right:1px solid var(--bsoft);border-bottom:1px solid var(--bsoft);position:sticky;top:0;z-index:4}


/* TERM BANNER */
.term-banner{display:flex;align-items:center;gap:.6rem;margin-bottom:.7rem;flex-wrap:wrap;min-height:0}
.term-banner:empty{display:none}
.term-chip{display:flex;align-items:center;gap:.38rem;padding:.22rem .72rem;border-radius:20px;font-size:.66rem;font-weight:600;white-space:nowrap}
.term-chip.term-label{background:#e8f0e8;border:1px solid #b0ccb0;color:#2a5a2a}
.term-chip.week-label{background:var(--warm);border:1px solid var(--border);color:var(--mid)}
.term-chip.half-term{background:#fff3e0;border:1px solid #f0cc80;color:#8a5a00}
.term-chip.holiday{background:#fde8e8;border:1px solid #f0b0b0;color:#8a2020}
.term-chip.exams{background:#ede8f8;border:1px solid #c0a8e8;color:#4a2090}

/* TERM SETTINGS */
.term-periods{display:flex;flex-direction:column;gap:.55rem}
.term-period-row{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;padding:.6rem .78rem;display:flex;flex-direction:column;gap:.45rem}
.term-period-hdr{display:flex;align-items:center;justify-content:space-between}
.term-period-name{font-size:.78rem;font-weight:600;color:var(--text)}
.term-period-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.72rem;padding:.04rem .18rem;border-radius:3px;transition:color .1s}
.term-period-del:hover{color:#c03030}
.term-date-row{display:grid;grid-template-columns:1fr 1fr;gap:.45rem}
.term-type-row{display:flex;gap:.3rem;flex-wrap:wrap}
.term-type-btn{background:#fff;border:1px solid var(--border);border-radius:4px;padding:.2rem .55rem;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:600;cursor:pointer;transition:all .11s;color:var(--mid)}
.term-type-btn:hover{border-color:var(--mid);color:var(--text)}
.term-type-btn.st{background:#e8f0e8;border-color:#b0ccb0;color:#2a5a2a}
.term-type-btn.sht{background:#fff3e0;border-color:#f0cc80;color:#8a5a00}
.term-type-btn.sh{background:#fde8e8;border-color:#f0b0b0;color:#8a2020}
.term-type-btn.sex{background:#ede8f8;border-color:#c0a8e8;color:#4a2090}
.add-period-btn{background:none;border:1px dashed var(--border);border-radius:7px;padding:.5rem;font-family:'Nunito',sans-serif;font-size:.7rem;font-weight:500;color:var(--soft);cursor:pointer;transition:all .13s;width:100%;margin-top:.2rem}
.add-period-btn:hover{border-color:var(--mid);color:var(--text);background:var(--warm)}
.term-save-bar{display:flex;align-items:center;gap:.45rem;margin-top:.3rem}
.term-saved{font-size:.62rem;color:#2e7060;font-weight:600;opacity:0;transition:opacity .3s}
.term-saved.show{opacity:1}

/* LOADING / AUTH */
.loading-overlay{position:fixed;inset:0;background:#f3f0ea;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem}
.loading-overlay.hidden{display:none}
.loading-spinner{width:32px;height:32px;border:3px solid #d5cfc4;border-top-color:#2c2820;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'Nunito',sans-serif;font-size:.82rem;color:#6b6258}
/* SETUP EMPTY STATE */
.setup-empty{text-align:center;padding:3rem 1.5rem;color:var(--mid)}
.setup-empty h2{font-family:'Lora',serif;font-size:1.2rem;font-weight:600;color:var(--text);margin-bottom:.5rem}
.setup-empty p{font-size:.78rem;margin-bottom:1rem;line-height:1.6}
.setup-empty .setup-btn{background:var(--text);color:#fff;border:none;border-radius:7px;padding:.5rem 1.2rem;font-family:'Nunito',sans-serif;font-size:.74rem;font-weight:700;cursor:pointer}
.setup-empty .setup-btn:hover{background:#3d3830}
/* BACK BUTTON */
.hdr-back{text-decoration:none;color:var(--mid);font-size:.72rem;font-weight:600;display:flex;align-items:center;gap:.2rem;transition:color .12s;flex-shrink:0}
.hdr-back:hover{color:var(--text)}
.hdr-user{font-size:.62rem;color:var(--soft);white-space:nowrap;flex-shrink:0;max-width:140px;overflow:hidden;text-overflow:ellipsis}
/* TT SETUP */
.tt-setup-day{background:var(--warm);border:1px solid var(--bsoft);border-radius:7px;margin-bottom:.42rem;padding:.5rem .68rem}
.tt-setup-day-hdr{font-family:'Lora',serif;font-size:.78rem;font-weight:600;margin-bottom:.32rem;display:flex;align-items:center;justify-content:space-between}
.tt-setup-slot{display:flex;align-items:center;gap:.32rem;padding:.2rem 0;font-size:.68rem}
.tt-setup-slot .slot-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.66rem}
.tt-setup-slot .slot-del:hover{color:#c03030}
.tt-setup-slot .slot-time{min-width:42px;font-weight:600;cursor:pointer;border-radius:3px;padding:0 .18rem;transition:background .12s}
.tt-setup-slot .slot-time:hover{background:rgba(0,0,0,.06)}
.tt-setup-slot .slot-time-edit{width:80px;font-size:.68rem;padding:.14rem .28rem;border:1px solid var(--border);border-radius:4px;font-family:'Nunito',sans-serif}
.tt-slot-migrate{font-size:.58rem;color:var(--mid);margin-top:.12rem;padding:.3rem .42rem;background:#f8f5f0;border:1px solid var(--bsoft);border-radius:5px;display:flex;align-items:center;gap:.32rem;flex-wrap:wrap}
.tt-slot-migrate button{font-size:.58rem;padding:.14rem .48rem;border-radius:4px;border:1px solid var(--border);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:600;transition:all .12s}
.tt-slot-migrate .migrate-yes{background:var(--text);color:#fff;border-color:var(--text)}
.tt-slot-migrate .migrate-yes:hover{opacity:.85}
.tt-slot-migrate .migrate-no{background:#fff;color:var(--mid)}
.tt-slot-migrate .migrate-no:hover{border-color:var(--mid)}
.tt-add-row{display:flex;gap:.28rem;margin-top:.32rem;flex-wrap:wrap}
.tt-add-row .finput{width:auto;padding:.28rem .48rem;font-size:.68rem}
.week-ab-toggle{display:flex;gap:.18rem}
.week-ab-btn{border:1px solid var(--border);border-radius:4px;padding:.14rem .4rem;font-size:.6rem;font-weight:700;cursor:pointer;background:#fff;color:var(--soft);transition:all .1s}
.week-ab-btn.active{background:var(--text);color:#fff;border-color:var(--text)}
.subj-row{display:flex;align-items:center;gap:.44rem;padding:.28rem .5rem;background:var(--warm);border:1px solid var(--bsoft);border-radius:5px;margin-bottom:.24rem;font-size:.7rem}
.subj-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.64rem}
.subj-del:hover{color:#c03030}
.save-indicator{position:fixed;bottom:16px;right:16px;background:var(--text);color:#fff;padding:.38rem .82rem;border-radius:7px;font-family:'Nunito',sans-serif;font-size:.66rem;font-weight:600;opacity:0;transition:opacity .3s;z-index:100;pointer-events:none}
.save-indicator.show{opacity:1}
/* RECURRENCE */
.ed-recur-row{display:flex;gap:.26rem;flex-wrap:wrap}
.ed-recur-btn{background:#fff;border:1px solid var(--border);border-radius:4px;padding:.22rem .6rem;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:600;cursor:pointer;transition:all .11s;color:var(--soft)}
.ed-recur-btn:hover{border-color:var(--mid);color:var(--text)}
.ed-recur-btn.active{background:var(--text);color:#fff;border-color:var(--text)}
.ec-recur{font-size:.5rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--soft);margin-top:.04rem}

</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading your planner...</div>
</div>
<div class="save-indicator" id="saveIndicator">Saved to cloud &#x2713;</div>
<div id="appContent" style="display:none">
<header class="hdr">
  <a class="hdr-back" id="backLink" href="../index.html">&#8592; Back</a>
  <span class="hdr-div"></span>
  <span class="hdr-title">My Planner</span>
  <span class="hdr-user" id="hdrUser"></span>
  <span class="hdr-div"></span>
  <span class="wk-chip" id="wkChip">Week A</span>
  <div class="hdr-clock">
    <span class="clock-time" id="clockTime">00:00</span>
    <span class="clock-lesson" id="clockLesson"></span>
  </div>
  <button class="settings-btn" onclick="openSearch()" title="Search" style="font-size:.78rem">&#x1F50D;</button>
  <button class="hdr-btn ev" onclick="openEdModal('event')">+ Event</button>
  <button class="hdr-btn du" onclick="openEdModal('duty')">+ Duty</button>
  <button class="settings-btn" onclick="openSettings()" title="Settings">&#x2699;</button>
</header>
<nav class="nav">
  <button class="ntab active"  onclick="showView('week',this)">This Week</button>
  <button class="ntab" onclick="showView('alllessons',this)">All Lessons</button>
  <button class="ntab" onclick="showView('heatmap',this)">Term Overview</button>
  <button class="ntab" onclick="showView('classes',this)">All Classes</button>
  <button class="ntab" onclick="showView('past',this)">Past Lessons</button>
  <button class="ntab" onclick="showView('behaviour',this)">Behaviour</button>
  <button class="ntab" onclick="showView('notes',this)">Quick Notes</button>
</nav>
<main>
  <div class="view visible" id="viewWeek">
    <div class="wk-ctrl">
      <button class="wk-btn" onclick="shiftWeek(-1)">&#8592;</button>
      <span class="wk-range" id="wkRange">&#8230;</span>
      <button class="wk-btn" onclick="shiftWeek(1)">&#8594;</button>
      <button class="today-pill" onclick="jumpToday()">Today</button>
      <div class="view-toggle">
        <button class="vt-btn active" id="vtList" onclick="setTtView('list')">List</button>
        <button class="vt-btn" id="vtTime" onclick="setTtView('time')">&#9201; Timeline</button>
      </div>
    </div>
    <div class="term-banner" id="termBanner"></div>
    <div class="week-layout">
      <div class="tt" id="timetable"></div>
      <div class="today-panel" id="todayPanel">
        <div class="tp-hdr">
          <span class="tp-title">Today</span>
          <span class="tp-date-lbl" id="tpDateLbl"></span>
        </div>
        <div class="tp-scroll" id="tpScroll"></div>
      </div>
    </div>
  </div>
  <div class="view" id="viewHeatmap">
    <div class="heatmap" id="heatmap"></div>
    <div style="display:flex;gap:.9rem;margin-top:.85rem;font-size:.64rem;color:var(--soft);flex-wrap:wrap">
      <span style="display:flex;align-items:center;gap:.26rem"><span style="width:9px;height:9px;border-radius:2px;background:#c8e0c8;border:1px solid #90c090;display:inline-block"></span>Topic set</span>
      <span style="display:flex;align-items:center;gap:.26rem"><span style="width:9px;height:9px;border-radius:2px;background:#e3ddd3;border:1px solid #ccc4b8;display:inline-block"></span>No plan</span>
      <span style="display:flex;align-items:center;gap:.26rem"><span style="width:9px;height:9px;border-radius:2px;background:#e8d4d4;border:1px solid #c8a0a0;opacity:.5;display:inline-block"></span>Cancelled</span>
    </div>
  </div>
  <div class="view" id="viewClasses"><div class="cg" id="classesGrid"></div><div id="classDetail" style="display:none"></div></div>
  <div class="view" id="viewPast"><div id="pastContent"></div></div>
  <div class="view" id="viewBehaviour">
    <div class="beh-filters">
      <button class="beh-filter-btn active" onclick="setBehFilter('all',this)">All</button>
      <button class="beh-filter-btn" onclick="setBehFilter('verbal',this)">Verbal</button>
      <button class="beh-filter-btn" onclick="setBehFilter('detention',this)">Detention</button>
      <button class="beh-filter-btn" onclick="setBehFilter('praise',this)">Praise</button>
      <button class="beh-filter-btn" onclick="setBehFilter('note',this)">Note</button>
    </div>
    <div id="behContent"></div>
  </div>
  <div class="view" id="viewNotes"><div class="qn-grid" id="qnGrid"></div></div>
  <div class="view" id="viewAllLessons"><div id="allLessonsContent"></div></div>
</main>

<!-- SEARCH OVERLAY -->
<div class="search-overlay" id="searchOverlay" onclick="searchBgClick(event)">
  <div class="search-box">
    <div class="search-input-wrap">
      <span class="search-icon">&#x1F50D;</span>
      <input class="search-input" id="searchInput" type="text" placeholder="Search topics, notes, resources&hellip;" autocomplete="off">
      <button class="search-close" onclick="closeSearch()">&#x2715;</button>
    </div>
    <div class="search-results" id="searchResults">
      <div class="search-empty">Start typing to search across all lessons</div>
    </div>
  </div>
</div>

<!-- LESSON MODAL -->
<div class="overlay" id="overlay" onclick="bgClick(event)">
  <div class="modal">
    <div class="mtop">
      <div><div class="m-cname" id="mName">&#8212;</div><div class="m-cmeta" id="mMeta">&#8212;</div></div>
      <button class="m-close" onclick="closeModal()">&#x2715;</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('plan',this)">Plan</button>
      <button class="modal-tab" onclick="switchTab('prep',this)">Prep</button>
      <button class="modal-tab" onclick="switchTab('behaviour',this)">Behaviour</button>
    </div>
    <div class="modal-pane active" id="paneplan">
      <div><div class="slabel">Term progress</div>
        <div class="cnt-banner"><div class="cnt-big" id="mRem">&#8212;</div>
          <div class="cnt-lbls"><div class="cnt-main" id="mRemLabel">&#8212;</div><div class="cnt-sub" id="mTaughtLabel">&#8212;</div></div>
          <div class="cnt-bar-wrap"><div class="cnt-bar"><div class="cnt-bar-fill" id="mBarFill" style="width:0%"></div></div></div>
        </div>
      </div>
      <div id="prepDueBannerWrap" style="display:none">
        <div class="slabel">Prep due this lesson</div>
        <div class="prep-due-banner" id="prepDueBanner"></div>
        <div id="prepCollectWrap"></div>
      </div>
      <div><div class="slabel">Context</div>
        <div class="pn-grid">
          <div class="pn-blk"><div class="pn-lbl">Last lesson</div><div class="pn-date" id="mPrevDate">&#8212;</div><div class="pn-topic" id="mPrevTopic"></div><div class="pn-text" id="mPrevText"></div></div>
          <div class="pn-blk"><div class="pn-lbl">Next lesson</div><div class="pn-date" id="mNextDate">&#8212;</div><div class="pn-topic" id="mNextTopic"></div><div class="pn-text" id="mNextText"></div></div>
        </div>
      </div>
      <div><div class="slabel">Topic <span style="font-weight:300;letter-spacing:0;text-transform:none;font-size:.66rem;color:var(--dim)">(shows on card)</span></div>
        <input type="text" class="topic-in" id="mTopic" placeholder="e.g. Tacitus Annals 1.1&#8211;3 &#8212; passive voice"></div>
      <div><div class="slabel">Notes <span style="font-weight:300;letter-spacing:0;text-transform:none;font-size:.66rem;color:var(--dim)">(detail, modal only)</span></div>
        <textarea class="plan-ta" id="mPlan" placeholder="Resources, timings, differentiation, key questions&#8230;"></textarea></div>
      <div><div class="slabel">Resources</div>
        <div id="mResources"></div>
        <div class="res-add-row">
          <input type="text" class="finput res-input" id="resTitle" placeholder="Title">
          <input type="url" class="finput res-input" id="resUrl" placeholder="https://...">
          <button class="sm-action-btn res-add-btn" onclick="addResource()">Add</button>
        </div>
      </div>
      <div class="cancel-box">
        <div class="cancel-row">
          <div><div class="cancel-title">Cancel this lesson</div><div class="cancel-sub">Trip, illness, INSET, assembly, cover&#8230;</div></div>
          <div class="tgl-wrap"><input type="checkbox" class="tgl-in" id="cancelTgl" onchange="toggleCancel()"><label class="tgl-lbl" for="cancelTgl"></label></div>
        </div>
        <div class="cancel-reason-wrap" id="cancelReasonWrap">
          <input type="text" class="cancel-reason-in" id="cancelReason" placeholder="Reason (optional)&#8230;"></div>
      </div>
    </div>
    <div class="modal-pane" id="paneprep">
      <div id="prepExistingWrap"></div>
      <div class="prep-set-box">
        <div><div style="font-size:.73rem;font-weight:700;color:var(--text)" id="prepFormTitle">Set prep for this lesson</div>
          <div style="font-size:.64rem;color:var(--soft);margin-top:.04rem">Appears as a reminder when the due lesson opens.</div></div>
        <div class="frow"><label class="slabel">Description</label>
          <textarea class="finput plan-ta" id="prepDesc" style="min-height:58px" placeholder="e.g. Learn vocab list 7. Translate sentences 1&#8211;5."></textarea></div>
        <div class="frow"><label class="slabel">Due by lesson</label>
          <select class="fselect" id="prepDueLesson"><option value="">Select a lesson&#8230;</option></select></div>
        <button class="sm-action-btn" onclick="savePrep()">Save prep</button>
      </div>
    </div>
    <div class="modal-pane" id="panebehaviour">
      <div><div class="slabel">This lesson</div><div class="beh-log-list" id="behLogList"></div></div>
      <div class="beh-add-form">
        <div class="slabel">Add entry</div>
        <div id="noStudentsMsg" class="no-students-msg" style="display:none">No students added. <span class="go-settings-link" onclick="openSettings()">Add in Settings &#x2699;</span></div>
        <div id="studentSelectWrap"><select class="fselect" id="behStudent"><option value="">Select student&#8230;</option></select></div>
        <div class="frow"><label class="slabel">Type</label>
          <div class="beh-type-btns">
            <button class="beh-type-btn" onclick="selBehT('verbal',this)">Verbal Warning</button>
            <button class="beh-type-btn" onclick="selBehT('detention',this)">Detention</button>
            <button class="beh-type-btn" onclick="selBehT('praise',this)">Praise</button>
            <button class="beh-type-btn" onclick="selBehT('note',this)">Note to Self</button>
          </div></div>
        <div class="frow"><input class="finput" type="text" id="behNote" placeholder="Optional note&#8230;"></div>
        <button class="sm-action-btn" onclick="addBehEntry()">Add entry</button>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn-save" onclick="saveLesson()">Save</button>
      <button class="btn-discard" onclick="closeModal()">Discard</button>
      <span class="saved-msg" id="savedMsg">Saved &#x2713;</span>
    </div>
  </div>
</div>

<!-- EVENT/DUTY MODAL -->
<div class="overlay" id="edOverlay" onclick="edBgClick(event)">
  <div class="ed-modal">
    <div class="ed-top">
      <span class="ed-title-txt" id="edTitleTxt">Add Event</span>
      <button class="m-close" onclick="closeEdModal()">&#x2715;</button>
    </div>
    <div class="ed-body">
      <div><div class="slabel">Type</div>
        <div class="ed-type-row">
          <button class="ed-type-btn" id="edTypeEv" onclick="setEdType('event')">&#127914; Event<br><span style="font-size:.6rem;font-weight:400;opacity:.65">Assembly, trip, drop-down&#8230;</span></button>
          <button class="ed-type-btn" id="edTypeDu" onclick="setEdType('duty')">&#128203; Duty<br><span style="font-size:.6rem;font-weight:400;opacity:.65">Clinic, lunch, boarding&#8230;</span></button>
        </div>
      </div>
      <div class="frow"><label class="slabel">Title</label>
        <input type="text" class="finput" id="edTitleIn" placeholder="e.g. Year 10 Assembly / Lunch Cover&#8230;"></div>
      <div class="frow"><label class="slabel">Day</label>
        <select class="fselect" id="edDay"></select></div>
      <div class="ed-time-row">
        <div class="frow"><label class="slabel">Start</label><input type="time" class="finput" id="edStart" value="09:00"></div>
        <div class="frow"><label class="slabel">End</label><input type="time" class="finput" id="edEnd" value="10:00"></div>
      </div>
      <div class="frow"><label class="slabel">Recurrence</label>
        <div class="ed-recur-row" id="edRecurRow">
          <button class="ed-recur-btn active" data-recur="once" onclick="setEdRecur('once',this)">Once</button>
          <button class="ed-recur-btn" data-recur="all" onclick="setEdRecur('all',this)">Every week</button>
          <button class="ed-recur-btn" data-recur="A" onclick="setEdRecur('A',this)">Week A only</button>
          <button class="ed-recur-btn" data-recur="B" onclick="setEdRecur('B',this)">Week B only</button>
        </div>
      </div>
    </div>
    <div class="ed-foot">
      <button class="btn-save" onclick="saveEdEntry()">Save</button>
      <button class="btn-discard" onclick="closeEdModal()">Discard</button>
      <button class="btn-discard" id="edDeleteBtn" style="display:none;margin-left:auto;border-color:#e0a0a0;color:#c03030" onclick="deleteEdEntry()">Delete</button>
    </div>
  </div>
</div>

<!-- DAY NOTE MODAL -->
<div class="overlay" id="dnOverlay" onclick="dnBgClick(event)">
  <div class="dn-modal">
    <div class="dn-top">
      <span class="dn-title-txt" id="dnTitleTxt">Add Day Note</span>
      <button class="m-close" onclick="closeDnModal()">&#x2715;</button>
    </div>
    <div class="dn-body">
      <div class="frow"><label class="slabel">Note</label>
        <input type="text" class="finput" id="dnTextIn" placeholder="e.g. Parents Evening, INSET Day, Sports Day&#8230;"></div>
    </div>
    <div class="dn-foot">
      <button class="btn-save" onclick="saveDnEntry()">Save</button>
      <button class="btn-discard" onclick="closeDnModal()">Discard</button>
      <button class="btn-discard" id="dnDeleteBtn" style="display:none;margin-left:auto;border-color:#e0a0a0;color:#c03030" onclick="deleteDnEntry()">Delete</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="settings-overlay" id="settingsOverlay" onclick="settingsBgClick(event)">
  <div class="settings-modal">
    <div class="settings-top"><span class="settings-title">Settings</span><button class="m-close" onclick="closeSettings()">&#x2715;</button></div>
    <div class="settings-body">
      <div><div class="sst">Term dates</div>
        <div style="display:flex;gap:.48rem;flex-wrap:wrap">
          <div class="frow" style="flex:1;min-width:130px"><label class="slabel">Term start</label>
            <input class="finput" type="date" id="termStartInput"></div>
          <div class="frow" style="flex:1;min-width:130px"><label class="slabel">Term end</label>
            <input class="finput" type="date" id="termEndInput"></div>
        </div>
        <div class="term-save-bar" style="margin-top:.45rem"><button class="sm-action-btn" onclick="saveTermDates()">Save dates</button><span class="term-saved" id="termDatesSaved">Saved &#x2713;</span></div>
      </div>
      <div><div class="sst">Subjects</div>
        <div id="subjectRows"></div>
        <div style="display:flex;gap:.28rem;margin-top:.4rem;align-items:flex-end">
          <div class="frow" style="width:70px"><label class="slabel">Code</label><input class="finput" id="newSubjCode" placeholder="La" style="text-transform:capitalize"></div>
          <div class="frow" style="flex:1"><label class="slabel">Name</label><input class="finput" id="newSubjName" placeholder="Latin"></div>
          <button class="sm-action-btn" onclick="addSubject()" style="margin-bottom:1px">Add</button>
        </div>
      </div>
      <div><div class="sst">Timetable</div>
        <div style="display:flex;gap:.2rem;margin-bottom:.55rem" id="ttSetupWeekToggle">
          <button class="week-ab-btn active" onclick="setTtSetupWeek('A',this)">Week A</button>
          <button class="week-ab-btn" onclick="setTtSetupWeek('B',this)">Week B</button>
        </div>
        <div id="ttSetupGrid"></div>
      </div>
      <div><div class="sst">Term calendar</div><div id="termPeriodRows"></div>
        <button class="add-period-btn" onclick="addTermPeriod()">+ Add period</button>
        <div class="term-save-bar"><button class="sm-action-btn" onclick="saveTermPeriods()">Save calendar</button><span class="term-saved" id="termSavedMsg">Saved &#x2713;</span></div>
      </div>
      <div><div class="sst">Prep nights</div>
        <div style="font-size:.62rem;color:var(--mid);margin-bottom:.45rem;line-height:1.5">Set which evening each class typically gets prep. A dot will appear on that class's lessons as a reminder.</div>
        <div id="prepNightRows"></div>
        <button class="add-period-btn" onclick="addPrepNight()" id="addPrepNightBtn">+ Add prep night</button>
      </div>
      <div><div class="sst">Class colours</div><div id="colourRows"></div></div>
      <div><div class="sst">Class rosters</div><div id="rosterRows"></div></div>
    </div>
  </div>
</div>
</div><!-- /appContent -->
<script src="../auth/config.js"></script>
<script src="../auth/auth.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LAYER â€” all planner data stored per-user in Supabase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUserId = null;

// In-memory store â€” replaces all localStorage usage
let PDATA = {
  timetable: {A:{},B:{}},
  subjects: {},
  defaultColours: {},
  termStart: '',
  termEnd: '',
  classColours: {},
  lessons: {},
  rosters: {},
  prep: {},
  behaviour: {},
  quickNotes: {},
  events: {},
  recurringEvents: [],
  termPeriods: [],
  prepNights: [],
  dayNotes: {}
};

// Derived globals (populated from PDATA after load)
let TT = {A:{},B:{}};
let SUBJ = {};
let DCOLS = {};
let TERM_START = new Date();
let TERM_END = new Date();
const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

function applyPDATA() {
  TT = PDATA.timetable || {A:{},B:{}};
  SUBJ = PDATA.subjects || {};
  DCOLS = PDATA.defaultColours || {};
  TERM_START = PDATA.termStart ? new Date(PDATA.termStart+'T00:00:00') : new Date();
  TERM_END = PDATA.termEnd ? new Date(PDATA.termEnd+'T00:00:00') : new Date();
}

// â”€â”€â”€ SUPABASE SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let saveTimer = null;
function scheduleSave() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(syncToCloud, 1500);
}

async function syncToCloud() {
  if (!currentUserId) return;
  try {
    const { error } = await supabase.from('planner_data').upsert({
      user_id: currentUserId,
      data: PDATA
    }, { onConflict: 'user_id' });
    if (!error) {
      const ind = document.getElementById('saveIndicator');
      ind.classList.add('show');
      setTimeout(() => ind.classList.remove('show'), 2000);
    }
  } catch (e) { console.error('Sync error:', e); }
}

async function loadFromCloud() {
  if (!currentUserId) return false;
  try {
    const { data, error } = await supabase
      .from('planner_data')
      .select('data')
      .eq('user_id', currentUserId)
      .single();
    if (error && error.code !== 'PGRST116') { console.error('Load error:', error); return false; }
    if (data && data.data) {
      // Merge loaded data with defaults to ensure all keys exist
      PDATA = { ...PDATA, ...data.data };
      return true;
    }
    return false;
  } catch (e) { console.error('Load error:', e); return false; }
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pcode(c){const m=c.match(/^(\d+)([A-Za-z]{2})([A-Za-z]*)$/);if(!m)return{sk:'La'};const sk=m[2][0].toUpperCase()+m[2][1].toLowerCase();return{sk:SUBJ[sk]?sk:'La'}}
function sn(c){return SUBJ[pcode(c).sk]?.name||''}
function isSt(c){return c.endsWith('Ss')}
function dur(c){return c.startsWith('8')?35:45}
function addD(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r}
function monOf(d){const r=new Date(d);r.setHours(0,0,0,0);const w=r.getDay();r.setDate(r.getDate()-(w===0?6:w-1));return r}
function sameD(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function fmtF(d){return d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}
function fmtS(d){return d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function wkT(mon){if(!PDATA.termStart)return'A';return Math.round((mon-monOf(TERM_START))/604800000)%2===0?'A':'B'}
function allC(){const s=new Set();for(const w of['A','B'])for(const ls of Object.values(TT[w]||{}))for(const[,c]of ls)if(!isSt(c))s.add(c);return Array.from(s).sort()}
function datesFor(code){
  if(!PDATA.termStart||!PDATA.termEnd)return[];
  const res=[];let mon=monOf(TERM_START);
  while(mon<=TERM_END){const w=wkT(mon);for(let d=0;d<=5;d++)for(const[t,c]of(TT[w]?.[d]||[])){if(c!==code)continue;const dt=addD(mon,d);if(dt>=TERM_START&&dt<=TERM_END)res.push({date:dt,time:t})}mon=addD(mon,7)}
  return res;
}
function t2m(t){const[h,m]=t.split(':').map(Number);return h*60+m}
function m2t(m){return`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`}

function h2rgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
function bl(hex,a){const{r,g,b}=h2rgb(hex)||{r:150,g:150,b:150};return`rgb(${Math.round(r*a+255*(1-a))},${Math.round(g*a+255*(1-a))},${Math.round(b*a+255*(1-a))})`}
function dk(hex,f=.65){const{r,g,b}=h2rgb(hex)||{r:100,g:100,b:100};return`rgb(${Math.round(r*f)},${Math.round(g*f)},${Math.round(b*f)})`}

// â”€â”€â”€ DATA ACCESSORS (read/write PDATA instead of localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gCol(c){return PDATA.classColours[c]||DCOLS[c]||'#888888'}

function lk(d,t,c){return`${d.toISOString().slice(0,10)}::${t}::${c}`}
function loadL(d,t,c){return PDATA.lessons[lk(d,t,c)]||{}}
function saveL(d,t,c,data){PDATA.lessons[lk(d,t,c)]=data;scheduleSave()}
function gRoster(c){return PDATA.rosters[c]||[]}
function sRoster(c,a){PDATA.rosters[c]=a;scheduleSave()}
function gAllPrep(c){const res=[];const prefix=`${c}::`;for(const[key,data]of Object.entries(PDATA.prep||{})){if(key.startsWith(prefix))res.push({key,data})}return res}
function gBeh(c){return PDATA.behaviour[c]||[]}
function sBeh(c,a){PDATA.behaviour[c]=a;scheduleSave()}
function gQNote(c){return PDATA.quickNotes[c]||''}
function sQNote(c,t){PDATA.quickNotes[c]=t;scheduleSave()}
function gEd(ds){
  const oneOff=PDATA.events[ds]||[];
  const d=new Date(ds+'T00:00:00');
  const di=((d.getDay()||7)-1);
  if(di<0||di>5)return oneOff;
  const wt=wkT(monOf(d));
  const recs=(PDATA.recurringEvents||[]).filter(r=>r.day===di&&(r.weeks==='all'||r.weeks===wt));
  if(!recs.length)return oneOff;
  // exclude recurring events that have been individually deleted for this date
  const deletedSet=new Set((PDATA.events['_del_'+ds]||[]).map(id=>id));
  const merged=[...oneOff];
  for(const r of recs){if(!deletedSet.has(r.id))merged.push({id:r.id,type:r.type,title:r.title,start:r.start,end:r.end,_recurring:true,_weeks:r.weeks})}
  return merged;
}
function sEd(ds,a){PDATA.events[ds]=a;scheduleSave()}
// Day notes (whole-day notes pinned at top of a day)
function gDayNotes(ds){return PDATA.dayNotes[ds]||[]}
function sDayNotes(ds,arr){PDATA.dayNotes[ds]=arr;scheduleSave()}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function typeLbl(t){return{verbal:'Verbal',detention:'Detention',praise:'Praise',note:'Note'}[t]||t}

let weekOffset=0,activeModal=null,selBehType='',behFilter='all',editPrepKey=null,edType='event',edEditId=null,edEditDs=null,edRecur='once',edEditRecurring=false;
function curMon(){return addD(monOf(TERM_START),weekOffset*7)}

// CLOCK
function updateClock(){
  const now=new Date();
  document.getElementById('clockTime').textContent=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const nowM=now.getHours()*60+now.getMinutes();
  const today=new Date(now);today.setHours(0,0,0,0);
  const di=((today.getDay()||7)-1);
  const el=document.getElementById('clockLesson');
  if(di<0||di>5){el.textContent='';updateTodayPanel();return}
  const wt=wkT(monOf(today));
  const lessons=(TT[wt][di]||[]).filter(([,c])=>!isSt(c)).sort((a,b)=>t2m(a[0])-t2m(b[0]));
  let cur=null,nxt=null;
  for(const[time,code]of lessons){const s=t2m(time),e=s+dur(code);if(nowM>=s&&nowM<e){cur={time,code};break}if(nowM<s){nxt={time,code};break}}
  let status='',cls='';
  if(cur){const d=loadL(today,cur.time,cur.code);const tp=d.topic?` &#8212; ${d.topic.slice(0,20)}${d.topic.length>20?'&#8230;':''}`:'';const left=t2m(cur.time)+dur(cur.code)-nowM;status=`<strong>${cur.code}${tp}</strong> &middot; ${left}m left`;cls='now'}
  else if(nxt){const until=t2m(nxt.time)-nowM;if(until<=45){status=`<strong>${nxt.code}</strong> in ${until}m`;cls='soon'}else{status=`Next: <strong>${nxt.code}</strong> at ${nxt.time}`}}
  el.innerHTML=status;el.className=`clock-lesson${cls?' '+cls:''}`;
  updateTodayPanel();
  updateTimelineNow();
}

// TODAY PANEL
function updateTodayPanel(){
  const today=new Date();today.setHours(0,0,0,0);
  const now=new Date();const nowM=now.getHours()*60+now.getMinutes();
  const ds=today.toISOString().slice(0,10);
  const di=((today.getDay()||7)-1);
  const wt=wkT(monOf(today));
  document.getElementById('tpDateLbl').textContent=fmtF(today);
  const items=[];
  if(di>=0&&di<=5){
    for(const[time,code]of(TT[wt][di]||[])){
      if(isSt(code))continue;
      const data=loadL(today,time,code);
      const col=gCol(code);
      items.push({sM:t2m(time),eM:t2m(time)+dur(code),kind:'lesson',code,time,data,col,label:data.topic?`${code} &#8212; ${data.topic}`:code,sub:sn(code),cancelled:data.cancelled||false});
    }
  }
  for(const e of gEd(ds)){
    items.push({sM:t2m(e.start),eM:t2m(e.end),kind:e.type,label:e.title,sub:e.type==='event'?'Event':'Duty',col:e.type==='event'?'#b07800':'#1a6a78',cancelled:false,eId:e.id});
  }
  items.sort((a,b)=>a.sM-b.sM);
  const scroll=document.getElementById('tpScroll');scroll.innerHTML='';
  const todayDayNotes=gDayNotes(ds);
  if(!items.length&&!todayDayNotes.length){scroll.innerHTML='<div class="tp-empty">No lessons or events today.</div>';return}
  // Pinned day notes at top
  for(const dn of todayDayNotes){
    const el=document.createElement('div');el.className='dnote-card';el.style.marginBottom='.35rem';
    el.innerHTML=`<span class="dnote-icon">&#x1F4CC;</span><span class="dnote-text">${esc(dn.text)}</span>`;
    el.addEventListener('click',()=>openDnModal(ds,dn));
    scroll.appendChild(el);
  }
  if(!items.length)return;
  const track=document.createElement('div');track.className='tp-track';
  const fill=document.createElement('div');fill.className='tp-fill';
  const marker=document.createElement('div');marker.className='tp-now-marker';
  track.appendChild(fill);track.appendChild(marker);scroll.appendChild(track);
  const firstM=items[0].sM,lastM=items[items.length-1].eM;
  const span=Math.max(lastM-firstM,60);
  const pct=Math.max(0,Math.min(100,(nowM-firstM)/span*100));
  fill.style.height=`${pct}%`;marker.style.top=`${pct}%`;
  for(let i=0;i<items.length;i++){
    const it=items[i],prev=items[i-1];
    if(prev){const gap=it.sM-prev.eM;if(gap>=10){const g=document.createElement('div');g.className='tp-gap';g.textContent=gap>=60?`${Math.floor(gap/60)}h${gap%60?' '+gap%60+'m':''} free`:`${gap}m free`;scroll.appendChild(g)}}
    const isPast=it.eM<nowM,isNow=it.sM<=nowM&&it.eM>nowM;
    const el=document.createElement('div');el.className=`tp-item${isPast?' tp-past':''} ${isNow?' tp-now':''}`;
    if(it.cancelled)el.style.opacity='.38';
    const dotCol=it.cancelled?'#ccc':it.col;
    el.innerHTML=`<div class="tp-item-time">${m2t(it.sM)}</div><div class="tp-dot" style="background:${dotCol}"></div><div class="tp-body"><div class="tp-item-title">${it.label}${it.cancelled?' <span style="font-size:.56rem;color:var(--dim);font-weight:400">(cancelled)</span>':''}</div>${it.sub?`<div class="tp-item-sub">${esc(it.sub)}</div>`:''}<div class="tp-item-dur">${m2t(it.sM)}&#8211;${m2t(it.eM)} &middot; ${it.eM-it.sM}min</div></div>`;
    if(it.kind==='lesson'){el.style.cursor='pointer';el.addEventListener('click',()=>openModal(today,it.time,it.code))}
    scroll.appendChild(el);
  }
}

// VIEW SWITCHING
function showView(n,btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('visible'));
  document.querySelectorAll('.ntab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const map={week:'viewWeek',heatmap:'viewHeatmap',classes:'viewClasses',past:'viewPast',behaviour:'viewBehaviour',notes:'viewNotes',alllessons:'viewAllLessons'};
  document.getElementById(map[n]).classList.add('visible');
  if(n==='week'){renderWeek();updateTodayPanel()}
  if(n==='heatmap')renderHeatmap();
  if(n==='classes'){hideClassDetail();renderClasses()}
  if(n==='past')renderPast();
  if(n==='behaviour')renderBehView();
  if(n==='notes')renderNotes();
  if(n==='alllessons')renderAllLessons();
}

// WEEK NAVIGATION
function termWeeks(){if(!PDATA.termStart||!PDATA.termEnd)return 20;return Math.max(0,Math.floor((TERM_END-monOf(TERM_START))/604800000))}
function shiftWeek(d){weekOffset=Math.max(0,Math.min(weekOffset+d,termWeeks()));renderWeek();updateTodayPanel()}
function jumpToday(){const t=new Date();t.setHours(0,0,0,0);weekOffset=Math.max(0,Math.min(Math.round((monOf(t)-monOf(TERM_START))/604800000),termWeeks()));renderWeek();updateTodayPanel()}

// WEEK RENDER
function renderWeek(){
  const mon=curMon(),wt=wkT(mon),today=new Date();today.setHours(0,0,0,0);
  document.getElementById('wkChip').textContent=`Week ${wt}`;
  renderTermBanner();
  document.getElementById('wkRange').textContent=`${fmtS(mon)} â€“ ${fmtS(addD(mon,5))}`;
  const grid=document.getElementById('timetable');grid.innerHTML='';
  if(ttView==='time'){grid.style.display='block';grid.appendChild(renderTimeline(mon,wt,today));return}
  grid.style.display='';
  for(let di=0;di<=5;di++){
    const date=addD(mon,di),isToday=sameD(date,today);
    const col=document.createElement('div');col.className='day-col';
    const hd=document.createElement('div');hd.className=`day-hd${isToday?' today-hd':''}`;
    const ds_hd=addD(mon,di).toISOString().slice(0,10);
    hd.innerHTML=`<div class="day-hd-wrap"><div><div class="dn">${DAYS[di].slice(0,3)}</div><div class="dd">${fmtS(date)}</div></div><button class="day-add-note" title="Add day note" data-ds="${ds_hd}">&#x1F4CC;</button></div>`;
    hd.querySelector('.day-add-note').addEventListener('click',function(ev){ev.stopPropagation();openDnModal(this.dataset.ds)});
    col.appendChild(hd);
    if(date<TERM_START||date>TERM_END){const e=document.createElement('div');e.className='empty-day';e.textContent='Outside term';e.style.color='var(--dim)';col.appendChild(e);grid.appendChild(col);continue}
    const lessons=TT[wt][di]||[],ds=date.toISOString().slice(0,10);
    // Day notes pinned at top
    for(const dn of gDayNotes(ds)){
      const nc=document.createElement('div');nc.className='dnote-card';
      nc.innerHTML=`<span class="dnote-icon">&#x1F4CC;</span><span class="dnote-text">${esc(dn.text)}</span><button class="dnote-del" onclick="deleteDnInline(event,'${ds}','${dn.id}')" title="Remove">&#x2715;</button>`;
      nc.addEventListener('click',()=>openDnModal(ds,dn));
      col.appendChild(nc);
    }
    const edEntries=gEd(ds).sort((a,b)=>t2m(a.start)-t2m(b.start));
    const allItems=[...lessons.map(([time,code])=>({type:'lesson',time,code,sM:t2m(time)})),...edEntries.map(e=>({type:e.type,time:e.start,sM:t2m(e.start),entry:e}))].sort((a,b)=>a.sM-b.sM);
    if(!allItems.length&&!gDayNotes(ds).length){const e=document.createElement('div');e.className='empty-day';e.textContent='Free';col.appendChild(e);grid.appendChild(col);continue}
    for(const item of allItems){
      if(item.type==='lesson'){
        const{time,code}=item,study=isSt(code),data=study?{}:loadL(date,time,code),colour=gCol(code);
        const bg=data.cancelled?'#f0ede8':bl(colour,.09),bc=data.cancelled?'#d5cfc4':bl(colour,.26),ac=data.cancelled?'#c4beb4':colour,tc=dk(colour,.72);
        let prepDue=null;
        if(!study){const tk=`${ds}::${time}`;for(const p of gAllPrep(code))if(p.data.dueLessonKey===tk){prepDue=p;break}}
        const beh=study?[]:gBeh(code).filter(b=>b.lessonDate===ds&&b.lessonTime===time);
        const card=document.createElement('div');card.className=`lcard${study?' no-click':''} ${data.cancelled?' cancelled':''}`;
        card.style.cssText=`background:${bg};border-color:${bc};border-left-color:${ac}`;
        let h='';if(data.cancelled)h+='<div class="cstripe"></div>';
        h+=`<div class="lc-time">${time}</div><div class="lc-code" style="color:${data.cancelled?'var(--dim)':tc}">${code}</div><div class="lc-subj">${sn(code)}</div>`;
        if(data.cancelled){h+=`<div class="lc-cancelled">Cancelled${data.cancelReason?` &#8212; ${data.cancelReason}`:''}</div>`}
        else{
          if(data.topic)h+=`<div class="lc-topic">${esc(data.topic)}</div>`;
          const bs=[];if(prepDue)bs.push('<span class="lc-badge badge-prep">&#128203; Prep</span>');
          const w=beh.filter(b=>b.type==='verbal').length,d2=beh.filter(b=>b.type==='detention').length,p=beh.filter(b=>b.type==='praise').length;
          if(w)bs.push(`<span class="lc-badge badge-warn">&#9888; ${w}</span>`);
          if(d2)bs.push(`<span class="lc-badge badge-det">&#128308; ${d2}</span>`);
          if(p)bs.push(`<span class="lc-badge badge-praise">&#9733; ${p}</span>`);
          if(bs.length)h+=`<div class="lc-indicators">${bs.join('')}</div>`;
          if(data.topic||data.plan)h+='<div class="plan-dot"></div>';
          if(isPrepNight(wt,di,code))h+='<div class="prep-night-dot" title="Prep night"></div>';
        }
        card.innerHTML=h;if(!study)card.addEventListener('click',()=>openModal(date,time,code));col.appendChild(card);
      } else {
        const e=item.entry,card=document.createElement('div');
        card.className=`ecard ${e.type==='event'?'ev-card':'du-card'}`;
        const recurLbl=e._recurring?`<div class="ec-recur">&#x21bb; ${e._weeks==='all'?'Weekly':'Week '+e._weeks}</div>`:'';
        card.innerHTML=`<div class="ec-time">${e.start}&#8211;${e.end}</div><div class="ec-title">${esc(e.title)}</div><div class="ec-type">${e.type==='event'?'Event':'Duty'}</div>${recurLbl}<button class="ec-del" onclick="deleteEdEntry(event,'${ds}','${e.id}')" title="Remove">&#x2715;</button>`;
        card.addEventListener('click',()=>editEdEntry(ds,e));col.appendChild(card);
      }
    }
    grid.appendChild(col);
  }
}

// HEATMAP
function renderHeatmap(){
  const today=new Date();today.setHours(0,0,0,0);
  const container=document.getElementById('heatmap');container.innerHTML='';
  for(let w=0;w<=termWeeks();w++){
    const mon=addD(monOf(TERM_START),w*7),wt=wkT(mon);
    const row=document.createElement('div');row.className='hm-week';
    const lbl=document.createElement('div');lbl.className='hm-lbl';lbl.textContent=`Wk ${wt}\n${fmtS(mon)}`;lbl.style.whiteSpace='pre-line';row.appendChild(lbl);
    const days=document.createElement('div');days.className='hm-days';
    for(let di=0;di<=5;di++){
      const date=addD(mon,di);const dayCol=document.createElement('div');dayCol.className='hm-day';
      if(date<TERM_START||date>TERM_END){days.appendChild(dayCol);continue}
      const isToday=sameD(date,today);
      const hdr=document.createElement('div');hdr.className=`hm-day-hdr${isToday?' today-col':''}`;hdr.textContent=`${DAYS[di].slice(0,3)} ${fmtS(date)}`;dayCol.appendChild(hdr);
      const cells=document.createElement('div');cells.className='hm-cells';
      const ls=(TT[wt][di]||[]).filter(([,c])=>!isSt(c));
      if(!ls.length){const e=document.createElement('div');e.style.cssText='height:10px;font-size:.52rem;color:var(--dim);padding:0 .26rem;display:flex;align-items:center';e.textContent='â€“';cells.appendChild(e)}
      for(const[time,code]of ls){
        const data=loadL(date,time,code),colour=gCol(code),planned=!!(data.topic||data.plan);
        const cell=document.createElement('div');cell.className=`hcell${data.cancelled?' hcell-cancelled':planned?' hcell-planned':' hcell-empty'}`;
        cell.style.cssText=data.cancelled?'background:#f0e8e8;border-left-color:#c0a0a0;color:#b08080':planned?`background:${bl(colour,.2)};border-left-color:${colour};color:${dk(colour,.72)}`:' background:var(--parch);border-left-color:var(--border);color:var(--dim)';
        cell.textContent=data.topic?`${code} â€” ${data.topic.slice(0,15)}${data.topic.length>15?'â€¦':''}`:code;
        cell.addEventListener('click',()=>openModal(date,time,code));cells.appendChild(cell);
      }
      dayCol.appendChild(cells);days.appendChild(dayCol);
    }
    row.appendChild(days);container.appendChild(row);
  }
}

// CLASSES VIEW
function renderClasses(){
  const today=new Date();today.setHours(0,0,0,0);const grid=document.getElementById('classesGrid');grid.innerHTML='';
  for(const code of allC()){
    const colour=gCol(code),tc=dk(colour,.72),dates=datesFor(code);
    const taught=dates.filter(({date})=>date<today).length,remaining=dates.filter(({date})=>date>=today).length,total=dates.length;
    const pct=total?(taught/total)*100:0;
    const cancelled=dates.filter(({date,time})=>loadL(date,time,code).cancelled).length;
    let lastTopic='';for(const{date,time}of[...dates].filter(x=>x.date<today).reverse()){const d=loadL(date,time,code);if((d.topic||d.plan)&&!d.cancelled){lastTopic=d.topic||d.plan;break}}
    const card=document.createElement('div');card.className='ccard';card.style.borderLeftColor=colour;
    card.innerHTML=`<div class="cch"><div class="cc-code" style="color:${tc}">${code}</div><span class="ctag" style="background:${bl(colour,.11)};color:${tc};border:1px solid ${bl(colour,.28)}">${sn(code)}</span></div>
      <div class="cstats"><div><div class="csv">${remaining}</div><div class="csl">remaining</div></div><div><div class="csv">${taught}</div><div class="csl">taught</div></div><div><div class="csv">${total}</div><div class="csl">total</div></div>${cancelled?`<div><div class="csv" style="color:#c03030">${cancelled}</div><div class="csl">cancelled</div></div>`:''}</div>
      <div class="cbar"><div class="cbarf" style="background:${colour};width:${pct}%"></div></div>
      <div class="clast">${lastTopic?`<strong>Last covered</strong>${esc(lastTopic.slice(0,78))}${lastTopic.length>78?'&#8230;':''}`:`<em style="color:var(--dim)">No topics recorded yet</em>`}</div>`;
    card.addEventListener('click',()=>showClassDetail(code));
    grid.appendChild(card);
  }
}

// ALL LESSONS VIEW
function renderAllLessons(){
  const today=new Date();today.setHours(0,0,0,0);
  const container=document.getElementById('allLessonsContent');container.innerHTML='';
  if(!PDATA.termStart||!PDATA.termEnd){container.innerHTML='<div class="al-empty">Set term dates in Settings to see lessons.</div>';return}
  // Collect every lesson across all classes, keyed by date string
  const dayMap=new Map();
  let mon=monOf(TERM_START);
  while(mon<=TERM_END){
    const wt=wkT(mon);
    for(let di=0;di<=5;di++){
      const dt=addD(mon,di);
      if(dt<TERM_START||dt>TERM_END)continue;
      const slots=TT[wt]?.[di]||[];
      if(!slots.length)continue;
      const ds=dt.toISOString().slice(0,10);
      if(!dayMap.has(ds))dayMap.set(ds,{date:dt,wt,lessons:[]});
      for(const[time,code]of slots){
        if(isSt(code))continue;
        dayMap.get(ds).lessons.push({time,code});
      }
    }
    mon=addD(mon,7);
  }
  if(!dayMap.size){container.innerHTML='<div class="al-empty">No lessons found this term.</div>';return}
  // Sort days chronologically, lessons by time within each day
  const sortedDays=[...dayMap.values()].sort((a,b)=>a.date-b.date);
  let scrollTarget=null;
  for(const day of sortedDays){
    day.lessons.sort((a,b)=>t2m(a.time)-t2m(b.time));
    const isToday=sameD(day.date,today);
    const sec=document.createElement('div');sec.className='al-day';
    const hdr=document.createElement('div');hdr.className=`al-day-hdr${isToday?' today-al':''}`;
    hdr.innerHTML=`${fmtF(day.date)} <span class="al-wk">Week ${day.wt}</span>`;
    sec.appendChild(hdr);
    const list=document.createElement('div');list.className='al-list';
    for(const{time,code}of day.lessons){
      const d=loadL(day.date,time,code);
      const colour=gCol(code);
      const classes=['cd-lesson'];
      if(isToday)classes.push('is-today');
      if(d.cancelled)classes.push('cancelled');
      const hasPlan=!!(d.topic||d.plan);
      const el=document.createElement('div');el.className=classes.join(' ');el.style.borderLeftColor=colour;
      el.dataset.date=day.date.toISOString();el.dataset.time=time;el.dataset.code=code;
      el.innerHTML=`<div class="cd-ldate">${time}<div class="cd-ltime">${code} Â· ${sn(code)}</div></div>${d.cancelled?`<span class="cd-lcancel">Cancelled${d.cancelReason?' â€” '+esc(d.cancelReason):''}</span>`:`<div class="cd-ltopic">${d.topic?esc(d.topic):`<span style="color:var(--dim);font-style:italic;font-weight:400">No topic set</span>`}</div>`}${hasPlan&&!d.cancelled?'<div class="cd-ldot"></div>':''}`;
      el.addEventListener('click',()=>{const dt=new Date(el.dataset.date);dt.setHours(0,0,0,0);openModal(dt,el.dataset.time,el.dataset.code)});
      list.appendChild(el);
    }
    sec.appendChild(list);
    container.appendChild(sec);
    if(isToday)scrollTarget=sec;
  }
  if(scrollTarget)scrollTarget.scrollIntoView({behavior:'smooth',block:'start'});
}

// PAST VIEW
function renderPast(){
  const today=new Date();today.setHours(0,0,0,0);const container=document.getElementById('pastContent');container.innerHTML='';
  for(const code of allC()){
    const colour=gCol(code),past=datesFor(code).filter(({date})=>date<today).reverse();
    const sec=document.createElement('div');sec.className='psec';
    sec.innerHTML=`<div class="ptitle"><span class="pdot" style="background:${colour}"></span>${code} <span style="color:var(--soft);font-weight:400;font-size:.72rem">${sn(code)}</span></div>`;
    if(!past.length){sec.innerHTML+='<div class="no-entries">No lessons yet this term.</div>'}
    else{
      let any=false;
      for(const{date,time}of past){const d=loadL(date,time,code);if(!d.topic&&!d.plan&&!d.cancelled)continue;any=true;
        const e=document.createElement('div');e.className='pentry';
        e.innerHTML=`<div class="pdate">${fmtF(date)}<br>${time}</div>${d.cancelled?`<span class="pcancel-tag">Cancelled${d.cancelReason?` &#8212; ${d.cancelReason}`:''}</span>`:`<div class="ptext">${d.topic?`<div class="ptopic-lbl">${esc(d.topic)}</div>`:''} ${d.plan?`<div>${esc(d.plan).replace(/\n/g,'<br>')}</div>`:''}</div>`}`;
        sec.appendChild(e);
      }
      if(!any)sec.innerHTML+='<div class="no-entries">No plans recorded yet.</div>';
    }
    container.appendChild(sec);
  }
}

// BEHAVIOUR VIEW
function setBehFilter(f,btn){behFilter=f;document.querySelectorAll('.beh-filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBehView()}
function renderBehView(){
  const container=document.getElementById('behContent');container.innerHTML='';
  for(const code of allC()){
    const colour=gCol(code);let entries=[...gBeh(code)].reverse();if(behFilter!=='all')entries=entries.filter(e=>e.type===behFilter);
    const sec=document.createElement('div');sec.className='beh-class-section';
    sec.innerHTML=`<div class="beh-class-title"><span class="pdot" style="background:${colour}"></span>${code} <span style="color:var(--soft);font-weight:400;font-size:.72rem">${sn(code)}</span></div>`;
    if(!entries.length){sec.innerHTML+=`<div class="beh-empty">No entries${behFilter!=='all'?' of this type':''} recorded.</div>`}
    else{
      const list=document.createElement('div');list.className='beh-entries';
      for(const e of entries){
        const el=document.createElement('div');el.className='beh-entry';
        el.innerHTML=`<div class="beh-entry-left"><div class="beh-sname">${esc(e.student)}</div><div class="beh-date">${e.lessonDate} &middot; ${e.lessonTime}</div></div><span class="beh-type-badge type-${e.type}">${typeLbl(e.type)}</span><div class="beh-note">${e.note?esc(e.note):'<em style="color:var(--dim)">No note</em>'}</div><button class="beh-del" onclick="delBeh('${code}','${e.id}')">&#x2715;</button>`;
        list.appendChild(el);
      }
      sec.appendChild(list);
    }
    container.appendChild(sec);
  }
}
function delBeh(code,id){sBeh(code,gBeh(code).filter(e=>e.id!==id));renderBehView();if(activeModal&&activeModal.code===code)populateBehLog()}

// QUICK NOTES
function renderNotes(){
  const grid=document.getElementById('qnGrid');grid.innerHTML='';
  for(const code of allC()){
    const colour=gCol(code),tc=dk(colour,.72);
    const card=document.createElement('div');card.className='qn-card';card.style.borderLeftColor=colour;
    card.innerHTML=`<div class="qn-hdr"><span class="pdot" style="background:${colour}"></span><span class="qn-code" style="color:${tc}">${code}</span><span class="qn-subj">${sn(code)}</span></div><textarea class="qn-ta" placeholder="Notes, reminders, to-dos for ${code}&#8230;" data-code="${code}">${esc(gQNote(code))}</textarea><div class="qn-footer"><span class="qn-saved">Saved &#x2713;</span><button class="qn-save-btn" onclick="saveQNBtn(this,'${code}')">Save</button></div>`;
    card.querySelector('.qn-ta').addEventListener('blur',function(){saveQNBtn(card.querySelector('.qn-save-btn'),code,this)});
    grid.appendChild(card);
  }
}
function saveQNBtn(btn,code,ta){const t=ta||btn.closest('.qn-card').querySelector('.qn-ta');sQNote(code,t.value);const m=btn.closest('.qn-footer').querySelector('.qn-saved');m.classList.add('show');setTimeout(()=>m.classList.remove('show'),1800)}

// ED MODAL
function openEdModal(type,prefillDs){
  edType=type;edEditId=null;edEditDs=null;edEditRecurring=false;
  document.getElementById('edTitleTxt').textContent=type==='event'?'Add Event':'Add Duty';
  setEdType(type);document.getElementById('edTitleIn').value='';document.getElementById('edStart').value='09:00';document.getElementById('edEnd').value='10:00';
  document.getElementById('edDeleteBtn').style.display='none';
  setEdRecur('once');
  const mon=curMon(),sel=document.getElementById('edDay');sel.innerHTML='';
  for(let di=0;di<=5;di++){const date=addD(mon,di);const opt=document.createElement('option');opt.value=date.toISOString().slice(0,10);opt.textContent=`${DAYS[di]} ${fmtS(date)}`;if(prefillDs&&date.toISOString().slice(0,10)===prefillDs)opt.selected=true;sel.appendChild(opt)}
  document.getElementById('edOverlay').classList.add('open');setTimeout(()=>document.getElementById('edTitleIn').focus(),200);
}
function editEdEntry(ds,e){
  edType=e.type;edEditId=e.id;edEditDs=ds;edEditRecurring=!!e._recurring;
  document.getElementById('edTitleTxt').textContent=e.type==='event'?'Edit Event':'Edit Duty';
  setEdType(e.type);document.getElementById('edTitleIn').value=e.title;document.getElementById('edStart').value=e.start;document.getElementById('edEnd').value=e.end;
  document.getElementById('edDeleteBtn').style.display='inline-flex';
  setEdRecur(e._recurring?e._weeks:'once');
  const mon=curMon(),sel=document.getElementById('edDay');sel.innerHTML='';
  for(let di=0;di<=5;di++){const date=addD(mon,di);const opt=document.createElement('option');opt.value=date.toISOString().slice(0,10);opt.textContent=`${DAYS[di]} ${fmtS(date)}`;if(date.toISOString().slice(0,10)===ds)opt.selected=true;sel.appendChild(opt)}
  document.getElementById('edOverlay').classList.add('open');
}
function setEdType(type){
  edType=type;
  document.getElementById('edTypeEv').className=`ed-type-btn${type==='event'?' sel-ev':''}`;
  document.getElementById('edTypeDu').className=`ed-type-btn${type==='duty'?' sel-du':''}`;
}
function setEdRecur(v,btn){
  edRecur=v;
  document.querySelectorAll('.ed-recur-btn').forEach(b=>{b.classList.remove('active');if(b.dataset.recur===v)b.classList.add('active')});
}
function saveEdEntry(){
  const title=document.getElementById('edTitleIn').value.trim();if(!title){alert('Please enter a title.');return}
  const ds=document.getElementById('edDay').value;
  const start=document.getElementById('edStart').value;
  const end=document.getElementById('edEnd').value;
  if(t2m(end)<=t2m(start)){alert('End time must be after start time.');return}
  const id=edEditId||Date.now().toString(36)+Math.random().toString(36).slice(2,5);
  const selDate=new Date(ds+'T00:00:00');
  const dayIdx=((selDate.getDay()||7)-1);
  // Remove old entry from wherever it lived
  if(edEditId){
    if(edEditRecurring){PDATA.recurringEvents=(PDATA.recurringEvents||[]).filter(r=>r.id!==edEditId)}
    else{if(edEditDs){const old=(PDATA.events[edEditDs]||[]).filter(e=>e.id!==edEditId);if(old.length)PDATA.events[edEditDs]=old;else delete PDATA.events[edEditDs]}}
  }
  if(edRecur==='once'){
    const entries=(PDATA.events[ds]||[]).filter(e=>e.id!==id);
    entries.push({id,type:edType,title,start,end});
    PDATA.events[ds]=entries;
  } else {
    if(!PDATA.recurringEvents)PDATA.recurringEvents=[];
    PDATA.recurringEvents.push({id,type:edType,title,start,end,day:dayIdx,weeks:edRecur});
  }
  scheduleSave();
  closeEdModal();renderWeek();updateTodayPanel();
}
function deleteEdEntry(evObj,ds,id){
  if(evObj)evObj.stopPropagation();
  const targetDs=ds||edEditDs;
  const targetId=id||edEditId;
  const isRec=(PDATA.recurringEvents||[]).some(r=>r.id===targetId);
  if(isRec){
    // From inline X (ds provided) â†’ just skip this date
    // From modal Delete button (ds is falsy) â†’ ask
    let deleteAll=false;
    if(!ds){deleteAll=confirm('Delete ALL occurrences of this recurring event?\n\nOK = delete all\nCancel = remove just this date')}
    if(deleteAll){
      PDATA.recurringEvents=(PDATA.recurringEvents||[]).filter(r=>r.id!==targetId);
      for(const k of Object.keys(PDATA.events)){if(k.startsWith('_del_')){PDATA.events[k]=(PDATA.events[k]||[]).filter(i=>i!==targetId);if(!PDATA.events[k].length)delete PDATA.events[k]}}
    } else {
      const delKey='_del_'+targetDs;
      if(!PDATA.events[delKey])PDATA.events[delKey]=[];
      if(!PDATA.events[delKey].includes(targetId))PDATA.events[delKey].push(targetId);
    }
    scheduleSave();
  } else {
    const entries=(PDATA.events[targetDs]||[]).filter(e=>e.id!==targetId);
    if(entries.length)PDATA.events[targetDs]=entries;else delete PDATA.events[targetDs];
    scheduleSave();
  }
  if(!ds)closeEdModal();
  renderWeek();updateTodayPanel();
}
function closeEdModal(){document.getElementById('edOverlay').classList.remove('open')}
function edBgClick(e){if(e.target===document.getElementById('edOverlay'))closeEdModal()}

// â”€â”€â”€ DAY NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let dnEditDs=null,dnEditId=null;
function openDnModal(ds,existingNote){
  dnEditDs=ds;
  if(existingNote){
    dnEditId=existingNote.id;
    document.getElementById('dnTitleTxt').textContent='Edit Day Note';
    document.getElementById('dnTextIn').value=existingNote.text;
    document.getElementById('dnDeleteBtn').style.display='inline-flex';
  } else {
    dnEditId=null;
    document.getElementById('dnTitleTxt').textContent='Add Day Note';
    document.getElementById('dnTextIn').value='';
    document.getElementById('dnDeleteBtn').style.display='none';
  }
  document.getElementById('dnOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('dnTextIn').focus(),200);
}
function saveDnEntry(){
  const text=document.getElementById('dnTextIn').value.trim();
  if(!text){alert('Please enter a note.');return}
  const notes=gDayNotes(dnEditDs);
  if(dnEditId){
    const n=notes.find(n=>n.id===dnEditId);
    if(n)n.text=text;
  } else {
    const id=Date.now().toString(36)+Math.random().toString(36).slice(2,5);
    notes.push({id,text});
  }
  sDayNotes(dnEditDs,notes);
  closeDnModal();renderWeek();updateTodayPanel();
}
function deleteDnEntry(){
  if(!dnEditId)return;
  const notes=gDayNotes(dnEditDs).filter(n=>n.id!==dnEditId);
  if(notes.length)sDayNotes(dnEditDs,notes);else{delete PDATA.dayNotes[dnEditDs];scheduleSave()}
  closeDnModal();renderWeek();updateTodayPanel();
}
function deleteDnInline(ev,ds,id){
  ev.stopPropagation();
  const notes=gDayNotes(ds).filter(n=>n.id!==id);
  if(notes.length)sDayNotes(ds,notes);else{delete PDATA.dayNotes[ds];scheduleSave()}
  renderWeek();updateTodayPanel();
}
function closeDnModal(){document.getElementById('dnOverlay').classList.remove('open')}
function dnBgClick(e){if(e.target===document.getElementById('dnOverlay'))closeDnModal()}

// LESSON MODAL
function openModal(date,time,code){
  activeModal={date,time,code};selBehType='';editPrepKey=null;
  const today=new Date();today.setHours(0,0,0,0);
  const colour=gCol(code),tc=dk(colour,.72);
  document.getElementById('mName').textContent=`${code} â€” ${sn(code)}`;document.getElementById('mName').style.color=tc;
  document.getElementById('mMeta').textContent=`${fmtF(date)} Â· ${time} Â· ${dur(code)}min`;
  const all=datesFor(code),taught=all.filter(({date:d})=>d<today).length,remaining=all.filter(({date:d})=>d>=today).length,total=all.length;
  document.getElementById('mRem').textContent=remaining;document.getElementById('mRemLabel').textContent=`${remaining} lesson${remaining!==1?'s':''} remaining`;document.getElementById('mTaughtLabel').textContent=`${taught} taught this term`;
  const fill=document.getElementById('mBarFill');fill.style.width=`${total?(taught/total)*100:0}%`;fill.style.background=colour;
  const ds=date.toISOString().slice(0,10),thisKey=`${ds}::${time}`;
  let prepDue=null;for(const p of gAllPrep(code))if(p.data.dueLessonKey===thisKey){prepDue=p;break}
  const pw=document.getElementById('prepDueBannerWrap'),cw=document.getElementById('prepCollectWrap');
  if(prepDue){
    pw.style.display='block';document.getElementById('prepDueBanner').innerHTML=`<div class="prep-due-title">&#128203; Prep due this lesson</div><div class="prep-due-text">${esc(prepDue.data.desc)}</div><div class="prep-due-sub">Set ${prepDue.data.setDisplay||'previously'}</div>`;
    const cs=prepDue.data.collectStatus||'';
    cw.innerHTML=`<div class="prep-collect-wrap"><div class="prep-collect-lbl">Collection status</div><div class="prep-collect-btns"><button class="pcbtn${cs==='in'?' ai':''}" onclick="setPrepCollect('${prepDue.key}','in',this)">&#x2713; All in</button><button class="pcbtn${cs==='partial'?' ap':''}" onclick="setPrepCollect('${prepDue.key}','partial',this)">~ Partial</button><button class="pcbtn${cs==='missing'?' am':''}" onclick="setPrepCollect('${prepDue.key}','missing',this)">&#x2715; Not in</button></div></div>`;
  } else {pw.style.display='none';cw.innerHTML=''}
  const idx=all.findIndex(x=>sameD(x.date,date)&&x.time===time);
  const setPrevNext=(de,to,te,entry)=>{if(entry){document.getElementById(de).textContent=`${fmtF(entry.date)} Â· ${entry.time}`;const d=loadL(entry.date,entry.time,code);document.getElementById(to).textContent=d.topic||'';document.getElementById(to).style.display=d.topic?'block':'none';document.getElementById(te).innerHTML=d.cancelled?`<em>Cancelled${d.cancelReason?` â€” ${d.cancelReason}`:''}</em>`:(d.plan?esc(d.plan).replace(/\n/g,'<br>'):`<span class="pn-empty">No notes recorded</span>`)}else{document.getElementById(de).textContent='â€”';document.getElementById(to).style.display='none';document.getElementById(te).innerHTML=`<span class="pn-empty">${idx===0?'First lesson of term':'Last lesson of term'}</span>`}};
  setPrevNext('mPrevDate','mPrevTopic','mPrevText',idx>0?all[idx-1]:null);
  setPrevNext('mNextDate','mNextTopic','mNextText',idx<all.length-1?all[idx+1]:null);
  const data=loadL(date,time,code);
  document.getElementById('mTopic').value=data.topic||'';document.getElementById('mPlan').value=data.plan||'';
  const tgl=document.getElementById('cancelTgl');tgl.checked=data.cancelled||false;document.getElementById('cancelReason').value=data.cancelReason||'';document.getElementById('cancelReasonWrap').classList.toggle('open',tgl.checked);
  renderResources();
  populatePrepPane(date,time,code);populateBehLog();populateBehForm(code);
  document.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.modal-pane').forEach(p=>p.classList.remove('active'));document.querySelector('.modal-tab').classList.add('active');document.getElementById('paneplan').classList.add('active');
  document.getElementById('savedMsg').classList.remove('show');document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('mTopic').focus(),200);
}
function closeModal(){document.getElementById('overlay').classList.remove('open');activeModal=null}
function bgClick(e){if(e.target===document.getElementById('overlay'))closeModal()}
function switchTab(n,btn){document.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.modal-pane').forEach(p=>p.classList.remove('active'));btn.classList.add('active');document.getElementById(`pane${n}`).classList.add('active')}
function toggleCancel(){document.getElementById('cancelReasonWrap').classList.toggle('open',document.getElementById('cancelTgl').checked)}
function saveLesson(){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const prev=loadL(date,time,code);
  saveL(date,time,code,{topic:document.getElementById('mTopic').value.trim(),plan:document.getElementById('mPlan').value,cancelled:document.getElementById('cancelTgl').checked,cancelReason:document.getElementById('cancelReason').value.trim(),resources:prev.resources||[]});
  const msg=document.getElementById('savedMsg');msg.classList.add('show');setTimeout(()=>msg.classList.remove('show'),2200);
  renderWeek();updateTodayPanel();updateClock();
  if(classDetailCode)renderClassDetail(classDetailCode);
}
function renderResources(){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const data=loadL(date,time,code),res=data.resources||[];
  const wrap=document.getElementById('mResources');wrap.innerHTML='';
  for(let i=0;i<res.length;i++){
    const r=res[i],el=document.createElement('div');el.className='res-item';
    let domain='';try{domain=new URL(r.url).hostname.replace('www.','')}catch(e){}
    el.innerHTML=`<a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title)}<span class="res-domain">${esc(domain)}</span></a><button class="res-del" onclick="removeResource(${i})" title="Remove">&#x2715;</button>`;
    wrap.appendChild(el);
  }
}
function addResource(){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const title=document.getElementById('resTitle').value.trim(),url=document.getElementById('resUrl').value.trim();
  if(!title||!url)return;
  const data=loadL(date,time,code);if(!data.resources)data.resources=[];
  data.resources.push({title,url});saveL(date,time,code,data);
  document.getElementById('resTitle').value='';document.getElementById('resUrl').value='';
  renderResources();
}
function removeResource(idx){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const data=loadL(date,time,code);if(!data.resources)return;
  data.resources.splice(idx,1);saveL(date,time,code,data);
  renderResources();
}

// PREP PANE
function populatePrepPane(date,time,code){
  const setKey=`${date.toISOString().slice(0,10)}::${time}`;
  const existing=gAllPrep(code).filter(p=>p.data.setKey===setKey);
  const wrap=document.getElementById('prepExistingWrap');wrap.innerHTML='';
  for(const p of existing){
    const box=document.createElement('div');box.className='prep-existing';
    box.innerHTML=`<div class="prep-existing-lbl">Prep set this lesson</div><div class="prep-existing-text">${esc(p.data.desc)}</div><div class="prep-existing-due">Due: ${p.data.dueDisplay||'&#8212;'}</div><div class="prep-existing-actions"><button class="prep-small-btn" onclick="editPrep('${p.key}')">Edit</button><button class="prep-small-btn danger" onclick="deletePrep('${p.key}','${code}')">Remove</button></div>`;
    wrap.appendChild(box);
  }
  document.getElementById('prepFormTitle').textContent=existing.length?'Set another prep':'Set prep for this lesson';
  const sel=document.getElementById('prepDueLesson');sel.innerHTML='<option value="">Select a lesson&#8230;</option>';
  for(const{date:d,time:t}of datesFor(code).filter(({date:dd})=>dd>date)){
    const opt=document.createElement('option');opt.value=`${d.toISOString().slice(0,10)}::${t}`;opt.textContent=`${fmtF(d)} &middot; ${t}`;sel.appendChild(opt);
  }
  if(!editPrepKey){document.getElementById('prepDesc').value='';sel.value=''}
}
function savePrep(){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const desc=document.getElementById('prepDesc').value.trim();const sel=document.getElementById('prepDueLesson');const dueLessonKey=sel.value;const dueDisplay=sel.options[sel.selectedIndex]?.text||'';
  if(!desc){alert('Please enter a description.');return}if(!dueLessonKey){alert('Please select a due lesson.');return}
  const setKey=`${date.toISOString().slice(0,10)}::${time}`;const sk=editPrepKey||`${code}::${setKey}::${Date.now()}`;
  if(!PDATA.prep)PDATA.prep={};
  const ex=editPrepKey?(PDATA.prep[editPrepKey]||{}):{};
  PDATA.prep[sk]={...ex,desc,dueLessonKey,dueDisplay,setKey,setDisplay:`${fmtF(date)} &middot; ${time}`,code};
  scheduleSave();
  editPrepKey=null;populatePrepPane(date,time,code);renderWeek();document.getElementById('prepDesc').value='';document.getElementById('prepDueLesson').value='';
}
function editPrep(key){const d=PDATA.prep[key]||{};editPrepKey=key;document.getElementById('prepDesc').value=d.desc||'';document.getElementById('prepDueLesson').value=d.dueLessonKey||'';document.getElementById('prepFormTitle').textContent='Edit prep';document.getElementById('prepDesc').focus()}
function deletePrep(key,code){delete PDATA.prep[key];scheduleSave();if(activeModal&&activeModal.code===code)populatePrepPane(activeModal.date,activeModal.time,code);renderWeek()}
function setPrepCollect(key,status,btn){const d=PDATA.prep[key]||{};const ns=d.collectStatus===status?'':status;d.collectStatus=ns;PDATA.prep[key]=d;scheduleSave();btn.closest('.prep-collect-btns').querySelectorAll('.pcbtn').forEach(b=>b.classList.remove('ai','ap','am'));if(ns)btn.classList.add({in:'ai',partial:'ap',missing:'am'}[ns]);renderWeek()}

// BEHAVIOUR PANE
function populateBehLog(){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const ds=date.toISOString().slice(0,10),log=gBeh(code).filter(e=>e.lessonDate===ds&&e.lessonTime===time);
  const list=document.getElementById('behLogList');list.innerHTML='';
  if(!log.length){const e=document.createElement('div');e.className='no-entries';e.textContent='No entries for this lesson.';list.appendChild(e);return}
  for(const e of log){const el=document.createElement('div');el.className='beh-log-entry';el.innerHTML=`<div class="beh-log-left"><div class="beh-log-name">${esc(e.student)}</div><span class="beh-type-badge type-${e.type}" style="font-size:.52rem">${typeLbl(e.type)}</span></div><div style="flex:1;font-size:.7rem;color:var(--mid)">${e.note?esc(e.note):'<em style="color:var(--dim)">No note</em>'}</div><button class="beh-log-del" onclick="delBeh('${code}','${e.id}')">&#x2715;</button>`;list.appendChild(el)}
}
function populateBehForm(code){
  const roster=gRoster(code),sel=document.getElementById('behStudent'),nm=document.getElementById('noStudentsMsg'),sw=document.getElementById('studentSelectWrap');
  sel.innerHTML='<option value="">Select student&#8230;</option>';
  if(!roster.length){nm.style.display='block';sw.style.display='none'}
  else{nm.style.display='none';sw.style.display='block';for(const n of roster){const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o)}}
  selBehType='';document.querySelectorAll('.beh-type-btn').forEach(b=>b.className='beh-type-btn');document.getElementById('behNote').value='';
}
function selBehT(type,btn){selBehType=type;document.querySelectorAll('.beh-type-btn').forEach(b=>b.classList.remove('sv','sd','sp','sn'));btn.classList.add({verbal:'sv',detention:'sd',praise:'sp',note:'sn'}[type])}
function addBehEntry(){
  if(!activeModal)return;const{date,time,code}=activeModal;
  const student=document.getElementById('behStudent').value.trim(),note=document.getElementById('behNote').value.trim();
  if(!student){alert('Please select a student.');return}if(!selBehType){alert('Please select a type.');return}
  const log=gBeh(code);log.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,5),student,type:selBehType,note,lessonDate:date.toISOString().slice(0,10),lessonTime:time});
  sBeh(code,log);populateBehLog();document.getElementById('behStudent').value='';document.getElementById('behNote').value='';selBehType='';document.querySelectorAll('.beh-type-btn').forEach(b=>b.className='beh-type-btn');renderWeek();
}

// SETTINGS
function openSettings(){renderTermPeriodRows();renderColourRows();renderRosterRows();document.getElementById('settingsOverlay').classList.add('open')}
function closeSettings(){document.getElementById('settingsOverlay').classList.remove('open')}
function settingsBgClick(e){if(e.target===document.getElementById('settingsOverlay'))closeSettings()}
function renderColourRows(){
  const stored=PDATA.classColours||{};const container=document.getElementById('colourRows');container.innerHTML='';
  for(const code of allC()){
    const colour=stored[code]||DCOLS[code]||'#888888';const row=document.createElement('div');row.className='colour-row';
    row.innerHTML=`<span class="colour-swatch" id="sw-${code}" style="background:${colour}"></span><span class="colour-code" id="swtxt-${code}" style="color:${dk(colour,.7)}">${code}</span><span class="colour-name">${sn(code)}</span><div class="colour-preview" id="swprev-${code}" style="background:${bl(colour,.11)};border-left-color:${colour};color:${dk(colour,.72)}">${sn(code)}</div><input type="color" class="colour-input" value="${colour}" oninput="liveCol('${code}',this.value)">`;
    container.appendChild(row);
  }
}
function liveCol(code,hex){
  PDATA.classColours[code]=hex;scheduleSave();
  const sw=document.getElementById(`sw-${code}`),txt=document.getElementById(`swtxt-${code}`),prev=document.getElementById(`swprev-${code}`);
  if(sw)sw.style.background=hex;if(txt)txt.style.color=dk(hex,.7);if(prev){prev.style.background=bl(hex,.11);prev.style.borderLeftColor=hex;prev.style.color=dk(hex,.72)}
  const av=document.querySelector('.view.visible')?.id;if(av==='viewWeek')renderWeek();if(av==='viewClasses')renderClasses();if(av==='viewHeatmap')renderHeatmap();
}
function renderRosterRows(){
  const container=document.getElementById('rosterRows');container.innerHTML='';
  for(const code of allC()){
    const roster=gRoster(code);const row=document.createElement('div');row.className='roster-row';
    row.innerHTML=`<div class="roster-header" onclick="toggleRoster(this)"><span class="roster-class-label">${code} <span style="color:var(--soft);font-weight:400;font-size:.76rem">${sn(code)}</span></span><span class="roster-toggle">&#x25BC;</span></div><div class="roster-content"><textarea class="roster-ta" rows="4" placeholder="One name per line&#10;e.g. Alice Smith&#10;Ben Jones">${roster.join('\n')}</textarea><div class="roster-hint">One name per line.</div><div style="display:flex;align-items:center;gap:.42rem"><button class="roster-save-btn" onclick="saveRosterRow(this,'${code}')">Save</button><span class="roster-saved">Saved &#x2713;</span></div></div>`;
    container.appendChild(row);
  }
}
function toggleRoster(hdr){hdr.nextElementSibling.classList.toggle('open');hdr.querySelector('.roster-toggle').classList.toggle('open')}
function saveRosterRow(btn,code){const ta=btn.closest('.roster-content').querySelector('.roster-ta');sRoster(code,ta.value.split('\n').map(s=>s.trim()).filter(Boolean));const m=btn.nextElementSibling;m.classList.add('show');setTimeout(()=>m.classList.remove('show'),2000)}

// SEARCH
function openSearch(){
  document.getElementById('searchOverlay').classList.add('open');
  const inp=document.getElementById('searchInput');inp.value='';inp.focus();
  document.getElementById('searchResults').innerHTML='<div class="search-empty">Start typing to search across all lessons</div>';
}
function closeSearch(){document.getElementById('searchOverlay').classList.remove('open')}
function searchBgClick(e){if(e.target===document.getElementById('searchOverlay'))closeSearch()}
document.getElementById('searchInput').addEventListener('input',function(){
  const q=this.value.trim().toLowerCase();const container=document.getElementById('searchResults');
  if(!q){container.innerHTML='<div class="search-empty">Start typing to search across all lessons</div>';return}
  if(q.length<2){container.innerHTML='<div class="search-empty">Type at least 2 characters</div>';return}
  const results=[];
  for(const code of allC()){
    for(const{date,time}of datesFor(code)){
      const d=loadL(date,time,code);
      const fields=[(d.topic||''),(d.plan||''),(d.cancelReason||'')];
      if(d.resources)for(const r of d.resources)fields.push(r.title||'',r.url||'');
      const combined=fields.join(' ');
      if(combined.toLowerCase().includes(q)){
        let matchText='';
        for(const f of fields){if(f.toLowerCase().includes(q)){matchText=f;break}}
        results.push({code,date,time,topic:d.topic||'',matchText,cancelled:d.cancelled});
      }
    }
  }
  if(!results.length){container.innerHTML='<div class="search-empty">No results found</div>';return}
  results.sort((a,b)=>b.date-a.date);
  container.innerHTML='';
  for(const r of results.slice(0,40)){
    const colour=gCol(r.code);
    const el=document.createElement('div');el.className='search-result';
    let snippet=r.matchText;
    const idx=snippet.toLowerCase().indexOf(q);
    if(snippet.length>100){
      const start=Math.max(0,idx-40);const end=Math.min(snippet.length,idx+q.length+40);
      snippet=(start>0?'â€¦':'')+snippet.slice(start,end)+(end<r.matchText.length?'â€¦':'');
    }
    const highlighted=esc(snippet).replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark>$1</mark>');
    el.innerHTML=`<div class="sr-color" style="background:${colour}"></div><div class="sr-body"><div class="sr-head"><span class="sr-code" style="color:${dk(colour,.72)}">${r.code}</span><span class="sr-date">${fmtF(r.date)} Â· ${r.time}</span></div>${r.topic?`<div class="sr-topic">${esc(r.topic)}</div>`:''}<div class="sr-match">${highlighted}</div></div>`;
    el.addEventListener('click',()=>{closeSearch();openModal(r.date,r.time,r.code)});
    container.appendChild(el);
  }
});

// CLASS DETAIL VIEW
let classDetailCode=null;
function showClassDetail(code){
  classDetailCode=code;
  const grid=document.getElementById('classesGrid');grid.style.display='none';
  const detail=document.getElementById('classDetail');detail.style.display='block';
  renderClassDetail(code);
}
function hideClassDetail(){
  classDetailCode=null;
  document.getElementById('classDetail').style.display='none';
  document.getElementById('classesGrid').style.display='';
}
function renderClassDetail(code){
  const today=new Date();today.setHours(0,0,0,0);
  const colour=gCol(code),tc=dk(colour,.72),dates=datesFor(code);
  const taught=dates.filter(({date})=>date<today).length,remaining=dates.filter(({date})=>date>=today).length,total=dates.length;
  const cancelled=dates.filter(({date,time})=>loadL(date,time,code).cancelled).length;
  const detail=document.getElementById('classDetail');
  let html=`<button class="cd-back" onclick="hideClassDetail()">&#8592; Back to all classes</button>`;
  html+=`<div class="cd-header"><div class="cd-dot" style="background:${colour}"></div><span class="cd-title" style="color:${tc}">${code}</span><span class="cd-subj">${sn(code)}</span></div>`;
  html+=`<div class="cd-stats"><div><div class="cd-stat-val">${remaining}</div><div class="cd-stat-lbl">remaining</div></div><div><div class="cd-stat-val">${taught}</div><div class="cd-stat-lbl">taught</div></div><div><div class="cd-stat-val">${total}</div><div class="cd-stat-lbl">total</div></div>${cancelled?`<div><div class="cd-stat-val" style="color:#c03030">${cancelled}</div><div class="cd-stat-lbl">cancelled</div></div>`:''}</div>`;
  const upcoming=dates.filter(({date})=>date>=today);
  const past=dates.filter(({date})=>date<today).reverse();
  html+=`<div class="cd-list">`;
  function renderLessonRow(date,time){
    const d=loadL(date,time,code);const isToday=sameD(date,today);
    const classes=['cd-lesson'];
    if(isToday)classes.push('is-today');
    if(d.cancelled)classes.push('cancelled');
    const hasPlan=!!(d.topic||d.plan);
    html+=`<div class="${classes.join(' ')}" style="border-left-color:${colour}" data-date="${date.toISOString()}" data-time="${time}" data-code="${code}">`;
    html+=`<div class="cd-ldate">${fmtF(date)}<div class="cd-ltime">${time}</div></div>`;
    if(d.cancelled){html+=`<span class="cd-lcancel">Cancelled</span>`}
    else{html+=`<div class="cd-ltopic">${d.topic?esc(d.topic):`<span style="color:var(--dim);font-style:italic;font-weight:400">No topic set</span>`}</div>`}
    if(hasPlan&&!d.cancelled)html+=`<div class="cd-ldot"></div>`;
    html+=`</div>`;
  }
  if(upcoming.length){html+=`<div class="cd-divider">Upcoming (${upcoming.length})</div>`;for(const{date,time}of upcoming)renderLessonRow(date,time)}
  if(past.length){html+=`<div class="cd-divider">Past (${past.length})</div>`;for(const{date,time}of past)renderLessonRow(date,time)}
  html+=`</div>`;
  detail.innerHTML=html;
  detail.querySelectorAll('.cd-lesson').forEach(el=>{
    el.addEventListener('click',()=>{
      const dt=new Date(el.dataset.date);dt.setHours(0,0,0,0);
      openModal(dt,el.dataset.time,el.dataset.code);
    });
  });
  // Scroll to today or first upcoming
  const todayEl=detail.querySelector('.cd-lesson.is-today');
  if(todayEl)todayEl.scrollIntoView({behavior:'smooth',block:'center'});
}

// KEYBOARD
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){if(document.getElementById('searchOverlay').classList.contains('open'))closeSearch();else if(document.getElementById('dnOverlay').classList.contains('open'))closeDnModal();else if(document.getElementById('overlay').classList.contains('open'))closeModal();else if(document.getElementById('edOverlay').classList.contains('open'))closeEdModal();else if(document.getElementById('settingsOverlay').classList.contains('open'))closeSettings();else if(classDetailCode)hideClassDetail()}
  if((e.key==='s'||e.key==='S')&&(e.ctrlKey||e.metaKey)&&document.getElementById('overlay').classList.contains('open')){e.preventDefault();saveLesson()}
  if((e.key==='k'||e.key==='K')&&(e.ctrlKey||e.metaKey)){e.preventDefault();if(document.getElementById('searchOverlay').classList.contains('open'))closeSearch();else openSearch()}
});


// TIMELINE VIEW STATE
let ttView = 'list'; // 'list' or 'time'
const DAY_START = 8 * 60;  // 08:00
const DAY_END   = 18 * 60; // 18:00
// PX_PER_MIN computed dynamically to fit viewport â€” see calcPxPerMin()
function calcPxPerMin() {
  // available height = viewport minus header(50) + nav(36) + wk-ctrl(~38) + main padding(~34) + hdr row(36) + term banner(~28) + border/padding(8)
  const avail = window.innerHeight - 50 - 36 - 38 - 34 - 36 - 28 - 8;
  return Math.max(1.2, avail / (DAY_END - DAY_START));
}

function setTtView(v) {
  ttView = v;
  document.getElementById('vtList').classList.toggle('active', v === 'list');
  document.getElementById('vtTime').classList.toggle('active', v === 'time');
  document.body.classList.toggle('timeline-mode', v === 'time');
  renderWeek();
}

function renderTimeline(mon, wt, today) {
  const totalMins = DAY_END - DAY_START;
  const PX_PER_MIN = calcPxPerMin();
  const totalPx   = totalMins * PX_PER_MIN;
  const HDR_H     = 36; // px for day header

  const wrap = document.createElement('div');
  wrap.className = 'tt-timeline';
  // 7 columns: time gutter + 6 days
  wrap.style.gridTemplateColumns = '36px repeat(6,1fr)';

  // â”€â”€ time gutter header â”€â”€
  const timeHdr = document.createElement('div');
  timeHdr.className = 'tl-time-hdr';
  timeHdr.style.cssText = `height:${HDR_H}px;`;
  wrap.appendChild(timeHdr);

  // â”€â”€ day headers â”€â”€
  for (let di = 0; di <= 5; di++) {
    const date = addD(mon, di);
    const isToday = sameD(date, today);
    const hdr = document.createElement('div');
    hdr.className = `tl-day-hdr${isToday ? ' today-hd' : ''}`;
    hdr.style.cssText = `height:${HDR_H}px;`;
    hdr.innerHTML = `<div class="dn">${DAYS[di].slice(0,3)}</div><div class="dd" style="font-family:'Lora',serif;font-size:.82rem;font-weight:500;${isToday?'color:#fff':''}">${fmtS(date)}</div>`;
    wrap.appendChild(hdr);
  }

  // â”€â”€ Row 2: Day notes (separate grid row so all columns stay aligned) â”€â”€
  let _anyNotes = false;
  for (let di = 0; di <= 5; di++) {
    const d = addD(mon, di);
    if (d >= TERM_START && d <= TERM_END && gDayNotes(d.toISOString().slice(0,10)).length) { _anyNotes = true; break; }
  }
  if (_anyNotes) {
    const ns = document.createElement('div');
    ns.style.cssText = 'background:var(--warm);border-right:1px solid var(--bsoft);';
    wrap.appendChild(ns);
    for (let di = 0; di <= 5; di++) {
      const date = addD(mon, di);
      const nc = document.createElement('div');
      nc.style.cssText = `border-right:${di < 5 ? '1px solid var(--bsoft)' : 'none'};`;
      if (date >= TERM_START && date <= TERM_END) {
        const ds = date.toISOString().slice(0, 10);
        for (const dn of gDayNotes(ds)) {
          const c = document.createElement('div');
          c.className = 'dnote-card';
          c.style.cssText = 'margin:0 .18rem .14rem;border-radius:4px;padding:.22rem .38rem';
          c.innerHTML = `<span class="dnote-icon">&#x1F4CC;</span><span class="dnote-text" style="font-size:.58rem">${esc(dn.text)}</span>`;
          c.addEventListener('click', () => openDnModal(ds, dn));
          nc.appendChild(c);
        }
      }
      wrap.appendChild(nc);
    }
  }

  // â”€â”€ Row 3: Time gutter + Day columns â”€â”€
  const gutterBody = document.createElement('div');
  gutterBody.className = 'tl-time-col';
  gutterBody.style.cssText = `height:${totalPx}px;position:relative;`;
  for (let h = DAY_START / 60; h <= DAY_END / 60; h++) {
    const pct = ((h * 60 - DAY_START) / totalMins) * totalPx;
    const lbl = document.createElement('div');
    lbl.className = 'tl-time-label';
    lbl.style.top = pct + 'px';
    lbl.textContent = `${String(h).padStart(2,'0')}:00`;
    gutterBody.appendChild(lbl);
  }
  wrap.appendChild(gutterBody);

  // â”€â”€ day columns â”€â”€
  for (let di = 0; di <= 5; di++) {
    const date   = addD(mon, di);
    const dayCol = document.createElement('div');
    dayCol.className = 'tl-day-col';

    if (date < TERM_START || date > TERM_END) {
      const body = document.createElement('div');
      body.className = 'tl-body';
      body.style.cssText = `height:${totalPx}px;position:relative;display:flex;align-items:center;justify-content:center;`;
      body.innerHTML = '<div style="color:var(--dim);font-size:.7rem">Outside term</div>';
      dayCol.appendChild(body);
      wrap.appendChild(dayCol);
      continue;
    }

    const ds     = date.toISOString().slice(0, 10);
    const lessons = TT[wt][di] || [];
    const edEntries = gEd(ds);

    // body container with fixed height
    const body = document.createElement('div');
    body.className = 'tl-body';
    body.style.cssText = `height:${totalPx}px;position:relative;`;

    // hour/half-hour grid lines
    for (let m = DAY_START; m <= DAY_END; m += 30) {
      const line = document.createElement('div');
      line.className = `tl-hour-line${m % 60 !== 0 ? ' half' : ''}`;
      line.style.top = ((m - DAY_START) * PX_PER_MIN) + 'px';
      body.appendChild(line);
    }

    // lesson cards
    for (const [time, code] of lessons) {
      if (isSt(code)) continue;
      const startM = t2m(time);
      const endM   = startM + dur(code);
      if (endM < DAY_START || startM > DAY_END) continue;
      const topPx    = Math.max(0, (startM - DAY_START) * PX_PER_MIN);
      const heightPx = Math.max(18, (endM - startM) * PX_PER_MIN - 2);

      const data   = loadL(date, time, code);
      const colour = gCol(code);
      const bg  = data.cancelled ? '#f0ede8' : bl(colour, .09);
      const bc  = data.cancelled ? '#d5cfc4' : bl(colour, .26);
      const ac  = data.cancelled ? '#c4beb4' : colour;
      const tc  = dk(colour, .72);

      // prep due?
      const tk = `${ds}::${time}`;
      let prepDue = null;
      for (const p of gAllPrep(code)) if (p.data.dueLessonKey === tk) { prepDue = p; break; }
      const beh = gBeh(code).filter(b => b.lessonDate === ds && b.lessonTime === time);

      const isToday = sameD(date, today);
      const nowMin = today.getHours() * 60 + today.getMinutes();
      const isNow = isToday && !data.cancelled && nowMin >= startM && nowMin < endM;

      const card = document.createElement('div');
      card.className = `tl-card lcard${data.cancelled ? ' cancelled' : ''}${isNow ? ' tl-now' : ''}`;
      card.dataset.startM = startM;
      card.dataset.endM = endM;
      card.dataset.isToday = isToday ? '1' : '';
      card.style.cssText = `top:${topPx}px;height:${heightPx}px;background:${bg};border-color:${bc};border-left-color:${ac};`;

      let h = '';
      if (data.cancelled) h += '<div class="cstripe"></div>';
      // Only show time label if card tall enough
      if (heightPx > 28) h += `<div class="lc-time">${time}</div>`;
      h += `<div class="lc-code" style="color:${data.cancelled ? 'var(--dim)' : tc};font-size:${heightPx < 36 ? '.7rem' : '.82rem'}">${code}</div>`;
      if (heightPx > 42) h += `<div class="lc-subj">${sn(code)}</div>`;
      if (data.cancelled && heightPx > 34) {
        h += `<div class="lc-cancelled">Cancelled</div>`;
      } else if (!data.cancelled) {
        if (data.topic && heightPx > 50) h += `<div class="lc-topic">${esc(data.topic)}</div>`;
        const bs = [];
        if (prepDue) bs.push('<span class="lc-badge badge-prep">&#128203;</span>');
        const w = beh.filter(b => b.type === 'verbal').length;
        const d2 = beh.filter(b => b.type === 'detention').length;
        const p = beh.filter(b => b.type === 'praise').length;
        if (w) bs.push(`<span class="lc-badge badge-warn">&#9888; ${w}</span>`);
        if (d2) bs.push(`<span class="lc-badge badge-det">&#128308;</span>`);
        if (p) bs.push(`<span class="lc-badge badge-praise">&#9733;</span>`);
        if (bs.length && heightPx > 58) h += `<div class="lc-indicators">${bs.join('')}</div>`;
        if ((data.topic || data.plan)) h += '<div class="plan-dot"></div>';
        if (isPrepNight(wt, di, code)) h += '<div class="prep-night-dot" title="Prep night"></div>';
      }
      card.innerHTML = h;
      card.addEventListener('click', () => openModal(date, time, code));
      body.appendChild(card);
    }

    // event/duty cards
    for (const e of edEntries) {
      const startM = t2m(e.start);
      const endM   = t2m(e.end);
      if (endM < DAY_START || startM > DAY_END) continue;
      const topPx    = Math.max(0, (startM - DAY_START) * PX_PER_MIN);
      const heightPx = Math.max(18, (endM - startM) * PX_PER_MIN - 2);

      const card = document.createElement('div');
      card.className = `tl-ecard ${e.type === 'event' ? 'ev-card' : 'du-card'}`;
      card.style.cssText = `top:${topPx}px;height:${heightPx}px;`;
      let h = '';
      if (heightPx > 26) h += `<div class="ec-time" style="font-size:.52rem">${e.start}&#8211;${e.end}</div>`;
      h += `<div class="ec-title" style="font-size:${heightPx < 34 ? '.68rem' : '.76rem'}">${esc(e.title)}</div>`;
      if (e._recurring && heightPx > 38) h += `<div class="ec-recur" style="font-size:.46rem">&#x21bb; ${e._weeks==='all'?'Weekly':'Wk '+e._weeks}</div>`;
      card.innerHTML = h;
      card.addEventListener('click', () => editEdEntry(ds, e));
      body.appendChild(card);
    }

    // "now" red line for today
    if (sameD(date, today)) {
      const nowM = new Date().getHours() * 60 + new Date().getMinutes();
      if (nowM >= DAY_START && nowM <= DAY_END) {
        const line = document.createElement('div');
        line.className = 'tl-now-line';
        line.id = 'tlNowLine_' + di;
        line.style.top = ((nowM - DAY_START) * PX_PER_MIN) + 'px';
        body.appendChild(line);
      }
    }

    dayCol.appendChild(body);
    wrap.appendChild(dayCol);
  }
  return wrap;
}

function updateTimelineNow() {
  if (ttView !== 'time') return;
  const now = new Date();
  const nowM = now.getHours() * 60 + now.getMinutes();
  const PX_PER_MIN = calcPxPerMin();
  // Move now-lines
  document.querySelectorAll('[id^="tlNowLine_"]').forEach(el => {
    if (nowM >= DAY_START && nowM <= DAY_END) {
      el.style.top = ((nowM - DAY_START) * PX_PER_MIN) + 'px';
      el.style.display = '';
    } else { el.style.display = 'none'; }
  });
  // Update current-lesson highlights
  document.querySelectorAll('.tl-card[data-is-today="1"]').forEach(card => {
    const s = +card.dataset.startM, e = +card.dataset.endM;
    card.classList.toggle('tl-now', nowM >= s && nowM < e);
  });
}


// â”€â”€â”€ TERM CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function gTermPeriods() {
  return PDATA.termPeriods || [];
}
function sTermPeriods(arr) { PDATA.termPeriods = arr; scheduleSave(); }

// Default periods seeded from TERM_START/END so new users see something sensible
function defaultTermPeriods() {
  return [
    { id: 'default-1', type: 'term', label: 'Spring Term 2', start: '2025-02-23', end: '2025-04-11' },
    { id: 'default-ht', type: 'halfterm', label: 'Half Term', start: '2025-02-17', end: '2025-02-21' },
  ];
}

function getTermPeriods() {
  return gTermPeriods();
}

// What period (if any) does a given Monday fall in?
function periodForDate(d) {
  const ds = d.toISOString().slice(0, 10);
  for (const p of getTermPeriods()) {
    if (ds >= p.start && ds <= p.end) return p;
  }
  return null;
}

// Week number within a term period (1-based)
function weekNumInTerm(mon) {
  const ds = mon.toISOString().slice(0, 10);
  for (const p of getTermPeriods()) {
    if (p.type !== 'term') continue;
    if (ds >= p.start && ds <= p.end) {
      const startMon = monOf(new Date(p.start + 'T00:00:00'));
      const diff = Math.round((mon - startMon) / 604800000);
      return diff + 1;
    }
  }
  return null;
}

function renderTermBanner() {
  const banner = document.getElementById('termBanner');
  if (!banner) return;
  const mon = curMon();
  const chips = [];
  const period = periodForDate(mon);

  if (period) {
    const typeMap = {
      term: { cls: 'term-label', icon: 'ðŸ“š' },
      halfterm: { cls: 'half-term', icon: 'â˜€ï¸' },
      holiday: { cls: 'holiday', icon: 'ðŸ–' },
      exams: { cls: 'exams', icon: 'ðŸ“' },
    };
    const t = typeMap[period.type] || typeMap.term;
    chips.push(`<span class="term-chip ${t.cls}">${t.icon} ${esc(period.label)}</span>`);
  }

  const wn = weekNumInTerm(mon);
  if (wn !== null) chips.push(`<span class="term-chip week-label">Week ${wn}</span>`);

  const weekAB = wkT(mon);
  chips.push(`<span class="term-chip week-label">Timetable Week ${weekAB}</span>`);

  banner.innerHTML = chips.join('');
}

// â”€â”€â”€ TERM SETTINGS UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let termDraft = []; // working copy while settings open

function renderTermPeriodRows() {
  termDraft = getTermPeriods().map(p => ({...p}));
  redrawTermPeriodRows();
}

function redrawTermPeriodRows() {
  const container = document.getElementById('termPeriodRows');
  container.innerHTML = '';
  const typeOptions = [
    { v: 'term',     l: 'Term',      cls: 'st'  },
    { v: 'halfterm', l: 'Half Term', cls: 'sht' },
    { v: 'holiday',  l: 'Holiday',   cls: 'sh'  },
    { v: 'exams',    l: 'Exams',     cls: 'sex' },
  ];

  termDraft.forEach((p, i) => {
    const row = document.createElement('div');
    row.className = 'term-period-row';
    const typeBtns = typeOptions.map(opt =>
      `<button class="term-type-btn${p.type === opt.v ? ' ' + opt.cls : ''}" onclick="setTermType(${i},'${opt.v}',this)">${opt.l}</button>`
    ).join('');
    row.innerHTML = `
      <div class="term-period-hdr">
        <span class="term-period-name">${esc(p.label)||'Untitled'}</span>
        <button class="term-period-del" onclick="delTermPeriod(${i})" title="Remove">&#x2715;</button>
      </div>
      <div class="frow"><label class="slabel">Label</label>
        <input class="finput" type="text" value="${esc(p.label)}" oninput="termDraft[${i}].label=this.value;this.closest('.term-period-row').querySelector('.term-period-name').textContent=this.value||'Untitled'"></div>
      <div class="term-date-row">
        <div class="frow"><label class="slabel">Start</label><input class="finput" type="date" value="${p.start}" oninput="termDraft[${i}].start=this.value"></div>
        <div class="frow"><label class="slabel">End</label><input class="finput" type="date" value="${p.end}" oninput="termDraft[${i}].end=this.value"></div>
      </div>
      <div><div class="slabel">Type</div><div class="term-type-row">${typeBtns}</div></div>`;
    container.appendChild(row);
  });
}

function setTermType(i, type, btn) {
  termDraft[i].type = type;
  const allBtns = btn.closest('.term-type-row').querySelectorAll('.term-type-btn');
  allBtns.forEach(b => b.className = 'term-type-btn');
  const clsMap = { term: 'st', halfterm: 'sht', holiday: 'sh', exams: 'sex' };
  btn.classList.add(clsMap[type] || 'st');
}

function addTermPeriod() {
  termDraft.push({ id: Date.now().toString(36), type: 'term', label: 'New Period', start: '', end: '' });
  redrawTermPeriodRows();
  // scroll to bottom of settings
  document.querySelector('.settings-modal').scrollTop = 9999;
}

function delTermPeriod(i) {
  termDraft.splice(i, 1);
  redrawTermPeriodRows();
}

function saveTermPeriods() {
  sTermPeriods(termDraft.filter(p => p.start && p.end));
  const msg = document.getElementById('termSavedMsg');
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2000);
  renderTermBanner();
  renderWeek();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: TERM DATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveTermDates() {
  PDATA.termStart = document.getElementById('termStartInput').value;
  PDATA.termEnd = document.getElementById('termEndInput').value;
  applyPDATA();
  scheduleSave();
  const msg = document.getElementById('termDatesSaved');
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2000);
  renderWeek(); renderTermBanner();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: SUBJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSubjectRows() {
  const container = document.getElementById('subjectRows');
  container.innerHTML = '';
  for (const [code, obj] of Object.entries(SUBJ)) {
    const row = document.createElement('div');
    row.className = 'subj-row';
    row.innerHTML = `<strong>${esc(code)}</strong> <span style="flex:1;color:var(--mid)">${esc(obj.name)}</span><button class="subj-del" onclick="removeSubject('${esc(code)}')" title="Remove">&#x2715;</button>`;
    container.appendChild(row);
  }
  if (!Object.keys(SUBJ).length) {
    container.innerHTML = '<div style="font-size:.68rem;color:var(--dim);font-style:italic;padding:.3rem 0">No subjects added yet. Add one below.</div>';
  }
}
function addSubject() {
  const codeEl = document.getElementById('newSubjCode');
  const nameEl = document.getElementById('newSubjName');
  const code = codeEl.value.trim();
  const name = nameEl.value.trim();
  if (!code || !name) { alert('Please enter both a code and name.'); return; }
  const normCode = code.charAt(0).toUpperCase() + code.slice(1).toLowerCase();
  PDATA.subjects[normCode] = { name };
  applyPDATA();
  scheduleSave();
  codeEl.value = ''; nameEl.value = '';
  renderSubjectRows();
}
function removeSubject(code) {
  delete PDATA.subjects[code];
  applyPDATA();
  scheduleSave();
  renderSubjectRows();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: TIMETABLE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ttSetupWeek = 'A';
function setTtSetupWeek(w, btn) {
  ttSetupWeek = w;
  document.querySelectorAll('#ttSetupWeekToggle .week-ab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTtSetup();
}
function renderTtSetup() {
  const grid = document.getElementById('ttSetupGrid');
  grid.innerHTML = '';
  const weekData = TT[ttSetupWeek] || {};
  for (let di = 0; di <= 5; di++) {
    const slots = weekData[di] || [];
    const day = document.createElement('div');
    day.className = 'tt-setup-day';
    let slotsHtml = '';
    for (let si = 0; si < slots.length; si++) {
      const [time, code] = slots[si];
      slotsHtml += `<div class="tt-setup-slot" id="ttSlot_${ttSetupWeek}_${di}_${si}"><span class="slot-time" onclick="editSlotTime('${ttSetupWeek}',${di},${si})" title="Click to change time">${time}</span> <span style="flex:1">${code}</span><button class="slot-del" onclick="removeTtSlot('${ttSetupWeek}',${di},${si})">&#x2715;</button></div>`;
    }
    if (!slots.length) slotsHtml = '<div style="font-size:.62rem;color:var(--dim);font-style:italic;padding:.14rem 0">No lessons</div>';
    day.innerHTML = `<div class="tt-setup-day-hdr"><span>${DAYS[di]}</span></div>${slotsHtml}
      <div class="tt-add-row"><input class="finput" type="time" id="ttTime_${di}" value="09:00" style="width:90px"><input class="finput" type="text" id="ttCode_${di}" placeholder="e.g. 10La" style="width:80px"><button class="sm-action-btn" style="font-size:.62rem;padding:.24rem .6rem" onclick="addTtSlot('${ttSetupWeek}',${di})">+ Add</button></div>`;
    grid.appendChild(day);
  }
}
function addTtSlot(week, dayIdx) {
  const time = document.getElementById(`ttTime_${dayIdx}`).value;
  const code = document.getElementById(`ttCode_${dayIdx}`).value.trim();
  if (!time || !code) { alert('Please enter both a time and class code.'); return; }
  if (!PDATA.timetable[week]) PDATA.timetable[week] = {};
  if (!PDATA.timetable[week][dayIdx]) PDATA.timetable[week][dayIdx] = [];
  PDATA.timetable[week][dayIdx].push([time, code]);
  PDATA.timetable[week][dayIdx].sort((a, b) => t2m(a[0]) - t2m(b[0]));
  applyPDATA();
  scheduleSave();
  renderTtSetup();
  renderWeek();
  document.getElementById(`ttCode_${dayIdx}`).value = '';
}
function removeTtSlot(week, dayIdx, slotIdx) {
  if (!PDATA.timetable[week]?.[dayIdx]) return;
  PDATA.timetable[week][dayIdx].splice(slotIdx, 1);
  applyPDATA();
  scheduleSave();
  renderTtSetup();
  renderWeek();
}
function editSlotTime(week, dayIdx, slotIdx) {
  const slot = PDATA.timetable[week]?.[dayIdx]?.[slotIdx];
  if (!slot) return;
  const [oldTime, code] = slot;
  const container = document.getElementById(`ttSlot_${week}_${dayIdx}_${slotIdx}`);
  const timeSpan = container.querySelector('.slot-time');
  const input = document.createElement('input');
  input.type = 'time'; input.value = oldTime; input.className = 'slot-time-edit';
  timeSpan.replaceWith(input);
  input.focus();
  const commit = () => {
    const newTime = input.value;
    if (!newTime || newTime === oldTime) { renderTtSetup(); return; }
    // Update the timetable slot
    PDATA.timetable[week][dayIdx][slotIdx] = [newTime, code];
    PDATA.timetable[week][dayIdx].sort((a, b) => t2m(a[0]) - t2m(b[0]));
    applyPDATA(); scheduleSave(); renderTtSetup(); renderWeek();
    // Check if there are lessons to migrate
    const toMigrate = findLessonsToMigrate(week, dayIdx, oldTime, newTime, code);
    if (toMigrate.length) {
      // Find the new index after sort
      const newIdx = PDATA.timetable[week][dayIdx].findIndex(s => s[0] === newTime && s[1] === code);
      showMigratePrompt(week, dayIdx, newIdx >= 0 ? newIdx : slotIdx, oldTime, newTime, code, toMigrate);
    }
  };
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') { input.removeEventListener('blur', commit); commit(); } if (e.key === 'Escape') renderTtSetup(); });
}
function findLessonsToMigrate(week, dayIdx, oldTime, newTime, code) {
  const found = [];
  if (!TERM_START || !TERM_END) return found;
  let mon = monOf(TERM_START);
  while (mon <= TERM_END) {
    if (wkT(mon) === week) {
      const date = addD(mon, dayIdx);
      if (date >= TERM_START && date <= TERM_END) {
        const key = lk(date, oldTime, code);
        if (PDATA.lessons[key]) found.push({ date, oldTime, code, key });
      }
    }
    mon = addD(mon, 7);
  }
  return found;
}
function showMigratePrompt(week, dayIdx, slotIdx, oldTime, newTime, code, toMigrate) {
  const container = document.getElementById(`ttSlot_${week}_${dayIdx}_${slotIdx}`);
  if (!container) return;
  const existing = container.querySelector('.tt-slot-migrate');
  if (existing) existing.remove();
  const bar = document.createElement('div');
  bar.className = 'tt-slot-migrate';
  bar.innerHTML = `${toMigrate.length} existing lesson${toMigrate.length !== 1 ? 's' : ''} for <strong>${code}</strong> at ${oldTime} on ${DAYS[dayIdx]}s. Move them to ${newTime}? <button class="migrate-yes" onclick="migrateLessons('${week}',${dayIdx},'${oldTime}','${newTime}','${code}');this.closest('.tt-slot-migrate').remove()">Yes, move all</button><button class="migrate-no" onclick="this.closest('.tt-slot-migrate').remove()">No, keep old times</button>`;
  container.appendChild(bar);
}
function migrateLessons(week, dayIdx, oldTime, newTime, code) {
  const toMove = findLessonsToMigrate(week, dayIdx, oldTime, newTime, code);
  const migratedDates = new Set();
  for (const { date, key } of toMove) {
    const data = PDATA.lessons[key];
    if (!data) continue;
    const newKey = lk(date, newTime, code);
    PDATA.lessons[newKey] = data;
    delete PDATA.lessons[key];
    migratedDates.add(date.toISOString().slice(0, 10));
  }
  // Also migrate prep references whose dates fall on migrated days
  for (const [pk, pd] of Object.entries(PDATA.prep || {})) {
    if (!pd || !pd.code || pd.code !== code) continue;
    let changed = false;
    if (pd.setKey) { const [sd, st] = pd.setKey.split('::'); if (st === oldTime && migratedDates.has(sd)) { pd.setKey = `${sd}::${newTime}`; pd.setDisplay = (pd.setDisplay || '').replace(oldTime, newTime); changed = true; } }
    if (pd.dueLessonKey) { const [dd, dt] = pd.dueLessonKey.split('::'); if (dt === oldTime && migratedDates.has(dd)) { pd.dueLessonKey = `${dd}::${newTime}`; pd.dueDisplay = (pd.dueDisplay || '').replace(oldTime, newTime); changed = true; } }
    if (changed) PDATA.prep[pk] = pd;
  }
  // Also migrate behaviour references on migrated dates
  for (const entry of (PDATA.behaviour[code] || [])) {
    if (entry.lessonTime === oldTime && migratedDates.has(entry.lessonDate)) entry.lessonTime = newTime;
  }
  scheduleSave();
  renderWeek();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: PREP NIGHTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isPrepNight(week, dayIdx, code) {
  return (PDATA.prepNights || []).some(pn => pn.week === week && pn.day === dayIdx && pn.code === code);
}

function renderPrepNightRows() {
  const container = document.getElementById('prepNightRows');
  container.innerHTML = '';
  const nights = PDATA.prepNights || [];
  const classes = allC();
  for (let i = 0; i < nights.length; i++) {
    const pn = nights[i];
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:.38rem;margin-bottom:.35rem;padding:.38rem .55rem;background:var(--warm);border:1px solid var(--bsoft);border-radius:6px';
    row.innerHTML = `<select class="finput" style="flex:1.2;font-size:.68rem;padding:.28rem .4rem" onchange="updatePrepNight(${i},'code',this.value)">
      <option value="">Class&#8230;</option>
      ${classes.map(c => `<option value="${c}"${pn.code===c?' selected':''}>${c}</option>`).join('')}
    </select>
    <select class="finput" style="flex:.8;font-size:.68rem;padding:.28rem .4rem" onchange="updatePrepNight(${i},'week',this.value)">
      <option value="A"${pn.week==='A'?' selected':''}>Wk A</option>
      <option value="B"${pn.week==='B'?' selected':''}>Wk B</option>
    </select>
    <select class="finput" style="flex:1.2;font-size:.68rem;padding:.28rem .4rem" onchange="updatePrepNight(${i},'day',+this.value)">
      ${DAYS.map((d,di) => `<option value="${di}"${pn.day===di?' selected':''}>${d}</option>`).join('')}
    </select>
    <button class="subj-del" onclick="removePrepNight(${i})" title="Remove" style="flex-shrink:0">&#x2715;</button>`;
    container.appendChild(row);
  }
  if (!nights.length) {
    container.innerHTML = '<div style="font-size:.62rem;color:var(--dim);font-style:italic;padding:.26rem 0">No prep nights set.</div>';
  }
}

function addPrepNight() {
  if (!PDATA.prepNights) PDATA.prepNights = [];
  const classes = allC();
  PDATA.prepNights.push({ code: classes[0] || '', week: 'A', day: 0 });
  scheduleSave();
  renderPrepNightRows();
  renderWeek();
}

function updatePrepNight(idx, field, value) {
  if (!PDATA.prepNights?.[idx]) return;
  PDATA.prepNights[idx][field] = value;
  scheduleSave();
  renderPrepNightRows();
  renderWeek();
}

function removePrepNight(idx) {
  if (!PDATA.prepNights) return;
  PDATA.prepNights.splice(idx, 1);
  scheduleSave();
  renderPrepNightRows();
  renderWeek();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED SETTINGS OPEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origOpenSettings = openSettings;
openSettings = function() {
  // Populate term dates
  document.getElementById('termStartInput').value = PDATA.termStart || '';
  document.getElementById('termEndInput').value = PDATA.termEnd || '';
  renderSubjectRows();
  renderTtSetup();
  renderPrepNightRows();
  _origOpenSettings();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OWNER DATA SEED â€” preserves existing hardcoded timetable for site owner
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seedOwnerData() {
  return {
    timetable: {
      A:{0:[['08:50','10Cc'],['09:45','11La'],['17:05','9Gk']],1:[['08:50','12La'],['11:35','8La'],['12:45','13Cc'],['15:30','9XLa']],2:[['09:50','9YLa'],['11:35','8La'],['13:05','13Cc'],['14:00','10Cc'],['16:10','13La'],['17:05','9Gk']],3:[['08:50','10En'],['09:45','12La'],['11:00','10Cc'],['13:25','8La']],4:[['08:50','10Cc'],['09:45','13Cc'],['11:55','9YLa'],['15:15','11La']],5:[['08:50','10Ss'],['09:45','9YLa'],['11:00','11La']]},
      B:{0:[['11:00','13Cc'],['13:40','11La'],['17:05','9Gk']],1:[['11:35','8La'],['12:45','13Cc'],['15:30','9XLa']],2:[['09:50','9YLa'],['09:45','12La'],['11:35','8La'],['15:15','13Cc'],['16:10','10Cc'],['17:05','9Gk']],3:[['08:50','10En'],['11:55','9YLa'],['13:25','8La']],4:[['09:45','13La'],['11:00','11La'],['13:05','11La'],['14:00','10Cc'],['15:15','9YLa'],['16:10','12La']],5:[['09:45','13La'],['11:00','10Cc']]}
    },
    subjects: {La:{name:'Latin'},Cc:{name:'Classical Civ.'},Gk:{name:'Greek'},En:{name:'English'},Ss:{name:'Supervised Study'}},
    defaultColours: {'10Cc':'#2d7a6a','11La':'#9a6820','9Gk':'#5040a0','12La':'#7a5200','8La':'#a04020','13Cc':'#1a5c7a','9XLa':'#7a3060','9YLa':'#3a6030','13La':'#602070','10En':'#7a3030','10Ss':'#7a7068'},
    termStart: '2026-02-23',
    termEnd: '2026-03-27',
    classColours: {},
    lessons: {},
    rosters: {},
    prep: {},
    behaviour: {},
    quickNotes: {},
    events: {},
    termPeriods: [
      {id:'default-1',type:'term',label:'Spring Term 2',start:'2026-02-23',end:'2026-04-10'},
      {id:'default-ht',type:'halfterm',label:'Half Term',start:'2026-02-16',end:'2026-02-20'}
    ]
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH + INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startApp() {
  applyPDATA();
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('appContent').style.display = '';
  const t = new Date(); t.setHours(0, 0, 0, 0);
  if (PDATA.termStart) {
    weekOffset = Math.max(0, Math.min(Math.round((monOf(t) - monOf(TERM_START)) / 604800000), termWeeks()));
  }
  renderWeek(); renderTermBanner(); updateClock(); setInterval(updateClock, 30000);
  window.addEventListener('resize', () => { if (ttView === 'time') renderWeek(); });
  // Show setup hint if no classes configured
  if (!allC().length && !PDATA.termStart) {
    document.getElementById('timetable').innerHTML = `<div class="setup-empty" style="grid-column:1/-1"><h2>Welcome to your planner!</h2><p>You haven't set up your timetable yet.<br>Open Settings to add your term dates, subjects, and lessons.</p><button class="setup-btn" onclick="openSettings()">Open Settings</button></div>`;
  }
}

(async function init() {
  try {
    const user = await requireAuth();
    if (!user) return; // redirects to login
    currentUserId = user.id;

    // Set back link based on role
    const profile = await getUserProfile();
    if (profile) {
      document.getElementById('hdrUser').textContent = profile.full_name || user.email;
      if (profile.role === 'teacher') {
        document.getElementById('backLink').href = 'teacher.html';
      } else {
        document.getElementById('backLink').href = 'student-hub.html';
      }
    }

    // Load planner data from Supabase
    const loaded = await loadFromCloud();
    if (loaded && user.email === 'lawrencefmcnally@gmail.com') {
      // Update owner's stale term dates if they're in the past
      const seed = seedOwnerData();
      if (PDATA.termEnd && new Date(PDATA.termEnd+'T00:00:00') < new Date()) {
        PDATA.termStart = seed.termStart;
        PDATA.termEnd = seed.termEnd;
        PDATA.termPeriods = seed.termPeriods;
        await syncToCloud();
      }
    }
    if (!loaded) {
      // Check if this is the site owner â€” seed their existing timetable
      if (user.email === 'lawrencefmcnally@gmail.com') {
        PDATA = seedOwnerData();
        await syncToCloud();
      } else {
        // New user â€” start with empty planner
        PDATA = {
          timetable: {A:{},B:{}},
          subjects: {},
          defaultColours: {},
          termStart: '',
          termEnd: '',
          classColours: {},
          lessons: {},
          rosters: {},
          prep: {},
          behaviour: {},
          quickNotes: {},
          events: {},
          termPeriods: [],
          prepNights: []
        };
      }
    }
    startApp();
  } catch (e) {
    console.error('Init error:', e);
    document.querySelector('.loading-text').textContent = 'Error loading planner. Please try again.';
  }
})();
</script>
</body>
</html>
