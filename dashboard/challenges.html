<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Challenges - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 1100px; margin: 0 auto; }

        /* Header */
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%; right: -10%;
            width: 200px; height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 { font-size: 1.75rem; font-weight: 700; }
        .header p { opacity: 0.9; margin-top: 0.25rem; }
        .header-actions { display: flex; gap: 1rem; }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-ghost { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.4); }
        .btn-ghost:hover { background: rgba(255,255,255,0.3); }
        .btn-white { background: white; color: #7c3aed; }
        .btn-white:hover { background: #f0f4ff; transform: translateY(-2px); }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1.1rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Cards */
        .card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 1.5rem; }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; }
        .card-body { padding: 1.25rem; }

        /* Form */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-input, .form-select {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db;
            border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-hint { font-size: 0.8rem; color: #6b7280; margin-top: 0.35rem; }

        /* Challenge Type Selector */
        .challenge-types { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .challenge-type-card {
            border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.25rem;
            text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa;
        }
        .challenge-type-card:hover { border-color: #7c3aed; background: #faf5ff; }
        .challenge-type-card.selected { border-color: #7c3aed; background: #f5f3ff; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15); }
        .challenge-type-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .challenge-type-name { font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
        .challenge-type-desc { font-size: 0.8rem; color: #6b7280; line-height: 1.4; }

        /* Word picker */
        .word-picker { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem; }
        .word-picker-item {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem;
            border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: background 0.1s;
        }
        .word-picker-item:hover { background: #f5f3ff; }
        .word-picker-item input { accent-color: #7c3aed; }
        .word-picker-item .word-latin { font-weight: 600; color: #7c3aed; }
        .word-picker-item .word-english { color: #6b7280; }
        .word-picker-controls { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }

        /* Challenge items */
        .challenge-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.2s; background: white; }
        .challenge-item:hover { border-color: #7c3aed; }
        .challenge-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .challenge-item-title { font-weight: 600; font-size: 1.1rem; color: #1f2937; }
        .challenge-badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .badge-speed { background: #fef3c7; color: #92400e; }
        .badge-streak { background: #fee2e2; color: #dc2626; }
        .badge-marathon { background: #dcfce7; color: #166534; }
        .badge-gold_rush { background: #fef3c7; color: #92400e; }
        .badge-waiting { background: #fef3c7; color: #92400e; }
        .badge-active { background: #dcfce7; color: #166534; }
        .badge-ended { background: #f3f4f6; color: #6b7280; }
        .challenge-meta { display: flex; gap: 1.5rem; font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem; }
        .challenge-meta span { display: flex; align-items: center; gap: 0.35rem; }
        .challenge-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Join code display */
        .join-code-display {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            border-radius: 16px; padding: 2rem; text-align: center; color: white; margin-bottom: 1rem;
        }
        .join-code-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem; }
        .join-code-value {
            font-size: 3.5rem; font-weight: 800; letter-spacing: 6px; font-family: monospace;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .join-code-hint { font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem; }

        /* Live Scoreboard */
        .scoreboard { background: #0f172a; border-radius: 16px; overflow: hidden; color: white; }
        .scoreboard-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            text-align: center;
        }
        .scoreboard-header h2 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .scoreboard-header p { opacity: 0.8; font-size: 0.9rem; }
        .scoreboard-info { display: flex; justify-content: center; gap: 2rem; margin-top: 1rem; font-size: 0.85rem; }
        .scoreboard-info-item { display: flex; align-items: center; gap: 0.35rem; }
        .scoreboard-body { padding: 1rem; }
        .scoreboard-row {
            display: flex; align-items: center; padding: 0.75rem 1rem;
            border-radius: 10px; margin-bottom: 0.5rem;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .scoreboard-row.score-flash {
            animation: score-flash 0.6s ease;
        }
        @keyframes score-flash {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.4); }
        }
        .scoreboard-row.rank-1 { background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); }
        .scoreboard-row.rank-2 { background: linear-gradient(135deg, rgba(192,192,192,0.2), rgba(192,192,192,0.05)); }
        .scoreboard-row.rank-3 { background: linear-gradient(135deg, rgba(205,127,50,0.2), rgba(205,127,50,0.05)); }
        .scoreboard-row:not(.rank-1):not(.rank-2):not(.rank-3) { background: rgba(255,255,255,0.05); }
        .scoreboard-rank {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.1rem; margin-right: 1rem; flex-shrink: 0;
        }
        .scoreboard-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; }
        .scoreboard-rank.silver { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #374151; }
        .scoreboard-rank.bronze { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
        .scoreboard-rank.other { background: rgba(255,255,255,0.1); color: #9ca3af; }
        .scoreboard-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(124, 58, 237, 0.15); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-right: 0.5rem; flex-shrink: 0; }
        .scoreboard-name { flex: 1; font-weight: 500; font-size: 1rem; }
        .scoreboard-tag { font-size: 0.7rem; color: #a78bfa; margin-top: 0.1rem; }
        .scoreboard-status { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-right: 1rem; }
        .status-active { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .status-completed { background: rgba(124, 58, 237, 0.2); color: #a78bfa; }
        .status-waiting { background: rgba(255,255,255,0.1); color: #6b7280; }
        .scoreboard-value { font-weight: 700; font-size: 1.25rem; min-width: 60px; text-align: right; }
        .scoreboard-sublabel { font-size: 0.7rem; color: #9ca3af; text-align: right; }
        .scoreboard-empty { text-align: center; padding: 3rem; color: #6b7280; }
        .scoreboard-empty-icon { font-size: 3rem; margin-bottom: 1rem; }

        /* XP award row */
        .xp-award-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; }
        .xp-award-input { width: 80px; padding: 0.4rem 0.5rem; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; font-size: 0.9rem; }

        /* Live dot */
        .live-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block; margin-right: 0.35rem; animation: pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Start button pulse */
        .btn-start-pulse { animation: start-pulse 2s infinite; }
        @keyframes start-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
        }

        /* Tabs */
        .view-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .view-tab {
            padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; border: 2px solid #e5e7eb; background: white; color: #6b7280; transition: all 0.2s;
        }
        .view-tab:hover { border-color: #7c3aed; color: #7c3aed; }
        .view-tab.active { background: #7c3aed; color: white; border-color: #7c3aed; }

        .empty-state { text-align: center; padding: 3rem 2rem; color: #6b7280; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .empty-state p { margin-bottom: 1rem; }
        .loading { text-align: center; padding: 3rem; color: #6b7280; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal { background: white; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.15rem; font-weight: 600; color: #1f2937; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: #9ca3af; cursor: pointer; padding: 0; line-height: 1; }
        .modal-close:hover { color: #1f2937; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; background: #f9fafb; border-top: 1px solid #f0f0f0; display: flex; gap: 0.75rem; justify-content: flex-end; }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            .challenge-types { grid-template-columns: 1fr 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; text-align: center; gap: 1rem; }
            .scoreboard-info { flex-direction: column; gap: 0.5rem; }
            .join-code-value { font-size: 2.5rem; letter-spacing: 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üèÜ Class Challenges</h1>
                    <p id="className">Loading...</p>
                </div>
                <div class="header-actions">
                    <a id="backLink" href="class.html" class="btn btn-ghost">‚Üê Back to Class</a>
                </div>
            </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" onclick="showView('challenges')">üìã Challenges</button>
            <button class="view-tab" onclick="showView('create')">+ Create New</button>
        </div>

        <!-- Challenges List View -->
        <div id="challengesView">
            <div id="challengesContainer">
                <div class="loading">Loading challenges...</div>
            </div>
        </div>

        <!-- Create Challenge View -->
        <div id="createView" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Create New Challenge</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Challenge Type</label>
                        <div class="challenge-types">
                            <div class="challenge-type-card selected" onclick="selectChallengeType('speed')" id="type-speed">
                                <div class="challenge-type-icon">‚ö°</div>
                                <div class="challenge-type-name">Speed Round</div>
                                <div class="challenge-type-desc">Most correct answers within the time limit</div>
                            </div>
                            <div class="challenge-type-card" onclick="selectChallengeType('streak')" id="type-streak">
                                <div class="challenge-type-icon">üî•</div>
                                <div class="challenge-type-name">Streak Challenge</div>
                                <div class="challenge-type-desc">Longest run of consecutive correct answers</div>
                            </div>
                            <div class="challenge-type-card" onclick="selectChallengeType('marathon')" id="type-marathon">
                                <div class="challenge-type-icon">üèÅ</div>
                                <div class="challenge-type-name">Marathon</div>
                                <div class="challenge-type-desc">Master every word - fastest time wins</div>
                            </div>
                            <div class="challenge-type-card" onclick="selectChallengeType('gold_rush')" id="type-gold_rush">
                                <div class="challenge-type-icon">üéÅ</div>
                                <div class="challenge-type-name">Gold Rush</div>
                                <div class="challenge-type-desc">Answer questions and open chests for bonus gold - like Blooket!</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Challenge Title</label>
                        <input type="text" class="form-input" id="challengeTitle" placeholder="e.g. Chapter 3 Speed Blitz">
                    </div>

                    <!-- Chapter selection -->
                    <div class="form-group">
                        <label class="form-label">Select Chapters</label>
                        <div id="chapterSelector" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                    </div>

                    <!-- Word picker: shows words from selected chapters, teacher ticks which ones to include -->
                    <div class="form-group" id="wordPickerGroup" style="display: none;">
                        <label class="form-label">Select Words</label>
                        <div class="word-picker-controls">
                            <button class="btn btn-sm btn-primary" onclick="selectAllWords()">Select All</button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAllWords()">Deselect All</button>
                            <span id="wordPickerCount" style="font-size: 0.85rem; color: #6b7280; margin-left: auto; align-self: center;">0 words selected</span>
                        </div>
                        <div class="word-picker" id="wordPicker"></div>
                    </div>

                    <!-- Time Limit (for speed) -->
                    <div class="form-group" id="timeLimitGroup">
                        <label class="form-label">Time Limit</label>
                        <select class="form-select" id="timeLimit">
                            <option value="120">2 minutes</option>
                            <option value="180">3 minutes</option>
                            <option value="300" selected>5 minutes</option>
                            <option value="600">10 minutes</option>
                            <option value="900">15 minutes</option>
                        </select>
                    </div>

                    <button class="btn btn-primary btn-lg" onclick="createChallenge()" style="width: 100%;">Create Challenge</button>
                </div>
            </div>
        </div>

        <!-- Scoreboard View -->
        <div id="scoreboardView" style="display: none;">
            <!-- Join code display -->
            <div class="join-code-display" id="joinCodeDisplay">
                <div class="join-code-label">Students: go to your dashboard and enter this code</div>
                <div class="join-code-value" id="joinCodeValue">---</div>
                <div class="join-code-hint">Waiting for students to join...</div>
            </div>

            <!-- Start button (only shown in waiting state) -->
            <div id="startSection" style="text-align: center; margin-bottom: 1.5rem;">
                <button class="btn btn-success btn-lg btn-start-pulse" onclick="startChallengeNow()" id="startChallengeBtn" style="font-size: 1.3rem; padding: 1rem 3rem;">
                    ‚ñ∂ Start Challenge
                </button>
                <p style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem;">Press when all students have joined</p>
            </div>

            <div class="scoreboard" id="scoreboard">
                <div class="scoreboard-header">
                    <h2 id="scoreboardTitle">Challenge</h2>
                    <p id="scoreboardSubtitle"></p>
                    <div class="scoreboard-info">
                        <div class="scoreboard-info-item">
                            <span class="live-dot"></span> Live
                        </div>
                        <div class="scoreboard-info-item" id="scoreboardParticipants">0 joined</div>
                        <div class="scoreboard-info-item" id="scoreboardCompleted">0 completed</div>
                    </div>
                </div>
                <div class="scoreboard-body" id="scoreboardBody">
                    <div class="scoreboard-empty">
                        <div class="scoreboard-empty-icon">‚è≥</div>
                        <p>Waiting for students to join...</p>
                    </div>
                </div>
            </div>

            <div id="autoXpNotice" style="display: none; margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 8px; font-size: 0.85rem; color: #a78bfa;"></div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="showView('challenges')">‚Üê Back</button>
                <button class="btn btn-danger" id="endChallengeBtn" onclick="endChallenge()">End Challenge</button>
                <button class="btn btn-warning" id="awardXpBtn" onclick="openXpModal()" style="display: none;">‚≠ê Adjust XP</button>
            </div>
        </div>
    </div>

    <!-- End Challenge Modal -->
    <div class="modal-overlay" id="endChallengeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>End Challenge?</h3>
                <button class="modal-close" onclick="closeEndModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>This will end the challenge. Students still playing can finish, but no new students can join.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEndModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmEndChallenge()">End Challenge</button>
            </div>
        </div>
    </div>

    <!-- XP Award Modal -->
    <div class="modal-overlay" id="xpModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚≠ê Award XP to Winners</h3>
                <button class="modal-close" onclick="closeXpModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">Set the XP to award for each position. Leave blank or 0 to skip.</p>
                <div id="xpAwardList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeXpModal()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmAwardXp()">Award XP</button>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    <script src="../shared/vocabulary-data.js"></script>
    <script src="../shared/greek-vocabulary-data.js"></script>
    <script src="../latin/data/suburani-vocab.js"></script>
    <script src="../shared/xp-system.js"></script>
    <script>
        let currentUser = null;
        let currentClass = null;
        let challenges = [];
        let selectedType = 'speed';
        let selectedChapters = new Set();
        let selectedWordIndices = new Set(); // indices into chapterWords
        let chapterWords = []; // words from selected chapters
        let viewingChallengeId = null;
        let viewingChallenge = null;
        let realtimeSubscription = null;
        let lastAttempts = [];
        let scoreboardPollInterval = null;
        let previousScores = {}; // track score changes for flash animation

        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get('classId');
        if (!classId) window.location.href = 'teacher.html';

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = '../auth/login.html'; return; }

            const { data: profile } = await supabase
                .from('users').select('*').eq('id', user.id).single();

            if (!profile || profile.role !== 'teacher') {
                window.location.href = '../auth/login.html'; return;
            }
            currentUser = profile;

            const { data: cls } = await supabase
                .from('classes').select('*').eq('id', classId).single();
            if (!cls) { window.location.href = 'teacher.html'; return; }
            currentClass = cls;

            document.getElementById('className').textContent = cls.name;
            document.getElementById('backLink').href = `class.html?id=${classId}`;

            populateChapterSelector();
            await loadChallenges();
        }

        // === VOCAB DATA ===

        function getVocabData() {
            if (currentClass.type === 'greek') return typeof greekVocabularyData !== 'undefined' ? greekVocabularyData : [];
            if (currentClass.type === 'prep-latin') return typeof suburaniVocabularyData !== 'undefined' ? suburaniVocabularyData : [];
            return typeof vocabularyData !== 'undefined' ? vocabularyData : [];
        }

        function getWordKey() {
            return currentClass.type === 'greek' ? 'greek' : 'latin';
        }

        function getLanguage() {
            if (currentClass.type === 'greek') return 'greek';
            if (currentClass.type === 'prep-latin') return 'prep-latin';
            return 'latin';
        }

        // === CHAPTER & WORD SELECTION ===

        function populateChapterSelector() {
            const vocab = getVocabData();
            const chapters = [...new Set(vocab.map(w => w.chapter))].sort((a, b) => a - b);
            const container = document.getElementById('chapterSelector');

            container.innerHTML = chapters.map(ch => `
                <label style="display: flex; align-items: center; gap: 0.35rem; padding: 0.4rem 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.15s; user-select: none;"
                    onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#7c3aed':'#d1d5db'">
                    <input type="checkbox" value="${ch}" onchange="toggleChapter(${ch}, this)" style="accent-color: #7c3aed;">
                    Ch ${ch}
                </label>
            `).join('');
        }

        function toggleChapter(ch, checkbox) {
            if (checkbox.checked) selectedChapters.add(ch);
            else selectedChapters.delete(ch);
            checkbox.parentElement.style.borderColor = checkbox.checked ? '#7c3aed' : '#d1d5db';
            checkbox.parentElement.style.background = checkbox.checked ? '#f5f3ff' : 'white';
            refreshWordPicker();
        }

        function refreshWordPicker() {
            const vocab = getVocabData();
            const key = getWordKey();
            chapterWords = vocab.filter(w => selectedChapters.has(w.chapter));
            const picker = document.getElementById('wordPicker');
            const group = document.getElementById('wordPickerGroup');

            if (chapterWords.length === 0) {
                group.style.display = 'none';
                selectedWordIndices.clear();
                return;
            }

            group.style.display = 'block';
            // Default: all selected
            selectedWordIndices = new Set(chapterWords.map((_, i) => i));

            picker.innerHTML = chapterWords.map((w, i) => `
                <label class="word-picker-item">
                    <input type="checkbox" checked data-idx="${i}" onchange="toggleWord(${i}, this)" style="accent-color: #7c3aed;">
                    <span class="word-latin">${w[key]}</span>
                    <span class="word-english">‚Äî ${w.english}</span>
                </label>
            `).join('');

            updateWordPickerCount();
        }

        function toggleWord(idx, checkbox) {
            if (checkbox.checked) selectedWordIndices.add(idx);
            else selectedWordIndices.delete(idx);
            updateWordPickerCount();
        }

        function selectAllWords() {
            selectedWordIndices = new Set(chapterWords.map((_, i) => i));
            document.querySelectorAll('#wordPicker input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateWordPickerCount();
        }

        function deselectAllWords() {
            selectedWordIndices.clear();
            document.querySelectorAll('#wordPicker input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateWordPickerCount();
        }

        function updateWordPickerCount() {
            document.getElementById('wordPickerCount').textContent = `${selectedWordIndices.size} word${selectedWordIndices.size !== 1 ? 's' : ''} selected`;
        }

        function getSelectedWords() {
            return [...selectedWordIndices].sort((a, b) => a - b).map(i => chapterWords[i]);
        }

        // === CHALLENGE TYPE ===

        function selectChallengeType(type) {
            selectedType = type;
            document.querySelectorAll('.challenge-type-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('type-' + type).classList.add('selected');
            document.getElementById('timeLimitGroup').style.display = (type === 'speed' || type === 'gold_rush') ? 'block' : 'none';
        }

        // === VIEW SWITCHING ===

        function showView(view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('challengesView').style.display = 'none';
            document.getElementById('createView').style.display = 'none';
            document.getElementById('scoreboardView').style.display = 'none';

            if (view === 'challenges') {
                document.getElementById('challengesView').style.display = 'block';
                document.querySelectorAll('.view-tab')[0].classList.add('active');
                if (realtimeSubscription) { realtimeSubscription.unsubscribe(); realtimeSubscription = null; }
                if (scoreboardPollInterval) { clearInterval(scoreboardPollInterval); scoreboardPollInterval = null; }
            } else if (view === 'create') {
                document.getElementById('createView').style.display = 'block';
                document.querySelectorAll('.view-tab')[1].classList.add('active');
            } else if (view === 'scoreboard') {
                document.getElementById('scoreboardView').style.display = 'block';
            }
        }

        // === GENERATE JOIN CODE ===

        function generateJoinCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no I/O/0/1 to avoid confusion
            let code = 'GO-';
            for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }

        // === CREATE CHALLENGE ===

        async function createChallenge() {
            const title = document.getElementById('challengeTitle').value.trim();
            if (!title) { alert('Please enter a challenge title'); return; }
            if (selectedChapters.size === 0) { alert('Please select at least one chapter'); return; }

            const words = getSelectedWords();
            if (words.length === 0) { alert('Please select at least one word'); return; }

            const timeLimit = (selectedType === 'speed' || selectedType === 'gold_rush') ? parseInt(document.getElementById('timeLimit').value) : null;

            // Calculate word_from and word_to based on selected indices
            const sortedIndices = [...selectedWordIndices].sort((a, b) => a - b);
            const wordFrom = sortedIndices[0] + 1; // 1-based
            const wordTo = sortedIndices[sortedIndices.length - 1] + 1;
            // If all consecutive and all selected, use range; otherwise store individual indices
            const allConsecutive = sortedIndices.length === (wordTo - wordFrom + 1);

            const joinCode = generateJoinCode();

            const { data, error } = await supabase
                .from('challenges')
                .insert({
                    class_id: classId,
                    created_by: currentUser.id,
                    title: title,
                    challenge_type: selectedType,
                    language: getLanguage(),
                    chapters: Array.from(selectedChapters),
                    word_from: allConsecutive ? wordFrom : null,
                    word_to: allConsecutive ? wordTo : null,
                    time_limit_seconds: timeLimit,
                    join_code: joinCode,
                    status: 'waiting',
                    is_active: true
                })
                .select()
                .single();

            if (error) {
                // If join code collision, retry with new code
                if (error.message.includes('unique') || error.message.includes('duplicate')) {
                    const retryCode = generateJoinCode();
                    const { data: d2, error: e2 } = await supabase.from('challenges').insert({
                        class_id: classId, created_by: currentUser.id, title, challenge_type: selectedType,
                        language: getLanguage(), chapters: Array.from(selectedChapters),
                        word_from: allConsecutive ? wordFrom : null, word_to: allConsecutive ? wordTo : null,
                        time_limit_seconds: timeLimit, join_code: retryCode, status: 'waiting', is_active: true
                    }).select().single();
                    if (e2) { alert('Error creating challenge: ' + e2.message); return; }
                    resetForm();
                    await loadChallenges();
                    viewChallenge(d2.id);
                    return;
                }
                alert('Error creating challenge: ' + error.message);
                return;
            }

            resetForm();
            await loadChallenges();
            viewChallenge(data.id);
        }

        function resetForm() {
            document.getElementById('challengeTitle').value = '';
            selectedChapters.clear();
            selectedWordIndices.clear();
            chapterWords = [];
            document.querySelectorAll('#chapterSelector input').forEach(cb => {
                cb.checked = false;
                cb.parentElement.style.borderColor = '#d1d5db';
                cb.parentElement.style.background = 'white';
            });
            document.getElementById('wordPickerGroup').style.display = 'none';
        }

        // === LOAD & RENDER CHALLENGES ===

        async function loadChallenges() {
            const { data, error } = await supabase
                .from('challenges').select('*').eq('class_id', classId)
                .order('created_at', { ascending: false });

            if (error) { console.error('Error loading challenges:', error); return; }
            challenges = data || [];
            renderChallenges();
        }

        function renderChallenges() {
            const container = document.getElementById('challengesContainer');
            if (challenges.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÜ</div>
                        <p>No challenges yet. Create one to get your class competing!</p>
                        <button class="btn btn-primary" onclick="showView('create')">+ Create Challenge</button>
                    </div>`;
                return;
            }

            const typeIcons = { speed: '‚ö°', streak: 'üî•', marathon: 'üèÅ', gold_rush: 'üéÅ' };
            const typeNames = { speed: 'Speed Round', streak: 'Streak Challenge', marathon: 'Marathon', gold_rush: 'Gold Rush' };
            const statusNames = { waiting: 'Waiting', active: 'Live', ended: 'Ended' };
            const statusBadges = { waiting: 'badge-waiting', active: 'badge-active', ended: 'badge-ended' };

            container.innerHTML = challenges.map(ch => `
                <div class="challenge-item">
                    <div class="challenge-item-header">
                        <div class="challenge-item-title">${typeIcons[ch.challenge_type] || ''} ${ch.title}</div>
                        <div style="display: flex; gap: 0.35rem;">
                            <span class="challenge-badge badge-${ch.challenge_type}">${typeNames[ch.challenge_type]}</span>
                            <span class="challenge-badge ${statusBadges[ch.status] || 'badge-ended'}">${statusNames[ch.status] || ch.status}</span>
                        </div>
                    </div>
                    <div class="challenge-meta">
                        <span>üîë ${ch.join_code}</span>
                        <span>üìö Ch ${ch.chapters.join(', ')}</span>
                        ${ch.time_limit_seconds ? `<span>‚è±Ô∏è ${Math.floor(ch.time_limit_seconds / 60)} min</span>` : ''}
                        <span>üìÖ ${new Date(ch.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    <div class="challenge-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewChallenge('${ch.id}')">View Scoreboard</button>
                        ${ch.status === 'ended' ? `<button class="btn btn-success btn-sm" onclick="reactivateChallenge('${ch.id}')">Reactivate</button>` : ''}
                        <button class="btn btn-danger btn-sm" onclick="deleteChallenge('${ch.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function reactivateChallenge(id) {
            const newCode = generateJoinCode();
            await supabase.from('challenges').update({ status: 'waiting', is_active: true, join_code: newCode }).eq('id', id);
            // Clear old attempts
            await supabase.from('challenge_attempts').delete().eq('challenge_id', id);
            await loadChallenges();
        }

        async function deleteChallenge(id) {
            if (!confirm('Delete this challenge? All results will be lost.')) return;
            await supabase.from('challenges').delete().eq('id', id);
            await loadChallenges();
        }

        // === VIEW CHALLENGE / SCOREBOARD ===

        async function viewChallenge(id) {
            viewingChallengeId = id;
            viewingChallenge = challenges.find(c => c.id === id);
            if (!viewingChallenge) return;

            const ch = viewingChallenge;
            const typeNames = { speed: 'Speed Round', streak: 'Streak Challenge', marathon: 'Marathon', gold_rush: 'Gold Rush' };

            document.getElementById('scoreboardTitle').textContent = ch.title;
            document.getElementById('scoreboardSubtitle').textContent =
                typeNames[ch.challenge_type] +
                (ch.time_limit_seconds ? ` - ${Math.floor(ch.time_limit_seconds / 60)} min` : '') +
                ` - Ch ${ch.chapters.join(', ')}`;

            // Join code
            document.getElementById('joinCodeValue').textContent = ch.join_code;

            // Show/hide based on status
            const isWaiting = ch.status === 'waiting';
            const isActive = ch.status === 'active';
            const isEnded = ch.status === 'ended' || !ch.is_active;

            document.getElementById('joinCodeDisplay').style.display = (isWaiting || isActive) ? 'block' : 'none';
            document.getElementById('startSection').style.display = isWaiting ? 'block' : 'none';
            document.getElementById('endChallengeBtn').style.display = (isWaiting || isActive) ? 'inline-flex' : 'none';
            document.getElementById('awardXpBtn').style.display = isEnded ? 'inline-flex' : 'none';
            document.getElementById('autoXpNotice').style.display = 'none';

            if (isActive) {
                document.getElementById('joinCodeDisplay').querySelector('.join-code-hint').textContent =
                    ch.challenge_type === 'gold_rush' ? 'ü™ô Gold Rush is live!' : 'Challenge is live!';
            }

            showView('scoreboard');
            await refreshScoreboard(id, ch.challenge_type);
            subscribeToScoreboard(id, ch.challenge_type);
        }

        // Teacher presses Start
        async function startChallengeNow() {
            if (!viewingChallengeId) return;
            await supabase.from('challenges').update({
                status: 'active',
                started_at: new Date().toISOString()
            }).eq('id', viewingChallengeId);

            // Update local state
            viewingChallenge.status = 'active';
            const idx = challenges.findIndex(c => c.id === viewingChallengeId);
            if (idx >= 0) challenges[idx].status = 'active';

            document.getElementById('startSection').style.display = 'none';
            document.getElementById('joinCodeDisplay').querySelector('.join-code-hint').textContent = 'Challenge is live!';
        }

        // Refresh scoreboard
        async function refreshScoreboard(challengeId, challengeType) {
            // Fetch attempts (no FK join - avoids auth.users vs public.users issues)
            const { data: attempts, error } = await supabase
                .from('challenge_attempts')
                .select('*')
                .eq('challenge_id', challengeId)
                .order('completed', { ascending: false });

            if (error) {
                console.error('Scoreboard fetch error:', error);
            }

            const results = attempts || [];

            // Look up student names separately from public.users
            if (results.length > 0) {
                const studentIds = [...new Set(results.map(a => a.student_id))];
                const { data: users } = await supabase
                    .from('users')
                    .select('id, full_name, selected_emoji, selected_tag')
                    .in('id', studentIds);

                const userMap = {};
                if (users) users.forEach(u => { userMap[u.id] = u; });
                results.forEach(a => {
                    const u = userMap[a.student_id];
                    a.users = { full_name: u?.full_name || 'Student', id: a.student_id, emoji: u?.selected_emoji || null, tag: u?.selected_tag || null };
                });
            }

            lastAttempts = results;
            renderScoreboard(lastAttempts, challengeType);
        }

        function renderScoreboard(attempts, challengeType) {
            const body = document.getElementById('scoreboardBody');
            document.getElementById('scoreboardParticipants').textContent = `${attempts.length} joined`;
            const completedCount = attempts.filter(a => a.completed).length;
            document.getElementById('scoreboardCompleted').textContent = `${completedCount} completed`;

            if (attempts.length === 0) {
                body.innerHTML = `<div class="scoreboard-empty"><div class="scoreboard-empty-icon">‚è≥</div><p>Waiting for students to join...</p><p style="font-size: 0.8rem;">Tell them to enter code <strong>${viewingChallenge?.join_code || ''}</strong></p></div>`;
                return;
            }

            let sorted;
            if (challengeType === 'speed' || challengeType === 'gold_rush') {
                sorted = [...attempts].sort((a, b) => b.score - a.score || a.time_spent_seconds - b.time_spent_seconds);
            } else if (challengeType === 'streak') {
                sorted = [...attempts].sort((a, b) => b.best_streak - a.best_streak || b.score - a.score);
            } else {
                sorted = [...attempts].sort((a, b) => {
                    if (a.completed && !b.completed) return -1;
                    if (!a.completed && b.completed) return 1;
                    if (a.completed && b.completed) return a.time_spent_seconds - b.time_spent_seconds;
                    return b.words_mastered - a.words_mastered;
                });
            }

            // Detect which students' scores changed since last render
            const changedStudents = new Set();
            for (const a of sorted) {
                const key = a.student_id;
                const prevScore = previousScores[key];
                const currentScore = challengeType === 'streak' ? a.best_streak : (challengeType === 'marathon' ? (a.words_mastered || 0) : a.score);
                if (prevScore !== undefined && prevScore !== currentScore) {
                    changedStudents.add(key);
                }
                previousScores[key] = currentScore;
            }

            body.innerHTML = sorted.map((a, i) => {
                const rank = i + 1;
                const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : 'other';
                const rankLabel = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                const name = a.users?.full_name || 'Student';
                const emoji = a.users?.emoji || 'üôÇ';
                const tagId = a.users?.tag;
                const tagInfo = tagId && typeof xpSystem !== 'undefined' ? xpSystem.TAGS?.find(t => t.id === tagId) : null;
                const tagHtml = tagInfo ? `<div class="scoreboard-tag">${tagInfo.emoji} ${tagInfo.text}</div>` : '';
                const flash = changedStudents.has(a.student_id) ? ' score-flash' : '';

                let status, statusClass;
                if (a.completed) { status = 'Finished'; statusClass = 'status-completed'; }
                else if (a.score > 0 || a.total_questions > 0) { status = 'In Progress'; statusClass = 'status-active'; }
                else { status = 'Joined'; statusClass = 'status-waiting'; }

                let value, sublabel, valueStyle = '';
                if (challengeType === 'gold_rush') {
                    value = `ü™ô ${a.score}`;
                    valueStyle = ' style="color: #fbbf24;"';
                    sublabel = `${a.total_questions} answered`;
                } else if (challengeType === 'speed') {
                    value = a.score;
                    const pct = a.total_questions > 0 ? Math.round((a.score / a.total_questions) * 100) : 0;
                    sublabel = `${pct}% accuracy`;
                } else if (challengeType === 'streak') {
                    value = a.best_streak;
                    sublabel = `${a.score}/${a.total_questions} correct`;
                } else {
                    value = a.words_mastered || 0;
                    sublabel = a.completed ? formatTime(a.time_spent_seconds) : 'in progress';
                }

                return `
                    <div class="scoreboard-row rank-${rank <= 3 ? rank : ''}${flash}" data-student="${a.student_id}">
                        <div class="scoreboard-rank ${rankClass}">${rankLabel}</div>
                        <div class="scoreboard-avatar">${emoji}</div>
                        <div class="scoreboard-name">${name}${tagHtml}</div>
                        <span class="scoreboard-status ${statusClass}">${status}</span>
                        <div>
                            <div class="scoreboard-value"${valueStyle}>${value}</div>
                            <div class="scoreboard-sublabel">${sublabel}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        function formatTime(seconds) {
            if (!seconds) return '‚Äî';
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Realtime subscription + polling fallback
        function subscribeToScoreboard(challengeId, challengeType) {
            if (realtimeSubscription) realtimeSubscription.unsubscribe();
            if (scoreboardPollInterval) clearInterval(scoreboardPollInterval);

            // Realtime (may not work without proper publication setup)
            realtimeSubscription = supabase
                .channel(`challenge-${challengeId}`)
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'challenge_attempts', filter: `challenge_id=eq.${challengeId}` },
                    () => { refreshScoreboard(challengeId, challengeType); }
                )
                .subscribe();

            // Polling fallback - every 2 seconds for reliable live updates
            scoreboardPollInterval = setInterval(() => {
                refreshScoreboard(challengeId, challengeType);
            }, 2000);
        }

        // === END CHALLENGE ===

        function endChallenge() { document.getElementById('endChallengeModal').classList.add('open'); }
        function closeEndModal() { document.getElementById('endChallengeModal').classList.remove('open'); }

        async function confirmEndChallenge() {
            closeEndModal();
            await supabase.from('challenges').update({ status: 'ended', is_active: false }).eq('id', viewingChallengeId);
            viewingChallenge.status = 'ended';
            viewingChallenge.is_active = false;

            // Stop live polling (keep realtime for any final saves)
            if (scoreboardPollInterval) { clearInterval(scoreboardPollInterval); scoreboardPollInterval = null; }

            document.getElementById('startSection').style.display = 'none';
            document.getElementById('joinCodeDisplay').style.display = 'none';
            document.getElementById('endChallengeBtn').style.display = 'none';
            document.getElementById('awardXpBtn').style.display = 'inline-flex';

            // One final scoreboard refresh to get the latest data
            await refreshScoreboard(viewingChallengeId, viewingChallenge.challenge_type);

            // Auto-award XP to top 3
            await autoAwardXp();

            await loadChallenges();
        }

        // === XP AWARDS ===

        function sortAttemptsByRank(attempts, challengeType) {
            if (challengeType === 'speed' || challengeType === 'gold_rush') return [...attempts].sort((a, b) => b.score - a.score || a.time_spent_seconds - b.time_spent_seconds);
            if (challengeType === 'streak') return [...attempts].sort((a, b) => b.best_streak - a.best_streak || b.score - a.score);
            return [...attempts].sort((a, b) => { if (a.completed && !b.completed) return -1; if (!a.completed && b.completed) return 1; return a.time_spent_seconds - b.time_spent_seconds; });
        }

        async function autoAwardXp() {
            if (lastAttempts.length === 0) return;
            const ch = viewingChallenge;
            const sorted = sortAttemptsByRank(lastAttempts, ch.challenge_type);
            const xpAmounts = [50, 30, 20]; // 1st, 2nd, 3rd
            let awarded = 0;

            for (let i = 0; i < Math.min(3, sorted.length); i++) {
                const a = sorted[i];
                // Only award to students who actually participated
                if (a.score === 0 && a.total_questions === 0) continue;
                const xp = xpAmounts[i];
                const studentId = a.student_id;

                const { data: user } = await supabase.from('users').select('xp, total_xp_earned').eq('id', studentId).single();
                if (user) {
                    await supabase.from('users').update({
                        xp: (user.xp || 0) + xp,
                        total_xp_earned: (user.total_xp_earned || 0) + xp
                    }).eq('id', studentId);

                    await supabase.from('xp_transactions').insert({
                        user_id: studentId,
                        amount: xp,
                        reason: `Challenge ${i === 0 ? '1st' : i === 1 ? '2nd' : '3rd'} place: ${ch.title}`,
                        reference_id: viewingChallengeId
                    });
                    awarded++;
                }
            }

            if (awarded > 0) {
                const names = sorted.slice(0, Math.min(3, sorted.length))
                    .filter(a => a.score > 0 || a.total_questions > 0)
                    .map((a, i) => `${['ü•á','ü•à','ü•â'][i]} ${a.users?.full_name || 'Student'} (+${xpAmounts[i]} XP)`);
                document.getElementById('autoXpNotice').innerHTML = `<strong>XP auto-awarded:</strong> ${names.join(' &nbsp; ')}`;
                document.getElementById('autoXpNotice').style.display = 'block';
            }
        }

        function openXpModal() {
            const list = document.getElementById('xpAwardList');
            if (lastAttempts.length === 0) { alert('No participants to award XP to.'); return; }

            // Sort by ranking
            const ch = viewingChallenge;
            const sorted = sortAttemptsByRank(lastAttempts, ch.challenge_type);

            // Default XP: 50, 30, 20, 10 for top 4
            const defaults = [50, 30, 20, 10];

            list.innerHTML = sorted.map((a, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
                const name = a.users?.full_name || 'Student';
                const emojiAvatar = a.users?.emoji || 'üôÇ';
                const defaultXp = i < defaults.length ? defaults[i] : 0;
                return `
                    <div class="xp-award-row">
                        <span style="width: 30px; font-weight: 700;">${medal}</span>
                        <span style="font-size: 1.2rem; margin-right: 0.25rem;">${emojiAvatar}</span>
                        <span style="flex: 1;">${name}</span>
                        <input type="number" class="xp-award-input" data-student-id="${a.student_id}" value="${defaultXp}" min="0" max="500" placeholder="0">
                        <span style="font-size: 0.85rem; color: #6b7280;">XP</span>
                    </div>`;
            }).join('');

            document.getElementById('xpModal').classList.add('open');
        }

        function closeXpModal() { document.getElementById('xpModal').classList.remove('open'); }

        async function confirmAwardXp() {
            const inputs = document.querySelectorAll('#xpAwardList .xp-award-input');
            let awarded = 0;

            for (const input of inputs) {
                const xp = parseInt(input.value);
                const studentId = input.dataset.studentId;
                if (!xp || xp <= 0 || !studentId) continue;

                // Update user's XP
                const { data: user } = await supabase.from('users').select('xp, total_xp_earned').eq('id', studentId).single();
                if (user) {
                    await supabase.from('users').update({
                        xp: (user.xp || 0) + xp,
                        total_xp_earned: (user.total_xp_earned || 0) + xp
                    }).eq('id', studentId);

                    // Log XP transaction
                    await supabase.from('xp_transactions').insert({
                        user_id: studentId,
                        amount: xp,
                        reason: `Challenge reward: ${viewingChallenge?.title || 'Challenge'}`,
                        reference_id: viewingChallengeId
                    });

                    awarded++;
                }
            }

            closeXpModal();
            alert(`XP awarded to ${awarded} student${awarded !== 1 ? 's' : ''}!`);
        }

        // === INIT ===

        document.getElementById('endChallengeModal').addEventListener('click', function(e) { if (e.target === this) closeEndModal(); });
        document.getElementById('xpModal').addEventListener('click', function(e) { if (e.target === this) closeXpModal(); });

        init();
    </script>
</body>
</html>
