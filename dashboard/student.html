<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .header p {
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
        }
        .btn-white {
            background: white;
            color: #0066ff;
        }
        .btn-white:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066ff;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Word Mastery Stats */
        .word-mastery-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        /* Language Progress Sections */
        .language-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .language-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }
        .language-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .language-title-icon {
            font-size: 1.5rem;
        }
        .language-practise-btn {
            padding: 0.5rem 1rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
        }
        .language-practise-btn:hover {
            background: #0052cc;
        }
        .language-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .language-stat {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 12px;
        }
        .language-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0066ff;
        }
        .language-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .language-review-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.2s;
        }
        .language-review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .no-classes-message {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        .no-classes-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .no-classes-message h3 {
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .no-classes-message p {
            color: #6b7280;
            margin-bottom: 1rem;
        }
        .mastery-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
        }
        .mastery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .mastery-card.mastered {
            border-left: 4px solid #10b981;
        }
        .mastery-card.learning {
            border-left: 4px solid #f59e0b;
        }
        .mastery-card.struggling {
            border-left: 4px solid #ef4444;
        }
        .mastery-card.review {
            border-left: 4px solid #0066ff;
            cursor: pointer;
        }
        .mastery-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .mastery-count {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
        }
        .mastery-card.mastered .mastery-count { color: #10b981; }
        .mastery-card.learning .mastery-count { color: #f59e0b; }
        .mastery-card.struggling .mastery-count { color: #ef4444; }
        .mastery-card.review .mastery-count { color: #0066ff; }
        .mastery-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Review Weak Words Button */
        .review-weak-section {
            margin-bottom: 2rem;
        }
        .review-weak-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .review-weak-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        /* Word List Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-header h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #1f2937;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #1f2937;
        }
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        .modal-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .modal-tab:hover {
            color: #1f2937;
            background: #f9fafb;
        }
        .modal-tab.active {
            color: #0066ff;
            border-bottom-color: #0066ff;
        }
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }
        .word-list {
            list-style: none;
        }
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
        }
        .word-item:last-child {
            margin-bottom: 0;
        }
        .word-latin {
            font-weight: 600;
            color: #0066ff;
            font-size: 1rem;
        }
        .word-english {
            color: #6b7280;
            font-size: 0.9rem;
        }
        .word-stats {
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .word-accuracy {
            font-weight: 600;
        }
        .word-accuracy.good { color: #10b981; }
        .word-accuracy.okay { color: #f59e0b; }
        .word-accuracy.bad { color: #ef4444; }
        .empty-word-list {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Leaderboard */
        .lb-select {
            padding: 0.35rem 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.8rem;
            background: white;
            cursor: pointer;
        }
        .leaderboard-list {
            list-style: none;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        .leaderboard-item.is-me {
            background: #eff6ff;
            margin: 0 -1.25rem;
            padding-left: 1.25rem;
            padding-right: 1.25rem;
            border-radius: 8px;
        }
        .leaderboard-rank {
            width: 2rem;
            font-weight: 700;
            font-size: 0.9rem;
            color: #6b7280;
        }
        .leaderboard-rank.gold { color: #f59e0b; }
        .leaderboard-rank.silver { color: #9ca3af; }
        .leaderboard-rank.bronze { color: #b45309; }
        .leaderboard-name {
            flex: 1;
            font-weight: 500;
            color: #1f2937;
            font-size: 0.9rem;
        }
        .leaderboard-item.is-me .leaderboard-name {
            color: #0066ff;
        }
        .leaderboard-value {
            font-weight: 600;
            color: #0066ff;
            font-size: 0.85rem;
        }
        .empty-state-small {
            text-align: center;
            padding: 1.5rem;
            color: #6b7280;
            font-size: 0.85rem;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 1.25rem;
            overflow: hidden;
        }

        /* Activity Calendar */
        .calendar-wrapper {
            overflow-x: auto;
        }
        .calendar-grid {
            display: flex;
            gap: 3px;
        }
        .calendar-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .calendar-day {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: #ebedf0;
        }
        .calendar-day.level-1 { background: #9be9a8; }
        .calendar-day.level-2 { background: #40c463; }
        .calendar-day.level-3 { background: #30a14e; }
        .calendar-day.level-4 { background: #216e39; }
        .calendar-day:hover {
            outline: 2px solid #0066ff;
            outline-offset: 1px;
        }
        .calendar-months {
            display: flex;
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            padding-left: 2px;
        }
        .calendar-months span {
            flex: 1;
        }
        .calendar-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .calendar-legend .calendar-day {
            width: 12px;
            height: 12px;
        }

        /* Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .activity-icon.success { background: #dcfce7; }
        .activity-icon.partial { background: #fef3c7; }
        .activity-icon.low { background: #fee2e2; }
        .activity-info { flex: 1; }
        .activity-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .activity-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .activity-score {
            font-weight: 700;
            font-size: 1.1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
        }
        .activity-score.success { background: #dcfce7; color: #166534; }
        .activity-score.partial { background: #fef3c7; color: #92400e; }
        .activity-score.low { background: #fee2e2; color: #dc2626; }

        /* Achievements & Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        .badge.earned {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-color: #fbbf24;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }
        .badge.earned.gold {
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border-color: #f59e0b;
        }
        .badge.earned.purple {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            color: #6d28d9;
            border-color: #a78bfa;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        .badge.earned.green {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border-color: #4ade80;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
        }
        .badge.earned.blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-color: #60a5fa;
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.3);
        }
        .badge.earned.red {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-color: #f87171;
            box-shadow: 0 2px 8px rgba(248, 113, 113, 0.3);
        }
        .badge-icon {
            font-size: 1.1rem;
        }
        .badge-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        .badge-name {
            font-weight: 600;
        }
        .badge-detail {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .badge:not(.earned) {
            opacity: 0.5;
        }
        .badge:not(.earned) .badge-icon {
            filter: grayscale(100%);
        }

        /* Pending Tasks */
        /* Join Class */
        .join-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .join-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .join-input:focus {
            outline: none;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        .join-btn {
            width: 100%;
            padding: 0.75rem 1.25rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .join-btn:hover {
            background: #0052cc;
        }
        .join-message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }
        .join-message.success {
            display: block;
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .join-message.error {
            display: block;
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .my-classes {
            margin-top: 1rem;
        }
        .class-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #eff6ff;
            color: #0066ff;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .task-item {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border: 1px solid #f0f0f0;
        }
        .task-item:last-child {
            margin-bottom: 0;
        }
        .task-top {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .task-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .task-info { 
            flex: 1;
            min-width: 0;
        }
        .task-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }
        .task-due {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .task-due.overdue {
            color: #dc2626;
            font-weight: 600;
        }
        .task-due.soon {
            color: #f59e0b;
        }
        .task-btn {
            width: 100%;
            padding: 0.625rem 1rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            display: block;
        }
        .task-btn:hover {
            background: #0052cc;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .language-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .word-mastery-section {
                grid-template-columns: repeat(2, 1fr);
            }
            .language-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .language-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .language-practise-btn {
                width: 100%;
            }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .modal-tabs {
                flex-wrap: wrap;
            }
            .modal-tab {
                flex: 1 1 50%;
                font-size: 0.8rem;
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üëã Welcome back<span id="userName"></span>!</h1>
                    <p>Keep up the great work with your studies</p>
                </div>
                <div class="header-actions">
                    <a href="../index.html" class="btn btn-ghost">‚Üê Home</a>
                </div>
            </div>
        </div>

        <!-- Achievements Banner -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>üèÜ Achievements</span>
                <span id="achievementCount" style="font-size: 0.85rem; font-weight: normal; color: #6b7280;"></span>
            </div>
            <div class="card-body">
                <div id="achievementsContainer" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Language Progress Sections (dynamically generated) -->
        <div id="languageProgressSections">
            <div class="loading">Loading your progress...</div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Activity Calendar -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìÖ Activity Calendar</div>
                    <div class="card-body">
                        <div class="calendar-wrapper">
                            <div class="calendar-months" id="calendarMonths"></div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                        <div class="calendar-legend">
                            <span>Less</span>
                            <div class="calendar-day"></div>
                            <div class="calendar-day level-1"></div>
                            <div class="calendar-day level-2"></div>
                            <div class="calendar-day level-3"></div>
                            <div class="calendar-day level-4"></div>
                            <span>More</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">üìä Recent Activity</div>
                    <div class="card-body" id="recentActivity">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Pending Tasks -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìù Pending Tasks</div>
                    <div class="card-body" id="pendingTasks">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Class Leaderboard -->
                <div class="card" style="margin-bottom: 1.5rem;" id="leaderboardCard">
                    <div class="card-header">
                        üèÜ Class Leaderboard
                        <select id="leaderboardType" class="lb-select" onchange="renderLeaderboard()">
                            <option value="time">‚è±Ô∏è Time</option>
                            <option value="words">üìö Words</option>
                            <option value="streak">üî• Streak</option>
                            <option value="score">üéØ Score</option>
                        </select>
                    </div>
                    <div class="card-body" id="leaderboardContainer">
                        <div class="empty-state-small">Join a class to see the leaderboard!</div>
                    </div>
                </div>

                <!-- Set Text Progress -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">üìú Set Text Progress</div>
                    <div class="card-body" id="setTextProgress">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    
    <!-- Word List Modal -->
    <div class="modal-overlay" id="wordListModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìö My Word Bank</h3>
                <button class="modal-close" onclick="closeWordListModal()">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="showTab('all')">All (<span id="tabAllCount">0</span>)</button>
                <button class="modal-tab" onclick="showTab('mastered')">üåü Mastered (<span id="tabMasteredCount">0</span>)</button>
                <button class="modal-tab" onclick="showTab('learning')">üìñ Learning (<span id="tabLearningCount">0</span>)</button>
                <button class="modal-tab" onclick="showTab('struggling')">üí™ Need Practice (<span id="tabStrugglingCount">0</span>)</button>
            </div>
            <div class="modal-body" id="wordListBody">
                <div class="empty-word-list">Loading...</div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let attempts = [];

        // Initialize
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Get user profile
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'student') {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = profile;
            document.getElementById('userName').textContent = ', ' + profile.full_name.split(' ')[0];

            // Load all data
            await loadAttempts();
            await loadLanguageProgress(); // New: builds per-language sections
            await loadLeaderboardData();
            renderCalendar();
            renderRecentActivity();
            loadPendingTasks();
            
            // Load achievements (don't crash page on error)
            try {
                await loadAchievements();
            } catch (e) {
                console.error('Error loading achievements:', e);
            }
            
            // Load set text progress (don't let errors crash the whole page)
            try {
                await loadSetTextProgress();
            } catch (e) {
                console.error('Error loading set text progress:', e);
            }
        }
        
        // Language progress data
        let languageData = {}; // { latin: { classes, attempts, words, stats }, greek: {...}, classics: {...} }
        
        // Load and render language progress sections
        async function loadLanguageProgress() {
            const container = document.getElementById('languageProgressSections');
            
            // Get all classes the student is in
            const { data: memberships, error } = await supabase
                .from('class_members')
                .select(`
                    class_id,
                    classes (
                        id,
                        name,
                        type
                    )
                `)
                .eq('student_id', currentUser.id);
            
            if (error || !memberships || memberships.length === 0) {
                container.innerHTML = `
                    <div class="no-classes-message">
                        <div class="no-classes-icon">üìö</div>
                        <h3>No classes yet</h3>
                        <p>Join a class using a code from your teacher to start tracking your progress.</p>
                        <div style="margin-top: 1rem;">
                            <input type="text" id="joinCodeInput" class="join-input" placeholder="e.g. LATIN-7X" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-right: 0.5rem;">
                            <button onclick="joinClass()" class="language-practise-btn">Join Class</button>
                        </div>
                        <div id="joinMessage" class="join-message" style="margin-top: 0.5rem;"></div>
                    </div>
                `;
                return;
            }
            
            // Group classes by type
            const classTypes = {};
            memberships.forEach(m => {
                const type = m.classes.type || 'latin';
                if (!classTypes[type]) {
                    classTypes[type] = [];
                }
                classTypes[type].push(m.classes);
            });
            
            // Get class IDs for each type
            const allClassIds = memberships.map(m => m.class_id);
            
            // Get all word mastery data
            const { data: allWords } = await supabase
                .from('word_mastery')
                .select('*')
                .eq('student_id', currentUser.id);
            
            // Get all task attempts with task info to determine language
            const { data: allAttempts } = await supabase
                .from('task_attempts')
                .select('*, tasks(class_id)')
                .eq('student_id', currentUser.id);
            
            // Get class info for attempts
            const { data: classInfo } = await supabase
                .from('classes')
                .select('id, type')
                .in('id', allClassIds);
            
            const classTypeMap = {};
            (classInfo || []).forEach(c => classTypeMap[c.id] = c.type || 'latin');
            
            // Build data for each language type
            languageData = {};
            
            for (const [type, classes] of Object.entries(classTypes)) {
                const typeClassIds = classes.map(c => c.id);
                
                // Filter attempts for this type's classes
                const typeAttempts = (allAttempts || []).filter(a => {
                    if (!a.tasks) return false;
                    return typeClassIds.includes(a.tasks.class_id);
                });
                
                // Also include free practice (no task_id) - attribute to type based on content_path or default
                const freePractice = (allAttempts || []).filter(a => !a.task_id);
                
                // Filter words for this language
                const langKey = type === 'classics' ? null : type; // Classics has no vocab
                const typeWords = langKey ? (allWords || []).filter(w => (w.language || 'latin') === langKey) : [];
                
                // Calculate stats
                const stats = calculateLanguageStats(typeAttempts, typeWords, type);
                
                languageData[type] = {
                    classes,
                    attempts: typeAttempts,
                    words: typeWords,
                    stats
                };
            }
            
            // Render sections
            renderLanguageSections(container, classTypes);
        }
        
        function calculateLanguageStats(attempts, words, type) {
            // Time spent (sum of all attempts)
            const totalSeconds = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            const totalMinutes = Math.round(totalSeconds / 60);
            const timeStr = totalMinutes >= 60 
                ? `${Math.floor(totalMinutes/60)}h ${totalMinutes%60}m` 
                : `${totalMinutes}m`;
            
            // Streak calculation
            const streak = calculateStreak(attempts);
            
            // Word mastery (for latin/greek only)
            let mastered = 0, learning = 0, struggling = 0;
            if (type !== 'classics') {
                words.forEach(word => {
                    const total = word.correct_count + word.incorrect_count;
                    const accuracy = total > 0 ? (word.correct_count / total) * 100 : 0;
                    
                    if (word.correct_count >= 3 && accuracy >= 70) {
                        mastered++;
                    } else if (accuracy < 50 && word.incorrect_count >= 2) {
                        struggling++;
                    } else {
                        learning++;
                    }
                });
            }
            
            // Average accuracy from attempts
            const completedAttempts = attempts.filter(a => a.score !== null);
            const avgAccuracy = completedAttempts.length > 0
                ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                : 0;
            
            return {
                timeStr,
                totalMinutes,
                streak,
                mastered,
                learning,
                struggling,
                totalWords: words.length,
                avgAccuracy,
                sessionsCompleted: completedAttempts.length
            };
        }
        
        function calculateStreak(attempts) {
            if (!attempts || attempts.length === 0) return 0;
            
            const completedAttempts = attempts.filter(a => a.completed_at);
            if (completedAttempts.length === 0) return 0;
            
            const dates = [...new Set(completedAttempts.map(a =>
                new Date(a.completed_at).toISOString().split('T')[0]
            ))].sort().reverse();
            
            if (dates.length === 0) return 0;
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            if (dates[0] !== today && dates[0] !== yesterday) return 0;
            
            let streak = 1;
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i - 1]);
                const currDate = new Date(dates[i]);
                const diff = (prevDate - currDate) / 86400000;
                
                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }
        
        function renderLanguageSections(container, classTypes) {
            const typeConfig = {
                latin: { 
                    icon: 'üìñ', 
                    name: 'Latin GCSE', 
                    hasVocab: true,
                    practiseUrl: '../latin/vocabulary-hub.html',
                    reviewUrl: '../latin/vocabulary-practice.html?mode=review&language=latin'
                },
                'prep-latin': { 
                    icon: 'üìö', 
                    name: 'Prep Latin', 
                    hasVocab: true,
                    practiseUrl: '../latin/prep-vocabulary-practice.html',
                    reviewUrl: '../latin/prep-vocabulary-practice.html?mode=review&language=prep-latin'
                },
                greek: { 
                    icon: 'üè∫', 
                    name: 'Greek', 
                    hasVocab: true,
                    practiseUrl: '../greek/vocabulary-practice.html',
                    reviewUrl: '../greek/vocabulary-practice.html?mode=review&language=greek'
                },
                classics: { 
                    icon: 'üèõÔ∏è', 
                    name: 'Classical Civilisation', 
                    hasVocab: false,
                    practiseUrl: '../classics/hub.html' // Update when you have Classics hub
                }
            };
            
            let html = '';
            
            // Render in order: Latin GCSE, Prep Latin, Greek, Classics
            const orderedTypes = ['latin', 'prep-latin', 'greek', 'classics'].filter(t => classTypes[t]);
            
            for (const type of orderedTypes) {
                const config = typeConfig[type];
                const data = languageData[type];
                const stats = data.stats;
                
                html += `
                    <div class="language-section">
                        <div class="language-header">
                            <div class="language-title">
                                <span class="language-title-icon">${config.icon}</span>
                                ${config.name} Progress
                            </div>
                            <a href="${config.practiseUrl}" class="language-practise-btn">Practise Now</a>
                        </div>
                        
                        <div class="language-stats">
                            ${config.hasVocab ? `
                                <div class="language-stat">
                                    <div class="language-stat-value">${stats.mastered}</div>
                                    <div class="language-stat-label">üåü Words Mastered</div>
                                </div>
                            ` : ''}
                            <div class="language-stat">
                                <div class="language-stat-value">${stats.timeStr}</div>
                                <div class="language-stat-label">‚è±Ô∏è Time Practised</div>
                            </div>
                            <div class="language-stat">
                                <div class="language-stat-value">${stats.streak}</div>
                                <div class="language-stat-label">üî• Day Streak</div>
                            </div>
                            ${config.hasVocab ? `
                                <div class="language-stat">
                                    <div class="language-stat-value">${stats.struggling}</div>
                                    <div class="language-stat-label">üí™ Need Practice</div>
                                </div>
                            ` : `
                                <div class="language-stat">
                                    <div class="language-stat-value">${stats.sessionsCompleted}</div>
                                    <div class="language-stat-label">‚úÖ Sessions</div>
                                </div>
                            `}
                        </div>
                        
                        ${config.hasVocab && stats.struggling > 0 ? `
                            <a href="${config.reviewUrl}" class="language-review-btn">
                                üí™ Review Weak Words (${stats.struggling})
                            </a>
                        ` : ''}
                    </div>
                `;
            }
            
            // Add join class section at bottom
            html += `
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìù Join a Class</div>
                    <div class="card-body">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #6b7280;">Enter your class code:</label>
                            <input type="text" id="joinCodeInput" class="join-input" placeholder="e.g. LATIN-7X" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; text-transform: uppercase;">
                            <button onclick="joinClass()" style="padding: 0.75rem; background: #0066ff; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Join Class</button>
                            <div id="joinMessage" class="join-message"></div>
                        </div>
                        <div id="myClasses" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Show current classes
            renderMyClasses(classTypes);
        }
        
        function renderMyClasses(classTypes) {
            const container = document.getElementById('myClasses');
            if (!container) return;
            
            const typeConfig = {
                latin: 'üìñ',
                'prep-latin': 'üìö',
                greek: 'üè∫', 
                classics: 'üèõÔ∏è'
            };
            
            let tags = [];
            for (const [type, classes] of Object.entries(classTypes)) {
                classes.forEach(c => {
                    tags.push(`<span class="class-tag">${typeConfig[type] || 'üìö'} ${c.name}</span>`);
                });
            }
            
            if (tags.length > 0) {
                container.innerHTML = '<p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem;">Your classes:</p>' + tags.join('');
            }
        }
        let leaderboardData = [];
        let myClassIds = [];

        // Load leaderboard data for all classmates
        async function loadLeaderboardData() {
            // First get my classes
            const { data: memberships, error: memberError } = await supabase
                .from('class_members')
                .select('class_id')
                .eq('student_id', currentUser.id);

            if (memberError || !memberships || memberships.length === 0) {
                document.getElementById('leaderboardCard').style.display = 'none';
                return;
            }

            myClassIds = memberships.map(m => m.class_id);

            // Get all students in my classes
            const { data: classmates, error: classmatesError } = await supabase
                .from('class_members')
                .select(`
                    student_id,
                    users (
                        id,
                        full_name
                    )
                `)
                .in('class_id', myClassIds);

            if (classmatesError || !classmates) {
                return;
            }

            // Get unique students
            const uniqueStudents = {};
            classmates.forEach(cm => {
                if (cm.users && !uniqueStudents[cm.users.id]) {
                    uniqueStudents[cm.users.id] = cm.users;
                }
            });

            const studentIds = Object.keys(uniqueStudents);

            // Get all attempts for these students
            const { data: allAttempts } = await supabase
                .from('task_attempts')
                .select('*')
                .in('student_id', studentIds);

            // Get word mastery for these students
            const { data: allWords } = await supabase
                .from('word_mastery')
                .select('*')
                .in('student_id', studentIds);

            // Calculate stats for each student
            leaderboardData = studentIds.map(studentId => {
                const student = uniqueStudents[studentId];
                const studentAttempts = (allAttempts || []).filter(a => a.student_id === studentId);
                const studentWords = (allWords || []).filter(w => w.student_id === studentId);

                const totalTime = studentAttempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                const completedAttempts = studentAttempts.filter(a => a.score !== null);
                const avgScore = completedAttempts.length > 0
                    ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                    : 0;

                // Count mastered words
                const wordsMastered = studentWords.filter(w => {
                    const total = w.correct_count + w.incorrect_count;
                    const acc = total > 0 ? (w.correct_count / total) * 100 : 0;
                    return w.correct_count >= 3 && acc >= 70;
                }).length;

                // Calculate streak
                const streak = calculateStudentStreak(studentAttempts);

                return {
                    id: studentId,
                    name: student.full_name || 'Student',
                    isMe: studentId === currentUser.id,
                    totalTime,
                    avgScore,
                    wordsMastered,
                    streak
                };
            });

            renderLeaderboard();
        }

        function calculateStudentStreak(attempts) {
            if (!attempts || attempts.length === 0) return 0;

            const completedAttempts = attempts.filter(a => a.completed_at);
            if (completedAttempts.length === 0) return 0;

            const dates = [...new Set(completedAttempts.map(a =>
                new Date(a.completed_at).toISOString().split('T')[0]
            ))].sort().reverse();

            if (dates.length === 0) return 0;

            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            if (dates[0] !== today && dates[0] !== yesterday) return 0;

            let streak = 1;
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i - 1]);
                const currDate = new Date(dates[i]);
                const diff = (prevDate - currDate) / 86400000;

                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }

            return streak;
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            const type = document.getElementById('leaderboardType').value;

            if (leaderboardData.length === 0) {
                container.innerHTML = '<div class="empty-state-small">No classmates yet</div>';
                return;
            }

            let sorted = [...leaderboardData];
            let valueFormatter;

            switch (type) {
                case 'time':
                    sorted.sort((a, b) => b.totalTime - a.totalTime);
                    valueFormatter = s => {
                        const mins = Math.round(s.totalTime / 60);
                        return mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins}m`;
                    };
                    break;
                case 'words':
                    sorted.sort((a, b) => b.wordsMastered - a.wordsMastered);
                    valueFormatter = s => `${s.wordsMastered}`;
                    break;
                case 'streak':
                    sorted.sort((a, b) => b.streak - a.streak);
                    valueFormatter = s => s.streak > 0 ? `${s.streak} üî•` : '-';
                    break;
                case 'score':
                    sorted.sort((a, b) => b.avgScore - a.avgScore);
                    valueFormatter = s => s.avgScore > 0 ? `${s.avgScore}%` : '-';
                    break;
            }

            // Find my position
            const myPosition = sorted.findIndex(s => s.isMe);

            // Show top 5 + me if I'm not in top 5
            let displayList = sorted.slice(0, 5);
            let showingMe = myPosition < 5;

            if (!showingMe && myPosition >= 0) {
                displayList.push({ separator: true, position: myPosition + 1 });
                displayList.push(sorted[myPosition]);
            }

            container.innerHTML = '<ul class="leaderboard-list">' +
                displayList.map((s, i) => {
                    if (s.separator) {
                        return `<li class="leaderboard-item" style="justify-content: center; color: #9ca3af; font-size: 0.8rem;">¬∑¬∑¬∑</li>`;
                    }
                    const actualRank = s.isMe && !showingMe ? myPosition + 1 : i + 1;
                    const rankClass = actualRank === 1 ? 'gold' : actualRank === 2 ? 'silver' : actualRank === 3 ? 'bronze' : '';
                    const medal = actualRank === 1 ? 'ü•á' : actualRank === 2 ? 'ü•à' : actualRank === 3 ? 'ü•â' : actualRank;
                    return `
                        <li class="leaderboard-item ${s.isMe ? 'is-me' : ''}">
                            <span class="leaderboard-rank ${rankClass}">${medal}</span>
                            <span class="leaderboard-name">${s.isMe ? 'You' : s.name}</span>
                            <span class="leaderboard-value">${valueFormatter(s)}</span>
                        </li>
                    `;
                }).join('') + '</ul>';
        }

        // Word mastery data
        let wordMasteryData = {
            mastered: [],
            learning: [],
            struggling: [],
            all: []
        };

        // Load word mastery from database
        async function loadWordMastery() {
            const { data, error } = await supabase
                .from('word_mastery')
                .select('*')
                .eq('student_id', currentUser.id)
                .order('last_seen_at', { ascending: false });

            if (error) {
                console.error('Error loading word mastery:', error);
                return;
            }

            // Categorise words
            wordMasteryData = {
                mastered: [],
                learning: [],
                struggling: [],
                all: data || []
            };

            (data || []).forEach(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? (word.correct_count / total) * 100 : 0;

                if (word.correct_count >= 3 && accuracy >= 70) {
                    wordMasteryData.mastered.push({ ...word, accuracy });
                } else if (accuracy < 50 && word.incorrect_count >= 2) {
                    wordMasteryData.struggling.push({ ...word, accuracy });
                } else {
                    wordMasteryData.learning.push({ ...word, accuracy });
                }
            });

            // Update stats display
            document.getElementById('masteredCount').textContent = wordMasteryData.mastered.length;
            document.getElementById('learningCount').textContent = wordMasteryData.learning.length;
            document.getElementById('strugglingCount').textContent = wordMasteryData.struggling.length;
            
            // Show/hide review weak words button
            const reviewSection = document.getElementById('reviewWeakSection');
            if (wordMasteryData.struggling.length > 0) {
                reviewSection.style.display = 'block';
                document.getElementById('weakWordCount').textContent = wordMasteryData.struggling.length;
            } else {
                reviewSection.style.display = 'none';
            }
        }

        // Show word list modal
        function showWordList() {
            document.getElementById('wordListModal').classList.add('open');
            showTab('all');
        }

        // Close word list modal
        function closeWordListModal() {
            document.getElementById('wordListModal').classList.remove('open');
        }

        // Show specific tab
        function showTab(tab) {
            // Update active tab
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update counts
            document.getElementById('tabAllCount').textContent = wordMasteryData.all.length;
            document.getElementById('tabMasteredCount').textContent = wordMasteryData.mastered.length;
            document.getElementById('tabLearningCount').textContent = wordMasteryData.learning.length;
            document.getElementById('tabStrugglingCount').textContent = wordMasteryData.struggling.length;

            // Get words for this tab
            let words = [];
            if (tab === 'all') words = wordMasteryData.all;
            else if (tab === 'mastered') words = wordMasteryData.mastered;
            else if (tab === 'learning') words = wordMasteryData.learning;
            else if (tab === 'struggling') words = wordMasteryData.struggling;

            // Render word list
            const body = document.getElementById('wordListBody');
            
            if (words.length === 0) {
                body.innerHTML = '<div class="empty-word-list">No words yet. Start practising to build your word bank!</div>';
                return;
            }

            body.innerHTML = '<ul class="word-list">' + words.map(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? Math.round((word.correct_count / total) * 100) : 0;
                const accuracyClass = accuracy >= 70 ? 'good' : accuracy >= 50 ? 'okay' : 'bad';
                
                return `
                    <li class="word-item">
                        <div>
                            <div class="word-latin">${word.word_latin}</div>
                            <div class="word-english">${word.word_english || ''}</div>
                        </div>
                        <div class="word-stats">
                            <div class="word-accuracy ${accuracyClass}">${accuracy}%</div>
                            <div>${word.correct_count}‚úì ${word.incorrect_count}‚úó</div>
                        </div>
                    </li>
                `;
            }).join('') + '</ul>';
        }

        // Close modal on overlay click
        document.getElementById('wordListModal').addEventListener('click', function(e) {
            if (e.target === this) closeWordListModal();
        });

        // Load classes the student is in
        async function loadMyClasses() {
            const { data: memberships, error } = await supabase
                .from('class_members')
                .select(`
                    class_id,
                    classes (
                        id,
                        name,
                        join_code,
                        type
                    )
                `)
                .eq('student_id', currentUser.id);

            if (error || !memberships || memberships.length === 0) {
                document.getElementById('myClasses').innerHTML = '<p style="color: #6b7280; font-size: 0.85rem;">You haven\'t joined any classes yet.</p>';
                // Hide word mastery if no classes
                document.querySelector('.word-mastery-section').style.display = 'none';
                document.getElementById('reviewWeakSection').style.display = 'none';
                return;
            }

            // Check if student is in any vocab-tracking classes (Latin or Greek)
            const hasVocabClass = memberships.some(m => m.classes.type === 'latin' || m.classes.type === 'greek');
            
            // Hide word mastery stuff if only in Classics classes
            if (!hasVocabClass) {
                document.querySelector('.word-mastery-section').style.display = 'none';
                document.getElementById('reviewWeakSection').style.display = 'none';
                // Hide words option in leaderboard
                const wordsOption = document.querySelector('#leaderboardType option[value="words"]');
                if (wordsOption) wordsOption.style.display = 'none';
            }

            const classesHtml = memberships.map(m => {
                const icons = { latin: 'üìñ', greek: 'üè∫', classics: 'üèõÔ∏è' };
                const icon = icons[m.classes.type] || 'üìö';
                return `<span class="class-tag">${icon} ${m.classes.name}</span>`;
            }).join('');
            
            document.getElementById('myClasses').innerHTML = '<p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem;">Your classes:</p>' + classesHtml;
        }

        // Join a class
        async function joinClass() {
            const input = document.getElementById('joinCodeInput');
            const messageEl = document.getElementById('joinMessage');
            const code = input.value.trim().toUpperCase();

            if (!code) {
                messageEl.textContent = 'Please enter a join code';
                messageEl.className = 'join-message error';
                return;
            }

            // Find the class with this code
            const { data: classData, error: classError } = await supabase
                .from('classes')
                .select('id, name')
                .eq('join_code', code)
                .single();

            if (classError || !classData) {
                messageEl.textContent = 'Class not found. Check the code and try again.';
                messageEl.className = 'join-message error';
                return;
            }

            // Check if already a member
            const { data: existing } = await supabase
                .from('class_members')
                .select('id')
                .eq('class_id', classData.id)
                .eq('student_id', currentUser.id)
                .single();

            if (existing) {
                messageEl.textContent = 'You\'re already in this class!';
                messageEl.className = 'join-message error';
                return;
            }

            // Join the class
            const { error: joinError } = await supabase
                .from('class_members')
                .insert({
                    class_id: classData.id,
                    student_id: currentUser.id
                });

            if (joinError) {
                messageEl.textContent = 'Error joining class. Please try again.';
                messageEl.className = 'join-message error';
                return;
            }

            messageEl.textContent = `Successfully joined "${classData.name}"! üéâ`;
            messageEl.className = 'join-message success';
            input.value = '';

            // Reload language progress and tasks
            await loadLanguageProgress();
            await loadPendingTasks();
        }

        // Load all attempts for this user
        async function loadAttempts() {
            const { data, error } = await supabase
                .from('task_attempts')
                .select('*, tasks(title, due_date)')
                .eq('student_id', currentUser.id)
                .order('started_at', { ascending: false });

            if (error) {
                console.error('Error loading attempts:', error);
                return;
            }

            attempts = data || [];
        }

        // Calculate stats from attempts
        function calculateStats() {
            if (attempts.length === 0) {
                document.getElementById('statStreak').textContent = '0';
                document.getElementById('statTime').textContent = '0';
                document.getElementById('statAccuracy').textContent = '0%';
                document.getElementById('statCompleted').textContent = '0';
                return;
            }

            // Total time
            const totalSeconds = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            const totalMinutes = Math.round(totalSeconds / 60);

            // Average accuracy
            const completedAttempts = attempts.filter(a => a.completed_at && a.score !== null);
            const avgAccuracy = completedAttempts.length > 0
                ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                : 0;

            // Streak calculation
            const streak = calculateStreak();

            // Update display
            document.getElementById('statStreak').textContent = streak;
            document.getElementById('statTime').textContent = totalMinutes;
            document.getElementById('statAccuracy').textContent = avgAccuracy + '%';
            document.getElementById('statCompleted').textContent = completedAttempts.length;
        }

        // Calculate current streak
        function calculateStreak() {
            if (attempts.length === 0) return 0;

            // Get unique practice days
            const days = new Set();
            attempts.forEach(a => {
                if (a.completed_at) {
                    const date = new Date(a.completed_at).toDateString();
                    days.add(date);
                }
            });

            const sortedDays = Array.from(days).map(d => new Date(d)).sort((a, b) => b - a);
            if (sortedDays.length === 0) return 0;

            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Check if most recent activity is today or yesterday
            const mostRecent = sortedDays[0];
            mostRecent.setHours(0, 0, 0, 0);

            if (mostRecent < yesterday) {
                return 0; // Streak broken
            }

            // Count consecutive days
            let checkDate = mostRecent;
            for (const day of sortedDays) {
                day.setHours(0, 0, 0, 0);
                if (day.getTime() === checkDate.getTime()) {
                    streak++;
                    checkDate = new Date(checkDate);
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (day < checkDate) {
                    break;
                }
            }

            return streak;
        }

        // Render activity calendar (last 12 weeks)
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthsDiv = document.getElementById('calendarMonths');
            grid.innerHTML = '';
            monthsDiv.innerHTML = '';

            // Count attempts per day
            const dayCounts = {};
            attempts.forEach(a => {
                if (a.completed_at) {
                    const date = new Date(a.completed_at).toISOString().split('T')[0];
                    dayCounts[date] = (dayCounts[date] || 0) + 1;
                }
            });

            // Generate last 12 weeks (84 days)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find the most recent Sunday to align the grid
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const endDate = new Date(today);
            
            // Start from 12 weeks ago
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 83); // 84 days including today
            
            // Adjust to start on a Sunday
            const startDayOfWeek = startDate.getDay();
            if (startDayOfWeek !== 0) {
                startDate.setDate(startDate.getDate() - startDayOfWeek);
            }

            const weeks = [];
            let currentDate = new Date(startDate);
            let lastMonth = -1;
            const monthLabels = [];

            // Generate weeks
            while (currentDate <= endDate) {
                const week = [];
                
                for (let d = 0; d < 7; d++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dateObj = new Date(currentDate);
                    
                    // Track month changes for labels
                    if (d === 0 && dateObj.getMonth() !== lastMonth) {
                        monthLabels.push({
                            weekIndex: weeks.length,
                            name: dateObj.toLocaleString('en-GB', { month: 'short' })
                        });
                        lastMonth = dateObj.getMonth();
                    }
                    
                    week.push({
                        date: dateStr,
                        display: dateObj.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }),
                        count: dayCounts[dateStr] || 0,
                        isFuture: dateObj > today
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                weeks.push(week);
            }

            // Render month labels
            let monthHtml = '';
            let lastLabelWeek = -1;
            monthLabels.forEach((label, i) => {
                const nextLabel = monthLabels[i + 1];
                const span = nextLabel ? nextLabel.weekIndex - label.weekIndex : weeks.length - label.weekIndex;
                monthHtml += `<span style="flex: ${span};">${label.name}</span>`;
            });
            monthsDiv.innerHTML = monthHtml;

            // Render calendar grid
            weeks.forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'calendar-week';
                
                week.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    
                    if (day.isFuture) {
                        dayDiv.style.opacity = '0.3';
                    } else {
                        if (day.count >= 4) dayDiv.classList.add('level-4');
                        else if (day.count >= 3) dayDiv.classList.add('level-3');
                        else if (day.count >= 2) dayDiv.classList.add('level-2');
                        else if (day.count >= 1) dayDiv.classList.add('level-1');
                    }
                    
                    dayDiv.title = `${day.display}\n${day.count} ${day.count === 1 ? 'activity' : 'activities'}`;
                    weekDiv.appendChild(dayDiv);
                });
                
                grid.appendChild(weekDiv);
            });
        }

        // Render recent activity
        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            const recent = attempts.filter(a => a.completed_at).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>No activity yet. Start practising!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recent.map(a => {
                const score = a.score || 0;
                const scoreClass = score >= 80 ? 'success' : score >= 50 ? 'partial' : 'low';
                const icon = score >= 80 ? '‚úÖ' : score >= 50 ? 'üìù' : 'üìñ';
                const date = new Date(a.completed_at);
                const timeAgo = getTimeAgo(date);
                const duration = Math.round((a.time_spent_seconds || 0) / 60);

                return `
                    <div class="activity-item">
                        <div class="activity-icon ${scoreClass}">${icon}</div>
                        <div class="activity-info">
                            <div class="activity-title">${a.tasks?.title || 'Practice Session'}</div>
                            <div class="activity-meta">${timeAgo} ‚Ä¢ ${duration} min</div>
                        </div>
                        <div class="activity-score ${scoreClass}">${score}%</div>
                    </div>
                `;
            }).join('');
        }

        // Load achievements
        async function loadAchievements() {
            const container = document.getElementById('achievementsContainer');
            if (!container) return;
            
            try {
                // Get word mastery data
                const { data: wordData } = await supabase
                    .from('word_mastery')
                    .select('correct_count, incorrect_count')
                    .eq('student_id', currentUser.id);
                
                const allWords = wordData || [];
                
                // Calculate achievements based on loaded data
                const achievements = [];
                
                // --- STREAK BADGES ---
                const streak = calculateStreak();
                achievements.push({
                    icon: 'üî•',
                    name: '3 Day Streak',
                    detail: 'Practise 3 days in a row',
                    earned: streak >= 3,
                    color: 'red'
                });
                achievements.push({
                    icon: 'üî•',
                    name: '7 Day Streak',
                    detail: 'Practise 7 days in a row',
                    earned: streak >= 7,
                    color: 'red'
                });
                achievements.push({
                    icon: 'üî•',
                    name: '30 Day Streak',
                    detail: 'Practise 30 days in a row',
                    earned: streak >= 30,
                    color: 'red'
                });
                
                // --- TIME BADGES ---
                const totalMinutes = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0) / 60;
                achievements.push({
                    icon: '‚è±Ô∏è',
                    name: '1 Hour Club',
                    detail: `${Math.round(totalMinutes)} mins practised`,
                    earned: totalMinutes >= 60,
                    color: 'blue'
                });
                achievements.push({
                    icon: '‚è±Ô∏è',
                    name: '5 Hour Club',
                    detail: `${Math.round(totalMinutes / 60 * 10) / 10} hours practised`,
                    earned: totalMinutes >= 300,
                    color: 'blue'
                });
                
                // --- WORD MASTERY BADGES ---
                const masteredWords = allWords.filter(w => {
                    const total = w.correct_count + w.incorrect_count;
                    const acc = total > 0 ? (w.correct_count / total) * 100 : 0;
                    return w.correct_count >= 3 && acc >= 70;
                }).length;
                
                achievements.push({
                    icon: 'üìö',
                    name: 'Word Collector',
                    detail: '50 words mastered',
                    earned: masteredWords >= 50,
                    color: 'green'
                });
                achievements.push({
                    icon: 'üìö',
                    name: 'Vocabulary Master',
                    detail: '100 words mastered',
                    earned: masteredWords >= 100,
                    color: 'green'
                });
                achievements.push({
                    icon: 'üìö',
                    name: 'Lexicon Legend',
                    detail: '250 words mastered',
                    earned: masteredWords >= 250,
                    color: 'purple'
                });
                
                // --- SCORE BADGES ---
                const perfectScores = attempts.filter(a => a.score === 100).length;
                const highScores = attempts.filter(a => a.score >= 90).length;
                
                achievements.push({
                    icon: 'üéØ',
                    name: 'Perfectionist',
                    detail: 'First 100% score',
                    earned: perfectScores >= 1,
                    color: 'gold'
                });
                achievements.push({
                    icon: 'üéØ',
                    name: 'Sharpshooter',
                    detail: '10 scores of 90%+',
                    earned: highScores >= 10,
                    color: 'gold'
                });
                
                // --- SESSION BADGES ---
                const totalSessions = attempts.filter(a => a.completed_at).length;
                achievements.push({
                    icon: '‚úÖ',
                    name: 'Getting Started',
                    detail: 'Complete 10 sessions',
                    earned: totalSessions >= 10,
                    color: 'green'
                });
                achievements.push({
                    icon: '‚úÖ',
                    name: 'Dedicated Learner',
                    detail: 'Complete 50 sessions',
                    earned: totalSessions >= 50,
                    color: 'green'
                });
                achievements.push({
                    icon: '‚úÖ',
                    name: 'Latin Legend',
                    detail: 'Complete 100 sessions',
                    earned: totalSessions >= 100,
                    color: 'purple'
                });
                
                // --- LEADERBOARD BADGES ---
                if (myClassIds && myClassIds.length > 0) {
                    const myPosition = await getMyLeaderboardPosition();
                    
                    achievements.push({
                        icon: 'ü•á',
                        name: 'Class Champion',
                        detail: '#1 in class leaderboard',
                        earned: myPosition === 1,
                        color: 'gold'
                    });
                    achievements.push({
                        icon: 'üèÜ',
                        name: 'Top 3',
                        detail: 'Top 3 in class',
                        earned: myPosition > 0 && myPosition <= 3,
                        color: 'gold'
                    });
                }
                
                // Sort: earned first
                achievements.sort((a, b) => {
                    if (a.earned && !b.earned) return -1;
                    if (!a.earned && b.earned) return 1;
                    return 0;
                });
                
                // Render badges
                const earnedCount = achievements.filter(a => a.earned).length;
                
                // Update count in header
                const countEl = document.getElementById('achievementCount');
                if (countEl) countEl.textContent = `${earnedCount}/${achievements.length} unlocked`;
                
                let html = '';
                achievements.forEach(badge => {
                    const colorClass = badge.earned ? `earned ${badge.color}` : '';
                    html += `
                        <div class="badge ${colorClass}" title="${badge.detail}">
                            <span class="badge-icon">${badge.icon}</span>
                            <div class="badge-info">
                                <span class="badge-name">${badge.name}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading achievements:', err);
                container.innerHTML = '<p style="color: #6b7280;">Could not load achievements</p>';
            }
        }
        
        async function getMyLeaderboardPosition() {
            if (!myClassIds || myClassIds.length === 0) return 0;
            
            try {
                // Get all students in my classes
                const { data: members } = await supabase
                    .from('class_members')
                    .select('student_id')
                    .in('class_id', myClassIds);
                
                if (!members || members.length === 0) return 0;
                
                const studentIds = [...new Set(members.map(m => m.student_id))];
                
                // Get word mastery for all students
                const { data: allMastery } = await supabase
                    .from('word_mastery')
                    .select('student_id, correct_count, incorrect_count')
                    .in('student_id', studentIds);
                
                // Calculate mastered words per student
                const studentScores = {};
                studentIds.forEach(id => studentScores[id] = 0);
                
                (allMastery || []).forEach(w => {
                    const total = w.correct_count + w.incorrect_count;
                    const acc = total > 0 ? (w.correct_count / total) * 100 : 0;
                    if (w.correct_count >= 3 && acc >= 70) {
                        studentScores[w.student_id] = (studentScores[w.student_id] || 0) + 1;
                    }
                });
                
                // Sort and find my position
                const sorted = Object.entries(studentScores)
                    .sort((a, b) => b[1] - a[1]);
                
                const position = sorted.findIndex(([id]) => id === currentUser.id) + 1;
                return position;
                
            } catch (err) {
                console.error('Error getting leaderboard position:', err);
                return 0;
            }
        }

        // Load pending tasks (shows all tasks until due date passes)
        async function loadPendingTasks() {
            const container = document.getElementById('pendingTasks');

            // Get classes this student is in
            const { data: memberships } = await supabase
                .from('class_members')
                .select('class_id')
                .eq('student_id', currentUser.id);

            if (!memberships || memberships.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéí</div>
                        <p>Join a class to see tasks</p>
                    </div>
                `;
                return;
            }

            const classIds = memberships.map(m => m.class_id);

            // Get tasks for these classes that haven't passed their due date
            const now = new Date();
            const { data: tasks } = await supabase
                .from('tasks')
                .select('*')
                .in('class_id', classIds)
                .gte('due_date', now.toISOString())
                .order('due_date', { ascending: true });

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>No upcoming tasks!</p>
                    </div>
                `;
                return;
            }

            // Check which tasks have been completed (for visual indicator)
            const completedTaskIds = new Set(attempts.filter(a => a.completed_at).map(a => a.task_id));

            container.innerHTML = tasks.slice(0, 5).map(task => {
                const due = new Date(task.due_date);
                const daysUntil = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                const isCompleted = completedTaskIds.has(task.id);
                
                let dueClass = '';
                let dueText = '';
                
                if (daysUntil === 0) {
                    dueClass = 'soon';
                    dueText = 'Due today!';
                } else if (daysUntil === 1) {
                    dueClass = 'soon';
                    dueText = 'Due tomorrow';
                } else if (daysUntil <= 3) {
                    dueClass = 'soon';
                    dueText = `Due in ${daysUntil} days`;
                } else {
                    dueText = `Due ${due.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
                }

                return `
                    <div class="task-item">
                        <div class="task-top">
                            <div class="task-icon">${isCompleted ? '‚úÖ' : 'üìù'}</div>
                            <div class="task-info">
                                <div class="task-title">${task.title}${isCompleted ? ' <span style="color: #10b981; font-size: 0.75rem;">(done)</span>' : ''}</div>
                                <div class="task-due ${dueClass}">${dueText}</div>
                            </div>
                        </div>
                        <a href="${task.content_path}${task.content_path.includes('?') ? '&' : '?'}task_id=${task.id}" class="task-btn">${isCompleted ? 'Practise Again' : 'Practise Now'}</a>
                    </div>
                `;
            }).join('');
        }

        // Helper: time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        // Load Set Text Progress
        async function loadSetTextProgress() {
            const container = document.getElementById('setTextProgress');
            if (!container) return;
            
            try {
                // Get set text progress
                const { data: progress, error: progressError } = await supabase
                    .from('set_text_progress')
                    .select('*')
                    .eq('student_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                // Get answer stats for accuracy (may not exist yet)
                let answers = [];
                try {
                    const { data: answerData } = await supabase
                        .from('set_text_answers')
                        .select('text_id, is_correct')
                        .eq('user_id', currentUser.id);
                    answers = answerData || [];
                } catch (e) {
                    // Table may not exist yet
                }
                
                if (progressError) {
                    console.error('Set text progress error:', progressError);
                    container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">Set text tracking not available</p>';
                    return;
                }
                
                if (!progress || progress.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 1.5rem; color: #6b7280;">
                            <p style="font-size: 2rem; margin-bottom: 0.5rem;">üìö</p>
                            <p style="margin-bottom: 0.75rem;">No set text attempts yet</p>
                            <a href="../latin/literature/set-text-quiz.html" style="color: #0066ff; text-decoration: none; font-weight: 500;">Start practising ‚Üí</a>
                        </div>
                    `;
                    return;
                }
                
                // Group by text
                const textProgress = {};
                progress.forEach(p => {
                    if (!textProgress[p.text_id]) {
                        textProgress[p.text_id] = {
                            sections: {},
                            totalCorrect: 0,
                            totalQuestions: 0
                        };
                    }
                    // Keep best score per section
                    if (!textProgress[p.text_id].sections[p.section_id] || 
                        p.questions_correct > textProgress[p.text_id].sections[p.section_id].correct) {
                        // Subtract old values if replacing
                        if (textProgress[p.text_id].sections[p.section_id]) {
                            textProgress[p.text_id].totalCorrect -= textProgress[p.text_id].sections[p.section_id].correct;
                            textProgress[p.text_id].totalQuestions -= textProgress[p.text_id].sections[p.section_id].total;
                        }
                        textProgress[p.text_id].sections[p.section_id] = {
                            correct: p.questions_correct,
                            total: p.questions_total,
                            date: p.created_at
                        };
                        // Add new values
                        textProgress[p.text_id].totalCorrect += p.questions_correct || 0;
                        textProgress[p.text_id].totalQuestions += p.questions_total || 0;
                    }
                });
                
                // Known texts and their section counts
                const textInfo = {
                    'messalina': { name: 'Messalina', sections: 9 }
                };
                
                let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                for (const [textId, data] of Object.entries(textProgress)) {
                    const info = textInfo[textId] || { name: textId, sections: 9 };
                    // Calculate accuracy from progress data
                    const accuracy = data.totalQuestions > 0 ? Math.round((data.totalCorrect / data.totalQuestions) * 100) : 0;
                    const sectionsCompleted = Object.keys(data.sections).length;
                    
                    html += `
                        <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <strong style="color: #1f2937;">${info.name}</strong>
                                <span style="font-size: 0.85rem; color: #6b7280;">${sectionsCompleted}/${info.sections} sections</span>
                            </div>
                            <div style="display: flex; gap: 0.35rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                    `;
                    
                    for (let i = 1; i <= info.sections; i++) {
                        const section = data.sections[i];
                        if (section) {
                            const pct = Math.round((section.correct / section.total) * 100);
                            const bgColor = pct >= 70 ? '#dcfce7' : '#fef3c7';
                            const textColor = pct >= 70 ? '#16a34a' : '#d97706';
                            html += `<span style="padding: 0.25rem 0.5rem; background: ${bgColor}; color: ${textColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 500;" title="${section.correct}/${section.total}">¬ß${i}: ${pct}%</span>`;
                        } else {
                            html += `<span style="padding: 0.25rem 0.5rem; background: #f3f4f6; color: #9ca3af; border-radius: 4px; font-size: 0.75rem;">¬ß${i}</span>`;
                        }
                    }
                    
                    html += `
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: #6b7280;">
                                <span>üéØ ${accuracy}% accuracy</span>
                                <span>‚ùì ${data.totalQuestions} questions</span>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                    <a href="../latin/literature/set-text-review.html" style="color: #0066ff; text-decoration: none; font-weight: 500;">üìù Review wrong answers ‚Üí</a>
                </div>`;
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading set text progress:', err);
                container.innerHTML = '<p style="color: #dc2626; padding: 1rem;">Error loading progress</p>';
            }
        }

        // Start
        init();
        
        // Allow Enter key to join (if join input exists)
        const joinInput = document.getElementById('joinCodeInput');
        if (joinInput) {
            joinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') joinClass();
            });
        }
    </script>
</body>
</html>
