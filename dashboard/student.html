<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .header p {
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
        }
        .btn-white {
            background: white;
            color: #0066ff;
        }
        .btn-white:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066ff;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 1.25rem;
        }

        /* Activity Calendar */
        .calendar-wrapper {
            overflow-x: auto;
        }
        .calendar-grid {
            display: flex;
            gap: 3px;
        }
        .calendar-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .calendar-day {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: #ebedf0;
        }
        .calendar-day.level-1 { background: #9be9a8; }
        .calendar-day.level-2 { background: #40c463; }
        .calendar-day.level-3 { background: #30a14e; }
        .calendar-day.level-4 { background: #216e39; }
        .calendar-day:hover {
            outline: 2px solid #0066ff;
            outline-offset: 1px;
        }
        .calendar-months {
            display: flex;
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            padding-left: 2px;
        }
        .calendar-months span {
            flex: 1;
        }
        .calendar-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .calendar-legend .calendar-day {
            width: 12px;
            height: 12px;
        }

        /* Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .activity-icon.success { background: #dcfce7; }
        .activity-icon.partial { background: #fef3c7; }
        .activity-icon.low { background: #fee2e2; }
        .activity-info { flex: 1; }
        .activity-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .activity-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .activity-score {
            font-weight: 700;
            font-size: 1.1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
        }
        .activity-score.success { background: #dcfce7; color: #166534; }
        .activity-score.partial { background: #fef3c7; color: #92400e; }
        .activity-score.low { background: #fee2e2; color: #dc2626; }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .achievement {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #f0f0f0;
        }
        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }
        .achievement-icon {
            font-size: 1.5rem;
        }
        .achievement-info {
            flex: 1;
        }
        .achievement-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: #1f2937;
        }
        .achievement-desc {
            font-size: 0.7rem;
            color: #6b7280;
        }

        /* Pending Tasks */
        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border: 1px solid #f0f0f0;
        }
        .task-item:last-child {
            margin-bottom: 0;
        }
        .task-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .task-info { flex: 1; }
        .task-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .task-due {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .task-due.overdue {
            color: #dc2626;
            font-weight: 600;
        }
        .task-due.soon {
            color: #f59e0b;
        }
        .task-btn {
            padding: 0.5rem 1rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
        }
        .task-btn:hover {
            background: #0052cc;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .achievements-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üëã Welcome back, <span id="userName">Student</span>!</h1>
                    <p>Keep up the great work with your Latin studies</p>
                </div>
                <div class="header-actions">
                    <a href="../index.html" class="btn btn-ghost">‚Üê Home</a>
                    <a href="../latin/vocabulary-hub.html" class="btn btn-white">Practice Now</a>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-value" id="statStreak">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="statTime">0</div>
                <div class="stat-label">Minutes Practised</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value" id="statAccuracy">0%</div>
                <div class="stat-label">Average Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="statCompleted">0</div>
                <div class="stat-label">Tasks Completed</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Activity Calendar -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìÖ Activity Calendar</div>
                    <div class="card-body">
                        <div class="calendar-wrapper">
                            <div class="calendar-months" id="calendarMonths"></div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                        <div class="calendar-legend">
                            <span>Less</span>
                            <div class="calendar-day"></div>
                            <div class="calendar-day level-1"></div>
                            <div class="calendar-day level-2"></div>
                            <div class="calendar-day level-3"></div>
                            <div class="calendar-day level-4"></div>
                            <span>More</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">üìä Recent Activity</div>
                    <div class="card-body" id="recentActivity">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Pending Tasks -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìù Pending Tasks</div>
                    <div class="card-body" id="pendingTasks">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <div class="card-header">üèÜ Achievements</div>
                    <div class="card-body">
                        <div class="achievements-grid" id="achievements">
                            <!-- Achievements will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    <script>
        let currentUser = null;
        let attempts = [];

        // Achievement definitions
        const ACHIEVEMENTS = [
            { key: 'first_steps', icon: 'üåü', name: 'First Steps', desc: 'Complete your first exercise', check: (stats) => stats.completed >= 1 },
            { key: 'streak_3', icon: 'üî•', name: 'Getting Warm', desc: '3-day streak', check: (stats) => stats.streak >= 3 },
            { key: 'streak_7', icon: 'üî•', name: 'On Fire', desc: '7-day streak', check: (stats) => stats.streak >= 7 },
            { key: 'perfect', icon: 'üíØ', name: 'Perfectionist', desc: 'Get 100% on an exercise', check: (stats) => stats.hasPerfect },
            { key: 'five_complete', icon: 'üìö', name: 'Scholar', desc: 'Complete 5 tasks', check: (stats) => stats.completed >= 5 },
            { key: 'ten_complete', icon: 'üéì', name: 'Graduate', desc: 'Complete 10 tasks', check: (stats) => stats.completed >= 10 },
            { key: 'hour', icon: '‚è∞', name: 'Dedicated', desc: 'Practice for 1 hour total', check: (stats) => stats.totalMinutes >= 60 },
            { key: 'early_bird', icon: '‚ö°', name: 'Early Bird', desc: 'Complete a task before due date', check: (stats) => stats.hasEarly },
        ];

        // Initialize
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Get user profile
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'student') {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = profile;
            document.getElementById('userName').textContent = profile.full_name.split(' ')[0];

            // Load all data
            await loadAttempts();
            calculateStats();
            renderCalendar();
            renderRecentActivity();
            renderAchievements();
            loadPendingTasks();
        }

        // Load all attempts for this user
        async function loadAttempts() {
            const { data, error } = await supabase
                .from('task_attempts')
                .select('*, tasks(title, due_date)')
                .eq('student_id', currentUser.id)
                .order('started_at', { ascending: false });

            if (error) {
                console.error('Error loading attempts:', error);
                return;
            }

            attempts = data || [];
        }

        // Calculate stats from attempts
        function calculateStats() {
            if (attempts.length === 0) {
                document.getElementById('statStreak').textContent = '0';
                document.getElementById('statTime').textContent = '0';
                document.getElementById('statAccuracy').textContent = '0%';
                document.getElementById('statCompleted').textContent = '0';
                return;
            }

            // Total time
            const totalSeconds = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            const totalMinutes = Math.round(totalSeconds / 60);

            // Average accuracy
            const completedAttempts = attempts.filter(a => a.completed_at && a.score !== null);
            const avgAccuracy = completedAttempts.length > 0
                ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                : 0;

            // Streak calculation
            const streak = calculateStreak();

            // Update display
            document.getElementById('statStreak').textContent = streak;
            document.getElementById('statTime').textContent = totalMinutes;
            document.getElementById('statAccuracy').textContent = avgAccuracy + '%';
            document.getElementById('statCompleted').textContent = completedAttempts.length;
        }

        // Calculate current streak
        function calculateStreak() {
            if (attempts.length === 0) return 0;

            // Get unique practice days
            const days = new Set();
            attempts.forEach(a => {
                if (a.completed_at) {
                    const date = new Date(a.completed_at).toDateString();
                    days.add(date);
                }
            });

            const sortedDays = Array.from(days).map(d => new Date(d)).sort((a, b) => b - a);
            if (sortedDays.length === 0) return 0;

            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Check if most recent activity is today or yesterday
            const mostRecent = sortedDays[0];
            mostRecent.setHours(0, 0, 0, 0);

            if (mostRecent < yesterday) {
                return 0; // Streak broken
            }

            // Count consecutive days
            let checkDate = mostRecent;
            for (const day of sortedDays) {
                day.setHours(0, 0, 0, 0);
                if (day.getTime() === checkDate.getTime()) {
                    streak++;
                    checkDate = new Date(checkDate);
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (day < checkDate) {
                    break;
                }
            }

            return streak;
        }

        // Render activity calendar (last 12 weeks)
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthsDiv = document.getElementById('calendarMonths');
            grid.innerHTML = '';
            monthsDiv.innerHTML = '';

            // Count attempts per day
            const dayCounts = {};
            attempts.forEach(a => {
                if (a.completed_at) {
                    const date = new Date(a.completed_at).toISOString().split('T')[0];
                    dayCounts[date] = (dayCounts[date] || 0) + 1;
                }
            });

            // Generate last 12 weeks
            const today = new Date();
            const weeks = [];
            const months = [];
            
            for (let w = 11; w >= 0; w--) {
                const week = [];
                for (let d = 6; d >= 0; d--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (w * 7 + d));
                    week.unshift({
                        date: date.toISOString().split('T')[0],
                        count: dayCounts[date.toISOString().split('T')[0]] || 0,
                        month: date.getMonth()
                    });
                }
                weeks.push(week);
                
                // Track month labels
                if (weeks.length === 1 || week[0].month !== weeks[weeks.length - 2]?.[0]?.month) {
                    months.push({ week: weeks.length - 1, name: new Date(week[0].date).toLocaleString('default', { month: 'short' }) });
                }
            }

            // Render month labels
            const monthNames = ['', '', '', '', '', '', '', '', '', '', '', ''];
            months.forEach(m => {
                monthNames[m.week] = m.name;
            });
            monthsDiv.innerHTML = monthNames.map(m => `<span>${m}</span>`).join('');

            // Render calendar grid
            weeks.forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'calendar-week';
                
                week.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    
                    if (day.count >= 4) dayDiv.classList.add('level-4');
                    else if (day.count >= 3) dayDiv.classList.add('level-3');
                    else if (day.count >= 2) dayDiv.classList.add('level-2');
                    else if (day.count >= 1) dayDiv.classList.add('level-1');
                    
                    dayDiv.title = `${day.date}: ${day.count} ${day.count === 1 ? 'activity' : 'activities'}`;
                    weekDiv.appendChild(dayDiv);
                });
                
                grid.appendChild(weekDiv);
            });
        }

        // Render recent activity
        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            const recent = attempts.filter(a => a.completed_at).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>No activity yet. Start practising!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recent.map(a => {
                const score = a.score || 0;
                const scoreClass = score >= 80 ? 'success' : score >= 50 ? 'partial' : 'low';
                const icon = score >= 80 ? '‚úÖ' : score >= 50 ? 'üìù' : 'üìñ';
                const date = new Date(a.completed_at);
                const timeAgo = getTimeAgo(date);
                const duration = Math.round((a.time_spent_seconds || 0) / 60);

                return `
                    <div class="activity-item">
                        <div class="activity-icon ${scoreClass}">${icon}</div>
                        <div class="activity-info">
                            <div class="activity-title">${a.tasks?.title || 'Practice Session'}</div>
                            <div class="activity-meta">${timeAgo} ‚Ä¢ ${duration} min</div>
                        </div>
                        <div class="activity-score ${scoreClass}">${score}%</div>
                    </div>
                `;
            }).join('');
        }

        // Render achievements
        function renderAchievements() {
            const container = document.getElementById('achievements');
            
            // Calculate stats for achievement checks
            const completedAttempts = attempts.filter(a => a.completed_at);
            const stats = {
                completed: completedAttempts.length,
                streak: calculateStreak(),
                hasPerfect: completedAttempts.some(a => a.score === 100),
                totalMinutes: Math.round(attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0) / 60),
                hasEarly: attempts.some(a => {
                    if (!a.completed_at || !a.tasks?.due_date) return false;
                    return new Date(a.completed_at) < new Date(a.tasks.due_date);
                })
            };

            container.innerHTML = ACHIEVEMENTS.map(ach => {
                const unlocked = ach.check(stats);
                return `
                    <div class="achievement ${unlocked ? '' : 'locked'}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${ach.name}</div>
                            <div class="achievement-desc">${ach.desc}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load pending tasks
        async function loadPendingTasks() {
            const container = document.getElementById('pendingTasks');

            // Get classes this student is in
            const { data: memberships } = await supabase
                .from('class_members')
                .select('class_id')
                .eq('student_id', currentUser.id);

            if (!memberships || memberships.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéí</div>
                        <p>Join a class to see tasks</p>
                    </div>
                `;
                return;
            }

            const classIds = memberships.map(m => m.class_id);

            // Get tasks for these classes
            const { data: tasks } = await supabase
                .from('tasks')
                .select('*')
                .in('class_id', classIds)
                .order('due_date', { ascending: true });

            // Filter out completed tasks
            const completedTaskIds = new Set(attempts.filter(a => a.completed_at).map(a => a.task_id));
            const pendingTasks = (tasks || []).filter(t => !completedTaskIds.has(t.id));

            if (pendingTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>All caught up!</p>
                    </div>
                `;
                return;
            }

            const now = new Date();
            container.innerHTML = pendingTasks.slice(0, 5).map(task => {
                const due = new Date(task.due_date);
                const daysUntil = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                
                let dueClass = '';
                let dueText = '';
                
                if (daysUntil < 0) {
                    dueClass = 'overdue';
                    dueText = `Overdue by ${Math.abs(daysUntil)} day${Math.abs(daysUntil) === 1 ? '' : 's'}`;
                } else if (daysUntil === 0) {
                    dueClass = 'overdue';
                    dueText = 'Due today!';
                } else if (daysUntil <= 2) {
                    dueClass = 'soon';
                    dueText = `Due in ${daysUntil} day${daysUntil === 1 ? '' : 's'}`;
                } else {
                    dueText = `Due ${due.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
                }

                return `
                    <div class="task-item">
                        <div class="task-icon">üìù</div>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-due ${dueClass}">${dueText}</div>
                        </div>
                        <a href="${task.content_path}" class="task-btn">Start</a>
                    </div>
                `;
            }).join('');
        }

        // Helper: time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        // Start
        init();
    </script>
</body>
</html>
