<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .header p {
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
        }
        .btn-white {
            background: white;
            color: #0066ff;
        }
        .btn-white:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .btn-ghost:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066ff;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Word Mastery Stats */
        .word-mastery-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .mastery-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
        }
        .mastery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .mastery-card.mastered {
            border-left: 4px solid #10b981;
        }
        .mastery-card.learning {
            border-left: 4px solid #f59e0b;
        }
        .mastery-card.struggling {
            border-left: 4px solid #ef4444;
        }
        .mastery-card.review {
            border-left: 4px solid #0066ff;
            cursor: pointer;
        }
        .mastery-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .mastery-count {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
        }
        .mastery-card.mastered .mastery-count { color: #10b981; }
        .mastery-card.learning .mastery-count { color: #f59e0b; }
        .mastery-card.struggling .mastery-count { color: #ef4444; }
        .mastery-card.review .mastery-count { color: #0066ff; }
        .mastery-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Word List Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-header h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #1f2937;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #1f2937;
        }
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        .modal-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .modal-tab:hover {
            color: #1f2937;
            background: #f9fafb;
        }
        .modal-tab.active {
            color: #0066ff;
            border-bottom-color: #0066ff;
        }
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }
        .word-list {
            list-style: none;
        }
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
        }
        .word-item:last-child {
            margin-bottom: 0;
        }
        .word-latin {
            font-weight: 600;
            color: #0066ff;
            font-size: 1rem;
        }
        .word-english {
            color: #6b7280;
            font-size: 0.9rem;
        }
        .word-stats {
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .word-accuracy {
            font-weight: 600;
        }
        .word-accuracy.good { color: #10b981; }
        .word-accuracy.okay { color: #f59e0b; }
        .word-accuracy.bad { color: #ef4444; }
        .empty-word-list {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 1.25rem;
            overflow: hidden;
        }

        /* Activity Calendar */
        .calendar-wrapper {
            overflow-x: auto;
        }
        .calendar-grid {
            display: flex;
            gap: 3px;
        }
        .calendar-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .calendar-day {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: #ebedf0;
        }
        .calendar-day.level-1 { background: #9be9a8; }
        .calendar-day.level-2 { background: #40c463; }
        .calendar-day.level-3 { background: #30a14e; }
        .calendar-day.level-4 { background: #216e39; }
        .calendar-day:hover {
            outline: 2px solid #0066ff;
            outline-offset: 1px;
        }
        .calendar-months {
            display: flex;
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            padding-left: 2px;
        }
        .calendar-months span {
            flex: 1;
        }
        .calendar-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .calendar-legend .calendar-day {
            width: 12px;
            height: 12px;
        }

        /* Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .activity-icon.success { background: #dcfce7; }
        .activity-icon.partial { background: #fef3c7; }
        .activity-icon.low { background: #fee2e2; }
        .activity-info { flex: 1; }
        .activity-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .activity-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .activity-score {
            font-weight: 700;
            font-size: 1.1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
        }
        .activity-score.success { background: #dcfce7; color: #166534; }
        .activity-score.partial { background: #fef3c7; color: #92400e; }
        .activity-score.low { background: #fee2e2; color: #dc2626; }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        .achievement {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #f0f0f0;
        }
        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }
        .achievement-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .achievement-info {
            flex: 1;
            min-width: 0;
        }
        .achievement-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: #1f2937;
        }
        .achievement-desc {
            font-size: 0.7rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Pending Tasks */
        /* Join Class */
        .join-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .join-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .join-input:focus {
            outline: none;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        .join-btn {
            width: 100%;
            padding: 0.75rem 1.25rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .join-btn:hover {
            background: #0052cc;
        }
        .join-message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }
        .join-message.success {
            display: block;
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .join-message.error {
            display: block;
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .my-classes {
            margin-top: 1rem;
        }
        .class-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #eff6ff;
            color: #0066ff;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .task-item {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border: 1px solid #f0f0f0;
        }
        .task-item:last-child {
            margin-bottom: 0;
        }
        .task-top {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .task-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .task-info { 
            flex: 1;
            min-width: 0;
        }
        .task-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }
        .task-due {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .task-due.overdue {
            color: #dc2626;
            font-weight: 600;
        }
        .task-due.soon {
            color: #f59e0b;
        }
        .task-btn {
            width: 100%;
            padding: 0.625rem 1rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            display: block;
        }
        .task-btn:hover {
            background: #0052cc;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .word-mastery-section {
                grid-template-columns: repeat(2, 1fr);
            }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            .modal-tabs {
                flex-wrap: wrap;
            }
            .modal-tab {
                flex: 1 1 50%;
                font-size: 0.8rem;
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üëã Welcome back<span id="userName"></span>!</h1>
                    <p>Keep up the great work with your Latin studies</p>
                </div>
                <div class="header-actions">
                    <a href="../index.html" class="btn btn-ghost">‚Üê Home</a>
                    <a href="../latin/vocabulary-hub.html" class="btn btn-white">Practise Now</a>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-value" id="statStreak">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="statTime">0</div>
                <div class="stat-label">Minutes Practised</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value" id="statAccuracy">0%</div>
                <div class="stat-label">Average Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="statCompleted">0</div>
                <div class="stat-label">Tasks Completed</div>
            </div>
        </div>

        <!-- Word Mastery Stats -->
        <div class="word-mastery-section">
            <div class="mastery-card mastered">
                <div class="mastery-icon">üåü</div>
                <div class="mastery-count" id="masteredCount">0</div>
                <div class="mastery-label">Mastered</div>
            </div>
            <div class="mastery-card learning">
                <div class="mastery-icon">üìñ</div>
                <div class="mastery-count" id="learningCount">0</div>
                <div class="mastery-label">Learning</div>
            </div>
            <div class="mastery-card struggling">
                <div class="mastery-icon">üí™</div>
                <div class="mastery-count" id="strugglingCount">0</div>
                <div class="mastery-label">Need Practice</div>
            </div>
            <a href="#" class="mastery-card review" id="reviewWeakBtn" onclick="showWordList()">
                <div class="mastery-icon">üîÑ</div>
                <div class="mastery-count" style="font-size: 1rem;">View</div>
                <div class="mastery-label">My Words</div>
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Activity Calendar -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìÖ Activity Calendar</div>
                    <div class="card-body">
                        <div class="calendar-wrapper">
                            <div class="calendar-months" id="calendarMonths"></div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                        <div class="calendar-legend">
                            <span>Less</span>
                            <div class="calendar-day"></div>
                            <div class="calendar-day level-1"></div>
                            <div class="calendar-day level-2"></div>
                            <div class="calendar-day level-3"></div>
                            <div class="calendar-day level-4"></div>
                            <span>More</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">üìä Recent Activity</div>
                    <div class="card-body" id="recentActivity">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Join a Class -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üéí Join a Class</div>
                    <div class="card-body">
                        <div id="joinMessage" class="join-message"></div>
                        <div class="join-form">
                            <label style="font-size: 0.85rem; color: #6b7280; margin-bottom: -0.25rem;">Enter your class code:</label>
                            <input type="text" id="joinCodeInput" class="join-input" placeholder="e.g. LATIN-7X" maxlength="10">
                            <button class="join-btn" onclick="joinClass()">Join Class</button>
                        </div>
                        <div id="myClasses" class="my-classes"></div>
                    </div>
                </div>

                <!-- Pending Tasks -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">üìù Pending Tasks</div>
                    <div class="card-body" id="pendingTasks">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <div class="card-header">üèÜ Achievements</div>
                    <div class="card-body">
                        <div class="achievements-grid" id="achievements">
                            <!-- Achievements will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../auth/config.js"></script>
    
    <!-- Word List Modal -->
    <div class="modal-overlay" id="wordListModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìö My Word Bank</h3>
                <button class="modal-close" onclick="closeWordListModal()">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="showTab('all')">All (<span id="tabAllCount">0</span>)</button>
                <button class="modal-tab" onclick="showTab('mastered')">üåü Mastered (<span id="tabMasteredCount">0</span>)</button>
                <button class="modal-tab" onclick="showTab('learning')">üìñ Learning (<span id="tabLearningCount">0</span>)</button>
                <button class="modal-tab" onclick="showTab('struggling')">üí™ Need Practice (<span id="tabStrugglingCount">0</span>)</button>
            </div>
            <div class="modal-body" id="wordListBody">
                <div class="empty-word-list">Loading...</div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let attempts = [];

        // Achievement definitions
        const ACHIEVEMENTS = [
            { key: 'first_steps', icon: 'üåü', name: 'First Steps', desc: 'Complete your first exercise', check: (stats) => stats.completed >= 1 },
            { key: 'streak_3', icon: 'üî•', name: 'Getting Warm', desc: '3-day streak', check: (stats) => stats.streak >= 3 },
            { key: 'streak_7', icon: 'üî•', name: 'On Fire', desc: '7-day streak', check: (stats) => stats.streak >= 7 },
            { key: 'perfect', icon: 'üíØ', name: 'Perfectionist', desc: 'Get 100% on an exercise', check: (stats) => stats.hasPerfect },
            { key: 'five_complete', icon: 'üìö', name: 'Scholar', desc: 'Complete 5 tasks', check: (stats) => stats.completed >= 5 },
            { key: 'ten_complete', icon: 'üéì', name: 'Graduate', desc: 'Complete 10 tasks', check: (stats) => stats.completed >= 10 },
            { key: 'hour', icon: '‚è∞', name: 'Dedicated', desc: 'Practice for 1 hour total', check: (stats) => stats.totalMinutes >= 60 },
            { key: 'early_bird', icon: '‚ö°', name: 'Early Bird', desc: 'Complete a task before due date', check: (stats) => stats.hasEarly },
        ];

        // Initialize
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Get user profile
            const { data: profile } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'student') {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = profile;
            document.getElementById('userName').textContent = ', ' + profile.full_name.split(' ')[0];

            // Load all data
            await loadAttempts();
            await loadMyClasses();
            await loadWordMastery();
            calculateStats();
            renderCalendar();
            renderRecentActivity();
            renderAchievements();
            loadPendingTasks();
        }

        // Word mastery data
        let wordMasteryData = {
            mastered: [],
            learning: [],
            struggling: [],
            all: []
        };

        // Load word mastery from database
        async function loadWordMastery() {
            const { data, error } = await supabase
                .from('word_mastery')
                .select('*')
                .eq('student_id', currentUser.id)
                .order('last_seen_at', { ascending: false });

            if (error) {
                console.error('Error loading word mastery:', error);
                return;
            }

            // Categorise words
            wordMasteryData = {
                mastered: [],
                learning: [],
                struggling: [],
                all: data || []
            };

            (data || []).forEach(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? (word.correct_count / total) * 100 : 0;

                if (word.correct_count >= 3 && accuracy >= 70) {
                    wordMasteryData.mastered.push({ ...word, accuracy });
                } else if (accuracy < 50 && word.incorrect_count >= 2) {
                    wordMasteryData.struggling.push({ ...word, accuracy });
                } else {
                    wordMasteryData.learning.push({ ...word, accuracy });
                }
            });

            // Update stats display
            document.getElementById('masteredCount').textContent = wordMasteryData.mastered.length;
            document.getElementById('learningCount').textContent = wordMasteryData.learning.length;
            document.getElementById('strugglingCount').textContent = wordMasteryData.struggling.length;
        }

        // Show word list modal
        function showWordList() {
            document.getElementById('wordListModal').classList.add('open');
            showTab('all');
        }

        // Close word list modal
        function closeWordListModal() {
            document.getElementById('wordListModal').classList.remove('open');
        }

        // Show specific tab
        function showTab(tab) {
            // Update active tab
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update counts
            document.getElementById('tabAllCount').textContent = wordMasteryData.all.length;
            document.getElementById('tabMasteredCount').textContent = wordMasteryData.mastered.length;
            document.getElementById('tabLearningCount').textContent = wordMasteryData.learning.length;
            document.getElementById('tabStrugglingCount').textContent = wordMasteryData.struggling.length;

            // Get words for this tab
            let words = [];
            if (tab === 'all') words = wordMasteryData.all;
            else if (tab === 'mastered') words = wordMasteryData.mastered;
            else if (tab === 'learning') words = wordMasteryData.learning;
            else if (tab === 'struggling') words = wordMasteryData.struggling;

            // Render word list
            const body = document.getElementById('wordListBody');
            
            if (words.length === 0) {
                body.innerHTML = '<div class="empty-word-list">No words yet. Start practising to build your word bank!</div>';
                return;
            }

            body.innerHTML = '<ul class="word-list">' + words.map(word => {
                const total = word.correct_count + word.incorrect_count;
                const accuracy = total > 0 ? Math.round((word.correct_count / total) * 100) : 0;
                const accuracyClass = accuracy >= 70 ? 'good' : accuracy >= 50 ? 'okay' : 'bad';
                
                return `
                    <li class="word-item">
                        <div>
                            <div class="word-latin">${word.word_latin}</div>
                            <div class="word-english">${word.word_english || ''}</div>
                        </div>
                        <div class="word-stats">
                            <div class="word-accuracy ${accuracyClass}">${accuracy}%</div>
                            <div>${word.correct_count}‚úì ${word.incorrect_count}‚úó</div>
                        </div>
                    </li>
                `;
            }).join('') + '</ul>';
        }

        // Close modal on overlay click
        document.getElementById('wordListModal').addEventListener('click', function(e) {
            if (e.target === this) closeWordListModal();
        });

        // Load classes the student is in
        async function loadMyClasses() {
            const { data: memberships, error } = await supabase
                .from('class_members')
                .select(`
                    class_id,
                    classes (
                        id,
                        name,
                        join_code
                    )
                `)
                .eq('student_id', currentUser.id);

            if (error || !memberships || memberships.length === 0) {
                document.getElementById('myClasses').innerHTML = '<p style="color: #6b7280; font-size: 0.85rem;">You haven\'t joined any classes yet.</p>';
                return;
            }

            const classesHtml = memberships.map(m => 
                `<span class="class-tag">üìö ${m.classes.name}</span>`
            ).join('');
            
            document.getElementById('myClasses').innerHTML = '<p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem;">Your classes:</p>' + classesHtml;
        }

        // Join a class
        async function joinClass() {
            const input = document.getElementById('joinCodeInput');
            const messageEl = document.getElementById('joinMessage');
            const code = input.value.trim().toUpperCase();

            if (!code) {
                messageEl.textContent = 'Please enter a join code';
                messageEl.className = 'join-message error';
                return;
            }

            // Find the class with this code
            const { data: classData, error: classError } = await supabase
                .from('classes')
                .select('id, name')
                .eq('join_code', code)
                .single();

            if (classError || !classData) {
                messageEl.textContent = 'Class not found. Check the code and try again.';
                messageEl.className = 'join-message error';
                return;
            }

            // Check if already a member
            const { data: existing } = await supabase
                .from('class_members')
                .select('id')
                .eq('class_id', classData.id)
                .eq('student_id', currentUser.id)
                .single();

            if (existing) {
                messageEl.textContent = 'You\'re already in this class!';
                messageEl.className = 'join-message error';
                return;
            }

            // Join the class
            const { error: joinError } = await supabase
                .from('class_members')
                .insert({
                    class_id: classData.id,
                    student_id: currentUser.id
                });

            if (joinError) {
                messageEl.textContent = 'Error joining class. Please try again.';
                messageEl.className = 'join-message error';
                return;
            }

            messageEl.textContent = `Successfully joined "${classData.name}"! üéâ`;
            messageEl.className = 'join-message success';
            input.value = '';

            // Reload classes and tasks
            await loadMyClasses();
            await loadPendingTasks();
        }

        // Load all attempts for this user
        async function loadAttempts() {
            const { data, error } = await supabase
                .from('task_attempts')
                .select('*, tasks(title, due_date)')
                .eq('student_id', currentUser.id)
                .order('started_at', { ascending: false });

            if (error) {
                console.error('Error loading attempts:', error);
                return;
            }

            attempts = data || [];
        }

        // Calculate stats from attempts
        function calculateStats() {
            if (attempts.length === 0) {
                document.getElementById('statStreak').textContent = '0';
                document.getElementById('statTime').textContent = '0';
                document.getElementById('statAccuracy').textContent = '0%';
                document.getElementById('statCompleted').textContent = '0';
                return;
            }

            // Total time
            const totalSeconds = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            const totalMinutes = Math.round(totalSeconds / 60);

            // Average accuracy
            const completedAttempts = attempts.filter(a => a.completed_at && a.score !== null);
            const avgAccuracy = completedAttempts.length > 0
                ? Math.round(completedAttempts.reduce((sum, a) => sum + a.score, 0) / completedAttempts.length)
                : 0;

            // Streak calculation
            const streak = calculateStreak();

            // Update display
            document.getElementById('statStreak').textContent = streak;
            document.getElementById('statTime').textContent = totalMinutes;
            document.getElementById('statAccuracy').textContent = avgAccuracy + '%';
            document.getElementById('statCompleted').textContent = completedAttempts.length;
        }

        // Calculate current streak
        function calculateStreak() {
            if (attempts.length === 0) return 0;

            // Get unique practice days
            const days = new Set();
            attempts.forEach(a => {
                if (a.completed_at) {
                    const date = new Date(a.completed_at).toDateString();
                    days.add(date);
                }
            });

            const sortedDays = Array.from(days).map(d => new Date(d)).sort((a, b) => b - a);
            if (sortedDays.length === 0) return 0;

            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Check if most recent activity is today or yesterday
            const mostRecent = sortedDays[0];
            mostRecent.setHours(0, 0, 0, 0);

            if (mostRecent < yesterday) {
                return 0; // Streak broken
            }

            // Count consecutive days
            let checkDate = mostRecent;
            for (const day of sortedDays) {
                day.setHours(0, 0, 0, 0);
                if (day.getTime() === checkDate.getTime()) {
                    streak++;
                    checkDate = new Date(checkDate);
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (day < checkDate) {
                    break;
                }
            }

            return streak;
        }

        // Render activity calendar (last 12 weeks)
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthsDiv = document.getElementById('calendarMonths');
            grid.innerHTML = '';
            monthsDiv.innerHTML = '';

            // Count attempts per day
            const dayCounts = {};
            attempts.forEach(a => {
                if (a.completed_at) {
                    const date = new Date(a.completed_at).toISOString().split('T')[0];
                    dayCounts[date] = (dayCounts[date] || 0) + 1;
                }
            });

            // Generate last 12 weeks (84 days)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find the most recent Sunday to align the grid
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const endDate = new Date(today);
            
            // Start from 12 weeks ago
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 83); // 84 days including today
            
            // Adjust to start on a Sunday
            const startDayOfWeek = startDate.getDay();
            if (startDayOfWeek !== 0) {
                startDate.setDate(startDate.getDate() - startDayOfWeek);
            }

            const weeks = [];
            let currentDate = new Date(startDate);
            let lastMonth = -1;
            const monthLabels = [];

            // Generate weeks
            while (currentDate <= endDate) {
                const week = [];
                
                for (let d = 0; d < 7; d++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dateObj = new Date(currentDate);
                    
                    // Track month changes for labels
                    if (d === 0 && dateObj.getMonth() !== lastMonth) {
                        monthLabels.push({
                            weekIndex: weeks.length,
                            name: dateObj.toLocaleString('en-GB', { month: 'short' })
                        });
                        lastMonth = dateObj.getMonth();
                    }
                    
                    week.push({
                        date: dateStr,
                        display: dateObj.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }),
                        count: dayCounts[dateStr] || 0,
                        isFuture: dateObj > today
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                weeks.push(week);
            }

            // Render month labels
            let monthHtml = '';
            let lastLabelWeek = -1;
            monthLabels.forEach((label, i) => {
                const nextLabel = monthLabels[i + 1];
                const span = nextLabel ? nextLabel.weekIndex - label.weekIndex : weeks.length - label.weekIndex;
                monthHtml += `<span style="flex: ${span};">${label.name}</span>`;
            });
            monthsDiv.innerHTML = monthHtml;

            // Render calendar grid
            weeks.forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'calendar-week';
                
                week.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    
                    if (day.isFuture) {
                        dayDiv.style.opacity = '0.3';
                    } else {
                        if (day.count >= 4) dayDiv.classList.add('level-4');
                        else if (day.count >= 3) dayDiv.classList.add('level-3');
                        else if (day.count >= 2) dayDiv.classList.add('level-2');
                        else if (day.count >= 1) dayDiv.classList.add('level-1');
                    }
                    
                    dayDiv.title = `${day.display}\n${day.count} ${day.count === 1 ? 'activity' : 'activities'}`;
                    weekDiv.appendChild(dayDiv);
                });
                
                grid.appendChild(weekDiv);
            });
        }

        // Render recent activity
        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            const recent = attempts.filter(a => a.completed_at).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>No activity yet. Start practising!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recent.map(a => {
                const score = a.score || 0;
                const scoreClass = score >= 80 ? 'success' : score >= 50 ? 'partial' : 'low';
                const icon = score >= 80 ? '‚úÖ' : score >= 50 ? 'üìù' : 'üìñ';
                const date = new Date(a.completed_at);
                const timeAgo = getTimeAgo(date);
                const duration = Math.round((a.time_spent_seconds || 0) / 60);

                return `
                    <div class="activity-item">
                        <div class="activity-icon ${scoreClass}">${icon}</div>
                        <div class="activity-info">
                            <div class="activity-title">${a.tasks?.title || 'Practice Session'}</div>
                            <div class="activity-meta">${timeAgo} ‚Ä¢ ${duration} min</div>
                        </div>
                        <div class="activity-score ${scoreClass}">${score}%</div>
                    </div>
                `;
            }).join('');
        }

        // Render achievements
        function renderAchievements() {
            const container = document.getElementById('achievements');
            
            // Calculate stats for achievement checks
            const completedAttempts = attempts.filter(a => a.completed_at);
            const stats = {
                completed: completedAttempts.length,
                streak: calculateStreak(),
                hasPerfect: completedAttempts.some(a => a.score === 100),
                totalMinutes: Math.round(attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0) / 60),
                hasEarly: attempts.some(a => {
                    if (!a.completed_at || !a.tasks?.due_date) return false;
                    return new Date(a.completed_at) < new Date(a.tasks.due_date);
                })
            };

            container.innerHTML = ACHIEVEMENTS.map(ach => {
                const unlocked = ach.check(stats);
                return `
                    <div class="achievement ${unlocked ? '' : 'locked'}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${ach.name}</div>
                            <div class="achievement-desc">${ach.desc}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load pending tasks (shows all tasks until due date passes)
        async function loadPendingTasks() {
            const container = document.getElementById('pendingTasks');

            // Get classes this student is in
            const { data: memberships } = await supabase
                .from('class_members')
                .select('class_id')
                .eq('student_id', currentUser.id);

            if (!memberships || memberships.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéí</div>
                        <p>Join a class to see tasks</p>
                    </div>
                `;
                return;
            }

            const classIds = memberships.map(m => m.class_id);

            // Get tasks for these classes that haven't passed their due date
            const now = new Date();
            const { data: tasks } = await supabase
                .from('tasks')
                .select('*')
                .in('class_id', classIds)
                .gte('due_date', now.toISOString())
                .order('due_date', { ascending: true });

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>No upcoming tasks!</p>
                    </div>
                `;
                return;
            }

            // Check which tasks have been completed (for visual indicator)
            const completedTaskIds = new Set(attempts.filter(a => a.completed_at).map(a => a.task_id));

            container.innerHTML = tasks.slice(0, 5).map(task => {
                const due = new Date(task.due_date);
                const daysUntil = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                const isCompleted = completedTaskIds.has(task.id);
                
                let dueClass = '';
                let dueText = '';
                
                if (daysUntil === 0) {
                    dueClass = 'soon';
                    dueText = 'Due today!';
                } else if (daysUntil === 1) {
                    dueClass = 'soon';
                    dueText = 'Due tomorrow';
                } else if (daysUntil <= 3) {
                    dueClass = 'soon';
                    dueText = `Due in ${daysUntil} days`;
                } else {
                    dueText = `Due ${due.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
                }

                return `
                    <div class="task-item">
                        <div class="task-top">
                            <div class="task-icon">${isCompleted ? '‚úÖ' : 'üìù'}</div>
                            <div class="task-info">
                                <div class="task-title">${task.title}${isCompleted ? ' <span style="color: #10b981; font-size: 0.75rem;">(done)</span>' : ''}</div>
                                <div class="task-due ${dueClass}">${dueText}</div>
                            </div>
                        </div>
                        <a href="${task.content_path}" class="task-btn">${isCompleted ? 'Practise Again' : 'Practise Now'}</a>
                    </div>
                `;
            }).join('');
        }

        // Helper: time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        // Start
        init();
        
        // Allow Enter key to join
        document.getElementById('joinCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') joinClass();
        });
    </script>
</body>
</html>
