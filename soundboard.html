<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classicalia Soundboard</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f5f0e8;
    --parchment: #ebe4d6;
    --ink: #1e1a14;
    --ink-soft: #3d3529;
    --terracotta: #c45a3c;
    --terracotta-light: #d4785f;
    --terracotta-glow: rgba(196, 90, 60, 0.35);
    --gold: #b8973a;
    --gold-light: #d4b85a;
    --olive: #5e7042;
    --olive-light: #7a9058;
    --deep-blue: #3a4a6b;
    --deep-blue-light: #5a6a8b;
    --wine: #7a3b5e;
    --wine-light: #9a5b7e;
    --bronze: #8b6b3e;
    --bronze-light: #ab8b5e;
    --shadow: rgba(44, 36, 22, 0.15);
    --radius: 14px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: #1a1610;
    color: var(--cream);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ---- Header ---- */
  header {
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(30, 26, 20, 0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(245, 240, 232, 0.06);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo { display: flex; align-items: baseline; gap: 0.5rem; }

  .logo h1 {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--cream);
    letter-spacing: -0.02em;
  }

  .logo span {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--terracotta);
    text-transform: uppercase;
    letter-spacing: 0.18em;
  }

  .header-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; justify-content: flex-end; }

  .btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.45rem 0.8rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    color: rgba(245, 240, 232, 0.8);
    background: rgba(245, 240, 232, 0.08);
  }
  .btn:hover { background: rgba(245, 240, 232, 0.14); color: white; }

  .btn-save { background: var(--gold); color: white; }
  .btn-save:hover { background: var(--gold-light); }

  .btn-icon { font-size: 0.9rem; line-height: 1; }

  /* ---- Main ---- */
  main {
    max-width: 960px;
    margin: 0 auto;
    padding: 1.5rem;
  }

  /* Session bar */
  .session-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.2rem;
    flex-wrap: wrap;
  }

  .session-bar input {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.4rem;
    font-weight: 600;
    border: none;
    background: transparent;
    border-bottom: 2px solid rgba(245, 240, 232, 0.12);
    padding: 0.3rem 0.2rem;
    color: var(--cream);
    width: 320px;
    transition: border-color 0.2s;
  }
  .session-bar input:focus { outline: none; border-bottom-color: var(--terracotta); }
  .session-bar input::placeholder { color: rgba(245, 240, 232, 0.25); }

  .sound-count {
    font-size: 0.75rem;
    color: rgba(245, 240, 232, 0.35);
    margin-left: auto;
  }

  /* Upload zone */
  .upload-zone {
    border: 2px dashed rgba(245, 240, 232, 0.12);
    border-radius: var(--radius);
    padding: 1.8rem 1.5rem;
    text-align: center;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
    background: rgba(245, 240, 232, 0.02);
    cursor: pointer;
    position: relative;
  }
  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--terracotta);
    background: rgba(196, 90, 60, 0.06);
  }
  .upload-zone h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: rgba(245, 240, 232, 0.7);
  }
  .upload-zone p {
    font-size: 0.8rem;
    color: rgba(245, 240, 232, 0.35);
  }
  .upload-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  /* ---- DECK GRID ---- */
  .deck {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 700px) {
    .deck { grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
  }

  /* ---- SOUND PAD (Stream Deck style) ---- */
  .pad {
    position: relative;
    border-radius: var(--radius);
    aspect-ratio: 1 / 0.75;
    min-height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    user-select: none;
    transition: all 0.12s ease;
    border: 2px solid rgba(255, 255, 255, 0.06);
    overflow: hidden;
  }

  .pad::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, transparent 60%);
    pointer-events: none;
  }

  .pad:hover {
    transform: translateY(-2px);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .pad:active {
    transform: scale(0.96);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .pad.playing {
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 30px var(--pad-glow, rgba(255,255,255,0.15));
    animation: pulse-glow 1.5s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 20px var(--pad-glow, rgba(255,255,255,0.12)); }
    50% { box-shadow: 0 0 35px var(--pad-glow, rgba(255,255,255,0.25)); }
  }

  /* Pad colours */
  .pad-c0 { background: linear-gradient(145deg, #c45a3c, #a3432a); --pad-glow: rgba(196, 90, 60, 0.4); }
  .pad-c1 { background: linear-gradient(145deg, #b8973a, #977a28); --pad-glow: rgba(184, 151, 58, 0.4); }
  .pad-c2 { background: linear-gradient(145deg, #5e7042, #4a5a32); --pad-glow: rgba(94, 112, 66, 0.4); }
  .pad-c3 { background: linear-gradient(145deg, #3a4a6b, #2a3a55); --pad-glow: rgba(58, 74, 107, 0.4); }
  .pad-c4 { background: linear-gradient(145deg, #7a3b5e, #602a48); --pad-glow: rgba(122, 59, 94, 0.4); }
  .pad-c5 { background: linear-gradient(145deg, #8b6b3e, #70552e); --pad-glow: rgba(139, 107, 62, 0.4); }

  .pad-label {
    font-weight: 700;
    font-size: 1.05rem;
    text-align: center;
    line-height: 1.25;
    padding: 0 0.8rem;
    color: white;
    text-shadow: 0 1px 4px rgba(0,0,0,0.3);
    word-break: break-word;
    max-width: 100%;
  }

  .pad-key {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(255, 255, 255, 0.5);
    background: rgba(0, 0, 0, 0.2);
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
  }

  .pad-duration {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.45);
  }

  /* Pad hover controls */
  .pad-controls {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .pad:hover .pad-controls { opacity: 1; }

  .pad-ctrl {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
  }
  .pad-ctrl:hover { background: rgba(0, 0, 0, 0.6); }

  /* Volume slider on hover */
  .pad-vol {
    position: absolute;
    bottom: 8px;
    left: 12px;
    right: 12px;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .pad:hover .pad-vol { opacity: 1; }

  .pad-vol input[type="range"] {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 3px;
    outline: none;
  }
  .pad-vol input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }

  /* ---- Progress ring ---- */
  .pad-progress {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    height: 4px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 2px;
    width: calc(100% - 24px);
    overflow: hidden;
  }
  .pad-progress-fill {
    height: 100%;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s linear;
  }

  /* ---- Empty state ---- */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: rgba(245, 240, 232, 0.3);
  }
  .empty-state .empty-icon { font-size: 3.5rem; margin-bottom: 1rem; }
  .empty-state h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: rgba(245, 240, 232, 0.4);
  }
  .empty-state p { font-size: 0.85rem; }

  /* ---- Control bar ---- */
  .control-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(30, 26, 20, 0.95);
    backdrop-filter: blur(12px);
    border-top: 1px solid rgba(245, 240, 232, 0.08);
    padding: 0.7rem 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    z-index: 100;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }
  .control-bar.visible { transform: translateY(0); }

  .stop-all-btn {
    background: var(--terracotta);
    color: white;
    border: none;
    padding: 0.55rem 1.5rem;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.15s;
    letter-spacing: 0.02em;
  }
  .stop-all-btn:hover { background: var(--terracotta-light); }

  .now-playing-text {
    font-size: 0.78rem;
    color: rgba(245, 240, 232, 0.5);
  }

  /* ---- Modal ---- */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.active { opacity: 1; pointer-events: auto; }

  .modal {
    background: #2a2520;
    border-radius: var(--radius);
    padding: 1.5rem;
    width: 360px;
    border: 1px solid rgba(245, 240, 232, 0.08);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }
  .modal h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--cream);
  }
  .modal input {
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    padding: 0.6rem 0.8rem;
    border: 1px solid rgba(245, 240, 232, 0.12);
    border-radius: 8px;
    background: rgba(245, 240, 232, 0.05);
    color: var(--cream);
    margin-bottom: 1rem;
  }
  .modal input:focus { outline: none; border-color: var(--terracotta); }
  .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }

  .btn-modal-primary {
    background: var(--terracotta);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
  }
  .btn-modal-primary:hover { background: var(--terracotta-light); }

  .btn-modal-secondary {
    background: rgba(245, 240, 232, 0.08);
    color: rgba(245, 240, 232, 0.7);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
  }

  /* ---- Sessions dropdown ---- */
  .sessions-dropdown { position: relative; }

  .sessions-list {
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: #2a2520;
    border: 1px solid rgba(245, 240, 232, 0.1);
    border-radius: var(--radius);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    min-width: 280px;
    max-height: 320px;
    overflow-y: auto;
    z-index: 150;
    display: none;
  }
  .sessions-list.open { display: block; }

  .session-item {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: background 0.1s;
    border-bottom: 1px solid rgba(245, 240, 232, 0.04);
    font-size: 0.85rem;
  }
  .session-item:hover { background: rgba(245, 240, 232, 0.05); }
  .session-item .session-meta { font-size: 0.68rem; color: rgba(245, 240, 232, 0.3); margin-top: 2px; }

  .session-item-del {
    background: none;
    border: none;
    color: var(--terracotta);
    cursor: pointer;
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .session-item:hover .session-item-del { opacity: 1; }

  .no-sessions {
    padding: 1.5rem;
    text-align: center;
    color: rgba(245, 240, 232, 0.3);
    font-size: 0.8rem;
  }

  /* ---- Toast ---- */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: rgba(245, 240, 232, 0.95);
    color: var(--ink);
    padding: 0.6rem 1.4rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 300;
    pointer-events: none;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
  .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

  .footer-spacer { height: 70px; }

  @media (max-width: 500px) {
    header { flex-direction: column; gap: 0.6rem; align-items: flex-start; }
    .header-actions { width: 100%; justify-content: flex-start; }
    .session-bar input { width: 100%; }
    main { padding: 1rem; }
    .pad { min-height: 110px; }
    .pad-label { font-size: 0.9rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <h1>Classicalia</h1>
    <span>Soundboard</span>
  </div>
  <div class="header-actions">
    <button class="btn btn-save" onclick="saveSession()"><span class="btn-icon">üíæ</span> Save</button>
    <div class="sessions-dropdown">
      <button class="btn" onclick="toggleSessionsList()"><span class="btn-icon">üìÇ</span> Load</button>
      <div class="sessions-list" id="sessionsList"></div>
    </div>
    <button class="btn" onclick="exportSession()"><span class="btn-icon">üì§</span> Export</button>
    <button class="btn" onclick="importSession()"><span class="btn-icon">üì•</span> Import</button>
    <button class="btn" onclick="clearBoard()"><span class="btn-icon">üóëÔ∏è</span> Clear</button>
  </div>
</header>

<main>
  <div class="session-bar">
    <input type="text" id="sessionName" value="House Play Soundboard" placeholder="Session name...">
    <span class="sound-count" id="soundCount"></span>
  </div>

  <div class="upload-zone" id="uploadZone">
    <h2>Drop audio files here</h2>
    <p>MP3, WAV, OGG, M4A ‚Äî click or drag</p>
    <input type="file" id="fileInput" multiple accept="audio/*">
  </div>

  <div class="deck" id="deck"></div>

  <div class="empty-state" id="emptyState">
    <div class="empty-icon">üé≠</div>
    <h3>No sounds loaded</h3>
    <p>Upload audio files to build your deck</p>
  </div>
</main>

<div class="control-bar" id="controlBar">
  <span class="now-playing-text" id="nowPlaying"></span>
  <button class="stop-all-btn" onclick="stopAll()">‚ñ†&ensp;STOP ALL&ensp;(Esc)</button>
</div>

<div class="modal-overlay" id="renameModal">
  <div class="modal">
    <h3>Rename Sound</h3>
    <input type="text" id="renameInput" placeholder="Enter new name...">
    <div class="modal-actions">
      <button class="btn-modal-secondary" onclick="closeRename()">Cancel</button>
      <button class="btn-modal-primary" onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="footer-spacer"></div>
<input type="file" id="importInput" accept=".json" style="display:none">

<script>
  let sounds = [];
  let audioEls = {};
  let playing = new Set();
  let renamingId = null;
  let progressTimers = {};
  const STORE = 'classicalia_sb_sessions';
  const COLORS = 6;
  const KEYS = '123456789QWERTYU';

  // File handling
  const fileInput = document.getElementById('fileInput');
  const uploadZone = document.getElementById('uploadZone');

  uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
  uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
  uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
  fileInput.addEventListener('change', () => { handleFiles(fileInput.files); fileInput.value = ''; });

  function handleFiles(files) {
    Array.from(files).forEach(file => {
      if (!file.type.startsWith('audio/')) return;
      const reader = new FileReader();
      reader.onload = e => {
        const s = {
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          name: file.name.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' '),
          dataUrl: e.target.result,
          volume: 1,
          ci: sounds.length % COLORS
        };
        sounds.push(s);
        mkAudio(s);
        render();
      };
      reader.readAsDataURL(file);
    });
  }

  function mkAudio(s) {
    const a = new Audio(s.dataUrl);
    a.volume = s.volume;
    a.addEventListener('ended', () => { playing.delete(s.id); stopProgress(s.id); updateBar(); render(); });
    audioEls[s.id] = a;
  }

  // Render
  function render() {
    const deck = document.getElementById('deck');
    const empty = document.getElementById('emptyState');
    const countEl = document.getElementById('soundCount');

    if (!sounds.length) { deck.innerHTML = ''; empty.style.display = 'block'; countEl.textContent = ''; return; }

    empty.style.display = 'none';
    countEl.textContent = sounds.length + ' sound' + (sounds.length !== 1 ? 's' : '');

    deck.innerHTML = sounds.map((s, i) => {
      const key = i < KEYS.length ? KEYS[i] : '';
      const on = playing.has(s.id);
      const a = audioEls[s.id];
      const dur = a && a.duration && isFinite(a.duration) ? fmt(a.duration) : '';

      return `
        <div class="pad pad-c${s.ci} ${on ? 'playing' : ''}" onclick="toggle('${s.id}')" data-id="${s.id}">
          <div class="pad-controls">
            <button class="pad-ctrl" onclick="event.stopPropagation(); openRename('${s.id}')" title="Rename">‚úèÔ∏è</button>
            <button class="pad-ctrl" onclick="event.stopPropagation(); remove('${s.id}')" title="Remove">‚úï</button>
          </div>
          <div class="pad-label">${esc(s.name)}</div>
          ${key ? `<div class="pad-key">${key}</div>` : ''}
          ${dur ? `<div class="pad-duration">${dur}</div>` : ''}
          <div class="pad-vol" onclick="event.stopPropagation()">
            <input type="range" min="0" max="1" step="0.05" value="${s.volume}" oninput="vol('${s.id}',this.value)">
          </div>
          ${on ? `<div class="pad-progress"><div class="pad-progress-fill" id="prog-${s.id}"></div></div>` : ''}
        </div>`;
    }).join('');

    // Restart progress bars for playing sounds
    playing.forEach(id => startProgress(id));
  }

  function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
  function fmt(s) { return Math.floor(s/60) + ':' + Math.floor(s%60).toString().padStart(2,'0'); }

  // Playback
  function toggle(id) {
    const a = audioEls[id];
    if (!a) return;
    if (playing.has(id)) {
      a.pause(); a.currentTime = 0;
      playing.delete(id);
      stopProgress(id);
    } else {
      a.currentTime = 0;
      a.play().catch(()=>{});
      playing.add(id);
    }
    updateBar(); render();
  }

  function stopAll() {
    playing.forEach(id => {
      const a = audioEls[id];
      if (a) { a.pause(); a.currentTime = 0; }
      stopProgress(id);
    });
    playing.clear();
    updateBar(); render();
  }

  function vol(id, v) {
    const s = sounds.find(x => x.id === id);
    if (s) s.volume = parseFloat(v);
    const a = audioEls[id];
    if (a) a.volume = parseFloat(v);
  }

  // Progress bars
  function startProgress(id) {
    stopProgress(id);
    const a = audioEls[id];
    if (!a || !isFinite(a.duration)) return;
    progressTimers[id] = setInterval(() => {
      const el = document.getElementById('prog-' + id);
      if (el && a.duration) el.style.width = (a.currentTime / a.duration * 100) + '%';
    }, 80);
  }
  function stopProgress(id) {
    if (progressTimers[id]) { clearInterval(progressTimers[id]); delete progressTimers[id]; }
  }

  function updateBar() {
    const bar = document.getElementById('controlBar');
    const np = document.getElementById('nowPlaying');
    if (playing.size) {
      bar.classList.add('visible');
      const names = [...playing].map(id => { const s = sounds.find(x=>x.id===id); return s?s.name:''; }).filter(Boolean);
      np.textContent = 'Now playing: ' + names.join(', ');
    } else bar.classList.remove('visible');
  }

  // Pad management
  function remove(id) {
    const a = audioEls[id]; if(a){a.pause();delete audioEls[id];}
    playing.delete(id); stopProgress(id);
    sounds = sounds.filter(s=>s.id!==id);
    sounds.forEach((s,i)=>s.ci=i%COLORS);
    updateBar(); render();
  }

  function openRename(id) {
    renamingId = id;
    const s = sounds.find(x=>x.id===id);
    document.getElementById('renameInput').value = s?s.name:'';
    document.getElementById('renameModal').classList.add('active');
    setTimeout(()=>document.getElementById('renameInput').focus(),100);
  }
  function closeRename() { document.getElementById('renameModal').classList.remove('active'); renamingId=null; }
  function confirmRename() {
    const v = document.getElementById('renameInput').value.trim();
    if(v&&renamingId){const s=sounds.find(x=>x.id===renamingId);if(s)s.name=v;}
    closeRename(); render();
  }
  document.getElementById('renameInput').addEventListener('keydown',e=>{
    if(e.key==='Enter')confirmRename(); if(e.key==='Escape')closeRename();
  });

  // Sessions
  function getSessions(){try{return JSON.parse(localStorage.getItem(STORE)||'{}');}catch{return {};}}

  function saveSession(){
    const name=document.getElementById('sessionName').value.trim()||'Untitled';
    const ss=getSessions();
    ss[name]={name,savedAt:new Date().toISOString(),sounds:sounds.map(s=>({id:s.id,name:s.name,dataUrl:s.dataUrl,volume:s.volume,ci:s.ci}))};
    localStorage.setItem(STORE,JSON.stringify(ss));
    toast('Session "'+name+'" saved');
  }

  function loadSession(name){
    const ss=getSessions(),s=ss[name]; if(!s)return;
    stopAll(); Object.values(audioEls).forEach(a=>a.pause()); audioEls={}; sounds=[];
    document.getElementById('sessionName').value=s.name;
    s.sounds.forEach(x=>{sounds.push({...x});mkAudio(x);});
    render(); closeSessionsList(); toast('Loaded "'+name+'"');
  }

  function deleteSession(name,e){
    e.stopPropagation();
    const ss=getSessions(); delete ss[name];
    localStorage.setItem(STORE,JSON.stringify(ss));
    renderSessionsList();
  }

  function toggleSessionsList(){
    const l=document.getElementById('sessionsList');
    if(l.classList.contains('open'))l.classList.remove('open');
    else{renderSessionsList();l.classList.add('open');}
  }
  function closeSessionsList(){document.getElementById('sessionsList').classList.remove('open');}

  function renderSessionsList(){
    const l=document.getElementById('sessionsList'),ss=getSessions(),keys=Object.keys(ss);
    if(!keys.length){l.innerHTML='<div class="no-sessions">No saved sessions</div>';return;}
    l.innerHTML=keys.sort((a,b)=>new Date(ss[b].savedAt)-new Date(ss[a].savedAt)).map(n=>{
      const s=ss[n],c=s.sounds?s.sounds.length:0,d=new Date(s.savedAt).toLocaleDateString();
      return `<div class="session-item" onclick="loadSession('${esc(n)}')"><div><div>${esc(n)}</div><div class="session-meta">${c} sounds ¬∑ ${d}</div></div><button class="session-item-del" onclick="deleteSession('${esc(n)}',event)">‚úï</button></div>`;
    }).join('');
  }

  document.addEventListener('click',e=>{if(!document.querySelector('.sessions-dropdown').contains(e.target))closeSessionsList();});

  // Export / Import
  function exportSession(){
    const name=document.getElementById('sessionName').value.trim()||'soundboard';
    const data={name,exportedAt:new Date().toISOString(),sounds:sounds.map(s=>({name:s.name,dataUrl:s.dataUrl,volume:s.volume,ci:s.ci}))};
    const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download=name.replace(/\s+/g,'_')+'.json';a.click();URL.revokeObjectURL(url);
    toast('Session exported');
  }

  function importSession(){document.getElementById('importInput').click();}
  document.getElementById('importInput').addEventListener('change',function(){
    const f=this.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
      try{
        const d=JSON.parse(e.target.result);
        if(!d.sounds||!Array.isArray(d.sounds)){toast('Invalid file');return;}
        stopAll();Object.values(audioEls).forEach(a=>a.pause());audioEls={};sounds=[];
        document.getElementById('sessionName').value=d.name||'Imported';
        d.sounds.forEach((s,i)=>{
          const x={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6)+i,name:s.name,dataUrl:s.dataUrl,volume:s.volume??1,ci:s.ci??(i%COLORS)};
          sounds.push(x);mkAudio(x);
        });
        render(); toast('Imported "' + (d.name||'session') + '"');
      }catch{toast('Could not read file');}
    };
    r.readAsText(f);this.value='';
  });

  function clearBoard(){
    if(!sounds.length)return;
    if(!confirm('Remove all sounds from the board?'))return;
    stopAll();Object.values(audioEls).forEach(a=>a.pause());audioEls={};sounds=[];
    render();toast('Board cleared');
  }

  // Keyboard
  document.addEventListener('keydown',e=>{
    if(e.target.tagName==='INPUT')return;
    if(e.key==='Escape'){stopAll();return;}
    const k=e.key.toUpperCase(),i=KEYS.indexOf(k);
    if(i>=0&&i<sounds.length)toggle(sounds[i].id);
  });

  // Toast
  function toast(msg){
    const t=document.getElementById('toast');t.textContent=msg;
    t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),2200);
  }

  render();
  toast('Keys 1-9, Q-U trigger pads');
</script>

</body>
</html>
