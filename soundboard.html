<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classicalia Soundboard</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f5f0e8;
    --ink: #1e1a14;
    --terracotta: #c45a3c;
    --terracotta-light: #d4785f;
    --gold: #b8973a;
    --gold-light: #d4b85a;
    --olive: #5e7042;
    --deep-blue: #3a4a6b;
    --wine: #7a3b5e;
    --bronze: #8b6b3e;
    --radius: 14px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: #1a1610;
    color: var(--cream);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.4s;
  }

  /* ===== STAGE MODE ===== */
  body.stage-mode { background: #000; }
  body.stage-mode header { background:rgba(0,0,0,0.95); border-bottom-color:rgba(255,255,255,0.03); }
  body.stage-mode .upload-zone { display:none; }
  body.stage-mode .session-bar { display:none; }
  body.stage-mode .pad-controls { display:none; }
  body.stage-mode .cat-select { display:none; }
  body.stage-mode .pad-vol { display:none; }
  body.stage-mode .control-bar { background:rgba(0,0,0,0.95); border-top-color:rgba(255,255,255,0.03); }
  body.stage-mode .cue-bar { background:rgba(255,255,255,0.02); border-color:rgba(255,255,255,0.04); }
  body.stage-mode .pad { border-color:rgba(255,255,255,0.03); }
  body.stage-mode .pad:hover { border-color:rgba(255,255,255,0.08); }
  body.stage-mode .pad.playing { border-color:rgba(255,255,255,0.25); }
  body.stage-mode .pad.cue-next { border-color:rgba(255,255,255,0.45); }
  body.stage-mode .toast { background:rgba(255,255,255,0.1); color:white; }

  /* Fade-in badge */
  .pad-fadein-badge {
    position:absolute; bottom:22px; right:8px;
    font-size:0.55rem; background:rgba(0,0,0,0.35); padding:0.1rem 0.3rem;
    border-radius:4px; color:rgba(255,255,255,0.6); backdrop-filter:blur(4px);
  }
  body.stage-mode .pad-fadein-badge { display:none; }

  /* ===== HEADER ===== */
  header {
    padding: 0.8rem 1.2rem;
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(30,26,20,0.95); backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(245,240,232,0.06);
    position: sticky; top:0; z-index:100;
    flex-wrap: wrap; gap: 0.5rem;
  }
  .logo { display:flex; align-items:baseline; gap:0.5rem; }
  .logo h1 { font-family:'Cormorant Garamond',serif; font-weight:700; font-size:1.4rem; color:var(--cream); letter-spacing:-0.02em; }
  .logo span { font-size:0.6rem; font-weight:600; color:var(--terracotta); text-transform:uppercase; letter-spacing:0.18em; }

  .header-row { display:flex; gap:0.35rem; flex-wrap:wrap; align-items:center; }

  .btn {
    font-family:'DM Sans',sans-serif; font-size:0.7rem; font-weight:600;
    padding:0.4rem 0.7rem; border:none; border-radius:7px; cursor:pointer;
    transition:all 0.2s; display:inline-flex; align-items:center; gap:0.3rem;
    color:rgba(245,240,232,0.75); background:rgba(245,240,232,0.08);
  }
  .btn:hover { background:rgba(245,240,232,0.14); color:white; }
  .btn-save { background:var(--gold); color:white; }
  .btn-save:hover { background:var(--gold-light); }
  .btn-icon { font-size:0.85rem; line-height:1; }

  .btn-stage { background:transparent; border:1px solid rgba(245,240,232,0.15); }
  .btn-stage:hover { background:rgba(245,240,232,0.08); }
  .btn-stage.active { background:var(--ink); border-color:var(--terracotta); color:var(--terracotta); }

  /* ===== TOGGLE PILLS ===== */
  .mode-toggle, .grid-toggle, .fade-toggle {
    display:flex; background:rgba(245,240,232,0.06); border-radius:8px; overflow:hidden; align-items:center;
  }
  .toggle-label {
    font-size:0.6rem; font-weight:600; color:rgba(245,240,232,0.35);
    padding:0 0.5rem; letter-spacing:0.05em; white-space:nowrap;
  }
  .mode-btn, .grid-btn, .fade-btn {
    font-family:'DM Sans',sans-serif; font-size:0.7rem; font-weight:600;
    padding:0.4rem 0.6rem; border:none; cursor:pointer;
    color:rgba(245,240,232,0.5); background:transparent; transition:all 0.2s;
    min-width:28px; text-align:center; white-space:nowrap;
  }
  .mode-btn.active { background:var(--terracotta); color:white; }
  .grid-btn.active { background:var(--deep-blue); color:white; }
  .fade-btn.active { background:var(--olive); color:white; }
  .mode-btn:hover:not(.active), .grid-btn:hover:not(.active), .fade-btn:hover:not(.active) { color:rgba(245,240,232,0.8); }

  /* ===== MAIN ===== */
  main { max-width:1000px; margin:0 auto; padding:1.2rem; }

  .session-bar {
    display:flex; align-items:center; gap:0.8rem; margin-bottom:1rem; flex-wrap:wrap;
  }
  .session-bar input {
    font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:600;
    border:none; background:transparent; border-bottom:2px solid rgba(245,240,232,0.1);
    padding:0.25rem 0.2rem; color:var(--cream); width:280px; transition:border-color 0.2s;
  }
  .session-bar input:focus { outline:none; border-bottom-color:var(--terracotta); }
  .session-bar input::placeholder { color:rgba(245,240,232,0.2); }
  .sound-count { font-size:0.7rem; color:rgba(245,240,232,0.3); margin-left:auto; }

  /* Master volume */
  .master-vol {
    display:flex; align-items:center; gap:0.5rem; font-size:0.7rem; color:rgba(245,240,232,0.5);
  }
  .master-vol input[type="range"] {
    width:80px; height:4px; -webkit-appearance:none; appearance:none;
    background:rgba(245,240,232,0.15); border-radius:2px; outline:none;
  }
  .master-vol input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance:none; width:14px; height:14px; border-radius:50%;
    background:var(--cream); cursor:pointer;
  }

  /* Upload */
  .upload-zone {
    border:2px dashed rgba(245,240,232,0.1); border-radius:var(--radius);
    padding:1.5rem; text-align:center; margin-bottom:1.2rem;
    transition:all 0.3s; background:rgba(245,240,232,0.02); cursor:pointer; position:relative;
  }
  .upload-zone:hover,.upload-zone.drag-over { border-color:var(--terracotta); background:rgba(196,90,60,0.05); }
  .upload-zone h2 { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600; margin-bottom:0.2rem; color:rgba(245,240,232,0.6); }
  .upload-zone p { font-size:0.75rem; color:rgba(245,240,232,0.3); }
  .upload-zone input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; }

  /* ===== DECK GRID ===== */
  .deck {
    display:grid; grid-template-columns:repeat(var(--cols,3),1fr); gap:0.9rem; margin-bottom:1.5rem;
  }
  @media(max-width:700px){ .deck{grid-template-columns:repeat(min(var(--cols,3),2),1fr);gap:0.7rem;} }

  /* ===== PAD ===== */
  .pad {
    position:relative; border-radius:var(--radius); aspect-ratio:1/0.72; min-height:130px;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.35rem;
    cursor:pointer; user-select:none; transition:all 0.12s;
    border:2px solid rgba(255,255,255,0.05); overflow:hidden;
  }
  .pad::before {
    content:''; position:absolute; inset:0; border-radius:inherit;
    background:linear-gradient(145deg,rgba(255,255,255,0.07) 0%,transparent 55%);
    pointer-events:none;
  }
  .pad:hover { transform:translateY(-2px); border-color:rgba(255,255,255,0.12); }
  .pad:active { transform:scale(0.97); }

  .pad.playing {
    border-color:rgba(255,255,255,0.35);
    box-shadow:0 0 25px var(--pad-glow,rgba(255,255,255,0.12));
    animation:glow 1.5s ease-in-out infinite;
  }
  @keyframes glow {
    0%,100%{box-shadow:0 0 18px var(--pad-glow,rgba(255,255,255,0.1));}
    50%{box-shadow:0 0 32px var(--pad-glow,rgba(255,255,255,0.22));}
  }

  .pad.cue-next {
    border-color:rgba(255,255,255,0.6);
    box-shadow:0 0 0 3px rgba(255,255,255,0.15);
  }
  .pad.cue-next::after {
    content:'‚ñ∂ NEXT'; position:absolute; top:8px; left:8px;
    font-size:0.55rem; font-weight:700; letter-spacing:0.12em;
    background:rgba(0,0,0,0.5); color:white; padding:0.15rem 0.45rem;
    border-radius:4px; backdrop-filter:blur(4px);
  }

  .pad.dragging { opacity:0.4; transform:scale(0.95); }
  .pad.drag-over-pad { border-color:rgba(255,255,255,0.5); transform:scale(1.03); }

  /* Pad colours by category */
  .pad-cat-sfx { background:linear-gradient(145deg,#c45a3c,#a3432a); --pad-glow:rgba(196,90,60,0.4); }
  .pad-cat-music { background:linear-gradient(145deg,#3a4a6b,#2a3a55); --pad-glow:rgba(58,74,107,0.4); }
  .pad-cat-ambience { background:linear-gradient(145deg,#5e7042,#4a5a32); --pad-glow:rgba(94,112,66,0.4); }
  .pad-cat-voice { background:linear-gradient(145deg,#b8973a,#977a28); --pad-glow:rgba(184,151,58,0.4); }
  .pad-cat-none { background:linear-gradient(145deg,#5a5248,#47403a); --pad-glow:rgba(90,82,72,0.4); }

  .pad-label {
    font-weight:700; font-size:1rem; text-align:center; line-height:1.25;
    padding:0 0.7rem; color:white; text-shadow:0 1px 4px rgba(0,0,0,0.3);
    word-break:break-word; max-width:100%;
  }
  .pad-key {
    font-size:0.6rem; font-weight:600; text-transform:uppercase; letter-spacing:0.15em;
    color:rgba(255,255,255,0.45); background:rgba(0,0,0,0.2);
    padding:0.12rem 0.45rem; border-radius:4px;
  }
  .pad-time {
    font-size:0.65rem; color:rgba(255,255,255,0.5);
    font-variant-numeric:tabular-nums;
  }

  .pad-loop-badge {
    position:absolute; top:8px; right:8px;
    font-size:0.6rem; background:rgba(0,0,0,0.35); padding:0.1rem 0.35rem;
    border-radius:4px; color:rgba(255,255,255,0.7); backdrop-filter:blur(4px);
  }

  .pad-controls {
    position:absolute; top:6px; left:6px; display:flex; gap:3px;
    opacity:0; transition:opacity 0.2s;
  }
  .pad:hover .pad-controls { opacity:1; }

  .pad-ctrl {
    background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; color:white;
    width:26px; height:26px; border-radius:6px; cursor:pointer; font-size:0.65rem;
    display:flex; align-items:center; justify-content:center; transition:background 0.15s;
  }
  .pad-ctrl:hover { background:rgba(0,0,0,0.6); }
  .pad-ctrl.loop-on { background:rgba(255,255,255,0.25); }

  .pad-vol {
    position:absolute; bottom:20px; left:10px; right:10px;
    opacity:0; transition:opacity 0.2s;
  }
  .pad:hover .pad-vol { opacity:1; }
  .pad-vol input[type="range"] {
    width:100%; height:5px; -webkit-appearance:none; appearance:none;
    background:rgba(255,255,255,0.15); border-radius:3px; outline:none;
  }
  .pad-vol input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance:none; width:14px; height:14px; border-radius:50%;
    background:white; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }

  .pad-progress {
    position:absolute; bottom:0; left:0; right:0; height:5px;
    background:rgba(0,0,0,0.2);
  }
  .pad-progress-fill {
    height:100%; background:rgba(255,255,255,0.5); width:0%;
    transition:width 0.1s linear; border-radius:0 0 var(--radius) var(--radius);
  }

  /* ===== CUE BAR ===== */
  .cue-bar {
    display:none; align-items:center; justify-content:center; gap:1rem;
    padding:0.8rem 1rem; margin-bottom:1rem;
    background:rgba(245,240,232,0.04); border-radius:var(--radius);
    border:1px solid rgba(245,240,232,0.06);
  }
  .cue-bar.visible { display:flex; }
  .cue-bar .cue-label { font-size:0.8rem; color:rgba(245,240,232,0.5); }
  .cue-bar .cue-current {
    font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:700;
    color:var(--cream); min-width:180px; text-align:center;
  }
  .cue-nav {
    background:rgba(245,240,232,0.1); border:none; color:var(--cream);
    width:36px; height:36px; border-radius:8px; cursor:pointer;
    font-size:1rem; display:flex; align-items:center; justify-content:center;
    transition:background 0.15s;
  }
  .cue-nav:hover { background:rgba(245,240,232,0.18); }
  .spacebar-hint {
    font-size:0.65rem; color:rgba(245,240,232,0.3);
    background:rgba(245,240,232,0.06); padding:0.2rem 0.6rem; border-radius:4px;
  }

  /* ===== EMPTY STATE ===== */
  .empty-state { text-align:center; padding:3.5rem 2rem; color:rgba(245,240,232,0.3); }
  .empty-state .empty-icon { font-size:3rem; margin-bottom:0.8rem; }
  .empty-state h3 {
    font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:600;
    margin-bottom:0.3rem; color:rgba(245,240,232,0.4);
  }

  /* ===== CONTROL BAR ===== */
  .control-bar {
    position:fixed; bottom:0; left:0; right:0;
    background:rgba(30,26,20,0.95); backdrop-filter:blur(12px);
    border-top:1px solid rgba(245,240,232,0.06);
    padding:0.6rem 1.5rem; display:flex; align-items:center; justify-content:center; gap:1rem;
    z-index:100; transform:translateY(100%); transition:transform 0.3s;
  }
  .control-bar.visible { transform:translateY(0); }

  .stop-btn,.panic-btn {
    border:none; padding:0.5rem 1.2rem; border-radius:8px;
    font-family:'DM Sans',sans-serif; font-weight:700; font-size:0.8rem;
    cursor:pointer; transition:all 0.15s;
  }
  .stop-btn { background:var(--terracotta); color:white; }
  .stop-btn:hover { background:var(--terracotta-light); }
  .panic-btn { background:rgba(245,240,232,0.1); color:var(--cream); }
  .panic-btn:hover { background:rgba(245,240,232,0.18); }

  .now-playing-text { font-size:0.72rem; color:rgba(245,240,232,0.45); max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* ===== MODAL ===== */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200;
    display:flex; align-items:center; justify-content:center;
    opacity:0; pointer-events:none; transition:opacity 0.2s;
  }
  .modal-overlay.active { opacity:1; pointer-events:auto; }
  .modal {
    background:#2a2520; border-radius:var(--radius); padding:1.4rem; width:360px;
    border:1px solid rgba(245,240,232,0.08); box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .modal h3 { font-family:'Cormorant Garamond',serif; font-size:1.15rem; margin-bottom:0.8rem; }
  .modal input,.modal select {
    width:100%; font-family:'DM Sans',sans-serif; font-size:0.85rem;
    padding:0.55rem 0.7rem; border:1px solid rgba(245,240,232,0.1); border-radius:7px;
    background:rgba(245,240,232,0.05); color:var(--cream); margin-bottom:0.7rem;
  }
  .modal input:focus,.modal select:focus { outline:none; border-color:var(--terracotta); }
  .modal label { font-size:0.75rem; color:rgba(245,240,232,0.5); display:block; margin-bottom:0.3rem; }
  .modal-actions { display:flex; gap:0.4rem; justify-content:flex-end; margin-top:0.5rem; }
  .btn-m-pri { background:var(--terracotta); color:white; border:none; padding:0.45rem 0.9rem; border-radius:7px; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.78rem; cursor:pointer; }
  .btn-m-sec { background:rgba(245,240,232,0.08); color:rgba(245,240,232,0.7); border:none; padding:0.45rem 0.9rem; border-radius:7px; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.78rem; cursor:pointer; }

  /* Checkbox row in modal */
  .modal-check {
    display:flex; align-items:center; gap:0.5rem; margin-bottom:0.7rem;
  }
  .modal-check input[type="checkbox"] {
    width:16px; height:16px; accent-color:var(--terracotta); cursor:pointer; margin:0;
  }
  .modal-check label { margin:0; cursor:pointer; }

  /* Sessions dropdown */
  .sessions-dd { position:relative; }
  .sessions-list {
    position:absolute; top:calc(100% + 5px); right:0; background:#2a2520;
    border:1px solid rgba(245,240,232,0.08); border-radius:var(--radius);
    box-shadow:0 10px 40px rgba(0,0,0,0.4); min-width:260px; max-height:300px;
    overflow-y:auto; z-index:150; display:none;
  }
  .sessions-list.open { display:block; }
  .s-item {
    padding:0.65rem 0.9rem; display:flex; align-items:center; justify-content:space-between;
    cursor:pointer; transition:background 0.1s; border-bottom:1px solid rgba(245,240,232,0.03);
    font-size:0.8rem;
  }
  .s-item:hover { background:rgba(245,240,232,0.04); }
  .s-meta { font-size:0.65rem; color:rgba(245,240,232,0.25); margin-top:2px; }
  .s-del {
    background:none; border:none; color:var(--terracotta); cursor:pointer;
    font-size:0.75rem; padding:0.15rem 0.35rem; border-radius:4px; opacity:0; transition:opacity 0.15s;
  }
  .s-item:hover .s-del { opacity:1; }
  .no-sessions { padding:1.2rem; text-align:center; color:rgba(245,240,232,0.25); font-size:0.75rem; }

  /* Toast */
  .toast {
    position:fixed; bottom:75px; left:50%; transform:translateX(-50%) translateY(20px);
    background:rgba(245,240,232,0.95); color:var(--ink); padding:0.55rem 1.2rem;
    border-radius:8px; font-size:0.78rem; font-weight:600; opacity:0;
    transition:all 0.3s; z-index:300; pointer-events:none; box-shadow:0 4px 16px rgba(0,0,0,0.3);
  }
  .toast.visible { opacity:1; transform:translateX(-50%) translateY(0); }

  .footer-spacer { height:65px; }

  @media(max-width:500px){
    header{padding:0.6rem 0.8rem;}
    .logo h1{font-size:1.2rem;}
    .session-bar input{width:100%;}
    main{padding:0.8rem;}
    .pad{min-height:105px;}
    .pad-label{font-size:0.85rem;}
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <h1>Classicalia</h1>
    <span>Soundboard</span>
  </div>
  <div class="header-row">
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeFree" onclick="setMode('free')">Free Play</button>
      <button class="mode-btn" id="modeCue" onclick="setMode('cue')">Cue List</button>
    </div>
    <div class="grid-toggle">
      <span class="toggle-label">Grid</span>
      <button class="grid-btn" onclick="setGrid(2)" data-cols="2">2</button>
      <button class="grid-btn active" onclick="setGrid(3)" data-cols="3">3</button>
      <button class="grid-btn" onclick="setGrid(4)" data-cols="4">4</button>
      <button class="grid-btn" onclick="setGrid(5)" data-cols="5">5</button>
    </div>
    <div class="fade-toggle">
      <span class="toggle-label">Fade</span>
      <button class="fade-btn active" onclick="setFadeDur(1)" data-dur="1">1s</button>
      <button class="fade-btn" onclick="setFadeDur(3)" data-dur="3">3s</button>
      <button class="fade-btn" onclick="setFadeDur(5)" data-dur="5">5s</button>
    </div>
    <div class="master-vol">
      <span>üîä</span>
      <input type="range" min="0" max="1" step="0.05" value="1" oninput="setMasterVol(this.value)" title="Master volume">
    </div>
    <button class="btn btn-stage" id="stageBtn" onclick="toggleStage()">
      <span class="btn-icon">üé≠</span> Stage
    </button>
  </div>
  <div class="header-row">
    <button class="btn btn-save" onclick="saveSession()"><span class="btn-icon">üíæ</span> Save</button>
    <div class="sessions-dd">
      <button class="btn" onclick="toggleSL()"><span class="btn-icon">üìÇ</span> Load</button>
      <div class="sessions-list" id="sl"></div>
    </div>
    <button class="btn" onclick="exportSession()"><span class="btn-icon">üì§</span> Export</button>
    <button class="btn" onclick="importSession()"><span class="btn-icon">üì•</span> Import</button>
    <button class="btn" onclick="clearBoard()"><span class="btn-icon">üóëÔ∏è</span> Clear</button>
  </div>
</header>

<main>
  <div class="session-bar">
    <input type="text" id="sessionName" value="House Play Soundboard" placeholder="Session name...">
    <span class="sound-count" id="soundCount"></span>
  </div>

  <div class="upload-zone" id="uploadZone">
    <h2>Drop audio files here</h2>
    <p>MP3, WAV, OGG, M4A ‚Äî click or drag</p>
    <input type="file" id="fileInput" multiple accept="audio/*">
  </div>

  <div class="cue-bar" id="cueBar">
    <button class="cue-nav" onclick="cueJump(-1)" title="Previous cue">‚óÄ</button>
    <div>
      <div class="cue-label" id="cueLabel">Next cue</div>
      <div class="cue-current" id="cueCurrent">‚Äî</div>
    </div>
    <button class="cue-nav" onclick="cueJump(1)" title="Skip cue">‚ñ∂</button>
    <div class="spacebar-hint">SPACE to fire</div>
  </div>

  <div class="deck" id="deck"></div>

  <div class="empty-state" id="emptyState">
    <div class="empty-icon">üé≠</div>
    <h3>No sounds loaded</h3>
    <p>Upload audio files to build your deck</p>
  </div>
</main>

<div class="control-bar" id="controlBar">
  <span class="now-playing-text" id="nowPlaying"></span>
  <button class="stop-btn" onclick="stopAll()">‚ñ† STOP ALL (Esc)</button>
  <button class="panic-btn" onclick="panicFade()">‚ö° FADE OUT</button>
</div>

<!-- Edit modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h3>Edit Sound</h3>
    <label>Name</label>
    <input type="text" id="editName" placeholder="Sound name...">
    <label>Category (sets colour)</label>
    <select id="editCat">
      <option value="none">No category</option>
      <option value="sfx">SFX</option>
      <option value="music">Music</option>
      <option value="ambience">Ambience</option>
      <option value="voice">Voice / Dialogue</option>
    </select>
    <label>Fade in duration</label>
    <select id="editFadeIn">
      <option value="0">Off (instant start)</option>
      <option value="1">1 second</option>
      <option value="2">2 seconds</option>
      <option value="3">3 seconds</option>
      <option value="5">5 seconds</option>
    </select>
    <div class="modal-check">
      <input type="checkbox" id="editLoop">
      <label for="editLoop">Loop this sound</label>
    </div>
    <div class="modal-actions">
      <button class="btn-m-sec" onclick="closeEdit()">Cancel</button>
      <button class="btn-m-pri" onclick="confirmEdit()">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="footer-spacer"></div>
<input type="file" id="importInput" accept=".json" style="display:none">

<script>
// ===== STATE =====
let sounds = []; // {id, name, dataUrl, volume, cat, loop, fadeIn}
let audioEls = {};
let playing = new Set();
let progTimers = {};
let editingId = null;
let mode = 'free';
let cueIndex = 0;
let masterVol = 1;
let fadeDur = 1; // global fade-out duration in seconds
let dragSrcIdx = null;
let stageMode = false;
let activeFades = new Set();

const STORE = 'classicalia_sb_v3';
const KEYS = '123456789QWERTYU';

// ===== GRID =====
let gridCols = 3;

function setGrid(n) {
  gridCols = n;
  document.getElementById('deck').style.setProperty('--cols', n);
  document.querySelectorAll('.grid-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.cols) === n);
  });
  document.querySelectorAll('.pad').forEach(p => {
    p.style.minHeight = n >= 5 ? '100px' : n >= 4 ? '115px' : '130px';
  });
}

// ===== FADE DURATION =====
function setFadeDur(s) {
  fadeDur = s;
  document.querySelectorAll('.fade-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.dur) === s);
  });
}

// ===== STAGE MODE =====
function toggleStage() {
  stageMode = !stageMode;
  document.body.classList.toggle('stage-mode', stageMode);
  document.getElementById('stageBtn').classList.toggle('active', stageMode);
  toast(stageMode ? 'Stage mode on ‚Äî minimal UI' : 'Stage mode off');
}

// ===== FILES =====
const fileInput = document.getElementById('fileInput');
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', () => { handleFiles(fileInput.files); fileInput.value = ''; });

function handleFiles(files) {
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('audio/')) return;
    const reader = new FileReader();
    reader.onload = e => {
      const s = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        name: file.name.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' '),
        dataUrl: e.target.result,
        volume: 1,
        cat: 'none',
        loop: false,
        fadeIn: 0
      };
      sounds.push(s);
      mkAudio(s);
      render();
    };
    reader.readAsDataURL(file);
  });
}

function mkAudio(s) {
  const a = new Audio(s.dataUrl);
  a.volume = s.volume * masterVol;
  a.loop = s.loop;
  a.addEventListener('ended', () => {
    if (!s.loop) {
      playing.delete(s.id);
      stopProg(s.id);
      if (mode === 'cue') { cueIndex = Math.min(cueIndex + 1, sounds.length); }
      updateBar(); render();
    }
  });
  audioEls[s.id] = a;
}

// ===== RENDER =====
function render() {
  const deck = document.getElementById('deck');
  const empty = document.getElementById('emptyState');
  const countEl = document.getElementById('soundCount');

  if (!sounds.length) { deck.innerHTML = ''; empty.style.display = 'block'; countEl.textContent = ''; updateCueBar(); return; }
  empty.style.display = 'none';
  countEl.textContent = sounds.length + ' sound' + (sounds.length !== 1 ? 's' : '');

  const padMinH = gridCols >= 5 ? '100px' : gridCols >= 4 ? '115px' : '130px';

  deck.innerHTML = sounds.map((s, i) => {
    const key = i < KEYS.length ? KEYS[i] : '';
    const on = playing.has(s.id);
    const a = audioEls[s.id];
    const isCueNext = mode === 'cue' && i === cueIndex && !on;
    const dur = a && a.duration && isFinite(a.duration) ? fmt(a.duration) : '';
    const remaining = on && a && isFinite(a.duration) ? fmt(a.duration - a.currentTime) : '';

    // Badges
    let badges = '';
    if (s.loop) badges += '<div class="pad-loop-badge">LOOP</div>';
    if (s.fadeIn > 0) badges += `<div class="pad-fadein-badge">IN ${s.fadeIn}s</div>`;

    return `
      <div class="pad pad-cat-${s.cat} ${on ? 'playing' : ''} ${isCueNext ? 'cue-next' : ''}"
           onclick="trigger(${i})"
           draggable="true"
           ondragstart="dragStart(event,${i})"
           ondragover="dragOver(event,${i})"
           ondrop="drop(event,${i})"
           ondragend="dragEnd(event)"
           ondragleave="dragLeave(event)"
           data-idx="${i}"
           style="min-height:${padMinH};${gridCols>=5?'font-size:0.85rem':''}">
        <div class="pad-controls">
          <button class="pad-ctrl" onclick="event.stopPropagation();openEdit('${s.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="pad-ctrl ${s.loop?'loop-on':''}" onclick="event.stopPropagation();toggleLoop('${s.id}')" title="Loop">üîÅ</button>
          <button class="pad-ctrl" onclick="event.stopPropagation();fadeOutPad('${s.id}')" title="Fade out">üîâ</button>
          <button class="pad-ctrl" onclick="event.stopPropagation();removePad('${s.id}')" title="Remove">‚úï</button>
        </div>
        ${badges}
        <div class="pad-label" style="${gridCols>=5?'font-size:0.8rem':gridCols>=4?'font-size:0.9rem':''}">${esc(s.name)}</div>
        ${key ? `<div class="pad-key">${key}</div>` : ''}
        <div class="pad-time">${on && remaining ? remaining : dur}</div>
        <div class="pad-vol" onclick="event.stopPropagation()">
          <input type="range" min="0" max="1" step="0.05" value="${s.volume}" oninput="setVol('${s.id}',this.value)">
        </div>
        ${on ? `<div class="pad-progress"><div class="pad-progress-fill" id="prog-${s.id}"></div></div>` : ''}
      </div>`;
  }).join('');

  playing.forEach(id => startProg(id));
  updateCueBar();
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmt(s) { const m = Math.floor(s/60); return m + ':' + Math.floor(s%60).toString().padStart(2,'0'); }

// ===== PLAYBACK =====
function trigger(idx) {
  if (idx < 0 || idx >= sounds.length) return;
  toggleSound(sounds[idx].id);
}

function toggleSound(id) {
  const a = audioEls[id];
  if (!a) return;
  const s = sounds.find(x => x.id === id);

  if (playing.has(id)) {
    a.pause(); a.currentTime = 0;
    playing.delete(id); stopProg(id);
  } else {
    a.currentTime = 0;
    const targetVol = (s?.volume ?? 1) * masterVol;

    // Fade in
    if (s && s.fadeIn > 0) {
      a.volume = 0;
      a.play().catch(()=>{});
      playing.add(id);
      const steps = Math.round(s.fadeIn * 20); // 50ms intervals
      let step = 0;
      const fadeTimer = setInterval(() => {
        step++;
        a.volume = Math.min(targetVol, (step / steps) * targetVol);
        if (step >= steps) { clearInterval(fadeTimer); a.volume = targetVol; }
      }, 50);
    } else {
      a.volume = targetVol;
      a.play().catch(()=>{});
      playing.add(id);
    }
  }
  updateBar(); render();
}

function stopAll() {
  playing.forEach(id => { const a=audioEls[id]; if(a){a.pause();a.currentTime=0;} stopProg(id); });
  playing.clear(); activeFades.clear(); updateBar(); render();
}

// ===== FADE OUT =====
function fadeOutPad(id) {
  const a = audioEls[id];
  if (!a || !playing.has(id) || activeFades.has(id)) return;
  activeFades.add(id);
  let vol = a.volume;
  if (vol <= 0) vol = 0.01;
  const totalSteps = Math.round(fadeDur * 20); // 50ms intervals
  const step = vol / totalSteps;
  const timer = setInterval(() => {
    vol -= step;
    if (vol <= 0.001) {
      clearInterval(timer);
      a.pause(); a.currentTime = 0;
      const s = sounds.find(x => x.id === id);
      a.volume = (s?.volume ?? 1) * masterVol;
      playing.delete(id); stopProg(id); activeFades.delete(id);
      if (activeFades.size === 0) { updateBar(); render(); }
    } else {
      a.volume = vol;
    }
  }, 50);
}

function panicFade() {
  if (playing.size === 0) return;
  playing.forEach(id => fadeOutPad(id));
}

function setVol(id, v) {
  const s = sounds.find(x=>x.id===id);
  if (s) s.volume = parseFloat(v);
  const a = audioEls[id];
  if (a && !activeFades.has(id)) a.volume = parseFloat(v) * masterVol;
}

function setMasterVol(v) {
  masterVol = parseFloat(v);
  sounds.forEach(s => {
    const a = audioEls[s.id];
    if (a && !activeFades.has(s.id)) a.volume = s.volume * masterVol;
  });
}

function toggleLoop(id) {
  const s = sounds.find(x=>x.id===id);
  if (!s) return;
  s.loop = !s.loop;
  const a = audioEls[id];
  if (a) a.loop = s.loop;
  render();
}

// Progress
function startProg(id) {
  stopProg(id);
  const a = audioEls[id];
  if (!a || !isFinite(a.duration)) return;
  progTimers[id] = setInterval(() => {
    const el = document.getElementById('prog-'+id);
    if (el && a.duration) el.style.width = (a.currentTime/a.duration*100)+'%';
    const pad = document.querySelector(`[data-idx="${sounds.findIndex(x=>x.id===id)}"] .pad-time`);
    if (pad && isFinite(a.duration)) pad.textContent = fmt(a.duration - a.currentTime);
  }, 100);
}
function stopProg(id) { if(progTimers[id]){clearInterval(progTimers[id]);delete progTimers[id];} }

function updateBar() {
  const bar = document.getElementById('controlBar');
  const np = document.getElementById('nowPlaying');
  if (playing.size) {
    bar.classList.add('visible');
    const names = [...playing].map(id=>{const s=sounds.find(x=>x.id===id);return s?s.name:'';}).filter(Boolean);
    np.textContent = names.join('  ¬∑  ');
  } else bar.classList.remove('visible');
}

// ===== CUE LIST =====
function setMode(m) {
  mode = m;
  document.getElementById('modeFree').classList.toggle('active', m==='free');
  document.getElementById('modeCue').classList.toggle('active', m==='cue');
  if (m==='cue') cueIndex = 0;
  render();
}

function updateCueBar() {
  const bar = document.getElementById('cueBar');
  if (mode !== 'cue' || !sounds.length) { bar.classList.remove('visible'); return; }
  bar.classList.add('visible');
  const label = document.getElementById('cueLabel');
  const current = document.getElementById('cueCurrent');
  if (cueIndex >= sounds.length) {
    label.textContent = 'All cues fired';
    current.textContent = '‚Äî End ‚Äî';
  } else {
    label.textContent = `Cue ${cueIndex + 1} of ${sounds.length}`;
    current.textContent = sounds[cueIndex].name;
  }
}

function cueJump(dir) {
  cueIndex = Math.max(0, Math.min(sounds.length, cueIndex + dir));
  render();
}

function fireCue() {
  if (mode !== 'cue' || cueIndex >= sounds.length) return;
  const s = sounds[cueIndex];
  if (!playing.has(s.id)) {
    toggleSound(s.id);
    cueIndex++;
    render();
  }
}

// ===== DRAG & DROP =====
function dragStart(e, idx) {
  dragSrcIdx = idx;
  e.dataTransfer.effectAllowed = 'move';
  e.target.classList.add('dragging');
}
function dragOver(e, idx) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over-pad');
}
function dragLeave(e) { e.currentTarget.classList.remove('drag-over-pad'); }
function drop(e, idx) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over-pad');
  if (dragSrcIdx === null || dragSrcIdx === idx) return;
  const moved = sounds.splice(dragSrcIdx, 1)[0];
  sounds.splice(idx, 0, moved);
  dragSrcIdx = null;
  render();
}
function dragEnd(e) { e.target.classList.remove('dragging'); dragSrcIdx = null; }

// ===== EDIT MODAL =====
function openEdit(id) {
  editingId = id;
  const s = sounds.find(x=>x.id===id);
  document.getElementById('editName').value = s ? s.name : '';
  document.getElementById('editCat').value = s ? s.cat : 'none';
  document.getElementById('editFadeIn').value = s ? String(s.fadeIn || 0) : '0';
  document.getElementById('editLoop').checked = s ? s.loop : false;
  document.getElementById('editModal').classList.add('active');
  setTimeout(()=>document.getElementById('editName').focus(),100);
}
function closeEdit() { document.getElementById('editModal').classList.remove('active'); editingId=null; }
function confirmEdit() {
  if (!editingId) return;
  const s = sounds.find(x=>x.id===editingId);
  if (s) {
    const n = document.getElementById('editName').value.trim();
    if (n) s.name = n;
    s.cat = document.getElementById('editCat').value;
    s.fadeIn = parseInt(document.getElementById('editFadeIn').value) || 0;
    s.loop = document.getElementById('editLoop').checked;
    const a = audioEls[s.id];
    if (a) a.loop = s.loop;
  }
  closeEdit(); render();
}
document.getElementById('editName').addEventListener('keydown', e => {
  if(e.key==='Enter')confirmEdit(); if(e.key==='Escape')closeEdit();
});

// ===== PAD MANAGEMENT =====
function removePad(id) {
  const a=audioEls[id]; if(a){a.pause();delete audioEls[id];}
  playing.delete(id); stopProg(id); activeFades.delete(id);
  sounds = sounds.filter(s=>s.id!==id);
  updateBar(); render();
}

// ===== SESSIONS =====
function getSS(){try{return JSON.parse(localStorage.getItem(STORE)||'{}');}catch{return {};}}

function saveSession(){
  const name=document.getElementById('sessionName').value.trim()||'Untitled';
  const ss=getSS();
  ss[name]={name,savedAt:new Date().toISOString(),sounds:sounds.map(s=>({
    id:s.id, name:s.name, dataUrl:s.dataUrl, volume:s.volume,
    cat:s.cat, loop:s.loop, fadeIn:s.fadeIn
  }))};
  localStorage.setItem(STORE,JSON.stringify(ss));
  toast('Session "'+name+'" saved');
}

function loadSS(name){
  const ss=getSS(),s=ss[name]; if(!s)return;
  stopAll(); Object.values(audioEls).forEach(a=>a.pause()); audioEls={}; sounds=[];
  document.getElementById('sessionName').value=s.name;
  s.sounds.forEach(x=>{
    const snd={...x, cat:x.cat||'none', loop:x.loop||false, fadeIn:x.fadeIn||0};
    sounds.push(snd); mkAudio(snd);
  });
  cueIndex=0; render(); closeSL(); toast('Loaded "'+name+'"');
}

function delSS(name,e){
  e.stopPropagation();
  const ss=getSS(); delete ss[name];
  localStorage.setItem(STORE,JSON.stringify(ss));
  renderSL();
}

function toggleSL(){
  const l=document.getElementById('sl');
  if(l.classList.contains('open'))l.classList.remove('open');
  else{renderSL();l.classList.add('open');}
}
function closeSL(){document.getElementById('sl').classList.remove('open');}

function renderSL(){
  const l=document.getElementById('sl'),ss=getSS(),keys=Object.keys(ss);
  if(!keys.length){l.innerHTML='<div class="no-sessions">No saved sessions</div>';return;}
  l.innerHTML=keys.sort((a,b)=>new Date(ss[b].savedAt)-new Date(ss[a].savedAt)).map(n=>{
    const s=ss[n],c=s.sounds?s.sounds.length:0,d=new Date(s.savedAt).toLocaleDateString();
    return `<div class="s-item" onclick="loadSS('${esc(n)}')"><div><div>${esc(n)}</div><div class="s-meta">${c} sounds ¬∑ ${d}</div></div><button class="s-del" onclick="delSS('${esc(n)}',event)">‚úï</button></div>`;
  }).join('');
}

document.addEventListener('click',e=>{if(!document.querySelector('.sessions-dd').contains(e.target))closeSL();});

// Export/Import
function exportSession(){
  const name=document.getElementById('sessionName').value.trim()||'soundboard';
  const data={name,exportedAt:new Date().toISOString(),sounds:sounds.map(s=>({
    name:s.name, dataUrl:s.dataUrl, volume:s.volume,
    cat:s.cat, loop:s.loop, fadeIn:s.fadeIn
  }))};
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download=name.replace(/\s+/g,'_')+'.json';a.click();URL.revokeObjectURL(url);
  toast('Session exported');
}

function importSession(){document.getElementById('importInput').click();}
document.getElementById('importInput').addEventListener('change',function(){
  const f=this.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(!d.sounds||!Array.isArray(d.sounds)){toast('Invalid file');return;}
      stopAll();Object.values(audioEls).forEach(a=>a.pause());audioEls={};sounds=[];
      document.getElementById('sessionName').value=d.name||'Imported';
      d.sounds.forEach((s,i)=>{
        const x={
          id:Date.now().toString(36)+Math.random().toString(36).slice(2,6)+i,
          name:s.name, dataUrl:s.dataUrl, volume:s.volume??1,
          cat:s.cat||'none', loop:s.loop||false, fadeIn:s.fadeIn||0
        };
        sounds.push(x);mkAudio(x);
      });
      cueIndex=0; render(); toast('Imported "'+(d.name||'session')+'"');
    }catch{toast('Could not read file');}
  };
  r.readAsText(f);this.value='';
});

function clearBoard(){
  if(!sounds.length)return;
  if(!confirm('Remove all sounds from the board?'))return;
  stopAll();Object.values(audioEls).forEach(a=>a.pause());audioEls={};sounds=[];
  cueIndex=0; render(); toast('Board cleared');
}

// ===== KEYBOARD =====
document.addEventListener('keydown', e => {
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT') return;

  if(e.key==='Escape'){ stopAll(); return; }

  if(e.code==='Space' && mode==='cue'){
    e.preventDefault();
    fireCue();
    return;
  }

  const k=e.key.toUpperCase(), i=KEYS.indexOf(k);
  if(i>=0 && i<sounds.length) trigger(i);
});

// ===== TOAST =====
function toast(msg){
  const t=document.getElementById('toast');t.textContent=msg;
  t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),2200);
}

// ===== INIT =====
render();
toast('Free Play mode ‚Äî press keys to trigger pads');
</script>
</body>
</html>
