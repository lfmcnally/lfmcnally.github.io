<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latin Vocabulary Test - Classicalia</title>
    <link rel="stylesheet" href="../shared/styles.css">
    <style>
        /* Test-specific styles */
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .setup-panel {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .setup-panel h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .setup-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-width: 150px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .control-group select {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 1rem;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .start-test-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .start-test-btn:hover {
            background: #218838;
        }

        .start-test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Test area styles */
        .test-area {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .test-area.active {
            display: block;
        }

        .test-header {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .test-header h2 {
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }

        .test-info {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .test-table {
            width: 100%;
            margin-bottom: 2rem;
            border-collapse: collapse;
        }

        .test-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .test-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .test-table tr:hover:not(.correct):not(.incorrect) {
            background: #f8f9fa;
        }

        .latin-word {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .word-info {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .answer-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .answer-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
        }

        .answer-input:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            color: #495057;
        }

        /* Marking feedback */
        .answer-cell {
            position: relative;
        }

        .correct {
            background: #d4edda !important;
        }

        .incorrect {
            background: #f8d7da !important;
        }

        .feedback-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .correct-answer {
            color: #721c24;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-style: italic;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Action buttons */
        .test-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .mark-btn, .reset-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .mark-btn:hover {
            background: #0056b3;
        }

        .mark-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #6c757d;
        }

        .reset-btn:hover {
            background: #5a6268;
        }

        /* Results box */
        .results-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            display: none;
        }

        .results-box.show {
            display: block;
        }

        .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 0.5rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .score-message {
            color: #0c5460;
            font-size: 1.1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .print-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .print-btn:hover {
            background: #138496;
        }

        @media print {
            .header, .test-actions, .setup-panel, .print-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <a href="../index.html" style="text-decoration: none; color: inherit;">Classicalia</a>
            </div>
            <div class="author">by Lawrence McNally</div>
            <div class="subtitle">Latin Vocabulary Test</div>
            
            <div class="page-nav">
                <a href="../index.html" class="nav-link">← Back to Home</a>
                <a href="vocabulary.html" class="nav-link">← Back to Practice</a>
            </div>
        </div>
    </header>

    <main class="test-container">
        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel">
            <h2>Test Setup</h2>
            <div class="setup-controls">
                <div class="control-group">
                    <label for="chapterSelect">Chapter</label>
                    <select id="chapterSelect">
                        <option value="">Select Chapter</option>
                        <option value="1">Chapter 1</option>
                        <option value="2">Chapter 2</option>
                        <option value="3">Chapter 3</option>
                        <option value="4">Chapter 4</option>
                        <option value="5">Chapter 5</option>
                        <option value="6">Chapter 6</option>
                        <option value="7">Chapter 7</option>
                        <option value="8">Chapter 8</option>
                        <option value="9">Chapter 9</option>
                        <option value="10">Chapter 10</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="fromWord">From Word</label>
                    <select id="fromWord" disabled>
                        <option value="">Select start word</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="toWord">To Word</label>
                    <select id="toWord" disabled>
                        <option value="">Select end word</option>
                    </select>
                </div>

                <button class="start-test-btn" id="startTestBtn" disabled>Start Test</button>
            </div>
        </div>

        <!-- Test Area -->
        <div class="test-area" id="testArea">
            <div class="test-header">
                <h2 id="testTitle">Chapter 1: ad to insula</h2>
                <div class="test-info" id="testInfo">20 words</div>
            </div>

            <div class="results-box" id="resultsBox">
                <div class="score-display" id="scoreDisplay">18/20</div>
                <div class="score-message" id="scoreMessage">Excellent work!</div>
                <button class="print-btn" onclick="window.print()">Print Results</button>
            </div>

            <table class="test-table">
                <thead>
                    <tr>
                        <th style="width: 40%">Latin Word</th>
                        <th style="width: 60%">Your Answer</th>
                    </tr>
                </thead>
                <tbody id="testTableBody">
                    <!-- Words will be inserted here -->
                </tbody>
            </table>

            <div class="test-actions">
                <button class="mark-btn" id="markBtn">Mark Test</button>
                <button class="reset-btn" id="resetBtn" style="display: none;">New Test</button>
            </div>
        </div>
    </main>

    <!-- Include vocabulary data and quiz logic -->
    <script src="../shared/vocabulary-data.js"></script>
    <script>
        // Test state
        let testWords = [];
        let isMarked = false;
        let selectedChapter = null;
        let fromIndex = null;
        let toIndex = null;

        // Setup event listeners
        document.getElementById('chapterSelect').addEventListener('change', handleChapterSelect);
        document.getElementById('fromWord').addEventListener('change', handleFromWordSelect);
        document.getElementById('toWord').addEventListener('change', handleToWordSelect);
        document.getElementById('startTestBtn').addEventListener('click', startTest);
        document.getElementById('markBtn').addEventListener('click', markTest);
        document.getElementById('resetBtn').addEventListener('click', resetTest);

        function handleChapterSelect() {
            const chapter = document.getElementById('chapterSelect').value;
            const fromSelect = document.getElementById('fromWord');
            const toSelect = document.getElementById('toWord');
            
            if (!chapter) {
                fromSelect.disabled = true;
                toSelect.disabled = true;
                document.getElementById('startTestBtn').disabled = true;
                return;
            }

            selectedChapter = chapter;
            const chapterWords = vocabularyData.filter(word => word.chapter == chapter);
            
            // Populate from word dropdown
            fromSelect.innerHTML = '<option value="">Select start word</option>';
            chapterWords.forEach((word, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = word.latin;
                fromSelect.appendChild(option);
            });
            fromSelect.disabled = false;
            
            // Reset to word dropdown
            toSelect.innerHTML = '<option value="">Select end word</option>';
            toSelect.disabled = true;
            document.getElementById('startTestBtn').disabled = true;
        }

        function handleFromWordSelect() {
            const fromValue = document.getElementById('fromWord').value;
            const toSelect = document.getElementById('toWord');
            
            if (!fromValue) {
                toSelect.disabled = true;
                document.getElementById('startTestBtn').disabled = true;
                return;
            }

            fromIndex = parseInt(fromValue);
            const chapterWords = vocabularyData.filter(word => word.chapter == selectedChapter);
            
            // Populate to word dropdown (only words after the from word)
            toSelect.innerHTML = '<option value="">Select end word</option>';
            for (let i = fromIndex; i < chapterWords.length; i++) {
                const word = chapterWords[i];
                const option = document.createElement('option');
                option.value = i;
                option.textContent = word.latin;
                toSelect.appendChild(option);
            }
            toSelect.disabled = false;
        }

        function handleToWordSelect() {
            const toValue = document.getElementById('toWord').value;
            if (toValue) {
                toIndex = parseInt(toValue);
                document.getElementById('startTestBtn').disabled = false;
            } else {
                document.getElementById('startTestBtn').disabled = true;
            }
        }

        function startTest() {
            const chapterWords = vocabularyData.filter(word => word.chapter == selectedChapter);
            testWords = chapterWords.slice(fromIndex, toIndex + 1);
            
            // Update test header
            const fromWord = chapterWords[fromIndex].latin;
            const toWord = chapterWords[toIndex].latin;
            document.getElementById('testTitle').textContent = `Chapter ${selectedChapter}: ${fromWord} to ${toWord}`;
            document.getElementById('testInfo').textContent = `${testWords.length} words`;
            
            // Build test table
            const tbody = document.getElementById('testTableBody');
            tbody.innerHTML = '';
            
            testWords.forEach((word, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="latin-word">${word.latin}</div>
                        <div class="word-info">${word.info}</div>
                    </td>
                    <td class="answer-cell">
                        <input type="text" class="answer-input" id="answer-${index}" 
                               placeholder="Enter English meaning..." autocomplete="off">
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Show test area, hide setup
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('testArea').classList.add('active');
            
            // Focus first input
            document.getElementById('answer-0').focus();
        }

        function markTest() {
            isMarked = true;
            let correctCount = 0;
            
            testWords.forEach((word, index) => {
                const input = document.getElementById(`answer-${index}`);
                const userAnswer = input.value.trim().toLowerCase();
                const row = input.closest('tr');
                const answerCell = input.closest('td');
                
                // Disable input
                input.disabled = true;
                
                // Check answer
                const correctAnswers = word.english.toLowerCase().split(',').map(a => a.trim());
                let isCorrect = false;
                
                // Check for exact match or partial match
                for (const correctAnswer of correctAnswers) {
                    if (userAnswer === correctAnswer) {
                        isCorrect = true;
                        break;
                    }
                    
                    // Also accept variations like "I love" for "love" or "to love" for "love"
                    const cleanUserAnswer = userAnswer.replace(/^(to |i |a |the )/i, '').trim();
                    const cleanCorrectAnswer = correctAnswer.replace(/^(to |i |a |the )/i, '').trim();
                    
                    if (cleanUserAnswer === cleanCorrectAnswer) {
                        isCorrect = true;
                        break;
                    }
                    
                    // Check if user answer contains the main word
                    const correctWords = correctAnswer.split(' ');
                    for (const correctWord of correctWords) {
                        if (correctWord.length > 2 && userAnswer.includes(correctWord)) {
                            isCorrect = true;
                            break;
                        }
                    }
                }
                
                if (isCorrect) {
                    row.classList.add('correct');
                    // Create feedback icon separately
                    const icon = document.createElement('span');
                    icon.className = 'feedback-icon';
                    icon.textContent = '✓';
                    answerCell.appendChild(icon);
                    correctCount++;
                } else {
                    row.classList.add('incorrect');
                    // Create feedback icon
                    const icon = document.createElement('span');
                    icon.className = 'feedback-icon';
                    icon.textContent = '✗';
                    answerCell.appendChild(icon);
                    // Add correct answer below the input
                    const correctDiv = document.createElement('div');
                    correctDiv.className = 'correct-answer';
                    correctDiv.textContent = `Correct answer: ${word.english}`;
                    answerCell.appendChild(correctDiv);
                }
            });
            
            // Show results
            const percentage = Math.round((correctCount / testWords.length) * 100);
            document.getElementById('scoreDisplay').textContent = `${correctCount}/${testWords.length}`;
            
            let message = '';
            if (percentage >= 90) {
                message = 'Outstanding! 🌟';
            } else if (percentage >= 80) {
                message = 'Great job! 👏';
            } else if (percentage >= 70) {
                message = 'Good effort! 📚';
            } else if (percentage >= 60) {
                message = 'Keep practising! 💪';
            } else {
                message = 'Keep studying! You can do it! 📖';
            }
            
            document.getElementById('scoreMessage').textContent = `${message} (${percentage}%)`;
            document.getElementById('resultsBox').classList.add('show');
            
            // Update buttons
            document.getElementById('markBtn').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'inline-block';
        }

        function resetTest() {
            // Reset state
            isMarked = false;
            testWords = [];
            
            // Show setup, hide test
            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('testArea').classList.remove('active');
            document.getElementById('resultsBox').classList.remove('show');
            
            // Reset buttons
            document.getElementById('markBtn').style.display = 'inline-block';
            document.getElementById('resetBtn').style.display = 'none';
            
            // Reset form
            document.getElementById('chapterSelect').value = '';
            document.getElementById('fromWord').innerHTML = '<option value="">Select start word</option>';
            document.getElementById('fromWord').disabled = true;
            document.getElementById('toWord').innerHTML = '<option value="">Select end word</option>';
            document.getElementById('toWord').disabled = true;
            document.getElementById('startTestBtn').disabled = true;
        }
    </script>
</body>
</html>
