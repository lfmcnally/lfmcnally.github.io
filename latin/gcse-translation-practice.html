<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCSE Latin Translation Practice - Classicalia</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        header {
            background: transparent;
            border-bottom: none;
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 2rem 1rem 2rem;
            position: relative;
        }

        .header-content {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            border-radius: 24px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.2);
            position: relative;
            overflow: hidden;
        }

        .header-content::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7c3aed;
            font-weight: 700;
            font-size: 2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .logo-icon:hover {
            transform: scale(1.05);
        }

        .header-text {
            text-align: center;
            z-index: 1;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.35rem;
        }

        .header-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.25rem;
        }

        .header-author {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.75);
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .panel {
            background: white;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .panel h2 {
            color: #1f2937;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Setup Panel */
        .setup-step {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .setup-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .setup-step h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-number {
            background: #7c3aed;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        /* Chapter Selection */
        .chapter-grid {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chapter-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chapter-btn:hover {
            border-color: #7c3aed;
            background: #faf5ff;
        }

        .chapter-btn.selected {
            border-color: #7c3aed;
            background: #7c3aed;
            color: white;
        }

        .chapter-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Spotlight Selection */
        .spotlight-select {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            margin-bottom: 1rem;
        }

        .spotlight-select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .intensity-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .intensity-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .intensity-option input {
            accent-color: #7c3aed;
        }

        /* Length Options */
        .length-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .length-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        /* Generate Button */
        .generate-btn {
            padding: 1rem 2rem;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .generate-btn:hover:not(:disabled) {
            background: #6d28d9;
            transform: translateY(-1px);
        }

        .generate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Translation Area */
        .translation-area {
            display: none;
        }

        .translation-area.active {
            display: block;
        }

        .passage-header {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .passage-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .passage-meta {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .full-passage {
            background: #faf5ff;
            border: 1px solid #e9d5ff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #4c1d95;
        }

        .current-sentence-box {
            background: white;
            border: 2px solid #7c3aed;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .sentence-counter {
            font-size: 0.85rem;
            color: #7c3aed;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .current-latin {
            font-size: 1.5rem;
            font-family: Georgia, 'Times New Roman', serif;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .hint-btn-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .hint-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hint-btn:hover {
            background: #e5e7eb;
        }

        .hint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hint-display {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #92400e;
            display: none;
        }

        .hint-display.visible {
            display: block;
        }

        .answer-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #7c3aed;
            color: white;
        }

        .btn-primary:hover {
            background: #6d28d9;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .hidden {
            display: none !important;
        }

        /* Feedback */
        .feedback {
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .feedback-correct {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .feedback-partial {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .feedback-incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .model-answer {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        .model-answer strong {
            color: #374151;
        }

        /* Progress */
        .progress-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 8px;
            height: 10px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-stats {
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Completion */
        .completion-panel {
            text-align: center;
            padding: 2rem;
        }

        .completion-grade {
            font-size: 4rem;
            font-weight: 700;
            color: #7c3aed;
            margin-bottom: 0.5rem;
        }

        .completion-message {
            font-size: 1.25rem;
            color: #374151;
            margin-bottom: 1rem;
        }

        .completion-stats {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        /* Word hover hints */
        .latin-word-hover {
            cursor: help;
            border-bottom: 1px dotted #7c3aed;
        }

        .latin-word-hover:hover {
            background: #faf5ff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }

            .chapter-grid {
                justify-content: center;
            }

            .header-title {
                font-size: 1.5rem;
            }

            .current-latin {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="header-content">
                <a href="../index.html" class="logo-icon">C</a>
                <div class="header-text">
                    <h1 class="header-title">GCSE Latin Translation Practice</h1>
                    <p class="header-subtitle">Unseen translation with auto-marking</p>
                    <p class="header-author">by Lawrence McNally</p>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Tracking Indicator -->
        <div class="tracking-indicator not-tracking" id="trackingIndicator" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; font-size: 0.85rem; color: #92400e; margin-bottom: 1rem;">
            <div class="tracking-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></div>
            <span id="trackingText">Log in to track your progress</span>
        </div>

        <!-- Setup Panel -->
        <div class="panel" id="setupPanel">
            <h2>Generate an Unseen Translation</h2>

            <div class="setup-step">
                <h3><span class="step-number">1</span> Select your chapter level</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                    The passage will only use vocabulary and grammar from chapters up to your selection.
                </p>
                <div class="chapter-grid" id="chapterGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="setup-step">
                <h3><span class="step-number">2</span> Grammar spotlight (optional)</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                    Focus on a specific grammar construction for intensive practice.
                </p>
                <select class="spotlight-select" id="spotlightSelect">
                    <option value="">No spotlight - mixed practice</option>
                </select>
                <div class="intensity-options" id="intensityOptions" style="display: none;">
                    <label class="intensity-option">
                        <input type="radio" name="intensity" value="light"> Light (1-2 examples)
                    </label>
                    <label class="intensity-option">
                        <input type="radio" name="intensity" value="heavy" checked> Heavy (3-4 examples)
                    </label>
                    <label class="intensity-option">
                        <input type="radio" name="intensity" value="intensive"> Intensive (every sentence)
                    </label>
                </div>
            </div>

            <div class="setup-step">
                <h3><span class="step-number">3</span> Passage length</h3>
                <div class="length-options">
                    <label class="length-option">
                        <input type="radio" name="length" value="4"> Short (4-5 sentences)
                    </label>
                    <label class="length-option">
                        <input type="radio" name="length" value="6" checked> Medium (6-8 sentences)
                    </label>
                    <label class="length-option">
                        <input type="radio" name="length" value="10"> Long (10-12 sentences)
                    </label>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="generate-btn" id="generateBtn" disabled>
                    <span>Generate Passage</span>
                </button>
            </div>
        </div>

        <!-- Translation Area -->
        <div class="translation-area" id="translationArea">
            <div class="panel">
                <div class="passage-header">
                    <div class="passage-title" id="passageTitle">The Journey</div>
                    <div class="passage-meta" id="passageMeta">Chapter 4 | 6 sentences</div>
                </div>

                <div class="full-passage" id="fullPassage">
                    <!-- Full Latin text here -->
                </div>

                <div class="current-sentence-box">
                    <div class="sentence-counter" id="sentenceCounter">Sentence 1 of 6</div>
                    <div class="current-latin" id="currentLatin">puella in horto ambulat.</div>

                    <div class="hint-btn-group">
                        <button class="hint-btn" id="vocabHintBtn" onclick="showVocabHint()">Show Vocab Hints</button>
                        <button class="hint-btn" id="grammarHintBtn" onclick="showGrammarHint()">Show Grammar Hint</button>
                    </div>

                    <div class="hint-display" id="hintDisplay"></div>

                    <textarea class="answer-input" id="answerInput" placeholder="Type your English translation here..." rows="2"></textarea>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="checkBtn" onclick="checkAnswer()">
                            <span>Check Answer</span>
                        </button>
                        <button class="btn btn-secondary hidden" id="nextBtn" onclick="nextSentence()">
                            <span>Next Sentence</span>
                        </button>
                        <button class="btn btn-warning" id="skipBtn" onclick="skipSentence()">
                            <span>Skip</span>
                        </button>
                    </div>

                    <div class="feedback hidden" id="feedback"></div>
                    <div class="model-answer hidden" id="modelAnswer"></div>
                </div>

                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="correctCount">0</span> correct | <span id="partialCount">0</span> partial | <span id="incorrectCount">0</span> incorrect
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="newPassage()">
                    <span>Generate New Passage</span>
                </button>
            </div>
        </div>

        <!-- Completion Panel -->
        <div class="panel hidden" id="completionPanel">
            <div class="completion-panel">
                <div class="completion-grade" id="finalGrade">A</div>
                <div class="completion-message" id="finalMessage">Great job! Well done!</div>
                <div class="completion-stats" id="finalStats">
                    Score: 5/6 correct (83%)
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="newPassage()">
                        <span>Try Another Passage</span>
                    </button>
                    <button class="btn btn-secondary" onclick="reviewAnswers()">
                        <span>Review Answers</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../auth/config.js"></script>
    <script src="../shared/xp-system.js"></script>
    <script src="../shared/task-tracker.js"></script>
    <script src="data/translation-generator-data.js"></script>
    <script src="../shared/translation-generator.js"></script>

    <script>
        // State
        let selectedChapter = null;
        let currentPassage = null;
        let currentSentenceIndex = 0;
        let results = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initChapterGrid();
            initEventListeners();
            checkTrackingStatus();
        });

        // Check tracking status
        async function checkTrackingStatus() {
            const indicator = document.getElementById('trackingIndicator');
            const text = document.getElementById('trackingText');
            const dot = indicator.querySelector('.tracking-dot');

            if (typeof supabase === 'undefined') {
                text.textContent = 'Progress tracking unavailable';
                return;
            }

            const { data: { user } } = await supabase.auth.getUser();

            if (user) {
                indicator.style.background = '#ecfdf5';
                indicator.style.borderColor = '#a7f3d0';
                indicator.style.color = '#065f46';
                dot.style.background = '#10b981';
                dot.style.animation = 'pulse 2s infinite';
                text.textContent = 'Logged in - your practice will be tracked';
            } else {
                text.innerHTML = 'Log in to track progress - <a href="/auth/login.html" style="color: #7c3aed;">Sign in</a>';
            }
        }

        function initChapterGrid() {
            const grid = document.getElementById('chapterGrid');
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'chapter-btn';
                btn.textContent = `Ch ${i}`;
                btn.dataset.chapter = i;
                btn.onclick = () => selectChapter(i);
                grid.appendChild(btn);
            }
        }

        function initEventListeners() {
            document.getElementById('spotlightSelect').addEventListener('change', function() {
                const intensityDiv = document.getElementById('intensityOptions');
                intensityDiv.style.display = this.value ? 'flex' : 'none';
            });

            document.getElementById('answerInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const checkBtn = document.getElementById('checkBtn');
                    const nextBtn = document.getElementById('nextBtn');
                    if (!checkBtn.classList.contains('hidden')) {
                        checkAnswer();
                    } else if (!nextBtn.classList.contains('hidden')) {
                        nextSentence();
                    }
                }
            });
        }

        function selectChapter(chapter) {
            selectedChapter = chapter;

            // Update UI
            document.querySelectorAll('.chapter-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.chapter) === chapter) {
                    btn.classList.add('selected');
                }
            });

            // Update spotlight options
            updateSpotlightOptions(chapter);

            // Enable generate button
            document.getElementById('generateBtn').disabled = false;
        }

        function updateSpotlightOptions(maxChapter) {
            const select = document.getElementById('spotlightSelect');
            const spotlights = TranslationGenerator.getAvailableSpotlights(maxChapter);

            select.innerHTML = '<option value="">No spotlight - mixed practice</option>';

            spotlights.forEach(s => {
                const option = document.createElement('option');
                option.value = s.key;
                option.textContent = `${s.name} (Ch ${s.minChapter}+)`;
                select.appendChild(option);
            });
        }

        document.getElementById('generateBtn').addEventListener('click', generateAndStart);

        async function generateAndStart() {
            const spotlight = document.getElementById('spotlightSelect').value || null;
            const intensity = document.querySelector('input[name="intensity"]:checked')?.value || 'heavy';
            const length = parseInt(document.querySelector('input[name="length"]:checked')?.value || '6');

            // Generate passage
            currentPassage = TranslationGenerator.generatePassage(selectedChapter, spotlight, intensity, length);

            if (!currentPassage || currentPassage.sentences.length === 0) {
                alert('Could not generate passage. Try different settings.');
                return;
            }

            // Start tracking
            if (typeof taskTracker !== 'undefined') {
                taskTracker.setLanguage('latin');
                await taskTracker.start();
            }

            // Reset state
            currentSentenceIndex = 0;
            results = [];

            // Update UI
            document.getElementById('passageTitle').textContent = currentPassage.title;

            let metaText = `Chapter ${currentPassage.maxChapter} vocabulary`;
            if (currentPassage.spotlight) {
                const spotlightName = grammarSpotlights[currentPassage.spotlight]?.name || currentPassage.spotlight;
                metaText += ` | ${spotlightName} focus`;
            }
            metaText += ` | ${currentPassage.sentences.length} sentences`;
            document.getElementById('passageMeta').textContent = metaText;

            document.getElementById('fullPassage').textContent = currentPassage.fullText;

            // Show translation area
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('translationArea').classList.add('active');
            document.getElementById('completionPanel').classList.add('hidden');

            // Load first sentence
            loadSentence(0);
        }

        function loadSentence(index) {
            if (index >= currentPassage.sentences.length) {
                showCompletion();
                return;
            }

            const sentence = currentPassage.sentences[index];
            currentSentenceIndex = index;

            document.getElementById('sentenceCounter').textContent =
                `Sentence ${index + 1} of ${currentPassage.sentences.length}`;
            document.getElementById('currentLatin').textContent = sentence.latin;

            // Reset input
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();

            // Reset hints
            document.getElementById('hintDisplay').classList.remove('visible');
            document.getElementById('hintDisplay').textContent = '';
            document.getElementById('vocabHintBtn').disabled = false;
            document.getElementById('grammarHintBtn').disabled = false;

            // Reset buttons
            document.getElementById('checkBtn').classList.remove('hidden');
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('skipBtn').classList.remove('hidden');

            // Reset feedback
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('modelAnswer').classList.add('hidden');

            // Update progress
            updateProgress();
        }

        function showVocabHint() {
            const sentence = currentPassage.sentences[currentSentenceIndex];
            const hints = sentence.hints || {};

            const hintDisplay = document.getElementById('hintDisplay');

            if (Object.keys(hints).length === 0) {
                hintDisplay.innerHTML = '<strong>Vocab hints:</strong> No specific hints available for this sentence.';
            } else {
                const hintList = Object.entries(hints)
                    .map(([word, hint]) => `<strong>${word}:</strong> ${hint}`)
                    .join('<br>');
                hintDisplay.innerHTML = `<strong>Vocab hints:</strong><br>${hintList}`;
            }

            hintDisplay.classList.add('visible');
            document.getElementById('vocabHintBtn').disabled = true;
        }

        function showGrammarHint() {
            const sentence = currentPassage.sentences[currentSentenceIndex];
            const hint = TranslationGenerator.getGrammarHint(sentence);

            const hintDisplay = document.getElementById('hintDisplay');
            hintDisplay.innerHTML = `<strong>Grammar hint:</strong> ${hint}`;
            hintDisplay.classList.add('visible');
            document.getElementById('grammarHintBtn').disabled = true;
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim();
            const sentence = currentPassage.sentences[currentSentenceIndex];

            const result = TranslationGenerator.checkTranslation(userAnswer, sentence);
            results.push(result);

            // Track activity
            if (typeof taskTracker !== 'undefined' && taskTracker.isTracking) {
                taskTracker.recordActivity();
                taskTracker.questionsAnswered++;
                if (result.correct) taskTracker.correctAnswers++;
            }

            // Show feedback
            const feedback = document.getElementById('feedback');
            feedback.textContent = result.feedback;
            feedback.classList.remove('hidden', 'feedback-correct', 'feedback-partial', 'feedback-incorrect');

            if (result.correct) {
                feedback.classList.add('feedback-correct');
            } else if (result.partial) {
                feedback.classList.add('feedback-partial');
            } else {
                feedback.classList.add('feedback-incorrect');
            }

            // Show model answer
            const modelAnswer = document.getElementById('modelAnswer');
            modelAnswer.innerHTML = `<strong>Model answer:</strong> ${sentence.translations[0]}`;
            modelAnswer.classList.remove('hidden');

            // Update buttons
            document.getElementById('checkBtn').classList.add('hidden');
            document.getElementById('nextBtn').classList.remove('hidden');
            document.getElementById('skipBtn').classList.add('hidden');

            // Update progress stats
            updateProgress();
        }

        function skipSentence() {
            results.push({ correct: false, partial: false, matchType: 'skipped', feedback: 'Skipped' });

            const sentence = currentPassage.sentences[currentSentenceIndex];

            // Track activity (skipped = incorrect)
            if (typeof taskTracker !== 'undefined' && taskTracker.isTracking) {
                taskTracker.recordActivity();
                taskTracker.questionsAnswered++;
            }

            const feedback = document.getElementById('feedback');
            feedback.textContent = 'Skipped - see the model answer below.';
            feedback.classList.remove('hidden', 'feedback-correct', 'feedback-partial');
            feedback.classList.add('feedback-incorrect');

            const modelAnswer = document.getElementById('modelAnswer');
            modelAnswer.innerHTML = `<strong>Model answer:</strong> ${sentence.translations[0]}`;
            modelAnswer.classList.remove('hidden');

            document.getElementById('checkBtn').classList.add('hidden');
            document.getElementById('nextBtn').classList.remove('hidden');
            document.getElementById('skipBtn').classList.add('hidden');

            updateProgress();
        }

        function nextSentence() {
            loadSentence(currentSentenceIndex + 1);
        }

        function updateProgress() {
            const total = currentPassage.sentences.length;
            const answered = results.length;
            const correct = results.filter(r => r.correct).length;
            const partial = results.filter(r => r.partial).length;
            const incorrect = answered - correct - partial;

            document.getElementById('progressFill').style.width = `${(answered / total) * 100}%`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('partialCount').textContent = partial;
            document.getElementById('incorrectCount').textContent = incorrect;
        }

        async function showCompletion() {
            const stats = TranslationGenerator.calculateStats(results);

            document.getElementById('finalGrade').textContent = stats.grade.grade;
            document.getElementById('finalMessage').textContent = stats.grade.message;
            document.getElementById('finalStats').textContent =
                `Score: ${stats.correct}/${stats.total} correct (${stats.percentage}%)`;

            document.getElementById('translationArea').classList.remove('active');
            document.getElementById('completionPanel').classList.remove('hidden');

            // Complete tracking
            if (typeof taskTracker !== 'undefined' && taskTracker.isTracking) {
                await taskTracker.complete(stats.percentage, stats.total, stats.correct);
            }
        }

        function newPassage() {
            document.getElementById('setupPanel').classList.remove('hidden');
            document.getElementById('translationArea').classList.remove('active');
            document.getElementById('completionPanel').classList.add('hidden');

            // Reset
            currentPassage = null;
            currentSentenceIndex = 0;
            results = [];
        }

        function reviewAnswers() {
            // For now, just restart
            // Could implement a review mode showing all sentences and answers
            alert('Review feature coming soon! For now, try another passage.');
        }
    </script>
</body>
</html>
