<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15-Mark Answer Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 25%, #e6f0ff 60%, #ffffff 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            padding: 1.5rem;
        }

        .header {
            text-align: center;
            padding: 1rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .question-box {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .question-input {
            width: 100%;
            font-size: 1.3rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            background: white;
            font-family: inherit;
            text-align: center;
        }

        .question-input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .marks {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .marks-input {
            width: 50px;
            font-size: 1rem;
            color: #666;
            font-weight: 500;
            border: 1px solid rgba(0, 102, 255, 0.2);
            border-radius: 4px;
            padding: 0.25rem;
            text-align: center;
            font-family: inherit;
        }

        .marks-input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .author-input {
            width: 200px;
            font-size: 1rem;
            color: #0066ff;
            font-weight: 600;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            font-family: inherit;
        }

        .author-input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            max-width: 1600px;
            margin: 0 auto 1.5rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(0, 102, 255, 0.2);
        }

        .builder-section {
            max-height: 75vh;
            overflow-y: auto;
        }

        .structure-guide {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .structure-guide strong {
            display: block;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .passage-input {
            width: 100%;
            min-height: 200px;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            line-height: 1.8;
            overflow: hidden;
        }

        .passage-input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .passage-input:disabled {
            background: rgba(0, 102, 255, 0.02);
            cursor: not-allowed;
        }

        .lock-btn {
            background: #0066ff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.2s ease;
        }

        .lock-btn:hover {
            background: #0052cc;
        }

        .lock-btn.locked {
            background: #4CAF50;
        }

        .technique-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            background: white;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .technique-select:focus {
            outline: none;
            border-color: #0066ff;
        }

        .custom-technique-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            background: white;
        }

        .custom-technique-input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .technique-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background: rgba(0, 102, 255, 0.05);
            cursor: not-allowed;
        }

        .answer-slot {
            background: white;
            border: 2px solid rgba(0, 102, 255, 0.15);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .slot-number {
            font-weight: 600;
            color: #0066ff;
            font-size: 1rem;
        }

        .clear-slot {
            background: transparent;
            border: 1px solid #ccc;
            color: #666;
            padding: 0.3rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-slot:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
            display: block;
        }

        .step-number {
            background: #0066ff;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .latin-input, .translation-input, .effect-phrase-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .latin-input:focus, .translation-input:focus, .effect-phrase-input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .translation-input {
            font-style: italic;
            color: #555;
            font-size: 0.9rem;
        }

        .sentence-starter, .structure-style {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }

        .sentence-starter:focus, .structure-style:focus {
            outline: none;
            border-color: #0066ff;
        }

        .analysis-textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 2px solid rgba(0, 102, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
        }

        .analysis-textarea:focus {
            outline: none;
            border-color: #0066ff;
        }

        .char-counter {
            text-align: right;
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .bank-button {
            width: 100%;
            padding: 0.75rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.75rem;
        }

        .bank-button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .add-slot-btn {
            width: 100%;
            padding: 0.75rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .answer-display {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 1600px;
            margin: 0 auto;
        }

        .banked-point {
            background: white;
            border: 1px solid rgba(0, 102, 255, 0.15);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 102, 255, 0.1);
        }

        .point-label {
            font-weight: 600;
            color: #0066ff;
            font-size: 0.9rem;
        }

        .point-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: transparent;
            border: 1px solid #ccc;
            color: #666;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .point-content {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #333;
            padding: 0.75rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: text;
            transition: all 0.2s ease;
            min-height: 3rem;
        }

        .point-content:hover {
            background: rgba(0, 102, 255, 0.05);
            border-color: rgba(0, 102, 255, 0.2);
        }

        .point-content:focus {
            outline: none;
            background: white;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .point-content[contenteditable="true"]:empty:before {
            content: "Click to edit...";
            color: #999;
        }

        .total-words {
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid rgba(0, 102, 255, 0.2);
            font-weight: 600;
            color: #0066ff;
        }

        .export-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
            font-style: italic;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Classicalia</div>
        <div class="subtitle">15-Mark Answer Builder</div>
    </header>

    <div class="question-box">
        <div style="display: flex; gap: 1rem; align-items: center; justify-content: center; margin-bottom: 1rem;">
            <div style="flex: 0 0 auto;">
                <label style="font-size: 0.9rem; color: #666; display: block; margin-bottom: 0.25rem;">Author:</label>
                <input type="text" id="authorInput" class="author-input" placeholder="e.g., Tacitus" value="Tacitus">
            </div>
        </div>
        <input type="text" id="questionInput" class="question-input" placeholder="Type or paste your question here..." value="How does Tacitus create a dramatic account of Britannicus' poisoning?">
        <div class="marks">
            [<input type="number" id="marksInput" class="marks-input" value="15" min="1" max="30"> marks]
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <h3 class="panel-title">Latin Passage</h3>
            
            <div class="input-group">
                <label class="input-label">Paste your Latin text:</label>
                <textarea id="latinTextInput" class="passage-input" placeholder="Paste your Latin passage here..." oninput="autoResize(this)">epulanti Britannico—nam proprium adhuc mensam et adstantem habebat—haustum poculi per ministros suos adlatum, ubi gustu temperantis eius probabat, additur venenum. ac perinde vocis et spiritus eius pavor obturbat convivas: pars imprudentes trepidavere, sagaciores manebant defixi et Neronem intuentes. at ille, ut erat reclinis et nescio similis, solitum ita ait per comitialem morbum, quo prima ab infantia adflictaretur Britannicus, et redituros paulatim visus sensusque.</textarea>
                <button class="lock-btn" id="lockLatinBtn" onclick="toggleLock('latin')">🔓 Click to Lock</button>
            </div>

            <div class="input-group">
                <label class="input-label">Paste your translation:</label>
                <textarea id="translationInput" class="passage-input" placeholder="Paste your English translation here..." oninput="autoResize(this)">While Britannicus was dining—for he still had his own separate table and attendant—a drink from a cup was brought to him by his servants, when the taster proved with his taste that it was harmless, poison was added. And at once the convulsions of his voice and breathing disturbed the guests: some unaware panicked, the shrewder ones remained frozen and watching Nero. But he, as he was reclining and pretending not to know, said it was usual because of the epilepsy, by which Britannicus had been afflicted from earliest infancy, and that his sight and senses would gradually return.</textarea>
                <button class="lock-btn" id="lockTransBtn" onclick="toggleLock('translation')">🔓 Click to Lock</button>
            </div>
        </div>

        <div class="panel builder-section">
            <h3 class="panel-title">Build Your Answer</h3>

            <div class="structure-guide">
                <strong>Answer Structure - Choose your style for each point:</strong>
                Different structures help avoid repetitive writing while maintaining analytical depth.
            </div>

            <div class="input-group">
                <label class="input-label">Select a stylistic technique:</label>
                <select id="techniqueSelect" class="technique-select" onchange="handleTechniqueChange()">
                    <option value="">Choose a technique...</option>
                    <option value="asyndeton">Asyndeton - omission of conjunctions (no 'and', 'but')</option>
                    <option value="polysyndeton">Polysyndeton - repeated conjunctions (lots of 'and', 'et')</option>
                    <option value="tricolon">Tricolon - three parallel phrases or clauses</option>
                    <option value="anaphora">Anaphora - repetition of words at start of clauses</option>
                    <option value="repetition">Repetition - repeated words/phrases for emphasis</option>
                    <option value="parallelism">Parallelism - similar grammatical structures</option>
                    <option value="chiasmus">Chiasmus - ABBA structure (reversed word order)</option>
                    <option value="hyperbaton">Hyperbaton - unusual/separated word order</option>
                    <option value="word order/delay">Word order/delay - key word held back for emphasis</option>
                    <option value="word order (advanced)">Word order (advanced) - complex structural arrangement</option>
                    <option value="vivid imagery">Vivid imagery - descriptive, sensory language</option>
                    <option value="irony">Irony - contrast between appearance and reality</option>
                    <option value="contrast">Contrast - opposing ideas/words placed together</option>
                    <option value="antithesis">Antithesis - direct opposites balanced against each other</option>
                    <option value="brevity">Brevity - short, clipped expression</option>
                    <option value="hyperbole">Hyperbole - exaggeration for effect</option>
                    <option value="loaded vocabulary">Loaded vocabulary - emotionally charged words</option>
                    <option value="metaphor">Metaphor - implicit comparison</option>
                    <option value="simile">Simile - explicit comparison (using 'like')</option>
                    <option value="personification">Personification - human qualities to non-human things</option>
                    <option value="alliteration">Alliteration - repeated consonant sounds</option>
                    <option value="sibilance">Sibilance - repeated 's' sounds</option>
                    <option value="rhetorical question">Rhetorical question - question for effect, not answer</option>
                    <option value="direct speech">Direct speech - character's actual words quoted</option>
                    <option value="indirect speech">Indirect speech - reported speech</option>
                    <option value="historic present">Historic present - present tense for past events</option>
                    <option value="historic infinitive">Historic infinitive - infinitive for past narration</option>
                    <option value="passive voice">Passive voice - subject receives the action</option>
                    <option value="zeugma">Zeugma - one verb governing multiple objects</option>
                    <option value="CUSTOM">✏️ Custom (type your own)</option>
                </select>
                <input type="text" id="customTechniqueInput" class="custom-technique-input" placeholder="Type your custom technique here..." style="display: none; margin-top: 0.5rem;">
            </div>

            <div id="slotsContainer"></div>

            <button class="add-slot-btn" onclick="addSlot()" style="display: none;">+ Add Another Point</button>
        </div>
    </div>

    <div class="answer-display">
        <h3 class="panel-title">Your Complete Answer</h3>
        <div id="answerDisplay">
            <div class="empty-state">Your banked points will appear here...</div>
        </div>
        <div class="total-words" id="totalWords" style="display: none;"></div>
        <button class="export-btn" id="exportBtn" onclick="exportToPDF()" disabled>📄 Export to PDF</button>
    </div>

    <script>
        let slotCount = 0;
        let bankedPoints = [];

        function handleTechniqueChange() {
            const select = document.getElementById('techniqueSelect');
            const customInput = document.getElementById('customTechniqueInput');
            
            if (select.value === 'CUSTOM') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
                copyTechniqueToSlots();
            }
        }

        function copyTechniqueToSlots() {
            const select = document.getElementById('techniqueSelect');
            const customInput = document.getElementById('customTechniqueInput');
            const selectedValue = select.value === 'CUSTOM' ? customInput.value.trim() : select.value;
            
            if (selectedValue) {
                const slots = document.querySelectorAll('.technique-input');
                slots.forEach(slot => {
                    slot.value = selectedValue;
                });
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        window.addEventListener('load', function() {
            autoResize(document.getElementById('latinTextInput'));
            autoResize(document.getElementById('translationInput'));
            document.getElementById('authorInput').addEventListener('input', updateSentenceStarters);
            
            const customInput = document.getElementById('customTechniqueInput');
            customInput.addEventListener('input', copyTechniqueToSlots);
            customInput.addEventListener('keyup', copyTechniqueToSlots);
        });

        function updateSentenceStarters() {
            const author = document.getElementById('authorInput').value || 'the author';
            const allStarters = document.querySelectorAll('.sentence-starter');
            
            allStarters.forEach(select => {
                const authorOption = select.querySelector('option[value="AUTHOR_PLACEHOLDER"]');
                if (authorOption) {
                    authorOption.value = 'By doing this, ' + author.toLowerCase();
                    authorOption.textContent = 'By doing this, ' + author.toLowerCase();
                }
            });
        }

        function toggleLock(type) {
            if (type === 'latin') {
                const input = document.getElementById('latinTextInput');
                const btn = document.getElementById('lockLatinBtn');
                input.disabled = !input.disabled;
                if (input.disabled) {
                    btn.textContent = '🔒 Locked';
                    btn.classList.add('locked');
                } else {
                    btn.textContent = '🔓 Click to Lock';
                    btn.classList.remove('locked');
                }
            } else {
                const input = document.getElementById('translationInput');
                const btn = document.getElementById('lockTransBtn');
                input.disabled = !input.disabled;
                if (input.disabled) {
                    btn.textContent = '🔒 Locked';
                    btn.classList.add('locked');
                } else {
                    btn.textContent = '🔓 Click to Lock';
                    btn.classList.remove('locked');
                }
            }
        }

        function createSlot() {
            slotCount++;
            const slotId = 'slot' + slotCount;
            
            const slot = document.createElement('div');
            slot.className = 'answer-slot';
            slot.id = slotId;
            
            const html = `
                <div class="slot-header">
                    <span class="slot-number">Point ${slotCount}</span>
                    <button class="clear-slot" onclick="clearSlot('${slotId}')">Clear</button>
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">1</span> Choose answer structure:</label>
                    <select class="structure-style">
                        <option value="">Select structure...</option>
                        <option value="standard">Standard: [Author] uses [technique] with "[Latin]" (translation)...</option>
                        <option value="quote-first">Quote-first: The phrase "[Latin]" (translation) demonstrates [technique]...</option>
                        <option value="effect-first">Effect-first: [Author] creates [effect] through [technique]...</option>
                        <option value="embedded">Embedded: Through [technique] ("[Latin]" - translation), [Author]...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">2</span> Technique (auto-filled):</label>
                    <input type="text" class="technique-input" placeholder="Select from dropdown above" readonly>
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">3</span> Copy your Latin quote:</label>
                    <input type="text" class="latin-input" placeholder="e.g., haustum... venenum">
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">4</span> Add translation:</label>
                    <input type="text" class="translation-input" placeholder="e.g., the drink... poison">
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">5</span> Effect phrase (for effect-first/embedded structures):</label>
                    <input type="text" class="effect-phrase-input" placeholder="e.g., suspense, enhances the tension, dramatic effect">
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">6</span> Choose sentence starter:</label>
                    <select class="sentence-starter">
                        <option value="">Select...</option>
                        <option value="This creates">This creates</option>
                        <option value="This emphasizes">This emphasizes</option>
                        <option value="This suggests">This suggests</option>
                        <option value="This highlights">This highlights</option>
                        <option value="This conveys">This conveys</option>
                        <option value="This reveals">This reveals</option>
                        <option value="AUTHOR_PLACEHOLDER">By doing this, [author]</option>
                        <option value="Through this,">Through this,</option>
                        <option value="In this way,">In this way,</option>
                        <option value="As a result,">As a result,</option>
                        <option value="Consequently,">Consequently,</option>
                        <option value="The effect of this is to">The effect of this is to</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label"><span class="step-number">7</span> Explain the effect:</label>
                    <textarea class="analysis-textarea" placeholder="Explain the dramatic effect...

Example: dramatic suspense by holding back the critical word until the end, making the reader experience the sudden shock of the poisoning."></textarea>
                    <div class="char-counter">0 characters</div>
                </div>
                <button class="bank-button" onclick="bankPoint('${slotId}')">Bank Point</button>
            `;
            
            slot.innerHTML = html;
            return slot;
        }

        function addSlot() {
            const container = document.getElementById('slotsContainer');
            const slot = createSlot();
            container.appendChild(slot);
            setupValidation(slot);
            updateSentenceStarters();
            
            // Copy technique to new slot
            copyTechniqueToSlots();
        }

        function setupValidation(slot) {
            const textarea = slot.querySelector('.analysis-textarea');
            const counter = slot.querySelector('.char-counter');

            textarea.addEventListener('input', function() {
                const charCount = this.value.length;
                const wordCount = this.value.trim().split(/\s+/).filter(w => w.length > 0).length;
                counter.textContent = charCount + ' characters (~' + wordCount + ' words)';
            });
        }

        function bankPoint(slotId) {
            const slot = document.getElementById(slotId);
            const structure = slot.querySelector('.structure-style').value;
            const technique = slot.querySelector('.technique-input').value;
            const latin = slot.querySelector('.latin-input').value;
            const translation = slot.querySelector('.translation-input').value;
            const effectPhrase = slot.querySelector('.effect-phrase-input').value;
            let starter = slot.querySelector('.sentence-starter').value;
            const effect = slot.querySelector('.analysis-textarea').value;
            const author = document.getElementById('authorInput').value || 'The author';

            // Validation - check if required fields are filled
            if (!structure || !technique || !latin || !translation || !starter || !effect) {
                alert('Please fill in all required fields before banking this point.');
                return;
            }

            // Handle author placeholder
            const authorPattern = /\b(tacitus|virgil|cicero|ovid|horace|catullus|livy|pliny|lawrence|[a-z]+)\b/i;
            if (starter.match(authorPattern) && starter.toLowerCase().includes('by doing this')) {
                starter = 'By doing this, ' + author;
            }

            let fullPoint = '';

            if (structure === 'standard') {
                fullPoint = author + ' uses ' + technique + ' with "' + latin + '" (' + translation + '). ' + starter + ' ' + effect;
            } else if (structure === 'quote-first') {
                fullPoint = 'The phrase "' + latin + '" (' + translation + ') demonstrates ' + technique + '. ' + starter + ' ' + effect;
            } else if (structure === 'effect-first') {
                const effectText = effectPhrase || 'dramatic effect';
                fullPoint = author + ' creates ' + effectText + ' through ' + technique + ' in "' + latin + '" (' + translation + '). ' + starter + ' ' + effect;
            } else if (structure === 'embedded') {
                const effectText = effectPhrase || 'dramatic effect';
                fullPoint = 'Through ' + technique + ' ("' + latin + '" - ' + translation + '), ' + author + ' creates ' + effectText + '. ' + starter + ' ' + effect;
            }

            const pointNumber = bankedPoints.length + 1;
            bankedPoints.push({ fullPoint, pointNumber });

            updateAnswerDisplay();
            clearSlot(slotId);
        }

        function clearSlot(slotId) {
            const slot = document.getElementById(slotId);
            slot.querySelector('.structure-style').value = '';
            slot.querySelector('.latin-input').value = '';
            slot.querySelector('.translation-input').value = '';
            slot.querySelector('.effect-phrase-input').value = '';
            slot.querySelector('.sentence-starter').value = '';
            slot.querySelector('.analysis-textarea').value = '';
            slot.querySelector('.char-counter').textContent = '0 characters';
            
            // Re-fill technique from dropdown
            const techniqueSelect = document.getElementById('techniqueSelect');
            const customInput = document.getElementById('customTechniqueInput');
            const techniqueInput = slot.querySelector('.technique-input');
            
            if (techniqueSelect.value === 'CUSTOM' && customInput.value.trim()) {
                techniqueInput.value = customInput.value.trim();
            } else if (techniqueSelect.value && techniqueSelect.value !== 'CUSTOM') {
                techniqueInput.value = techniqueSelect.value;
            } else {
                techniqueInput.value = '';
            }
        }

        function updateAnswerDisplay() {
            const display = document.getElementById('answerDisplay');
            const totalWords = document.getElementById('totalWords');

            if (bankedPoints.length === 0) {
                display.innerHTML = '<div class="empty-state">Your banked points will appear here...</div>';
                totalWords.style.display = 'none';
                document.getElementById('exportBtn').disabled = true;
                return;
            }

            let html = '';
            let wordCount = 0;

            bankedPoints.forEach((point, index) => {
                const words = point.fullPoint.trim().split(/\s+/).filter(w => w.length > 0).length;
                wordCount += words;

                html += '<div class="banked-point"><div class="point-header"><span class="point-label">Point ' + point.pointNumber + '</span><div class="point-actions"><button class="action-btn" onclick="moveUp(' + index + ')">▲</button><button class="action-btn" onclick="moveDown(' + index + ')">▼</button><button class="action-btn" onclick="removePoint(' + index + ')">✕</button></div></div><div class="point-content" contenteditable="true" onblur="updatePointText(' + index + ', this.innerText)" onkeydown="if(event.key===\'Enter\' && !event.shiftKey){event.preventDefault(); this.blur();}">' + point.fullPoint + '</div></div>';
            });

            display.innerHTML = html;
            totalWords.textContent = 'Total: ' + bankedPoints.length + ' points, ~' + wordCount + ' words';
            totalWords.style.display = 'block';
            document.getElementById('exportBtn').disabled = false;
        }

        function updatePointText(index, newText) {
            if (bankedPoints[index]) {
                bankedPoints[index].fullPoint = newText.trim();
                updateAnswerDisplay();
            }
        }

        function moveUp(index) {
            if (index > 0) {
                const temp = bankedPoints[index];
                bankedPoints[index] = bankedPoints[index - 1];
                bankedPoints[index - 1] = temp;
                updateAnswerDisplay();
            }
        }

        function moveDown(index) {
            if (index < bankedPoints.length - 1) {
                const temp = bankedPoints[index];
                bankedPoints[index] = bankedPoints[index + 1];
                bankedPoints[index + 1] = temp;
                updateAnswerDisplay();
            }
        }

        function removePoint(index) {
            bankedPoints.splice(index, 1);
            updateAnswerDisplay();
        }

        function exportToPDF() {
            const question = document.getElementById('questionInput').value;
            const date = new Date().toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });

            const printWindow = window.open('', '_blank');
            
            let htmlContent = '<!DOCTYPE html><html><head><title>Latin Answer</title>';
            htmlContent += '<meta charset="UTF-8">';
            htmlContent += '<style>';
            htmlContent += '@page { margin: 2.5cm; }';
            htmlContent += 'body { font-family: "Times New Roman", Times, serif; margin: 0; padding: 1cm; line-height: 1.8; color: #000; background: white; }';
            htmlContent += '.date { text-align: right; margin-bottom: 2em; font-size: 11pt; }';
            htmlContent += '.question { font-weight: bold; font-size: 13pt; margin-bottom: 2em; text-align: center; }';
            htmlContent += '.answer { font-size: 12pt; }';
            htmlContent += '.paragraph { margin-bottom: 1.5em; text-align: justify; }';
            htmlContent += '@media print { body { padding: 0; } }';
            htmlContent += '</style></head><body>';
            
            htmlContent += '<div class="date">' + date + '</div>';
            htmlContent += '<div class="question">' + question + '</div>';
            htmlContent += '<div class="answer">';
            
            bankedPoints.forEach(function(point) {
                htmlContent += '<div class="paragraph">' + point.fullPoint + '</div>';
            });
            
            htmlContent += '</div>';
            htmlContent += '<script>setTimeout(function() { window.print(); }, 250);<\/script>';
            htmlContent += '</body></html>';
            
            printWindow.document.open();
            printWindow.document.write(htmlContent);
            printWindow.document.close();
        }

        // Initialize with one slot
        addSlot();
    </script>
</body>
</html>
