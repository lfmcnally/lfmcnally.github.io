<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messalina - Section 2</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: #333;
            padding: 25px 45px;
            min-height: 100vh;
            margin: 0;
            font-size: 22px;
        }

        .header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 2px;
        }

        .logo:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
        }

        .title-area {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        h1 {
            color: #222;
            margin: 0;
            font-size: 1.6em;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1em;
            color: #666;
            margin: 0;
        }

        /* Compact controls */
        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 4px;
        }

        .controls {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .controls button {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
            flex: 1;
            text-align: center;
        }

        .controls button:hover {
            background: rgba(0, 102, 255, 0.15);
            transform: translateY(-1px);
        }

        #showAllBtn {
            background: #0066ff;
            color: white;
        }

        #showAllBtn:hover {
            background: #0052cc;
        }

        #hideAllBtn {
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
        }

        #toggleColoursBtn {
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
        }

        #toggleStyleBtn {
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
        }

        body.style-mode #toggleStyleBtn {
            background: #0066ff;
            color: white;
        }

        /* Key - compact squares in header */
        .key {
            display: flex;
            gap: 6px;
        }

        .key-item {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
            flex: 1;
        }

        .key-item:hover {
            transform: translateY(-1px);
            filter: brightness(0.95);
        }

        .key-item.active {
            outline: 2px solid #333;
            outline-offset: 1px;
        }

        /* Main content area */
        .translation-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
        }

        .column-header {
            font-size: 0.9em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            padding-left: 0;
        }

        /* Each line row */
        .line-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .line-number {
            display: none;
            color: #0066ff;
            font-weight: bold;
            min-width: 45px;
            margin-right: 10px;
            font-size: 1.15em;
            align-self: flex-end;
            padding-bottom: 4px;
        }

        .words-container {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            flex-wrap: wrap;
        }

        /* Word group with number above */
        .word-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .word-order {
            font-size: 0.65em;
            color: #888;
            margin-bottom: 4px;
            height: 1em;
            font-weight: 600;
        }

        .latin-word, .english-word {
            padding: 3px 7px;
            border-radius: 3px;
            font-size: 1em;
            transition: background-color 0.3s, opacity 0.3s;
            cursor: pointer;
        }

        .latin-word {
            background-color: transparent;
        }

        .english-word {
            opacity: 0;
        }

        .english-word.revealed {
            opacity: 1;
        }

        /* Colours */
        .subject .latin-word { background-color: #ffb3b3; }
        .english-word.subject { background-color: #ffb3b3; }

        .verb .latin-word { background-color: #b3e6ff; }
        .english-word.verb { background-color: #b3e6ff; }

        .object .latin-word { background-color: #b3ffcc; }
        .english-word.object { background-color: #b3ffcc; }

        .genitive .latin-word { background-color: #ffd9b3; }
        .english-word.genitive { background-color: #ffd9b3; }

        .dative .latin-word { background-color: #e6b3ff; }
        .english-word.dative { background-color: #e6b3ff; }

        .ablative .latin-word { background-color: #ffffb3; }
        .english-word.ablative { background-color: #ffffb3; }

        .preposition .latin-word { background-color: #ffb3e6; }
        .english-word.preposition { background-color: #ffb3e6; }

        .conjunction .latin-word { background-color: #d9ffb3; }
        .english-word.conjunction { background-color: #d9ffb3; }

        .adverb .latin-word { background-color: #ccb3ff; }
        .english-word.adverb { background-color: #ccb3ff; }

        .gerundive .latin-word { background-color: #ffcbb3; }
        .english-word.gerundive { background-color: #ffcbb3; }

        /* Highlighting */
        .subject.highlighted .latin-word { background-color: #ffb3b3 !important; }
        .english-word.subject.highlighted { background-color: #ffb3b3 !important; }
        .verb.highlighted .latin-word { background-color: #b3e6ff !important; }
        .english-word.verb.highlighted { background-color: #b3e6ff !important; }
        .object.highlighted .latin-word { background-color: #b3ffcc !important; }
        .english-word.object.highlighted { background-color: #b3ffcc !important; }
        .genitive.highlighted .latin-word { background-color: #ffd9b3 !important; }
        .english-word.genitive.highlighted { background-color: #ffd9b3 !important; }
        .dative.highlighted .latin-word { background-color: #e6b3ff !important; }
        .english-word.dative.highlighted { background-color: #e6b3ff !important; }
        .ablative.highlighted .latin-word { background-color: #ffffb3 !important; }
        .english-word.ablative.highlighted { background-color: #ffffb3 !important; }
        .preposition.highlighted .latin-word { background-color: #ffb3e6 !important; }
        .english-word.preposition.highlighted { background-color: #ffb3e6 !important; }
        .conjunction.highlighted .latin-word { background-color: #d9ffb3 !important; }
        .english-word.conjunction.highlighted { background-color: #d9ffb3 !important; }
        .adverb.highlighted .latin-word { background-color: #ccb3ff !important; }
        .english-word.adverb.highlighted { background-color: #ccb3ff !important; }
        .gerundive.highlighted .latin-word { background-color: #ffcbb3 !important; }
        .english-word.gerundive.highlighted { background-color: #ffcbb3 !important; }

        /* Hide colours mode */
        body.hide-colours .subject .latin-word,
        body.hide-colours .english-word.subject.revealed,
        body.hide-colours .verb .latin-word,
        body.hide-colours .english-word.verb.revealed,
        body.hide-colours .object .latin-word,
        body.hide-colours .english-word.object.revealed,
        body.hide-colours .genitive .latin-word,
        body.hide-colours .english-word.genitive.revealed,
        body.hide-colours .dative .latin-word,
        body.hide-colours .english-word.dative.revealed,
        body.hide-colours .ablative .latin-word,
        body.hide-colours .english-word.ablative.revealed,
        body.hide-colours .preposition .latin-word,
        body.hide-colours .english-word.preposition.revealed,
        body.hide-colours .conjunction .latin-word,
        body.hide-colours .english-word.conjunction.revealed,
        body.hide-colours .adverb .latin-word,
        body.hide-colours .english-word.adverb.revealed,
        body.hide-colours .gerundive .latin-word,
        body.hide-colours .english-word.gerundive.revealed {
            background-color: #e0e0e0;
        }

        /* Style Mode */
        .style-highlight {
            position: relative;
        }

        .style-highlight.active-style .latin-word {
            outline: 2px solid #333;
            outline-offset: 1px;
        }

        /* Style panel at bottom */
        .style-panel {
            display: none;
            background: rgba(0, 102, 255, 0.03);
            border-top: 2px solid rgba(0, 102, 255, 0.15);
            padding: 18px 24px;
            margin-top: 20px;
        }

        body.style-mode .style-panel {
            display: block;
        }

        .style-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .style-panel h3 {
            margin: 0;
            color: #0066ff;
            font-size: 1rem;
            font-weight: 600;
        }

        .style-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .style-tag {
            padding: 8px 14px;
            background: white;
            border: 1px solid rgba(0, 102, 255, 0.25);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
        }

        .style-tag:hover {
            border-color: #0066ff;
            background: rgba(0, 102, 255, 0.05);
        }

        .style-tag.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        .style-tag em {
            font-style: italic;
        }

        .style-analysis {
            display: none;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(0, 102, 255, 0.15);
        }

        .style-analysis.active {
            display: block;
        }

        .style-analysis-title {
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .style-analysis-lines {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .style-analysis-effect {
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .style-analysis-effect strong {
            color: #0066ff;
        }

        .style-analysis-exam {
            padding-top: 12px;
            border-top: 1px dashed #ddd;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        .style-analysis-exam strong {
            color: #333;
        }

        .style-analysis em {
            font-style: italic;
        }

        /* ===== ANALYSIS MODE ===== */
        #analyseBtn {
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            color: white;
        }

        #analyseBtn:hover {
            background: linear-gradient(135deg, #0052cc 0%, #3d85e0 100%);
        }

        .analysis-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #fff;
            z-index: 1000;
            flex-direction: column;
        }

        .analysis-overlay.active {
            display: flex;
        }

        .analysis-overlay .english-word {
            opacity: 1;
        }

        /* Top toolbar */
        .analysis-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
            z-index: 20;
            flex-shrink: 0;
        }

        .analysis-toolbar-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-btn {
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: rgba(0, 102, 255, 0.08);
            color: #0066ff;
            font-family: inherit;
        }

        .analysis-btn:hover {
            background: rgba(0, 102, 255, 0.15);
        }

        .analysis-btn.active {
            background: #0066ff;
            color: white;
        }

        .analysis-btn.back-btn {
            background: #f0f0f0;
            color: #333;
        }

        .analysis-btn.back-btn:hover {
            background: #e0e0e0;
        }

        .analysis-nav-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            min-width: 140px;
            text-align: center;
        }

        .save-indicator {
            font-size: 0.8rem;
            color: #4caf50;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        /* Drawing tools bar */
        .analysis-tools-bar {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            gap: 6px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            flex-shrink: 0;
            z-index: 20;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tool-divider {
            width: 1px;
            height: 22px;
            background: #ddd;
            margin: 0 8px;
        }

        .color-swatch {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.active {
            border-color: #333;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #333;
        }

        .size-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.15s;
            font-family: inherit;
        }

        .size-btn:hover {
            background: #f0f0f0;
        }

        .size-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        /* Analysis key */
        .analysis-key {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .analysis-key-item {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            color: #555;
        }

        /* Workspace */
        .analysis-workspace {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
            background-image: radial-gradient(circle, #e8e8e8 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .analysis-sentence-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            pointer-events: none;
            max-width: 80%;
        }

        .analysis-latin-line {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .analysis-english-line {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }

        .analysis-sentence-display .word-group {
            cursor: default;
        }

        .analysis-sentence-display .word-order {
            display: none;
        }

        .analysis-sentence-display .latin-word {
            font-size: 1.4em;
            padding: 5px 12px;
            border-radius: 4px;
        }

        .analysis-sentence-display .english-word {
            font-size: 1.2em;
            padding: 4px 10px;
            border-radius: 4px;
        }

        #analysisCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
        }

        #analysisCanvas.eraser-mode {
            cursor: cell;
        }

        #analysisCanvas.pointer-mode {
            pointer-events: none;
            cursor: default;
        }

        /* Notes panel */
        .analysis-notes {
            border-top: 2px solid #eee;
            background: #fafafa;
            flex-shrink: 0;
            z-index: 20;
        }

        .analysis-notes-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            cursor: pointer;
            user-select: none;
        }

        .analysis-notes-toggle:hover {
            background: #f0f0f0;
        }

        .analysis-notes-toggle h4 {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .analysis-notes-toggle .toggle-arrow {
            font-size: 0.8rem;
            color: #999;
            transition: transform 0.2s;
        }

        .analysis-notes.open .toggle-arrow {
            transform: rotate(180deg);
        }

        .analysis-notes-body {
            display: none;
            padding: 0 20px 12px;
        }

        .analysis-notes.open .analysis-notes-body {
            display: block;
        }

        #analysisNotesText {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            outline: none;
            line-height: 1.5;
        }

        #analysisNotesText:focus {
            border-color: #0066ff;
            box-shadow: 0 0 0 2px rgba(0, 102, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <a href="https://www.classicalia.co.uk" class="logo">C</a>
                <div class="title-area">
                    <h1>Messalina</h1>
                    <p class="subtitle">Section 2 (Lines 8-17): Messalina's visits to Silius become increasingly more frequent</p>
                </div>
            </div>
            <div class="controls-area">
                <div class="controls">
                    <button id="showAllBtn">Show All</button>
                    <button id="hideAllBtn">Hide All</button>
                    <button id="toggleColoursBtn">Hide Colours</button>
                    <button id="toggleStyleBtn">Style Notes</button>
                    <button id="analyseBtn">Analyse</button>
                </div>
                <div class="key">
                    <span class="key-item" data-category="subject" style="background-color: #ffb3b3;">Subj.</span>
                    <span class="key-item" data-category="object" style="background-color: #b3ffcc;">Obj.</span>
                    <span class="key-item" data-category="verb" style="background-color: #b3e6ff;">Verb</span>
                    <span class="key-item" data-category="genitive" style="background-color: #ffd9b3;">Gen.</span>
                    <span class="key-item" data-category="dative" style="background-color: #e6b3ff;">Dat.</span>
                    <span class="key-item" data-category="ablative" style="background-color: #ffffb3;">Abl.</span>
                    <span class="key-item" data-category="preposition" style="background-color: #ffb3e6;">Prep.</span>
                    <span class="key-item" data-category="conjunction" style="background-color: #d9ffb3;">Conj.</span>
                    <span class="key-item" data-category="adverb" style="background-color: #ccb3ff;">Adv.</span>
                    <span class="key-item" data-category="gerundive" style="background-color: #ffcbb3;">Gdv.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="translation-area">
        <!-- LATIN COLUMN -->
        <div class="latin-column">
            <div class="column-header">Latin</div>

            <!-- Sentence 1: illa non furtim sed multis cum comitibus ventitat domum, egredienti adhaeret, dat opes honoresque: -->
            <div class="line-row" data-line="1">
                <span class="line-number">1</span>
                <div class="words-container">
                    <span class="word-group subject" data-order="01-01"><span class="word-order">1</span><span class="latin-word">illa</span></span>
                    <span class="word-group adverb" data-order="01-04"><span class="word-order">4</span><span class="latin-word">non</span></span>
                    <span class="word-group adverb" data-order="01-05"><span class="word-order">5</span><span class="latin-word">furtim</span></span>
                    <span class="word-group conjunction" data-order="01-06"><span class="word-order">6</span><span class="latin-word">sed</span></span>
                    <span class="word-group ablative" data-order="01-08"><span class="word-order">8</span><span class="latin-word">multis</span></span>
                    <span class="word-group preposition" data-order="01-07"><span class="word-order">7</span><span class="latin-word">cum</span></span>
                    <span class="word-group ablative" data-order="01-09"><span class="word-order">9</span><span class="latin-word">comitibus</span></span>
                    <span class="word-group verb" data-order="01-02"><span class="word-order">2</span><span class="latin-word">ventitat</span></span>
                    <span class="word-group object" data-order="01-03"><span class="word-order">3</span><span class="latin-word">domum,</span></span>
                    <span class="word-group dative" data-order="01-11"><span class="word-order">11</span><span class="latin-word">egredienti</span></span>
                    <span class="word-group verb" data-order="01-10"><span class="word-order">10</span><span class="latin-word">adhaeret,</span></span>
                    <span class="word-group verb style-highlight" data-order="01-12" data-style-feature="asyndeton"><span class="word-order">12</span><span class="latin-word">dat</span></span>
                    <span class="word-group object style-highlight" data-order="01-13" data-style-feature="asyndeton"><span class="word-order">13</span><span class="latin-word">opes</span></span>
                    <span class="word-group object style-highlight" data-order="01-14" data-style-feature="asyndeton"><span class="word-order">14</span><span class="latin-word">honoresque:</span></span>
                </div>
            </div>

            <!-- Sentence 2: postremo servi, liberti, paratus principis apud adulterum saepe videbantur. -->
            <div class="line-row" data-line="2">
                <span class="line-number">2</span>
                <div class="words-container">
                    <span class="word-group adverb" data-order="02-01"><span class="word-order">1</span><span class="latin-word">postremo</span></span>
                    <span class="word-group subject style-highlight" data-order="02-02" data-style-feature="tricolon"><span class="word-order">2</span><span class="latin-word">servi,</span></span>
                    <span class="word-group subject style-highlight" data-order="02-03" data-style-feature="tricolon"><span class="word-order">3</span><span class="latin-word">liberti,</span></span>
                    <span class="word-group subject style-highlight" data-order="02-04" data-style-feature="tricolon"><span class="word-order">4</span><span class="latin-word">paratus</span></span>
                    <span class="word-group genitive" data-order="02-05"><span class="word-order">5</span><span class="latin-word">principis</span></span>
                    <span class="word-group preposition" data-order="02-06"><span class="word-order">6</span><span class="latin-word">apud</span></span>
                    <span class="word-group object" data-order="02-07"><span class="word-order">7</span><span class="latin-word">adulterum</span></span>
                    <span class="word-group adverb" data-order="02-08"><span class="word-order">8</span><span class="latin-word">saepe</span></span>
                    <span class="word-group verb" data-order="02-09"><span class="word-order">9</span><span class="latin-word">videbantur.</span></span>
                </div>
            </div>

            <!-- Sentence 3: at Claudius matrimonii sui ignarus. -->
            <div class="line-row" data-line="3">
                <span class="line-number">3</span>
                <div class="words-container">
                    <span class="word-group conjunction" data-order="03-01"><span class="word-order">1</span><span class="latin-word">at</span></span>
                    <span class="word-group subject style-highlight" data-order="03-02" data-style-feature="ellipsis irony"><span class="word-order">2</span><span class="latin-word">Claudius</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-05" data-style-feature="ellipsis irony"><span class="word-order">5</span><span class="latin-word">matrimonii</span></span>
                    <span class="word-group genitive style-highlight" data-order="03-04" data-style-feature="irony"><span class="word-order">4</span><span class="latin-word">sui</span></span>
                    <span class="word-group adverb style-highlight" data-order="03-03" data-style-feature="ellipsis irony"><span class="word-order">3</span><span class="latin-word">ignarus.</span></span>
                </div>
            </div>

            <!-- Sentence 4: iam Messalina propter facilitatem adulteriorum ad novas libidines versa est. -->
            <div class="line-row" data-line="4">
                <span class="line-number">4</span>
                <div class="words-container">
                    <span class="word-group adverb" data-order="04-01"><span class="word-order">1</span><span class="latin-word">iam</span></span>
                    <span class="word-group subject" data-order="04-02"><span class="word-order">2</span><span class="latin-word">Messalina</span></span>
                    <span class="word-group preposition" data-order="04-04"><span class="word-order">4</span><span class="latin-word">propter</span></span>
                    <span class="word-group object" data-order="04-05"><span class="word-order">5</span><span class="latin-word">facilitatem</span></span>
                    <span class="word-group genitive" data-order="04-06"><span class="word-order">6</span><span class="latin-word">adulteriorum</span></span>
                    <span class="word-group preposition" data-order="04-07"><span class="word-order">7</span><span class="latin-word">ad</span></span>
                    <span class="word-group object" data-order="04-08"><span class="word-order">8</span><span class="latin-word">novas</span></span>
                    <span class="word-group object" data-order="04-09"><span class="word-order">9</span><span class="latin-word">libidines</span></span>
                    <span class="word-group verb" data-order="04-03"><span class="word-order">3</span><span class="latin-word">versa est.</span></span>
                </div>
            </div>

            <!-- Sentence 5: Silius, sive fatali insania an ipsa pericula remedium imminentium periculorum ratus, abrumpi dissimulationem urgebat: -->
            <div class="line-row" data-line="5">
                <span class="line-number">5</span>
                <div class="words-container">
                    <span class="word-group subject" data-order="05-01"><span class="word-order">1</span><span class="latin-word">Silius,</span></span>
                    <span class="word-group conjunction" data-order="05-02"><span class="word-order">2</span><span class="latin-word">sive</span></span>
                    <span class="word-group ablative style-highlight" data-order="05-03" data-style-feature="oxymoron"><span class="word-order">3</span><span class="latin-word">fatali</span></span>
                    <span class="word-group ablative style-highlight" data-order="05-04" data-style-feature="oxymoron"><span class="word-order">4</span><span class="latin-word">insania</span></span>
                    <span class="word-group conjunction" data-order="05-05"><span class="word-order">5</span><span class="latin-word">an</span></span>
                    <span class="word-group subject" data-order="05-08"><span class="word-order">8</span><span class="latin-word">ipsa</span></span>
                    <span class="word-group object style-highlight" data-order="05-07" data-style-feature="paradox"><span class="word-order">7</span><span class="latin-word">pericula</span></span>
                    <span class="word-group object style-highlight" data-order="05-09" data-style-feature="paradox"><span class="word-order">9</span><span class="latin-word">remedium</span></span>
                    <span class="word-group genitive style-highlight" data-order="05-10" data-style-feature="paradox"><span class="word-order">10</span><span class="latin-word">imminentium</span></span>
                    <span class="word-group genitive style-highlight" data-order="05-11" data-style-feature="paradox"><span class="word-order">11</span><span class="latin-word">periculorum</span></span>
                    <span class="word-group verb" data-order="05-06"><span class="word-order">6</span><span class="latin-word">ratus,</span></span>
                    <span class="word-group verb" data-order="05-14"><span class="word-order">14</span><span class="latin-word">abrumpi</span></span>
                    <span class="word-group object" data-order="05-13"><span class="word-order">13</span><span class="latin-word">dissimulationem</span></span>
                    <span class="word-group verb" data-order="05-12"><span class="word-order">12</span><span class="latin-word">urgebat:</span></span>
                </div>
            </div>

            <!-- Sentence 6: quippe non exspectandum, dum princeps senesceret. -->
            <div class="line-row" data-line="6">
                <span class="line-number">6</span>
                <div class="words-container">
                    <span class="word-group conjunction" data-order="06-01"><span class="word-order">1</span><span class="latin-word">quippe</span></span>
                    <span class="word-group adverb" data-order="06-02"><span class="word-order">2</span><span class="latin-word">non</span></span>
                    <span class="word-group gerundive style-highlight" data-order="06-03" data-style-feature="gerundive"><span class="word-order">3</span><span class="latin-word">exspectandum,</span></span>
                    <span class="word-group conjunction" data-order="06-04"><span class="word-order">4</span><span class="latin-word">dum</span></span>
                    <span class="word-group subject" data-order="06-05"><span class="word-order">5</span><span class="latin-word">princeps</span></span>
                    <span class="word-group verb" data-order="06-06"><span class="word-order">6</span><span class="latin-word">senesceret.</span></span>
                </div>
            </div>
        </div>

        <!-- ENGLISH COLUMN -->
        <div class="english-column">
            <div class="column-header">English</div>

            <!-- Sentence 1 English -->
            <div class="line-row" data-line="1">
                <span class="line-number">1</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="01-01">She</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="01-02">keeps visiting</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="01-03">his house</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="01-04">not</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="01-05">secretly</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="01-06">but</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="01-07">with</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word ablative" data-order="01-08">many</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word ablative" data-order="01-09">companions;</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="01-10">she clings</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word dative" data-order="01-11">to him as he goes out,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="01-12">she gives him</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="01-13">wealth</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="01-14">and honours:</span></span>
                </div>
            </div>

            <!-- Sentence 2 English -->
            <div class="line-row" data-line="2">
                <span class="line-number">2</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="02-01">Finally,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="02-02">the slaves,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="02-03">freedmen,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="02-04">and equipment</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="02-05">of the emperor</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="02-06">at the house of</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="02-07">the adulterer</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="02-08">were often</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="02-09">seen.</span></span>
                </div>
            </div>

            <!-- Sentence 3 English -->
            <div class="line-row" data-line="3">
                <span class="line-number">3</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="03-01">But</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="03-02">Claudius (was)</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="03-03">unaware</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-04">of his own</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="03-05">marriage.</span></span>
                </div>
            </div>

            <!-- Sentence 4 English -->
            <div class="line-row" data-line="4">
                <span class="line-number">4</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="04-01">Now</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="04-02">Messalina,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="04-03">turned</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="04-04">because of</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="04-05">the ease</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="04-06">of her adulteries,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word preposition" data-order="04-07">to</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="04-08">new</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="04-09">lusts.</span></span>
                </div>
            </div>

            <!-- Sentence 5 English -->
            <div class="line-row" data-line="5">
                <span class="line-number">5</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="05-01">Silius,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="05-02">whether through</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word ablative" data-order="05-03">fatal</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word ablative" data-order="05-04">madness</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="05-05">or</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="05-06">thinking</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="05-07">(that) the dangers</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="05-08">themselves (were)</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="05-09">a remedy</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="05-10">for impending</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word genitive" data-order="05-11">dangers,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="05-12">urged that</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word object" data-order="05-13">the pretence</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="05-14">be broken off:</span></span>
                </div>
            </div>

            <!-- Sentence 6 English -->
            <div class="line-row" data-line="6">
                <span class="line-number">6</span>
                <div class="words-container">
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="06-01">For indeed</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word adverb" data-order="06-02">they should not</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word gerundive" data-order="06-03">wait,</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word conjunction" data-order="06-04">until</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word subject" data-order="06-05">the emperor</span></span>
                    <span class="word-group"><span class="word-order"></span><span class="english-word verb" data-order="06-06">grew old.</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Style Panel -->
    <div class="style-panel">
        <div class="style-panel-header">
            <h3>Stylistic Features</h3>
        </div>
        <div class="style-list">
            <span class="style-tag" data-feature="asyndeton">Asyndeton — <em>dat opes honoresque</em></span>
            <span class="style-tag" data-feature="tricolon">Tricolon — <em>servi, liberti, paratus</em></span>
            <span class="style-tag" data-feature="ellipsis">Ellipsis — <em>at Claudius ... ignarus</em></span>
            <span class="style-tag" data-feature="irony">Irony — <em>matrimonii sui ignarus</em></span>
            <span class="style-tag" data-feature="oxymoron">Oxymoron — <em>fatali insania</em></span>
            <span class="style-tag" data-feature="paradox">Paradox — <em>pericula remedium periculorum</em></span>
            <span class="style-tag" data-feature="gerundive">Gerundive of Obligation — <em>exspectandum</em></span>
        </div>

        <div class="style-analysis" id="analysis-asyndeton">
            <div class="style-analysis-title">Asyndeton — dat opes honoresque</div>
            <div class="style-analysis-lines">Sentence 1</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> Messalina is practically throwing gifts at Silius like confetti. "Gives wealth and honours" — notice how there's no conjunction linking the earlier verbs? <em>Ventitat... adhaeret... dat</em> — she visits, she clings, she gives. Boom, boom, boom. The lack of connectives (asyndeton) makes it feel breathless and frantic, like she can't stop herself. Each action tumbles into the next without pause, mirroring her reckless generosity. She's not just having an affair; she's emptying the imperial treasury into her lover's pockets.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The asyndetic sequence <em>ventitat... adhaeret... dat</em> creates a rapid, breathless accumulation of Messalina's actions. The absence of conjunctions mirrors her uninhibited behaviour, while the tricolon of verbs conveys escalating boldness."
            </div>
        </div>

        <div class="style-analysis" id="analysis-tricolon">
            <div class="style-analysis-title">Tricolon — servi, liberti, paratus</div>
            <div class="style-analysis-lines">Sentence 2</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> Three things — slaves, freedmen, furnishings — listed in a neat, devastating row. This is a tricolon (a three-part list), and it's doing serious work here. Each item represents a different layer of the imperial household: the enslaved workers, the freed administrators, even the <em>furniture</em>. Tacitus is basically saying the entire palace is being relocated to Silius's house, piece by piece. The progression from people to objects makes it feel comprehensive — she's moved <em>everything</em>. It's not a discreet affair; it's an imperial house move.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The tricolon <em>servi, liberti, paratus</em> catalogues the transfer of imperial resources with devastating precision. The progression from human (<em>servi, liberti</em>) to material (<em>paratus</em>) emphasises the comprehensive scale of Messalina's misappropriation of imperial property."
            </div>
        </div>

        <div class="style-analysis" id="analysis-ellipsis">
            <div class="style-analysis-title">Ellipsis — at Claudius matrimonii sui ignarus</div>
            <div class="style-analysis-lines">Sentence 3</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> Where's the verb? There isn't one. Tacitus has deliberately omitted <em>erat</em> ("was"), and the effect is devastating. After all those rolling sentences about Messalina's brazen behaviour — visiting, clinging, giving, imperial property being carted across Rome — we get this blunt fragment: "But Claudius — of his own marriage — unaware." Full stop. The missing verb makes Claudius seem almost non-existent. He's so irrelevant to his own marriage that he doesn't even get a complete sentence. It's Tacitean brevity at its most savage.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The ellipsis of <em>erat</em> in <em>at Claudius matrimonii sui ignarus</em> creates a stark, verbless sentence that contrasts sharply with the elaborate preceding description of Messalina's activity. The deliberate brevity suggests Claudius's irrelevance and passivity, reducing him to a parenthetical afterthought in his own marriage."
            </div>
        </div>

        <div class="style-analysis" id="analysis-irony">
            <div class="style-analysis-title">Irony — matrimonii sui ignarus</div>
            <div class="style-analysis-lines">Sentence 3</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> This is bitterly, exquisitely ironic. <em>Sui</em> — "his own." The most powerful man in the Roman world, commander of legions, ruler of an empire stretching from Britain to Syria, and he doesn't know what's happening in <em>his own marriage</em>. Everyone else can see it — the slaves, the freedmen, presumably half of Rome — but the emperor himself is clueless. Tacitus doesn't even comment on the irony; he just presents it. "Unaware of his own marriage." The words speak for themselves, and they're absolutely damning.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The phrase <em>matrimonii sui ignarus</em> is bitterly ironic: the genitive <em>sui</em> ('his own') emphasises that Claudius, despite being the most powerful man in Rome, is ignorant of what concerns him most intimately. The dramatic irony is heightened by the reader's awareness of the openly scandalous behaviour described in the preceding sentences."
            </div>
        </div>

        <div class="style-analysis" id="analysis-oxymoron">
            <div class="style-analysis-title">Oxymoron — fatali insania</div>
            <div class="style-analysis-lines">Sentence 5</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> "Fateful madness" — these two words shouldn't really go together, and that's the point. <em>Fatalis</em> suggests something ordained by fate, something predetermined and inevitable. <em>Insania</em> is irrationality, loss of reason, madness. So was Silius's behaviour calculated destiny or unhinged lunacy? Tacitus brilliantly refuses to choose. The oxymoron captures the impossible position Silius is in: his doom feels both fated and insane, both unavoidable and utterly reckless. It's the kind of phrase that makes you read it twice.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The oxymoron <em>fatali insania</em> juxtaposes divine predestination (<em>fatalis</em>) with irrational madness (<em>insania</em>), creating an unresolvable tension around Silius's motivation and suggesting that his actions were simultaneously destined and irrational."
            </div>
        </div>

        <div class="style-analysis" id="analysis-paradox">
            <div class="style-analysis-title">Paradox — pericula remedium periculorum</div>
            <div class="style-analysis-lines">Sentence 5</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> Dangers as a cure for dangers. Read that again. Silius's logic is: "We're already in mortal danger from this secret affair, so let's do something <em>even more dangerous</em> — that'll fix it!" It's the kind of reasoning you get from someone who's either a genius or completely desperate (probably the latter). The repetition of <em>pericula... periculorum</em> — the word "danger" echoing itself — creates a verbal maze that mirrors the circular, trapped logic. There's no way out except through more danger. It's like fighting fire with fire, except the fire is treason and the firefighter is also on fire.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The paradox <em>ipsa pericula remedium imminentium periculorum</em> employs polyptoton (<em>pericula... periculorum</em>) to create a chiastic, self-referencing formulation that encapsulates Silius's desperate circular reasoning: the only escape from danger is through greater danger."
            </div>
        </div>

        <div class="style-analysis" id="analysis-gerundive">
            <div class="style-analysis-title">Gerundive of Obligation — exspectandum</div>
            <div class="style-analysis-lines">Sentence 6</div>
            <div class="style-analysis-effect">
                <strong>What's happening:</strong> <em>Exspectandum</em> — "it must be waited" or rather, with <em>non</em>, "it must NOT be waited." This is the impersonal gerundive of obligation, one of Latin's most forceful constructions. It doesn't say "they shouldn't wait" (a suggestion) or "they might not want to wait" (a thought). It says waiting is <em>not to be done</em>. Period. It creates a sense of inevitability and urgency — as if the universe itself has decided that delay is not an option. Silius is wrapping his treasonous proposal in the language of necessity, making it sound like an obligation rather than a choice. Very persuasive. Very dangerous.
            </div>
            <div class="style-analysis-exam">
                <strong>In an exam:</strong> "The impersonal gerundive <em>non exspectandum</em> expresses obligation with an air of impersonal necessity. By framing the decision to act as an unavoidable requirement rather than a personal choice, Silius lends his treasonous argument the rhetorical force of inevitability."
            </div>
        </div>
    </div>

    <!-- Analysis Mode Overlay -->
    <div id="analysisOverlay" class="analysis-overlay">
        <!-- Toolbar -->
        <div class="analysis-toolbar">
            <div class="analysis-toolbar-section">
                <button class="analysis-btn back-btn" id="analysisBackBtn">Back</button>
                <button class="analysis-btn" id="analysisPrevBtn">&#9664;</button>
                <span class="analysis-nav-label" id="analysisNavLabel">Sentence 1 of 6</span>
                <button class="analysis-btn" id="analysisNextBtn">&#9654;</button>
            </div>
            <div class="analysis-toolbar-section">
                <button class="analysis-btn" id="analysisSaveBtn">Save</button>
                <span class="save-indicator" id="analysisSaveIndicator">Saved</span>
            </div>
        </div>

        <!-- Drawing tools -->
        <div class="analysis-tools-bar">
            <div class="tool-group">
                <button class="analysis-btn active" data-tool="pen" id="toolPen">Pen</button>
                <button class="analysis-btn" data-tool="eraser" id="toolEraser">Eraser</button>
                <button class="analysis-btn" data-tool="pointer" id="toolPointer">Pointer</button>
            </div>
            <span class="tool-divider"></span>
            <div class="tool-group">
                <span class="color-swatch active" data-color="#333333" style="background:#333333;" title="Black"></span>
                <span class="color-swatch" data-color="#e53935" style="background:#e53935;" title="Red"></span>
                <span class="color-swatch" data-color="#1e88e5" style="background:#1e88e5;" title="Blue"></span>
                <span class="color-swatch" data-color="#43a047" style="background:#43a047;" title="Green"></span>
                <span class="color-swatch" data-color="#fb8c00" style="background:#fb8c00;" title="Orange"></span>
            </div>
            <span class="tool-divider"></span>
            <div class="tool-group">
                <button class="size-btn" data-size="2" title="Fine">S</button>
                <button class="size-btn active" data-size="4" title="Medium">M</button>
                <button class="size-btn" data-size="8" title="Thick">L</button>
            </div>
            <span class="tool-divider"></span>
            <div class="tool-group">
                <button class="analysis-btn" id="undoBtn">Undo</button>
                <button class="analysis-btn" id="clearCanvasBtn">Clear</button>
            </div>
            <div class="analysis-key">
                <span class="analysis-key-item" style="background:#ffb3b3;">Subj</span>
                <span class="analysis-key-item" style="background:#b3ffcc;">Obj</span>
                <span class="analysis-key-item" style="background:#b3e6ff;">Verb</span>
                <span class="analysis-key-item" style="background:#ffd9b3;">Gen</span>
                <span class="analysis-key-item" style="background:#e6b3ff;">Dat</span>
                <span class="analysis-key-item" style="background:#ffffb3;">Abl</span>
                <span class="analysis-key-item" style="background:#ffb3e6;">Prep</span>
                <span class="analysis-key-item" style="background:#d9ffb3;">Conj</span>
                <span class="analysis-key-item" style="background:#ccb3ff;">Adv</span>
                <span class="analysis-key-item" style="background:#ffcbb3;">Gdv</span>
            </div>
        </div>

        <!-- Workspace -->
        <div class="analysis-workspace" id="analysisWorkspace">
            <div class="analysis-sentence-display" id="analysisSentenceDisplay">
                <div class="analysis-latin-line" id="analysisLatinLine"></div>
                <div class="analysis-english-line" id="analysisEnglishLine"></div>
            </div>
            <canvas id="analysisCanvas"></canvas>
        </div>

        <!-- Notes panel -->
        <div class="analysis-notes" id="analysisNotes">
            <div class="analysis-notes-toggle" id="analysisNotesToggle">
                <h4>Notes</h4>
                <span class="toggle-arrow">&#9650;</span>
            </div>
            <div class="analysis-notes-body">
                <textarea id="analysisNotesText" placeholder="Type your analysis notes here..."></textarea>
            </div>
        </div>
    </div>


    <script>
        let currentStep = 0;
        let coloursHidden = false;
        const activeCategories = new Set();

        const wordOrders = [];
        document.querySelectorAll('.latin-column .word-group').forEach(group => {
            if (group.dataset.order) {
                wordOrders.push(group.dataset.order);
            }
        });
        wordOrders.sort((a, b) => {
            const [lineA, numA] = a.split('-');
            const [lineB, numB] = b.split('-');
            if (lineA !== lineB) return parseInt(lineA) - parseInt(lineB);
            return parseInt(numA) - parseInt(numB);
        });

        function revealWord(order) {
            const latinGroup = document.querySelector(`.latin-column .word-group[data-order="${order}"]`);
            if (latinGroup) {
                latinGroup.classList.add('revealed');
            }

            document.querySelectorAll(`.english-word`).forEach(word => {
                if (word.dataset.order) {
                    const orders = word.dataset.order.split(',');
                    if (orders.includes(order)) {
                        word.classList.add('revealed');
                    }
                }
            });
        }

        function hideWord(order) {
            const latinGroup = document.querySelector(`.latin-column .word-group[data-order="${order}"]`);
            if (latinGroup) {
                latinGroup.classList.remove('revealed');
            }

            document.querySelectorAll(`.english-word`).forEach(word => {
                if (word.dataset.order) {
                    const orders = word.dataset.order.split(',');
                    if (orders.includes(order)) {
                        word.classList.remove('revealed');
                    }
                }
            });
        }

        function toggleWord(order) {
            const latinGroup = document.querySelector(`.latin-column .word-group[data-order="${order}"]`);
            if (latinGroup && latinGroup.classList.contains('revealed')) {
                hideWord(order);
            } else {
                revealWord(order);
            }
        }

        function stepForward() {
            if (currentStep < wordOrders.length) {
                revealWord(wordOrders[currentStep]);
                currentStep++;
            }
        }

        function stepBackward() {
            if (currentStep > 0) {
                currentStep--;
                hideWord(wordOrders[currentStep]);
            }
        }

        function toggleCategory(category) {
            const keyItem = document.querySelector(`.key-item[data-category="${category}"]`);

            if (activeCategories.has(category)) {
                activeCategories.delete(category);
                keyItem.classList.remove('active');

                document.querySelectorAll(`.latin-column .word-group.${category}`).forEach(group => {
                    group.classList.remove('highlighted');
                });

                document.querySelectorAll(`.english-word.${category}`).forEach(word => {
                    word.classList.remove('highlighted');
                });
            } else {
                activeCategories.add(category);
                keyItem.classList.add('active');

                document.querySelectorAll(`.latin-column .word-group.${category}`).forEach(group => {
                    group.classList.add('highlighted');
                });

                document.querySelectorAll(`.english-word.${category}`).forEach(word => {
                    word.classList.add('highlighted');
                });
            }
        }

        document.getElementById('showAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.latin-column .word-group').forEach(group => {
                if (group.dataset.order) {
                    revealWord(group.dataset.order);
                }
            });
            currentStep = wordOrders.length;
        });

        document.getElementById('hideAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.revealed').forEach(el => {
                el.classList.remove('revealed');
            });
            document.querySelectorAll('.english-word').forEach(el => {
                el.classList.remove('revealed');
            });
            document.querySelectorAll('.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            document.querySelectorAll('.key-item').forEach(el => {
                el.classList.remove('active');
            });
            activeCategories.clear();
            currentStep = 0;
        });

        document.getElementById('toggleColoursBtn').addEventListener('click', () => {
            coloursHidden = !coloursHidden;
            document.body.classList.toggle('hide-colours', coloursHidden);
            document.getElementById('toggleColoursBtn').textContent =
                coloursHidden ? 'Show Colours' : 'Hide Colours';
        });

        document.querySelectorAll('.key-item').forEach(item => {
            item.addEventListener('click', () => {
                toggleCategory(item.dataset.category);
            });
        });

        document.querySelectorAll('.latin-column .word-group').forEach(group => {
            group.addEventListener('click', () => {
                if (group.dataset.order) {
                    toggleWord(group.dataset.order);
                }
            });
        });

        document.querySelectorAll('.english-word').forEach(word => {
            word.addEventListener('click', () => {
                if (word.dataset.order) {
                    const order = word.dataset.order.split(',')[0];
                    toggleWord(order);
                }
            });
        });

        document.querySelectorAll('.english-column .line-number').forEach(lineNum => {
            lineNum.style.cursor = 'pointer';
            lineNum.addEventListener('click', () => {
                const lineRow = lineNum.closest('.line-row');
                const lineOrders = [];
                lineRow.querySelectorAll('.english-word').forEach(word => {
                    if (word.dataset.order) {
                        word.dataset.order.split(',').forEach(order => {
                            if (!lineOrders.includes(order)) {
                                lineOrders.push(order);
                            }
                        });
                    }
                });

                const firstWord = lineRow.querySelector('.english-word');
                const isRevealed = firstWord && firstWord.classList.contains('revealed');

                lineOrders.forEach(order => {
                    if (isRevealed) {
                        hideWord(order);
                    } else {
                        revealWord(order);
                    }
                });
            });
        });

        document.getElementById('toggleStyleBtn').addEventListener('click', () => {
            document.body.classList.toggle('style-mode');
            const isStyleMode = document.body.classList.contains('style-mode');
            document.getElementById('toggleStyleBtn').textContent =
                isStyleMode ? 'Hide Style' : 'Style Notes';

            if (!isStyleMode) {
                document.querySelectorAll('.style-tag.active').forEach(tag => {
                    tag.classList.remove('active');
                });
                document.querySelectorAll('.style-analysis.active').forEach(analysis => {
                    analysis.classList.remove('active');
                });
                document.querySelectorAll('.active-style').forEach(el => {
                    el.classList.remove('active-style');
                });
            }
        });

        document.querySelectorAll('.style-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const featureId = tag.dataset.feature;
                const isActive = tag.classList.contains('active');

                document.querySelectorAll('.style-tag.active').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.style-analysis.active').forEach(a => a.classList.remove('active'));
                document.querySelectorAll('.active-style').forEach(el => el.classList.remove('active-style'));

                if (!isActive) {
                    tag.classList.add('active');

                    const analysis = document.getElementById('analysis-' + featureId);
                    if (analysis) {
                        analysis.classList.add('active');
                    }

                    document.querySelectorAll('[data-style-feature]').forEach(el => {
                        const features = el.dataset.styleFeature.split(' ');
                        if (features.includes(featureId)) {
                            el.classList.add('active-style');
                        }
                    });
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (window.isAnalysisActive && window.isAnalysisActive()) return;
            if (e.code === 'ArrowRight' || e.code === 'ArrowDown' || e.code === 'PageDown' || e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                stepForward();
            }
            else if (e.code === 'ArrowLeft' || e.code === 'ArrowUp' || e.code === 'PageUp' || e.code === 'Backspace') {
                e.preventDefault();
                stepBackward();
            }
            else if (e.code === 'Escape' || e.code === 'KeyR') {
                document.getElementById('hideAllBtn').click();
            }
        });
        // ===== ANALYSIS MODE =====
        (function() {
            const overlay = document.getElementById('analysisOverlay');
            const canvas = document.getElementById('analysisCanvas');
            const ctx = canvas.getContext('2d');
            const workspace = document.getElementById('analysisWorkspace');

            let analysisActive = false;
            let currentSentenceIdx = 0;
            let drawTool = 'pen';
            let drawColor = '#333333';
            let drawSize = 4;
            let isDrawing = false;
            let lastX = 0, lastY = 0;
            let undoStack = [];
            const MAX_UNDO = 30;

            const sentences = [
                { lines: ['1'], title: 'Sentence 1' },
                { lines: ['2'], title: 'Sentence 2' },
                { lines: ['3'], title: 'Sentence 3' },
                { lines: ['4'], title: 'Sentence 4' },
                { lines: ['5'], title: 'Sentence 5' },
                { lines: ['6'], title: 'Sentence 6' }
            ];

            // === Canvas setup ===
            function resizeCanvas(preserveContent) {
                const rect = workspace.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                let savedData = null;
                if (preserveContent && canvas.width > 0 && canvas.height > 0) {
                    savedData = canvas.toDataURL();
                }
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                if (savedData) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0, rect.width, rect.height);
                    img.src = savedData;
                }
            }

            // === Drawing ===
            function getCoords(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            }

            function saveUndoState() {
                undoStack.push(canvas.toDataURL());
                if (undoStack.length > MAX_UNDO) undoStack.shift();
            }

            function startDraw(e) {
                if (drawTool === 'pointer') return;
                e.preventDefault();
                isDrawing = true;
                saveUndoState();
                const { x, y } = getCoords(e);
                lastX = x; lastY = y;
                ctx.beginPath();
                ctx.arc(x, y, drawSize / 2, 0, Math.PI * 2);
                ctx.globalCompositeOperation = drawTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.fillStyle = drawTool === 'eraser' ? 'rgba(0,0,0,1)' : drawColor;
                ctx.fill();
            }

            function doDraw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getCoords(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.lineWidth = drawSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalCompositeOperation = drawTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.strokeStyle = drawTool === 'eraser' ? 'rgba(0,0,0,1)' : drawColor;
                ctx.stroke();
                lastX = x; lastY = y;
            }

            function stopDraw() {
                isDrawing = false;
            }

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', doDraw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseleave', stopDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', doDraw, { passive: false });
            canvas.addEventListener('touchend', stopDraw);

            // === Undo ===
            function undo() {
                if (undoStack.length === 0) return;
                const prev = undoStack.pop();
                const img = new Image();
                img.onload = () => {
                    const rect = workspace.getBoundingClientRect();
                    ctx.clearRect(0, 0, rect.width, rect.height);
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.drawImage(img, 0, 0, rect.width, rect.height);
                };
                img.src = prev;
            }

            document.getElementById('undoBtn').addEventListener('click', undo);

            document.getElementById('clearCanvasBtn').addEventListener('click', () => {
                saveUndoState();
                const rect = workspace.getBoundingClientRect();
                ctx.clearRect(0, 0, rect.width, rect.height);
            });

            // === Tools ===
            document.querySelectorAll('[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    drawTool = btn.dataset.tool;
                    canvas.className = drawTool === 'pointer' ? 'pointer-mode' :
                                       drawTool === 'eraser' ? 'eraser-mode' : '';
                });
            });

            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    drawColor = swatch.dataset.color;
                    if (drawTool !== 'pen') {
                        document.querySelector('[data-tool="pen"]').click();
                    }
                });
            });

            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    drawSize = parseInt(btn.dataset.size);
                });
            });

            // === Save / Load ===
            function getStorageKey(idx) {
                return 'messalina-s2-analysis-' + idx;
            }

            function saveAnalysis() {
                const rect = workspace.getBoundingClientRect();
                const data = {
                    canvas: canvas.toDataURL(),
                    notes: document.getElementById('analysisNotesText').value
                };
                localStorage.setItem(getStorageKey(currentSentenceIdx), JSON.stringify(data));
                const indicator = document.getElementById('analysisSaveIndicator');
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 1500);
            }

            function loadAnalysis(idx) {
                const raw = localStorage.getItem(getStorageKey(idx));
                const rect = workspace.getBoundingClientRect();
                ctx.clearRect(0, 0, rect.width, rect.height);
                ctx.globalCompositeOperation = 'source-over';
                document.getElementById('analysisNotesText').value = '';
                undoStack = [];

                if (raw) {
                    try {
                        const data = JSON.parse(raw);
                        if (data.canvas) {
                            const img = new Image();
                            img.onload = () => {
                                ctx.globalCompositeOperation = 'source-over';
                                ctx.drawImage(img, 0, 0, rect.width, rect.height);
                            };
                            img.src = data.canvas;
                        }
                        if (data.notes) {
                            document.getElementById('analysisNotesText').value = data.notes;
                        }
                    } catch(e) {}
                }
            }

            document.getElementById('analysisSaveBtn').addEventListener('click', saveAnalysis);

            // === Sentence display ===
            function showSentence(idx) {
                if (analysisActive && currentSentenceIdx !== idx) {
                    saveAnalysis();
                }

                currentSentenceIdx = idx;
                const def = sentences[idx];

                document.getElementById('analysisNavLabel').textContent =
                    def.title + ' (' + (idx + 1) + ' of ' + sentences.length + ')';

                // Build Latin
                const latinEl = document.getElementById('analysisLatinLine');
                latinEl.innerHTML = '';
                def.lines.forEach(line => {
                    const row = document.querySelector('.latin-column .line-row[data-line="' + line + '"]');
                    if (row) {
                        row.querySelectorAll('.word-group').forEach(wg => {
                            const clone = wg.cloneNode(true);
                            clone.style.cursor = 'default';
                            latinEl.appendChild(clone);
                        });
                    }
                });

                // Build English
                const engEl = document.getElementById('analysisEnglishLine');
                engEl.innerHTML = '';
                def.lines.forEach(line => {
                    const row = document.querySelector('.english-column .line-row[data-line="' + line + '"]');
                    if (row) {
                        row.querySelectorAll('.word-group').forEach(wg => {
                            const clone = wg.cloneNode(true);
                            clone.querySelectorAll('.english-word').forEach(ew => ew.classList.add('revealed'));
                            clone.style.cursor = 'default';
                            engEl.appendChild(clone);
                        });
                    }
                });

                requestAnimationFrame(() => loadAnalysis(idx));
            }

            // Nav
            document.getElementById('analysisPrevBtn').addEventListener('click', () => {
                if (currentSentenceIdx > 0) showSentence(currentSentenceIdx - 1);
            });

            document.getElementById('analysisNextBtn').addEventListener('click', () => {
                if (currentSentenceIdx < sentences.length - 1) showSentence(currentSentenceIdx + 1);
            });

            // === Enter / Exit ===
            function enterAnalysis() {
                analysisActive = true;
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                requestAnimationFrame(() => {
                    resizeCanvas(false);
                    showSentence(0);
                });
            }

            function exitAnalysis() {
                saveAnalysis();
                analysisActive = false;
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            document.getElementById('analyseBtn').addEventListener('click', enterAnalysis);
            document.getElementById('analysisBackBtn').addEventListener('click', exitAnalysis);

            // Notes toggle
            document.getElementById('analysisNotesToggle').addEventListener('click', () => {
                document.getElementById('analysisNotes').classList.toggle('open');
                requestAnimationFrame(() => resizeCanvas(true));
            });

            // Window resize
            window.addEventListener('resize', () => {
                if (analysisActive) resizeCanvas(true);
            });

            // Analysis keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (!analysisActive) return;
                if (document.activeElement && document.activeElement.tagName === 'TEXTAREA') {
                    if (e.code === 'Escape') {
                        document.activeElement.blur();
                        e.preventDefault();
                    }
                    return;
                }
                if (e.code === 'Escape') {
                    e.preventDefault();
                    exitAnalysis();
                } else if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    if (currentSentenceIdx > 0) showSentence(currentSentenceIdx - 1);
                } else if (e.code === 'ArrowRight') {
                    e.preventDefault();
                    if (currentSentenceIdx < sentences.length - 1) showSentence(currentSentenceIdx + 1);
                } else if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ') {
                    e.preventDefault();
                    undo();
                } else if (e.code === 'KeyS' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    saveAnalysis();
                }
            });

            window.isAnalysisActive = () => analysisActive;
        })();
    </script>
</body>
</html>
