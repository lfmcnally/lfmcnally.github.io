<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.6</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Three-tier style highlighting */
        .style-mode .word.style-tier1 {
            background: rgba(147, 51, 234, 0.25);
            border-bottom: 2px solid #9333ea;
        }
        .style-mode .word.style-tier2 {
            background: rgba(245, 158, 11, 0.25);
            border-bottom: 2px solid #f59e0b;
        }
        .style-mode .word.style-tier3 {
            background: rgba(20, 184, 166, 0.25);
            border-bottom: 2px solid #14b8a6;
        }
        .style-mode .word.style-tier1:hover {
            background: rgba(147, 51, 234, 0.4);
        }
        .style-mode .word.style-tier2:hover {
            background: rgba(245, 158, 11, 0.4);
        }
        .style-mode .word.style-tier3:hover {
            background: rgba(20, 184, 166, 0.4);
        }
        body.dark-mode .style-mode .word.style-tier1 {
            background: rgba(167, 139, 250, 0.35);
            border-bottom-color: #a78bfa;
        }
        body.dark-mode .style-mode .word.style-tier2 {
            background: rgba(251, 191, 36, 0.35);
            border-bottom-color: #fbbf24;
        }
        body.dark-mode .style-mode .word.style-tier3 {
            background: rgba(45, 212, 191, 0.35);
            border-bottom-color: #2dd4bf;
        }

        /* Style popup */
        .style-popup {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1.25rem 1.5rem;
            z-index: 1001;
            max-width: 400px;
            min-width: 300px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .style-popup.visible {
            display: block;
        }
        .style-popup .style-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .style-popup .style-tier-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            letter-spacing: 0.05em;
        }
        .style-popup .style-tier-badge.tier1 {
            background: rgba(147, 51, 234, 0.15);
            color: #7c3aed;
        }
        .style-popup .style-tier-badge.tier2 {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }
        .style-popup .style-tier-badge.tier3 {
            background: rgba(20, 184, 166, 0.15);
            color: #0d9488;
        }
        .style-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .style-popup .style-latin {
            font-size: 1rem;
            font-style: italic;
            color: #6b7280;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .style-popup .style-description {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.6;
        }
        .style-popup .style-effect {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }
        .style-popup .style-effect strong {
            color: #4b5563;
        }
        body.dark-mode .style-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .style-popup h4 {
            color: #c5d2f8;
        }
        body.dark-mode .style-popup .style-latin {
            color: #b8a8b8;
            border-bottom-color: #5a1a3a;
        }
        body.dark-mode .style-popup .style-description {
            color: #c5d2f8;
        }
        body.dark-mode .style-popup .style-effect {
            color: #a8b8d8;
            border-top-color: #5a1a3a;
        }
        body.dark-mode .style-popup .style-tier-badge.tier1 {
            background: rgba(167, 139, 250, 0.25);
            color: #c4b5fd;
        }
        body.dark-mode .style-popup .style-tier-badge.tier2 {
            background: rgba(251, 191, 36, 0.25);
            color: #fcd34d;
        }
        body.dark-mode .style-popup .style-tier-badge.tier3 {
            background: rgba(45, 212, 191, 0.25);
            color: #5eead4;
        }

        /* Style legend */
        .style-legend {
            display: none;
            background: #f9fafb;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        .style-legend.visible {
            display: block;
        }
        .style-legend h5 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        .style-legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .style-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #4b5563;
        }
        .style-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .style-legend-color.tier1 {
            background: rgba(147, 51, 234, 0.4);
            border: 2px solid #9333ea;
        }
        .style-legend-color.tier2 {
            background: rgba(245, 158, 11, 0.4);
            border: 2px solid #f59e0b;
        }
        .style-legend-color.tier3 {
            background: rgba(20, 184, 166, 0.4);
            border: 2px solid #14b8a6;
        }
        body.dark-mode .style-legend {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .style-legend h5 {
            color: #c5d2f8;
        }
        body.dark-mode .style-legend-item {
            color: #b8a8b8;
        }
        body.dark-mode .style-legend-color.tier1 {
            background: rgba(167, 139, 250, 0.4);
            border-color: #a78bfa;
        }
        body.dark-mode .style-legend-color.tier2 {
            background: rgba(251, 191, 36, 0.4);
            border-color: #fbbf24;
        }
        body.dark-mode .style-legend-color.tier3 {
            background: rgba(45, 212, 191, 0.4);
            border-color: #2dd4bf;
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .style-legend {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">Agrippina's Response</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.6</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleStyleMode()">Style</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="style-legend" id="styleLegend">
                            <h5>Literary Device Categories</h5>
                            <div class="style-legend-items">
                                <div class="style-legend-item">
                                    <div class="style-legend-color tier1"></div>
                                    <span>Sound & Rhythm</span>
                                </div>
                                <div class="style-legend-item">
                                    <div class="style-legend-color tier2"></div>
                                    <span>Word Choice & Meaning</span>
                                </div>
                                <div class="style-legend-item">
                                    <div class="style-legend-color tier3"></div>
                                    <span>Structure & Syntax</span>
                                </div>
                            </div>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 7</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>There, reflecting that she had been summoned for that reason by a deceptive letter and held in particular honour, and that the ship near the shore had not been driven by the winds, not dashed onto rocks, but had collapsed in its upper part like a land-based contrivance; noting also the murder of Acerronia, at the same time looking at her own wound, she realised that the only remedy against treachery was if it was not recognised; and she sent her freedman Agerinus to announce to her son that she had escaped a serious disaster through the kindness of the gods and his good fortune; she begged him to postpone the duty of visiting, however much he was frightened by his mother's danger; for the present, she needed rest. And meanwhile, feigning unconcern, she applied medicines to the wound and poultices to the body; she ordered Acerronia's will to be sought and her property to be sealed up; this alone was not done through pretence.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="style-popup" id="stylePopup"></div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>

    <script>
const vocab = {
    "illic": { lemma: "illic", parsing: "adverb", meaning: "there, in that place" },
    "reputans": { lemma: "reputo, -are, -avi, -atum", parsing: "pres. act. part. nom. sing.", meaning: "reflecting, considering" },
    "ideo": { lemma: "ideo", parsing: "adverb", meaning: "for that reason, therefore" },
    "se": { lemma: "sui, sibi, se", parsing: "acc. reflexive", meaning: "herself" },
    "fallacibus": { lemma: "fallax, fallacis", parsing: "abl. pl.", meaning: "deceptive, treacherous" },
    "litteris": { lemma: "littera, -ae (f.)", parsing: "abl. pl.", meaning: "by letter(s)" },
    "accitam": { lemma: "accio, -ire, -ivi, -itum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "summoned, sent for" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and" },
    "honore": { lemma: "honor, -oris (m.)", parsing: "abl. sing.", meaning: "with honour" },
    "praecipuo": { lemma: "praecipuus, -a, -um", parsing: "abl. sing. masc./neut.", meaning: "special, particular" },
    "habitam": { lemma: "habeo, -ere, habui, habitum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "held, treated" },
    "quodque": { lemma: "quod + -que", parsing: "conjunction", meaning: "and that, and because" },
    "litus": { lemma: "litus, litoris (n.)", parsing: "acc. sing.", meaning: "shore, coast" },
    "iuxta": { lemma: "iuxta", parsing: "adverb/preposition", meaning: "near, close to" },
    "non": { lemma: "non", parsing: "adverb", meaning: "not" },
    "ventis": { lemma: "ventus, -i (m.)", parsing: "abl. pl.", meaning: "by winds" },
    "acta": { lemma: "ago, agere, egi, actum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "driven" },
    "saxis": { lemma: "saxum, -i (n.)", parsing: "abl. pl.", meaning: "onto rocks" },
    "impulsa": { lemma: "impello, -ere, impuli, impulsum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "dashed, driven against" },
    "navis": { lemma: "navis, -is (f.)", parsing: "nom. sing.", meaning: "ship" },
    "summa": { lemma: "summus, -a, -um", parsing: "abl. fem. sing.", meaning: "highest, upper" },
    "sui": { lemma: "sui, sibi, se", parsing: "gen. reflexive", meaning: "of itself" },
    "parte": { lemma: "pars, partis (f.)", parsing: "abl. sing.", meaning: "in part" },
    "veluti": { lemma: "veluti / velut", parsing: "adverb", meaning: "just as, like" },
    "terrestre": { lemma: "terrestris, -e", parsing: "nom./acc. neut. sing.", meaning: "land-based, terrestrial" },
    "machinamentum": { lemma: "machinamentum, -i (n.)", parsing: "nom./acc. sing.", meaning: "contrivance, mechanism, device" },
    "concidisset": { lemma: "concido, -ere, concidi", parsing: "pluperf. subj. act. 3rd sing.", meaning: "had collapsed, had fallen" },
    "observans": { lemma: "observo, -are, -avi, -atum", parsing: "pres. act. part. nom. sing.", meaning: "observing, noting" },
    "etiam": { lemma: "etiam", parsing: "adverb", meaning: "also, even" },
    "Acerroniae": { lemma: "Acerronia, -ae (f.)", parsing: "gen. sing.", meaning: "of Acerronia" },
    "necem": { lemma: "nex, necis (f.)", parsing: "acc. sing.", meaning: "murder, violent death" },
    "simul": { lemma: "simul", parsing: "adverb", meaning: "at the same time" },
    "suum": { lemma: "suus, -a, -um", parsing: "acc. neut. sing.", meaning: "her own" },
    "vulnus": { lemma: "vulnus, vulneris (n.)", parsing: "acc. sing.", meaning: "wound" },
    "aspiciens": { lemma: "aspicio, -ere, aspexi, aspectum", parsing: "pres. act. part. nom. sing.", meaning: "looking at, observing" },
    "solum": { lemma: "solus, -a, -um", parsing: "acc. neut. sing.", meaning: "only, sole" },
    "insidiarum": { lemma: "insidiae, -arum (f. pl.)", parsing: "gen. pl.", meaning: "of treachery, of plots" },
    "remedium": { lemma: "remedium, -i (n.)", parsing: "acc. sing.", meaning: "remedy, cure" },
    "esse": { lemma: "sum, esse, fui", parsing: "pres. inf.", meaning: "to be" },
    "si": { lemma: "si", parsing: "conjunction", meaning: "if" },
    "intellegerentur": { lemma: "intellego, -ere, intellexi, intellectum", parsing: "imperf. subj. pass. 3rd pl.", meaning: "were understood, were recognised" },
    "misitque": { lemma: "mitto, -ere, misi, missum + -que", parsing: "perf. act. ind. 3rd sing. + and", meaning: "and sent" },
    "libertum": { lemma: "libertus, -i (m.)", parsing: "acc. sing.", meaning: "freedman" },
    "Agerinum": { lemma: "Agerinus, -i (m.)", parsing: "acc. sing.", meaning: "Agerinus (proper name)" },
    "qui": { lemma: "qui, quae, quod", parsing: "rel. pron. nom. masc. sing.", meaning: "who" },
    "nuntiaret": { lemma: "nuntio, -are, -avi, -atum", parsing: "imperf. subj. act. 3rd sing.", meaning: "should announce, might report" },
    "filio": { lemma: "filius, -i (m.)", parsing: "dat. sing.", meaning: "to her son" },
    "benignitate": { lemma: "benignitas, -atis (f.)", parsing: "abl. sing.", meaning: "by kindness, by favour" },
    "deum": { lemma: "deus, -i (m.)", parsing: "gen. pl.", meaning: "of the gods" },
    "fortuna": { lemma: "fortuna, -ae (f.)", parsing: "abl. sing.", meaning: "by fortune, by luck" },
    "eius": { lemma: "is, ea, id", parsing: "gen. sing.", meaning: "his" },
    "evasisse": { lemma: "evado, -ere, evasi, evasum", parsing: "perf. inf. act.", meaning: "to have escaped" },
    "gravem": { lemma: "gravis, -e", parsing: "acc. sing.", meaning: "serious, grave" },
    "casum": { lemma: "casus, -us (m.)", parsing: "acc. sing.", meaning: "disaster, accident, misfortune" },
    "orare": { lemma: "oro, -are, -avi, -atum", parsing: "pres. inf. act.", meaning: "to beg, to entreat" },
    "ut": { lemma: "ut", parsing: "conjunction", meaning: "that, so that" },
    "quamvis": { lemma: "quamvis", parsing: "conjunction", meaning: "although, however much" },
    "periculo": { lemma: "periculum, -i (n.)", parsing: "abl. sing.", meaning: "by danger" },
    "matris": { lemma: "mater, matris (f.)", parsing: "gen. sing.", meaning: "of his mother" },
    "exterritus": { lemma: "exterreo, -ere, -ui, -itum", parsing: "perf. pass. part. nom. masc. sing.", meaning: "frightened, terrified" },
    "visendi": { lemma: "viso, -ere, visi, visum", parsing: "gerund gen.", meaning: "of visiting" },
    "curam": { lemma: "cura, -ae (f.)", parsing: "acc. sing.", meaning: "care, duty, concern" },
    "differret": { lemma: "differo, differre, distuli, dilatum", parsing: "imperf. subj. act. 3rd sing.", meaning: "should postpone, might defer" },
    "sibi": { lemma: "sui, sibi, se", parsing: "dat. reflexive", meaning: "for herself" },
    "ad": { lemma: "ad", parsing: "preposition + acc.", meaning: "for, to, towards" },
    "praesens": { lemma: "praesens, praesentis", parsing: "acc. neut. sing.", meaning: "the present" },
    "quiete": { lemma: "quies, quietis (f.)", parsing: "abl. sing.", meaning: "of rest, of quiet" },
    "opus": { lemma: "opus, operis (n.)", parsing: "nom. sing.", meaning: "need (with abl.)" },
    "atque": { lemma: "atque", parsing: "conjunction", meaning: "and, and also" },
    "interim": { lemma: "interim", parsing: "adverb", meaning: "meanwhile, in the meantime" },
    "securitate": { lemma: "securitas, -atis (f.)", parsing: "abl. sing.", meaning: "unconcern, freedom from care" },
    "simulata": { lemma: "simulo, -are, -avi, -atum", parsing: "perf. pass. part. abl. fem. sing.", meaning: "feigned, pretended" },
    "medicamina": { lemma: "medicamen, -inis (n.)", parsing: "acc. pl.", meaning: "medicines, remedies" },
    "vulneri": { lemma: "vulnus, vulneris (n.)", parsing: "dat. sing.", meaning: "to the wound" },
    "fomenta": { lemma: "fomentum, -i (n.)", parsing: "acc. pl.", meaning: "poultices, warm applications" },
    "corpori": { lemma: "corpus, corporis (n.)", parsing: "dat. sing.", meaning: "to the body" },
    "adhibet": { lemma: "adhibeo, -ere, -ui, -itum", parsing: "pres. act. ind. 3rd sing.", meaning: "applies, employs" },
    "testamentum": { lemma: "testamentum, -i (n.)", parsing: "acc. sing.", meaning: "will, testament" },
    "requiri": { lemma: "requiro, -ere, requisivi, requisitum", parsing: "pres. pass. inf.", meaning: "to be sought, to be searched for" },
    "bonaque": { lemma: "bona, -orum (n. pl.) + -que", parsing: "acc. pl. + and", meaning: "and property, and goods" },
    "obsignari": { lemma: "obsigno, -are, -avi, -atum", parsing: "pres. pass. inf.", meaning: "to be sealed up" },
    "iubet": { lemma: "iubeo, -ere, iussi, iussum", parsing: "pres. act. ind. 3rd sing.", meaning: "orders, commands" },
    "id": { lemma: "is, ea, id", parsing: "nom./acc. neut. sing.", meaning: "this, that" },
    "tantum": { lemma: "tantum", parsing: "adverb", meaning: "only" },
    "per": { lemma: "per", parsing: "preposition + acc.", meaning: "through, by means of" },
    "simulationem": { lemma: "simulatio, -onis (f.)", parsing: "acc. sing.", meaning: "pretence, feigning" }
};

const latinSentences = [
    "illic reputans ideo se fallacibus litteris accitam et honore praecipuo habitam,",
    "quodque litus iuxta non ventis acta, non saxis impulsa navis summa sui parte veluti terrestre machinamentum concidisset;",
    "observans etiam Acerroniae necem, simul suum vulnus aspiciens, solum insidiarum remedium esse, si non intellegerentur;",
    "misitque libertum Agerinum qui nuntiaret filio benignitate deum et fortuna eius evasisse gravem casum;",
    "orare ut quamvis periculo matris exterritus visendi curam differret; sibi ad praesens quiete opus.",
    "atque interim securitate simulata medicamina vulneri et fomenta corpori adhibet;",
    "testamentum Acerroniae requiri bonaque obsignari iubet, id tantum non per simulationem."
];

// Style data: maps words to their literary devices
// Tier 1: Sound & Rhythm (purple)
// Tier 2: Word Choice & Meaning (amber)
// Tier 3: Structure & Syntax (teal)
const styleData = {
    // Tricolon of participles - methodical thinking
    "reputans": {
        tier: 3,
        device: "Asyndetic Tricolon of Participles",
        latin: "reputans... observans... aspiciens",
        description: "Tacitus uses three present participles in rapid succession without connecting conjunctions (asyndeton). This accumulation portrays Agrippina's mind working systematically through the evidence, each participle representing a stage of her analytical process.",
        effect: "Creates urgency and shows Agrippina's rapid, methodical assessment of the situation."
    },
    "observans": {
        tier: 3,
        device: "Asyndetic Tricolon of Participles",
        latin: "reputans... observans... aspiciens",
        description: "The second participle in the tricolon shifts from internal reflection (reputans) to external observation (observans), showing how Agrippina moves from processing the past to examining present evidence.",
        effect: "Demonstrates the progression of her logical analysis from abstract to concrete."
    },
    "aspiciens": {
        tier: 3,
        device: "Asyndetic Tricolon of Participles",
        latin: "reputans... observans... aspiciens",
        description: "The final participle focuses on the most personal evidence: her own wound. The climactic placement emphasises the physical proof of attempted murder.",
        effect: "Brings the analytical sequence to its most visceral conclusion."
    },
    // Anaphora with negation
    "ventis": {
        tier: 3,
        device: "Anaphoric Negation",
        latin: "non ventis acta, non saxis impulsa",
        description: "The repetition of 'non' at the start of parallel phrases creates anaphora. Agrippina methodically eliminates natural explanations for the shipwreck, each negation ruling out innocent causes.",
        effect: "Emphasises the deliberate exclusion of accident, building towards the conclusion of murder."
    },
    "saxis": {
        tier: 3,
        device: "Anaphoric Negation",
        latin: "non ventis acta, non saxis impulsa",
        description: "The second element of the anaphoric pair. The parallel structure (ablative + perfect passive participle) reinforces the systematic logic of her reasoning.",
        effect: "The symmetry mirrors the clarity of her analytical thinking."
    },
    // Simile
    "veluti": {
        tier: 2,
        device: "Technical Simile",
        latin: "veluti terrestre machinamentum",
        description: "Agrippina compares the collapsing ship to a 'land-based contrivance' (terrestre machinamentum). This technical language suggests she recognises the ship was engineered to fail, like a stage mechanism or siege device.",
        effect: "Reveals her sophisticated understanding of the plot's mechanics and her refusal to be deceived."
    },
    "terrestre": {
        tier: 2,
        device: "Technical Simile",
        latin: "veluti terrestre machinamentum",
        description: "The adjective 'terrestre' is key: ships should not behave like land-based machines. The incongruity exposes the artificiality of the 'accident.'",
        effect: "Highlights the unnaturalness of the ship's collapse, pointing to deliberate sabotage."
    },
    // Litotes
    "intellegerentur": {
        tier: 2,
        device: "Litotes",
        latin: "si non intellegerentur",
        description: "Litotes: 'if they were not recognised' instead of 'if they were concealed.' The double negative (solum... si non) creates understatement that actually emphasises the desperate nature of her strategy.",
        effect: "Understatement that paradoxically intensifies the stakes of her gamble."
    },
    // Irony
    "benignitate": {
        tier: 2,
        device: "Dramatic Irony",
        latin: "benignitate deum et fortuna eius",
        description: "Agrippina thanks the gods' kindness and Nero's 'fortune' for her survival. The message operates on two levels: ostensibly grateful, but Nero will understand that his 'fortune' nearly murdered her.",
        effect: "Creates bitter irony; what appears as thanks is actually an accusation disguised as praise."
    },
    "fortuna": {
        tier: 2,
        device: "Dramatic Irony",
        latin: "benignitate deum et fortuna eius",
        description: "The word 'fortuna' carries double meaning: Nero's good luck, or perhaps the fortune he will inherit if she dies. Agrippina's message is a masterpiece of plausible deniability.",
        effect: "Allows Agrippina to communicate her knowledge while maintaining the pretence of ignorance."
    },
    // Chiasmus
    "medicamina": {
        tier: 3,
        device: "Chiasmus",
        latin: "medicamina vulneri et fomenta corpori",
        description: "ABBA word order: direct object (medicamina) - dative (vulneri) - conjunction - direct object (fomenta) - dative (corpori). This balanced structure reflects the calm, methodical pretence of normality.",
        effect: "The rhetorical balance mirrors Agrippina's controlled performance of unconcern."
    },
    "fomenta": {
        tier: 3,
        device: "Chiasmus",
        latin: "medicamina vulneri et fomenta corpori",
        description: "The second half of the chiastic structure. Both nouns (medicamina, fomenta) refer to medical treatments, paired with their recipients in inverted order.",
        effect: "Creates a sense of orderly routine that contrasts with the extraordinary circumstances."
    },
    // Key thematic word: simulata/simulationem
    "simulata": {
        tier: 2,
        device: "Thematic Repetition",
        latin: "securitate simulata... non per simulationem",
        description: "The root simul- appears twice: first as 'feigned unconcern' (simulata), then negated in 'not through pretence' (non per simulationem). This frames the entire passage around the theme of performance.",
        effect: "Emphasises that Agrippina's survival depends on acting, except for one genuine act."
    },
    "simulationem": {
        tier: 2,
        device: "Thematic Repetition with Antithesis",
        latin: "securitate simulata... non per simulationem",
        description: "The final use of simul- root is negated: sealing Acerronia's estate was 'not through pretence.' This pointed exception makes everything else she does explicitly performative.",
        effect: "Tacitus's closing observation transforms our understanding of the entire passage."
    },
    // Sibilance
    "simul": {
        tier: 1,
        device: "Sibilance",
        latin: "simul suum... securitate simulata... simulationem",
        description: "The repeated 's' sounds throughout the passage create sibilance, particularly concentrated around words of pretence (simul, simulata, simulationem) and possession (suum, sui, sibi).",
        effect: "The hissing sounds may evoke secrecy, deception, or the whispered plotting of the court."
    },
    "suum": {
        tier: 1,
        device: "Sibilance",
        latin: "simul suum vulnus",
        description: "The clustering of 's' sounds in 'simul suum' creates an audible effect that draws attention to this moment of self-examination.",
        effect: "Sound reinforces meaning: the soft sibilants suit the intimate examination of her wound."
    },
    // Alliteration
    "fallacibus": {
        tier: 1,
        device: "Alliteration",
        latin: "fallacibus... filio... fortuna... fomenta",
        description: "The 'f' sound recurs throughout the passage, linking deception (fallacibus), family (filio), fate (fortuna), and medicine (fomenta). This alliterative thread connects the passage's themes.",
        effect: "Creates phonetic cohesion across the passage while subtly linking related concepts."
    }
};

const resources = {
    summary: `<h4>Summary</h4>
<p>In this passage, Agrippina demonstrates remarkable analytical intelligence and political cunning after surviving the assassination attempt. Having been pulled from the sea, she methodically pieces together the evidence: the suspicious letter summoning her, the excessive honour shown to her, and most tellingly, the unnatural way the ship collapsed from above like a land-based mechanism rather than from natural causes.</p>
<p>Recognising her son's murderous intent, Agrippina concludes that her only chance of survival is to pretend ignorance. She sends her freedman Agerinus to Nero with a carefully crafted message: she has escaped through divine favour and his good fortune (a subtle barb), and she begs him not to visit her despite his supposed concern. The request buys her time while forcing Nero to maintain his pretence of innocence.</p>
<p>Meanwhile, she performs complete normalcy‚Äîapplying medicines and poultices as if nothing unusual has happened. Only one action is genuine: securing Acerronia's will and property. Tacitus's final observation‚Äî"id tantum non per simulationem" (this alone was not through pretence)‚Äîreveals that everything else Agrippina does is calculated performance in a deadly game of mutual dissimulation.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>The Assassination Attempt:</strong> Earlier in Annals 14, Nero had arranged for a specially constructed ship designed to collapse and drown his mother during a night voyage across the Bay of Naples. The mechanism failed to kill Agrippina, who swam to safety. Acerronia, her companion who shouted that she was Agrippina (hoping to be rescued first), was beaten to death by the sailors.</p>
<p><strong>Dissimulatio:</strong> The concept of dissimulatio‚Äîconcealing one's true feelings and intentions‚Äîwas central to survival in the imperial court. Here, both mother and son engage in elaborate pretence: Agrippina feigns ignorance of Nero's guilt, while Nero must pretend shock at his mother's "accident." Tacitus shows Agrippina as the master of this political art.</p>
<p><strong>The Message to Nero:</strong> Agrippina's message is a masterpiece of political communication. By thanking the gods and specifically Nero's "fortune" for her survival, she implies that Nero should be grateful she survived his attempt. By asking him not to visit, she removes the awkward necessity of a face-to-face meeting while suggesting she knows he would rather not come.</p>
<p><strong>The Sealing of Acerronia's Estate:</strong> Agrippina's order to seal Acerronia's property was the one genuine action because it served her practical interests‚Äîpreventing the estate from being claimed by others. Everything else was performance designed to maintain the fiction of ignorance.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Lines 1-2:</strong> What three pieces of evidence does Agrippina consider while reflecting on her situation? How does each point towards assassination?</p>
<p><strong>Line 2:</strong> What is the significance of the phrase "veluti terrestre machinamentum"? What does this comparison reveal about Agrippina's analysis?</p>
<p><strong>Line 3:</strong> What conclusion does Agrippina reach about how to survive? What does "solum insidiarum remedium" tell us about her options?</p>
<p><strong>Lines 4-5:</strong> What message does Agrippina send to Nero? How does the phrase "benignitate deum et fortuna eius" function as both thanks and accusation?</p>
<p><strong>Line 5:</strong> Why does Agrippina ask Nero not to visit? What does "sibi ad praesens quiete opus" achieve strategically?</p>
<p><strong>Line 6:</strong> What is the significance of "securitate simulata"? How does this ablative absolute characterise Agrippina's behaviour?</p>
<p><strong>Line 7:</strong> Why does Tacitus specifically note that sealing Acerronia's estate was "non per simulationem"? What does this reveal about everything else Agrippina does?</p>
<p><strong>Overall:</strong> How does Tacitus present Agrippina in this passage? Is she victim, survivor, or political operator? Consider the role of participles in characterising her actions.</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;
let styleModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    // Exit style mode if entering pointer mode
    if (pointerModeActive && styleModeActive) {
        toggleStyleMode();
    }

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
    }
}

function toggleStyleMode() {
    styleModeActive = !styleModeActive;
    const latinText = document.getElementById('latinText');
    const legend = document.getElementById('styleLegend');
    const btn = event.currentTarget;

    // Exit pointer mode if entering style mode
    if (styleModeActive && pointerModeActive) {
        pointerModeActive = false;
        document.body.classList.remove('pointer-mode');
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
        document.querySelectorAll('.btn').forEach(b => {
            if (b.textContent === 'Pointer Mode') b.classList.remove('active');
        });
    }

    if (styleModeActive) {
        latinText.classList.add('style-mode');
        legend.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Hide Style';
        hidePopup();
        hideStylePopup();
    } else {
        latinText.classList.remove('style-mode');
        legend.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Style';
        hideStylePopup();
    }
}

function showStylePopup(event, word) {
    const popup = document.getElementById('stylePopup');
    const data = styleData[word.toLowerCase()];

    if (!data) {
        hideStylePopup();
        return;
    }

    const tierLabels = {
        1: 'Sound & Rhythm',
        2: 'Word Choice',
        3: 'Structure'
    };

    popup.innerHTML = `
        <div class="style-header">
            <span class="style-tier-badge tier${data.tier}">${tierLabels[data.tier]}</span>
        </div>
        <h4>${data.device}</h4>
        <div class="style-latin">${data.latin}</div>
        <div class="style-description">${data.description}</div>
        <div class="style-effect"><strong>Effect:</strong> ${data.effect}</div>
    `;

    // Position popup
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 380;
    const popupHeight = 280;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 15;

    // Keep within viewport
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }
    if (top + popupHeight > window.innerHeight - 10) {
        top = rect.top - popupHeight - 15;
    }

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.classList.add('visible');
}

function hideStylePopup() {
    const popup = document.getElementById('stylePopup');
    popup.classList.remove('visible');
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:]*|[.,;:]+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:]*)$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2];
                    const lookupWord = word.toLowerCase();

                    // Check if word has style data
                    let styleClass = '';
                    if (styleData[lookupWord]) {
                        styleClass = ` style-tier${styleData[lookupWord].tier}`;
                    }

                    html += `<span class="word${styleClass}" data-word="${lookupWord}">${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else if (styleModeActive && styleData[this.dataset.word]) {
                // Show style popup if in style mode and word has style data
                hidePopup();
                showStylePopup(e, this.dataset.word);
            } else {
                // Show vocab popup
                hideStylePopup();
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();
            hideStylePopup();

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
            // Exit style mode on escape
            if (styleModeActive) {
                styleModeActive = false;
                document.getElementById('latinText').classList.remove('style-mode');
                document.getElementById('styleLegend').classList.remove('visible');
                hideStylePopup();
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Hide Style') {
                        btn.textContent = 'Style';
                        btn.classList.remove('active');
                    }
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
