<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.9</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Three-tier style highlighting colors */
        .word.style-tier1 {
            background: rgba(239, 68, 68, 0.25) !important;
            border-bottom: 2px solid #ef4444;
        }
        .word.style-tier2 {
            background: rgba(59, 130, 246, 0.25) !important;
            border-bottom: 2px solid #3b82f6;
        }
        .word.style-tier3 {
            background: rgba(34, 197, 94, 0.25) !important;
            border-bottom: 2px solid #22c55e;
        }
        body.dark-mode .word.style-tier1 {
            background: rgba(239, 68, 68, 0.35) !important;
        }
        body.dark-mode .word.style-tier2 {
            background: rgba(59, 130, 246, 0.35) !important;
        }
        body.dark-mode .word.style-tier3 {
            background: rgba(34, 197, 94, 0.35) !important;
        }

        /* Style popup */
        .style-popup {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            z-index: 1001;
            max-width: 450px;
            min-width: 320px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .style-popup.visible {
            display: block;
        }
        .style-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .style-popup h4 .tier-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .tier-badge.tier1 {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }
        .tier-badge.tier2 {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }
        .tier-badge.tier3 {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }
        .style-popup .latin-quote {
            font-style: italic;
            color: #6b7280;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .style-popup .device-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .style-popup .explanation {
            font-size: 0.9rem;
            color: #4b5563;
            line-height: 1.6;
        }
        .style-popup .close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #9ca3af;
            padding: 0.25rem;
            line-height: 1;
        }
        .style-popup .close-btn:hover {
            color: #4b5563;
        }
        body.dark-mode .style-popup {
            background: #4f0c28;
        }
        body.dark-mode .style-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .style-popup .latin-quote {
            background: #3a0a1f;
            color: #b8a8b8;
        }
        body.dark-mode .style-popup .device-name {
            color: #c5d2f8;
        }
        body.dark-mode .style-popup .explanation {
            color: #b8c8e8;
        }
        body.dark-mode .style-popup .close-btn {
            color: #9a8a9a;
        }
        body.dark-mode .style-popup .close-btn:hover {
            color: #c5d2f8;
        }

        /* Style mode indicator */
        .style-mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #ef4444 0%, #3b82f6 50%, #22c55e 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }
        body.style-mode .style-mode-indicator {
            display: block;
        }
        body.style-mode .word {
            cursor: help;
        }

        /* Style legend */
        .style-legend {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .style-legend.visible {
            display: block;
        }
        .style-legend h5 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        .style-legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .style-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #4b5563;
        }
        .style-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .style-legend-color.tier1 {
            background: rgba(239, 68, 68, 0.4);
            border: 2px solid #ef4444;
        }
        .style-legend-color.tier2 {
            background: rgba(59, 130, 246, 0.4);
            border: 2px solid #3b82f6;
        }
        .style-legend-color.tier3 {
            background: rgba(34, 197, 94, 0.4);
            border: 2px solid #22c55e;
        }
        body.dark-mode .style-legend {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .style-legend h5 {
            color: #c5d2f8;
        }
        body.dark-mode .style-legend-item {
            color: #b8a8b8;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }
        body.full-screen .style-legend {
            display: none !important;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">Burial and Prophecy</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.9</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleStyleMode()">Style</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="style-legend" id="styleLegend">
                            <h5>Style Analysis Legend</h5>
                            <div class="style-legend-items">
                                <div class="style-legend-item">
                                    <div class="style-legend-color tier1"></div>
                                    <span>Sound Effects (alliteration, assonance)</span>
                                </div>
                                <div class="style-legend-item">
                                    <div class="style-legend-color tier2"></div>
                                    <span>Word Order (hyperbaton, chiasmus)</span>
                                </div>
                                <div class="style-legend-item">
                                    <div class="style-legend-color tier3"></div>
                                    <span>Rhetoric & Meaning (irony, juxtaposition)</span>
                                </div>
                            </div>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 9</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>These accounts are recorded with general agreement. Whether Nero looked at his lifeless mother and praised the beauty of her body, some have related it, others deny it. She was cremated that same night on a dining couch and with cheap funeral rites; nor, as long as Nero was in charge of affairs, was earth piled up or closed upon her. Some time later, thanks to the attention of her servants, she received a light mound near the road to Misenum and the villa of the dictator Caesar which, being very high up, looked out over the bays lying beneath. When the funeral pyre had been lit, her freedman with the family name Mnester stabbed himself with a sword; it is not clear whether this was out of affection for his patron or in fear of death. Many years before, Agrippina had believed this would be her end and had made light of it. For when she was consulting them about Nero, Chaldaean soothsayers answered her that he would be emperor and kill his mother; and she said, 'Let him kill, as long as he becomes emperor.'</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="style-popup" id="stylePopup">
        <button class="close-btn" onclick="hideStylePopup()">&times;</button>
        <div id="stylePopupContent"></div>
    </div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>
    <div class="style-mode-indicator">üé® Style Mode (click highlighted words for analysis)</div>

    <script>
const vocab = {
    "haec": { lemma: "hic, haec, hoc", parsing: "nom./acc. neut. pl.", meaning: "these things" },
    "consensu": { lemma: "consensus, -us (m.)", parsing: "abl. sing.", meaning: "with agreement" },
    "produntur": { lemma: "prodo, -ere, prodidi, proditum", parsing: "pres. pass. ind. 3rd pl.", meaning: "are reported, handed down" },
    "aspexeritne": { lemma: "aspicio, -ere, aspexi, aspectum + -ne", parsing: "perf. subj. act. 3rd sing. + interrog.", meaning: "whether he looked at" },
    "matrem": { lemma: "mater, matris (f.)", parsing: "acc. sing.", meaning: "mother" },
    "exanimem": { lemma: "exanimis, -e", parsing: "acc. sing.", meaning: "lifeless" },
    "nero": { lemma: "Nero, Neronis (m.)", parsing: "nom. sing.", meaning: "Nero" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and" },
    "formam": { lemma: "forma, -ae (f.)", parsing: "acc. sing.", meaning: "beauty, form" },
    "corporis": { lemma: "corpus, corporis (n.)", parsing: "gen. sing.", meaning: "of body" },
    "eius": { lemma: "is, ea, id", parsing: "gen. sing.", meaning: "her, his" },
    "laudaverit": { lemma: "laudo, -are, -avi, -atum", parsing: "perf. subj. act. 3rd sing.", meaning: "praised" },
    "sunt": { lemma: "sum, esse, fui", parsing: "pres. ind. 3rd pl.", meaning: "there are" },
    "qui": { lemma: "qui, quae, quod", parsing: "nom. pl. masc.", meaning: "who" },
    "tradiderint": { lemma: "trado, -ere, tradidi, traditum", parsing: "perf. subj. act. 3rd pl.", meaning: "have reported" },
    "abnuant": { lemma: "abnuo, -ere, abnui", parsing: "pres. subj. act. 3rd pl.", meaning: "deny" },
    "cremata": { lemma: "cremo, -are, -avi, -atum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "cremated" },
    "est": { lemma: "sum, esse, fui", parsing: "pres. ind. 3rd sing.", meaning: "was" },
    "nocte": { lemma: "nox, noctis (f.)", parsing: "abl. sing.", meaning: "on night" },
    "eadem": { lemma: "idem, eadem, idem", parsing: "abl. fem. sing.", meaning: "same" },
    "convivali": { lemma: "convivalis, -e", parsing: "abl. sing.", meaning: "dining" },
    "lecto": { lemma: "lectus, -i (m.)", parsing: "abl. sing.", meaning: "on couch" },
    "exequiis": { lemma: "exequiae, -arum (f. pl.)", parsing: "abl. pl.", meaning: "with funeral rites" },
    "vilibus": { lemma: "vilis, -e", parsing: "abl. pl.", meaning: "cheap" },
    "neque": { lemma: "neque", parsing: "conjunction", meaning: "and not, nor" },
    "dum": { lemma: "dum", parsing: "conjunction", meaning: "while, as long as" },
    "rerum": { lemma: "res, rei (f.)", parsing: "gen. pl.", meaning: "of affairs" },
    "potiebatur": { lemma: "potior, potiri, potitus sum", parsing: "imperf. ind. dep. 3rd sing.", meaning: "was in control" },
    "congesta": { lemma: "congero, -ere, congessi, congestum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "heaped up" },
    "aut": { lemma: "aut", parsing: "conjunction", meaning: "or" },
    "clausa": { lemma: "claudo, -ere, clausi, clausum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "closed, sealed" },
    "humus": { lemma: "humus, -i (f.)", parsing: "nom. sing.", meaning: "earth" },
    "mox": { lemma: "mox", parsing: "adverb", meaning: "soon, later" },
    "domesticorum": { lemma: "domesticus, -i (m.)", parsing: "gen. pl.", meaning: "of household servants" },
    "cura": { lemma: "cura, -ae (f.)", parsing: "abl. sing.", meaning: "through care" },
    "levem": { lemma: "levis, -e", parsing: "acc. sing.", meaning: "light, modest" },
    "tumulum": { lemma: "tumulus, -i (m.)", parsing: "acc. sing.", meaning: "mound" },
    "accepit": { lemma: "accipio, -ere, accepi, acceptum", parsing: "perf. ind. act. 3rd sing.", meaning: "received" },
    "viam": { lemma: "via, -ae (f.)", parsing: "acc. sing.", meaning: "road" },
    "miseni": { lemma: "Misenum, -i (n.)", parsing: "gen. sing.", meaning: "of Misenum" },
    "propter": { lemma: "propter", parsing: "preposition + acc.", meaning: "near" },
    "villam": { lemma: "villa, -ae (f.)", parsing: "acc. sing.", meaning: "villa" },
    "caesaris": { lemma: "Caesar, Caesaris (m.)", parsing: "gen. sing.", meaning: "of Caesar" },
    "dictatoris": { lemma: "dictator, -oris (m.)", parsing: "gen. sing.", meaning: "dictator" },
    "quae": { lemma: "qui, quae, quod", parsing: "nom. fem. sing.", meaning: "which" },
    "subiectos": { lemma: "subicio, -ere, subieci, subiectum", parsing: "perf. pass. part. acc. pl.", meaning: "lying below" },
    "sinus": { lemma: "sinus, -us (m.)", parsing: "acc. pl.", meaning: "bays" },
    "editissima": { lemma: "editus, -a, -um", parsing: "nom. fem. sing. superl.", meaning: "very high up" },
    "prospectat": { lemma: "prospecto, -are, -avi, -atum", parsing: "pres. ind. act. 3rd sing.", meaning: "looks over" },
    "accenso": { lemma: "accendo, -ere, accendi, accensum", parsing: "perf. pass. part. abl. masc. sing.", meaning: "having been lit" },
    "rogo": { lemma: "rogus, -i (m.)", parsing: "abl. sing.", meaning: "pyre" },
    "libertus": { lemma: "libertus, -i (m.)", parsing: "nom. sing.", meaning: "freedman" },
    "cognomento": { lemma: "cognomen, -inis (n.)", parsing: "abl. sing.", meaning: "with surname" },
    "mnester": { lemma: "Mnester, Mnesteris (m.)", parsing: "nom. sing.", meaning: "Mnester (proper name)" },
    "se": { lemma: "sui, sibi, se", parsing: "acc. reflexive", meaning: "himself" },
    "ipse": { lemma: "ipse, ipsa, ipsum", parsing: "nom. masc. sing.", meaning: "himself (emphatic)" },
    "ferro": { lemma: "ferrum, -i (n.)", parsing: "abl. sing.", meaning: "with sword" },
    "transegit": { lemma: "transigo, -ere, transegi, transactum", parsing: "perf. ind. act. 3rd sing.", meaning: "killed, ran through" },
    "incertum": { lemma: "incertus, -a, -um", parsing: "nom./acc. neut. sing.", meaning: "uncertain" },
    "caritate": { lemma: "caritas, -atis (f.)", parsing: "abl. sing.", meaning: "through love" },
    "in": { lemma: "in", parsing: "preposition + acc.", meaning: "towards" },
    "patronam": { lemma: "patrona, -ae (f.)", parsing: "acc. sing.", meaning: "patron, mistress" },
    "an": { lemma: "an", parsing: "conjunction", meaning: "or whether" },
    "metu": { lemma: "metus, -us (m.)", parsing: "abl. sing.", meaning: "through fear" },
    "exitii": { lemma: "exitium, -i (n.)", parsing: "gen. sing.", meaning: "of death" },
    "hunc": { lemma: "hic, haec, hoc", parsing: "acc. masc. sing.", meaning: "this" },
    "sui": { lemma: "sui, sibi, se", parsing: "gen. reflexive", meaning: "of herself" },
    "finem": { lemma: "finis, -is (m.)", parsing: "acc. sing.", meaning: "end" },
    "multos": { lemma: "multus, -a, -um", parsing: "acc. pl. masc.", meaning: "many" },
    "ante": { lemma: "ante", parsing: "preposition + acc.", meaning: "before" },
    "annos": { lemma: "annus, -i (m.)", parsing: "acc. pl.", meaning: "years" },
    "crediderat": { lemma: "credo, -ere, credidi, creditum", parsing: "pluperf. ind. act. 3rd sing.", meaning: "had believed" },
    "agrippina": { lemma: "Agrippina, -ae (f.)", parsing: "nom. sing.", meaning: "Agrippina" },
    "contempseratque": { lemma: "contemno, -ere, contempsi, contemptum + -que", parsing: "pluperf. ind. act. 3rd sing. + and", meaning: "and had despised" },
    "nam": { lemma: "nam", parsing: "conjunction", meaning: "for" },
    "consulenti": { lemma: "consulo, -ere, consului, consultum", parsing: "pres. part. dat. fem. sing.", meaning: "to her consulting" },
    "super": { lemma: "super", parsing: "preposition + abl.", meaning: "about" },
    "nerone": { lemma: "Nero, Neronis (m.)", parsing: "abl. sing.", meaning: "Nero" },
    "responderunt": { lemma: "respondeo, -ere, respondi, responsum", parsing: "perf. ind. act. 3rd pl.", meaning: "replied" },
    "chaldaei": { lemma: "Chaldaei, -orum (m. pl.)", parsing: "nom. pl.", meaning: "Chaldaean soothsayers" },
    "fore": { lemma: "sum, esse, fui", parsing: "fut. inf.", meaning: "would be" },
    "ut": { lemma: "ut", parsing: "conjunction", meaning: "that" },
    "imperaret": { lemma: "impero, -are, -avi, -atum", parsing: "imperf. subj. act. 3rd sing.", meaning: "he would rule" },
    "matremque": { lemma: "mater, matris (f.) + -que", parsing: "acc. sing. + and", meaning: "and mother" },
    "occideret": { lemma: "occido, -ere, occidi, occisum", parsing: "imperf. subj. act. 3rd sing.", meaning: "he would kill" },
    "atque": { lemma: "atque", parsing: "conjunction", meaning: "and" },
    "illa": { lemma: "ille, illa, illud", parsing: "nom. fem. sing.", meaning: "she" },
    "occidat": { lemma: "occido, -ere, occidi, occisum", parsing: "pres. subj. act. 3rd sing.", meaning: "let him kill" },
    "inquit": { lemma: "inquam", parsing: "perf. ind. 3rd sing.", meaning: "said" },
    "imperet": { lemma: "impero, -are, -avi, -atum", parsing: "pres. subj. act. 3rd sing.", meaning: "let him rule" }
};

const latinSentences = [
    "haec consensu produntur.",
    "aspexeritne matrem exanimem Nero et formam corporis eius laudaverit, sunt qui tradiderint, sunt qui abnuant.",
    "cremata est nocte eadem convivali lecto et exequiis vilibus;",
    "neque, dum Nero rerum potiebatur, congesta aut clausa humus.",
    "mox domesticorum cura levem tumulum accepit, viam Miseni propter et villam Caesaris dictatoris quae subiectos sinus editissima prospectat.",
    "accenso rogo libertus eius cognomento Mnester se ipse ferro transegit, incertum caritate in patronam an metu exitii.",
    "hunc sui finem multos ante annos crediderat Agrippina contempseratque.",
    "nam consulenti super Nerone responderunt Chaldaei fore ut imperaret matremque occideret;",
    "atque illa 'occidat' inquit 'dum imperet.'"
];

// Style analysis data - three tiers:
// Tier 1 (red): Sound effects - alliteration, assonance, onomatopoeia
// Tier 2 (blue): Word order/structure - hyperbaton, chiasmus, anaphora
// Tier 3 (green): Rhetoric/meaning - irony, juxtaposition, paradox
const styleData = {
    // Sentence 2: Anaphora - sunt qui...sunt qui
    "sunt": {
        tier: 2,
        device: "Anaphora",
        latin: "sunt qui tradiderint, sunt qui abnuant",
        explanation: "The repetition of 'sunt qui' (there are those who) at the beginning of successive clauses creates a balanced structure that emphasises the division among sources. This rhetorical technique reflects Tacitus's careful historiographical method, presenting conflicting accounts without resolving them, and mirrors the uncertainty surrounding Nero's gruesome act."
    },
    // Sentence 2: Juxtaposition - matrem exanimem
    "matrem": {
        tier: 3,
        device: "Juxtaposition",
        latin: "matrem exanimem",
        explanation: "The stark placement of 'matrem' (mother) immediately before 'exanimem' (lifeless) creates a shocking juxtaposition. The natural relationship word collides with death, emphasising the horror of matricide. Tacitus forces the reader to confront the unnatural act: a son viewing his dead mother's body."
    },
    // Sentence 3: Oxymoron - convivali lecto
    "convivali": {
        tier: 3,
        device: "Oxymoron",
        latin: "convivali lecto",
        explanation: "A 'convivalis lectus' was a dining couch for feasts and pleasure - using it for a funeral cremation is deeply inappropriate. This jarring detail highlights the shameful haste and disrespect of Agrippina's cremation. The word associated with life's pleasures is repurposed for death, emphasising the dishonour done to her."
    },
    // Sentence 3: Asyndeton - nocte eadem...lecto et exequiis vilibus
    "vilibus": {
        tier: 2,
        device: "Asyndeton with Climax",
        latin: "nocte eadem convivali lecto et exequiis vilibus",
        explanation: "The rapid accumulation of shameful details - same night, dining couch, cheap rites - builds without elaborate connectives. This compressed style mimics the rushed, undignified funeral itself. The final 'vilibus' (cheap) strikes like a judgement, the list culminating in this damning adjective."
    },
    // Sentence 4: Alliteration - congesta...clausa
    "congesta": {
        tier: 1,
        device: "Alliteration",
        latin: "congesta aut clausa",
        explanation: "The harsh 'c' sounds in 'congesta' and 'clausa' create an emphatic alliterative pair that underscores the denial of proper burial. Both words describe what should happen to seal a grave - earth heaped up and closed - but here the negative 'neque' makes them an accusation. The repeated consonant hammers home the deliberate neglect."
    },
    // Sentence 5: Hyperbaton - viam Miseni propter
    "viam": {
        tier: 2,
        device: "Hyperbaton",
        latin: "viam Miseni propter et villam Caesaris dictatoris",
        explanation: "The separation of 'propter' from its objects and the elaborate location description creates a formal, almost epitaph-like quality. The word order slows the reader, contrasting with the rushed cremation described earlier. The location near Caesar's villa adds symbolic weight - Agrippina finally rests near a site of Republican power."
    },
    // Sentence 6: Chiasmus - caritate in patronam an metu exitii
    "caritate": {
        tier: 2,
        device: "Chiasmus",
        latin: "caritate in patronam an metu exitii",
        explanation: "The structure creates a chiastic pattern: emotion (caritate) - object (patronam) | object (exitii) - emotion (implied in metu). This balanced arrangement reflects the balanced uncertainty Tacitus presents - was it love or fear? The rhetorical symmetry mirrors the impossibility of knowing Mnester's true motivation."
    },
    // Sentence 6: Alliteration - ferro...transegit
    "ferro": {
        tier: 1,
        device: "Alliteration and Harsh Consonance",
        latin: "se ipse ferro transegit",
        explanation: "The 'f' and 't' sounds create a harsh, violent texture that mimics the brutal act described. 'Ferro transegit' (ran through with iron) is visceral and direct. Combined with the emphatic 'se ipse' (himself, personally), the sound pattern reinforces the decisive violence of Mnester's suicide."
    },
    // Sentence 7: Hyperbaton - hunc sui finem...Agrippina
    "hunc": {
        tier: 2,
        device: "Hyperbaton",
        latin: "hunc sui finem multos ante annos crediderat Agrippina",
        explanation: "Agrippina's name is delayed until the end of the sentence, creating suspense and emphasis. 'Hunc sui finem' (this end of herself) placed first forces readers to contemplate the death before learning who foresaw it. The word order mirrors how the prophecy preceded the event by many years."
    },
    // Sentence 8: Polyptoton - imperaret...occideret / imperet...occidat
    "imperaret": {
        tier: 1,
        device: "Polyptoton",
        latin: "imperaret...occideret / occidat...imperet",
        explanation: "The prophecy uses 'imperaret' and 'occideret' (subjunctive), which Agrippina echoes with 'occidat' and 'imperet' (jussive subjunctive). This repetition with variation creates a chilling echo between prophecy and acceptance. The same roots appear in different moods, showing Agrippina transforming prediction into willing command."
    },
    // Sentence 9: Brevity and Direct Speech
    "occidat": {
        tier: 3,
        device: "Brevitas and Epigrammatic Force",
        latin: "occidat...dum imperet",
        explanation: "Agrippina's response is devastatingly brief - just four words in Latin. This extreme compression creates an epigram that encapsulates her entire character: ruthless ambition that accepts even her own murder as the price of power. The shocking brevity makes this one of the most memorable lines in the Annals."
    },
    // Sentence 9: Juxtaposition of killing and ruling
    "imperet": {
        tier: 3,
        device: "Paradox and Moral Inversion",
        latin: "occidat...dum imperet",
        explanation: "The juxtaposition of 'occidat' (let him kill) with 'imperet' (let him rule) creates a moral paradox. Matricide becomes acceptable if it leads to imperial power. Agrippina inverts natural values - a mother welcomes her murder for political gain. This captures the corruption at the heart of the Julio-Claudian dynasty."
    }
};

const resources = {
    summary: `<h4>Summary</h4>
<p>Tacitus opens with historiographical honesty: most sources agree on the murder, but disagree on whether Nero viewed and praised his mother's corpse‚Äîsome say yes, others no. The cremation happens immediately, that same night, on a dining couch (not a proper funeral bier) with cheap, rushed rites. No proper burial follows: no earth heaped up, no sealed tomb‚Äîdeliberate erasure while Nero rules.</p>
<p>Only later do loyal servants secretly raise a modest mound near Misenum, by Julius Caesar's old villa overlooking the bay‚Äîa location both symbolic (Caesar's property) and practical (high visibility). At the pyre, freedman Mnester kills himself‚Äîwhether from grief or fear remains unclear.</p>
<p>Tacitus then reveals the prophecy: years earlier, Chaldaean astrologers told Agrippina that Nero would rule and kill her. Her chilling response: "Let him kill, as long as he becomes emperor." This retrospective prophecy frames the entire narrative‚Äîshe knew her fate and accepted it for power.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>Roman Funeral Customs:</strong> Roman funeral customs required proper rites‚Äîcremation on a formal funeral bed (not dining couch), appropriate ceremonies, and burial with earth properly heaped and sealed. Denying these was extreme dishonour.</p>
<p><strong>Location Significance:</strong> The location near Misenum was significant: Julius Caesar's villa represented old Republican power, contrasting with Nero's corrupted principate.</p>
<p><strong>Chaldaean Astrologers:</strong> Chaldaean astrologers were Babylonian practitioners highly regarded in Rome despite periodic expulsions‚Äîtheir prophecies were taken seriously.</p>
<p><strong>Freedman Loyalty:</strong> Freedmen like Mnester often had deep loyalty to patrons, making his suicide ambiguous‚Äîgenuine grief or fear of torture? The immediate cremation prevented proper preparation of the body and formal lying in state.</p>
<p><strong>The Prophecy:</strong> The servants' later action required courage‚Äîhonouring Agrippina could be seen as opposing Nero. The prophecy story may be retrospective invention, but captures Agrippina's character perfectly‚Äîaccepting death as the price of power.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Lines 1-2:</strong> Why does Tacitus include conflicting accounts about Nero viewing the body‚Äîwhat does this uncertainty achieve?</p>
<p><strong>Line 3:</strong> What details about the cremation emphasise the dishonour done to Agrippina? What is significant about "convivali lecto"?</p>
<p><strong>Line 4:</strong> What does "dum Nero rerum potiebatur" imply about the relationship between Nero's power and Agrippina's burial?</p>
<p><strong>Line 5:</strong> How does the contrast between immediate dishonour and eventual modest honour reflect on Nero's power? What is the significance of the burial location near Julius Caesar's villa?</p>
<p><strong>Line 6:</strong> Is Mnester's suicide loyalty or self-preservation‚Äîand why does Tacitus leave it ambiguous?</p>
<p><strong>Lines 7-9:</strong> How does the prophecy reframe the entire narrative‚Äîwas this always destiny? What does "occidat dum imperet" reveal about Roman attitudes to power versus family?</p>
<p><strong>Overall:</strong> How does Tacitus balance historical reporting with literary artistry in this passage?</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;
let styleModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    // Turn off style mode if active
    if (styleModeActive) {
        toggleStyleMode();
    }

    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
    }
}

function toggleStyleMode() {
    // Turn off pointer mode if active
    if (pointerModeActive) {
        pointerModeActive = false;
        document.body.classList.remove('pointer-mode');
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
        document.querySelectorAll('.btn').forEach(btn => {
            if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
        });
    }

    styleModeActive = !styleModeActive;
    document.body.classList.toggle('style-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    const legend = document.getElementById('styleLegend');

    if (styleModeActive) {
        // Apply style highlighting
        applyStyleHighlighting();
        legend.classList.add('visible');
        hidePopup();
    } else {
        // Remove style highlighting
        removeStyleHighlighting();
        legend.classList.remove('visible');
        hideStylePopup();
    }
}

function applyStyleHighlighting() {
    document.querySelectorAll('.word').forEach(word => {
        const wordText = word.dataset.word.toLowerCase();
        if (styleData[wordText]) {
            const tier = styleData[wordText].tier;
            word.classList.add(`style-tier${tier}`);
            word.dataset.hasStyle = 'true';
        }
    });
}

function removeStyleHighlighting() {
    document.querySelectorAll('.word').forEach(word => {
        word.classList.remove('style-tier1', 'style-tier2', 'style-tier3');
        delete word.dataset.hasStyle;
    });
}

function showStylePopup(event, wordText) {
    const data = styleData[wordText.toLowerCase()];
    if (!data) return;

    const popup = document.getElementById('stylePopup');
    const content = document.getElementById('stylePopupContent');

    const tierLabels = {
        1: 'Sound',
        2: 'Structure',
        3: 'Rhetoric'
    };

    content.innerHTML = `
        <h4>
            <span class="tier-badge tier${data.tier}">${tierLabels[data.tier]}</span>
            ${data.device}
        </h4>
        <div class="latin-quote">"${data.latin}"</div>
        <div class="explanation">${data.explanation}</div>
    `;

    // Position popup
    const rect = event.target.getBoundingClientRect();
    let left = rect.left + (rect.width / 2) - 175;
    let top = rect.bottom + 12;

    // Keep within viewport
    if (left < 10) left = 10;
    if (left + 350 > window.innerWidth - 10) {
        left = window.innerWidth - 360;
    }
    if (top + 250 > window.innerHeight) {
        top = rect.top - 260;
    }

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.classList.add('visible');
}

function hideStylePopup() {
    const popup = document.getElementById('stylePopup');
    popup.classList.remove('visible');
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:']*|[.,;:']+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:']*)?$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2] || '';
                    const lookupWord = word.toLowerCase();
                    // Check if word has style data
                    const hasStyle = styleData[lookupWord] ? ' data-has-style="true"' : '';
                    html += `<span class="word" data-word="${lookupWord}"${hasStyle}>${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else if (styleModeActive) {
                // Show style popup if word has style data
                const wordText = this.dataset.word;
                if (styleData[wordText.toLowerCase()]) {
                    hideStylePopup();
                    showStylePopup(e, wordText);
                }
            } else {
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();

            // Hide style popup if clicking outside
            if (!e.target.closest('.style-popup')) {
                hideStylePopup();
            }

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
            // Exit style mode on escape
            if (styleModeActive) {
                styleModeActive = false;
                document.body.classList.remove('style-mode');
                removeStyleHighlighting();
                document.getElementById('styleLegend').classList.remove('visible');
                hideStylePopup();
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Style') btn.classList.remove('active');
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
