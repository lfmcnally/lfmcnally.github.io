<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.2</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Style highlighting */
        .word.style-tier1 { border-bottom: 2px solid #f0c040; }
        .word.style-tier2 { border-bottom: 2px solid #38b2ac; }
        .word.style-tier3 { border-bottom: 2px solid #9f7aea; }
        .word.style-tier1:hover, .word.style-tier2:hover, .word.style-tier3:hover { background: rgba(159, 122, 234, 0.15); }
        body.dark-mode .word.style-tier1 { border-bottom-color: #ecc94b; }
        body.dark-mode .word.style-tier2 { border-bottom-color: #4fd1c5; }
        body.dark-mode .word.style-tier3 { border-bottom-color: #b794f4; }

        .style-popup { position: fixed; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 1rem 1.25rem; z-index: 1000; max-width: 400px; min-width: 280px; display: none; }
        .style-popup.visible { display: block; }
        .style-popup .device { font-weight: 600; color: #9f7aea; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .style-popup .latin { font-style: italic; color: #4b5563; margin-bottom: 0.5rem; }
        .style-popup .effect { font-size: 0.95rem; line-height: 1.6; color: #1f2937; }
        body.dark-mode .style-popup { background: #4f0c28; }
        body.dark-mode .style-popup .device { color: #b794f4; }
        body.dark-mode .style-popup .latin { color: #b8a8b8; }
        body.dark-mode .style-popup .effect { color: #c5d2f8; }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">Sources on Agrippina's Alleged Incest</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.2</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleStyleMode()">Style</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 7</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>Cluvius records that in her eagerness to retain power, Agrippina went so far as to offer herself quite often, adorned and ready for incest, to the drunken Nero in the middle of the day, at that time when Nero was becoming heated through wine and feasting; and already, as those closest were noticing the wanton kisses and caresses that announce scandal, Seneca sought help from a woman against the feminine enticements and Acte, a freedwoman, was sent in, who, anxious both for her own danger and Nero's disgrace, reported that their incest was widely known because the mother was boasting about it, and that the soldiers would not tolerate the rule of an unholy emperor. Fabius Rusticus records that this was desired not by Agrippina but by Nero, and was scattered by the cleverness of this same freedwoman. But what Cluvius (relates), the rest of the authors too have handed down, and rumour inclines this way, whether Agrippina conceived such great monstrosity in her mind, or the contemplation of a new lust seemed more believable in her who in her girlhood years had admitted adultery with Lepidus in hope of domination, with equal desire had prostrated herself even to the whims of Pallas and was practised in every disgrace through marriage to her uncle.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="style-popup" id="stylePopup"></div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>

    <script>
const vocab = {
    "tradit": { lemma: "trado, -ere, tradidi, traditum", parsing: "pres. act. ind. 3rd sing.", meaning: "records, hands down, relates" },
    "cluvius": { lemma: "Cluvius, -i (m.)", parsing: "nom. sing.", meaning: "Cluvius Rufus (Roman historian)" },
    "ardore": { lemma: "ardor, -oris (m.)", parsing: "abl. sing.", meaning: "with burning desire, with passion" },
    "retinendae": { lemma: "retineo, -ere, retinui, retentum", parsing: "gerundive gen. fem. sing.", meaning: "of retaining, to be retained" },
    "agrippinam": { lemma: "Agrippina, -ae (f.)", parsing: "acc. sing.", meaning: "Agrippina (mother of Nero)" },
    "potentiae": { lemma: "potentia, -ae (f.)", parsing: "gen. sing.", meaning: "of power" },
    "eo": { lemma: "eo", parsing: "adverb", meaning: "to such a point, so far" },
    "usque": { lemma: "usque", parsing: "adverb", meaning: "all the way, continuously" },
    "provectam": { lemma: "proveho, -ere, provexi, provectum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "carried forward, advanced" },
    "ut": { lemma: "ut", parsing: "conjunction", meaning: "that, so that (result)" },
    "medio": { lemma: "medius, -a, -um", parsing: "abl. neut. sing.", meaning: "middle" },
    "diei": { lemma: "dies, diei (m./f.)", parsing: "gen. sing.", meaning: "of the day" },
    "cum": { lemma: "cum", parsing: "conjunction", meaning: "when" },
    "id": { lemma: "is, ea, id", parsing: "acc. neut. sing.", meaning: "that" },
    "temporis": { lemma: "tempus, temporis (n.)", parsing: "gen. sing.", meaning: "of time" },
    "nero": { lemma: "Nero, Neronis (m.)", parsing: "nom. sing.", meaning: "Nero (Roman emperor)" },
    "per": { lemma: "per", parsing: "preposition + acc.", meaning: "through, by means of" },
    "vinum": { lemma: "vinum, -i (n.)", parsing: "acc. sing.", meaning: "wine" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and" },
    "epulas": { lemma: "epulae, -arum (f. pl.)", parsing: "acc. pl.", meaning: "feast, banquet" },
    "incalesceret": { lemma: "incalesco, -ere, incalui", parsing: "imperf. subj. act. 3rd sing.", meaning: "was becoming heated, was growing warm" },
    "offerret": { lemma: "offero, offerre, obtuli, oblatum", parsing: "imperf. subj. act. 3rd sing.", meaning: "offered, presented" },
    "se": { lemma: "sui, sibi, se", parsing: "acc. reflexive", meaning: "herself" },
    "saepius": { lemma: "saepe", parsing: "comparative adverb", meaning: "quite often, rather frequently" },
    "temulento": { lemma: "temulentus, -a, -um", parsing: "dat. masc. sing.", meaning: "to the drunken one" },
    "comptam": { lemma: "como, -ere, compsi, comptum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "adorned, arranged, dressed up" },
    "incesto": { lemma: "incestum, -i (n.)", parsing: "dat. sing.", meaning: "for incest" },
    "paratam": { lemma: "paro, -are, -avi, -atum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "prepared, ready" },
    "iamque": { lemma: "iam + -que", parsing: "adverb + enclitic", meaning: "and already, and now" },
    "lasciva": { lemma: "lascivus, -a, -um", parsing: "acc. neut. pl.", meaning: "wanton, lustful" },
    "oscula": { lemma: "osculum, -i (n.)", parsing: "acc. pl.", meaning: "kisses" },
    "praenuntias": { lemma: "praenuntius, -a, -um", parsing: "acc. fem. pl.", meaning: "announcing beforehand, foretelling" },
    "flagitii": { lemma: "flagitium, -i (n.)", parsing: "gen. sing.", meaning: "of scandal, of disgrace" },
    "blanditias": { lemma: "blanditiae, -arum (f. pl.)", parsing: "acc. pl.", meaning: "caresses, flattery, blandishments" },
    "adnotantibus": { lemma: "adnoto, -are, -avi, -atum", parsing: "pres. act. part. abl. pl.", meaning: "noticing, observing" },
    "proximis": { lemma: "proximus, -a, -um", parsing: "abl. pl.", meaning: "those closest, nearest ones" },
    "senecam": { lemma: "Seneca, -ae (m.)", parsing: "acc. sing.", meaning: "Seneca (Stoic philosopher and tutor)" },
    "contra": { lemma: "contra", parsing: "preposition + acc.", meaning: "against" },
    "muliebres": { lemma: "muliebris, -e", parsing: "acc. fem. pl.", meaning: "womanly, feminine" },
    "inlecebras": { lemma: "inlecebra, -ae (f.)", parsing: "acc. pl.", meaning: "enticements, allurements" },
    "subsidium": { lemma: "subsidium, -i (n.)", parsing: "acc. sing.", meaning: "help, reinforcement, reserve" },
    "a": { lemma: "a/ab", parsing: "preposition + abl.", meaning: "from" },
    "femina": { lemma: "femina, -ae (f.)", parsing: "abl. sing.", meaning: "from a woman" },
    "petivisse": { lemma: "peto, -ere, petivi, petitum", parsing: "perf. inf. act.", meaning: "to have sought" },
    "immissamque": { lemma: "immitto, -ere, immisi, immissum + -que", parsing: "perf. pass. part. acc. fem. sing. + and", meaning: "and sent in" },
    "acten": { lemma: "Acte, Actes (f.)", parsing: "Greek acc. sing.", meaning: "Acte (freedwoman and former mistress of Nero)" },
    "libertam": { lemma: "liberta, -ae (f.)", parsing: "acc. sing.", meaning: "freedwoman" },
    "quae": { lemma: "qui, quae, quod", parsing: "rel. pron. nom. fem. sing.", meaning: "who" },
    "simul": { lemma: "simul", parsing: "adverb", meaning: "at the same time, both" },
    "suo": { lemma: "suus, -a, -um", parsing: "abl. neut. sing.", meaning: "her own" },
    "periculo": { lemma: "periculum, -i (n.)", parsing: "abl. sing.", meaning: "danger" },
    "infamia": { lemma: "infamia, -ae (f.)", parsing: "abl. sing.", meaning: "disgrace, infamy" },
    "neronis": { lemma: "Nero, Neronis (m.)", parsing: "gen. sing.", meaning: "of Nero" },
    "anxia": { lemma: "anxius, -a, -um", parsing: "nom. fem. sing.", meaning: "anxious, troubled" },
    "deferret": { lemma: "defero, deferre, detuli, delatum", parsing: "imperf. subj. act. 3rd sing.", meaning: "reported, announced" },
    "pervulgatum": { lemma: "pervulgo, -are, -avi, -atum", parsing: "perf. pass. part. acc. neut. sing.", meaning: "widely spread, made public" },
    "esse": { lemma: "sum, esse, fui", parsing: "pres. inf.", meaning: "to be" },
    "incestum": { lemma: "incestum, -i (n.)", parsing: "acc. sing.", meaning: "incest" },
    "gloriante": { lemma: "glorior, -ari, -atus sum", parsing: "pres. part. abl. fem. sing.", meaning: "boasting" },
    "matre": { lemma: "mater, matris (f.)", parsing: "abl. sing.", meaning: "mother" },
    "nec": { lemma: "nec/neque", parsing: "conjunction", meaning: "and not, nor" },
    "toleraturos": { lemma: "tolero, -are, -avi, -atum", parsing: "fut. act. part. acc. masc. pl.", meaning: "about to tolerate, would tolerate" },
    "milites": { lemma: "miles, militis (m.)", parsing: "acc. pl.", meaning: "soldiers" },
    "profani": { lemma: "profanus, -a, -um", parsing: "gen. masc. sing.", meaning: "unholy, polluted, profane" },
    "principis": { lemma: "princeps, principis (m.)", parsing: "gen. sing.", meaning: "of the emperor, of the prince" },
    "imperium": { lemma: "imperium, -i (n.)", parsing: "acc. sing.", meaning: "rule, command, empire" },
    "fabius": { lemma: "Fabius, -i (m.)", parsing: "nom. sing.", meaning: "Fabius (Roman name)" },
    "rusticus": { lemma: "Rusticus, -i (m.)", parsing: "nom. sing.", meaning: "Rusticus (Roman historian)" },
    "non": { lemma: "non", parsing: "adverb", meaning: "not" },
    "agrippinae": { lemma: "Agrippina, -ae (f.)", parsing: "dat. sing.", meaning: "by Agrippina" },
    "sed": { lemma: "sed", parsing: "conjunction", meaning: "but" },
    "neroni": { lemma: "Nero, Neronis (m.)", parsing: "dat. sing.", meaning: "by Nero" },
    "cupitum": { lemma: "cupio, -ere, cupivi, cupitum", parsing: "perf. pass. part. acc. neut. sing.", meaning: "desired, longed for" },
    "memorat": { lemma: "memoro, -are, -avi, -atum", parsing: "pres. act. ind. 3rd sing.", meaning: "records, relates, mentions" },
    "eiusdemque": { lemma: "idem, eadem, idem + -que", parsing: "gen. fem. sing. + and", meaning: "and of the same" },
    "libertae": { lemma: "liberta, -ae (f.)", parsing: "gen. sing.", meaning: "of the freedwoman" },
    "astu": { lemma: "astus, -us (m.)", parsing: "abl. sing.", meaning: "by cleverness, by cunning" },
    "disiectum": { lemma: "disicio, -ere, disieci, disiectum", parsing: "perf. pass. part. acc. neut. sing.", meaning: "scattered, ruined, thwarted" },
    "eadem": { lemma: "idem, eadem, idem", parsing: "acc. neut. pl.", meaning: "the same things" },
    "ceteri": { lemma: "ceteri, -ae, -a", parsing: "nom. masc. pl.", meaning: "the rest, the others" },
    "quoque": { lemma: "quoque", parsing: "adverb", meaning: "also, too" },
    "auctores": { lemma: "auctor, -oris (m.)", parsing: "nom. pl.", meaning: "authors, authorities" },
    "prodidere": { lemma: "prodo, -ere, prodidi, proditum", parsing: "perf. act. ind. 3rd pl.", meaning: "have handed down, have related" },
    "fama": { lemma: "fama, -ae (f.)", parsing: "nom. sing.", meaning: "rumour, report, reputation" },
    "huc": { lemma: "huc", parsing: "adverb", meaning: "this way, to this point" },
    "inclinat": { lemma: "inclino, -are, -avi, -atum", parsing: "pres. act. ind. 3rd sing.", meaning: "inclines, leans" },
    "seu": { lemma: "seu/sive", parsing: "conjunction", meaning: "whether, or if" },
    "concepit": { lemma: "concipio, -ere, concepi, conceptum", parsing: "perf. act. ind. 3rd sing.", meaning: "conceived, formed" },
    "animo": { lemma: "animus, -i (m.)", parsing: "abl. sing.", meaning: "in mind, in spirit" },
    "tantum": { lemma: "tantus, -a, -um", parsing: "acc. neut. sing.", meaning: "so much, so great" },
    "immanitatis": { lemma: "immanitas, -atis (f.)", parsing: "gen. sing.", meaning: "of monstrosity, of savagery" },
    "agrippina": { lemma: "Agrippina, -ae (f.)", parsing: "nom. sing.", meaning: "Agrippina" },
    "credibilior": { lemma: "credibilis, -e", parsing: "comparative nom. fem. sing.", meaning: "more believable" },
    "novae": { lemma: "novus, -a, -um", parsing: "gen. fem. sing.", meaning: "of new, of novel" },
    "libidinis": { lemma: "libido, -inis (f.)", parsing: "gen. sing.", meaning: "of lust, of desire" },
    "meditatio": { lemma: "meditatio, -onis (f.)", parsing: "nom. sing.", meaning: "contemplation, planning" },
    "in": { lemma: "in", parsing: "preposition + abl.", meaning: "in" },
    "ea": { lemma: "is, ea, id", parsing: "abl. fem. sing.", meaning: "her" },
    "visa": { lemma: "video, -ere, vidi, visum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "seemed" },
    "est": { lemma: "sum, esse, fui", parsing: "pres. ind. 3rd sing.", meaning: "is" },
    "puellaribus": { lemma: "puellaris, -e", parsing: "abl. pl.", meaning: "girlhood, of a young girl" },
    "annis": { lemma: "annus, -i (m.)", parsing: "abl. pl.", meaning: "in years" },
    "stuprum": { lemma: "stuprum, -i (n.)", parsing: "acc. sing.", meaning: "adultery, debauchery, disgrace" },
    "lepido": { lemma: "Lepidus, -i (m.)", parsing: "abl. sing.", meaning: "with Lepidus" },
    "spe": { lemma: "spes, spei (f.)", parsing: "abl. sing.", meaning: "in hope" },
    "dominationis": { lemma: "dominatio, -onis (f.)", parsing: "gen. sing.", meaning: "of domination, of tyranny" },
    "admiserat": { lemma: "admitto, -ere, admisi, admissum", parsing: "pluperf. act. ind. 3rd sing.", meaning: "had admitted, had allowed" },
    "pari": { lemma: "par, paris", parsing: "abl. fem. sing.", meaning: "equal" },
    "cupidine": { lemma: "cupido, -inis (f.)", parsing: "abl. sing.", meaning: "with desire" },
    "ad": { lemma: "ad", parsing: "preposition + acc.", meaning: "to, towards" },
    "libita": { lemma: "libitum, -i (n.)", parsing: "acc. pl.", meaning: "whims, pleasures" },
    "pallantis": { lemma: "Pallas, Pallantis (m.)", parsing: "gen. sing.", meaning: "of Pallas (freedman of Claudius)" },
    "provoluta": { lemma: "provolvo, -ere, provolutum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "prostrated, thrown down" },
    "exercita": { lemma: "exerceo, -ere, exercui, exercitum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "practised, trained, experienced" },
    "omne": { lemma: "omnis, -e", parsing: "acc. neut. sing.", meaning: "every, all" },
    "flagitium": { lemma: "flagitium, -i (n.)", parsing: "acc. sing.", meaning: "disgrace, scandal" },
    "patrui": { lemma: "patruus, -i (m.)", parsing: "gen. sing.", meaning: "of uncle (paternal)" },
    "nuptiis": { lemma: "nuptiae, -arum (f. pl.)", parsing: "abl. pl.", meaning: "by marriage, through marriage" }
};

const latinSentences = [
    "tradit Cluvius ardore retinendae Agrippinam potentiae eo usque provectam ut medio diei, cum id temporis Nero per vinum et epulas incalesceret, offerret se saepius temulento comptam et incesto paratam;",
    "iamque lasciva oscula et praenuntias flagitii blanditias adnotantibus proximis, Senecam contra muliebres inlecebras subsidium a femina petivisse,",
    "immissamque Acten libertam quae simul suo periculo et infamia Neronis anxia deferret pervulgatum esse incestum gloriante matre, nec toleraturos milites profani principis imperium.",
    "Fabius Rusticus non Agrippinae sed Neroni cupitum id memorat eiusdemque libertae astu disiectum.",
    "sed quae Cluvius eadem ceteri quoque auctores prodidere, et fama huc inclinat,",
    "seu concepit animo tantum immanitatis Agrippina, seu credibilior novae libidinis meditatio in ea visa est",
    "quae puellaribus annis stuprum cum Lepido spe dominationis admiserat, pari cupidine usque ad libita Pallantis provoluta et exercita ad omne flagitium patrui nuptiis."
];

const styleData = {
    "comptam": {
        tier: 1,
        device: "Homoioteleuton",
        latin: "comptam...paratam",
        effect: "The matching -am endings create a chilling parallel: Agrippina is both 'adorned' (comptam) and 'prepared' (paratam) for incest, with the rhyme suggesting deliberate calculation in her seduction."
    },
    "paratam": {
        tier: 1,
        device: "Homoioteleuton",
        latin: "comptam...paratam",
        effect: "The matching -am endings link external appearance (comptam) to internal intention (paratam), suggesting Agrippina's corruption runs from surface to soul."
    },
    "vinum": {
        tier: 1,
        device: "Hendiadys",
        latin: "per vinum et epulas",
        effect: "'Through wine and feasting' essentially means 'through drunken feasting' - two nouns express one idea, emphasising Nero's intoxicated vulnerability."
    },
    "profani": {
        tier: 1,
        device: "Alliteration",
        latin: "profani principis",
        effect: "The repeated 'p' sound hammers home the pollution theme: an 'unholy emperor' - the soldiers' religious horror at incest made audible."
    },
    "lasciva": {
        tier: 2,
        device: "Hyperbaton",
        latin: "lasciva oscula...praenuntias flagitii blanditias",
        effect: "The adjectives are dramatically separated from their nouns: 'wanton...kisses' and 'scandal-announcing...caresses'. This word order mimics courtiers glimpsing fragments of the shameful scene."
    },
    "muliebres": {
        tier: 3,
        device: "Irony",
        latin: "contra muliebres inlecebras subsidium a femina petivisse",
        effect: "Seneca seeks 'help from a woman' against 'feminine enticements' - a paradoxical cure. Tacitus implies that only a woman's cunning can counter a woman's seduction, perhaps questioning male moral authority."
    },
    "gloriante": {
        tier: 2,
        device: "Ablative Absolute",
        latin: "gloriante matre",
        effect: "The participle carries heavy moral weight: 'the mother boasting'. This grammatically subordinate phrase delivers the most damning accusation - Agrippina's shameless pride in incest."
    },
    "tradit": {
        tier: 3,
        device: "Source Citation",
        latin: "tradit Cluvius...Fabius Rusticus memorat",
        effect: "Tacitus names his sources explicitly, creating historiographical distance. By presenting competing versions, he appears objective while still transmitting the scandal - a technique of apparent neutrality."
    },
    "seu": {
        tier: 2,
        device: "Disjunctive Structure",
        latin: "seu concepit...seu credibilior",
        effect: "'Whether...or whether' - Tacitus refuses to choose between alternatives, but both options condemn Agrippina. The apparent fairness masks a rhetorical trap."
    },
    "tantum": {
        tier: 1,
        device: "Intensifying Genitive",
        latin: "tantum immanitatis",
        effect: "'Such great monstrosity' - the partitive genitive with tantum creates emphasis on the scale of Agrippina's moral perversion."
    },
    "fama": {
        tier: 3,
        device: "Authorial Distance",
        latin: "fama huc inclinat",
        effect: "Tacitus uses fama ('rumour') to pass judgment while maintaining plausible deniability. The passive 'inclines this way' allows him to condemn without taking direct responsibility."
    },
    "exercita": {
        tier: 2,
        device: "Military Metaphor",
        latin: "exercita ad omne flagitium",
        effect: "'Trained for every disgrace' - exercita uses military/athletic vocabulary for sexual degradation. Agrippina is portrayed as professionally skilled in vice, like a soldier drilled for battle."
    }
};

const resources = {
    summary: `<h4>Summary</h4>
<p>Tacitus presents conflicting historical accounts of alleged incest between Agrippina and Nero. According to Cluvius, Agrippina initiated the seduction when Nero was drunk at midday banquets. Seneca intervened by sending Acte to warn Nero about spreading rumours and potential military revolt.</p>
<p>Fabius Rusticus offers an alternative version where Nero initiated the incest, though Acte still prevented it. Tacitus notes most sources agree with Cluvius and adds Agrippina's sexual history as evidence: affairs with Lepidus and Pallas for power, and incestuous marriage to uncle Claudius.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>The Sources:</strong> Cluvius Rufus was a contemporary historian who likely knew the imperial family personally. Fabius Rusticus was Seneca's friend, explaining his version that exonerates Seneca's intervention.</p>
<p><strong>The Characters:</strong> Acte was a real freedwoman who had been Nero's mistress before Poppaea. Her low status makes her moral superiority over Agrippina particularly striking.</p>
<p><strong>Agrippina's Past:</strong> The references are historically attested: Marcus Lepidus was her brother-in-law with whom she allegedly conspired; Pallas was Claudius's powerful freedman secretary; her marriage to uncle Claudius required special senatorial dispensation as it violated Roman incest laws.</p>
<p><strong>Military Concern:</strong> The emphasis on soldiers' reaction shows where real power lay - moral authority ultimately depended on military support.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Lines 1-2:</strong> According to Cluvius, who initiated the alleged incest? When did Agrippina make her advances?</p>
<p><strong>Line 2:</strong> What physical signs did courtiers notice? What does "lasciva oscula et praenuntias flagitii blanditias" suggest?</p>
<p><strong>Lines 2-3:</strong> How did Seneca respond to the situation? What is ironic about his strategy?</p>
<p><strong>Line 3:</strong> What was Acte's role and status? What two dangers concerned her?</p>
<p><strong>Line 3:</strong> Why would soldiers not tolerate a "profani principis" rule? What does this reveal about the source of imperial legitimacy?</p>
<p><strong>Line 4:</strong> How does Fabius Rusticus's version differ from Cluvius's? What might explain this difference?</p>
<p><strong>Lines 5-6:</strong> Which version does Tacitus seem to favour? What evidence does he provide?</p>
<p><strong>Line 7:</strong> What three past relationships does Tacitus mention? What was the motive behind each?</p>
<p><strong>Overall:</strong> How does Tacitus present Agrippina in this passage? Is his approach objective or tendentious?</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;
let styleModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
        hideStylePopup();
    }
}

function toggleStyleMode() {
    styleModeActive = !styleModeActive;
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    // Update word classes for style highlighting
    document.querySelectorAll('.word').forEach(word => {
        const lookupWord = word.dataset.word.toLowerCase();
        if (styleModeActive && styleData[lookupWord]) {
            word.classList.add('style-tier' + styleData[lookupWord].tier);
        } else {
            word.classList.remove('style-tier1', 'style-tier2', 'style-tier3');
        }
    });

    if (!styleModeActive) {
        hideStylePopup();
    }

    // Hide vocab popup when entering style mode
    if (styleModeActive) {
        hidePopup();
    }
}

function showStylePopup(event, word) {
    const popup = document.getElementById('stylePopup');
    const data = styleData[word.toLowerCase()];

    if (!data) {
        popup.classList.remove('visible');
        return;
    }

    popup.innerHTML = `
        <div class="device">${data.device}</div>
        <div class="latin">${data.latin}</div>
        <div class="effect">${data.effect}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 340;
    const popupHeight = 180;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
    }

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.classList.add('visible');
}

function hideStylePopup() {
    const popup = document.getElementById('stylePopup');
    popup.classList.remove('visible');
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:]*|[.,;:]+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:]*)$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2];
                    const lookupWord = word.toLowerCase();
                    // Check if word has style data and add tier class if style mode is active
                    let tierClass = '';
                    if (styleModeActive && styleData[lookupWord]) {
                        tierClass = ' style-tier' + styleData[lookupWord].tier;
                    }
                    html += `<span class="word${tierClass}" data-word="${lookupWord}">${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else if (styleModeActive && styleData[this.dataset.word.toLowerCase()]) {
                // Show style popup for words with style data
                hidePopup();
                showStylePopup(e, this.dataset.word);
            } else {
                // Show vocab popup
                hideStylePopup();
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();
            hideStylePopup();

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
