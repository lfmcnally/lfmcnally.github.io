<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.4</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">The Invitation to Baiae</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.4</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 12</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>Ingenuity was decided upon, which was also helped by time, since (Nero) was visiting the festival of the Quinquatrus at Baiae. He enticed his mother there, repeatedly saying that the angry feelings of parents had to be put up with and any hostile feeling should be appeased, so that he might create a (false) report of reconciliation and Agrippina might receive it, since women readily believe in joyful events. Then as she came onto the shores (for she was coming from Antium), he met her, welcomed her with his hand and an embrace and escorted her to Bauli. That is the name of the villa which (lying) between Cape Misenum and the Baian lake, is washed by a bend in the sea. A more elaborate ship stood among the others, as if this, too, was to be given as an honour to his mother: for she had been accustomed to sail in a trireme and with oars pulled by marines. And then she had been invited to a banquet, so that darkness could be used to hide the crime. It was sufficiently well-known that an informer appeared, and when Agrippina heard of the plot, uncertain as to whether to believe it, was carried to Baiae by a sedan chair. There flattery alleviated her fear: she was graciously received and placed above (Nero) himself (at the table). Now with many conversations, now with youthful friendship, then again stern as if he was sharing serious topics, having dragged out the banquet for a long time, Nero escorted her as she departed, cleaving more closely to her eyes and her breast, whether because he was bolstering up his pretence or the last sight of his doomed mother repressed his feelings, however savage they were.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>

    <script>
const vocab = {
    "placuit": { lemma: "placeo, -ere, placui, placitum", parsing: "perf. act. ind. 3rd sing.", meaning: "it pleased, it was decided" },
    "sollertia": { lemma: "sollertia, -ae (f.)", parsing: "nom. sing.", meaning: "ingenuity, cleverness" },
    "tempore": { lemma: "tempus, temporis (n.)", parsing: "abl. sing.", meaning: "by time, by timing" },
    "etiam": { lemma: "etiam", parsing: "adverb", meaning: "also, even" },
    "iuta": { lemma: "iuvo, -are, iuvi, iutum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "helped, assisted" },
    "quando": { lemma: "quando", parsing: "conjunction", meaning: "since, because, when" },
    "Quinquatruum": { lemma: "Quinquatrus, -uum (m. pl.)", parsing: "gen. pl.", meaning: "of the Quinquatrus (festival of Minerva)" },
    "festos": { lemma: "festus, -a, -um", parsing: "acc. pl. masc.", meaning: "festival, festive" },
    "dies": { lemma: "dies, diei (m.)", parsing: "acc. pl.", meaning: "days" },
    "apud": { lemma: "apud", parsing: "preposition + acc.", meaning: "at, near, among" },
    "Baias": { lemma: "Baiae, -arum (f. pl.)", parsing: "acc. pl.", meaning: "Baiae (resort town near Naples)" },
    "frequentabat": { lemma: "frequento, -are, -avi, -atum", parsing: "imperf. act. ind. 3rd sing.", meaning: "he was visiting, he was frequenting" },
    "illuc": { lemma: "illuc", parsing: "adverb", meaning: "to that place, there" },
    "matrem": { lemma: "mater, matris (f.)", parsing: "acc. sing.", meaning: "mother" },
    "elicit": { lemma: "elicio, -ere, elicui, elicitum", parsing: "pres. act. ind. 3rd sing.", meaning: "he entices, he lures out" },
    "ferendas": { lemma: "fero, ferre, tuli, latum", parsing: "gerundive acc. pl. fem.", meaning: "(things) to be endured" },
    "parentium": { lemma: "parens, parentis (m./f.)", parsing: "gen. pl.", meaning: "of parents" },
    "iracundias": { lemma: "iracundia, -ae (f.)", parsing: "acc. pl.", meaning: "angry feelings, fits of temper" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and" },
    "placandum": { lemma: "placo, -are, -avi, -atum", parsing: "gerundive acc. sing. masc.", meaning: "to be appeased, to be calmed" },
    "animum": { lemma: "animus, -i (m.)", parsing: "acc. sing.", meaning: "spirit, hostile feeling, mind" },
    "dictitans": { lemma: "dictito, -are, -avi, -atum", parsing: "pres. act. part. nom. sing.", meaning: "repeatedly saying" },
    "quo": { lemma: "quo", parsing: "conjunction", meaning: "so that, in order that" },
    "rumorem": { lemma: "rumor, -oris (m.)", parsing: "acc. sing.", meaning: "rumour, report" },
    "reconciliationis": { lemma: "reconciliatio, -onis (f.)", parsing: "gen. sing.", meaning: "of reconciliation" },
    "efficeret": { lemma: "efficio, -ere, effeci, effectum", parsing: "imperf. subj. act. 3rd sing.", meaning: "he might create, he might bring about" },
    "acciperetque": { lemma: "accipio, -ere, accepi, acceptum + -que", parsing: "imperf. subj. act. 3rd sing. + and", meaning: "and she might receive" },
    "Agrippina": { lemma: "Agrippina, -ae (f.)", parsing: "nom. sing.", meaning: "Agrippina (Nero's mother)" },
    "facili": { lemma: "facilis, -e", parsing: "abl. sing. fem.", meaning: "easy, ready" },
    "feminarum": { lemma: "femina, -ae (f.)", parsing: "gen. pl.", meaning: "of women" },
    "credulitate": { lemma: "credulitas, -atis (f.)", parsing: "abl. sing.", meaning: "with credulity, with readiness to believe" },
    "ad": { lemma: "ad", parsing: "preposition + acc.", meaning: "to, towards, for" },
    "gaudia": { lemma: "gaudium, -i (n.)", parsing: "acc. pl.", meaning: "joys, joyful things" },
    "venientem": { lemma: "venio, -ire, veni, ventum", parsing: "pres. act. part. acc. fem. sing.", meaning: "(her) coming" },
    "dehinc": { lemma: "dehinc", parsing: "adverb", meaning: "then, next, thereafter" },
    "obvius": { lemma: "obvius, -a, -um", parsing: "nom. sing. masc.", meaning: "meeting, going to meet" },
    "in": { lemma: "in", parsing: "preposition + acc.", meaning: "into, onto, to" },
    "litora": { lemma: "litus, litoris (n.)", parsing: "acc. pl.", meaning: "shores, coast" },
    "nam": { lemma: "nam", parsing: "conjunction", meaning: "for" },
    "Antio": { lemma: "Antium, -i (n.)", parsing: "abl. sing.", meaning: "from Antium (coastal town)" },
    "adventabat": { lemma: "advento, -are, -avi, -atum", parsing: "imperf. act. ind. 3rd sing.", meaning: "she was coming, she was approaching" },
    "excepit": { lemma: "excipio, -ere, excepi, exceptum", parsing: "perf. act. ind. 3rd sing.", meaning: "he welcomed, he received" },
    "manu": { lemma: "manus, -us (f.)", parsing: "abl. sing.", meaning: "with (his) hand" },
    "complexu": { lemma: "complexus, -us (m.)", parsing: "abl. sing.", meaning: "with an embrace" },
    "ducitque": { lemma: "duco, -ere, duxi, ductum + -que", parsing: "pres. act. ind. 3rd sing. + and", meaning: "and he leads, and he escorts" },
    "Baulos": { lemma: "Bauli, -orum (m. pl.)", parsing: "acc. pl.", meaning: "to Bauli (villa near Baiae)" },
    "id": { lemma: "is, ea, id", parsing: "nom./acc. neut. sing.", meaning: "that, this, it" },
    "villae": { lemma: "villa, -ae (f.)", parsing: "gen. sing.", meaning: "of the villa" },
    "nomen": { lemma: "nomen, nominis (n.)", parsing: "nom. sing.", meaning: "name" },
    "est": { lemma: "sum, esse, fui", parsing: "pres. ind. 3rd sing.", meaning: "is" },
    "quae": { lemma: "qui, quae, quod", parsing: "rel. pron. nom. fem. sing.", meaning: "which" },
    "promunturium": { lemma: "promunturium, -i (n.)", parsing: "acc. sing.", meaning: "promontory, cape" },
    "Misenum": { lemma: "Misenum, -i (n.)", parsing: "acc. sing.", meaning: "Misenum (cape near Naples)" },
    "inter": { lemma: "inter", parsing: "preposition + acc.", meaning: "between, among" },
    "Baianum": { lemma: "Baianus, -a, -um", parsing: "acc. sing. masc.", meaning: "Baian, of Baiae" },
    "lacum": { lemma: "lacus, -us (m.)", parsing: "acc. sing.", meaning: "lake" },
    "flexo": { lemma: "flecto, -ere, flexi, flexum", parsing: "perf. pass. part. abl. neut. sing.", meaning: "bent, curved" },
    "mari": { lemma: "mare, maris (n.)", parsing: "abl. sing.", meaning: "by the sea" },
    "adluitur": { lemma: "adluo, -ere, adlui", parsing: "pres. pass. ind. 3rd sing.", meaning: "is washed" },
    "stabat": { lemma: "sto, stare, steti, statum", parsing: "imperf. act. ind. 3rd sing.", meaning: "was standing" },
    "alias": { lemma: "alius, -a, -ud", parsing: "acc. pl. fem.", meaning: "other, the others" },
    "navis": { lemma: "navis, -is (f.)", parsing: "nom. sing.", meaning: "ship" },
    "ornatior": { lemma: "ornatus, -a, -um", parsing: "comp. nom. sing. fem.", meaning: "more elaborate, more ornate" },
    "tamquam": { lemma: "tamquam", parsing: "conjunction", meaning: "as if, just as" },
    "quoque": { lemma: "quoque", parsing: "adverb", meaning: "also, too" },
    "honori": { lemma: "honor, -oris (m.)", parsing: "dat. sing.", meaning: "for honour, as an honour" },
    "matris": { lemma: "mater, matris (f.)", parsing: "gen. sing.", meaning: "of (his) mother" },
    "daretur": { lemma: "do, dare, dedi, datum", parsing: "imperf. subj. pass. 3rd sing.", meaning: "might be given" },
    "quippe": { lemma: "quippe", parsing: "adverb", meaning: "for indeed, naturally" },
    "sueverat": { lemma: "suesco, -ere, suevi, suetum", parsing: "pluperf. act. ind. 3rd sing.", meaning: "she had been accustomed" },
    "triremi": { lemma: "triremis, -is (f.)", parsing: "abl. sing.", meaning: "in a trireme (warship)" },
    "classiariorum": { lemma: "classiarius, -i (m.)", parsing: "gen. pl.", meaning: "of marines, of sailors" },
    "remigio": { lemma: "remigium, -i (n.)", parsing: "abl. sing.", meaning: "with rowing, with oars" },
    "vehi": { lemma: "veho, -ere, vexi, vectum", parsing: "pres. pass. inf.", meaning: "to be carried, to sail" },
    "ac": { lemma: "ac/atque", parsing: "conjunction", meaning: "and, and also" },
    "tum": { lemma: "tum", parsing: "adverb", meaning: "then, at that time" },
    "invitata": { lemma: "invito, -are, -avi, -atum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "having been invited" },
    "epulas": { lemma: "epulae, -arum (f. pl.)", parsing: "acc. pl.", meaning: "banquet, feast" },
    "erat": { lemma: "sum, esse, fui", parsing: "imperf. ind. 3rd sing.", meaning: "she was" },
    "ut": { lemma: "ut", parsing: "conjunction", meaning: "so that, in order that" },
    "occultando": { lemma: "occulto, -are, -avi, -atum", parsing: "gerund dat.", meaning: "for hiding" },
    "facinori": { lemma: "facinus, facinoris (n.)", parsing: "dat. sing.", meaning: "the crime" },
    "nox": { lemma: "nox, noctis (f.)", parsing: "nom. sing.", meaning: "night, darkness" },
    "adhiberetur": { lemma: "adhibeo, -ere, -ui, -itum", parsing: "imperf. subj. pass. 3rd sing.", meaning: "might be used, might be employed" },
    "satis": { lemma: "satis", parsing: "adverb", meaning: "sufficiently, enough" },
    "constitit": { lemma: "consto, -are, constiti", parsing: "perf. act. ind. 3rd sing.", meaning: "it is established, it is well-known" },
    "extitisse": { lemma: "exsisto, -ere, extiti", parsing: "perf. inf. act.", meaning: "to have appeared, to have emerged" },
    "proditorem": { lemma: "proditor, -oris (m.)", parsing: "acc. sing.", meaning: "informer, betrayer" },
    "Agrippinam": { lemma: "Agrippina, -ae (f.)", parsing: "acc. sing.", meaning: "Agrippina" },
    "auditis": { lemma: "audio, -ire, -ivi, -itum", parsing: "perf. pass. part. abl. pl.", meaning: "having been heard" },
    "insidiis": { lemma: "insidiae, -arum (f. pl.)", parsing: "abl. pl.", meaning: "the plot, the ambush" },
    "an": { lemma: "an", parsing: "conjunction", meaning: "whether" },
    "crederet": { lemma: "credo, -ere, credidi, creditum", parsing: "imperf. subj. act. 3rd sing.", meaning: "she should believe" },
    "ambiguam": { lemma: "ambiguus, -a, -um", parsing: "acc. sing. fem.", meaning: "uncertain, wavering, doubtful" },
    "gestamine": { lemma: "gestamen, -inis (n.)", parsing: "abl. sing.", meaning: "by carrying, by transport" },
    "sellae": { lemma: "sella, -ae (f.)", parsing: "gen. sing.", meaning: "of a chair, of a sedan chair" },
    "pervectam": { lemma: "perveho, -ere, pervexi, pervectum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "having been carried" },
    "ibi": { lemma: "ibi", parsing: "adverb", meaning: "there" },
    "blandimentum": { lemma: "blandimentum, -i (n.)", parsing: "nom. sing.", meaning: "flattery, cajolery" },
    "sublevavit": { lemma: "sublevo, -are, -avi, -atum", parsing: "perf. act. ind. 3rd sing.", meaning: "alleviated, relieved" },
    "metum": { lemma: "metus, -us (m.)", parsing: "acc. sing.", meaning: "fear" },
    "comiter": { lemma: "comiter", parsing: "adverb", meaning: "graciously, courteously" },
    "excepta": { lemma: "excipio, -ere, excepi, exceptum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "having been received" },
    "superque": { lemma: "super + -que", parsing: "preposition + and", meaning: "and above" },
    "ipsum": { lemma: "ipse, ipsa, ipsum", parsing: "acc. sing. masc.", meaning: "himself" },
    "conlocata": { lemma: "conloco, -are, -avi, -atum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "having been placed" },
    "iam": { lemma: "iam", parsing: "adverb", meaning: "now, already" },
    "pluribus": { lemma: "plus, pluris", parsing: "abl. pl.", meaning: "with many, with more" },
    "sermonibus": { lemma: "sermo, -onis (m.)", parsing: "abl. pl.", meaning: "conversations, discussions" },
    "modo": { lemma: "modo", parsing: "adverb", meaning: "now, at one moment" },
    "familiaritate": { lemma: "familiaritas, -atis (f.)", parsing: "abl. sing.", meaning: "with familiarity, with intimacy" },
    "iuvenili": { lemma: "iuvenilis, -e", parsing: "abl. sing. fem.", meaning: "youthful" },
    "Nero": { lemma: "Nero, -onis (m.)", parsing: "nom. sing.", meaning: "Nero" },
    "rursus": { lemma: "rursus", parsing: "adverb", meaning: "again, on the other hand" },
    "adductus": { lemma: "adduco, -ere, adduxi, adductum", parsing: "perf. pass. part. nom. sing. masc.", meaning: "stern, serious (lit. drawn tight)" },
    "quasi": { lemma: "quasi", parsing: "conjunction", meaning: "as if, as though" },
    "seria": { lemma: "serius, -a, -um", parsing: "acc. pl. neut.", meaning: "serious matters" },
    "consociaret": { lemma: "consocio, -are, -avi, -atum", parsing: "imperf. subj. act. 3rd sing.", meaning: "he was sharing" },
    "tracto": { lemma: "traho, -ere, traxi, tractum", parsing: "perf. pass. part. abl. sing.", meaning: "having been dragged out" },
    "longum": { lemma: "longus, -a, -um", parsing: "acc. sing. neut.", meaning: "long, for a long time" },
    "convictu": { lemma: "convictus, -us (m.)", parsing: "abl. sing.", meaning: "banquet, feast" },
    "prosequitur": { lemma: "prosequor, -i, prosecutus sum", parsing: "pres. dep. ind. 3rd sing.", meaning: "he escorts, he accompanies" },
    "abeuntem": { lemma: "abeo, -ire, -ivi, -itum", parsing: "pres. act. part. acc. fem. sing.", meaning: "(her) departing" },
    "artius": { lemma: "arte", parsing: "comp. adverb", meaning: "more closely, more tightly" },
    "oculis": { lemma: "oculus, -i (m.)", parsing: "dat. pl.", meaning: "to (her) eyes" },
    "pectori": { lemma: "pectus, pectoris (n.)", parsing: "dat. sing.", meaning: "to (her) breast" },
    "haerens": { lemma: "haereo, -ere, haesi, haesum", parsing: "pres. act. part. nom. sing.", meaning: "clinging, cleaving" },
    "sive": { lemma: "sive/seu", parsing: "conjunction", meaning: "whether, or if" },
    "explenda": { lemma: "expleo, -ere, explevi, expletum", parsing: "gerundive abl. fem. sing.", meaning: "needing to be completed" },
    "simulatione": { lemma: "simulatio, -onis (f.)", parsing: "abl. sing.", meaning: "by pretence, by simulation" },
    "seu": { lemma: "sive/seu", parsing: "conjunction", meaning: "or if, or whether" },
    "periturae": { lemma: "pereo, -ire, -ivi, -itum", parsing: "fut. act. part. gen. fem. sing.", meaning: "of (his) doomed, about to perish" },
    "supremus": { lemma: "supremus, -a, -um", parsing: "nom. sing. masc.", meaning: "last, final" },
    "aspectus": { lemma: "aspectus, -us (m.)", parsing: "nom. sing.", meaning: "sight, view" },
    "quamvis": { lemma: "quamvis", parsing: "conjunction", meaning: "although, however much" },
    "ferum": { lemma: "ferus, -a, -um", parsing: "acc. sing. masc.", meaning: "savage, wild, fierce" },
    "retinebat": { lemma: "retineo, -ere, retinui, retentum", parsing: "imperf. act. ind. 3rd sing.", meaning: "was holding back, was restraining" }
};

const latinSentences = [
    "placuit sollertia, tempore etiam iuta, quando Quinquatruum festos dies apud Baias frequentabat.",
    "illuc matrem elicit, ferendas parentium iracundias et placandum animum dictitans",
    "quo rumorem reconciliationis efficeret acciperetque Agrippina facili feminarum credulitate ad gaudia.",
    "venientem dehinc obvius in litora (nam Antio adventabat) excepit manu et complexu ducitque Baulos.",
    "id villae nomen est quae promunturium Misenum inter et Baianum lacum flexo mari adluitur.",
    "stabat inter alias navis ornatior, tamquam id quoque honori matris daretur:",
    "quippe sueverat triremi et classiariorum remigio vehi.",
    "ac tum invitata ad epulas erat ut occultando facinori nox adhiberetur.",
    "satis constitit extitisse proditorem et Agrippinam auditis insidiis, an crederet ambiguam, gestamine sellae Baias pervectam.",
    "ibi blandimentum sublevavit metum: comiter excepta superque ipsum conlocata.",
    "iam pluribus sermonibus modo familiaritate iuvenili Nero et rursus adductus, quasi seria consociaret, tracto in longum convictu, prosequitur abeuntem,",
    "artius oculis et pectori haerens, sive explenda simulatione, seu periturae matris supremus aspectus quamvis ferum animum retinebat."
];

const resources = {
    summary: `<h4>Summary</h4>
<p>In this passage, Tacitus describes the elaborate deception Nero orchestrates to lure his mother Agrippina to her death. The timing is carefully chosen: the Quinquatrus festival at Baiae provides both cover and opportunity. Nero entices Agrippina with repeated assurances that parents' anger must be endured and hostile feelings appeased, creating a public impression of reconciliation.</p>
<p>The greeting scene on the shore drips with false affection‚ÄîNero welcomes her with outstretched hand and embrace, then leads her to the villa at Bauli. Among the ships stands one conspicuously more elaborate, ostensibly an honour for the emperor's mother but actually the murder weapon. A banquet is arranged specifically so that darkness can conceal the crime.</p>
<p>Tacitus notes that an informer warned Agrippina of the plot, leaving her uncertain whether to believe it. Despite her doubts, she proceeds to Baiae by sedan chair. Flattery dispels her fears: she is graciously received and seated in the place of honour above Nero himself. Throughout the long banquet, Nero performs shifting moods‚Äîyouthful warmth alternating with grave seriousness‚Äîbefore escorting his departing mother with an embrace of ambiguous meaning: either the final touch of his performance, or genuine emotion at the last sight of the mother he is about to kill.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>The Quinquatrus Festival:</strong> A five-day festival in honour of Minerva (19-23 March), the Quinquatrus was a time of celebration and relaxation. Nero's choice of this occasion for matricide is significant‚Äîsacred time becomes the setting for the ultimate crime. The festival atmosphere also helps explain why Agrippina might lower her guard.</p>
<p><strong>Baiae as Setting:</strong> Baiae was Rome's most fashionable resort, a place of luxury and pleasure on the Bay of Naples. Its association with relaxation and indulgence makes it an ironic setting for murder. The geography matters too: the sea provides both the murder weapon (the collapsible ship) and the escape route.</p>
<p><strong>The Collapsible Ship:</strong> Nero's freedman Anicetus, prefect of the fleet at Misenum, designed a ship whose deck would collapse, dropping the passengers into the sea while appearing to be an accident. The "ornatior" (more elaborate) decoration concealed the deadly mechanism.</p>
<p><strong>Dissimulatio:</strong> The concept of dissimulatio (concealing true feelings through performance) was central to Roman political life. Tacitus shows both Nero and Agrippina as masters of this art‚Äîhe performing filial devotion, she ignoring warnings through willful belief in reconciliation. The scene becomes a dance of mutual deception.</p>
<p><strong>The Final Embrace:</strong> Tacitus deliberately leaves ambiguous whether Nero's intense farewell embrace represents the completion of his performance or a moment of genuine emotion. This psychological complexity is characteristic of Tacitean historiography‚Äîeven matricide doesn't preclude complicated feelings.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Lines 1-2:</strong> What does "placuit sollertia" tell us about how Tacitus presents the murder plan? Why might he make "sollertia" the grammatical subject?</p>
<p><strong>Line 2:</strong> How does "dictitans" (repeatedly saying) characterise Nero's behaviour? What does the frequentative form suggest about his psychological state?</p>
<p><strong>Line 3:</strong> What is the significance of "rumorem reconciliationis"? Why does Tacitus use "rumor" rather than simply "reconciliatio"?</p>
<p><strong>Lines 3-4:</strong> How does Tacitus present Agrippina's susceptibility in "facili feminarum credulitate ad gaudia"? Is this straightforward misogyny or more complex characterisation?</p>
<p><strong>Lines 4-5:</strong> What do the physical gestures "manu et complexu" reveal about the nature of Nero's deception?</p>
<p><strong>Lines 6-7:</strong> Why does Tacitus include the detail about Agrippina's normal mode of travel ("triremi et classiariorum remigio vehi")? What contrast does this create?</p>
<p><strong>Line 8:</strong> What is the effect of personifying night in "ut occultando facinori nox adhiberetur"? How does this grammatical choice affect our perception of the conspiracy?</p>
<p><strong>Lines 9-10:</strong> What does "an crederet ambiguam" reveal about Agrippina's state of mind? Why does she proceed despite the warning?</p>
<p><strong>Lines 11-12:</strong> How does Tacitus use "modo...rursus...quasi" to characterise Nero's behaviour at the banquet? What does this variatio suggest?</p>
<p><strong>Lines 12-13:</strong> What is the significance of the unresolved "sive...seu" construction in the final sentence? Why does Tacitus refuse to tell us Nero's true motivation?</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
    }
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:()]*|[.,;:()]+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:()]*)$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2];
                    const lookupWord = word.toLowerCase();
                    html += `<span class="word" data-word="${lookupWord}">${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else {
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
