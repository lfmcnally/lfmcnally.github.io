<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.8</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">The Murder of Agrippina</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.8</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 12</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>Meanwhile, when the danger to Agrippina became widely known, as if it had happened by chance, as each person had heard about it, they ran down to the shore. Some climbed onto the projecting moles, others the nearest boats; others waded into the sea as far as their body allowed; certain people stretched out their hands; the whole shore was filled with complaints, prayers, and the shouting of people repeatedly asking different things or giving uncertain replies; a huge crowd flocked to the scene with torches, and when it became generally known that she was safe, they prepared as if to give thanks, until they were scattered by the sight of an armed and threatening column of soldiers. Anicetus surrounded the villa with sentries, and having broken open the door, dragged aside those slaves who got in his way, until he reached the doors of the bedroom; few stood near it, the rest were scared stiff by dread of those bursting in. There was a modest light in the bedroom and one of the maids, while Agrippina was more and more anxious because no one had come from her son, not even Agerinus: the appearance of a happy event would be different; as it was, now there was solitude, sudden noises and signs of utmost calamity. Then, as the maid was leaving, having declared "Are you also deserting me?", she looked around at Anicetus, accompanied by Herculeius, captain of a trireme, and the marine centurion Obaritus: and so, if he had come to visit, he should take back the news that she had recovered, but if he had come to commit an outrage, she believed nothing about her son; matricide had not been ordered. The assassins surrounded the bed, and the trireme captain was the first to strike her head with a club. Then, as the centurion drew his sword for the death blow, stretching out her womb, she shouted "Strike my belly!" and was finished off with many wounds.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>

    <script>
const vocab = {
    "interim": { lemma: "interim", parsing: "adverb", meaning: "meanwhile, in the meantime" },
    "vulgato": { lemma: "vulgo, -are, -avi, -atum", parsing: "perf. pass. part. abl. neut. sing.", meaning: "having become known, spread abroad" },
    "agrippinae": { lemma: "Agrippina, -ae (f.)", parsing: "gen. sing.", meaning: "of Agrippina" },
    "periculo": { lemma: "periculum, -i (n.)", parsing: "abl. sing.", meaning: "danger" },
    "quasi": { lemma: "quasi", parsing: "adverb/conjunction", meaning: "as if, as though" },
    "casu": { lemma: "casus, -us (m.)", parsing: "abl. sing.", meaning: "by chance, by accident" },
    "evenisset": { lemma: "evenio, -ire, eveni, eventum", parsing: "pluperf. subj. act. 3rd sing.", meaning: "it had happened, had occurred" },
    "ut": { lemma: "ut", parsing: "conjunction", meaning: "as, when; so that, in order that" },
    "quisque": { lemma: "quisque, quaeque, quidque", parsing: "nom. sing.", meaning: "each person, everyone" },
    "acceperat": { lemma: "accipio, -ere, accepi, acceptum", parsing: "pluperf. act. ind. 3rd sing.", meaning: "had heard, had received" },
    "decurrere": { lemma: "decurro, -ere, decurri, decursum", parsing: "pres. inf. act. (historic)", meaning: "to run down" },
    "ad": { lemma: "ad", parsing: "preposition + acc.", meaning: "to, towards" },
    "litus": { lemma: "litus, litoris (n.)", parsing: "acc. sing.", meaning: "shore, coast" },
    "hi": { lemma: "hic, haec, hoc", parsing: "nom. pl. masc.", meaning: "these, some" },
    "molium": { lemma: "moles, -is (f.)", parsing: "gen. pl.", meaning: "of moles, of piers" },
    "obiectus": { lemma: "obiectus, -us (m.)", parsing: "acc. pl.", meaning: "projections, things placed in the way" },
    "proximas": { lemma: "proximus, -a, -um", parsing: "acc. pl. fem.", meaning: "nearest" },
    "scaphas": { lemma: "scapha, -ae (f.)", parsing: "acc. pl.", meaning: "boats, skiffs" },
    "scandere": { lemma: "scando, -ere, scandi, scansum", parsing: "pres. inf. act. (historic)", meaning: "to climb" },
    "alii": { lemma: "alius, alia, aliud", parsing: "nom. pl. masc.", meaning: "others" },
    "quantum": { lemma: "quantum", parsing: "adverb", meaning: "as far as, as much as" },
    "corpus": { lemma: "corpus, corporis (n.)", parsing: "nom. sing.", meaning: "body" },
    "sinebat": { lemma: "sino, -ere, sivi, situm", parsing: "imperf. act. ind. 3rd sing.", meaning: "allowed, permitted" },
    "vadere": { lemma: "vado, -ere", parsing: "pres. inf. act. (historic)", meaning: "to go, to wade" },
    "in": { lemma: "in", parsing: "preposition + acc./abl.", meaning: "into, in; for" },
    "mare": { lemma: "mare, maris (n.)", parsing: "acc. sing.", meaning: "sea" },
    "quidam": { lemma: "quidam, quaedam, quoddam", parsing: "nom. pl. masc.", meaning: "certain people, some" },
    "manus": { lemma: "manus, -us (f.)", parsing: "acc. pl.", meaning: "hands" },
    "protendere": { lemma: "protendo, -ere, -tendi, -tentum", parsing: "pres. inf. act. (historic)", meaning: "to stretch out, extend" },
    "questibus": { lemma: "questus, -us (m.)", parsing: "abl. pl.", meaning: "with complaints, laments" },
    "votis": { lemma: "votum, -i (n.)", parsing: "abl. pl.", meaning: "with prayers, vows" },
    "clamore": { lemma: "clamor, -oris (m.)", parsing: "abl. sing.", meaning: "with shouting" },
    "diversa": { lemma: "diversus, -a, -um", parsing: "acc. pl. neut.", meaning: "different things" },
    "rogitantium": { lemma: "rogito, -are, -avi, -atum", parsing: "pres. act. part. gen. pl.", meaning: "of those asking repeatedly" },
    "aut": { lemma: "aut", parsing: "conjunction", meaning: "or" },
    "incerta": { lemma: "incertus, -a, -um", parsing: "acc. pl. neut.", meaning: "uncertain things" },
    "respondentium": { lemma: "respondeo, -ere, respondi, responsum", parsing: "pres. act. part. gen. pl.", meaning: "of those replying" },
    "omnis": { lemma: "omnis, -e", parsing: "acc. sing. fem.", meaning: "all, whole" },
    "ora": { lemma: "ora, -ae (f.)", parsing: "acc. sing.", meaning: "shore, coast" },
    "compleri": { lemma: "compleo, -ere, -plevi, -pletum", parsing: "pres. pass. inf.", meaning: "to be filled" },
    "adfluere": { lemma: "adfluo, -ere, adfluxi", parsing: "pres. inf. act. (historic)", meaning: "to flow to, flock" },
    "ingens": { lemma: "ingens, ingentis", parsing: "nom. sing.", meaning: "huge, vast" },
    "multitudo": { lemma: "multitudo, -inis (f.)", parsing: "nom. sing.", meaning: "crowd, multitude" },
    "cum": { lemma: "cum", parsing: "preposition + abl.", meaning: "with" },
    "luminibus": { lemma: "lumen, luminis (n.)", parsing: "abl. pl.", meaning: "with torches, lights" },
    "atque": { lemma: "atque", parsing: "conjunction", meaning: "and, and also" },
    "ubi": { lemma: "ubi", parsing: "conjunction", meaning: "when, where" },
    "incolumem": { lemma: "incolumis, -e", parsing: "acc. sing.", meaning: "safe, unharmed" },
    "esse": { lemma: "sum, esse, fui", parsing: "pres. inf.", meaning: "to be" },
    "pernotuit": { lemma: "pernotesco, -ere, pernotui", parsing: "perf. act. ind. 3rd sing.", meaning: "it became widely known" },
    "gratandum": { lemma: "grator, -ari, -atus sum", parsing: "gerund acc.", meaning: "giving thanks, congratulating" },
    "sese": { lemma: "sui, sibi, se", parsing: "acc. reflexive (emphatic)", meaning: "themselves" },
    "expedire": { lemma: "expedio, -ire, -ivi, -itum", parsing: "pres. inf. act.", meaning: "to prepare, get ready" },
    "donec": { lemma: "donec", parsing: "conjunction", meaning: "until" },
    "aspectu": { lemma: "aspectus, -us (m.)", parsing: "abl. sing.", meaning: "by the sight" },
    "armati": { lemma: "armatus, -a, -um", parsing: "gen. sing. masc.", meaning: "armed" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and" },
    "minitantis": { lemma: "minitor, -ari, -atus sum", parsing: "pres. part. gen. sing.", meaning: "threatening" },
    "agminis": { lemma: "agmen, agminis (n.)", parsing: "gen. sing.", meaning: "of a column, of a troop" },
    "disiecti": { lemma: "disicio, -ere, disieci, disiectum", parsing: "perf. pass. part. nom. pl.", meaning: "scattered, dispersed" },
    "sunt": { lemma: "sum, esse, fui", parsing: "pres. act. ind. 3rd pl.", meaning: "they are, they were" },
    "anicetus": { lemma: "Anicetus, -i (m.)", parsing: "nom. sing.", meaning: "Anicetus (freedman, admiral)" },
    "villam": { lemma: "villa, -ae (f.)", parsing: "acc. sing.", meaning: "villa" },
    "statione": { lemma: "statio, -onis (f.)", parsing: "abl. sing.", meaning: "with guards, a station" },
    "circumdat": { lemma: "circumdo, -are, -dedi, -datum", parsing: "pres. act. ind. 3rd sing.", meaning: "surrounds" },
    "refracta": { lemma: "refringo, -ere, refregi, refractum", parsing: "perf. pass. part. abl. fem. sing.", meaning: "broken open" },
    "que": { lemma: "-que", parsing: "enclitic conjunction", meaning: "and" },
    "ianua": { lemma: "ianua, -ae (f.)", parsing: "abl. sing.", meaning: "door" },
    "obvios": { lemma: "obvius, -a, -um", parsing: "acc. pl. masc.", meaning: "in the way, meeting" },
    "servorum": { lemma: "servus, -i (m.)", parsing: "gen. pl.", meaning: "of slaves" },
    "abripit": { lemma: "abripio, -ere, abripui, abreptum", parsing: "pres. act. ind. 3rd sing.", meaning: "drags away, snatches" },
    "fores": { lemma: "fores, -ium (f. pl.)", parsing: "acc. pl.", meaning: "doors" },
    "cubiculi": { lemma: "cubiculum, -i (n.)", parsing: "gen. sing.", meaning: "of the bedroom" },
    "veniret": { lemma: "venio, -ire, veni, ventum", parsing: "imperf. subj. act. 3rd sing.", meaning: "he came, he might come" },
    "cui": { lemma: "qui, quae, quod", parsing: "dat. sing.", meaning: "to which" },
    "pauci": { lemma: "paucus, -a, -um", parsing: "nom. pl. masc.", meaning: "few" },
    "adstabant": { lemma: "adsto, -are, adstiti", parsing: "imperf. act. ind. 3rd pl.", meaning: "were standing near" },
    "ceteris": { lemma: "ceteri, -ae, -a", parsing: "abl. pl.", meaning: "the rest" },
    "terrore": { lemma: "terror, -oris (m.)", parsing: "abl. sing.", meaning: "by terror, dread" },
    "inrumpentium": { lemma: "inrumpo, -ere, inrupi, inruptum", parsing: "pres. act. part. gen. pl.", meaning: "of those bursting in" },
    "exterritis": { lemma: "exterreo, -ere, -ui, -itum", parsing: "perf. pass. part. abl. pl.", meaning: "terrified" },
    "cubiculo": { lemma: "cubiculum, -i (n.)", parsing: "dat. sing.", meaning: "in the bedroom" },
    "modicum": { lemma: "modicus, -a, -um", parsing: "nom. neut. sing.", meaning: "modest, moderate" },
    "lumen": { lemma: "lumen, luminis (n.)", parsing: "nom. sing.", meaning: "light" },
    "inerat": { lemma: "insum, inesse, infui", parsing: "imperf. act. ind. 3rd sing.", meaning: "was in, was present" },
    "ancillarum": { lemma: "ancilla, -ae (f.)", parsing: "gen. pl.", meaning: "of maids" },
    "una": { lemma: "unus, -a, -um", parsing: "nom. fem. sing.", meaning: "one" },
    "magis": { lemma: "magis", parsing: "adverb", meaning: "more" },
    "ac": { lemma: "ac / atque", parsing: "conjunction", meaning: "and" },
    "anxia": { lemma: "anxius, -a, -um", parsing: "nom. fem. sing.", meaning: "anxious, worried" },
    "agrippina": { lemma: "Agrippina, -ae (f.)", parsing: "nom. sing.", meaning: "Agrippina" },
    "quod": { lemma: "quod", parsing: "conjunction", meaning: "because, that" },
    "nemo": { lemma: "nemo, neminis", parsing: "nom. sing.", meaning: "no one" },
    "a": { lemma: "a / ab", parsing: "preposition + abl.", meaning: "from" },
    "filio": { lemma: "filius, -i (m.)", parsing: "abl. sing.", meaning: "from her son" },
    "ne": { lemma: "ne", parsing: "adverb", meaning: "not even (with quidem)" },
    "agerinus": { lemma: "Agerinus, -i (m.)", parsing: "nom. sing.", meaning: "Agerinus (freedman)" },
    "quidem": { lemma: "quidem", parsing: "adverb", meaning: "indeed, even (with ne)" },
    "aliam": { lemma: "alius, alia, aliud", parsing: "acc. fem. sing.", meaning: "different, another" },
    "fore": { lemma: "sum, esse, fui", parsing: "fut. inf.", meaning: "would be" },
    "laetae": { lemma: "laetus, -a, -um", parsing: "gen. fem. sing.", meaning: "of a happy" },
    "rei": { lemma: "res, rei (f.)", parsing: "gen. sing.", meaning: "event, matter" },
    "faciem": { lemma: "facies, -ei (f.)", parsing: "acc. sing.", meaning: "appearance, face" },
    "nunc": { lemma: "nunc", parsing: "adverb", meaning: "now" },
    "solitudinem": { lemma: "solitudo, -inis (f.)", parsing: "acc. sing.", meaning: "solitude, loneliness" },
    "repentinos": { lemma: "repentinus, -a, -um", parsing: "acc. pl. masc.", meaning: "sudden" },
    "strepitus": { lemma: "strepitus, -us (m.)", parsing: "acc. pl.", meaning: "noises" },
    "extremi": { lemma: "extremus, -a, -um", parsing: "gen. neut. sing.", meaning: "of the utmost, final" },
    "mali": { lemma: "malum, -i (n.)", parsing: "gen. sing.", meaning: "of evil, calamity" },
    "indicia": { lemma: "indicium, -i (n.)", parsing: "acc. pl.", meaning: "signs, indications" },
    "abeunte": { lemma: "abeo, abire, abii, abitum", parsing: "pres. act. part. abl. fem. sing.", meaning: "leaving" },
    "dehinc": { lemma: "dehinc", parsing: "adverb", meaning: "then, next" },
    "ancilla": { lemma: "ancilla, -ae (f.)", parsing: "abl. sing.", meaning: "maid" },
    "tu": { lemma: "tu", parsing: "nom. sing.", meaning: "you" },
    "quoque": { lemma: "quoque", parsing: "adverb", meaning: "also, too" },
    "me": { lemma: "ego", parsing: "acc. sing.", meaning: "me" },
    "deseris": { lemma: "desero, -ere, deserui, desertum", parsing: "pres. act. ind. 2nd sing.", meaning: "you desert, abandon" },
    "prolocuta": { lemma: "proloquor, -loqui, -locutus sum", parsing: "perf. dep. part. nom. fem. sing.", meaning: "having spoken, declared" },
    "respicit": { lemma: "respicio, -ere, respexi, respectum", parsing: "pres. act. ind. 3rd sing.", meaning: "looks back at, regards" },
    "anicetum": { lemma: "Anicetus, -i (m.)", parsing: "acc. sing.", meaning: "Anicetus" },
    "trierarcho": { lemma: "trierarchus, -i (m.)", parsing: "abl. sing.", meaning: "with the trireme captain" },
    "herculeio": { lemma: "Herculeius, -i (m.)", parsing: "abl. sing.", meaning: "Herculeius (proper name)" },
    "obarito": { lemma: "Obaritus, -i (m.)", parsing: "abl. sing.", meaning: "Obaritus (proper name)" },
    "centurione": { lemma: "centurio, -onis (m.)", parsing: "abl. sing.", meaning: "centurion" },
    "classiario": { lemma: "classiarius, -a, -um", parsing: "abl. sing. masc.", meaning: "marine, naval" },
    "comitatum": { lemma: "comitor, -ari, -atus sum", parsing: "perf. pass. part. acc. masc. sing.", meaning: "accompanied" },
    "si": { lemma: "si", parsing: "conjunction", meaning: "if" },
    "visendum": { lemma: "viso, -ere, visi, visum", parsing: "gerund acc.", meaning: "visiting" },
    "venisset": { lemma: "venio, -ire, veni, ventum", parsing: "pluperf. subj. act. 3rd sing.", meaning: "he had come" },
    "refotam": { lemma: "refoveo, -ere, refovi, refotum", parsing: "perf. pass. part. acc. fem. sing.", meaning: "recovered, revived" },
    "nuntiaret": { lemma: "nuntio, -are, -avi, -atum", parsing: "imperf. subj. act. 3rd sing.", meaning: "he should report" },
    "sin": { lemma: "sin", parsing: "conjunction", meaning: "but if" },
    "facinus": { lemma: "facinus, -oris (n.)", parsing: "acc. sing.", meaning: "crime, outrage" },
    "patraturus": { lemma: "patro, -are, -avi, -atum", parsing: "fut. act. part. nom. masc. sing.", meaning: "about to commit" },
    "nihil": { lemma: "nihil", parsing: "acc. (indecl.)", meaning: "nothing" },
    "se": { lemma: "sui, sibi, se", parsing: "acc. reflexive", meaning: "herself" },
    "de": { lemma: "de", parsing: "preposition + abl.", meaning: "about, concerning" },
    "credere": { lemma: "credo, -ere, credidi, creditum", parsing: "pres. inf. act.", meaning: "to believe" },
    "non": { lemma: "non", parsing: "adverb", meaning: "not" },
    "imperatum": { lemma: "impero, -are, -avi, -atum", parsing: "perf. pass. part. acc. neut. sing.", meaning: "ordered, commanded" },
    "parricidium": { lemma: "parricidium, -i (n.)", parsing: "acc. sing.", meaning: "parent-murder, matricide" },
    "circumsistunt": { lemma: "circumsisto, -ere, circumsteti", parsing: "pres. act. ind. 3rd pl.", meaning: "they surround" },
    "lectum": { lemma: "lectus, -i (m.)", parsing: "acc. sing.", meaning: "bed, couch" },
    "percussores": { lemma: "percussor, -oris (m.)", parsing: "nom. pl.", meaning: "assassins, killers" },
    "prior": { lemma: "prior, prius", parsing: "nom. masc. sing.", meaning: "first, former" },
    "trierarchus": { lemma: "trierarchus, -i (m.)", parsing: "nom. sing.", meaning: "trireme captain" },
    "fusti": { lemma: "fustis, -is (m.)", parsing: "abl. sing.", meaning: "with a club" },
    "caput": { lemma: "caput, capitis (n.)", parsing: "acc. sing.", meaning: "head" },
    "eius": { lemma: "is, ea, id", parsing: "gen. sing.", meaning: "her" },
    "adflixit": { lemma: "adfligo, -ere, adflixi, adflictum", parsing: "perf. act. ind. 3rd sing.", meaning: "struck, dashed" },
    "iam": { lemma: "iam", parsing: "adverb", meaning: "now, already" },
    "mortem": { lemma: "mors, mortis (f.)", parsing: "acc. sing.", meaning: "death" },
    "centurioni": { lemma: "centurio, -onis (m.)", parsing: "dat. sing.", meaning: "to the centurion" },
    "ferrum": { lemma: "ferrum, -i (n.)", parsing: "acc. sing.", meaning: "sword, iron" },
    "destringenti": { lemma: "destringo, -ere, destrinxi, destrictum", parsing: "pres. act. part. dat. masc. sing.", meaning: "drawing (a sword)" },
    "protendens": { lemma: "protendo, -ere, -tendi, -tentum", parsing: "pres. act. part. nom. fem. sing.", meaning: "stretching out, offering" },
    "uterum": { lemma: "uterus, -i (m.)", parsing: "acc. sing.", meaning: "womb, belly" },
    "ventrem": { lemma: "venter, ventris (m.)", parsing: "acc. sing.", meaning: "belly, stomach" },
    "feri": { lemma: "ferio, -ire", parsing: "pres. imper. act. 2nd sing.", meaning: "strike!" },
    "exclamavit": { lemma: "exclamo, -are, -avi, -atum", parsing: "perf. act. ind. 3rd sing.", meaning: "shouted, cried out" },
    "multis": { lemma: "multus, -a, -um", parsing: "abl. pl.", meaning: "with many" },
    "vulneribus": { lemma: "vulnus, vulneris (n.)", parsing: "abl. pl.", meaning: "wounds" },
    "confecta": { lemma: "conficio, -ere, confeci, confectum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "finished off, killed" },
    "est": { lemma: "sum, esse, fui", parsing: "pres. act. ind. 3rd sing.", meaning: "was" }
};

const latinSentences = [
    "interim vulgato Agrippinae periculo, quasi casu evenisset, ut quisque acceperat, decurrere ad litus.",
    "hi molium obiectus, hi proximas scaphas scandere; alii quantum corpus sinebat vadere in mare; quidam manus protendere;",
    "questibus, votis, clamore diversa rogitantium aut incerta respondentium omnis ora compleri;",
    "adfluere ingens multitudo cum luminibus, atque ubi incolumem esse pernotuit, ut ad gratandum sese expedire, donec aspectu armati et minitantis agminis disiecti sunt.",
    "Anicetus villam statione circumdat refractaque ianua obvios servorum abripit, donec ad fores cubiculi veniret;",
    "cui pauci adstabant, ceteris terrore inrumpentium exterritis.",
    "cubiculo modicum lumen inerat et ancillarum una, magis ac magis anxia Agrippina quod nemo a filio ac ne Agerinus quidem:",
    "aliam fore laetae rei faciem; nunc solitudinem ac repentinos strepitus et extremi mali indicia.",
    "abeunte dehinc ancilla 'tu quoque me deseris' prolocuta respicit Anicetum trierarcho Herculeio et Obarito centurione classiario comitatum:",
    "ac, si ad visendum venisset, refotam nuntiaret, sin facinus patraturus, nihil se de filio credere; non imperatum parricidium.",
    "circumsistunt lectum percussores et prior trierarchus fusti caput eius adflixit.",
    "iam in mortem centurioni ferrum destringenti protendens uterum 'ventrem feri' exclamavit multisque vulneribus confecta est."
];

const resources = {
    summary: `<h4>Summary</h4>
<p>In this climactic passage, news of Agrippina's "accident" spreads rapidly through Baiae. The public response is overwhelming‚Äîcrowds rush to the shore with desperate concern, some climbing piers, others wading into the sea, stretching out hands in concern. The shore fills with prayers, questions, and confusion as people bring torches to search for survivors. When word spreads that she's alive, they prepare thanksgiving celebrations, showing genuine popular support for the emperor's mother.</p>
<p>But this touching scene is brutally shattered when Anicetus arrives with soldiers who disperse the crowds and surround her villa. Inside, the assault is methodical and violent. The door is smashed, slaves dragged aside as they try to protect their mistress. Agrippina waits in her bedroom with dim lighting and only a single maid, growing increasingly anxious as no messenger comes from Nero‚Äînot even her trusted freedman Agerinus returns. She understands the terrible truth: "A happy outcome would look different."</p>
<p>When even her maid tries to flee, Agrippina's plaintive "You too are deserting me?" captures her complete abandonment. When Anicetus enters with his officers, Agrippina makes one final attempt to maintain dignity. She tells them that if they've come to check on her welfare, they should report her recovery; if they've come to commit murder, she refuses to believe it's on Nero's orders. The assassins respond with brutal efficiency: first a club blow to her head, then as the centurion draws his sword for the killing blow, Agrippina defiantly offers her belly, shouting "Strike my womb!"‚Äîthe very womb that bore her son. She dies from multiple wounds.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>The Setting - Baiae:</strong> Baiae was a fashionable Roman resort town on the Bay of Naples, densely populated with villas of the wealthy elite. Its compact nature explains how news travelled so rapidly and crowds could gather quickly. The stone piers (moles) extending into the bay and small boats (scaphae) were typical coastal infrastructure. Romans bringing torches (lumina) for night searching reflects both practical necessity and traditional mourning rituals.</p>
<p><strong>Military Response:</strong> The brutal military response to civilian concern was standard Roman crowd control‚Äîimperial forces showed no hesitation in using violence against unarmed citizens when state security was involved. Agrippina's bedroom security detail abandoning her reveals how quickly loyalty evaporates when imperial favour shifts.</p>
<p><strong>The Assassins:</strong> Anicetus was admiral of the fleet at Misenum, making him a senior military officer. His companions Herculeius (trireme captain) and Obaritus (marine centurion) represent different naval ranks participating in the assassination. The use of multiple weapons‚Äîclub and sword‚Äîwith multiple wounds was standard military practice to ensure death and distribute responsibility among the killers.</p>
<p><strong>Agrippina's Final Words:</strong> Her command to strike her womb connects to ancient beliefs about maternal curses and the sanctity of motherhood. By commanding them to strike the source of Nero's existence, she transforms her murder into a symbolic assault on the very principle of filial duty that underpinned Roman society. The term "parricidium" she uses is the specific legal term for killing a parent‚Äîthe worst crime in Roman law.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Lines 1-2:</strong> How does the crowd respond when they hear about Agrippina's danger? What different actions do various people take?</p>
<p><strong>Line 3:</strong> What sounds fill the shore? What does "diversa rogitantium aut incerta respondentium" tell us about the atmosphere?</p>
<p><strong>Line 4:</strong> How does the mood change when people learn Agrippina is safe? What interrupts their celebration?</p>
<p><strong>Lines 5-6:</strong> Describe how Anicetus approaches Agrippina's room. What happens to the slaves and servants?</p>
<p><strong>Lines 7-8:</strong> What makes Agrippina "magis ac magis anxia"? What does she recognise about the situation?</p>
<p><strong>Line 9:</strong> What is the significance of Agrippina's words "tu quoque me deseris"? Who accompanies Anicetus?</p>
<p><strong>Line 10:</strong> What two possibilities does Agrippina offer the assassins? What does she refuse to believe about her son?</p>
<p><strong>Lines 11-12:</strong> Describe the actual murder. Why does Agrippina command "ventrem feri"? What is the symbolic significance of this command?</p>
<p><strong>Overall:</strong> How does Tacitus build tension throughout this passage? What contrast exists between the public's response and the private assassination?</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
    }
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:']*|[.,;:']+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:'"]*)$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2];
                    const lookupWord = word.toLowerCase();
                    html += `<span class="word" data-word="${lookupWord}">${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else {
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
