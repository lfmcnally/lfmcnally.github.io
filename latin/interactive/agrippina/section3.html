<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.3</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        /* Style highlighting */
        .word.style-tier1 { border-bottom: 2px solid #f0c040; }
        .word.style-tier2 { border-bottom: 2px solid #38b2ac; }
        .word.style-tier3 { border-bottom: 2px solid #9f7aea; }
        .word.style-tier1:hover, .word.style-tier2:hover, .word.style-tier3:hover { background: rgba(159, 122, 234, 0.15); }
        body.dark-mode .word.style-tier1 { border-bottom-color: #ecc94b; }
        body.dark-mode .word.style-tier2 { border-bottom-color: #4fd1c5; }
        body.dark-mode .word.style-tier3 { border-bottom-color: #b794f4; }

        .style-popup { position: fixed; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 1rem 1.25rem; z-index: 1000; max-width: 400px; min-width: 280px; display: none; }
        .style-popup.visible { display: block; }
        .style-popup .device { font-weight: 600; color: #9f7aea; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .style-popup .latin { font-style: italic; color: #4b5563; margin-bottom: 0.5rem; }
        .style-popup .effect { font-size: 0.95rem; line-height: 1.6; color: #1f2937; }
        body.dark-mode .style-popup { background: #4f0c28; }
        body.dark-mode .style-popup .device { color: #b794f4; }
        body.dark-mode .style-popup .latin { color: #b8a8b8; }
        body.dark-mode .style-popup .effect { color: #c5d2f8; }

        /* Style mode indicator */
        .style-mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #f3e8ff;
            color: #6b21a8;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.style-mode .style-mode-indicator {
            display: block;
        }
        body.dark-mode .style-mode-indicator {
            background: #4f0c28;
            color: #b794f4;
        }

        /* Style legend */
        .style-legend {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .style-legend.visible {
            display: block;
        }
        body.dark-mode .style-legend {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        .style-legend h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        body.dark-mode .style-legend h4 {
            color: #c5d2f8;
        }
        .style-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #4b5563;
        }
        body.dark-mode .style-legend-item {
            color: #b8a8b8;
        }
        .style-legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }
        .style-legend-color.tier1 { background: #f0c040; }
        .style-legend-color.tier2 { background: #38b2ac; }
        .style-legend-color.tier3 { background: #9f7aea; }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">Nero's Murder Plot</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.3</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleStyleMode()">Style</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="style-legend" id="styleLegend">
                            <h4>Style Analysis Key</h4>
                            <div class="style-legend-item">
                                <span class="style-legend-color tier1"></span>
                                <span>Tier 1: Sound patterns (alliteration, assonance, repetition)</span>
                            </div>
                            <div class="style-legend-item">
                                <span class="style-legend-color tier2"></span>
                                <span>Tier 2: Structural devices (tricolon, chiasmus, word order)</span>
                            </div>
                            <div class="style-legend-item">
                                <span class="style-legend-color tier3"></span>
                                <span>Tier 3: Thematic effects (euphemism, irony, characterisation)</span>
                            </div>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 12</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>Therefore, Nero began to avoid secret meetings with her and praise her when she went away to her gardens or to her estate at Tusculum or at Antium, that she was taking some leisure time. Finally, considering her a thorough nuisance, wherever she was being kept, he decided to kill her, deliberating only as far as whether it should be by poison, the sword or some other violent means. First of all, he decided on poison. But if it were to be given during the emperor's banquet, it could not be attributed to chance, since a similar destruction of Britannicus had already occurred; also, it seemed difficult to bribe the servants of a woman on her guard against treachery because of her experience in crimes; moreover, she herself had fortified her body by taking antidotes in advance. No one was able to discover how a sword and murder could be concealed; also, he feared that anyone selected for such a great crime as this might disregard instructions. An ingenious plan was offered by the freedman Anicetus, who was in charge of the fleet at Misenum, a tutor to Nero's boyhood, and one who hated Agrippina with mutual hostility. Therefore, he showed them that a boat could be constructed, part of which, skilfully loosened in the sea itself, would cast her out unawares.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="style-popup" id="stylePopup"></div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>
    <div class="style-mode-indicator">üé® Style Mode (click highlighted words to see literary analysis)</div>

    <script>
const vocab = {
    "igitur": { lemma: "igitur", parsing: "adverb", meaning: "therefore, consequently" },
    "nero": { lemma: "Nero, Neronis (m.)", parsing: "nom. sing.", meaning: "Nero (the emperor)" },
    "vitare": { lemma: "vito, -are, -avi, -atum", parsing: "pres. inf. act.", meaning: "to avoid, to shun" },
    "secretos": { lemma: "secretus, -a, -um", parsing: "acc. pl. masc.", meaning: "secret, private" },
    "eius": { lemma: "is, ea, id", parsing: "gen. sing.", meaning: "her, of her" },
    "congressus": { lemma: "congressus, -us (m.)", parsing: "acc. pl.", meaning: "meetings, encounters" },
    "abscedentem": { lemma: "abscedo, -ere, -cessi, -cessum", parsing: "pres. act. part. acc. fem. sing.", meaning: "going away, departing" },
    "in": { lemma: "in", parsing: "preposition + acc.", meaning: "into, to" },
    "hortos": { lemma: "hortus, -i (m.)", parsing: "acc. pl.", meaning: "gardens" },
    "aut": { lemma: "aut", parsing: "conjunction", meaning: "or" },
    "tusculanum": { lemma: "Tusculanum, -i (n.)", parsing: "acc. sing.", meaning: "estate at Tusculum" },
    "vel": { lemma: "vel", parsing: "conjunction", meaning: "or" },
    "antiatem": { lemma: "Antias, -atis", parsing: "acc. sing.", meaning: "at Antium (adjective)" },
    "agrum": { lemma: "ager, agri (m.)", parsing: "acc. sing.", meaning: "estate, land, field" },
    "laudare": { lemma: "laudo, -are, -avi, -atum", parsing: "pres. inf. act.", meaning: "to praise" },
    "quod": { lemma: "quod", parsing: "conjunction", meaning: "that, because" },
    "otium": { lemma: "otium, -i (n.)", parsing: "acc. sing.", meaning: "leisure, retirement" },
    "capesseret": { lemma: "capesso, -ere, -ivi, -itum", parsing: "imperf. subj. act. 3rd sing.", meaning: "she was taking up, undertaking" },
    "postremo": { lemma: "postremo", parsing: "adverb", meaning: "finally, at last" },
    "ubicumque": { lemma: "ubicumque", parsing: "adverb", meaning: "wherever" },
    "haberetur": { lemma: "habeo, -ere, habui, habitum", parsing: "imperf. subj. pass. 3rd sing.", meaning: "she was being kept" },
    "praegravem": { lemma: "praegravis, -e", parsing: "acc. sing. fem.", meaning: "very burdensome, a thorough nuisance" },
    "ratus": { lemma: "reor, reri, ratus sum", parsing: "perf. part. nom. masc. sing.", meaning: "having considered, thinking" },
    "interficere": { lemma: "interficio, -ere, -feci, -fectum", parsing: "pres. inf. act.", meaning: "to kill, to murder" },
    "constituit": { lemma: "constituo, -ere, -ui, -utum", parsing: "perf. act. ind. 3rd sing.", meaning: "he decided, determined" },
    "hactenus": { lemma: "hactenus", parsing: "adverb", meaning: "to this extent, only so far as" },
    "consultans": { lemma: "consulto, -are, -avi, -atum", parsing: "pres. act. part. nom. masc. sing.", meaning: "deliberating, consulting" },
    "veneno": { lemma: "venenum, -i (n.)", parsing: "abl. sing.", meaning: "by poison" },
    "an": { lemma: "an", parsing: "conjunction", meaning: "or (in indirect question)" },
    "ferro": { lemma: "ferrum, -i (n.)", parsing: "abl. sing.", meaning: "by sword, by blade" },
    "qua": { lemma: "qui, quae, quod", parsing: "abl. fem. sing.", meaning: "by what, by which" },
    "alia": { lemma: "alius, -a, -ud", parsing: "abl. fem. sing.", meaning: "other, another" },
    "vi": { lemma: "vis, vis (f.)", parsing: "abl. sing.", meaning: "by force, by violence" },
    "placuitque": { lemma: "placeo, -ere, placui + -que", parsing: "perf. act. ind. 3rd sing. + and", meaning: "and it was decided, and it pleased" },
    "primo": { lemma: "primo", parsing: "adverb", meaning: "first, at first" },
    "venenum": { lemma: "venenum, -i (n.)", parsing: "nom. sing.", meaning: "poison" },
    "sed": { lemma: "sed", parsing: "conjunction", meaning: "but" },
    "inter": { lemma: "inter", parsing: "preposition + acc.", meaning: "during, among" },
    "epulas": { lemma: "epulae, -arum (f. pl.)", parsing: "acc. pl.", meaning: "banquet, feast" },
    "principis": { lemma: "princeps, principis (m.)", parsing: "gen. sing.", meaning: "of the emperor, of the prince" },
    "si": { lemma: "si", parsing: "conjunction", meaning: "if" },
    "daretur": { lemma: "do, dare, dedi, datum", parsing: "imperf. subj. pass. 3rd sing.", meaning: "it were to be given" },
    "referri": { lemma: "refero, referre, rettuli, relatum", parsing: "pres. pass. inf.", meaning: "to be attributed, to be referred" },
    "ad": { lemma: "ad", parsing: "preposition + acc.", meaning: "to, towards" },
    "casum": { lemma: "casus, -us (m.)", parsing: "acc. sing.", meaning: "chance, accident" },
    "non": { lemma: "non", parsing: "adverb", meaning: "not" },
    "poterat": { lemma: "possum, posse, potui", parsing: "imperf. act. ind. 3rd sing.", meaning: "it was able, it could" },
    "tali": { lemma: "talis, -e", parsing: "abl. sing.", meaning: "such, of such a kind" },
    "iam": { lemma: "iam", parsing: "adverb", meaning: "already, by now" },
    "britannici": { lemma: "Britannicus, -i (m.)", parsing: "gen. sing.", meaning: "of Britannicus" },
    "exitio": { lemma: "exitium, -i (n.)", parsing: "abl. sing.", meaning: "by destruction, by death" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and, also" },
    "ministros": { lemma: "minister, -tri (m.)", parsing: "acc. pl.", meaning: "servants, attendants" },
    "temptare": { lemma: "tempto, -are, -avi, -atum", parsing: "pres. inf. act.", meaning: "to try, to bribe, to test" },
    "arduum": { lemma: "arduus, -a, -um", parsing: "nom./acc. neut. sing.", meaning: "difficult, hard" },
    "videbatur": { lemma: "video, -ere, vidi, visum", parsing: "imperf. pass. ind. 3rd sing.", meaning: "it seemed" },
    "mulieris": { lemma: "mulier, mulieris (f.)", parsing: "gen. sing.", meaning: "of a woman" },
    "usu": { lemma: "usus, -us (m.)", parsing: "abl. sing.", meaning: "by experience, by practice" },
    "scelerum": { lemma: "scelus, sceleris (n.)", parsing: "gen. pl.", meaning: "of crimes" },
    "adversus": { lemma: "adversus", parsing: "preposition + acc.", meaning: "against" },
    "insidias": { lemma: "insidiae, -arum (f. pl.)", parsing: "acc. pl.", meaning: "treachery, plots, ambush" },
    "intentae": { lemma: "intentus, -a, -um", parsing: "gen. fem. sing.", meaning: "on guard, attentive" },
    "atque": { lemma: "atque", parsing: "conjunction", meaning: "and moreover, and also" },
    "ipsa": { lemma: "ipse, ipsa, ipsum", parsing: "nom. fem. sing.", meaning: "she herself" },
    "praesumendo": { lemma: "praesumo, -ere, -sumpsi, -sumptum", parsing: "gerund abl.", meaning: "by taking in advance" },
    "remedia": { lemma: "remedium, -i (n.)", parsing: "acc. pl.", meaning: "remedies, antidotes" },
    "munierat": { lemma: "munio, -ire, -ivi, -itum", parsing: "pluperf. act. ind. 3rd sing.", meaning: "she had fortified" },
    "corpus": { lemma: "corpus, corporis (n.)", parsing: "acc. sing.", meaning: "body" },
    "ferrum": { lemma: "ferrum, -i (n.)", parsing: "nom. sing.", meaning: "sword, blade, iron" },
    "caedes": { lemma: "caedes, -is (f.)", parsing: "nom. sing.", meaning: "murder, slaughter" },
    "quonam": { lemma: "quisnam, quaenam, quidnam", parsing: "abl. neut. sing.", meaning: "in what way" },
    "modo": { lemma: "modus, -i (m.)", parsing: "abl. sing.", meaning: "way, manner" },
    "occultaretur": { lemma: "occulto, -are, -avi, -atum", parsing: "imperf. subj. pass. 3rd sing.", meaning: "could be concealed, hidden" },
    "nemo": { lemma: "nemo, neminis", parsing: "nom. sing.", meaning: "no one, nobody" },
    "reperiebat": { lemma: "reperio, -ire, repperi, repertum", parsing: "imperf. act. ind. 3rd sing.", meaning: "was able to discover, was finding" },
    "ne": { lemma: "ne", parsing: "conjunction", meaning: "lest, that...not" },
    "quis": { lemma: "quis, quid", parsing: "nom. sing.", meaning: "anyone (indefinite)" },
    "illi": { lemma: "ille, illa, illud", parsing: "dat. sing.", meaning: "for that" },
    "tanto": { lemma: "tantus, -a, -um", parsing: "dat./abl. sing.", meaning: "such great, so great" },
    "facinori": { lemma: "facinus, facinoris (n.)", parsing: "dat. sing.", meaning: "for the crime, deed" },
    "delectus": { lemma: "deligo, -ere, -legi, -lectum", parsing: "perf. pass. part. nom. masc. sing.", meaning: "having been chosen, selected" },
    "iussa": { lemma: "iussum, -i (n.)", parsing: "acc. pl.", meaning: "orders, instructions" },
    "sperneret": { lemma: "sperno, -ere, sprevi, spretum", parsing: "imperf. subj. act. 3rd sing.", meaning: "might disregard, might reject" },
    "metuebat": { lemma: "metuo, -ere, metui", parsing: "imperf. act. ind. 3rd sing.", meaning: "he feared" },
    "obtulit": { lemma: "offero, offerre, obtuli, oblatum", parsing: "perf. act. ind. 3rd sing.", meaning: "offered, presented" },
    "ingenium": { lemma: "ingenium, -i (n.)", parsing: "acc. sing.", meaning: "ingenuity, clever plan, talent" },
    "anicetus": { lemma: "Anicetus, -i (m.)", parsing: "nom. sing.", meaning: "Anicetus (proper name)" },
    "libertus": { lemma: "libertus, -i (m.)", parsing: "nom. sing.", meaning: "freedman" },
    "classi": { lemma: "classis, -is (f.)", parsing: "dat. sing.", meaning: "to the fleet" },
    "apud": { lemma: "apud", parsing: "preposition + acc.", meaning: "at, near" },
    "misenum": { lemma: "Misenum, -i (n.)", parsing: "acc. sing.", meaning: "Misenum (naval base)" },
    "praefectus": { lemma: "praefectus, -i (m.)", parsing: "nom. sing.", meaning: "commander, prefect" },
    "pueritiae": { lemma: "pueritia, -ae (f.)", parsing: "gen. sing.", meaning: "of boyhood, of childhood" },
    "neronis": { lemma: "Nero, Neronis (m.)", parsing: "gen. sing.", meaning: "of Nero" },
    "educator": { lemma: "educator, -oris (m.)", parsing: "nom. sing.", meaning: "tutor, one who raises" },
    "ac": { lemma: "ac / atque", parsing: "conjunction", meaning: "and" },
    "mutuis": { lemma: "mutuus, -a, -um", parsing: "abl. pl.", meaning: "mutual, reciprocal" },
    "odiis": { lemma: "odium, -i (n.)", parsing: "abl. pl.", meaning: "by hatreds" },
    "agrippinae": { lemma: "Agrippina, -ae (f.)", parsing: "dat. sing.", meaning: "to Agrippina" },
    "invisus": { lemma: "invisus, -a, -um", parsing: "nom. masc. sing.", meaning: "hated, hateful" },
    "ergo": { lemma: "ergo", parsing: "adverb", meaning: "therefore, consequently" },
    "navem": { lemma: "navis, -is (f.)", parsing: "acc. sing.", meaning: "ship, boat" },
    "posse": { lemma: "possum, posse, potui", parsing: "pres. inf.", meaning: "to be able" },
    "componi": { lemma: "compono, -ere, -posui, -positum", parsing: "pres. pass. inf.", meaning: "to be constructed, to be put together" },
    "docet": { lemma: "doceo, -ere, docui, doctum", parsing: "pres. act. ind. 3rd sing.", meaning: "he teaches, shows" },
    "cuius": { lemma: "qui, quae, quod", parsing: "gen. sing.", meaning: "of which, whose" },
    "pars": { lemma: "pars, partis (f.)", parsing: "nom. sing.", meaning: "part" },
    "ipso": { lemma: "ipse, ipsa, ipsum", parsing: "abl. neut. sing.", meaning: "itself" },
    "mari": { lemma: "mare, maris (n.)", parsing: "abl. sing.", meaning: "in the sea" },
    "per": { lemma: "per", parsing: "preposition + acc.", meaning: "through, by means of" },
    "artem": { lemma: "ars, artis (f.)", parsing: "acc. sing.", meaning: "skill, art, craft" },
    "soluta": { lemma: "solvo, -ere, solvi, solutum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "having been loosened, released" },
    "effunderet": { lemma: "effundo, -ere, -fudi, -fusum", parsing: "imperf. subj. act. 3rd sing.", meaning: "would cast out, would pour out" },
    "ignaram": { lemma: "ignarus, -a, -um", parsing: "acc. fem. sing.", meaning: "unaware, ignorant" }
};

const styleData = {
    // Tier 1: Sound patterns (alliteration, assonance, repetition)
    "placuitque": { tier: 1, device: "Alliteration", latin: "placuitque primo", effect: "The repeated 'p' sound in 'placuitque primo' creates a chilling matter-of-factness about the decision to murder. The soft plosives make the horrific choice sound almost casual, emphasising Nero's moral detachment." },
    "primo": { tier: 1, device: "Alliteration", latin: "placuitque primo", effect: "Part of the 'p' alliteration with 'placuitque'. The combination suggests a bureaucratic orderliness to Nero's murderous planning, as if poison were simply the first item on an agenda." },
    "vitare": { tier: 1, device: "Parallel Infinitives", latin: "vitare...laudare", effect: "The parallel infinitives 'vitare' (to avoid) and 'laudare' (to praise) create a rhythmic contrast showing Nero's two-faced behaviour: avoiding his mother while praising her absence. The structure emphasises his hypocrisy." },
    "laudare": { tier: 1, device: "Parallel Infinitives", latin: "vitare...laudare", effect: "Paired with 'vitare', this infinitive completes the picture of Nero's duplicity. The balanced structure makes his false praise seem as deliberate and calculated as his avoidance." },
    "aut": { tier: 1, device: "Polysyndeton", latin: "aut Tusculanum vel Antiatem", effect: "The accumulation of conjunctions (aut...vel) creates a sense of multiplying locations, suggesting Nero's relief whenever Agrippina goes anywhere at all. Each 'or' extends his desire for distance." },

    // Tier 2: Structural devices (tricolon, chiasmus, word order)
    "veneno": { tier: 2, device: "Ascending Tricolon", latin: "veneno an ferro vel qua alia vi", effect: "The first element of a tricolon presenting murder methods. The progression from poison (subtle) to sword (direct) to 'any other violence' (unlimited) shows Nero's deliberation escalating from specific to horrifyingly open-ended." },
    "ferro": { tier: 2, device: "Ascending Tricolon", latin: "veneno an ferro vel qua alia vi", effect: "The middle term of the tricolon. 'Ferrum' (sword/iron) represents direct violence, positioned between covert poisoning and the sweeping 'any other means', creating a crescendo of murderous intent." },
    "vi": { tier: 2, device: "Ascending Tricolon", latin: "veneno an ferro vel qua alia vi", effect: "The climactic third element expands to 'any other violence', showing that Nero's only concern is effectiveness, not method. The open-ended 'qua alia vi' reveals the depth of his determination." },
    "classi": { tier: 2, device: "Triple Appositive", latin: "classi praefectus...educator...invisus", effect: "The first of three appositives describing Anicetus. His naval command provides the practical means for the plot. Tacitus's triple characterisation builds a complete portrait of the perfect conspirator." },
    "educator": { tier: 2, device: "Triple Appositive", latin: "classi praefectus...educator...invisus", effect: "The second appositive reveals Anicetus's intimate connection to Nero as childhood tutor, explaining his access and loyalty. The word choice ('educator' rather than just 'magister') emphasises the bond." },
    "invisus": { tier: 2, device: "Triple Appositive", latin: "classi praefectus...educator...invisus", effect: "The climactic third appositive: Anicetus was 'hated' by Agrippina with mutual hostility. This provides his personal motive, completing the portrait: means, loyalty, and motivation for matricide." },

    // Tier 3: Thematic effects (euphemism, irony, characterisation)
    "praegravem": { tier: 3, device: "Dehumanising Vocabulary", latin: "praegravem ratus", effect: "Tacitus shows Nero reducing his mother to an object - a 'burden' (praegravem). This single adjective encapsulates the moral horror: the emperor views matricide as merely lifting an inconvenience. The prefix 'prae-' intensifies her nuisance value." },
    "constituit": { tier: 3, device: "Delayed Main Verb", latin: "interficere constituit", effect: "The main verb 'constituit' (he decided) comes after 'interficere' (to kill), building suspense. The reader reaches 'to kill' and must wait for the chilling confirmation. This word order mirrors the terrible finality of Nero's resolution." },
    "interficere": { tier: 3, device: "Blunt Vocabulary", latin: "interficere constituit", effect: "Rather than a euphemism, Tacitus uses the stark 'interficere' (to kill) - a word typically reserved for killing enemies. Applied to Nero's own mother, it emphasises the violation of natural bonds." },
    "usu": { tier: 3, device: "Bitter Irony", latin: "usu scelerum", effect: "The phrase 'experience in crimes' (usu scelerum) is devastatingly ironic. Agrippina's own criminal past - including possibly poisoning Claudius - now protects her from her son's poison. The hunter becomes prey to her own methods." },
    "artem": { tier: 3, device: "Perverted Language", latin: "per artem soluta", effect: "The word 'ars' (skill, art) typically suggests civilised achievement. Here it describes the 'craftsmanship' of a murder device. Tacitus shows how imperial corruption perverts even positive vocabulary into instruments of death." },
    "ignaram": { tier: 3, device: "Pathetic Final Word", latin: "effunderet ignaram", effect: "The passage ends with 'ignaram' (unaware) - the last word emphasising Agrippina's vulnerability. She who knew all the court's secrets would die 'unknowing'. The placement creates pathos and condemns the treachery of the plot." }
};

const latinSentences = [
    "igitur Nero vitare secretos eius congressus,",
    "abscedentem in hortos aut Tusculanum vel Antiatem in agrum laudare quod otium capesseret.",
    "postremo, ubicumque haberetur, praegravem ratus interficere constituit,",
    "hactenus consultans, veneno an ferro vel qua alia vi.",
    "placuitque primo venenum.",
    "sed inter epulas principis si daretur, referri ad casum non poterat tali iam Britannici exitio;",
    "et ministros temptare arduum videbatur mulieris usu scelerum adversus insidias intentae;",
    "atque ipsa praesumendo remedia munierat corpus.",
    "ferrum et caedes quonam modo occultaretur nemo reperiebat;",
    "et ne quis illi tanto facinori delectus iussa sperneret metuebat.",
    "obtulit ingenium Anicetus libertus, classi apud Misenum praefectus et pueritiae Neronis educator ac mutuis odiis Agrippinae invisus.",
    "ergo navem posse componi docet cuius pars ipso in mari per artem soluta effunderet ignaram:"
];

const resources = {
    summary: `<h4>Summary</h4>
<p>In this passage, Tacitus describes Nero's escalating determination to murder his mother Agrippina. The emperor's behaviour progresses from passive-aggressive avoidance (praising her "retirement" while secretly glad of her absence) to active plotting of matricide.</p>
<p>Nero's deliberations reveal the practical obstacles to assassination: poison is ruled out because Britannicus's recent poisoning makes it impossible to disguise, and Agrippina herself has built up immunity through preventive antidotes. Direct violence with a sword poses the problem of concealment, and Nero fears that any hired assassin might refuse orders or betray the plot.</p>
<p>The solution comes from Anicetus, a freedman with a triple connection to the conspiracy: he commands the fleet at Misenum (providing resources), was Nero's childhood tutor (ensuring loyalty), and harbours mutual hatred toward Agrippina (providing motivation). His ingenious proposal is a collapsible ship designed to fall apart at sea, making murder look like an accident.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>Britannicus's Poisoning:</strong> Tacitus's reference to "tali iam Britannici exitio" recalls the murder of Nero's stepbrother Britannicus in AD 55, described in Annals 13.15-17. Britannicus was poisoned at a banquet, and though Nero claimed it was an epileptic fit, no one was deceived. This precedent made poison unusable against Agrippina.</p>
<p><strong>Agrippina's Experience:</strong> The phrase "usu scelerum" (experience in crimes) reflects Agrippina's own history of political murder, including the likely poisoning of her husband Claudius. Her knowledge of court intrigue and routine use of antidotes ("praesumendo remedia") made her a formidable target.</p>
<p><strong>Anicetus:</strong> The freedman Anicetus was praefectus classis at Misenum, commanding Rome's principal naval base. His role as Nero's childhood educator (educator pueritiae) placed him in a position of trusted intimacy. The "mutual hatreds" between him and Agrippina suggest a long-standing rivalry, possibly connected to his influence over young Nero.</p>
<p><strong>The Collapsible Ship:</strong> The engineering of a ship designed to collapse was a remarkable piece of criminal ingenuity. The plan exploited the dangers of sea travel to create plausible deniability, though as Annals 14.5-6 reveal, the plot failed spectacularly when Agrippina survived and swam to shore.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Lines 1-2:</strong> What does Nero do when Agrippina leaves Rome for her various estates? What is ironic about his praise ("laudare quod otium capesseret")?</p>
<p><strong>Line 3:</strong> What does "praegravem ratus" reveal about Nero's view of his mother? How does "ubicumque haberetur" emphasise his frustration?</p>
<p><strong>Line 4:</strong> What three methods of murder does Nero consider? What does "hactenus consultans" suggest about the limits of his deliberation?</p>
<p><strong>Lines 5-6:</strong> Why is poison rejected? What does the reference to Britannicus reveal about the court's knowledge of that earlier murder?</p>
<p><strong>Line 7:</strong> Why is bribing Agrippina's servants considered difficult? What does "usu scelerum" tell us about Agrippina's character?</p>
<p><strong>Line 8:</strong> How has Agrippina protected herself against poison? What does this reveal about life at the imperial court?</p>
<p><strong>Lines 9-10:</strong> What two problems does the sword method present? What does Nero's fear about potential assassins tell us about trust at court?</p>
<p><strong>Line 11:</strong> How does Tacitus characterise Anicetus through his three identifying descriptors? Why are each of these relevant to the plot?</p>
<p><strong>Line 12:</strong> How does Anicetus's plan work? Why would death at sea be easier to disguise as an accident?</p>
<p><strong>Overall:</strong> How does Tacitus present Nero's moral character through the structure and vocabulary of this passage?</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;
let styleModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    // Exit style mode if entering pointer mode
    if (pointerModeActive && styleModeActive) {
        styleModeActive = false;
        document.body.classList.remove('style-mode');
        document.getElementById('styleLegend').classList.remove('visible');
        document.querySelectorAll('.btn').forEach(b => {
            if (b.textContent === 'Style') b.classList.remove('active');
        });
        hideStylePopup();
    }

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
    }
}

function toggleStyleMode() {
    styleModeActive = !styleModeActive;
    document.body.classList.toggle('style-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    const legend = document.getElementById('styleLegend');
    legend.classList.toggle('visible', styleModeActive);

    // Exit pointer mode if entering style mode
    if (styleModeActive && pointerModeActive) {
        pointerModeActive = false;
        document.body.classList.remove('pointer-mode');
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
        document.querySelectorAll('.btn').forEach(b => {
            if (b.textContent === 'Pointer Mode') b.classList.remove('active');
        });
    }

    // Hide popups when toggling
    if (styleModeActive) {
        hidePopup();
    } else {
        hideStylePopup();
    }
}

function showStylePopup(event, word) {
    const popup = document.getElementById('stylePopup');
    const data = styleData[word.toLowerCase()];

    if (!data) {
        popup.classList.remove('visible');
        return;
    }

    popup.innerHTML = `
        <div class="device">${data.device}</div>
        <div class="latin">${data.latin}</div>
        <div class="effect">${data.effect}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 380;
    const popupHeight = 200;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
    }

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.classList.add('visible');
}

function hideStylePopup() {
    const popup = document.getElementById('stylePopup');
    popup.classList.remove('visible');
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:]*|[.,;:]+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:]*)$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2];
                    const lookupWord = word.toLowerCase();
                    // Check for style tier class
                    let styleClass = '';
                    if (styleData[lookupWord]) {
                        styleClass = ` style-tier${styleData[lookupWord].tier}`;
                    }
                    html += `<span class="word${styleClass}" data-word="${lookupWord}">${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else if (styleModeActive) {
                // Show style popup if word has style data
                const wordText = this.dataset.word;
                if (styleData[wordText]) {
                    showStylePopup(e, wordText);
                } else {
                    hideStylePopup();
                    // Still show vocab popup for non-style words in style mode
                    showVocabPopup(e, wordText);
                }
            } else {
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();
            hideStylePopup();

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
            // Also exit style mode on escape
            if (styleModeActive) {
                styleModeActive = false;
                document.body.classList.remove('style-mode');
                document.getElementById('styleLegend').classList.remove('visible');
                hideStylePopup();
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Style') btn.classList.remove('active');
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
