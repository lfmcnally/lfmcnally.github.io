<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classicalia - Tacitus Annals 14.10</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo-section {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .nav-section {
            padding: 1rem 0.5rem;
        }
        .nav-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #9ca3af;
            letter-spacing: 0.05em;
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            margin: 0.125rem 0;
            border-radius: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .nav-item.active {
            background: #eef2ff;
            color: #0066ff;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .main-content {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .lesson-header {
            margin-bottom: 2rem;
        }
        .lesson-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .lesson-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .card-body {
            padding: 2rem;
        }
        .latin-text {
            font-size: 1.5rem;
            line-height: 2.4;
            color: #1f2937;
        }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: inline;
        }
        .word:hover {
            background: rgba(0, 102, 255, 0.15);
        }
        .word.active {
            background: rgba(0, 102, 255, 0.25);
        }

        /* Three-tier style highlighting */
        .word.style-tier-1 {
            background: rgba(239, 68, 68, 0.25);
            border-bottom: 2px solid #ef4444;
        }
        .word.style-tier-2 {
            background: rgba(234, 179, 8, 0.25);
            border-bottom: 2px solid #eab308;
        }
        .word.style-tier-3 {
            background: rgba(34, 197, 94, 0.25);
            border-bottom: 2px solid #22c55e;
        }
        body.dark-mode .word.style-tier-1 {
            background: rgba(239, 68, 68, 0.35);
        }
        body.dark-mode .word.style-tier-2 {
            background: rgba(234, 179, 8, 0.35);
        }
        body.dark-mode .word.style-tier-3 {
            background: rgba(34, 197, 94, 0.35);
        }

        /* Style mode indicator */
        body.style-mode .word {
            cursor: help;
        }
        .style-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #ef4444 0%, #eab308 50%, #22c55e 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }
        body.style-mode .style-indicator {
            display: block;
        }
        body.dark-mode .style-indicator {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        /* Style popup */
        .style-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 380px;
            min-width: 280px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .style-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .style-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .style-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .style-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        .style-popup.visible {
            display: block;
        }
        .style-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .style-popup h4.tier-1 { color: #ef4444; }
        .style-popup h4.tier-2 { color: #ca8a04; }
        .style-popup h4.tier-3 { color: #16a34a; }
        .style-popup .device {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .style-popup .effect {
            font-size: 0.9rem;
            color: #1f2937;
            line-height: 1.6;
        }
        .style-popup .tier-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .style-popup .tier-badge.tier-1 {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }
        .style-popup .tier-badge.tier-2 {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
        }
        .style-popup .tier-badge.tier-3 {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }
        body.dark-mode .style-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .style-popup .device {
            color: #b8a8b8;
        }
        body.dark-mode .style-popup .effect {
            color: #c5d2f8;
        }
        body.dark-mode .style-popup .tier-badge.tier-1 {
            background: rgba(239, 68, 68, 0.25);
            color: #fca5a5;
        }
        body.dark-mode .style-popup .tier-badge.tier-2 {
            background: rgba(234, 179, 8, 0.25);
            color: #fde047;
        }
        body.dark-mode .style-popup .tier-badge.tier-3 {
            background: rgba(34, 197, 94, 0.25);
            color: #86efac;
        }

        /* Popup styles */
        .vocab-popup {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            z-index: 1000;
            max-width: 350px;
            min-width: 250px;
            display: none;
            animation: popIn 0.2s ease;
        }
        .vocab-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        .vocab-popup.arrow-bottom::before {
            top: auto;
            bottom: -8px;
            border-bottom: none;
            border-top: 8px solid white;
        }
        body.dark-mode .vocab-popup::before {
            border-bottom-color: #4f0c28;
        }
        body.dark-mode .vocab-popup.arrow-bottom::before {
            border-bottom-color: transparent;
            border-top-color: #4f0c28;
        }
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vocab-popup.visible {
            display: block;
        }
        .vocab-popup h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066ff;
            margin-bottom: 0.5rem;
        }
        .vocab-popup .parsing {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .vocab-popup .meaning {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.5;
        }
        .vocab-popup .principal-parts {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn.active {
            background: #0066ff;
            color: white;
            border-color: #0066ff;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #2d0818;
        }
        body.dark-mode .sidebar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .logo-icon {
            background: linear-gradient(135deg, #8b5a8a 0%, #a67aa6 100%);
        }
        body.dark-mode .logo-text {
            color: #c5d2f8;
        }
        body.dark-mode .nav-title {
            color: #9a8a9a;
        }
        body.dark-mode .nav-item {
            color: #b8a8b8;
        }
        body.dark-mode .nav-item:hover {
            background: #4f0c28;
            color: #c5d2f8;
        }
        body.dark-mode .nav-item.active {
            background: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .top-bar {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card {
            background: #3a0a1f;
            border-color: #5a1a3a;
        }
        body.dark-mode .card-header {
            border-color: #5a1a3a;
        }
        body.dark-mode .card-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-title {
            color: #c5d2f8;
        }
        body.dark-mode .lesson-meta {
            color: #b8a8b8;
        }
        body.dark-mode .latin-text {
            color: #c5d2f8;
            text-shadow: 0 0 20px rgba(197, 210, 248, 0.15);
        }
        body.dark-mode .word:hover {
            background: rgba(232, 212, 168, 0.25);
        }
        body.dark-mode .word.active {
            background: rgba(232, 212, 168, 0.35);
        }
        body.dark-mode .btn {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .btn:hover {
            background: #5a1a3a;
        }
        body.dark-mode .btn.active {
            background: #7a3a5a;
            border-color: #8a4a6a;
        }
        body.dark-mode .resource-card {
            background: #4f0c28;
            border-color: #5a1a3a;
        }
        body.dark-mode .resource-card h4 {
            color: #c5d2f8;
        }
        body.dark-mode .resource-card p {
            color: #b8c8e8;
        }
        body.dark-mode .vocab-popup {
            background: #4f0c28;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .vocab-popup h4 {
            color: #e8d4a8;
        }
        body.dark-mode .vocab-popup .parsing {
            color: #b8a8b8;
        }
        body.dark-mode .vocab-popup .meaning {
            color: #c5d2f8;
        }
        body.dark-mode .vocab-popup .principal-parts {
            color: #a8b8d8;
            border-color: #5a1a3a;
        }

        /* Sentence hover highlight */
        .latin-text p {
            padding: 0.5rem 0.75rem;
            margin: 0 -0.75rem 1.5rem -0.75rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .latin-text p:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        body.dark-mode .latin-text p:hover {
            background: rgba(197, 210, 248, 0.1);
        }

        /* Sentence-by-sentence mode */
        .latin-text.sentence-mode p {
            display: none;
        }
        .latin-text.sentence-mode p.current-sentence {
            display: block;
        }
        .latin-text.sentence-mode p:hover {
            background: transparent;
        }

        .sentence-nav {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .sentence-nav.visible {
            display: flex;
        }
        body.dark-mode .sentence-nav {
            border-color: #5a1a3a;
        }
        .sentence-nav button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .sentence-nav button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        .sentence-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        body.dark-mode .sentence-nav button {
            background: #4f0c28;
            border-color: #6b2a4a;
            color: #c5d2f8;
        }
        body.dark-mode .sentence-nav button:hover:not(:disabled) {
            background: #5a1a3a;
        }
        .sentence-counter {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 80px;
            text-align: center;
        }
        body.dark-mode .sentence-counter {
            color: #b8a8b8;
        }

        /* Full-screen mode */
        body.full-screen .sidebar {
            display: none;
        }
        body.full-screen .main-content {
            margin-left: 0;
        }
        body.full-screen .lesson-header {
            display: none;
        }
        body.full-screen .content-container {
            max-width: 100%;
            padding: 1rem 2rem;
        }
        body.full-screen .card {
            border: none;
            border-radius: 0;
            background: transparent;
        }
        body.full-screen .card-header {
            display: none;
        }
        body.full-screen .card-body {
            padding: 1rem 2rem;
        }
        body.full-screen .latin-text {
            font-size: 2rem;
            line-height: 2.6;
        }
        body.full-screen .btn-group {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        body.full-screen.dark-mode .btn-group {
            background: #3a0a1f;
        }
        body.full-screen .resource-card {
            display: none !important;
        }
        body.full-screen .sentence-nav {
            border: none;
            padding-top: 0;
        }
        body.full-screen .top-bar {
            display: none;
        }

        /* Line numbers */
        .latin-text.show-lines p {
            display: flex;
            align-items: flex-start;
        }
        .line-number {
            display: none;
            min-width: 2.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            padding-top: 0.3rem;
            user-select: none;
        }
        .latin-text.show-lines .line-number {
            display: block;
        }
        body.dark-mode .line-number {
            color: #7a6a7a;
        }
        .line-content {
            flex: 1;
        }

        /* Pointer/highlight mode */
        .word.pointed {
            background: rgba(255, 200, 50, 0.5) !important;
            box-shadow: 0 0 12px rgba(255, 200, 50, 0.6);
            border-radius: 4px;
        }
        body.dark-mode .word.pointed {
            background: rgba(232, 212, 168, 0.5) !important;
            box-shadow: 0 0 15px rgba(232, 212, 168, 0.5);
        }

        /* Pointer mode indicator */
        body.pointer-mode .word {
            cursor: crosshair;
        }
        .mode-indicator {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body.pointer-mode .mode-indicator {
            display: block;
        }
        body.dark-mode .mode-indicator {
            background: #4f0c28;
            color: #e8d4a8;
        }

        .resource-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .resource-card.active {
            display: block;
        }
        .resource-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .resource-card p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #374151;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .latin-text {
                font-size: 1.25rem;
                line-height: 2.2;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <a href="../../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Resources</div>
            <div class="nav-item active" onclick="showView('text')">
                <span class="nav-icon">üìñ</span>
                <span>Read</span>
            </div>
            <div class="nav-item" onclick="showView('summary')">
                <span class="nav-icon">üìã</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showView('context')">
                <span class="nav-icon">üèõÔ∏è</span>
                <span>Context</span>
            </div>
            <div class="nav-item" onclick="showView('comprehension')">
                <span class="nav-icon">‚ùì</span>
                <span>Comprehension</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="lesson-header">
                    <h1 class="lesson-title">Aftermath and Cover-up</h1>
                    <div class="lesson-meta">
                        <span>üìï Tacitus Annals 14.10</span>
                        <span>‚è±Ô∏è 60 min</span>
                        <span>üìä A-Level</span>
                    </div>
                </header>

                <div class="card" id="textCard">
                    <div class="card-header">
                        <h3 class="card-title">Latin Text</h3>
                    </div>
                    <div class="card-body">
                        <div class="latin-text" id="latinText"></div>
                        <div class="btn-group">
                            <button class="btn" onclick="toggleTranslation()">Translation</button>
                            <button class="btn" onclick="toggleSentenceMode()">Sentence Mode</button>
                            <button class="btn" onclick="toggleLineNumbers()">Line Numbers</button>
                            <button class="btn" onclick="togglePointerMode()">Pointer Mode</button>
                            <button class="btn" onclick="toggleStyleMode()">Style</button>
                            <button class="btn" onclick="toggleDarkMode()">üåô Dark</button>
                            <button class="btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
                        </div>
                        <div class="sentence-nav" id="sentenceNav">
                            <button onclick="prevSentence()">‚Üê Previous</button>
                            <span class="sentence-counter" id="sentenceCounter">1 / 8</span>
                            <button onclick="nextSentence()">Next ‚Üí</button>
                        </div>
                        <div class="resource-card" id="translationBox">
                            <h4>Translation</h4>
                            <p>Not until the crime was finally completed was its enormity realised by Nero. For the remainder of the night at times stupefied in silence, more often rising in fear and bereft of purpose, he waited for the daylight, as if it was going to bring his destruction. And then, at the instigation of Burrus, the flattery of the centurions and tribunes was the first thing to encourage him to hope, since they grasped his hand and gave thanks that he had escaped unforeseen danger and his mother's crime. Then his friends approached the temples, and when the example had been set, the nearest towns of Campania showed their joy with sacrifices and embassies: (Nero) himself with a different pretence was sorrowful, and as if angry at his own safety and weeping over the death of his mother. However, because the appearances of places are not changed, unlike men's features, and the grievous sight of that sea and shores presented itself to his eyes, (and there were some who believed that the sound of a trumpet was heard in the lofty hills around, together with groaning from his mother's grave), he withdrew to Neapolis and sent a letter to the Senate, the gist of which was that an assassin Agerinus, (one) of Agrippina's closest freedmen, had been discovered with a sword, and because of her guilt, she had paid the penalty, as if she had planned the crime.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resourceCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title" id="resourceTitle">Summary</h3>
                    </div>
                    <div class="card-body" id="resourceContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="vocab-popup" id="vocabPopup"></div>
    <div class="style-popup" id="stylePopup"></div>
    <div class="mode-indicator">üìç Pointer Mode (click words to highlight, click again to remove)</div>
    <div class="style-indicator">üé® Style Mode - Tier 1: Sound | Tier 2: Syntax | Tier 3: Narrative</div>

    <script>
const vocab = {
    "sed": { lemma: "sed", parsing: "conjunction", meaning: "but" },
    "a": { lemma: "a/ab", parsing: "preposition + abl.", meaning: "by, from" },
    "caesare": { lemma: "Caesar, Caesaris (m.)", parsing: "abl. sing.", meaning: "Caesar, Nero" },
    "perfecto": { lemma: "perficio, -ere, -feci, -fectum", parsing: "perf. pass. part. abl. neut. sing.", meaning: "completed, finished" },
    "demum": { lemma: "demum", parsing: "adverb", meaning: "only then, finally, at last" },
    "scelere": { lemma: "scelus, sceleris (n.)", parsing: "abl. sing.", meaning: "crime, wickedness" },
    "magnitudo": { lemma: "magnitudo, -inis (f.)", parsing: "nom. sing.", meaning: "magnitude, enormity, greatness" },
    "eius": { lemma: "is, ea, id", parsing: "gen. sing.", meaning: "of it, its" },
    "intellecta": { lemma: "intellego, -ere, -lexi, -lectum", parsing: "perf. pass. part. nom. fem. sing.", meaning: "understood, realised" },
    "est": { lemma: "sum, esse, fui", parsing: "pres. ind. 3rd sing.", meaning: "is, was" },
    "reliquo": { lemma: "reliquus, -a, -um", parsing: "abl. neut. sing.", meaning: "remaining, rest of" },
    "noctis": { lemma: "nox, noctis (f.)", parsing: "gen. sing.", meaning: "of night" },
    "modo": { lemma: "modo", parsing: "adverb", meaning: "sometimes, at times; only" },
    "per": { lemma: "per", parsing: "preposition + acc.", meaning: "through, during" },
    "silentium": { lemma: "silentium, -i (n.)", parsing: "acc. sing.", meaning: "silence" },
    "defixus": { lemma: "defigo, -ere, -fixi, -fixum", parsing: "perf. pass. part. nom. masc. sing.", meaning: "stupefied, transfixed, frozen" },
    "saepius": { lemma: "saepe", parsing: "comparative adverb", meaning: "more often" },
    "pavore": { lemma: "pavor, -oris (m.)", parsing: "abl. sing.", meaning: "in panic, with fear" },
    "exsurgens": { lemma: "exsurgo, -ere, -surrexi", parsing: "pres. act. part. nom. masc. sing.", meaning: "rising up, getting up" },
    "et": { lemma: "et", parsing: "conjunction", meaning: "and" },
    "mentis": { lemma: "mens, mentis (f.)", parsing: "gen. sing.", meaning: "of mind, of purpose" },
    "inops": { lemma: "inops, inopis", parsing: "nom. sing.", meaning: "bereft, lacking, helpless" },
    "lucem": { lemma: "lux, lucis (f.)", parsing: "acc. sing.", meaning: "daylight, light" },
    "opperiebatur": { lemma: "opperior, -iri, oppertus sum", parsing: "imperf. ind. dep. 3rd sing.", meaning: "was waiting for, was awaiting" },
    "tamquam": { lemma: "tamquam", parsing: "conjunction", meaning: "as if, just as" },
    "exitium": { lemma: "exitium, -i (n.)", parsing: "acc. sing.", meaning: "destruction, ruin" },
    "adlaturam": { lemma: "adfero, adferre, attuli, allatum", parsing: "fut. act. part. acc. fem. sing.", meaning: "going to bring, about to bring" },
    "atque": { lemma: "atque", parsing: "conjunction", meaning: "and, and also" },
    "eum": { lemma: "is, ea, id", parsing: "acc. masc. sing.", meaning: "him" },
    "auctore": { lemma: "auctor, -oris (m.)", parsing: "abl. sing.", meaning: "at the instigation of, with as author" },
    "burro": { lemma: "Burrus, -i (m.)", parsing: "abl. sing.", meaning: "Burrus (Praetorian Prefect)" },
    "prima": { lemma: "primus, -a, -um", parsing: "nom. fem. sing.", meaning: "first" },
    "centurionum": { lemma: "centurio, -onis (m.)", parsing: "gen. pl.", meaning: "of centurions" },
    "tribunorumque": { lemma: "tribunus, -i (m.) + -que", parsing: "gen. pl. + and", meaning: "and of tribunes" },
    "tribunorum": { lemma: "tribunus, -i (m.)", parsing: "gen. pl.", meaning: "of tribunes" },
    "que": { lemma: "-que", parsing: "enclitic conjunction", meaning: "and" },
    "adulatio": { lemma: "adulatio, -onis (f.)", parsing: "nom. sing.", meaning: "flattery, adulation" },
    "ad": { lemma: "ad", parsing: "preposition + acc.", meaning: "to, towards, for" },
    "spem": { lemma: "spes, spei (f.)", parsing: "acc. sing.", meaning: "hope" },
    "firmavit": { lemma: "firmo, -are, -avi, -atum", parsing: "perf. act. ind. 3rd sing.", meaning: "strengthened, encouraged" },
    "prensantium": { lemma: "prenso, -are", parsing: "pres. act. part. gen. pl.", meaning: "grasping, seizing" },
    "manum": { lemma: "manus, -us (f.)", parsing: "acc. sing.", meaning: "hand" },
    "gratantiumque": { lemma: "grator, -ari + -que", parsing: "pres. dep. part. gen. pl. + and", meaning: "and congratulating" },
    "gratantium": { lemma: "grator, -ari", parsing: "pres. dep. part. gen. pl.", meaning: "congratulating, giving thanks" },
    "quod": { lemma: "quod", parsing: "conjunction", meaning: "because, that" },
    "discrimen": { lemma: "discrimen, -inis (n.)", parsing: "acc. sing.", meaning: "danger, crisis" },
    "improvisum": { lemma: "improvisus, -a, -um", parsing: "acc. neut. sing.", meaning: "unforeseen, unexpected" },
    "matris": { lemma: "mater, matris (f.)", parsing: "gen. sing.", meaning: "of mother" },
    "facinus": { lemma: "facinus, -oris (n.)", parsing: "acc. sing.", meaning: "crime, deed" },
    "evasisset": { lemma: "evado, -ere, evasi, evasum", parsing: "pluperf. subj. act. 3rd sing.", meaning: "had escaped" },
    "amici": { lemma: "amicus, -i (m.)", parsing: "nom. pl.", meaning: "friends" },
    "dehinc": { lemma: "dehinc", parsing: "adverb", meaning: "then, next, from this point" },
    "adire": { lemma: "adeo, adire, adii, aditum", parsing: "pres. inf. act.", meaning: "to approach, to visit" },
    "templa": { lemma: "templum, -i (n.)", parsing: "acc. pl.", meaning: "temples" },
    "coepto": { lemma: "coepio, -ere, coepi, coeptum", parsing: "perf. pass. part. abl. neut. sing.", meaning: "having been begun" },
    "exemplo": { lemma: "exemplum, -i (n.)", parsing: "abl. sing.", meaning: "by example" },
    "proxima": { lemma: "proximus, -a, -um", parsing: "nom. neut. pl.", meaning: "nearest, closest" },
    "campaniae": { lemma: "Campania, -ae (f.)", parsing: "gen. sing.", meaning: "of Campania" },
    "municipia": { lemma: "municipium, -i (n.)", parsing: "nom. pl.", meaning: "towns, municipalities" },
    "victimis": { lemma: "victima, -ae (f.)", parsing: "abl. pl.", meaning: "with sacrificial victims" },
    "legationibus": { lemma: "legatio, -onis (f.)", parsing: "abl. pl.", meaning: "with embassies, with delegations" },
    "laetitiam": { lemma: "laetitia, -ae (f.)", parsing: "acc. sing.", meaning: "joy, happiness" },
    "testari": { lemma: "testor, -ari, -atus sum", parsing: "pres. inf. dep.", meaning: "to witness, to show, to declare" },
    "ipse": { lemma: "ipse, ipsa, ipsum", parsing: "nom. masc. sing.", meaning: "he himself" },
    "diversa": { lemma: "diversus, -a, -um", parsing: "abl. fem. sing.", meaning: "opposite, different" },
    "simulatione": { lemma: "simulatio, -onis (f.)", parsing: "abl. sing.", meaning: "with pretence, with simulation" },
    "maestus": { lemma: "maestus, -a, -um", parsing: "nom. masc. sing.", meaning: "sorrowful, sad, gloomy" },
    "quasi": { lemma: "quasi", parsing: "conjunction", meaning: "as if, as though" },
    "incolumitati": { lemma: "incolumitas, -atis (f.)", parsing: "dat. sing.", meaning: "to safety, to well-being" },
    "suae": { lemma: "suus, -a, -um", parsing: "dat. fem. sing.", meaning: "his own" },
    "infensus": { lemma: "infensus, -a, -um", parsing: "nom. masc. sing.", meaning: "hostile, angry" },
    "ac": { lemma: "ac/atque", parsing: "conjunction", meaning: "and" },
    "morti": { lemma: "mors, mortis (f.)", parsing: "dat. sing.", meaning: "to death" },
    "parentis": { lemma: "parens, parentis (m./f.)", parsing: "gen. sing.", meaning: "of parent, of mother" },
    "inlacrimans": { lemma: "inlacrimo, -are", parsing: "pres. act. part. nom. masc. sing.", meaning: "weeping over, shedding tears for" },
    "quia": { lemma: "quia", parsing: "conjunction", meaning: "because" },
    "tamen": { lemma: "tamen", parsing: "adverb", meaning: "however, nevertheless" },
    "non": { lemma: "non", parsing: "adverb", meaning: "not" },
    "ut": { lemma: "ut", parsing: "conjunction", meaning: "as, just as" },
    "hominum": { lemma: "homo, hominis (m.)", parsing: "gen. pl.", meaning: "of humans, of men" },
    "vultus": { lemma: "vultus, -us (m.)", parsing: "nom. pl.", meaning: "faces, expressions" },
    "ita": { lemma: "ita", parsing: "adverb", meaning: "so, thus" },
    "locorum": { lemma: "locus, -i (m.)", parsing: "gen. pl.", meaning: "of places" },
    "facies": { lemma: "facies, -ei (f.)", parsing: "nom. sing.", meaning: "appearance, aspect" },
    "mutantur": { lemma: "muto, -are, -avi, -atum", parsing: "pres. pass. ind. 3rd pl.", meaning: "are changed" },
    "obversabaturque": { lemma: "obversor, -ari + -que", parsing: "imperf. ind. dep. 3rd sing. + and", meaning: "and kept appearing, and presented itself" },
    "obversabatur": { lemma: "obversor, -ari", parsing: "imperf. ind. dep. 3rd sing.", meaning: "kept appearing, presented itself" },
    "maris": { lemma: "mare, maris (n.)", parsing: "gen. sing.", meaning: "of sea" },
    "illius": { lemma: "ille, illa, illud", parsing: "gen. sing.", meaning: "of that" },
    "litorum": { lemma: "litus, litoris (n.)", parsing: "gen. pl.", meaning: "of shores" },
    "gravis": { lemma: "gravis, -e", parsing: "nom. masc. sing.", meaning: "grievous, heavy, oppressive" },
    "aspectus": { lemma: "aspectus, -us (m.)", parsing: "nom. sing.", meaning: "sight, view" },
    "erant": { lemma: "sum, esse, fui", parsing: "imperf. ind. 3rd pl.", meaning: "there were" },
    "qui": { lemma: "qui, quae, quod", parsing: "nom. masc. pl.", meaning: "who" },
    "crederent": { lemma: "credo, -ere, credidi, creditum", parsing: "imperf. subj. 3rd pl.", meaning: "believed" },
    "sonitum": { lemma: "sonitus, -us (m.)", parsing: "acc. sing.", meaning: "sound" },
    "tubae": { lemma: "tuba, -ae (f.)", parsing: "gen. sing.", meaning: "of trumpet" },
    "collibus": { lemma: "collis, -is (m.)", parsing: "abl. pl.", meaning: "in/on the hills" },
    "circum": { lemma: "circum", parsing: "adverb/preposition", meaning: "around" },
    "editis": { lemma: "edo, -ere, edidi, editum", parsing: "perf. pass. part. abl. pl.", meaning: "lofty, elevated, raised" },
    "planctusque": { lemma: "planctus, -us (m.) + -que", parsing: "acc. sing. + and", meaning: "and groaning, and lamentation" },
    "planctus": { lemma: "planctus, -us (m.)", parsing: "acc. sing.", meaning: "groaning, lamentation" },
    "tumulo": { lemma: "tumulus, -i (m.)", parsing: "abl. sing.", meaning: "from tomb, from grave" },
    "audiri": { lemma: "audio, -ire, -ivi, -itum", parsing: "pres. pass. inf.", meaning: "to be heard" },
    "neapolim": { lemma: "Neapolis, -is (f.)", parsing: "acc. sing.", meaning: "to Naples" },
    "concessit": { lemma: "concedo, -ere, -cessi, -cessum", parsing: "perf. act. ind. 3rd sing.", meaning: "withdrew, retired, departed" },
    "litterasque": { lemma: "littera, -ae (f.) + -que", parsing: "acc. pl. + and", meaning: "and letter(s)" },
    "litteras": { lemma: "littera, -ae (f.)", parsing: "acc. pl.", meaning: "letter(s)" },
    "senatum": { lemma: "senatus, -us (m.)", parsing: "acc. sing.", meaning: "Senate" },
    "misit": { lemma: "mitto, -ere, misi, missum", parsing: "perf. act. ind. 3rd sing.", meaning: "sent" },
    "quarum": { lemma: "qui, quae, quod", parsing: "gen. fem. pl.", meaning: "of which" },
    "summa": { lemma: "summa, -ae (f.)", parsing: "nom. sing.", meaning: "gist, summary, main point" },
    "erat": { lemma: "sum, esse, fui", parsing: "imperf. ind. 3rd sing.", meaning: "was" },
    "repertum": { lemma: "reperio, -ire, repperi, repertum", parsing: "perf. pass. part. acc. masc. sing.", meaning: "discovered, found" },
    "cum": { lemma: "cum", parsing: "preposition + abl.", meaning: "with" },
    "ferro": { lemma: "ferrum, -i (n.)", parsing: "abl. sing.", meaning: "with sword, with iron" },
    "percussorem": { lemma: "percussor, -oris (m.)", parsing: "acc. sing.", meaning: "assassin, murderer" },
    "agerinum": { lemma: "Agerinus, -i (m.)", parsing: "acc. sing.", meaning: "Agerinus (freedman's name)" },
    "ex": { lemma: "ex", parsing: "preposition + abl.", meaning: "from among, out of" },
    "intimis": { lemma: "intimus, -a, -um", parsing: "abl. pl.", meaning: "closest, most intimate" },
    "agrippinae": { lemma: "Agrippina, -ae (f.)", parsing: "gen. sing.", meaning: "of Agrippina" },
    "libertis": { lemma: "libertus, -i (m.)", parsing: "abl. pl.", meaning: "freedmen" },
    "luisse": { lemma: "luo, -ere, lui", parsing: "perf. inf. act.", meaning: "to have paid, to have atoned" },
    "eam": { lemma: "is, ea, id", parsing: "acc. fem. sing.", meaning: "her" },
    "poenas": { lemma: "poena, -ae (f.)", parsing: "acc. pl.", meaning: "penalty, punishment" },
    "conscientia": { lemma: "conscientia, -ae (f.)", parsing: "abl. sing.", meaning: "from guilt, from conscience" },
    "scelus": { lemma: "scelus, sceleris (n.)", parsing: "acc. sing.", meaning: "crime" },
    "paravisset": { lemma: "paro, -are, -avi, -atum", parsing: "pluperf. subj. act. 3rd sing.", meaning: "had prepared, had planned" }
};

const latinSentences = [
    "sed a Caesare perfecto demum scelere magnitudo eius intellecta est.",
    "reliquo noctis modo per silentium defixus, saepius pavore exsurgens et mentis inops lucem opperiebatur tamquam exitium adlaturam.",
    "atque eum auctore Burro prima centurionum tribunorumque adulatio ad spem firmavit, prensantium manum gratantiumque quod discrimen improvisum et matris facinus evasisset.",
    "amici dehinc adire templa et coepto exemplo proxima Campaniae municipia victimis et legationibus laetitiam testari:",
    "ipse diversa simulatione maestus et quasi incolumitati suae infensus ac morti parentis inlacrimans.",
    "quia tamen non, ut hominum vultus, ita locorum facies mutantur, obversabaturque maris illius et litorum gravis aspectus",
    "(et erant qui crederent sonitum tubae collibus circum editis planctusque tumulo matris audiri),",
    "Neapolim concessit litterasque ad senatum misit quarum summa erat repertum cum ferro percussorem Agerinum, ex intimis Agrippinae libertis, et luisse eam poenas conscientia quasi scelus paravisset."
];

// Three-tier stylistic analysis data for Annals 14.10
// Tier 1 (Red): Sound/Word-level devices
// Tier 2 (Yellow): Syntax/Phrase-level devices
// Tier 3 (Green): Narrative/Passage-level devices
const styleData = {
    "perfecto": {
        tier: 1,
        words: ["perfecto"],
        device: "Emphatic Word Placement",
        effect: "The ablative absolute 'perfecto...scelere' places the completed crime at the sentence's opening, forcing the reader to confront the deed before learning its psychological impact. The word order enacts Nero's belated realisation."
    },
    "defixus": {
        tier: 1,
        words: ["defixus"],
        device: "Metaphor of Paralysis",
        effect: "From 'defigo' (to pierce, transfix), suggesting Nero is pinned in place like a victim. The passive participle transforms the murderer into one psychologically impaled by his own crime."
    },
    "modo": {
        tier: 2,
        words: ["modo", "saepius"],
        device: "Antithetical Pairing",
        effect: "The contrast between 'modo' (at times) and 'saepius' (more often) creates a rhythm of Nero's alternating states - frozen silence versus panicked movement. Fear dominates, shown by the comparative."
    },
    "mentis": {
        tier: 1,
        words: ["mentis", "inops"],
        device: "Psychological Vocabulary",
        effect: "'Mentis inops' (bereft of mind/purpose) is devastatingly precise - Nero has lost not just composure but the very faculty of rational thought. The genitive of separation emphasises complete emptiness."
    },
    "tamquam": {
        tier: 2,
        words: ["tamquam", "exitium", "adlaturam"],
        device: "Ironic Simile",
        effect: "Nero awaits dawn 'as if it would bring destruction' - deeply ironic since he has just brought destruction to his mother. Light, normally salvation, becomes threat. The personification of dawn as destroyer inverts natural symbolism."
    },
    "adulatio": {
        tier: 3,
        words: ["adulatio"],
        device: "Political Commentary",
        effect: "Tacitus's loaded term 'adulatio' (flattery/sycophancy) exposes the corruption of Roman political culture. Military officers, whose duty is honesty, become agents of propaganda. The word condemns an entire system."
    },
    "prensantium": {
        tier: 1,
        words: ["prensantium", "manum", "gratantiumque"],
        device: "Physical Detail",
        effect: "The vivid participles create visceral imagery - officers literally grasping Nero's hand and offering congratulations. This physical intimacy with a matricide shows how deeply complicity is embodied."
    },
    "matris": {
        tier: 3,
        words: ["matris", "facinus"],
        device: "Narrative Inversion",
        effect: "The phrase 'matris facinus' (mother's crime) enacts the cover-up within the prose - Agrippina, the victim, is linguistically transformed into the criminal. Tacitus shows propaganda corrupting language itself."
    },
    "diversa": {
        tier: 2,
        words: ["diversa", "simulatione", "maestus"],
        device: "Oxymoronic Grief",
        effect: "'Diversa simulatione' (with opposite pretence) exposes Nero's performance as its inverse - he acts sad precisely because he is not. 'Maestus' (sorrowful) becomes a mask word, emptied of genuine emotion."
    },
    "vultus": {
        tier: 3,
        words: ["hominum", "vultus", "locorum", "facies"],
        device: "Gnomic Sententia",
        effect: "This philosophical observation - that places cannot dissemble like human faces - carries devastating moral weight. Nature becomes the only honest witness; the landscape refuses to participate in Nero's lies."
    },
    "sonitum": {
        tier: 2,
        words: ["sonitum", "tubae", "planctusque", "tumulo"],
        device: "Supernatural Atmosphere",
        effect: "The ghostly trumpet and groaning from Agrippina's grave introduce supernatural witnesses. Roman belief held that murdered spirits were restless; these omens suggest divine judgement that human courts cannot provide."
    },
    "quasi": {
        tier: 3,
        words: ["quasi", "scelus", "paravisset"],
        device: "Climactic Irony",
        effect: "The final 'quasi scelus paravisset' (as if she had planned the crime) completes the inversion: victim becomes plotter, murderer becomes intended victim. The subjunctive 'paravisset' marks this as official fiction, not fact."
    }
};

const resources = {
    summary: `<h4>Summary</h4>
<p>Only after completing matricide does Nero grasp its enormity. He spends the rest of the night alternating between stunned silence and terrified pacing, mentally broken, waiting for dawn as if it will bring his doom. Burrus orchestrates military flattery - centurions and tribunes grasp Nero's hand, congratulating him on "escaping" his mother's "plot." This begins the official lie.</p>
<p>Friends visit temples giving thanks; nearby towns send sacrifices and embassies celebrating. Meanwhile, Nero performs opposite grief - weeping for his mother, acting angry at surviving. But the landscape won't change like human faces can - the sea and shore constantly remind him. Some claim to hear ghostly trumpets from the hills and groaning from Agrippina's grave.</p>
<p>Unable to bear it, Nero flees to Naples and writes to the Senate, claiming Agerinus was caught with a sword as Agrippina's assassin, and she killed herself from guilt after her plot failed. The cover-up is complete: victim becomes criminal, murderer becomes intended victim.</p>`,
    context: `<h4>Historical Context</h4>
<p><strong>Military Flattery:</strong> Roman military culture required soldiers to congratulate commanders on surviving danger - Burrus exploits this tradition to create "evidence" of assassination attempt. The centurions and tribunes who participated became bound to the lie through their own complicity.</p>
<p><strong>Temple Visits and Sacrifices:</strong> Temple visits and sacrifices were standard responses to imperial deliverance from danger, creating public record of the false narrative. Campanian towns' participation shows how provincial communities were pressured to endorse official stories.</p>
<p><strong>Supernatural Elements:</strong> The supernatural elements (trumpet sounds, groaning) reflect Roman belief in restless spirits of the murdered, especially those denied proper burial. These omens suggest divine disapproval and hint at future consequences.</p>
<p><strong>Naples as Refuge:</strong> Naples (Neapolis) was culturally Greek, perhaps psychologically "foreign" enough for Nero to escape Roman guilt. The city was also associated with artistic culture that Nero favoured.</p>
<p><strong>The Senate Letter:</strong> Senate letters were official communications that became historical record - Nero's version would become "truth." The letter to the Senate represents the final transformation of the narrative from crime to justified response.</p>`,
    comprehension: `<h4>Comprehension Questions</h4>
<p><strong>Line 1:</strong> What does "perfecto demum scelere" suggest about Nero's psychological state during the murder? Why does realisation come only after completion?</p>
<p><strong>Lines 2:</strong> How do "modo per silentium defixus" and "saepius pavore exsurgens" characterise Nero's night? What does "mentis inops" reveal about his mental state?</p>
<p><strong>Line 3:</strong> What role does Burrus play in managing the aftermath? How does the military flattery function as political manipulation?</p>
<p><strong>Lines 4-5:</strong> What is the significance of "diversa simulatione"? How does Nero's public performance contrast with reality?</p>
<p><strong>Line 6:</strong> What does the phrase "ut hominum vultus, ita locorum facies mutantur" mean? Why is this observation significant?</p>
<p><strong>Line 7:</strong> What supernatural elements appear? What do they suggest about Roman beliefs regarding the murdered?</p>
<p><strong>Line 8:</strong> How does the letter to the Senate complete the cover-up? What is the significance of reversing the roles of victim and criminal?</p>
<p><strong>Overall:</strong> How does Tacitus use this passage to expose the mechanics of imperial propaganda and the corruption of truth?</p>`
};

let currentPopup = null;
let sentenceModeActive = false;
let currentSentenceIndex = 0;
let pointerModeActive = false;
let styleModeActive = false;

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    savePreference('darkMode', isDark);

    const btn = event.currentTarget;
    if (isDark) {
        btn.textContent = '‚òÄÔ∏è Light';
        btn.classList.add('active');
    } else {
        btn.textContent = 'üåô Dark';
        btn.classList.remove('active');
    }
}

function toggleFullScreen() {
    document.body.classList.toggle('full-screen');
    const btn = event.currentTarget;
    if (document.body.classList.contains('full-screen')) {
        btn.textContent = '‚õ∂ Exit Full Screen';
        btn.classList.add('active');
    } else {
        btn.textContent = '‚õ∂ Full Screen';
        btn.classList.remove('active');
    }
}

function toggleLineNumbers() {
    const latinText = document.getElementById('latinText');
    latinText.classList.toggle('show-lines');
    const showLines = latinText.classList.contains('show-lines');
    savePreference('lineNumbers', showLines);

    const btn = event.currentTarget;
    btn.classList.toggle('active');
}

function togglePointerMode() {
    pointerModeActive = !pointerModeActive;
    document.body.classList.toggle('pointer-mode');
    const btn = event.currentTarget;
    btn.classList.toggle('active');

    // Exit style mode if entering pointer mode
    if (pointerModeActive && styleModeActive) {
        toggleStyleMode();
    }

    if (!pointerModeActive) {
        // Clear all pointed words when exiting pointer mode
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
    }

    // Hide vocab popup when entering pointer mode
    if (pointerModeActive) {
        hidePopup();
    }
}

function toggleStyleMode() {
    styleModeActive = !styleModeActive;
    document.body.classList.toggle('style-mode');

    const btn = document.querySelector('.btn-group .btn:nth-child(5)');
    btn.classList.toggle('active');

    // Exit pointer mode if entering style mode
    if (styleModeActive && pointerModeActive) {
        pointerModeActive = false;
        document.body.classList.remove('pointer-mode');
        document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
        document.querySelectorAll('.btn').forEach(b => {
            if (b.textContent === 'Pointer Mode') b.classList.remove('active');
        });
    }

    if (styleModeActive) {
        // Apply style highlighting
        applyStyleHighlighting();
        hidePopup();
    } else {
        // Remove style highlighting
        removeStyleHighlighting();
        hideStylePopup();
    }
}

function applyStyleHighlighting() {
    for (const [key, data] of Object.entries(styleData)) {
        data.words.forEach(word => {
            document.querySelectorAll(`.word[data-word="${word.toLowerCase()}"]`).forEach(el => {
                el.classList.add(`style-tier-${data.tier}`);
                el.dataset.styleKey = key;
            });
        });
    }
}

function removeStyleHighlighting() {
    document.querySelectorAll('.word').forEach(el => {
        el.classList.remove('style-tier-1', 'style-tier-2', 'style-tier-3');
        delete el.dataset.styleKey;
    });
}

function showStylePopup(event, styleKey) {
    const popup = document.getElementById('stylePopup');
    const data = styleData[styleKey];

    if (!data) {
        popup.classList.remove('visible');
        return;
    }

    const tierLabels = {
        1: 'Sound & Word Level',
        2: 'Syntax & Phrase Level',
        3: 'Narrative & Passage Level'
    };

    popup.innerHTML = `
        <span class="tier-badge tier-${data.tier}">${tierLabels[data.tier]}</span>
        <h4 class="tier-${data.tier}">${data.words.join(' ')}</h4>
        <div class="device">${data.device}</div>
        <div class="effect">${data.effect}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 340;
    const popupHeight = 200;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');
}

function hideStylePopup() {
    const popup = document.getElementById('stylePopup');
    popup.classList.remove('visible');
}

function toggleSentenceMode() {
    const latinText = document.getElementById('latinText');
    const sentenceNav = document.getElementById('sentenceNav');
    const btn = event.currentTarget;

    sentenceModeActive = !sentenceModeActive;

    if (sentenceModeActive) {
        latinText.classList.add('sentence-mode');
        sentenceNav.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'Full Text';
        currentSentenceIndex = 0;
        updateSentenceDisplay();
    } else {
        latinText.classList.remove('sentence-mode');
        sentenceNav.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Sentence Mode';
        // Remove current-sentence class from all
        document.querySelectorAll('.latin-text p').forEach(p => p.classList.remove('current-sentence'));
    }
}

function updateSentenceDisplay() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    paragraphs.forEach((p, i) => {
        if (i === currentSentenceIndex) {
            p.classList.add('current-sentence');
        } else {
            p.classList.remove('current-sentence');
        }
    });
    document.getElementById('sentenceCounter').textContent = `${currentSentenceIndex + 1} / ${paragraphs.length}`;

    // Update button states
    const navButtons = document.querySelectorAll('.sentence-nav button');
    navButtons[0].disabled = currentSentenceIndex === 0;
    navButtons[1].disabled = currentSentenceIndex === paragraphs.length - 1;
}

function prevSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function nextSentence() {
    const paragraphs = document.querySelectorAll('.latin-text p');
    if (currentSentenceIndex < paragraphs.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
        hidePopup();
        hideStylePopup();
    }
}

function generateLatinHTML() {
    let html = '';
    latinSentences.forEach((sentence, index) => {
        // Split into tokens, keeping punctuation attached to words
        const tokens = sentence.match(/[a-zA-Z]+[.,;:()]*|[.,;:()]+/g);
        html += '<p style="margin-bottom: 1.5rem;">';
        html += `<span class="line-number">${index + 1}</span>`;
        html += '<span class="line-content">';
        if (tokens) {
            tokens.forEach((token, i) => {
                // Separate word from trailing punctuation
                const match = token.match(/^([a-zA-Z]+)([.,;:()]*)$/);
                if (match) {
                    const word = match[1];
                    const punct = match[2];
                    const lookupWord = word.toLowerCase();

                    // Check if this word has style data
                    let styleClass = '';
                    let styleKey = '';
                    if (styleModeActive) {
                        for (const [key, data] of Object.entries(styleData)) {
                            if (data.words.map(w => w.toLowerCase()).includes(lookupWord)) {
                                styleClass = ` style-tier-${data.tier}`;
                                styleKey = ` data-style-key="${key}"`;
                                break;
                            }
                        }
                    }

                    html += `<span class="word${styleClass}" data-word="${lookupWord}"${styleKey}>${word}</span>${punct}`;
                    // Add space after unless it's the last token
                    if (i < tokens.length - 1) html += ' ';
                } else {
                    // Just punctuation
                    html += token + ' ';
                }
            });
        }
        html += '</span></p>';
    });
    return html;
}

function showVocabPopup(event, word) {
    const popup = document.getElementById('vocabPopup');
    const wordData = vocab[word.toLowerCase()];

    // Remove active class from all words
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));

    if (!wordData) {
        popup.classList.remove('visible');
        return;
    }

    // Add active class to clicked word
    event.target.classList.add('active');

    popup.innerHTML = `
        <h4>${word}</h4>
        <div class="parsing">${wordData.parsing}</div>
        <div class="meaning">${wordData.meaning}</div>
        <div class="principal-parts">${wordData.lemma}</div>
    `;

    // Position popup near the word
    const rect = event.target.getBoundingClientRect();
    const popupWidth = 300;
    const popupHeight = 150;

    let left = rect.left + (rect.width / 2) - (popupWidth / 2);
    let top = rect.bottom + 12;
    let arrowBottom = false;

    // Keep popup within viewport horizontally
    if (left < 10) left = 10;
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
    }

    // If popup would go below viewport, show above word
    if (top + popupHeight > window.innerHeight) {
        top = rect.top - popupHeight - 12;
        arrowBottom = true;
    }

    // Calculate arrow position relative to popup
    const wordCenterX = rect.left + (rect.width / 2);
    const arrowLeft = Math.max(20, Math.min(popupWidth - 20, wordCenterX - left));

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.setProperty('--arrow-left', arrowLeft + 'px');
    popup.classList.toggle('arrow-bottom', arrowBottom);
    popup.classList.add('visible');

    currentPopup = popup;
}

function hidePopup() {
    const popup = document.getElementById('vocabPopup');
    popup.classList.remove('visible');
    document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
}

function toggleTranslation() {
    const box = document.getElementById('translationBox');
    const btn = event.currentTarget;

    if (box.classList.contains('active')) {
        box.classList.remove('active');
        btn.textContent = 'Translation';
        btn.classList.remove('active');
    } else {
        box.classList.add('active');
        btn.textContent = 'Hide Translation';
        btn.classList.add('active');
    }
}

function showView(view) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const textCard = document.getElementById('textCard');
    const resourceCard = document.getElementById('resourceCard');

    if (view === 'text') {
        textCard.style.display = 'block';
        resourceCard.style.display = 'none';
    } else {
        textCard.style.display = 'none';
        resourceCard.style.display = 'block';
        document.getElementById('resourceTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.getElementById('resourceContent').innerHTML = resources[view];
    }
}

// Initialise
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('latinText').innerHTML = generateLatinHTML();

    // Load saved preferences
    loadPreferences();

    // Add click handlers to words
    document.querySelectorAll('.word').forEach(word => {
        word.addEventListener('click', function(e) {
            e.stopPropagation();

            if (pointerModeActive) {
                // Toggle pointed class
                this.classList.toggle('pointed');
            } else if (styleModeActive && this.dataset.styleKey) {
                // Show style popup
                hidePopup();
                showStylePopup(e, this.dataset.styleKey);
            } else if (styleModeActive) {
                // In style mode but word has no style data - hide popups
                hideStylePopup();
                hidePopup();
            } else {
                // Normal vocab mode
                hideStylePopup();
                showVocabPopup(e, this.dataset.word);
            }
        });
    });

    // Hide popup when clicking elsewhere, clear pointer highlights on background click
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('word')) {
            hidePopup();
            hideStylePopup();

            // If in pointer mode and clicking background (not buttons), clear all highlights
            if (pointerModeActive && !e.target.closest('.btn-group') && !e.target.closest('.sentence-nav')) {
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to exit full screen
        if (e.key === 'Escape') {
            if (document.body.classList.contains('full-screen')) {
                document.body.classList.remove('full-screen');
                const btn = document.querySelector('.btn-group .btn:last-child');
                if (btn) {
                    btn.textContent = '‚õ∂ Full Screen';
                    btn.classList.remove('active');
                }
            }
            // Also exit pointer mode on escape
            if (pointerModeActive) {
                pointerModeActive = false;
                document.body.classList.remove('pointer-mode');
                document.querySelectorAll('.word.pointed').forEach(w => w.classList.remove('pointed'));
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Pointer Mode') btn.classList.remove('active');
                });
            }
            // Also exit style mode on escape
            if (styleModeActive) {
                styleModeActive = false;
                document.body.classList.remove('style-mode');
                removeStyleHighlighting();
                hideStylePopup();
                document.querySelectorAll('.btn').forEach(btn => {
                    if (btn.textContent === 'Style') btn.classList.remove('active');
                });
            }
        }

        // Arrow keys for sentence navigation
        if (sentenceModeActive) {
            if (e.key === 'ArrowLeft') {
                prevSentence();
            } else if (e.key === 'ArrowRight') {
                nextSentence();
            }
        }
    });
});

function loadPreferences() {
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent.includes('Dark')) {
                    btn.textContent = '‚òÄÔ∏è Light';
                    btn.classList.add('active');
                }
            });
        }, 0);
    }

    // Line numbers
    if (localStorage.getItem('lineNumbers') === 'true') {
        document.getElementById('latinText').classList.add('show-lines');
        setTimeout(() => {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.textContent === 'Line Numbers') {
                    btn.classList.add('active');
                }
            });
        }, 0);
    }
}

function savePreference(key, value) {
    localStorage.setItem(key, value);
}
    </script>
</body>
</html>
