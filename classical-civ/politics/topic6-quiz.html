<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic 6 Retrieval Practice - Classicalia</title>
    <link rel="icon" type="image/png" href="../../images/favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #f8f9fa; min-height: 100vh; display: flex; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e5e7eb; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .logo-section { padding: 1.5rem 1.25rem; border-bottom: 1px solid #e5e7eb; }
        .logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 1.1rem; }
        .logo-text { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        .nav-section { padding: 1rem 0.5rem; }
        .nav-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.05em; padding: 0 0.75rem; margin-bottom: 0.5rem; }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.75rem; margin: 0.125rem 0; border-radius: 8px; color: #4b5563; font-size: 0.9rem; text-decoration: none; transition: all 0.15s ease; }
        .nav-item:hover { background: #f3f4f6; color: #1f2937; }
        .nav-item.active { background: #eef2ff; color: #0066ff; font-weight: 500; }
        .nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .back-link { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: #6b7280; text-decoration: none; font-size: 0.85rem; border-bottom: 1px solid #e5e7eb; transition: all 0.15s ease; }
        .back-link:hover { background: #f9fafb; color: #0066ff; }
        .main-content { margin-left: 260px; flex: 1; display: flex; flex-direction: column; }
        .top-bar { background: white; border-bottom: 1px solid #e5e7eb; padding: 0.875rem 2rem; position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        .info-btn { width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; transition: all 0.15s ease; }
        .info-btn:hover { background: #e5e7eb; }
        .content-wrapper { flex: 1; overflow-y: auto; }
        .content-container { width: 100%; padding: 2rem 3rem; max-width: 1000px; margin: 0 auto; }
        .quiz-header { margin-bottom: 2rem; }
        .quiz-title { font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; }
        .quiz-meta { display: flex; gap: 1.5rem; font-size: 0.875rem; color: #6b7280; }
        .quiz-badge { background: linear-gradient(135deg, #0066ff 0%, #4d94ff 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 1.5rem; }
        .section-intro { background: #eff6ff; border-left: 4px solid #0066ff; padding: 1rem 1.25rem; border-radius: 0 8px 8px 0; margin-bottom: 1.5rem; }
        .section-intro h3 { color: #1e40af; margin-bottom: 0.5rem; font-size: 1rem; }
        .section-intro p { color: #1e40af; font-size: 0.9rem; line-height: 1.6; }
        .quiz-mode-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .mode-option { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.2s ease; text-align: center; }
        .mode-option:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0, 102, 255, 0.1); border-color: #0066ff; }
        .mode-title { font-size: 1.1rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; }
        .mode-description { color: #6b7280; font-size: 0.85rem; line-height: 1.5; margin-bottom: 1rem; }
        .mode-stats { display: flex; justify-content: center; gap: 0.75rem; font-size: 0.75rem; color: #0066ff; font-weight: 600; }
        .subtopic-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .subtopic-option { background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; cursor: pointer; transition: all 0.2s ease; text-align: center; }
        .subtopic-option:hover { border-color: #0066ff; background: #f0f7ff; }
        .subtopic-option.selected { border-color: #0066ff; background: #eff6ff; }
        .subtopic-title { font-size: 0.9rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
        .subtopic-description { color: #6b7280; font-size: 0.75rem; }
        .question-screen { display: none; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #eff6ff; }
        .question-number { background: #0066ff; color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem; }
        .question-info { flex: 1; margin-left: 1rem; }
        .question-type { font-size: 0.8rem; color: #0066ff; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem; }
        .question-topic { font-size: 0.9rem; color: #6b7280; }
        .progress-info { text-align: right; color: #6b7280; font-size: 0.85rem; }
        .question-text { font-size: 1.15rem; color: #1f2937; margin-bottom: 1.5rem; font-weight: 500; line-height: 1.5; }
        .answer-input { width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s ease; }
        .answer-input:focus { outline: none; border-color: #0066ff; }
        .multiple-choice { display: grid; gap: 0.75rem; }
        .choice-option { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; }
        .choice-option:hover { border-color: #0066ff; background: #f0f7ff; }
        .choice-option.selected { border-color: #0066ff; background: #eff6ff; }
        .choice-letter { background: #0066ff; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; margin-right: 1rem; flex-shrink: 0; }
        .drag-drop-container { min-height: 280px; }
        .drag-instruction { text-align: center; color: #6b7280; font-style: italic; margin-bottom: 1rem; font-size: 0.9rem; }
        .drag-items { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb; }
        .drag-item { background: #0066ff; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: grab; user-select: none; transition: all 0.2s ease; font-size: 0.85rem; }
        .drag-item:hover { background: #0052cc; transform: scale(1.05); }
        .drag-item.dragging { opacity: 0.5; cursor: grabbing; }
        .drop-zones { display: grid; gap: 1rem; }
        .drop-zone { border: 2px dashed #e5e7eb; border-radius: 8px; padding: 1rem; min-height: 70px; background: #f9fafb; transition: all 0.2s ease; }
        .drop-zone.drag-over { border-color: #0066ff; background: #f0f7ff; }
        .drop-zone-title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .dropped-items { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .dropped-item { background: #10b981; color: white; padding: 0.3rem 0.75rem; border-radius: 15px; font-size: 0.8rem; }
        .gap-fill-container { line-height: 2; font-size: 1.05rem; color: #1f2937; }
        .gap-input { display: inline-block; border: none; border-bottom: 2px solid #0066ff; background: transparent; padding: 0.2rem 0.5rem; font-size: 1rem; margin: 0 0.2rem; min-width: 100px; text-align: center; }
        .gap-input:focus { outline: none; background: #f0f7ff; }
        .feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none; border-left: 4px solid; }
        .feedback.correct { background: #d1fae5; border-left-color: #10b981; color: #065f46; }
        .feedback.incorrect { background: #fee2e2; border-left-color: #ef4444; color: #991b1b; }
        .feedback.partial { background: #fef3c7; border-left-color: #f59e0b; color: #92400e; }
        .feedback-header { font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .feedback-explanation { font-size: 0.9rem; line-height: 1.5; }
        .question-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
        .btn-primary { background: #0066ff; color: white; }
        .btn-primary:hover { background: #0052cc; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress-text { color: #6b7280; font-size: 0.85rem; }
        .results-screen { display: none; text-align: center; }
        .results-score { font-size: 4rem; font-weight: 700; color: #0066ff; margin-bottom: 0.5rem; }
        .results-message { font-size: 1.1rem; color: #1f2937; margin-bottom: 2rem; }
        .results-breakdown { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 2rem 0; }
        .breakdown-item { background: #f9fafb; padding: 1.25rem; border-radius: 8px; border: 1px solid #e5e7eb; }
        .breakdown-number { font-size: 1.75rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
        .breakdown-label { color: #6b7280; font-size: 0.85rem; }
        .restart-btn { display: inline-block; margin-top: 1.5rem; padding: 0.75rem 2rem; background: #0066ff; color: white; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .restart-btn:hover { background: #0052cc; transform: translateY(-2px); }
        @media (max-width: 1024px) { .quiz-mode-selector { grid-template-columns: 1fr; } .subtopic-selector { grid-template-columns: repeat(2, 1fr); } .results-breakdown { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } .content-container { padding: 1.5rem; } .quiz-title { font-size: 1.5rem; } .subtopic-selector { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <a href="index.html" class="back-link">‚Üê Back to Course</a>
        <div class="logo-section">
            <a href="../../index.html" class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Classicalia</span>
            </a>
        </div>
        <nav class="nav-section">
            <div class="nav-title">Topic 6 Lessons</div>
            <a href="6-1/index.html" class="nav-item"><span class="nav-icon">üìñ</span><span>6.1 Mark Antony and Octavian</span></a>
            <a href="6-2/index.html" class="nav-item"><span class="nav-icon">üìú</span><span>6.2 Cicero's Final Stand</span></a>
            <a href="6-3/index.html" class="nav-item"><span class="nav-icon">‚öîÔ∏è</span><span>6.3 The Second Triumvirate</span></a>
            <a href="6-4/index.html" class="nav-item"><span class="nav-icon">üèõÔ∏è</span><span>6.4 Legacy and Comparison</span></a>
            <a href="topic6-quiz.html" class="nav-item active"><span class="nav-icon">üéØ</span><span>Topic 6 Quiz</span></a>
        </nav>
        <nav class="nav-section">
            <div class="nav-title">Other Quizzes</div>
            <a href="topic1-quiz.html" class="nav-item"><span class="nav-icon">üìù</span><span>Topic 1 Quiz</span></a>
            <a href="topic2-quiz.html" class="nav-item"><span class="nav-icon">üìù</span><span>Topic 2 Quiz</span></a>
            <a href="topic4-quiz.html" class="nav-item"><span class="nav-icon">üìù</span><span>Topic 4 Quiz</span></a>
            <a href="topic5-quiz.html" class="nav-item"><span class="nav-icon">üìù</span><span>Topic 5 Quiz</span></a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar"><span></span><button class="info-btn" onclick="showInfoModal()">‚ÑπÔ∏è</button></div>
        <div class="content-wrapper">
            <div class="content-container">
                <header class="quiz-header">
                    <h1 class="quiz-title">Topic 6 Retrieval Practice</h1>
                    <div class="quiz-meta">
                        <span>üìö The Death of the Republic</span>
                        <span>üéØ Knowledge Check</span>
                        <span class="quiz-badge">Interactive</span>
                    </div>
                </header>

                <div class="card">
                    <div class="section-intro">
                        <h3>The Death of the Republic (44-27 BC)</h3>
                        <p>Comprehensive practice covering Mark Antony and Octavian, Cicero's Final Stand, The Second Triumvirate, and Legacy and Comparison. Questions are drawn from your lesson content and designed to prepare you for assessments.</p>
                    </div>

                    <div class="content-body">
                        <div id="mode-selection-screen">
                            <div class="subtopic-selector" id="subtopic-selector">
                                <div class="subtopic-option" onclick="selectSubtopic('6.1')" data-subtopic="6.1">
                                    <div class="subtopic-title">Topic 6.1</div>
                                    <div class="subtopic-description">Mark Antony and Octavian</div>
                                </div>
                                <div class="subtopic-option" onclick="selectSubtopic('6.2')" data-subtopic="6.2">
                                    <div class="subtopic-title">Topic 6.2</div>
                                    <div class="subtopic-description">Cicero's Final Stand</div>
                                </div>
                                <div class="subtopic-option" onclick="selectSubtopic('6.3')" data-subtopic="6.3">
                                    <div class="subtopic-title">Topic 6.3</div>
                                    <div class="subtopic-description">The Second Triumvirate</div>
                                </div>
                                <div class="subtopic-option" onclick="selectSubtopic('6.4')" data-subtopic="6.4">
                                    <div class="subtopic-title">Topic 6.4</div>
                                    <div class="subtopic-description">Legacy and Comparison</div>
                                </div>
                            </div>

                            <div class="quiz-mode-selector">
                                <div class="mode-option" onclick="startQuiz('comprehensive')">
                                    <div class="mode-title">Comprehensive Review</div>
                                    <div class="mode-description">30 questions covering all lesson content. Includes complex scenarios and detailed knowledge checks.</div>
                                    <div class="mode-stats"><span>üìö All Topics</span><span>‚è±Ô∏è 20-25 mins</span></div>
                                </div>
                                <div class="mode-option" onclick="startQuiz('quick')">
                                    <div class="mode-title">Quick Check</div>
                                    <div class="mode-description">15 key questions for rapid review. Perfect for consolidating main concepts.</div>
                                    <div class="mode-stats"><span>‚ö° Key Concepts</span><span>‚è±Ô∏è 10-12 mins</span></div>
                                </div>
                                <div class="mode-option" onclick="startQuiz('detailed')">
                                    <div class="mode-title">Detailed Knowledge</div>
                                    <div class="mode-description">20 questions focusing on specific details from lesson content.</div>
                                    <div class="mode-stats"><span>üîç Deep Dive</span><span>‚è±Ô∏è 15-18 mins</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="question-screen" id="question-screen">
                            <div class="question-header">
                                <div class="question-number" id="question-number">1</div>
                                <div class="question-info">
                                    <div class="question-type" id="question-type">Multiple Choice</div>
                                    <div class="question-topic" id="question-topic">Topic 6.1</div>
                                </div>
                                <div class="progress-info"><div class="progress-text" id="progress-text">Question 1 of 30</div></div>
                            </div>
                            <div class="question-content">
                                <div class="question-text" id="question-text">Loading question...</div>
                                <div id="answer-area"></div>
                                <div class="feedback" id="feedback">
                                    <div class="feedback-header"><span id="feedback-icon">‚úì</span><span id="feedback-title">Correct!</span></div>
                                    <div class="feedback-explanation" id="feedback-explanation"></div>
                                </div>
                            </div>
                            <div class="question-controls">
                                <button class="btn btn-secondary" id="prev-btn" onclick="previousQuestion()">Previous</button>
                                <div class="progress-text" id="progress-indicator">Question 1 of 30</div>
                                <button class="btn btn-primary" id="check-btn" onclick="checkAnswer()">Check Answer</button>
                                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display: none;">Next Question</button>
                            </div>
                        </div>

                        <div class="results-screen" id="results-screen">
                            <div class="results-score" id="final-score">85%</div>
                            <div class="results-message" id="results-message">Excellent work!</div>
                            <div class="results-breakdown">
                                <div class="breakdown-item"><div class="breakdown-number" id="correct-count">26</div><div class="breakdown-label">Correct</div></div>
                                <div class="breakdown-item"><div class="breakdown-number" id="partial-count">2</div><div class="breakdown-label">Partial</div></div>
                                <div class="breakdown-item"><div class="breakdown-number" id="incorrect-count">2</div><div class="breakdown-label">Incorrect</div></div>
                                <div class="breakdown-item"><div class="breakdown-number" id="completion-time">18</div><div class="breakdown-label">Minutes</div></div>
                            </div>
                            <button class="restart-btn" onclick="restartQuiz()">Practice Again</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/auth/config.js"></script>
    <script src="/shared/xp-system.js"></script>
    <script src="/shared/task-tracker.js"></script>
    <script src="topic6-questions.js"></script>
    <script>
        let currentMode = '', selectedSubtopics = [], currentQuestions = [], currentQuestionIndex = 0, userAnswers = [], quizStartTime = null, draggedItem = null;
        function showInfoModal() { alert('Welcome to Topic 6 Retrieval Practice!\n\nThis quiz covers The Death of the Republic (44-27 BC).\n\nCreated by Lawrence McNally'); }
        function selectSubtopic(subtopic) { const option = document.querySelector(`[data-subtopic="${subtopic}"]`); if (option.classList.contains('selected')) { option.classList.remove('selected'); selectedSubtopics = selectedSubtopics.filter(s => s !== subtopic); } else { option.classList.add('selected'); selectedSubtopics.push(subtopic); } }
        async function startQuiz(mode) { currentMode = mode; let questionsToUse = [...questionBank[currentMode]]; if (selectedSubtopics.length > 0) { questionsToUse = questionsToUse.filter(q => selectedSubtopics.some(st => q.topic.includes(st))); } if (questionsToUse.length === 0) { alert('No questions found for selected subtopics.'); return; } currentQuestions = questionsToUse.sort(() => Math.random() - 0.5); currentQuestionIndex = 0; userAnswers = []; quizStartTime = Date.now(); if (typeof taskTracker !== 'undefined') { taskTracker.setLanguage('classics'); await taskTracker.start(); } document.getElementById('mode-selection-screen').style.display = 'none'; document.getElementById('question-screen').style.display = 'block'; loadQuestion(); }
        function normaliseText(text) { return text.toLowerCase().trim().replace(/[^\w\s]/g, '').replace(/\s+/g, ' '); }
        function checkFlexibleAnswer(userInput, correctAnswers, acceptableVariations) { const normalised = normaliseText(userInput); for (let answer of correctAnswers) { if (normalised.includes(normaliseText(answer)) || normaliseText(answer).includes(normalised)) return 'correct'; } for (let variation of acceptableVariations) { if (normalised.includes(normaliseText(variation)) || normaliseText(variation).includes(normalised)) return 'correct'; } for (let answer of [...correctAnswers, ...acceptableVariations]) { const words = normaliseText(answer).split(' '); const userWords = normalised.split(' '); const matchingWords = words.filter(word => userWords.some(userWord => userWord.includes(word) || word.includes(userWord))); if (matchingWords.length >= Math.ceil(words.length * 0.6)) return 'partial'; } return 'incorrect'; }
        function loadQuestion() { const question = currentQuestions[currentQuestionIndex]; document.getElementById('question-number').textContent = currentQuestionIndex + 1; document.getElementById('question-type').textContent = formatQuestionType(question.type); document.getElementById('question-topic').textContent = question.topic; document.getElementById('question-text').textContent = question.question; document.getElementById('progress-text').textContent = `Question ${currentQuestionIndex + 1} of ${currentQuestions.length}`; document.getElementById('progress-indicator').textContent = `Question ${currentQuestionIndex + 1} of ${currentQuestions.length}`; document.getElementById('feedback').style.display = 'none'; document.getElementById('check-btn').style.display = 'inline-block'; document.getElementById('next-btn').style.display = 'none'; loadAnswerArea(question); document.getElementById('prev-btn').disabled = currentQuestionIndex === 0; }
        function formatQuestionType(type) { const types = {'multiple-choice': 'Multiple Choice', 'text-flexible': 'Short Answer', 'scenario': 'Scenario Analysis', 'drag-drop': 'Drag and Drop', 'gap-fill': 'Fill in the Gaps'}; return types[type] || type; }
        function loadAnswerArea(question) { const answerArea = document.getElementById('answer-area'); switch(question.type) { case 'text-flexible': answerArea.innerHTML = `<input type="text" class="answer-input" id="text-answer" placeholder="Type your answer here..." autocomplete="off">`; setTimeout(() => document.getElementById('text-answer').focus(), 100); break; case 'multiple-choice': case 'scenario': answerArea.innerHTML = `<div class="multiple-choice" id="multiple-choice">${question.choices.map((choice, index) => `<div class="choice-option" onclick="selectChoice(${index})" data-choice="${index}"><div class="choice-letter">${String.fromCharCode(65 + index)}</div><div>${choice}</div></div>`).join('')}</div>`; break; case 'drag-drop': const categories = Object.keys(question.categories); answerArea.innerHTML = `<div class="drag-drop-container"><div class="drag-instruction">Drag the items to the correct categories</div><div class="drag-items" id="drag-items">${question.items.map(item => `<div class="drag-item" draggable="true" data-item="${item}">${item}</div>`).join('')}</div><div class="drop-zones" id="drop-zones">${categories.map(category => `<div class="drop-zone" data-category="${category}"><div class="drop-zone-title">${category}</div><div class="dropped-items" id="dropped-${category.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}"></div></div>`).join('')}</div></div>`; setupDragAndDrop(); break; case 'gap-fill': let gapIndex = 0; const gapText = question.gapText.replace(/_+/g, () => `<input type="text" class="gap-input" data-gap="${gapIndex++}" autocomplete="off">`); answerArea.innerHTML = `<div class="gap-fill-container">${gapText}</div>`; break; } }
        function selectChoice(index) { document.querySelectorAll('.choice-option').forEach(option => option.classList.remove('selected')); document.querySelector(`[data-choice="${index}"]`).classList.add('selected'); }
        function setupDragAndDrop() { const dragItems = document.querySelectorAll('.drag-item'); const dropZones = document.querySelectorAll('.drop-zone'); dragItems.forEach(item => { item.addEventListener('dragstart', handleDragStart); item.addEventListener('dragend', handleDragEnd); }); dropZones.forEach(zone => { zone.addEventListener('dragover', handleDragOver); zone.addEventListener('dragenter', handleDragEnter); zone.addEventListener('dragleave', handleDragLeave); zone.addEventListener('drop', handleDrop); }); }
        function handleDragStart(e) { draggedItem = e.target; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', e.target.outerHTML); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleDragEnter(e) { e.target.closest('.drop-zone').classList.add('drag-over'); }
        function handleDragLeave(e) { if (!e.target.closest('.drop-zone').contains(e.relatedTarget)) e.target.closest('.drop-zone').classList.remove('drag-over'); }
        function handleDrop(e) { e.preventDefault(); const dropZone = e.target.closest('.drop-zone'); dropZone.classList.remove('drag-over'); if (draggedItem) { const category = dropZone.dataset.category; const droppedItems = dropZone.querySelector('.dropped-items'); const droppedItem = document.createElement('div'); droppedItem.className = 'dropped-item'; droppedItem.textContent = draggedItem.dataset.item; droppedItem.dataset.item = draggedItem.dataset.item; droppedItem.dataset.category = category; droppedItems.appendChild(droppedItem); draggedItem.remove(); draggedItem = null; } }
        function checkAnswer() { const question = currentQuestions[currentQuestionIndex]; let userAnswer = null, result = 'incorrect'; if (typeof taskTracker !== 'undefined') taskTracker.recordActivity(); switch(question.type) { case 'text-flexible': userAnswer = document.getElementById('text-answer').value; result = checkFlexibleAnswer(userAnswer, question.correctAnswers, question.acceptableVariations); break; case 'multiple-choice': case 'scenario': const selected = document.querySelector('.choice-option.selected'); if (selected) { userAnswer = parseInt(selected.dataset.choice); result = userAnswer === question.correct ? 'correct' : 'incorrect'; } break; case 'drag-drop': userAnswer = {}; document.querySelectorAll('.dropped-item').forEach(item => { const category = item.dataset.category; const itemText = item.dataset.item; if (!userAnswer[category]) userAnswer[category] = []; userAnswer[category].push(itemText); }); result = checkDragDropAnswer(userAnswer, question.categories); break; case 'gap-fill': userAnswer = []; document.querySelectorAll('.gap-input').forEach(input => userAnswer.push(input.value)); result = checkGapFillAnswer(userAnswer, question.correctGaps, question.acceptableGaps); break; } userAnswers[currentQuestionIndex] = { question, userAnswer, result }; showFeedback(result, question.explanation); document.getElementById('check-btn').style.display = 'none'; document.getElementById('next-btn').style.display = 'inline-block'; }
        function checkDragDropAnswer(userAnswer, correctCategories) { let correct = 0, total = 0; for (const [category, correctItems] of Object.entries(correctCategories)) { const userItems = userAnswer[category] || []; for (const item of correctItems) { total++; if (userItems.includes(item)) correct++; } } const percentage = correct / total; if (percentage >= 0.8) return 'correct'; if (percentage >= 0.5) return 'partial'; return 'incorrect'; }
        function checkGapFillAnswer(userAnswers, correctGaps, acceptableGaps) { let correct = 0; for (let i = 0; i < userAnswers.length; i++) { const userAnswer = normaliseText(userAnswers[i]); const correctAnswer = normaliseText(correctGaps[i]); const acceptableAnswers = acceptableGaps[i].map(a => normaliseText(a)); if (userAnswer === correctAnswer || acceptableAnswers.includes(userAnswer)) correct++; } const percentage = correct / userAnswers.length; if (percentage >= 0.8) return 'correct'; if (percentage >= 0.5) return 'partial'; return 'incorrect'; }
        function showFeedback(result, explanation) { const feedback = document.getElementById('feedback'); const feedbackIcon = document.getElementById('feedback-icon'); const feedbackTitle = document.getElementById('feedback-title'); const feedbackExplanation = document.getElementById('feedback-explanation'); feedback.className = `feedback ${result}`; switch(result) { case 'correct': feedbackIcon.textContent = '‚úì'; feedbackTitle.textContent = 'Correct!'; break; case 'partial': feedbackIcon.textContent = '‚óê'; feedbackTitle.textContent = 'Partially Correct'; break; case 'incorrect': feedbackIcon.textContent = '‚úó'; feedbackTitle.textContent = 'Incorrect'; break; } feedbackExplanation.textContent = explanation; feedback.style.display = 'block'; }
        function nextQuestion() { if (currentQuestionIndex < currentQuestions.length - 1) { currentQuestionIndex++; loadQuestion(); } else { showResults(); } }
        function previousQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; loadQuestion(); if (userAnswers[currentQuestionIndex]) { const answer = userAnswers[currentQuestionIndex]; showFeedback(answer.result, answer.question.explanation); document.getElementById('check-btn').style.display = 'none'; document.getElementById('next-btn').style.display = 'inline-block'; } } }
        async function showResults() { const quizEndTime = Date.now(); const completionTime = Math.round((quizEndTime - quizStartTime) / (1000 * 60)); document.getElementById('question-screen').style.display = 'none'; document.getElementById('results-screen').style.display = 'block'; let correct = 0, incorrect = 0, partial = 0; userAnswers.forEach(answer => { if (answer.result === 'correct') correct++; else if (answer.result === 'partial') partial++; else incorrect++; }); const totalScore = Math.round((correct + partial * 0.5) / userAnswers.length * 100); if (typeof taskTracker !== 'undefined' && taskTracker.isTracking) { const totalQuestions = userAnswers.length; const correctAnswers = correct + Math.round(partial * 0.5); await taskTracker.complete(totalScore, totalQuestions, correctAnswers); } document.getElementById('final-score').textContent = `${totalScore}%`; document.getElementById('correct-count').textContent = correct; document.getElementById('incorrect-count').textContent = incorrect; document.getElementById('partial-count').textContent = partial; document.getElementById('completion-time').textContent = completionTime; const resultsMessage = document.getElementById('results-message'); if (totalScore >= 85) resultsMessage.textContent = "Excellent work! You're well-prepared for assessments."; else if (totalScore >= 70) resultsMessage.textContent = 'Good progress! Review the areas where you lost marks.'; else if (totalScore >= 60) resultsMessage.textContent = 'Getting there! Focus on reviewing the lesson content.'; else resultsMessage.textContent = 'Keep practising! Revisit the lesson materials before your next attempt.'; }
        function restartQuiz() { currentMode = ''; selectedSubtopics = []; currentQuestions = []; currentQuestionIndex = 0; userAnswers = []; quizStartTime = null; document.querySelectorAll('.subtopic-option').forEach(option => option.classList.remove('selected')); document.getElementById('results-screen').style.display = 'none'; document.getElementById('mode-selection-screen').style.display = 'block'; }
        document.addEventListener('keydown', function(event) { if (document.getElementById('question-screen').style.display === 'block') { if (event.key === 'Enter') { const checkBtn = document.getElementById('check-btn'); const nextBtn = document.getElementById('next-btn'); if (checkBtn.style.display !== 'none') checkAnswer(); else if (nextBtn.style.display !== 'none') nextQuestion(); event.preventDefault(); } if (event.key >= '1' && event.key <= '4') { const choiceIndex = parseInt(event.key) - 1; const choice = document.querySelector(`[data-choice="${choiceIndex}"]`); if (choice) selectChoice(choiceIndex); } } });
    </script>
</body>
</html>
