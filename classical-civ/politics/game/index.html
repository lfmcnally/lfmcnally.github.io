<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursus Honorum — Rise to Power</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --parchment: #f4e4bc; --parchment-dark: #e8d4a8; --parchment-light: #faf6eb;
            --ink: #2c1810; --ink-light: #4a3728; --wax-red: #8b2323; --wax-gold: #c9a227;
            --bronze: #cd7f32; --success: #2d5016; --danger: #6b1c1c; --senate: #1a365d;
        }
        body { font-family: 'Crimson Text', Georgia, serif; background: linear-gradient(135deg, #3d2914, #2c1810, #1a0f0a); min-height: 100vh; color: var(--ink); }
        .game-container { max-width: 1000px; margin: 0 auto; padding: 15px; }
        .game-board {
            background: var(--parchment); border: 12px solid #5c4033;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), inset 0 0 60px rgba(139,69,19,0.1);
            padding: 20px; position: relative; min-height: 90vh;
        }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--ink-light); padding-bottom: 12px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-family: 'Cinzel', serif; font-size: 1.6rem; font-weight: 700; letter-spacing: 0.1em; }
        .header-info { text-align: right; }
        .year-display { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--wax-red); }
        .age-display { font-size: 0.9rem; color: var(--ink-light); }
        .career-track { display: flex; justify-content: space-between; align-items: center; background: var(--parchment-dark); padding: 10px 15px; margin-bottom: 15px; border: 1px solid var(--ink-light); overflow-x: auto; gap: 5px; }
        .career-office { text-align: center; padding: 5px 8px; opacity: 0.4; transition: all 0.3s; min-width: 70px; }
        .career-office.achieved { opacity: 1; color: var(--success); }
        .career-office.current { opacity: 1; background: var(--wax-red); color: white; border-radius: 5px; }
        .career-office.available { opacity: 0.8; border: 2px dashed var(--wax-gold); border-radius: 5px; }
        .career-office .office-name { font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 600; }
        .career-office .office-age { font-size: 0.6rem; }
        .stats-row { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .stat-box { flex: 1; min-width: 80px; text-align: center; padding: 8px 5px; background: var(--parchment-light); border: 2px solid var(--bronze); border-radius: 5px; }
        .stat-box.danger { border-color: var(--danger); background: #f5e0e0; }
        .stat-box.good { border-color: var(--success); background: #e0f0e0; }
        .stat-name { font-family: 'Cinzel', serif; font-size: 0.6rem; text-transform: uppercase; color: var(--ink-light); }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.3rem; font-weight: 700; }
        .relationships { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 15px; padding: 10px; background: var(--parchment-dark); border: 1px solid var(--ink-light); }
        .relationship { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
        .rel-name { font-weight: 600; min-width: 60px; font-size: 0.75rem; }
        .rel-bar { flex: 1; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; }
        .rel-fill { height: 100%; transition: width 0.3s; }
        .rel-fill.hostile { background: linear-gradient(to right, var(--danger), #a33); }
        .rel-fill.cold { background: linear-gradient(to right, #b44, #c66); }
        .rel-fill.neutral { background: linear-gradient(to right, #888, #aaa); }
        .rel-fill.warm { background: linear-gradient(to right, #6a6, #8c8); }
        .rel-fill.allied { background: linear-gradient(to right, var(--success), #4a7); }
        .content-area { background: var(--parchment-light); border: 2px solid var(--ink-light); padding: 20px; margin-bottom: 15px; min-height: 300px; }
        .section-title { font-family: 'Cinzel', serif; font-size: 1.15rem; color: var(--wax-red); margin-bottom: 15px; text-align: center; border-bottom: 1px solid var(--ink-light); padding-bottom: 10px; }
        .event-card { background: white; border: 2px solid var(--ink-light); padding: 15px; margin-bottom: 15px; }
        .event-type { font-family: 'Cinzel', serif; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--bronze); margin-bottom: 5px; }
        .event-title { font-family: 'Cinzel', serif; font-size: 1.05rem; font-weight: 600; margin-bottom: 10px; }
        .event-desc { line-height: 1.6; margin-bottom: 15px; font-size: 0.95rem; }
        .event-desc .highlight { color: var(--wax-red); font-weight: 600; }
        .choices { display: flex; flex-direction: column; gap: 8px; }
        .choice-btn {
            background: linear-gradient(to bottom, var(--parchment), var(--parchment-dark));
            border: 2px solid var(--ink-light); padding: 12px 15px; font-family: 'Crimson Text', serif;
            font-size: 0.95rem; color: var(--ink); cursor: pointer; text-align: left; transition: all 0.2s;
        }
        .choice-btn:hover:not(:disabled) { background: linear-gradient(to bottom, #fff, var(--parchment)); border-color: var(--bronze); transform: translateX(5px); }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .choice-btn .choice-cost { display: inline-block; background: var(--wax-red); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-left: 8px; }
        .choice-btn .choice-effect { display: block; font-size: 0.8rem; color: var(--ink-light); margin-top: 5px; font-style: italic; }
        .election-container { background: #fffef5; border: 3px double var(--wax-gold); padding: 20px; }
        .candidates { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 15px 0; }
        .candidate { background: var(--parchment); border: 2px solid var(--ink-light); padding: 12px; text-align: center; }
        .candidate.player { border-color: var(--wax-gold); background: #fffef8; }
        .candidate.winner { border-color: var(--success); background: #e8f5e0; }
        .candidate-name { font-family: 'Cinzel', serif; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; }
        .candidate-support { font-size: 0.8rem; color: var(--ink-light); }
        .vote-bar { height: 15px; background: #ddd; border-radius: 8px; margin-top: 8px; overflow: hidden; }
        .vote-fill { height: 100%; background: linear-gradient(to right, var(--wax-red), var(--bronze)); transition: width 1s; border-radius: 8px; }
        .campaign-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-top: 15px; }
        .campaign-btn { background: linear-gradient(to bottom, var(--parchment-dark), #cdb98a); border: 2px solid var(--bronze); padding: 10px; font-family: 'Cinzel', serif; font-size: 0.75rem; cursor: pointer; text-align: center; }
        .campaign-btn:hover:not(:disabled) { background: linear-gradient(to bottom, #e8d8b8, var(--parchment-dark)); }
        .campaign-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .campaign-btn .cost { display: block; font-size: 0.65rem; color: var(--danger); margin-top: 3px; }
        .btn-primary {
            display: block; width: 100%; background: linear-gradient(to bottom, var(--wax-red), #6b1818);
            color: white; border: none; padding: 12px; font-family: 'Cinzel', serif;
            font-size: 1rem; letter-spacing: 0.1em; cursor: pointer; transition: all 0.2s; margin-top: 10px;
        }
        .btn-primary:hover { background: linear-gradient(to bottom, #a02c2c, var(--wax-red)); }
        .btn-secondary { background: linear-gradient(to bottom, var(--ink-light), var(--ink)); }
        .btn-success { background: linear-gradient(to bottom, var(--success), #1a3a0a); }
        .intro-screen { padding: 15px; }
        .intro-screen h2 { font-family: 'Cinzel', serif; font-size: 1.4rem; text-align: center; margin-bottom: 15px; color: var(--wax-red); }
        .intro-screen p { line-height: 1.7; margin-bottom: 12px; }
        .family-choices { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 15px 0; }
        .family-choice { background: var(--parchment-dark); border: 2px solid var(--ink-light); padding: 12px; cursor: pointer; transition: all 0.2s; }
        .family-choice:hover { border-color: var(--wax-red); background: var(--parchment-light); }
        .family-choice.selected { border-color: var(--wax-red); background: var(--parchment-light); box-shadow: 0 0 10px rgba(139,35,35,0.3); }
        .family-choice h4 { font-family: 'Cinzel', serif; font-size: 0.9rem; margin-bottom: 8px; color: var(--wax-red); }
        .family-choice p { font-size: 0.85rem; margin-bottom: 5px; }
        .family-choice .bonuses { font-size: 0.75rem; color: var(--ink-light); }
        .end-screen { text-align: center; padding: 20px; }
        .end-screen h2 { font-family: 'Cinzel', serif; font-size: 1.6rem; margin-bottom: 15px; }
        .end-screen.victory h2 { color: var(--success); }
        .end-screen.defeat h2 { color: var(--danger); }
        .end-screen p { line-height: 1.7; margin-bottom: 12px; }
        .final-record { background: var(--parchment-dark); padding: 15px; margin: 15px 0; text-align: left; }
        .final-record h4 { font-family: 'Cinzel', serif; margin-bottom: 10px; }
        .year-summary { background: #fffef8; border-left: 4px solid var(--bronze); padding: 12px; margin-bottom: 15px; }
        .year-summary h4 { font-family: 'Cinzel', serif; color: var(--bronze); margin-bottom: 8px; font-size: 0.95rem; }
        .summary-item { display: flex; justify-content: space-between; padding: 3px 0; font-size: 0.85rem; }
        .historical-note { background: var(--senate); color: white; padding: 12px 15px; margin-top: 15px; font-size: 0.85rem; border-radius: 5px; }
        .historical-note strong { color: var(--wax-gold); }
        .hidden { display: none !important; }
        /* Stat change animations */
        @keyframes statUp {
            0% { background-color: var(--success); transform: scale(1.1); }
            100% { background-color: transparent; transform: scale(1); }
        }
        @keyframes statDown {
            0% { background-color: var(--danger); transform: scale(1.1); }
            100% { background-color: transparent; transform: scale(1); }
        }
        .stat-flash-up { animation: statUp 0.6s ease-out; }
        .stat-flash-down { animation: statDown 0.6s ease-out; }
        .stat-value.changing { transition: all 0.3s; }
        /* Educational note styling */
        .edu-note { background: linear-gradient(135deg, var(--senate), #2a4a7d); color: white; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid var(--wax-gold); }
        .edu-note h5 { font-family: 'Cinzel', serif; color: var(--wax-gold); margin-bottom: 8px; font-size: 0.9rem; }
        .edu-note p { font-size: 0.85rem; line-height: 1.5; margin: 0; }
        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .career-track { flex-wrap: wrap; justify-content: center; }
            .stats-row { flex-wrap: wrap; }
            .stat-box { min-width: 70px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-board">
            <div class="header">
                <div>
                    <h1>CURSUS HONORUM</h1>
                    <div id="playerName" style="font-style:italic;color:var(--ink-light);font-size:0.9rem;"></div>
                </div>
                <div class="header-info">
                    <div class="year-display" id="yearDisplay">134 BC</div>
                    <div class="age-display" id="ageDisplay">Age 17</div>
                </div>
            </div>
            <div class="career-track hidden" id="careerTrack">
                <div class="career-office" data-office="military"><div class="office-name">Military</div><div class="office-age">17-27</div></div>
                <div class="career-office" data-office="quaestor"><div class="office-name">Quaestor</div><div class="office-age">30+</div></div>
                <div class="career-office" data-office="aedile"><div class="office-name">Aedile</div><div class="office-age">36+</div></div>
                <div class="career-office" data-office="praetor"><div class="office-name">Praetor</div><div class="office-age">39+</div></div>
                <div class="career-office" data-office="consul"><div class="office-name">Consul</div><div class="office-age">42+</div></div>
                <div class="career-office" data-office="censor"><div class="office-name">Censor</div><div class="office-age">Ex-Consul</div></div>
            </div>
            <div class="stats-row hidden" id="statsRow">
                <div class="stat-box" id="dignitasBox"><div class="stat-name">Dignitas</div><div class="stat-value" id="dignitas">50</div></div>
                <div class="stat-box" id="auctoritasBox"><div class="stat-name">Influence</div><div class="stat-value" id="auctoritas">20</div></div>
                <div class="stat-box" id="pecuniaBox"><div class="stat-name">Wealth</div><div class="stat-value" id="pecunia">50</div></div>
                <div class="stat-box" id="militaryBox"><div class="stat-name">Military</div><div class="stat-value" id="military">0</div></div>
                <div class="stat-box" id="popularisBox"><div class="stat-name">Popularity</div><div class="stat-value" id="popularis">50</div></div>
            </div>
            <div class="relationships hidden" id="relationships"></div>
            <div class="content-area" id="contentArea"></div>
        </div>
    </div>
    <script>
    const OFFICES = {
        none: { name: 'Private Citizen', minAge: 0, order: 0 },
        military: { name: 'Military Tribune', minAge: 17, order: 1 },
        quaestor: { name: 'Quaestor', minAge: 30, order: 2, slots: 20, requires: { dignitas: 30, auctoritas: 25 } },
        aedile: { name: 'Aedile', minAge: 36, order: 3, slots: 4, requires: { dignitas: 40, auctoritas: 35, pecunia: 30 } },
        praetor: { name: 'Praetor', minAge: 39, order: 4, slots: 8, requires: { dignitas: 50, auctoritas: 45, military: 35 } },
        consul: { name: 'Consul', minAge: 42, order: 5, slots: 2, requires: { dignitas: 60, auctoritas: 55, military: 45 } },
        censor: { name: 'Censor', minAge: 44, order: 6, requiresConsul: true, slots: 2, requires: { dignitas: 70, auctoritas: 60 } }
    };

    const MAX_ACTIONS_PER_YEAR = 3;

    // Your rival - competes with you through the cursus honorum
    const RIVAL_NAMES = [
        { name: 'Lucius Sergius Catilina', short: 'Catilina', desc: 'Ruthless and ambitious' },
        { name: 'Gaius Verres', short: 'Verres', desc: 'Corrupt but well-connected' },
        { name: 'Publius Clodius Pulcher', short: 'Clodius', desc: 'Popular demagogue' },
        { name: 'Marcus Caelius Rufus', short: 'Caelius', desc: 'Charming troublemaker' }
    ];

    const NPCS = {
        crassus: { name: 'Crassus', fullName: 'Marcus Licinius Crassus', desc: 'The richest man in Rome', trait: 'greedy' },
        pompey: { name: 'Pompey', fullName: 'Gnaeus Pompeius Magnus', desc: 'Great general', trait: 'proud' },
        caesar: { name: 'Caesar', fullName: 'Gaius Julius Caesar', desc: 'Ambitious patrician', trait: 'ambitious' },
        cicero: { name: 'Cicero', fullName: 'Marcus Tullius Cicero', desc: 'Master orator', trait: 'principled' },
        cato: { name: 'Cato', fullName: 'Marcus Porcius Cato', desc: 'Stubborn traditionalist', trait: 'stubborn' }
    };

    const FAMILIES = [
        { id: 'patrician', name: 'Patrician Noble', desc: 'Ancient bloodline, modest means. The Senate respects your name.', bonuses: { dignitas: 20, auctoritas: 15, pecunia: -20 } },
        { id: 'plebeian_noble', name: 'Plebeian Noble', desc: 'Your family has produced consuls. Well-connected and wealthy.', bonuses: { dignitas: 10, pecunia: 30, auctoritas: 10 } },
        { id: 'equestrian', name: 'Equestrian', desc: 'Wealthy businessmen. Money opens doors, but nobles sneer.', bonuses: { pecunia: 50, dignitas: -10, popularis: 10 } },
        { id: 'novus', name: 'Novus Homo', desc: 'First in your family to seek office. Everything to prove.', bonuses: { dignitas: -20, popularis: 25, pecunia: 10 } }
    ];

    // Military service events - these happen during the 10 years of service
    const MILITARY_EVENTS = [
        { title: 'Night Watch', desc: 'You\'re assigned night watch during a bitter winter campaign. Your tent-mate suggests you both sleep instead—the centurion never checks.',
          choices: [
            { text: 'Keep proper watch alone', effects: { military: 8, dignitas: 5 }, successText: 'Your diligence is noted when you spot enemy scouts.' },
            { text: 'Agree to sleep in shifts', effects: { military: 3 }, risk: { chance: 0.3, penalty: { dignitas: -15, military: -10 }, desc: 'You\'re caught sleeping! Flogged before the legion.' } },
            { text: 'Report your tent-mate', effects: { military: 5, dignitas: -5 }, successText: 'He\'s punished. Others now distrust you.' }
          ]},
        { title: 'The Wounded Tribune', desc: 'A military tribune lies injured after a skirmish. Carrying him will slow you down as the enemy regroups.',
          choices: [
            { text: 'Carry him to safety', effects: { military: 5, dignitas: 15 }, risk: { chance: 0.25, penalty: { military: -8 }, desc: 'You\'re wounded in the retreat.' }, successText: 'The tribune\'s family becomes your patron.' },
            { text: 'Leave him with water and go for help', effects: { military: 3 }, risk: { chance: 0.4, penalty: { dignitas: -20 }, desc: 'He dies before help arrives. His family blames you.' } },
            { text: 'He\'s slowing us down—leave him', effects: { military: 8, dignitas: -15 }, successText: 'You escape quickly, but the story follows you.' }
          ]},
        { title: 'Loot Distribution', desc: 'After sacking a town, your century finds a hidden cache of silver. The commander hasn\'t seen it.',
          choices: [
            { text: 'Report it to the commander', effects: { dignitas: 12, military: 5 }, successText: 'You receive an official commendation and a small share.' },
            { text: 'Split it among the men', effects: { popularis: 10, pecunia: 15 }, risk: { chance: 0.2, penalty: { dignitas: -25, military: -15 }, desc: 'Someone talks. You\'re demoted.' } },
            { text: 'Take the lion\'s share for yourself', effects: { pecunia: 30 }, risk: { chance: 0.35, penalty: { dignitas: -20, popularis: -15 }, desc: 'The men resent you. One tries to kill you in battle.' } }
          ]},
        { title: 'A Rival\'s Challenge', desc: 'Another young officer, seeking glory, challenges you to single combat practice. The men are watching.',
          choices: [
            { text: 'Accept and fight hard', effects: { military: 8 }, risk: { chance: 0.4, penalty: { dignitas: -10 }, desc: 'He defeats you soundly.' }, successText: 'You win! Your reputation grows.' },
            { text: 'Accept but let him win gracefully', effects: { auctoritas: 8 }, successText: 'He becomes an ally, grateful for your discretion.' },
            { text: 'Decline—you have duties', effects: { dignitas: -5 }, successText: 'Some call you coward, but senior officers approve.' }
          ]},
        { title: 'Native Guides', desc: 'Local tribesmen offer to guide your patrol through the mountains for a price. Your centurion is skeptical.',
          choices: [
            { text: 'Pay them from your own purse', effects: { pecunia: -10, military: 12 }, successText: 'The shortcut gives your unit a tactical advantage.' },
            { text: 'Trust your centurion—refuse', effects: { military: 5 }, successText: 'A longer march, but safe.' },
            { text: 'Take them but don\'t pay', effects: { }, risk: { chance: 0.5, penalty: { military: -15 }, desc: 'They lead you into an ambush!' }, successText: 'They guide you true, then flee.' }
          ]},
        { title: 'The General\'s Favor', desc: 'The commanding general notices your work and invites you to dine with his officers.',
          choices: [
            { text: 'Praise his strategies effusively', effects: { auctoritas: 8 }, risk: { chance: 0.3, penalty: { dignitas: -8 }, desc: 'Your flattery is too obvious. He\'s offended.' } },
            { text: 'Offer a tactical suggestion', effects: { military: 5 }, risk: { chance: 0.4, penalty: { auctoritas: -10 }, desc: 'He doesn\'t appreciate being corrected.' }, successText: 'He\'s impressed by your insight.' },
            { text: 'Listen respectfully, speak little', effects: { dignitas: 8, auctoritas: 5 }, successText: 'Your discretion marks you as officer material.' }
          ]},
        { title: 'Mutinous Talk', desc: 'You overhear soldiers planning to desert. They haven\'t noticed you.',
          choices: [
            { text: 'Report them immediately', effects: { military: 10, dignitas: 8 }, successText: 'They\'re executed. The legion respects your loyalty.' },
            { text: 'Confront them privately', effects: { popularis: 10 }, risk: { chance: 0.3, penalty: { military: -10 }, desc: 'They attack you!' }, successText: 'You talk them out of it. They owe you their lives.' },
            { text: 'Pretend you heard nothing', effects: { }, risk: { chance: 0.4, penalty: { dignitas: -15, military: -10 }, desc: 'When they desert, suspicion falls on you.' } }
          ]},
        { title: 'Supply Shortage', desc: 'Your unit is short on food. A nearby farm has grain, but they\'re Roman citizens.',
          choices: [
            { text: 'Requisition the grain officially', effects: { military: 5 }, successText: 'The farmers are compensated... eventually.' },
            { text: 'Pay a fair price from unit funds', effects: { pecunia: -8, dignitas: 10, popularis: 8 }, successText: 'Word spreads of your fairness.' },
            { text: 'Just take it—they\'re peasants', effects: { military: 8 }, risk: { chance: 0.3, penalty: { dignitas: -20, popularis: -15 }, desc: 'They complain to a senator. There are consequences.' } }
          ]},
        { title: 'Siege Volunteer', desc: 'The commander calls for volunteers to lead a dangerous assault on the walls.',
          choices: [
            { text: 'Volunteer immediately', effects: { military: 15, dignitas: 12 }, risk: { chance: 0.35, penalty: { military: -10 }, desc: 'Wounded in the assault!' }, successText: 'You plant the standard on the walls. Glory!' },
            { text: 'Wait to see if others volunteer', effects: { military: 5 }, successText: 'Others go. You follow in the second wave.' },
            { text: 'Hang back—let the fools die', effects: { dignitas: -10 }, successText: 'You survive. Some notice your absence.' }
          ]},
        { title: 'A Mentor Appears', desc: 'A grizzled centurion takes interest in you. "You\'ve got potential, boy. I can teach you."',
          choices: [
            { text: 'Accept his training eagerly', effects: { military: 12, dignitas: 5 }, successText: 'His brutal training makes you a real soldier.' },
            { text: 'Politely decline—you know enough', effects: { dignitas: -5 }, successText: 'He shrugs. "Your funeral, boy."' },
            { text: 'Ask what he wants in return', effects: { auctoritas: 5 }, successText: '"Just pass it on someday." He teaches you well.' }
          ]}
    ];

    // Political events - these happen when you're in civilian life or office
    const POLITICAL_EVENTS = [
        { title: 'The Forum Orator', desc: 'A skilled speaker attacks your family\'s reputation in the Forum. A crowd gathers.',
          choices: [
            { text: 'Challenge him to a public debate', effects: { }, risk: { chance: 0.5, penalty: { dignitas: -20, popularis: -10 }, desc: 'He destroys you rhetorically.' }, successText: 'You hold your own! Your reputation rises.', successEffects: { dignitas: 15, popularis: 10 } },
            { text: 'Hire men to "discourage" him', effects: { pecunia: -15 }, risk: { chance: 0.3, penalty: { dignitas: -25 }, desc: 'The thugs are traced back to you!' }, successText: 'He stops speaking. No one knows why.' },
            { text: 'Ignore him—dignified silence', effects: { dignitas: 5 }, successText: 'Some admire your restraint. Others think you weak.' }
          ], minOffice: 'none' },
        { title: 'A Senator\'s Dinner', desc: 'You\'re invited to dine at a senator\'s home. Other ambitious men will be there.',
          npc: 'random',
          choices: [
            { text: 'Bring an expensive gift', effects: { pecunia: -20 }, successText: 'The host is pleased. You make a good impression.', successEffects: { auctoritas: 12 }, npcEffect: 15 },
            { text: 'Bring modest wine and charm', effects: { }, risk: { chance: 0.3, penalty: { dignitas: -5 }, desc: 'Your charm falls flat.' }, successText: 'Your wit makes you memorable.', successEffects: { auctoritas: 8, popularis: 5 }, npcEffect: 10 },
            { text: 'Focus on making one key ally', effects: { }, successText: 'You leave with a new connection.', successEffects: { auctoritas: 10 }, npcEffect: 20 }
          ], minOffice: 'none' },
        { title: 'The Bribe', desc: 'A wealthy merchant offers you money to speak against a proposed tax in the Senate.',
          choices: [
            { text: 'Accept the bribe', effects: { pecunia: 30, dignitas: -10 }, risk: { chance: 0.25, penalty: { dignitas: -30, auctoritas: -20 }, desc: 'The bribe becomes public knowledge!' } },
            { text: 'Refuse indignantly', effects: { dignitas: 15 }, successText: 'Your incorruptibility is noted.' },
            { text: 'Take the money, vote your conscience', effects: { pecunia: 30 }, risk: { chance: 0.4, penalty: { pecunia: -40, auctoritas: -15 }, desc: 'He demands his money back!' } }
          ], minOffice: 'quaestor' },
        { title: 'Grain Crisis', desc: 'The grain supply is short. The people look to their leaders. Hungry crowds gather.',
          choices: [
            { text: 'Fund grain distribution yourself', effects: { pecunia: -35, popularis: 25, dignitas: 15 }, requires: { pecunia: 35 } },
            { text: 'Blame the current magistrates', effects: { popularis: 10, auctoritas: -10 } },
            { text: 'Argue for patience—ships are coming', effects: { }, risk: { chance: 0.4, penalty: { popularis: -20 }, desc: 'The ships don\'t come. Riots break out!' } }
          ], minOffice: 'none' },
        { title: 'Gladiatorial Games', desc: 'The people expect games. How lavish will yours be?',
          choices: [
            { text: 'Spectacular games (-50 wealth)', effects: { pecunia: -50, popularis: 30, dignitas: 20 }, requires: { pecunia: 50 } },
            { text: 'Modest but dignified games (-20)', effects: { pecunia: -20, popularis: 12, dignitas: 5 }, requires: { pecunia: 20 } },
            { text: 'Skip the games—too expensive', effects: { dignitas: -15, popularis: -15 } }
          ], minOffice: 'aedile' },
        { title: 'Prosecution Opportunity', desc: 'You have evidence of corruption against a magistrate. Prosecuting him could make your name—or enemies.',
          npc: 'random',
          choices: [
            { text: 'Prosecute him publicly', effects: { dignitas: 20, popularis: 15 }, risk: { chance: 0.35, penalty: { auctoritas: -20 }, desc: 'He has powerful friends who now hate you!' }, npcEffect: -25 },
            { text: 'Sell the evidence to his enemies', effects: { pecunia: 25, dignitas: -10 } },
            { text: 'Approach him privately', effects: { }, successText: 'He owes you now.', successEffects: { auctoritas: 15, pecunia: 15 } }
          ], minOffice: 'none' },
        { title: 'Alliance Offer', desc: 'A powerful family proposes a marriage alliance—your child to theirs.',
          npc: 'random',
          choices: [
            { text: 'Accept enthusiastically', effects: { auctoritas: 20, dignitas: 10 }, npcEffect: 25, successText: 'The alliance strengthens your position.' },
            { text: 'Negotiate for better terms', effects: { }, risk: { chance: 0.3, penalty: { auctoritas: -10 }, desc: 'They\'re offended and withdraw!' }, successText: 'They agree to a larger dowry.', successEffects: { auctoritas: 15, pecunia: 20 }, npcEffect: 15 },
            { text: 'Politely decline', effects: { dignitas: 5 }, npcEffect: -10 }
          ], minOffice: 'none' },
        { title: 'The Tribune\'s Veto', desc: 'A tribune threatens to veto legislation you support. He might be persuaded.',
          choices: [
            { text: 'Bribe him (-25 wealth)', effects: { pecunia: -25 }, successText: 'He withdraws the veto.', successEffects: { auctoritas: 10 }, risk: { chance: 0.2, penalty: { dignitas: -20 }, desc: 'The bribe is discovered!' } },
            { text: 'Threaten his future career', effects: { }, risk: { chance: 0.4, penalty: { popularis: -15 }, desc: 'He vetoes it anyway and denounces you!' }, successText: 'He backs down.', successEffects: { auctoritas: 15 } },
            { text: 'Accept the veto gracefully', effects: { dignitas: 8 }, successText: 'You\'re seen as reasonable.' }
          ], minOffice: 'quaestor' },
        { title: 'Provincial Command', desc: 'You\'re offered a provincial posting. It means leaving Rome, but there\'s money to be made.',
          choices: [
            { text: 'Accept—govern justly', effects: { military: 10, dignitas: 15, pecunia: 20 }, successText: 'You return with honor and modest wealth.' },
            { text: 'Accept—extract maximum profit', effects: { pecunia: 50 }, risk: { chance: 0.4, penalty: { dignitas: -30 }, desc: 'Provincials complain to the Senate!' }, successText: 'You return very wealthy.' },
            { text: 'Decline—stay in Rome', effects: { auctoritas: 5 }, successText: 'You remain close to power.' }
          ], minOffice: 'praetor' },
        { title: 'Triumph Request', desc: 'After military success, you petition the Senate for a triumph.',
          choices: [
            { text: 'Make your case forcefully', effects: { }, risk: { chance: 0.5, penalty: { dignitas: -15 }, desc: 'The Senate denies your request!' }, successText: 'Triumph granted!', successEffects: { dignitas: 30, popularis: 25 }, requires: { military: 50 } },
            { text: 'Accept an ovation instead', effects: { dignitas: 15, popularis: 10 }, successText: 'A lesser honor, but guaranteed.' },
            { text: 'Withdraw the request', effects: { dignitas: -10 }, successText: 'Some call you modest. Others, weak.' }
          ], minOffice: 'consul', requires: { military: 40 } }
    ];

    // NPC encounter events - these introduce relationships naturally
    const NPC_EVENTS = {
        crassus: [
            { title: 'The Money-Lender', desc: 'Marcus Crassus approaches you. "I hear you need funds for your campaign. I can help... for a reasonable return."',
              choices: [
                { text: 'Accept his loan (-interest)', effects: { pecunia: 40 }, npcEffect: 20, successText: 'You owe him now, but you have funds.' },
                { text: 'Decline politely', effects: { dignitas: 5 }, npcEffect: -5, successText: '"Your loss," he shrugs.' },
                { text: 'Counter-offer a business partnership', effects: { }, npcEffect: 10, risk: { chance: 0.3, penalty: { }, desc: 'He\'s not interested.' }, successText: 'He\'s intrigued. A profitable arrangement.', successEffects: { pecunia: 25, auctoritas: 10 } }
              ]},
            { title: 'Fire Sale', desc: 'Crassus\'s fire brigades have been busy. He offers you a share in a "recovered" property—cheap.',
              choices: [
                { text: 'Invest with him', effects: { pecunia: -15 }, npcEffect: 15, successText: 'Profitable, if morally dubious.', successEffects: { pecunia: 30 } },
                { text: 'Refuse—it\'s distasteful', effects: { dignitas: 10 }, npcEffect: -15, successText: 'He remembers your squeamishness.' },
                { text: 'Report his practices to the Senate', effects: { dignitas: 15, popularis: 10 }, npcEffect: -40, successText: 'Nothing happens, but Crassus is furious.' }
              ]}
        ],
        pompey: [
            { title: 'The Great General', desc: 'Pompey Magnus holds court in the Forum. He notices you watching. "You served in the legions. What do you think of the eastern campaign?"',
              choices: [
                { text: 'Praise his genius effusively', effects: { }, npcEffect: 10, risk: { chance: 0.3, penalty: { dignitas: -8 }, desc: 'Your flattery is too obvious.' }, successText: 'He preens. He likes you.' },
                { text: 'Offer thoughtful military analysis', effects: { military: 5 }, npcEffect: 15, risk: { chance: 0.2, penalty: { npcChange: -10 }, desc: 'He doesn\'t like being analyzed.' }, successText: 'He respects your insight.' },
                { text: 'Deflect—you\'re no expert', effects: { dignitas: -5 }, npcEffect: 0, successText: 'He loses interest in you.' }
              ]},
            { title: 'Veterans\' Cause', desc: 'Pompey seeks support for land grants to his veterans. It\'s controversial but he\'s powerful.',
              choices: [
                { text: 'Support him publicly', effects: { popularis: -10 }, npcEffect: 25, successText: 'The veterans will remember.' },
                { text: 'Support privately, abstain publicly', effects: { }, npcEffect: 10, successText: 'A careful compromise.' },
                { text: 'Oppose—it sets bad precedent', effects: { dignitas: 10 }, npcEffect: -20, successText: 'Traditionalists approve. Pompey does not.' }
              ]}
        ],
        caesar: [
            { title: 'The Ambitious Patrician', desc: 'Young Gaius Julius Caesar buttonholes you. "Rome needs men of vision, not fossils clinging to tradition. Are you a man of vision?"',
              choices: [
                { text: '"I share your frustrations"', effects: { popularis: 8 }, npcEffect: 20, successText: 'He grins. "Then we should talk more."' },
                { text: '"Tradition has its place"', effects: { dignitas: 5 }, npcEffect: -10, successText: 'He shrugs and moves on.' },
                { text: '"Vision without prudence is dangerous"', effects: { }, npcEffect: 5, successText: 'He laughs. "Prudent. But are you bold?"' }
              ]},
            { title: 'Debt Proposal', desc: 'Caesar proposes debt relief for struggling citizens. It would be popular but anger the wealthy.',
              choices: [
                { text: 'Support the proposal', effects: { popularis: 20, auctoritas: -10 }, npcEffect: 20, successText: 'The people love you. The Senate less so.' },
                { text: 'Oppose it publicly', effects: { auctoritas: 10, popularis: -10 }, npcEffect: -20, successText: 'The optimates approve.' },
                { text: 'Suggest a compromise', effects: { dignitas: 8 }, npcEffect: 5, successText: 'Both sides are unsatisfied. Politics.' }
              ]}
        ],
        cicero: [
            { title: 'The Orator\'s Invitation', desc: 'Marcus Tullius Cicero invites you to hear him speak. Afterward, he asks your opinion.',
              choices: [
                { text: 'Praise his rhetoric genuinely', effects: { dignitas: 5 }, npcEffect: 15, successText: 'He beams. A new friendship begins.' },
                { text: 'Offer constructive criticism', effects: { }, npcEffect: 5, risk: { chance: 0.4, penalty: { npcChange: -15 }, desc: 'His ego is wounded.' }, successText: 'He appreciates your honesty.' },
                { text: 'Ask him to teach you', effects: { }, npcEffect: 20, successText: '"I don\'t usually... but for you, perhaps." Your speaking improves.', successEffects: { auctoritas: 10 } }
              ]},
            { title: 'Defense Request', desc: 'Cicero asks you to support his defense of an accused man. The case is politically charged.',
              choices: [
                { text: 'Stand with Cicero publicly', effects: { dignitas: 10 }, npcEffect: 25, risk: { chance: 0.3, penalty: { auctoritas: -10 }, desc: 'The accused is convicted anyway.' }, successText: 'The man is acquitted. Cicero is grateful.' },
                { text: 'Offer private support only', effects: { }, npcEffect: 10, successText: 'Cicero understands political realities.' },
                { text: 'Decline—too risky', effects: { }, npcEffect: -15, successText: 'Cicero is disappointed.' }
              ]}
        ],
        cato: [
            { title: 'The Stubborn Traditionalist', desc: 'Cato the Younger blocks the Senate doorway, lecturing on corruption. He fixes you with a stare. "And you? Are you another thief in a toga?"',
              choices: [
                { text: '"I serve Rome honorably"', effects: { }, npcEffect: 10, successText: '"We shall see," he grunts. High praise from Cato.' },
                { text: '"I do what I must to advance"', effects: { dignitas: -5 }, npcEffect: -20, successText: 'He spits. You\'ve made an enemy.' },
                { text: 'Ignore him and push past', effects: { }, npcEffect: -10, successText: 'He shouts after you. Others watch.' }
              ]},
            { title: 'Anti-Corruption Bill', desc: 'Cato proposes strict anti-bribery laws. Supporting him would be unpopular with... everyone who bribes.',
              choices: [
                { text: 'Support the bill vocally', effects: { dignitas: 15, auctoritas: -10 }, npcEffect: 30, successText: 'Cato nods approvingly. Others glare.' },
                { text: 'Water it down in committee', effects: { auctoritas: 10 }, npcEffect: -25, successText: 'Politics as usual. Cato is disgusted.' },
                { text: 'Oppose it—too disruptive', effects: { auctoritas: 5, dignitas: -10 }, npcEffect: -30, successText: 'Cato adds you to his mental enemies list.' }
              ]}
        ]
    };

    // Simpler random events for variety
    const RANDOM_EVENTS = [
        { type: 'good', title: 'Inheritance', desc: 'A distant relative leaves you money.', effects: { pecunia: 25 }, chance: 0.06 },
        { type: 'good', title: 'Favorable Omen', desc: 'The augurs declare the signs favor you.', effects: { dignitas: 10, popularis: 5 }, chance: 0.05 },
        { type: 'good', title: 'Investment Returns', desc: 'Your business ventures pay off handsomely.', effects: { pecunia: 30 }, chance: 0.05 },
        { type: 'bad', title: 'Scandal', desc: 'Rumours spread about your private life.', effects: { dignitas: -15, popularis: -8 }, chance: 0.06 },
        { type: 'bad', title: 'Debt Crisis', desc: 'A creditor demands immediate repayment.', effects: { pecunia: -25 }, chance: 0.06 },
        { type: 'bad', title: 'Failed Venture', desc: 'A shipping investment lost to pirates.', effects: { pecunia: -20 }, chance: 0.05 },
        { type: 'bad', title: 'Illness', desc: 'Fever keeps you bedridden. You miss opportunities.', effects: { dignitas: -10, auctoritas: -5 }, chance: 0.05 },
        { type: 'bad', title: 'Family Disgrace', desc: 'A relative is caught in scandal. It reflects on you.', effects: { dignitas: -15, auctoritas: -8 }, chance: 0.04 }
    ];

    const HISTORICAL_EVENTS = [
        { year: 133, title: 'Death of Tiberius Gracchus', desc: 'Tiberius Gracchus is beaten to death by senators. The Republic will never be the same.',
          edu: 'Tiberius Gracchus proposed redistributing public land to poor citizens. When he tried to stand for a second tribunate (breaking tradition), senators clubbed him to death with chair legs. This was the first political murder in Rome in nearly 400 years.' },
        { year: 121, title: 'Death of Gaius Gracchus', desc: 'Gaius Gracchus dies fleeing his enemies. Reform movements crushed.',
          edu: 'Gaius continued his brother\'s reforms and proposed citizenship for Italian allies. The Senate passed the "senatus consultum ultimum" (final decree) for the first time, authorizing violence against citizens. 3,000 of his supporters were killed.' },
        { year: 107, title: 'Marius Elected Consul', desc: 'Gaius Marius becomes consul and opens the army to the landless poor.',
          edu: 'Marius reformed the Roman army, allowing landless citizens to enlist. Soldiers now looked to their generals (not the state) for rewards of land after service. This created personal armies loyal to commanders—a fatal weakness for the Republic.' },
        { year: 88, title: 'Sulla Marches on Rome', desc: 'For the first time, a Roman general marches legions against the city.',
          edu: 'When the tribune Sulpicius transferred Sulla\'s command to Marius, Sulla did the unthinkable: he marched his army on Rome itself. The taboo against using legions in Italy was broken forever. Sulla declared "Let the laws be silent in the face of arms."' },
        { year: 82, title: 'Sulla\'s Proscriptions', desc: 'Sulla posts lists of enemies to be killed. Thousands die.',
          edu: 'Sulla invented the proscription: public lists of enemies whose property was confiscated and who could be killed by anyone. Over 500 senators and equestrians were murdered. Young Julius Caesar barely escaped the lists.' },
        { year: 73, title: 'Spartacus Revolt', desc: 'A gladiator leads a massive slave revolt threatening Italy.',
          edu: 'Spartacus, a Thracian gladiator, escaped from a training school with 70 others. His army grew to 70,000 escaped slaves and defeated multiple Roman legions. Crassus finally crushed the revolt; 6,000 captured slaves were crucified along the Appian Way.' },
        { year: 63, title: 'Catiline Conspiracy', desc: 'Cicero exposes Catiline\'s plot to overthrow the Republic.',
          edu: 'Catiline, a failed politician deep in debt, planned to murder the consuls and seize power. Cicero, as consul, exposed the plot in famous speeches. The conspirators were executed without trial—a decision that would later haunt Cicero.' },
        { year: 60, title: 'First Triumvirate', desc: 'Caesar, Pompey, and Crassus form a secret alliance.',
          edu: 'This informal alliance united Rome\'s three most powerful men: Pompey (military glory), Crassus (wealth), and Caesar (popular support). Though not official, they controlled Roman politics. Caesar received Gaul; Pompey married Caesar\'s daughter Julia.' },
        { year: 49, title: 'Caesar Crosses Rubicon', desc: '"The die is cast." Civil war begins.',
          edu: 'The Rubicon river marked the boundary of Italy. Bringing an army across meant war against the state. When Caesar crossed with his legion, he reportedly said "alea iacta est" (the die is cast). Four years of civil war followed.' },
        { year: 44, title: 'Assassination of Caesar', desc: 'On the Ides of March, Caesar falls beneath the daggers.',
          edu: 'On March 15, 44 BC, a group of senators stabbed Caesar 23 times in the Theatre of Pompey. The conspirators, led by Brutus and Cassius, believed they were saving the Republic. Instead, they triggered another civil war that would end it forever.' }
    ];

    // Flavor events - random Roman life events
    const FLAVOR_EVENTS = [
        { title: 'Favorable Omens', desc: 'The augurs declare the sacred chickens ate greedily. The gods favor you!',
          effects: { dignitas: 8, popularis: 5 }, type: 'good',
          edu: 'Romans took omens very seriously. Before any public business, augurs would observe the behavior of sacred chickens. If they ate eagerly, it was a good sign. Ignoring bad omens was considered impious and dangerous.' },
        { title: 'Unfavorable Omens', desc: 'Lightning strikes the temple of Jupiter. The priests say the gods are displeased.',
          effects: { dignitas: -5, popularis: -8 }, type: 'bad',
          edu: 'Lightning was considered a direct message from Jupiter. Temples struck by lightning had to be ritually purified. Public business on days of bad omens was often postponed.' },
        { title: 'Vestal Virgin Scandal', desc: 'A Vestal Virgin is accused of breaking her vows. The city is in uproar.',
          effects: { popularis: -5 }, type: 'news',
          edu: 'Vestal Virgins tended Rome\'s sacred flame and took 30-year vows of chastity. If convicted of breaking their vows, they were buried alive. Such scandals were seen as threatening Rome\'s divine protection.' },
        { title: 'Pirates!', desc: 'Pirates raid the coast. Trade is disrupted and grain prices rise.',
          effects: { pecunia: -10 }, type: 'bad',
          edu: 'Mediterranean piracy was endemic until Pompey cleared the seas in 67 BC. Pirates once kidnapped young Julius Caesar and held him for ransom. After his release, he returned with ships and crucified them all.' },
        { title: 'Triumph Celebration', desc: 'A victorious general celebrates a triumph through Rome. The city celebrates!',
          effects: { popularis: 5 }, type: 'good',
          edu: 'A triumph was Rome\'s highest honor—a parade through the city with captured treasures, prisoners, and the victorious army. The general wore Jupiter\'s own purple robes. A slave whispered "Remember, you are mortal" in his ear.' },
        { title: 'Gladiatorial Games', desc: 'A wealthy citizen sponsors spectacular games. The people are entertained.',
          effects: { popularis: 8 }, type: 'good',
          edu: 'Gladiatorial games originated as funeral rites. By the late Republic, ambitious politicians used them to win popular support. The games were expensive—Caesar went deeply into debt sponsoring them before his rise to power.' },
        { title: 'Grain Shortage', desc: 'Ships from Egypt are delayed. Bread prices soar and the poor grow restless.',
          effects: { popularis: -10 }, type: 'bad',
          edu: 'Rome depended on grain imports, especially from Egypt and Sicily. Grain distributions (the "dole") fed perhaps 300,000 citizens. Any disruption could cause riots. Controlling the grain supply was immense political power.' },
        { title: 'Building Project', desc: 'A new temple or basilica is dedicated. The city grows more magnificent.',
          effects: { dignitas: 3, popularis: 3 }, type: 'good',
          edu: 'Roman politicians built public works for glory and votes. The Forum was filled with basilicas, temples, and monuments bearing family names. These buildings advertised wealth, piety, and service to Rome.' },
        { title: 'Earthquake', desc: 'The earth shakes. Some buildings collapse and people speak of divine anger.',
          effects: { dignitas: -5 }, type: 'bad',
          edu: 'Romans interpreted natural disasters as messages from the gods. After earthquakes or other prodigies, priests would consult the Sibylline Books for instructions on appeasing divine anger.' },
        { title: 'Famous Orator Speaks', desc: 'A renowned speaker addresses the Forum. You attend and learn from his technique.',
          effects: { auctoritas: 5 }, type: 'good',
          edu: 'Oratory was essential for Roman political success. Young men studied rhetoric for years. Famous orators like Cicero, Hortensius, and later Caesar were celebrities. Their speeches were published and studied as literature.' }
    ];

    let game = {
        year: 134, age: 17, name: '', family: null, currentOffice: 'none', officesHeld: [],
        stats: { dignitas: 50, auctoritas: 20, pecunia: 50, military: 0, popularis: 50 },
        relationships: { crassus: 50, pompey: 50, caesar: 50, cicero: 50, cato: 50 },
        enemies: [], phase: 'intro', militaryYears: 0, consulYears: [], actionsThisYear: 0,
        currentEvent: null, usedMilitaryEvents: [], usedPoliticalEvents: [], usedNpcEvents: {},
        eventQueue: [],
        // New: rival system
        rival: null,
        rivalOffice: 'none',
        rivalMilitary: 0,
        rivalRelation: 50, // 0 = mortal enemy, 100 = ally
        // New: delayed consequences
        pendingConsequences: [], // { year: X, type: 'revenge'|'favour'|'scandal', data: {} }
        // New: track choices for callbacks
        savedTribune: false,
        betrayedAlly: false,
        tookBribe: false
    };

    function updateDisplay() {
        document.getElementById('yearDisplay').textContent = game.year + ' BC';
        document.getElementById('ageDisplay').textContent = 'Age ' + game.age;
        document.getElementById('playerName').textContent = game.name;
        ['dignitas', 'auctoritas', 'pecunia', 'military', 'popularis'].forEach(stat => {
            const el = document.getElementById(stat);
            const box = document.getElementById(stat + 'Box');
            if (el) {
                el.textContent = Math.round(game.stats[stat]);
                box.classList.remove('danger', 'good');
                if (game.stats[stat] <= 20) box.classList.add('danger');
                else if (game.stats[stat] >= 80) box.classList.add('good');
            }
        });
        document.querySelectorAll('.career-office').forEach(el => {
            const office = el.dataset.office;
            el.classList.remove('achieved', 'current', 'available');
            if (game.officesHeld.includes(office)) el.classList.add('achieved');
            if (game.currentOffice === office) el.classList.add('current');
            else if (canRunForOffice(office)) el.classList.add('available');
        });
        const relDiv = document.getElementById('relationships');
        relDiv.innerHTML = Object.entries(game.relationships).map(([id, value]) => {
            const npc = NPCS[id];
            let status = value <= 20 ? 'hostile' : value <= 40 ? 'cold' : value >= 80 ? 'allied' : value >= 60 ? 'warm' : 'neutral';
            return `<div class="relationship"><span class="rel-name">${npc.name}</span><div class="rel-bar"><div class="rel-fill ${status}" style="width:${value}%"></div></div></div>`;
        }).join('');
    }

    function modifyStats(changes) {
        let changeText = [];
        for (let stat in changes) {
            if (game.stats.hasOwnProperty(stat)) {
                const oldVal = game.stats[stat];
                game.stats[stat] = Math.max(0, Math.min(100, game.stats[stat] + changes[stat]));
                changeText.push(`${stat}: ${changes[stat] > 0 ? '+' : ''}${changes[stat]}`);

                // Trigger animation
                const box = document.getElementById(stat + 'Box');
                if (box) {
                    box.classList.remove('stat-flash-up', 'stat-flash-down');
                    void box.offsetWidth; // Force reflow
                    box.classList.add(changes[stat] > 0 ? 'stat-flash-up' : 'stat-flash-down');
                }
            }
        }
        updateDisplay();
        return changeText.join(', ');
    }

    function modifyRelationship(npcId, amount) {
        if (game.relationships.hasOwnProperty(npcId)) {
            game.relationships[npcId] = Math.max(0, Math.min(100, game.relationships[npcId] + amount));
        }
        updateDisplay();
    }

    function canRunForOffice(office) {
        const o = OFFICES[office];
        if (!o || game.age < o.minAge) return false;
        if (o.requiresConsul && !game.officesHeld.includes('consul')) return false;
        if (game.officesHeld.includes(office) && office !== 'consul') return false;
        if (office === 'consul' && game.consulYears.some(y => game.year - y < 10)) return false;
        if (office !== 'military' && game.militaryYears < 10) return false;
        const prevOffice = Object.entries(OFFICES).find(([k, v]) => v.order === o.order - 1);
        if (prevOffice && !game.officesHeld.includes(prevOffice[0]) && office !== 'military') return false;
        // Check stat requirements
        if (o.requires) {
            for (let stat in o.requires) {
                if (game.stats[stat] < o.requires[stat]) return false;
            }
        }
        return true;
    }

    function getNextOffice() {
        const officeOrder = ['military', 'quaestor', 'aedile', 'praetor', 'consul'];
        for (let office of officeOrder) {
            if (!game.officesHeld.includes(office) || office === 'consul') {
                return office;
            }
        }
        return 'censor';
    }

    function getOfficeRequirementsHtml(office) {
        const o = OFFICES[office];
        if (!o || !o.requires) return '';
        let reqs = [];
        for (let stat in o.requires) {
            const current = Math.round(game.stats[stat]);
            const needed = o.requires[stat];
            const met = current >= needed;
            reqs.push(`<span style="color:${met ? 'var(--success)' : 'var(--danger)'}">${stat}: ${current}/${needed} ${met ? '✓' : '✗'}</span>`);
        }
        return reqs.join(' | ');
    }

    function getOfficeBlockers(office) {
        const o = OFFICES[office];
        if (!o) return 'Unknown office';
        let blockers = [];

        // Age check
        if (game.age < o.minAge) {
            blockers.push(`Too young: age ${game.age}/${o.minAge} (wait ${o.minAge - game.age} years)`);
        }

        // Previous office check
        const prevOffice = Object.entries(OFFICES).find(([k, v]) => v.order === o.order - 1);
        if (prevOffice && !game.officesHeld.includes(prevOffice[0]) && office !== 'military') {
            blockers.push(`Must hold ${OFFICES[prevOffice[0]].name} first`);
        }

        // Consul requirement for Censor
        if (o.requiresConsul && !game.officesHeld.includes('consul')) {
            blockers.push('Must have been Consul first');
        }

        // Stat requirements
        if (o.requires) {
            for (let stat in o.requires) {
                if (game.stats[stat] < o.requires[stat]) {
                    blockers.push(`${stat}: ${Math.round(game.stats[stat])}/${o.requires[stat]}`);
                }
            }
        }

        return blockers.length > 0 ? blockers.join('<br>') : 'Requirements met!';
    }

    function advanceRival() {
        if (!game.rival) return;
        // Rival advances their military if still serving
        if (game.rivalMilitary < 10) {
            game.rivalMilitary++;
            return;
        }
        // Rival tries to advance in politics
        const officeOrder = ['quaestor', 'aedile', 'praetor', 'consul'];
        const currentIdx = officeOrder.indexOf(game.rivalOffice);
        const nextOffice = officeOrder[currentIdx + 1];
        if (nextOffice && Math.random() < 0.4) {
            game.rivalOffice = nextOffice;
        }
    }

    function checkGameOver() {
        if (game.stats.dignitas <= 0) return { over: true, reason: 'disgrace', title: 'DISGRACE', desc: 'Your reputation is destroyed. You retire to obscurity.' };
        if (game.stats.pecunia <= 0) return { over: true, reason: 'bankrupt', title: 'BANKRUPTCY', desc: 'Your creditors seize everything. Ruined, you flee Rome.' };
        if (game.enemies.length >= 5) return { over: true, reason: 'assassinated', title: 'ASSASSINATION', desc: 'Too many enemies. You are found dead near the Forum.' };
        if (game.age >= 70) return { over: true, reason: 'age', title: 'A LIFE COMPLETED', desc: 'You have lived a long Roman life. What legacy do you leave?' };
        return { over: false };
    }

    function showIntro() {
        game.phase = 'intro';
        document.getElementById('contentArea').innerHTML = `
            <div class="intro-screen">
                <h2>The Path to Power</h2>
                <p>It is <strong>134 BC</strong>. The Roman Republic stands at a crossroads. You are 17 years old. Before you lies the <em>cursus honorum</em> — the ladder of offices leading to the consulship and glory. Or perhaps to ruin.</p>
                <p><strong>Goal:</strong> Rise through military service, win elections, become Consul. Survive the politics of the Late Republic.</p>
                <p>Choose your family background:</p>
                <div class="family-choices" id="familyChoices">
                    ${FAMILIES.map(f => `
                        <div class="family-choice" onclick="selectFamily('${f.id}')" data-family="${f.id}">
                            <h4>${f.name}</h4>
                            <p>${f.desc}</p>
                            <div class="bonuses">${Object.entries(f.bonuses).map(([k,v]) => `${k}: ${v>0?'+':''}${v}`).join(', ')}</div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-primary" onclick="startGame()" id="startBtn" disabled>SELECT A BACKGROUND</button>
                <div class="historical-note">
                    <strong>Educational Note:</strong> The cursus honorum was the sequence of offices held by aspiring Roman politicians. Each had minimum age requirements. Bribery was common. Violence was not unknown.
                </div>
            </div>
        `;
    }

    function selectFamily(familyId) {
        game.family = FAMILIES.find(f => f.id === familyId);
        document.querySelectorAll('.family-choice').forEach(el => el.classList.toggle('selected', el.dataset.family === familyId));
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'BEGIN YOUR CAREER';
    }

    function startGame() {
        if (!game.family) return;
        for (let stat in game.family.bonuses) {
            if (game.stats.hasOwnProperty(stat)) game.stats[stat] += game.family.bonuses[stat];
        }
        const praenomina = ['Marcus', 'Gaius', 'Lucius', 'Quintus', 'Publius'];
        const nomina = { patrician: ['Cornelius', 'Aemilius', 'Claudius'], plebeian_noble: ['Tullius', 'Sempronius', 'Licinius'], equestrian: ['Atticus', 'Balbus', 'Oppius'], novus: ['Tullius', 'Didius', 'Fufius'] };
        const cognomina = ['Rufus', 'Niger', 'Longus', 'Pulcher', 'Brutus'];
        game.name = praenomina[Math.floor(Math.random()*praenomina.length)] + ' ' + nomina[game.family.id][Math.floor(Math.random()*nomina[game.family.id].length)] + ' ' + cognomina[Math.floor(Math.random()*cognomina.length)];
        // Initialize rival
        game.rival = RIVAL_NAMES[Math.floor(Math.random() * RIVAL_NAMES.length)];
        game.rivalOffice = 'none';
        game.rivalMilitary = 0;
        game.rivalRelation = 40 + Math.floor(Math.random() * 20); // 40-60 starting
        document.getElementById('careerTrack').classList.remove('hidden');
        document.getElementById('statsRow').classList.remove('hidden');
        document.getElementById('relationships').classList.remove('hidden');
        updateDisplay();
        showRivalIntro();
    }

    function showRivalIntro() {
        document.getElementById('contentArea').innerHTML = `
            <div class="event-card" style="border-color:var(--danger);">
                <div class="event-type">⚔️ Your Rival</div>
                <div class="event-title">${game.rival.name}</div>
                <div class="event-desc">
                    <p>As you prepare to begin your military service, you notice another young man of your age also joining the legions.</p>
                    <p><strong>${game.rival.short}</strong> — ${game.rival.desc}. You've heard of his family. He has the same ambitions as you: to climb the <em>cursus honorum</em> and become Consul.</p>
                    <p>Throughout your career, you will compete with ${game.rival.short}. He will run against you in elections. He may help you or hinder you. The choice of how to deal with him is yours.</p>
                </div>
            </div>
            <button class="btn-primary" onclick="showYearStart()">Begin Your Career</button>
        `;
    }

    function showYearStart() {
        game.phase = 'year_start';
        game.actionsThisYear = 0;

        // Check for delayed consequences
        const consequence = game.pendingConsequences.find(c => c.year === game.year);
        if (consequence) {
            game.pendingConsequences = game.pendingConsequences.filter(c => c !== consequence);
            showConsequence(consequence);
            return;
        }

        const historicalEvent = HISTORICAL_EVENTS.find(e => e.year === game.year);
        let historyHtml = '';
        if (historicalEvent) {
            historyHtml = `<div class="event-card" style="border-color:var(--wax-gold);"><div class="event-type">⚡ Historical Event</div><div class="event-title">${historicalEvent.title}</div><div class="event-desc">${historicalEvent.desc}</div></div>`;
            if (historicalEvent.edu) {
                historyHtml += `<div class="edu-note"><h5>📜 This Year in History</h5><p>${historicalEvent.edu}</p></div>`;
            }
        }

        // Show next goal
        const nextOffice = getNextOffice();
        const nextO = OFFICES[nextOffice];
        let goalHtml = '';
        if (game.militaryYears < 10) {
            goalHtml = `<div class="event-card" style="border-color:var(--bronze);"><div class="event-type">🎯 Current Goal</div><div class="event-title">Complete Military Service</div><div class="event-desc">You need <strong>${10 - game.militaryYears} more years</strong> of service before you can enter politics.</div></div>`;
        } else if (nextO && nextO.requires) {
            const reqs = getOfficeRequirementsHtml(nextOffice);
            const ageReq = nextO.minAge > game.age ? `<div style="color:var(--danger);">Age: ${game.age}/${nextO.minAge} (wait ${nextO.minAge - game.age} years)</div>` : `<div style="color:var(--success);">Age: ${game.age}/${nextO.minAge} ✓</div>`;
            goalHtml = `<div class="event-card" style="border-color:var(--bronze);"><div class="event-type">🎯 Next Office: ${nextO.name}</div><div class="event-desc">${ageReq}<div style="margin-top:5px;">${reqs}</div></div></div>`;
        }

        // Rival status
        let rivalHtml = '';
        if (game.rival) {
            const rivalStatus = game.rivalMilitary < 10 ? `Military (${game.rivalMilitary}/10)` : OFFICES[game.rivalOffice].name;
            const relStatus = game.rivalRelation < 30 ? 'Enemy' : game.rivalRelation < 50 ? 'Cold' : game.rivalRelation < 70 ? 'Neutral' : 'Friendly';
            rivalHtml = `<div class="summary-item"><span>Rival (${game.rival.short}):</span><span>${rivalStatus} — ${relStatus}</span></div>`;
        }

        document.getElementById('contentArea').innerHTML = `
            <div class="section-title">Year ${game.year} BC — Age ${game.age}</div>
            ${historyHtml}
            ${goalHtml}
            <div class="year-summary">
                <h4>Your Situation</h4>
                <div class="summary-item"><span>Position:</span><span>${OFFICES[game.currentOffice].name}</span></div>
                <div class="summary-item"><span>Military Service:</span><span>${game.militaryYears}/10 years</span></div>
                ${rivalHtml}
                <div class="summary-item"><span>Enemies:</span><span>${game.enemies.length}/5</span></div>
                <div class="summary-item"><span>Actions this year:</span><span>0/${MAX_ACTIONS_PER_YEAR}</span></div>
            </div>
            <button class="btn-primary" onclick="processYear()">Continue</button>
        `;
    }

    function showConsequence(consequence) {
        let html = '';
        if (consequence.type === 'revenge') {
            html = `<div class="event-card" style="border-color:var(--danger);"><div class="event-type">⚠️ The Past Returns</div><div class="event-title">${consequence.data.title}</div><div class="event-desc">${consequence.data.desc}</div></div>`;
            modifyStats(consequence.data.effects || {});
        } else if (consequence.type === 'favour') {
            html = `<div class="event-card" style="border-color:var(--success);"><div class="event-type">🌟 A Debt Repaid</div><div class="event-title">${consequence.data.title}</div><div class="event-desc">${consequence.data.desc}</div></div>`;
            modifyStats(consequence.data.effects || {});
        }
        document.getElementById('contentArea').innerHTML = `
            <div class="section-title">Year ${game.year} BC — Age ${game.age}</div>
            ${html}
            <button class="btn-primary" onclick="showYearStart()">Continue</button>
        `;
    }

    function processYear() {
        // This now just triggers the year actions with event generation
        showYearActions();
    }

    function showYearActions() {
        game.phase = 'year_actions';
        const status = checkGameOver();
        if (status.over) { showGameEnd(status); return; }

        // Check if we should trigger an event instead of showing the menu
        if (game.eventQueue.length > 0) {
            const nextEvent = game.eventQueue.shift();
            showEventFromQueue(nextEvent);
            return;
        }

        // Generate events for this year
        if (game.actionsThisYear === 0) {
            generateYearEvents();
            if (game.eventQueue.length > 0) {
                const nextEvent = game.eventQueue.shift();
                showEventFromQueue(nextEvent);
                return;
            }
        }

        const actionsLeft = MAX_ACTIONS_PER_YEAR - game.actionsThisYear;
        const outOfActions = actionsLeft <= 0;

        // Action counter display
        let actionCounterHtml = `<div style="text-align:center;margin-bottom:15px;padding:10px;background:${outOfActions ? '#f5e0e0' : '#e0f0e0'};border-radius:5px;">
            <strong>Actions Remaining: ${actionsLeft}/${MAX_ACTIONS_PER_YEAR}</strong>
            ${outOfActions ? '<div style="color:var(--danger);font-size:0.9rem;">You must end the year</div>' : ''}
        </div>`;

        let actionsHtml = actionCounterHtml;

        if (game.militaryYears < 10) {
            // During military service years - serve is always available (mandatory)
            actionsHtml += `<div class="event-card"><div class="event-type">Military Service</div><div class="event-title">Serve in the Legions</div><div class="event-desc">You need <strong>${10 - game.militaryYears} more years</strong> of service before seeking office.</div><button class="btn-primary btn-success" onclick="doMilitaryService()">Serve This Year</button></div>`;
        } else {
            const availableOffices = Object.entries(OFFICES).filter(([id]) => canRunForOffice(id) && id !== 'none');
            if (availableOffices.length > 0) {
                actionsHtml += `<div class="event-card"><div class="event-type">Elections (costs 2 actions)</div><div class="event-title">Stand for Office</div><div class="choices">${availableOffices.map(([id, o]) => {
                    const reqs = getOfficeRequirementsHtml(id);
                    return `<button class="choice-btn" onclick="startElection('${id}')" ${outOfActions || actionsLeft < 2 ? 'disabled' : ''}><strong>${o.name}</strong><span class="choice-effect">${reqs}</span></button>`;
                }).join('')}</div></div>`;
            } else {
                // Show why you can't run for the next office
                const nextOffice = getNextOffice();
                const nextO = OFFICES[nextOffice];
                if (nextO && nextOffice !== 'military') {
                    const blockers = getOfficeBlockers(nextOffice);
                    actionsHtml += `<div class="event-card" style="border-color:var(--ink-light);opacity:0.8;"><div class="event-type">🚫 Cannot Stand for Election</div><div class="event-title">Next: ${nextO.name}</div><div class="event-desc" style="color:var(--danger);">${blockers}</div></div>`;
                }
            }
            if (game.currentOffice !== 'none' && game.currentOffice !== 'military') {
                actionsHtml += `<div class="event-card"><div class="event-type">Official Duties (1 action)</div><div class="event-title">Serve as ${OFFICES[game.currentOffice].name}</div><button class="btn-primary" onclick="performDuties()" ${outOfActions ? 'disabled' : ''}>Perform Duties</button></div>`;
            }
            // Show a simpler action menu for political life
            actionsHtml += `<div class="event-card"><div class="event-type">Daily Life (1 action each)</div><div class="event-title">How do you spend your time?</div><div class="choices">
                <button class="choice-btn" onclick="doPoliticalAction('forum')" ${outOfActions ? 'disabled' : ''}>Attend the Forum<span class="choice-effect">+Influence, chance of encounters</span></button>
                <button class="choice-btn" onclick="doPoliticalAction('business')" ${outOfActions ? 'disabled' : ''}>Manage Business<span class="choice-effect">+/-Wealth (risky but rewarding)</span></button>
                <button class="choice-btn" onclick="doPoliticalAction('social')" ${outOfActions ? 'disabled' : ''}>Social Events<span class="choice-effect">+Relationships, +Dignitas</span></button>
                <button class="choice-btn" onclick="doPoliticalAction('train')" ${outOfActions ? 'disabled' : ''}>Train & Study<span class="choice-effect">+Military or +Influence (your choice)</span></button>
            </div></div>`;

            // Add rival interaction option
            if (game.rival) {
                actionsHtml += `<div class="event-card" style="border-color:var(--danger);"><div class="event-type">⚔️ Rival (1 action)</div><div class="event-title">Deal with ${game.rival.short}</div>
                <div class="event-desc" style="font-size:0.85rem;">Relationship: ${game.rivalRelation}% — ${game.rivalRelation < 30 ? 'Hostile' : game.rivalRelation < 50 ? 'Cold' : game.rivalRelation < 70 ? 'Neutral' : 'Friendly'}</div>
                <div class="choices">
                    <button class="choice-btn" onclick="rivalAction('befriend')" ${outOfActions ? 'disabled' : ''}>Approach as friend<span class="choice-effect">Try to improve relations</span></button>
                    <button class="choice-btn" onclick="rivalAction('undermine')" ${outOfActions ? 'disabled' : ''}>Undermine him<span class="choice-effect">Sabotage his career (risky)</span></button>
                    <button class="choice-btn" onclick="rivalAction('challenge')" ${outOfActions ? 'disabled' : ''}>Public challenge<span class="choice-effect">Debate him for glory (very risky)</span></button>
                </div></div>`;
            }
        }
        actionsHtml += `<button class="btn-primary btn-secondary" onclick="endYear()" style="margin-top:15px;">${outOfActions ? 'End Year (no actions left)' : 'End Year Early'}</button>`;
        document.getElementById('contentArea').innerHTML = `<div class="section-title">Year ${game.year} BC — Actions</div>${actionsHtml}`;
    }

    function rivalAction(action) {
        game.actionsThisYear++;
        let resultHtml = '';

        if (action === 'befriend') {
            const success = Math.random() < (0.4 + (game.stats.auctoritas / 200));
            if (success) {
                game.rivalRelation = Math.min(100, game.rivalRelation + 15);
                resultHtml = `<div class="event-card" style="border-color:var(--success);"><div class="event-type">Success</div><div class="event-title">A Warmer Reception</div><div class="event-desc">${game.rival.short} seems receptive to friendship. Perhaps you can work together... for now.</div><div style="color:var(--success);">Rival relation: +15</div></div>`;
            } else {
                game.rivalRelation = Math.max(0, game.rivalRelation - 5);
                resultHtml = `<div class="event-card" style="border-color:var(--danger);"><div class="event-type">Rebuffed</div><div class="event-title">Cold Shoulder</div><div class="event-desc">"I know what you're doing," ${game.rival.short} says coldly. "We are not friends."</div><div style="color:var(--danger);">Rival relation: -5</div></div>`;
            }
        } else if (action === 'undermine') {
            const success = Math.random() < 0.5;
            if (success) {
                game.rivalRelation = Math.max(0, game.rivalRelation - 20);
                modifyStats({ auctoritas: 5 });
                // Set back rival's progress
                if (game.rivalMilitary > 0 && game.rivalMilitary < 10) game.rivalMilitary = Math.max(0, game.rivalMilitary - 1);
                resultHtml = `<div class="event-card" style="border-color:var(--success);"><div class="event-type">Success</div><div class="event-title">Rumours Spread</div><div class="event-desc">Your whispers reach the right ears. ${game.rival.short}'s reputation suffers, and his career is set back.</div><div style="color:var(--success);">+5 Influence, Rival set back</div><div style="color:var(--danger);">Rival relation: -20</div></div>`;
            } else {
                game.rivalRelation = Math.max(0, game.rivalRelation - 15);
                modifyStats({ dignitas: -10 });
                resultHtml = `<div class="event-card" style="border-color:var(--danger);"><div class="event-type">Backfire!</div><div class="event-title">Caught Scheming</div><div class="event-desc">${game.rival.short} discovers your plot and exposes you. "This is who ${game.name} really is!" he declares in the Forum.</div><div style="color:var(--danger);">-10 Dignitas, Rival relation: -15</div></div>`;
            }
        } else if (action === 'challenge') {
            const yourScore = game.stats.dignitas + game.stats.auctoritas + Math.random() * 40;
            const rivalScore = 100 + Math.random() * 50;
            if (yourScore > rivalScore) {
                modifyStats({ dignitas: 15, popularis: 10 });
                game.rivalRelation = Math.max(0, game.rivalRelation - 10);
                resultHtml = `<div class="event-card" style="border-color:var(--success);"><div class="event-type">Victory!</div><div class="event-title">Triumph in Debate</div><div class="event-desc">In front of a crowd at the Forum, you demolish ${game.rival.short}'s arguments. The people cheer your name!</div><div style="color:var(--success);">+15 Dignitas, +10 Popularity</div></div>`;
            } else {
                modifyStats({ dignitas: -15, popularis: -5 });
                game.rivalRelation = Math.max(0, game.rivalRelation - 5);
                resultHtml = `<div class="event-card" style="border-color:var(--danger);"><div class="event-type">Defeat</div><div class="event-title">Humiliated</div><div class="event-desc">${game.rival.short} tears your arguments apart. The crowd laughs. You slink away, humiliated.</div><div style="color:var(--danger);">-15 Dignitas, -5 Popularity</div></div>`;
            }
        }

        document.getElementById('contentArea').innerHTML = `
            <div class="section-title">Rival Encounter</div>
            ${resultHtml}
            <button class="btn-primary" onclick="showYearActions()">Continue</button>
        `;
    }

    function generateYearEvents() {
        // Generate 1-3 events for this year
        const numEvents = 1 + Math.floor(Math.random() * 2);

        for (let i = 0; i < numEvents; i++) {
            // Chance for NPC encounter
            if (Math.random() < 0.4) {
                const npcIds = Object.keys(NPC_EVENTS);
                const npcId = npcIds[Math.floor(Math.random() * npcIds.length)];
                const npcEventList = NPC_EVENTS[npcId];

                // Get unused events for this NPC
                if (!game.usedNpcEvents[npcId]) game.usedNpcEvents[npcId] = [];
                const availableNpcEvents = npcEventList.filter((e, idx) => !game.usedNpcEvents[npcId].includes(idx));

                if (availableNpcEvents.length > 0) {
                    const eventIdx = npcEventList.indexOf(availableNpcEvents[Math.floor(Math.random() * availableNpcEvents.length)]);
                    game.usedNpcEvents[npcId].push(eventIdx);
                    game.eventQueue.push({ type: 'npc', npcId, event: npcEventList[eventIdx] });
                }
            }

            // Chance for political event (if not in military)
            if (game.militaryYears >= 10 && Math.random() < 0.5) {
                const officeOrder = { none: 0, quaestor: 1, aedile: 2, praetor: 3, consul: 4, censor: 5 };
                const currentOrder = officeOrder[game.currentOffice] || 0;

                const availablePolitical = POLITICAL_EVENTS.filter((e, idx) => {
                    if (game.usedPoliticalEvents.includes(idx)) return false;
                    if (e.minOffice && officeOrder[e.minOffice] > currentOrder) return false;
                    if (e.requires) {
                        for (let s in e.requires) if (game.stats[s] < e.requires[s]) return false;
                    }
                    return true;
                });

                if (availablePolitical.length > 0) {
                    const eventIdx = POLITICAL_EVENTS.indexOf(availablePolitical[Math.floor(Math.random() * availablePolitical.length)]);
                    game.usedPoliticalEvents.push(eventIdx);
                    game.eventQueue.push({ type: 'political', event: POLITICAL_EVENTS[eventIdx] });
                }
            }

            // Simple random events
            const randomEvent = RANDOM_EVENTS.find(e => Math.random() < e.chance);
            if (randomEvent) {
                game.eventQueue.push({ type: 'random', event: randomEvent });
            }

            // Flavor events (Roman life color)
            if (Math.random() < 0.25) {
                const flavorEvent = FLAVOR_EVENTS[Math.floor(Math.random() * FLAVOR_EVENTS.length)];
                game.eventQueue.push({ type: 'flavor', event: flavorEvent });
            }
        }
    }

    function showEventFromQueue(queuedEvent) {
        if (queuedEvent.type === 'npc') {
            showNpcEvent(queuedEvent.npcId, queuedEvent.event);
        } else if (queuedEvent.type === 'political') {
            showPoliticalEvent(queuedEvent.event);
        } else if (queuedEvent.type === 'random') {
            showSimpleRandomEvent(queuedEvent.event);
        } else if (queuedEvent.type === 'flavor') {
            showFlavorEvent(queuedEvent.event);
        }
    }

    function showNpcEvent(npcId, event) {
        game.currentEvent = { ...event, type: 'npc', npcId };
        const npc = NPCS[npcId];
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="event-card" style="border-color:var(--bronze);">
                <div class="event-type">👤 Encounter: ${npc.fullName}</div>
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc}</div>
                <div style="font-size:0.85rem;color:var(--ink-light);margin:10px 0;">Your relationship: ${game.relationships[npcId]}%</div>
                <div class="choices">
                    ${event.choices.map((c, i) => {
                        let disabled = c.requires ? Object.entries(c.requires).some(([s,v]) => game.stats[s] < v) : false;
                        let effectPreview = Object.entries(c.effects || {}).map(([k,v]) => `${k}: ${v > 0 ? '+' : ''}${v}`).join(', ') || '';
                        return `<button class="choice-btn" onclick="resolveNpcChoice(${i})" ${disabled ? 'disabled' : ''}>${c.text}<span class="choice-effect">${effectPreview}</span></button>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function resolveNpcChoice(i) {
        const choice = game.currentEvent.choices[i];
        const npcId = game.currentEvent.npcId;
        const npc = NPCS[npcId];

        let resultText = modifyStats(choice.effects || {});
        let riskText = '';
        let successText = '';

        // Handle NPC relationship change
        if (choice.npcEffect) {
            modifyRelationship(npcId, choice.npcEffect);
            resultText += (resultText ? ', ' : '') + `${npc.name}: ${choice.npcEffect > 0 ? '+' : ''}${choice.npcEffect}`;
        }

        if (choice.risk && Math.random() < choice.risk.chance) {
            modifyStats(choice.risk.penalty || {});
            if (choice.risk.npcChange) modifyRelationship(npcId, choice.risk.npcChange);
            riskText = `<div style="color:var(--danger);margin-top:10px;font-weight:bold;">⚠️ ${choice.risk.desc}</div>`;
        } else if (choice.successText) {
            successText = `<div style="color:var(--success);margin-top:10px;">${choice.successText}</div>`;
            if (choice.successEffects) {
                const extraText = modifyStats(choice.successEffects);
                resultText += (resultText ? ', ' : '') + extraText;
            }
        }

        document.getElementById('contentArea').innerHTML = `
            <div class="event-card">
                <div class="event-type">Result</div>
                <div class="event-title">${choice.text}</div>
                ${resultText ? `<div style="font-style:italic;color:var(--ink-light);">${resultText}</div>` : ''}
                ${riskText}${successText}
            </div>
            <button class="btn-primary" onclick="continueAfterEvent()">Continue</button>
        `;
    }

    function showPoliticalEvent(event) {
        game.currentEvent = { ...event, type: 'political' };
        // If event involves a random NPC, pick one
        if (event.npc === 'random') {
            const npcIds = Object.keys(NPCS);
            game.currentEvent.npcId = npcIds[Math.floor(Math.random() * npcIds.length)];
        }

        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="event-card" style="border-color:var(--senate);">
                <div class="event-type">⚖️ Political Event</div>
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc}</div>
                <div class="choices">
                    ${event.choices.map((c, i) => {
                        let disabled = c.requires ? Object.entries(c.requires).some(([s,v]) => game.stats[s] < v) : false;
                        let effectPreview = Object.entries(c.effects || {}).map(([k,v]) => `${k}: ${v > 0 ? '+' : ''}${v}`).join(', ') || '';
                        return `<button class="choice-btn" onclick="resolvePoliticalChoice(${i})" ${disabled ? 'disabled' : ''}>${c.text}<span class="choice-effect">${effectPreview}</span></button>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function resolvePoliticalChoice(i) {
        const choice = game.currentEvent.choices[i];
        const npcId = game.currentEvent.npcId;

        let resultText = modifyStats(choice.effects || {});
        let riskText = '';
        let successText = '';

        // Handle NPC relationship change if applicable
        if (choice.npcEffect && npcId) {
            modifyRelationship(npcId, choice.npcEffect);
            resultText += (resultText ? ', ' : '') + `${NPCS[npcId].name}: ${choice.npcEffect > 0 ? '+' : ''}${choice.npcEffect}`;
        }

        if (choice.risk && Math.random() < choice.risk.chance) {
            modifyStats(choice.risk.penalty || {});
            riskText = `<div style="color:var(--danger);margin-top:10px;font-weight:bold;">⚠️ ${choice.risk.desc}</div>`;
        } else if (choice.successText) {
            successText = `<div style="color:var(--success);margin-top:10px;">${choice.successText}</div>`;
            if (choice.successEffects) {
                const extraText = modifyStats(choice.successEffects);
                resultText += (resultText ? ', ' : '') + extraText;
            }
        }

        document.getElementById('contentArea').innerHTML = `
            <div class="event-card">
                <div class="event-type">Result</div>
                <div class="event-title">${choice.text}</div>
                ${resultText ? `<div style="font-style:italic;color:var(--ink-light);">${resultText}</div>` : ''}
                ${riskText}${successText}
            </div>
            <button class="btn-primary" onclick="continueAfterEvent()">Continue</button>
        `;
    }

    function showSimpleRandomEvent(event) {
        const changeText = modifyStats(event.effects);
        document.getElementById('contentArea').innerHTML = `
            <div class="event-card" style="border-color:${event.type === 'good' ? 'var(--success)' : 'var(--danger)'};">
                <div class="event-type">${event.type === 'good' ? '🌟 Fortune' : '⚡ Misfortune'}</div>
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc}</div>
                <div style="margin-top:10px;font-style:italic;color:${event.type === 'good' ? 'var(--success)' : 'var(--danger)'};">${changeText}</div>
            </div>
            <button class="btn-primary" onclick="continueAfterEvent()">Continue</button>
        `;
    }

    function showFlavorEvent(event) {
        const changeText = modifyStats(event.effects || {});
        const icon = event.type === 'good' ? '🏛️' : event.type === 'bad' ? '⚡' : '📜';
        const borderColor = event.type === 'good' ? 'var(--success)' : event.type === 'bad' ? 'var(--danger)' : 'var(--bronze)';
        const textColor = event.type === 'good' ? 'var(--success)' : event.type === 'bad' ? 'var(--danger)' : 'var(--ink-light)';

        document.getElementById('contentArea').innerHTML = `
            <div class="event-card" style="border-color:${borderColor};">
                <div class="event-type">${icon} Life in Rome</div>
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc}</div>
                ${changeText ? `<div style="margin-top:10px;font-style:italic;color:${textColor};">${changeText}</div>` : ''}
            </div>
            ${event.edu ? `<div class="edu-note"><h5>📜 Did You Know?</h5><p>${event.edu}</p></div>` : ''}
            <button class="btn-primary" onclick="continueAfterEvent()">Continue</button>
        `;
    }

    function continueAfterEvent() {
        game.actionsThisYear++;
        if (game.eventQueue.length > 0) {
            const nextEvent = game.eventQueue.shift();
            showEventFromQueue(nextEvent);
        } else {
            showYearActions();
        }
    }

    function doPoliticalAction(actionType) {
        game.actionsThisYear++;

        if (actionType === 'forum') {
            // Chance for a political or NPC event
            if (Math.random() < 0.6) {
                const npcIds = Object.keys(NPC_EVENTS);
                const npcId = npcIds[Math.floor(Math.random() * npcIds.length)];
                const npcEventList = NPC_EVENTS[npcId];
                if (!game.usedNpcEvents[npcId]) game.usedNpcEvents[npcId] = [];
                const availableNpcEvents = npcEventList.filter((e, idx) => !game.usedNpcEvents[npcId].includes(idx));

                if (availableNpcEvents.length > 0) {
                    const eventIdx = npcEventList.indexOf(availableNpcEvents[Math.floor(Math.random() * availableNpcEvents.length)]);
                    game.usedNpcEvents[npcId].push(eventIdx);
                    showNpcEvent(npcId, npcEventList[eventIdx]);
                    return;
                }
            }
            // Fallback: simple forum visit
            const outcomes = [
                { desc: 'You listen to speeches and gauge the political mood.', effects: { auctoritas: 3 } },
                { desc: 'A lively debate on provincial taxation. You make your views known.', effects: { dignitas: 5, popularis: -3 } },
                { desc: 'You spot rivals plotting. Useful intelligence.', effects: { auctoritas: 5 } }
            ];
            const outcome = outcomes[Math.floor(Math.random() * outcomes.length)];
            const changeText = modifyStats(outcome.effects);
            document.getElementById('contentArea').innerHTML = `
                <div class="event-card"><div class="event-type">The Forum</div><div class="event-title">A Day in Public Life</div><div class="event-desc">${outcome.desc}</div><div style="margin-top:10px;font-style:italic;">${changeText}</div></div>
                <button class="btn-primary" onclick="showYearActions()">Continue</button>
            `;
        } else if (actionType === 'business') {
            const roll = Math.random();
            let outcome;
            if (roll < 0.3) {
                outcome = { desc: 'Your investments pay off handsomely.', effects: { pecunia: 20 } };
            } else if (roll < 0.5) {
                outcome = { desc: 'A shipping venture is lost to storms.', effects: { pecunia: -15 } };
            } else {
                outcome = { desc: 'Steady returns from your estates.', effects: { pecunia: 8 } };
            }
            const changeText = modifyStats(outcome.effects);
            document.getElementById('contentArea').innerHTML = `
                <div class="event-card"><div class="event-type">Business Affairs</div><div class="event-title">Managing Your Wealth</div><div class="event-desc">${outcome.desc}</div><div style="margin-top:10px;font-style:italic;">${changeText}</div></div>
                <button class="btn-primary" onclick="showYearActions()">Continue</button>
            `;
        } else if (actionType === 'social') {
            // Pick a random NPC to potentially interact with
            const npcIds = Object.keys(NPCS);
            const npcId = npcIds[Math.floor(Math.random() * npcIds.length)];
            const npc = NPCS[npcId];

            const roll = Math.random();
            let change, desc;
            if (roll < 0.5) {
                change = 5 + Math.floor(Math.random() * 10);
                desc = `You have a pleasant conversation with ${npc.name} at a dinner party.`;
            } else if (roll < 0.8) {
                change = -5;
                desc = `${npc.name} snubs you at a social gathering.`;
            } else {
                change = 10 + Math.floor(Math.random() * 10);
                desc = `You impress ${npc.name} with your wit and insight.`;
            }
            modifyRelationship(npcId, change);
            modifyStats({ dignitas: 3 }); // Social events always give some dignitas
            document.getElementById('contentArea').innerHTML = `
                <div class="event-card"><div class="event-type">Social Events</div><div class="event-title">Roman High Society</div><div class="event-desc">${desc}</div><div style="margin-top:10px;font-style:italic;">${npc.name}: ${change > 0 ? '+' : ''}${change}, dignitas: +3</div></div>
                <button class="btn-primary" onclick="showYearActions()">Continue</button>
            `;
        } else if (actionType === 'train') {
            // Let player choose what to train
            document.getElementById('contentArea').innerHTML = `
                <div class="event-card"><div class="event-type">Training & Study</div><div class="event-title">Self-Improvement</div>
                <div class="event-desc">How do you spend your time improving yourself?</div>
                <div class="choices">
                    <button class="choice-btn" onclick="doTraining('military')">Military exercises<span class="choice-effect">+8 Military</span></button>
                    <button class="choice-btn" onclick="doTraining('auctoritas')">Study rhetoric & law<span class="choice-effect">+8 Influence</span></button>
                    <button class="choice-btn" onclick="doTraining('popularis')">Mingle with the people<span class="choice-effect">+8 Popularity</span></button>
                </div></div>
            `;
        }
    }

    function doTraining(stat) {
        const changeText = modifyStats({ [stat]: 8 });
        const descriptions = {
            military: 'You train with weapons and study tactics. Your military knowledge grows.',
            auctoritas: 'You study law, rhetoric, and the art of persuasion. Your influence grows.',
            popularis: 'You walk the streets, talk to shopkeepers and workers. The common people begin to know your name.'
        };
        document.getElementById('contentArea').innerHTML = `
            <div class="event-card"><div class="event-type">Training Complete</div><div class="event-title">Self-Improvement</div><div class="event-desc">${descriptions[stat]}</div><div style="margin-top:10px;font-style:italic;">${changeText}</div></div>
            <button class="btn-primary" onclick="showYearActions()">Continue</button>
        `;
    }

    function doMilitaryService() {
        game.militaryYears++;
        game.currentOffice = 'military';
        if (!game.officesHeld.includes('military')) game.officesHeld.push('military');

        // Pick a military event we haven't used yet
        const availableEvents = MILITARY_EVENTS.filter((e, i) => !game.usedMilitaryEvents.includes(i));
        if (availableEvents.length > 0 && Math.random() < 0.7) {
            const eventIndex = MILITARY_EVENTS.indexOf(availableEvents[Math.floor(Math.random() * availableEvents.length)]);
            game.usedMilitaryEvents.push(eventIndex);
            showMilitaryEvent(MILITARY_EVENTS[eventIndex]);
        } else {
            // Fallback to simple outcome
            const outcomes = [
                { desc: 'A quiet year on the frontier. You learn the legions\' ways.', effects: { military: 8, dignitas: 3 } },
                { desc: 'Your unit sees action. You acquit yourself adequately.', effects: { military: 10, dignitas: 5 } },
                { desc: 'Garrison duty in a provincial town. Boring but safe.', effects: { military: 6, pecunia: 5 } },
                { desc: 'A harsh winter campaign. Many die, but you survive.', effects: { military: 12, dignitas: 5 } }
            ];
            const outcome = outcomes[Math.floor(Math.random() * outcomes.length)];
            const changeText = modifyStats(outcome.effects);
            document.getElementById('contentArea').innerHTML = `
                <div class="event-card"><div class="event-type">🗡️ Military Service — Year ${game.militaryYears}/10</div><div class="event-title">Life in the Legions</div><div class="event-desc">${outcome.desc}</div><div style="margin-top:10px;font-style:italic;">${changeText}</div></div>
                <button class="btn-primary" onclick="endYear()">End Year</button>
            `;
        }
    }

    function showMilitaryEvent(event) {
        game.currentEvent = { ...event, type: 'military' };
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="event-card">
                <div class="event-type">🗡️ Military Service — Year ${game.militaryYears}/10</div>
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc}</div>
                <div class="choices">
                    ${event.choices.map((c, i) => {
                        let disabled = c.requires ? Object.entries(c.requires).some(([s,v]) => game.stats[s] < v) : false;
                        let effectPreview = Object.entries(c.effects || {}).map(([k,v]) => `${k}: ${v > 0 ? '+' : ''}${v}`).join(', ') || 'Unknown outcome';
                        return `<button class="choice-btn" onclick="resolveMilitaryChoice(${i})" ${disabled ? 'disabled' : ''}>${c.text}<span class="choice-effect">${effectPreview}</span></button>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function resolveMilitaryChoice(i) {
        const choice = game.currentEvent.choices[i];
        let resultText = modifyStats(choice.effects || {});
        let riskText = '';
        let successText = '';

        if (choice.risk && Math.random() < choice.risk.chance) {
            modifyStats(choice.risk.penalty || {});
            riskText = `<div style="color:var(--danger);margin-top:10px;font-weight:bold;">⚠️ ${choice.risk.desc}</div>`;
        } else if (choice.successText) {
            successText = `<div style="color:var(--success);margin-top:10px;">${choice.successText}</div>`;
            if (choice.successEffects) {
                resultText += (resultText ? ', ' : '') + modifyStats(choice.successEffects);
            }
        }

        document.getElementById('contentArea').innerHTML = `
            <div class="event-card">
                <div class="event-type">Result</div>
                <div class="event-title">${choice.text}</div>
                ${resultText ? `<div style="font-style:italic;color:var(--ink-light);">${resultText}</div>` : ''}
                ${riskText}${successText}
            </div>
            <button class="btn-primary" onclick="endYear()">End Year</button>
        `;
    }

    function startElection(officeId) {
        game.phase = 'election';
        game.actionsThisYear += 2; // Elections cost 2 actions
        const office = OFFICES[officeId];
        game.currentElection = {
            office: officeId,
            support: Math.floor(game.stats.dignitas/3 + game.stats.popularis/4 + game.stats.auctoritas/4),
            spent: 0,
            opponents: [],
            campaignRounds: 0,
            maxCampaignRounds: 3
        };

        // Add random opponents
        for (let i = 0; i < Math.min(office.slots || 2, 2); i++) {
            game.currentElection.opponents.push({
                name: generateName(),
                support: 25 + Math.floor(Math.random() * 35),
                desc: ['Senator', 'Tribune', 'Equestrian', 'General'][Math.floor(Math.random() * 4)]
            });
        }

        // Add rival if they're at the same career stage
        if (game.rival && game.rivalMilitary >= 10) {
            const rivalCanRun = (officeId === 'quaestor' && game.rivalOffice === 'none') ||
                               (officeId === 'aedile' && game.rivalOffice === 'quaestor') ||
                               (officeId === 'praetor' && game.rivalOffice === 'aedile') ||
                               (officeId === 'consul' && game.rivalOffice === 'praetor');
            if (rivalCanRun && Math.random() < 0.7) {
                const rivalBonus = game.rivalRelation < 30 ? 10 : game.rivalRelation > 70 ? -10 : 0;
                game.currentElection.opponents.push({
                    name: game.rival.name,
                    support: 40 + Math.floor(Math.random() * 25) + rivalBonus,
                    desc: 'Your Rival',
                    isRival: true
                });
            }
        }
        showElectionUI();
    }

    function generateName() {
        const p = ['Marcus', 'Gaius', 'Lucius', 'Quintus', 'Publius', 'Gnaeus'];
        const n = ['Cornelius', 'Aemilius', 'Claudius', 'Valerius', 'Fabius', 'Tullius'];
        const c = ['Rufus', 'Niger', 'Crassus', 'Pulcher', 'Brutus', 'Metellus'];
        return p[Math.floor(Math.random()*p.length)] + ' ' + n[Math.floor(Math.random()*n.length)] + ' ' + c[Math.floor(Math.random()*c.length)];
    }

    function showElectionUI() {
        const el = game.currentElection, office = OFFICES[el.office];
        const all = [{ name: game.name, support: el.support, isPlayer: true }, ...el.opponents].sort((a, b) => b.support - a.support);
        const roundsLeft = el.maxCampaignRounds - el.campaignRounds;
        const canCampaign = roundsLeft > 0;

        document.getElementById('contentArea').innerHTML = `
            <div class="election-container">
                <div class="section-title">⚖️ Election for ${office.name}</div>
                <p style="text-align:center;margin-bottom:10px;">Campaign to win! You have <strong>${roundsLeft}</strong> campaign actions remaining.</p>
                <div class="candidates">${all.map(c => `<div class="candidate ${c.isPlayer ? 'player' : ''} ${c.isRival ? 'rival' : ''}" style="${c.isRival ? 'border-color:var(--danger);' : ''}"><div class="candidate-name">${c.name}</div><div class="candidate-support">${c.isPlayer ? 'YOU' : c.desc}</div><div class="vote-bar"><div class="vote-fill" style="width:${Math.min(100, c.support)}%"></div></div><div style="font-size:0.85rem;margin-top:5px;">${Math.round(c.support)}%</div></div>`).join('')}</div>
                ${canCampaign ? `
                <div class="campaign-actions">
                    <button class="campaign-btn" onclick="campaignAction('bribe')" ${game.stats.pecunia < 20 ? 'disabled' : ''}>💰 Bribe Voters<span class="cost">-20 Wealth, +15 Support</span></button>
                    <button class="campaign-btn" onclick="campaignAction('speech')">📣 Public Speech<span class="cost">Risky: +12 or -5 Support</span></button>
                    <button class="campaign-btn" onclick="campaignAction('favours')" ${game.stats.auctoritas < 25 ? 'disabled' : ''}>🤝 Call Favours<span class="cost">-10 Influence, +12 Support</span></button>
                    <button class="campaign-btn" onclick="campaignAction('games')" ${game.stats.pecunia < 40 ? 'disabled' : ''}>🏟️ Fund Games<span class="cost">-40 Wealth, +20 Support</span></button>
                    <button class="campaign-btn" onclick="campaignAction('attack')">⚔️ Attack Opponent<span class="cost">Risky: hurt leader or backfire</span></button>
                </div>` : '<p style="text-align:center;color:var(--danger);">No more campaign actions! You must hold the election.</p>'}
                <button class="btn-primary" onclick="resolveElection()" style="margin-top:15px;">${canCampaign ? 'Hold Election Now' : 'Hold the Election'}</button>
            </div>
        `;
    }

    function campaignAction(action) {
        const el = game.currentElection;
        el.campaignRounds++;

        if (action === 'bribe') {
            game.stats.pecunia -= 20;
            el.support += 15;
            game.tookBribe = true; // Track for potential consequences
        } else if (action === 'speech') {
            // Risky - depends on your stats
            const success = Math.random() < (0.6 + game.stats.popularis / 200);
            if (success) {
                el.support += 12;
            } else {
                el.support -= 5;
            }
        } else if (action === 'favours') {
            game.stats.auctoritas -= 10;
            el.support += 12;
        } else if (action === 'games') {
            game.stats.pecunia -= 40;
            el.support += 20;
            game.stats.popularis += 8;
        } else if (action === 'attack') {
            // Attack the current leader
            const leader = el.opponents.sort((a, b) => b.support - a.support)[0];
            const success = Math.random() < 0.5;
            if (success) {
                leader.support -= 15;
                if (leader.isRival) game.rivalRelation = Math.max(0, game.rivalRelation - 15);
            } else {
                el.support -= 10; // Backfires
                modifyStats({ dignitas: -5 });
            }
        }

        // Opponents also campaign
        el.opponents.forEach(o => {
            o.support += 3 + Math.floor(Math.random() * 6);
        });

        updateDisplay();
        showElectionUI();
    }

    function resolveElection() {
        const el = game.currentElection, office = OFFICES[el.office];
        const finalSupport = el.support + Math.floor(Math.random() * 20) - 10;
        el.opponents.forEach(o => o.support += Math.floor(Math.random() * 15) - 5);
        const all = [{ name: game.name, support: finalSupport, isPlayer: true }, ...el.opponents].sort((a, b) => b.support - a.support);
        const winners = all.slice(0, office.slots || 1);
        const won = winners.some(w => w.isPlayer);
        const rivalWon = winners.some(w => w.isRival);

        if (won) {
            game.currentOffice = el.office;
            if (!game.officesHeld.includes(el.office)) game.officesHeld.push(el.office);
            if (el.office === 'consul') game.consulYears.push(game.year);
            modifyStats({ dignitas: 20, auctoritas: 15 });
        } else {
            modifyStats({ dignitas: -10 });
        }

        // If rival won, advance their career
        if (rivalWon) {
            game.rivalOffice = el.office;
        }

        let resultMsg = won ? `You have been elected <strong>${office.name}</strong>!` : `You lost the election for ${office.name}.`;
        if (rivalWon && !won) {
            resultMsg += ` <strong>${game.rival.short}</strong> has won the position instead!`;
        } else if (rivalWon && won) {
            resultMsg += ` You share the office with your rival <strong>${game.rival.short}</strong>.`;
        }

        document.getElementById('contentArea').innerHTML = `
            <div class="election-container">
                <div class="section-title" style="color:${won ? 'var(--success)' : 'var(--danger)'};">${won ? '🏆 VICTORY!' : '❌ DEFEAT'}</div>
                <p style="text-align:center;">${resultMsg}</p>
                <div class="candidates">${all.map((c,i) => `<div class="candidate ${c.isPlayer ? 'player' : ''} ${c.isRival ? 'rival' : ''} ${i < (office.slots||1) ? 'winner' : ''}" style="${c.isRival ? 'border-color:var(--danger);' : ''}"><div class="candidate-name">${c.name}</div><div class="vote-bar"><div class="vote-fill" style="width:${Math.min(100, c.support)}%"></div></div><div style="font-size:0.85rem;margin-top:5px;">${Math.round(c.support)}%</div></div>`).join('')}</div>
                <button class="btn-primary" onclick="${won ? 'endYear()' : 'showYearActions()'}">Continue</button>
            </div>
        `;
    }

    function performDuties() {
        const results = {
            quaestor: { desc: 'You manage the treasury competently.', effects: { dignitas: 8, auctoritas: 5, pecunia: 10 } },
            aedile: { desc: 'You organize games and maintain streets.', effects: { dignitas: 10, popularis: 15, pecunia: -15 } },
            praetor: { desc: 'You sit in judgment and command troops.', effects: { dignitas: 12, auctoritas: 10, military: 5 } },
            consul: { desc: 'You lead the Republic as its highest magistrate.', effects: { dignitas: 20, auctoritas: 15 } },
            censor: { desc: 'You conduct the census and judge morals.', effects: { dignitas: 25, auctoritas: 20 } }
        };
        const r = results[game.currentOffice] || { desc: 'You serve Rome.', effects: { dignitas: 5 } };
        const changeText = modifyStats(r.effects);
        document.getElementById('contentArea').innerHTML = `<div class="event-card"><div class="event-type">Official Duties</div><div class="event-title">Service as ${OFFICES[game.currentOffice].name}</div><div class="event-desc">${r.desc}</div><div style="margin-top:10px;font-style:italic;">${changeText}</div></div><button class="btn-primary" onclick="endYear()">End Year</button>`;
    }

    function endYear() {
        game.stats.pecunia -= 5 + game.officesHeld.length * 2;
        if (game.currentOffice !== 'none' && game.currentOffice !== 'military') game.currentOffice = 'none';
        if (game.militaryYears >= 10 && game.currentOffice === 'military') game.currentOffice = 'none';
        Object.keys(game.relationships).forEach(id => {
            if (game.relationships[id] > 50) game.relationships[id] -= 2;
            else if (game.relationships[id] < 50) game.relationships[id] += 1;
        });
        Object.entries(game.relationships).forEach(([id, val]) => {
            if (val <= 20 && Math.random() < 0.3 && !game.enemies.includes(NPCS[id].name)) game.enemies.push(NPCS[id].name);
        });

        // Advance rival
        advanceRival();

        // Check if rival sabotages you when hostile
        if (game.rival && game.rivalRelation < 25 && Math.random() < 0.3) {
            game.pendingConsequences.push({
                year: game.year - 1, // Next year
                type: 'revenge',
                data: {
                    title: `${game.rival.short}'s Revenge`,
                    desc: `${game.rival.short} has been spreading rumours about you. Your reputation suffers.`,
                    effects: { dignitas: -10, auctoritas: -5 }
                }
            });
        }

        game.year--;
        game.age++;
        game.actionsThisYear = 0;  // Reset for new year
        game.eventQueue = [];      // Clear any remaining events
        updateDisplay();
        const status = checkGameOver();
        if (status.over) showGameEnd(status);
        else showYearStart();
    }

    function showGameEnd(status) {
        game.phase = 'end';
        const isVictory = status.reason === 'age' && game.officesHeld.includes('consul');
        let achievements = [];
        if (game.officesHeld.includes('consul')) achievements.push('Reached Consulship');
        if (game.officesHeld.includes('censor')) achievements.push('Became Censor');
        if (game.consulYears.length >= 2) achievements.push('Multiple Consulships');
        if (game.stats.dignitas >= 80) achievements.push('Highly Respected');
        if (game.enemies.length === 0) achievements.push('No Enemies');
        document.getElementById('contentArea').innerHTML = `
            <div class="end-screen ${isVictory ? 'victory' : 'defeat'}">
                <h2>${status.title}</h2>
                <p>${status.desc}</p>
                <div class="final-record">
                    <h4>Record of ${game.name}</h4>
                    <p><strong>Family:</strong> ${game.family.name}</p>
                    <p><strong>Years:</strong> ${game.age} (134 BC - ${game.year} BC)</p>
                    <p><strong>Highest Office:</strong> ${OFFICES[game.officesHeld[game.officesHeld.length-1] || 'none'].name}</p>
                    <p><strong>Offices:</strong> ${game.officesHeld.map(o => OFFICES[o].name).join(', ') || 'None'}</p>
                    <p><strong>Final Dignitas:</strong> ${Math.round(game.stats.dignitas)}</p>
                    <p><strong>Enemies:</strong> ${game.enemies.join(', ') || 'None'}</p>
                    ${achievements.length ? `<p><strong>Achievements:</strong> ${achievements.join(', ')}</p>` : ''}
                </div>
                <div class="historical-note"><strong>Note:</strong> The Late Republic saw many ambitious men climb the cursus honorum. Some achieved greatness. Many more were forgotten.</div>
                <button class="btn-primary" onclick="restartGame()">Play Again</button>
            </div>
        `;
    }

    function restartGame() {
        game = {
            year: 134, age: 17, name: '', family: null, currentOffice: 'none', officesHeld: [],
            stats: { dignitas: 50, auctoritas: 20, pecunia: 50, military: 0, popularis: 50 },
            relationships: { crassus: 50, pompey: 50, caesar: 50, cicero: 50, cato: 50 },
            enemies: [], phase: 'intro', militaryYears: 0, consulYears: [], actionsThisYear: 0,
            currentEvent: null, usedMilitaryEvents: [], usedPoliticalEvents: [], usedNpcEvents: {},
            eventQueue: [],
            // Reset rival system
            rival: null,
            rivalOffice: 'none',
            rivalMilitary: 0,
            rivalRelation: 50,
            // Reset consequences
            pendingConsequences: [],
            savedTribune: false,
            betrayedAlly: false,
            tookBribe: false
        };
        document.getElementById('careerTrack').classList.add('hidden');
        document.getElementById('statsRow').classList.add('hidden');
        document.getElementById('relationships').classList.add('hidden');
        showIntro();
    }

    showIntro();
    </script>
</body>
</html>
